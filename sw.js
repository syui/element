/*! For license information please see sw.js.LICENSE.txt */
(()=>{var e,t,s,i={"./node_modules/another-json/another-json.js":e=>{"use strict";for(var t=/[\\\"\x00-\x1F]/g,s={},i=0;i<32;++i)s[String.fromCharCode(i)]="\\U"+("0000"+i.toString(16)).slice(-4).toUpperCase();function n(e){return t.lastIndex=0,e.replace(t,(function(e){return s[e]}))}function r(e){switch(typeof e){case"string":return'"'+n(e)+'"';case"number":return isFinite(e)?e:"null";case"boolean":return e;case"object":return null===e?"null":Array.isArray(e)?function(e){for(var t="[",s="",i=0;i<e.length;++i)s+=t,t=",",s+=r(e[i]);return","!=t?"[]":s+"]"}(e):function(e){var t="{",s="",i=Object.keys(e);i.sort();for(var o=0;o<i.length;++o){var a=i[o];s+=t+'"'+n(a)+'":',t=",",s+=r(e[a])}return","!=t?"{}":s+"}"}(e);default:throw new Error("Cannot stringify: "+typeof e)}}s["\b"]="\\b",s["\t"]="\\t",s["\n"]="\\n",s["\f"]="\\f",s["\r"]="\\r",s['"']='\\"',s["\\"]="\\\\",e.exports={stringify:r}},"./node_modules/matrix-js-sdk/src/@types/PushRules.ts":(e,t,s)=>{"use strict";s.d(t,{Ji:()=>o,QN:()=>n,YU:()=>i,kq:()=>a,wp:()=>r});let i=function(e){return e.DontNotify="dont_notify",e.Notify="notify",e.Coalesce="coalesce",e}({}),n=function(e){return e.Highlight="highlight",e.Sound="sound",e}({});let r=function(e){return e.EventMatch="event_match",e.EventPropertyIs="event_property_is",e.EventPropertyContains="event_property_contains",e.ContainsDisplayName="contains_display_name",e.RoomMemberCount="room_member_count",e.SenderNotificationPermission="sender_notification_permission",e.CallStarted="call_started",e.CallStartedPrefix="org.matrix.msc3914.call_started",e}({}),o=function(e){return e.Override="override",e.ContentSpecific="content",e.RoomSpecific="room",e.SenderSpecific="sender",e.Underride="underride",e}({}),a=function(e){return e.Master=".m.rule.master",e.IsUserMention=".m.rule.is_user_mention",e.IsRoomMention=".m.rule.is_room_mention",e.ContainsDisplayName=".m.rule.contains_display_name",e.ContainsUserName=".m.rule.contains_user_name",e.AtRoomNotification=".m.rule.roomnotif",e.DM=".m.rule.room_one_to_one",e.EncryptedDM=".m.rule.encrypted_room_one_to_one",e.Message=".m.rule.message",e.EncryptedMessage=".m.rule.encrypted",e.InviteToSelf=".m.rule.invite_for_me",e.MemberEvent=".m.rule.member_event",e.IncomingCall=".m.rule.call",e.SuppressNotices=".m.rule.suppress_notices",e.Tombstone=".m.rule.tombstone",e.PollStart=".m.rule.poll_start",e.PollStartUnstable=".org.matrix.msc3930.rule.poll_start",e.PollEnd=".m.rule.poll_end",e.PollEndUnstable=".org.matrix.msc3930.rule.poll_end",e.PollStartOneToOne=".m.rule.poll_start_one_to_one",e.PollStartOneToOneUnstable=".org.matrix.msc3930.rule.poll_start_one_to_one",e.PollEndOneToOne=".m.rule.poll_end_one_to_one",e.PollEndOneToOneUnstable=".org.matrix.msc3930.rule.poll_end_one_to_one",e}({})},"./node_modules/matrix-js-sdk/src/@types/beacon.ts":(e,t,s)=>{"use strict";s.d(t,{E:()=>n,z:()=>r});var i=s("./node_modules/matrix-js-sdk/src/NamespacedValue.ts");const n=new i.qr("m.beacon_info","org.matrix.msc3672.beacon_info"),r=new i.qr("m.beacon","org.matrix.msc3672.beacon")},"./node_modules/matrix-js-sdk/src/@types/event.ts":(e,t,s)=>{"use strict";s.d(t,{Bx:()=>n,CJ:()=>d,Ct:()=>a,D7:()=>l,ID:()=>m,Ng:()=>f,SY:()=>w,Sr:()=>E,Wr:()=>o,Xs:()=>b,Yg:()=>y,Z3:()=>v,cr:()=>S,ge:()=>g,iK:()=>p,nN:()=>h,ud:()=>u,wt:()=>c,zZ:()=>r});var i=s("./node_modules/matrix-js-sdk/src/NamespacedValue.ts");s("./node_modules/matrix-js-sdk/src/@types/beacon.ts"),s("./node_modules/matrix-js-sdk/src/@types/polls.ts");let n=function(e){return e.RoomCanonicalAlias="m.room.canonical_alias",e.RoomCreate="m.room.create",e.RoomJoinRules="m.room.join_rules",e.RoomMember="m.room.member",e.RoomThirdPartyInvite="m.room.third_party_invite",e.RoomPowerLevels="m.room.power_levels",e.RoomName="m.room.name",e.RoomTopic="m.room.topic",e.RoomAvatar="m.room.avatar",e.RoomPinnedEvents="m.room.pinned_events",e.RoomEncryption="m.room.encryption",e.RoomHistoryVisibility="m.room.history_visibility",e.RoomGuestAccess="m.room.guest_access",e.RoomServerAcl="m.room.server_acl",e.RoomTombstone="m.room.tombstone",e.RoomPredecessor="org.matrix.msc3946.room_predecessor",e.PolicyRuleUser="m.policy.rule.user",e.PolicyRuleRoom="m.policy.rule.room",e.PolicyRuleServer="m.policy.rule.server",e.SpaceChild="m.space.child",e.SpaceParent="m.space.parent",e.RoomRedaction="m.room.redaction",e.RoomMessage="m.room.message",e.RoomMessageEncrypted="m.room.encrypted",e.Sticker="m.sticker",e.CallInvite="m.call.invite",e.CallCandidates="m.call.candidates",e.CallAnswer="m.call.answer",e.CallHangup="m.call.hangup",e.CallReject="m.call.reject",e.CallSelectAnswer="m.call.select_answer",e.CallNegotiate="m.call.negotiate",e.CallSDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",e.CallSDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",e.CallReplaces="m.call.replaces",e.CallAssertedIdentity="m.call.asserted_identity",e.CallAssertedIdentityPrefix="org.matrix.call.asserted_identity",e.CallEncryptionKeysPrefix="io.element.call.encryption_keys",e.KeyVerificationRequest="m.key.verification.request",e.KeyVerificationStart="m.key.verification.start",e.KeyVerificationCancel="m.key.verification.cancel",e.KeyVerificationMac="m.key.verification.mac",e.KeyVerificationDone="m.key.verification.done",e.KeyVerificationKey="m.key.verification.key",e.KeyVerificationAccept="m.key.verification.accept",e.KeyVerificationReady="m.key.verification.ready",e.RoomMessageFeedback="m.room.message.feedback",e.Reaction="m.reaction",e.PollStart="org.matrix.msc3381.poll.start",e.Typing="m.typing",e.Receipt="m.receipt",e.Presence="m.presence",e.FullyRead="m.fully_read",e.Tag="m.tag",e.SpaceOrder="org.matrix.msc3230.space_order",e.PushRules="m.push_rules",e.Direct="m.direct",e.IgnoredUserList="m.ignored_user_list",e.RoomKey="m.room_key",e.RoomKeyRequest="m.room_key_request",e.ForwardedRoomKey="m.forwarded_room_key",e.Dummy="m.dummy",e.GroupCallPrefix="org.matrix.msc3401.call",e.GroupCallMemberPrefix="org.matrix.msc3401.call.member",e.CallNotify="org.matrix.msc4075.call.notify",e}({}),r=function(e){return e.Annotation="m.annotation",e.Replace="m.replace",e.Reference="m.reference",e.Thread="m.thread",e}({}),o=function(e){return e.Text="m.text",e.Emote="m.emote",e.Notice="m.notice",e.Image="m.image",e.File="m.file",e.Audio="m.audio",e.Location="m.location",e.Video="m.video",e.KeyVerificationRequest="m.key.verification.request",e}({});const a="type";let d=function(e){return e.Space="m.space",e.UnstableCall="org.matrix.msc3417.call",e.ElementVideo="io.element.video",e}({});const c="org.matrix.msgid",l=new i.qr("m.room.purpose","org.matrix.msc3088.purpose"),u=new i.qr("m.enabled","org.matrix.msc3088.enabled"),h=new i.qr("m.data_tree","org.matrix.msc3089.data_tree"),m=new i.qr("m.leaf","org.matrix.msc3089.leaf"),p=new i.qr("m.branch","org.matrix.msc3089.branch"),g=new i.qr("m.room.marker","org.matrix.msc2716.marker"),v=new i.qr("with_rel_types","org.matrix.msc3912.with_relations"),f=new i.qr("io.element.functional_members","io.element.functional_members"),y=new i.qr("m.visibility","org.matrix.msc3531.visibility"),S=new i.qr("enabled","org.matrix.msc3881.enabled"),b=(new i.qr("device_id","org.matrix.msc3881.device_id"),new i.qr("m.local_notification_settings","org.matrix.msc3890.local_notification_settings")),E=new i.qr("thread_id","org.matrix.msc4023.thread_id"),w=new i.xu("membership","io.element.msc4115.membership")},"./node_modules/matrix-js-sdk/src/@types/extensible_events.ts":(e,t,s)=>{"use strict";var i=s("./node_modules/matrix-events-sdk/lib/index.js");new i.UnstableValue("m.message","org.matrix.msc1767.message"),new i.UnstableValue("m.text","org.matrix.msc1767.text"),new i.UnstableValue("m.html","org.matrix.msc1767.html"),new i.NamespacedValue("m.reference")},"./node_modules/matrix-js-sdk/src/@types/location.ts":(e,t,s)=>{"use strict";s.d(t,{J1:()=>n,M6:()=>o,vo:()=>r});var i=s("./node_modules/matrix-js-sdk/src/NamespacedValue.ts");s("./node_modules/matrix-js-sdk/src/@types/extensible_events.ts");const n=new i.qr("m.asset","org.matrix.msc3488.asset"),r=new i.qr("m.ts","org.matrix.msc3488.ts"),o=new i.qr("m.location","org.matrix.msc3488.location")},"./node_modules/matrix-js-sdk/src/@types/membership.ts":(e,t,s)=>{"use strict";s.d(t,{O:()=>i});let i=function(e){return e.Ban="ban",e.Invite="invite",e.Join="join",e.Knock="knock",e.Leave="leave",e}({})},"./node_modules/matrix-js-sdk/src/@types/partials.ts":(e,t,s)=>{"use strict";s.d(t,{Jv:()=>o,dx:()=>n,k:()=>i,rF:()=>r});let i=function(e){return e.PrivateChat="private_chat",e.TrustedPrivateChat="trusted_private_chat",e.PublicChat="public_chat",e}({}),n=function(e){return e.Public="public",e.Invite="invite",e.Private="private",e.Knock="knock",e.Restricted="restricted",e}({}),r=function(e){return e.CanJoin="can_join",e.Forbidden="forbidden",e}({}),o=function(e){return e.Invited="invited",e.Joined="joined",e.Shared="shared",e.WorldReadable="world_readable",e}({})},"./node_modules/matrix-js-sdk/src/@types/polls.ts":(e,t,s)=>{"use strict";s.d(t,{cI:()=>r,qN:()=>n});var i=s("./node_modules/matrix-events-sdk/lib/index.js");new i.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed"),new i.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed"),new i.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start");const n=new i.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response"),r=new i.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end")},"./node_modules/matrix-js-sdk/src/@types/read_receipts.ts":(e,t,s)=>{"use strict";s.d(t,{L:()=>i,S:()=>n});let i=function(e){return e.Read="m.read",e.FullyRead="m.fully_read",e.ReadPrivate="m.read.private",e}({});const n="main"},"./node_modules/matrix-js-sdk/src/@types/requests.ts":(e,t,s)=>{"use strict";s.d(t,{e:()=>i});let i=function(e){return e.Cancel="cancel",e.Restart="restart",e.Send="send",e}({})},"./node_modules/matrix-js-sdk/src/@types/search.ts":(e,t,s)=>{"use strict";s.d(t,{g:()=>i});let i=function(e){return e.Recent="recent",e.Rank="rank",e}({})},"./node_modules/matrix-js-sdk/src/@types/sync.ts":(e,t,s)=>{"use strict";s.d(t,{a:()=>i});const i=new(s("./node_modules/matrix-js-sdk/src/NamespacedValue.ts").M6)("unread_thread_notifications","org.matrix.msc3773.unread_thread_notifications")},"./node_modules/matrix-js-sdk/src/@types/topic.ts":(e,t,s)=>{"use strict";s.d(t,{s:()=>i});const i=new(s("./node_modules/matrix-js-sdk/src/NamespacedValue.ts").qr)("m.topic","org.matrix.msc3765.topic")},"./node_modules/matrix-js-sdk/src/NamespacedValue.ts":(e,t,s)=>{"use strict";s.d(t,{M6:()=>r,qr:()=>o,xu:()=>n});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js");class n{constructor(e,t){if(this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}get names(){const e=[this.name],t=this.altName;return t&&e.push(t),e}matches(e){return this.name===e||this.altName===e}findIn(e){let t;return this.name&&(t=null==e?void 0:e[this.name]),!t&&this.altName&&(t=null==e?void 0:e[this.altName]),t}includedIn(e){let t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}}class r extends n{constructor(...e){super(...e),(0,i.A)(this,"preferUnstable",!1)}setPreferUnstable(e){this.preferUnstable=e}get name(){return this.stable&&!this.preferUnstable?this.stable:this.unstable}}class o extends n{constructor(e,t){if(super(e,t),!this.unstable)throw new Error("Unstable value must be supplied")}get name(){return this.unstable}get altName(){return this.stable}}},"./node_modules/matrix-js-sdk/src/ReEmitter.ts":(e,t,s)=>{"use strict";s.d(t,{K:()=>n,Q:()=>r});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js");class n{constructor(e){(0,i.A)(this,"reEmitters",new WeakMap),this.target=e}reEmit(e,t){let s=this.reEmitters.get(e);s||(s=new Map,this.reEmitters.set(e,s));for(const i of t){if(s.has(i))continue;const t=(...t)=>{"error"===i&&0===this.target.listenerCount("error")||this.target.emit(i,...t,e)};e.on(i,t),s.set(i,t)}}stopReEmitting(e,t){const s=this.reEmitters.get(e);if(s){for(const i of t)e.off(i,s.get(i)),s.delete(i);0===s.size&&this.reEmitters.delete(e)}}}class r extends n{constructor(e){super(e)}reEmit(e,t){super.reEmit(e,t)}stopReEmitting(e,t){super.stopReEmitting(e,t)}}},"./node_modules/matrix-js-sdk/src/autodiscovery.ts":(e,t,s)=>{"use strict";s.d(t,{MN:()=>c});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/logger.ts"),r=s("./node_modules/matrix-js-sdk/src/http-api/index.ts"),o=s("./node_modules/matrix-js-sdk/src/version-support.ts");let a=function(e){return e.SUCCESS="SUCCESS",e.IGNORE="IGNORE",e.PROMPT="PROMPT",e.FAIL_PROMPT="FAIL_PROMPT",e.FAIL_ERROR="FAIL_ERROR",e}({}),d=function(e){return e.Invalid="Invalid homeserver discovery response",e.GenericFailure="Failed to get autodiscovery configuration from server",e.InvalidHsBaseUrl="Invalid base_url for m.homeserver",e.InvalidHomeserver="Homeserver URL does not appear to be a valid Matrix homeserver",e.InvalidIsBaseUrl="Invalid base_url for m.identity_server",e.InvalidIdentityServer="Identity server URL does not appear to be a valid identity server",e.InvalidIs="Invalid identity server discovery response",e.MissingWellknown="No .well-known JSON file found",e.InvalidJson="Invalid JSON",e.UnsupportedHomeserverSpecVersion="The homeserver does not meet the version requirements",e}({});class c{static async fromDiscoveryConfig(e){var t;const s={"m.homeserver":{state:c.FAIL_ERROR,error:c.ERROR_INVALID,base_url:null},"m.identity_server":{state:c.PROMPT,error:null,base_url:null}};if(null==e||!e["m.homeserver"])return n.v.error("No m.homeserver key in config"),s["m.homeserver"].state=c.FAIL_PROMPT,s["m.homeserver"].error=c.ERROR_INVALID,Promise.resolve(s);if(!e["m.homeserver"].base_url)return n.v.error("No m.homeserver base_url in config"),s["m.homeserver"].state=c.FAIL_PROMPT,s["m.homeserver"].error=c.ERROR_INVALID_HS_BASE_URL,Promise.resolve(s);const i=this.sanitizeWellKnownUrl(e["m.homeserver"].base_url);if(!i)return n.v.error("Invalid base_url for m.homeserver"),s["m.homeserver"].error=c.ERROR_INVALID_HS_BASE_URL,Promise.resolve(s);const r=await this.fetchWellKnownObject(`${i}/_matrix/client/versions`);if(!r||!Array.isArray(null===(t=r.raw)||void 0===t?void 0:t.versions))return n.v.error("Invalid /versions response"),s["m.homeserver"].error=c.ERROR_INVALID_HOMESERVER,s["m.homeserver"].base_url=i,Promise.resolve(s);const d=new Set(r.raw.versions);let l=!1;for(const e of o.Hr)if(d.has(e)){l=!0;break}if(!l)return n.v.error("Homeserver does not meet version requirements"),s["m.homeserver"].error=c.ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION,s["m.homeserver"].base_url=i,Promise.resolve(s);s["m.homeserver"]={state:c.SUCCESS,error:null,base_url:i};let u="";if(e["m.identity_server"]){const t={"m.homeserver":s["m.homeserver"],"m.identity_server":{state:c.FAIL_PROMPT,error:c.ERROR_INVALID_IS,base_url:null}};if(u=this.sanitizeWellKnownUrl(e["m.identity_server"].base_url),!u)return n.v.error("Invalid base_url for m.identity_server"),t["m.identity_server"].error=c.ERROR_INVALID_IS_BASE_URL,Promise.resolve(t);const i=await this.fetchWellKnownObject(`${u}/_matrix/identity/v2`);if(null==i||!i.raw||i.action!==a.SUCCESS)return n.v.error("Invalid /v2 response"),t["m.identity_server"].error=c.ERROR_INVALID_IDENTITY_SERVER,t["m.identity_server"].base_url=u,Promise.resolve(t)}return u&&u.toString().length>0&&(s["m.identity_server"]={state:c.SUCCESS,error:null,base_url:u}),Object.keys(e).forEach((t=>{if("m.homeserver"===t||"m.identity_server"===t){const i=["error","state","base_url"];for(const n of Object.keys(e[t]))i.includes(n)||(s[t][n]=e[t][n])}else s[t]=e[t]})),Promise.resolve(s)}static async findClientConfig(e){if(!e||"string"!=typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");const t={"m.homeserver":{state:c.FAIL_ERROR,error:c.ERROR_INVALID,base_url:null},"m.identity_server":{state:c.PROMPT,error:null,base_url:null}},s=e.includes("://")?e:`https://${e}`,i=await this.fetchWellKnownObject(`${s}/.well-known/matrix/client`);return i&&i.action===a.SUCCESS?c.fromDiscoveryConfig(i.raw):(n.v.error("No response or error when parsing .well-known"),i.reason&&n.v.error(i.reason),i.action===a.IGNORE?t["m.homeserver"]={state:c.PROMPT,error:null,base_url:null}:(t["m.homeserver"].state=c.FAIL_PROMPT,t["m.homeserver"].error=c.ERROR_INVALID),Promise.resolve(t))}static async getRawClientConfig(e){var t;if(!e||"string"!=typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");const s=await this.fetchWellKnownObject(`https://${e}/.well-known/matrix/client`);return s&&null!==(t=s.raw)&&void 0!==t?t:{}}static sanitizeWellKnownUrl(e){if(!e)return!1;try{var t;let s;try{s=new URL(e)}catch(e){n.v.error("Could not parse url",e)}if(null===(t=s)||void 0===t||!t.hostname)return!1;if("http:"!==s.protocol&&"https:"!==s.protocol)return!1;const i=s.port?`:${s.port}`:"",r=s.pathname?s.pathname:"";let o=`${s.protocol}//${s.hostname}${i}${r}`;return o.endsWith("/")&&(o=o.substring(0,o.length-1)),o}catch(e){return n.v.error(e),!1}}static fetch(e,t){return this.fetchFn?this.fetchFn(e,t):s.g.fetch(e,t)}static setFetchFn(e){c.fetchFn=e}static async fetchWellKnownObject(e){let t;try{if(t=await c.fetch(e,{method:r.IT.Get,signal:(0,r._)(5e3)}),404===t.status)return{raw:{},action:a.IGNORE,reason:c.ERROR_MISSING_WELLKNOWN};if(!t.ok)return{raw:{},action:a.FAIL_PROMPT,reason:"General failure"}}catch(e){const t=e;let s="";return"object"==typeof t&&(s=null==t?void 0:t.message),{error:t,raw:{},action:a.FAIL_PROMPT,reason:s||"General failure"}}try{return{raw:await t.json(),action:a.SUCCESS}}catch(e){const t=e;return{error:t,raw:{},action:a.FAIL_PROMPT,reason:"SyntaxError"===(null==t?void 0:t.name)?c.ERROR_INVALID_JSON:c.ERROR_INVALID}}}}(0,i.A)(c,"ERROR_INVALID",d.Invalid),(0,i.A)(c,"ERROR_GENERIC_FAILURE",d.GenericFailure),(0,i.A)(c,"ERROR_INVALID_HS_BASE_URL",d.InvalidHsBaseUrl),(0,i.A)(c,"ERROR_INVALID_HOMESERVER",d.InvalidHomeserver),(0,i.A)(c,"ERROR_INVALID_IS_BASE_URL",d.InvalidIsBaseUrl),(0,i.A)(c,"ERROR_INVALID_IDENTITY_SERVER",d.InvalidIdentityServer),(0,i.A)(c,"ERROR_INVALID_IS",d.InvalidIs),(0,i.A)(c,"ERROR_MISSING_WELLKNOWN",d.MissingWellknown),(0,i.A)(c,"ERROR_INVALID_JSON",d.InvalidJson),(0,i.A)(c,"ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION",d.UnsupportedHomeserverSpecVersion),(0,i.A)(c,"ALL_ERRORS",Object.keys(d)),(0,i.A)(c,"FAIL_ERROR",a.FAIL_ERROR),(0,i.A)(c,"FAIL_PROMPT",a.FAIL_PROMPT),(0,i.A)(c,"PROMPT",a.PROMPT),(0,i.A)(c,"SUCCESS",a.SUCCESS),(0,i.A)(c,"fetchFn",void 0)},"./node_modules/matrix-js-sdk/src/base64.ts":(e,t,s)=>{"use strict";s.d(t,{A4:()=>o,PP:()=>r,WG:()=>n,y4:()=>a});var i=s("./node_modules/buffer/index.js").hp;function n(e){if("function"==typeof i)return i.from(e).toString("base64");if("function"==typeof btoa&&e instanceof Uint8Array)return btoa(e.reduce(((e,t)=>e+String.fromCharCode(t)),""));throw new Error("No base64 impl found!")}function r(e){return n(e).replace(/={1,2}$/,"")}function o(e){return r(e).replace(/\+/g,"-").replace(/\//g,"_")}function a(e){if("function"==typeof i)return i.from(e,"base64");if("function"==typeof atob){const t=function*(){const t=atob(e.replace(/-/g,"+").replace(/_/g,"/"));for(let e=0;e<t.length;++e)yield t.charCodeAt(e)};return Uint8Array.from(t())}throw new Error("No base64 impl found!")}},"./node_modules/matrix-js-sdk/src/client.ts":(e,t,s)=>{"use strict";s.d(t,{AU:()=>_e,pB:()=>Re,eO:()=>Ee,rG:()=>we,fN:()=>Ae,Xb:()=>Ce});var i=s("./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),n=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=s("./node_modules/matrix-js-sdk/src/sync.ts"),o=s("./node_modules/matrix-js-sdk/src/models/event.ts");class a{constructor(){(0,n.A)(this,"accountData",new Map),(0,n.A)(this,"fromToken",null)}isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(e){this.fromToken=e}storeRoom(e){}getRoom(e){return null}getRooms(){return[]}removeRoom(e){}getRoomSummaries(){return[]}storeUser(e){}getUser(e){return null}getUsers(){return[]}scrollback(e,t){return[]}setUserCreator(e){}storeEvents(e,t,s,i){}storeFilter(e){}getFilter(e,t){return null}getFilterIdByName(e){return null}setFilterIdByName(e,t){}storeAccountDataEvents(e){}getAccountData(e){}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(e,t){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve(void 0)}storeClientOptions(e){return Promise.resolve()}async getPendingEvents(e){return[]}setPendingEvents(e,t){return Promise.resolve()}async saveToDeviceBatches(e){return Promise.resolve()}getOldestToDeviceBatch(){return Promise.resolve(null)}async removeToDeviceBatch(e){return Promise.resolve()}async destroy(){}}var d=s("./node_modules/matrix-js-sdk/src/webrtc/call.ts"),c=s("./node_modules/matrix-js-sdk/src/filter.ts"),l=s("./node_modules/matrix-js-sdk/src/webrtc/callEventHandler.ts"),u=s("./node_modules/matrix-js-sdk/src/webrtc/groupCallEventHandler.ts"),h=s("./node_modules/matrix-js-sdk/src/utils.ts"),m=s("./node_modules/matrix-js-sdk/src/models/event-timeline.ts"),p=s("./node_modules/matrix-js-sdk/src/pushprocessor.ts"),g=s("./node_modules/matrix-js-sdk/src/autodiscovery.ts"),v=s("./node_modules/matrix-js-sdk/src/crypto/olmlib.ts"),f=s("./node_modules/matrix-js-sdk/src/base64.ts"),y=s("./node_modules/matrix-js-sdk/src/ReEmitter.ts"),S=s("./node_modules/matrix-js-sdk/src/logger.ts"),b=s("./node_modules/matrix-js-sdk/src/service-types.ts"),E=s("./node_modules/matrix-js-sdk/src/http-api/index.ts"),w=s("./node_modules/matrix-js-sdk/src/crypto/index.ts"),I=s("./node_modules/matrix-js-sdk/src/models/user.ts"),_=s("./node_modules/matrix-js-sdk/src/content-repo.ts"),k=s("./node_modules/matrix-js-sdk/src/models/search-result.ts"),R=s("./node_modules/matrix-js-sdk/src/crypto/dehydration.ts"),T=s("./node_modules/matrix-js-sdk/src/crypto/api.ts"),C=s("./node_modules/matrix-js-sdk/src/content-helpers.ts"),A=s("./node_modules/matrix-js-sdk/src/models/room.ts"),O=s("./node_modules/matrix-js-sdk/src/models/room-member.ts"),M=s("./node_modules/matrix-js-sdk/src/@types/event.ts"),x=s("./node_modules/matrix-js-sdk/src/@types/partials.ts");function D(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function P(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?D(Object(s),!0).forEach((function(t){(0,n.A)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):D(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}var U=s("./node_modules/matrix-js-sdk/src/randomstring.ts"),j=s("./node_modules/matrix-js-sdk/src/crypto/backup.ts"),L=s("./node_modules/p-retry/index.js"),N=s.n(L);function K(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function B(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?K(Object(s),!0).forEach((function(t){(0,n.A)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):K(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class F{constructor(e,t,s){this.client=e,this.indexEvent=t,this.directory=s}get id(){const e=this.indexEvent.getStateKey();if(!e)throw new Error("State key not found for branch");return e}get isActive(){return!0===this.indexEvent.getContent().active}get version(){var e;return null!==(e=this.indexEvent.getContent().version)&&void 0!==e?e:1}get roomId(){return this.indexEvent.getRoomId()}async delete(){await this.client.sendStateEvent(this.roomId,M.iK.name,{},this.id),await this.client.redactEvent(this.roomId,this.id);const e=(await this.getVersionHistory())[1];e&&await e.delete()}getName(){return this.indexEvent.getContent().name||"Unnamed File"}async setName(e){await this.client.sendStateEvent(this.roomId,M.iK.name,B(B({},this.indexEvent.getContent()),{},{name:e}),this.id)}isLocked(){return this.indexEvent.getContent().locked||!1}async setLocked(e){await this.client.sendStateEvent(this.roomId,M.iK.name,B(B({},this.indexEvent.getContent()),{},{locked:e}),this.id)}async getFileInfo(){const e=(await this.getFileEvent()).getOriginalContent().file,t=this.client.mxcUrlToHttp(e.url);if(!t)throw new Error(`No HTTP URL available for ${e.url}`);return{info:e,httpUrl:t}}async getFileEvent(){const e=this.client.getRoom(this.roomId);if(!e)throw new Error("Unknown room");let t=e.getUnfilteredTimelineSet().findEventById(this.id);for(;!t&&e.getLiveTimeline().getState(m.q.BACKWARDS).paginationToken;)await this.client.scrollback(e,100),t=e.getUnfilteredTimelineSet().findEventById(this.id);if(!t)throw new Error("Failed to find event");return await this.client.decryptEventIfNeeded(t),t}async createNewVersion(e,t,s,i){const n=await this.directory.createFile(e,t,s,B(B({},null!=i?i:{}),{},{"m.new_content":!0,"m.relates_to":{rel_type:M.zZ.Replace,event_id:this.id}}));return await this.client.sendStateEvent(this.roomId,M.iK.name,{active:!0,name:e,version:this.version+1},n.event_id),await this.client.sendStateEvent(this.roomId,M.iK.name,B(B({},this.indexEvent.getContent()),{},{active:!1}),this.id),n}async getVersionHistory(){const e=[];e.push(this);const t=this.client.getRoom(this.roomId);if(!t)throw new Error("Invalid or unknown room");const s=[...t.getLiveTimeline().getEvents()].reverse();let i,n=await this.getFileEvent();do{if(i=s.find((e=>e.replacingEventId()===n.getId())),i){const t=this.directory.getFile(i.getId());if(!t)break;e.push(t),n=i}}while(i);return e}}var $=s("./node_modules/matrix-js-sdk/src/crypto/algorithms/megolm.ts"),q=s("./node_modules/matrix-js-sdk/src/@types/membership.ts");function V(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function G(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?V(Object(s),!0).forEach((function(t){(0,n.A)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):V(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const H={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[M.Bx.RoomPowerLevels]:100,[M.Bx.RoomHistoryVisibility]:100,[M.Bx.RoomTombstone]:100,[M.Bx.RoomEncryption]:100,[M.Bx.RoomName]:50,[M.Bx.RoomMessage]:50,[M.Bx.RoomMessageEncrypted]:50,[M.Bx.Sticker]:50},users:{}};let W=function(e){return e.Viewer="viewer",e.Editor="editor",e.Owner="owner",e}({});class J{constructor(e,t){if((0,n.A)(this,"room",void 0),this.client=e,this.roomId=t,this.room=this.client.getRoom(this.roomId),!this.room)throw new Error("Unknown room")}get id(){return this.roomId}get isTopLevel(){const e=this.room.currentState.getStateEvents(M.Bx.SpaceParent);return null==e||!e.length||e.every((e=>{var t;return!(null!==(t=e.getContent())&&void 0!==t&&t.via)}))}async setName(e){await this.client.sendStateEvent(this.roomId,M.Bx.RoomName,{name:e},"")}async invite(e,t=!0,s=!0){const i=[this.retryInvite(e)];return t&&i.push(...this.getDirectories().map((i=>i.invite(e,t,s)))),Promise.all(i).then((()=>{s&&(0,$.hk)(this.room)&&this.client.sendSharedHistoryKeys(this.roomId,[e])}))}retryInvite(e){return(0,h.CC)((async()=>{await this.client.invite(this.roomId,e).catch((e=>{if("M_FORBIDDEN"===(null==e?void 0:e.errcode))throw new(N().AbortError)(e);throw e}))}))}async setPermissions(e,t){var s;const i=this.room.currentState.getStateEvents(M.Bx.RoomPowerLevels,"");if(Array.isArray(i))throw new Error("Unexpected return type for power levels");const n=(null==i?void 0:i.getContent())||{},r=n.users_default||0,o=n.events_default||50,a=(null===(s=n.events)||void 0===s?void 0:s[M.Bx.RoomPowerLevels])||100,d=n.users||{};switch(t){case W.Viewer:d[e]=r;break;case W.Editor:d[e]=o;break;case W.Owner:d[e]=a;break;default:throw new Error("Invalid role: "+t)}n.users=d,await this.client.sendStateEvent(this.roomId,M.Bx.RoomPowerLevels,n,"")}getPermissions(e){var t,s;const i=this.room.currentState.getStateEvents(M.Bx.RoomPowerLevels,"");if(Array.isArray(i))throw new Error("Unexpected return type for power levels");const n=(null==i?void 0:i.getContent())||{},r=n.users_default||0,o=n.events_default||50,a=(null===(t=n.events)||void 0===t?void 0:t[M.Bx.RoomPowerLevels])||100,d=(null===(s=n.users)||void 0===s?void 0:s[e])||r;return d>=a?W.Owner:d>=o?W.Editor:W.Viewer}async createDirectory(e){const t=await this.client.unstableCreateFileTree(e);return await this.client.sendStateEvent(this.roomId,M.Bx.SpaceChild,{via:[this.client.getDomain()]},t.roomId),await this.client.sendStateEvent(t.roomId,M.Bx.SpaceParent,{via:[this.client.getDomain()]},this.roomId),t}getDirectories(){const e=[],t=this.room.currentState.getStateEvents(M.Bx.SpaceChild);for(const s of t)try{const t=s.getStateKey();if(t){const s=this.client.unstableGetFileTreeSpace(t);s&&e.push(s)}}catch(e){S.v.warn("Unable to create tree space instance for listing. Are we joined?",e)}return e}getDirectory(e){return this.getDirectories().find((t=>t.roomId===e))}async delete(){const e=this.getDirectories();for(const t of e)await t.delete();const t=[q.O.Invite,q.O.Knock,q.O.Join],s=this.room.currentState.getStateEvents(M.Bx.RoomMember);for(const e of s){if(e.getStateKey()!==this.client.getUserId()&&t.includes(e.getContent().membership)){const t=e.getStateKey();if(!t)throw new Error("State key not found for branch");await this.client.kick(this.roomId,t,"Room deleted")}}await this.client.leave(this.roomId)}getOrderedChildren(e){const t=e.map((e=>({roomId:e.getStateKey(),order:e.getContent().order}))).filter((e=>e.roomId));return t.sort(((e,t)=>{if(e.order&&!t.order)return-1;if(!e.order&&t.order)return 1;if(e.order||t.order)return(0,h.aw)(e.order,t.order);{var s,i,n,r;const o=this.client.getRoom(e.roomId),a=this.client.getRoom(t.roomId);if(!o||!a)return(0,h.aw)(e.roomId,t.roomId);const d=null!==(s=null===(i=o.currentState.getStateEvents(M.Bx.RoomCreate,""))||void 0===i?void 0:i.getTs())&&void 0!==s?s:0,c=null!==(n=null===(r=a.currentState.getStateEvents(M.Bx.RoomCreate,""))||void 0===r?void 0:r.getTs())&&void 0!==n?n:0;return d===c?(0,h.aw)(e.roomId,t.roomId):d-c}})),t}getParentRoom(){const e=this.room.currentState.getStateEvents(M.Bx.SpaceParent)[0];if(!e)throw new Error("Expected to have a parent in a non-top level space");const t=e.getStateKey();if(!t)throw new Error("No state key found for parent");const s=this.client.getRoom(t);if(!s)throw new Error("Unable to locate room for parent");return s}getOrder(){if(this.isTopLevel)return-1;const e=this.getParentRoom().currentState.getStateEvents(M.Bx.SpaceChild);return this.getOrderedChildren(e).findIndex((e=>e.roomId===this.roomId))}async setOrder(e){var t;if(this.isTopLevel)throw new Error("Cannot set order of top level spaces currently");const s=this.getParentRoom(),i=s.currentState.getStateEvents(M.Bx.SpaceChild),n=this.getOrderedChildren(i);e=Math.max(Math.min(e,n.length-1),0);const r=this.getOrder()<e;r&&e===n.length-1?e--:r||0!==e||e++;const o=n[r?e:e-1],a=n[r?e+1:e];let d=h.Mf[0],c=!1;if(o)if(e===n.length-1)null!=a&&a.order&&(d=(0,h.$9)(a.order));else{const e=null==o?void 0:o.order,t=null==a?void 0:a.order;e&&t?d=e===t?(0,h.$9)(e):(0,h.sy)(e,t):e?d=(0,h.$9)(e):t?d=(0,h.zR)(t):c=!0}else null!=a&&a.order&&(d=(0,h.zR)(a.order));if(c){let t;for(let i=0;i<=e;i++){const e=n[i];if(0===i&&(t=e.order),e.order)t=e.order;else{var l;t=t?(0,h.$9)(t):h.Mf[0];const i=s.currentState.getStateEvents(M.Bx.SpaceChild,e.roomId),n=null!==(l=null==i?void 0:i.getContent())&&void 0!==l?l:{via:[this.client.getDomain()]};await this.client.sendStateEvent(s.roomId,M.Bx.SpaceChild,G(G({},n),{},{order:t}),e.roomId)}}t&&(d=(0,h.$9)(t))}const u=s.currentState.getStateEvents(M.Bx.SpaceChild,this.roomId),m=null!==(t=null==u?void 0:u.getContent())&&void 0!==t?t:{via:[this.client.getDomain()]};await this.client.sendStateEvent(s.roomId,M.Bx.SpaceChild,G(G({},m),{},{order:d}),this.roomId)}async createFile(e,t,s,i){var n;const{content_uri:r}=await this.client.uploadContent(t,{includeFilename:!1});s.url=r;const o={msgtype:M.Wr.File,body:e,url:r,file:s};(i=null!==(n=i)&&void 0!==n?n:{})["m.new_content"]&&(i["m.new_content"]=o);const a=await this.client.sendMessage(this.roomId,G(G(G({},i),o),{},{[M.ID.name]:{}}));return await this.client.sendStateEvent(this.roomId,M.iK.name,{active:!0,name:e},a.event_id),a}getFile(e){const t=this.room.currentState.getStateEvents(M.iK.name,e);return t?new F(this.client,t,this):null}listFiles(){return this.listAllFiles().filter((e=>e.isActive))}listAllFiles(){var e;return(null!==(e=this.room.currentState.getStateEvents(M.iK.name))&&void 0!==e?e:[]).map((e=>new F(this.client,e,this)))}}var z=s("./node_modules/matrix-js-sdk/src/@types/search.ts"),Q=s("./node_modules/matrix-js-sdk/src/@types/PushRules.ts"),Y=s("./node_modules/matrix-js-sdk/src/webrtc/groupCall.ts"),X=s("./node_modules/matrix-js-sdk/src/webrtc/mediaHandler.ts"),Z=s("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),ee=s("./node_modules/matrix-js-sdk/src/@types/read_receipts.ts"),te=s("./node_modules/matrix-js-sdk/src/sliding-sync-sdk.ts"),se=s("./node_modules/matrix-js-sdk/src/models/thread.ts"),ie=s("./node_modules/matrix-js-sdk/src/@types/beacon.ts"),ne=s("./node_modules/matrix-js-sdk/src/NamespacedValue.ts"),re=s("./node_modules/matrix-js-sdk/src/scheduler.ts");class oe{constructor(e){(0,n.A)(this,"sending",!1),(0,n.A)(this,"running",!0),(0,n.A)(this,"retryTimeout",null),(0,n.A)(this,"retryAttempts",0),(0,n.A)(this,"sendQueue",(async()=>{if(null!==this.retryTimeout&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.sending||!this.running)return;let e;S.v.debug("Attempting to send queued to-device messages"),this.sending=!0;try{for(;this.running&&(e=await this.client.store.getOldestToDeviceBatch(),null!==e);)await this.sendBatch(e),await this.client.store.removeToDeviceBatch(e.id),this.retryAttempts=0;if(!this.running)return;S.v.debug("All queued to-device messages sent")}catch(t){++this.retryAttempts;const s=re.b.RETRY_BACKOFF_RATELIMIT(null,this.retryAttempts,t);if(-1===s)return void(4===Math.floor(t.httpStatus/100)?(S.v.error("Fatal error when sending to-device message - dropping to-device batch!",t),await this.client.store.removeToDeviceBatch(e.id)):S.v.info("Automatic retry limit reached for to-device messages."));S.v.info(`Failed to send batch of to-device messages. Will retry in ${s}ms`,t),this.retryTimeout=setTimeout(this.sendQueue,s)}finally{this.sending=!1}})),(0,n.A)(this,"onResumedSync",((e,t)=>{e===r.Lm.Syncing&&t!==r.Lm.Syncing&&(S.v.info("Resuming queue after resumed sync"),this.sendQueue())})),this.client=e}start(){this.running=!0,this.sendQueue(),this.client.on(_e.Sync,this.onResumedSync)}stop(){this.running=!1,null!==this.retryTimeout&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.client.removeListener(_e.Sync,this.onResumedSync)}async queueBatch(e){const t=[];for(let s=0;s<e.batch.length;s+=20){const i={eventType:e.eventType,batch:e.batch.slice(s,s+20),txnId:this.client.makeTxnId()};t.push(i);const n=i.batch.map((e=>`${e.userId}/${e.deviceId} (msgid ${e.payload[M.wt]})`));S.v.info(`Enqueuing batch of to-device messages. type=${e.eventType} txnid=${i.txnId}`,n)}await this.client.store.saveToDeviceBatches(t),this.sendQueue()}async sendBatch(e){const t=new h.kG((()=>new Map));for(const s of e.batch)t.getOrCreate(s.userId).set(s.deviceId,s.payload);S.v.info(`Sending batch of ${e.batch.length} to-device messages with ID ${e.id} and txnId ${e.txnId}`),await this.client.sendToDevice(e.eventType,t,e.txnId)}}var ae=s("./node_modules/matrix-js-sdk/src/models/invites-ignorer.ts"),de=s("./node_modules/matrix-js-sdk/src/feature.ts");const ce="matrix-js-sdk";var le=s("./node_modules/matrix-js-sdk/src/crypto-api/index.ts"),ue=s("./node_modules/matrix-js-sdk/src/secret-storage.ts"),he=s("./node_modules/matrix-js-sdk/src/matrixrtc/MatrixRTCSessionManager.ts");function me(e){return t=>{var s,i;return(null===(s=t.content)||void 0===s||null===(s=s["m.relates_to"])||void 0===s?void 0:s.event_id)!==e||(null===(i=t.content)||void 0===i||null===(i=i["m.relates_to"])||void 0===i?void 0:i.rel_type)===se.RN.name}}var pe=s("./node_modules/matrix-js-sdk/src/serverCapabilities.ts"),ge=s("./node_modules/matrix-js-sdk/src/digest.ts"),ve=s("./node_modules/matrix-js-sdk/src/common-crypto/key-passphrase.ts");const fe=["server","limit","since"];function ye(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function Se(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?ye(Object(s),!0).forEach((function(t){(0,n.A)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):ye(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}(0,w.DM)();const be=6e5;new ne.qr("last_seen_user_agent","org.matrix.msc3852.last_seen_user_agent");let Ee=function(e){return e.Chronological="chronological",e.Detached="detached",e}({});new ne.xu("m.get_login_token","org.matrix.msc3882.get_login_token");const we="org.matrix.msc4140";const Ie="$";let _e=function(e){return e.Sync="sync",e.Event="event",e.ToDeviceEvent="toDeviceEvent",e.AccountData="accountData",e.Room="Room",e.DeleteRoom="deleteRoom",e.SyncUnexpectedError="sync.unexpectedError",e.ClientWellKnown="WellKnown.client",e.ReceivedVoipEvent="received_voip_event",e.UndecryptableToDeviceEvent="toDeviceEvent.undecryptable",e.TurnServers="turnServers",e.TurnServersError="turnServers.error",e}({});const ke=new ne.qr("action","org.matrix.msc3824.action");class Re extends Z.X{constructor(e){var t,s,i;super(),(0,n.A)(this,"logger",void 0),(0,n.A)(this,"reEmitter",new y.Q(this)),(0,n.A)(this,"olmVersion",null),(0,n.A)(this,"usingExternalCrypto",!1),(0,n.A)(this,"_store",void 0),(0,n.A)(this,"deviceId",void 0),(0,n.A)(this,"credentials",void 0),(0,n.A)(this,"pickleKey",void 0),(0,n.A)(this,"scheduler",void 0),(0,n.A)(this,"clientRunning",!1),(0,n.A)(this,"timelineSupport",!1),(0,n.A)(this,"urlPreviewCache",{}),(0,n.A)(this,"identityServer",void 0),(0,n.A)(this,"http",void 0),(0,n.A)(this,"crypto",void 0),(0,n.A)(this,"cryptoBackend",void 0),(0,n.A)(this,"cryptoCallbacks",void 0),(0,n.A)(this,"callEventHandler",void 0),(0,n.A)(this,"groupCallEventHandler",void 0),(0,n.A)(this,"supportsCallTransfer",!1),(0,n.A)(this,"forceTURN",!1),(0,n.A)(this,"iceCandidatePoolSize",0),(0,n.A)(this,"idBaseUrl",void 0),(0,n.A)(this,"baseUrl",void 0),(0,n.A)(this,"isVoipWithNoMediaAllowed",void 0),(0,n.A)(this,"useLivekitForGroupCalls",void 0),(0,n.A)(this,"canSupportVoip",!1),(0,n.A)(this,"peekSync",null),(0,n.A)(this,"isGuestAccount",!1),(0,n.A)(this,"ongoingScrollbacks",{}),(0,n.A)(this,"notifTimelineSet",null),(0,n.A)(this,"cryptoStore",void 0),(0,n.A)(this,"verificationMethods",void 0),(0,n.A)(this,"fallbackICEServerAllowed",!1),(0,n.A)(this,"syncApi",void 0),(0,n.A)(this,"roomNameGenerator",void 0),(0,n.A)(this,"pushRules",void 0),(0,n.A)(this,"syncLeftRoomsPromise",void 0),(0,n.A)(this,"syncedLeftRooms",!1),(0,n.A)(this,"clientOpts",void 0),(0,n.A)(this,"clientWellKnownIntervalID",void 0),(0,n.A)(this,"canResetTimelineCallback",void 0),(0,n.A)(this,"canSupport",new Map),(0,n.A)(this,"pushProcessor",new p.j(this)),(0,n.A)(this,"serverVersionsPromise",void 0),(0,n.A)(this,"clientWellKnown",void 0),(0,n.A)(this,"clientWellKnownPromise",void 0),(0,n.A)(this,"turnServers",[]),(0,n.A)(this,"turnServersExpiry",0),(0,n.A)(this,"checkTurnServersIntervalID",void 0),(0,n.A)(this,"exportedOlmDeviceToImport",void 0),(0,n.A)(this,"txnCtr",0),(0,n.A)(this,"mediaHandler",new X.L(this)),(0,n.A)(this,"sessionId",void 0),(0,n.A)(this,"eventsBeingEncrypted",new Set),(0,n.A)(this,"useE2eForGroupCall",!0),(0,n.A)(this,"toDeviceMessageQueue",void 0),(0,n.A)(this,"livekitServiceURL",void 0),(0,n.A)(this,"_secretStorage",void 0),(0,n.A)(this,"ignoredInvites",void 0),(0,n.A)(this,"matrixRTC",void 0),(0,n.A)(this,"serverCapabilitiesService",void 0),(0,n.A)(this,"startCallEventHandler",(()=>{this.isInitialSyncComplete()&&((0,d.sj)()&&(this.callEventHandler.start(),this.groupCallEventHandler.start()),this.off(_e.Sync,this.startCallEventHandler))})),(0,n.A)(this,"startMatrixRTC",(()=>{this.isInitialSyncComplete()&&(this.matrixRTC.start(),this.off(_e.Sync,this.startMatrixRTC))})),(0,n.A)(this,"fixupRoomNotifications",(()=>{if(this.isInitialSyncComplete()){var e;const t=(null!==(e=this.getRooms())&&void 0!==e?e:[]).filter((e=>e.getUnreadNotificationCount(A.X5.Total)>0));for(const e of t){const t=this.getSafeUserId();e.fixupNotifications(t)}this.off(_e.Sync,this.fixupRoomNotifications)}})),this.logger=null!==(t=e.logger)&&void 0!==t?t:S.v,e.baseUrl=h.hc(e.baseUrl),e.idBaseUrl=h.hc(e.idBaseUrl),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer,this.usingExternalCrypto=null!==(s=e.usingExternalCrypto)&&void 0!==s&&s,this.store=e.store||new a,this.deviceId=e.deviceId||null,this.sessionId=(0,U.DU)(10);const r=e.userId||null;this.credentials={userId:r},this.http=new E.ED(this,{fetchFn:e.fetchFn,baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,refreshToken:e.refreshToken,tokenRefreshFunction:e.tokenRefreshFunction,prefix:E.iD.V3,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader,logger:this.logger}),e.deviceToImport?this.deviceId?this.logger.warn("not importing device because device ID is provided to constructor independently of exported data"):this.credentials.userId?this.logger.warn("not importing device because user ID is provided to constructor independently of exported data"):e.deviceToImport.deviceId?(this.deviceId=e.deviceToImport.deviceId,this.credentials.userId=e.deviceToImport.userId,this.exportedOlmDeviceToImport=e.deviceToImport.olmDevice):this.logger.warn("not importing device because no device ID in exported data"):e.pickleKey&&(this.pickleKey=e.pickleKey),this.useLivekitForGroupCalls=Boolean(e.useLivekitForGroupCalls),this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction((async e=>{const t=this.getRoom(e.getRoomId());e.status!==o.fb.SENDING&&this.updatePendingEventStatus(t,e,o.fb.SENDING);const s=await this.sendEventHttpRequest(e);return t&&t.updatePendingEvent(e,o.fb.SENT,s.event_id),s})),(0,d.sj)()&&(this.callEventHandler=new l.N(this),this.groupCallEventHandler=new u.e(this),this.canSupportVoip=!0,this.on(_e.Sync,this.startCallEventHandler)),this.matrixRTC=new he.I(this),this.serverCapabilitiesService=new pe.K(this.http),this.on(_e.Sync,this.fixupRoomNotifications),this.timelineSupport=Boolean(e.timelineSupport),this.cryptoStore=e.cryptoStore,this.verificationMethods=e.verificationMethods,this.cryptoCallbacks=e.cryptoCallbacks||{},this.forceTURN=e.forceTURN||!1,this.iceCandidatePoolSize=void 0===e.iceCandidatePoolSize?0:e.iceCandidatePoolSize,this.supportsCallTransfer=e.supportsCallTransfer||!1,this.fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this.isVoipWithNoMediaAllowed=e.isVoipWithNoMediaAllowed||!1,void 0!==e.useE2eForGroupCall&&(this.useE2eForGroupCall=e.useE2eForGroupCall),this.livekitServiceURL=e.livekitServiceURL,this.roomNameGenerator=e.roomNameGenerator,this.toDeviceMessageQueue=new oe(this),this.on(o.OQ.Decrypted,(e=>{!function(e,t){var s;const i=e.getUserId(),n=t.getId(),r=e.getRoom(t.getRoomId());if(!r||!i||!n)return;if(!r.findEventById(n))return void S.v.info(`Decrypted event ${t.getId()} is not in room ${r.roomId}: ignoring`);const o=!!t.threadRootId&&!t.isThreadRoot;let a;if(o){const e=r.getThread(t.threadRootId);a=!e||e.hasUserReadEvent(i,n)}else a=r.hasUserReadEvent(i,n);if(a)return;const d=e.getPushActionsForEvent(t,!0);if(null!=d&&null!==(s=d.tweaks)&&void 0!==s&&s.highlight){const e=r.getUnreadCountForEventContext(A.X5.Highlight,t)+1;o?r.setThreadUnreadNotificationCount(t.threadRootId,A.X5.Highlight,e):r.setUnreadNotificationCount(A.X5.Highlight,e)}if(null!=d&&d.notify){const e=r.getUnreadCountForEventContext(A.X5.Total,t)+1;o?r.setThreadUnreadNotificationCount(t.threadRootId,A.X5.Total,e):r.setUnreadNotificationCount(A.X5.Total,e)}}(this,e)})),this.ignoredInvites=new ae.bp(this),this._secretStorage=new ue.ServerSideSecretStorageImpl(this,null!==(i=e.cryptoCallbacks)&&void 0!==i?i:{}),this.setMaxListeners(0)}set store(e){this._store=e,this._store.setUserCreator((e=>I.K.createUser(e,this)))}get store(){return this._store}async startClient(e){if(this.clientRunning)return;this.clientRunning=!0,this.on(_e.Sync,this.startMatrixRTC);const t=this.getUserId();t&&this.store.storeUser(new I.K(t)),this.canSupportVoip&&(this.checkTurnServersIntervalID=setInterval((()=>{this.checkTurnServers()}),be),this.checkTurnServers()),this.syncApi&&(this.logger.error("Still have sync object whilst not running: stopping old one"),this.syncApi.stop());try{await this.getVersions();const{threads:e,list:t,fwdPagination:s}=await this.doesServerSupportThread();se.jV.setServerSideSupport(e),se.jV.setServerSideListSupport(t),se.jV.setServerSideFwdPaginationSupport(s)}catch(e){this.logger.error("Can't fetch server versions, continuing to initialise sync, this will be retried later",e)}this.clientOpts=null!=e?e:{},this.clientOpts.slidingSync?this.syncApi=new te.m(this.clientOpts.slidingSync,this,this.clientOpts,this.buildSyncApiOptions()):this.syncApi=new r.w_(this,this.clientOpts,this.buildSyncApiOptions()),this.syncApi.sync().catch((e=>this.logger.info("Sync startup aborted with an error:",e))),void 0!==this.clientOpts.clientWellKnownPollPeriod&&(this.clientWellKnownIntervalID=setInterval((()=>{this.fetchClientWellKnown()}),1e3*this.clientOpts.clientWellKnownPollPeriod),this.fetchClientWellKnown()),this.toDeviceMessageQueue.start(),this.serverCapabilitiesService.start()}buildSyncApiOptions(){return{crypto:this.crypto,cryptoCallbacks:this.cryptoBackend,canResetEntireTimeline:e=>!!this.canResetTimelineCallback&&this.canResetTimelineCallback(e)}}stopClient(){var e,t,i,n,r;null===(e=this.cryptoBackend)||void 0===e||e.stop(),this.off(_e.Sync,this.startMatrixRTC),this.clientRunning&&(this.logger.debug("stopping MatrixClient"),this.clientRunning=!1,null===(t=this.syncApi)||void 0===t||t.stop(),this.syncApi=void 0,null===(i=this.peekSync)||void 0===i||i.stopPeeking(),null===(n=this.callEventHandler)||void 0===n||n.stop(),null===(r=this.groupCallEventHandler)||void 0===r||r.stop(),this.callEventHandler=void 0,this.groupCallEventHandler=void 0,s.g.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,void 0!==this.clientWellKnownIntervalID&&s.g.clearInterval(this.clientWellKnownIntervalID),this.toDeviceMessageQueue.stop(),this.matrixRTC.stop(),this.serverCapabilitiesService.stop())}async rehydrateDevice(){if(this.crypto)throw new Error("Cannot rehydrate device after crypto is initialized");if(!this.cryptoCallbacks.getDehydrationKey)return;const e=await this.getDehydratedDevice();if(!e)return;if(!e.device_data||!e.device_id)return void this.logger.info("no dehydrated device found");const t=new s.g.Olm.Account;try{const s=e.device_data;if(s.algorithm!==R.S)return void this.logger.warn("Wrong algorithm for dehydrated device");this.logger.debug("unpickling dehydrated device");const i=await this.cryptoCallbacks.getDehydrationKey(s,(e=>{t.unpickle(new Uint8Array(e),s.account)}));t.unpickle(i,s.account),this.logger.debug("unpickled device");if((await this.http.authedRequest(E.IT.Post,"/dehydrated_device/claim",void 0,{device_id:e.device_id},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})).success){this.deviceId=e.device_id,this.logger.info("using dehydrated device");const s=this.pickleKey||"DEFAULT_KEY";return this.exportedOlmDeviceToImport={pickledAccount:t.pickle(s),sessions:[],pickleKey:s},t.free(),this.deviceId}return t.free(),void this.logger.info("not using dehydrated device")}catch(e){t.free(),this.logger.warn("could not unpickle",e)}}async getDehydratedDevice(){try{return await this.http.authedRequest(E.IT.Get,"/dehydrated_device",void 0,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})}catch(e){return void this.logger.info("could not get dehydrated device",e)}}async setDehydrationKey(e,t,s){if(this.crypto)return this.crypto.dehydrationManager.setKeyAndQueueDehydration(e,t,s);this.logger.warn("not dehydrating device if crypto is not enabled")}async createDehydratedDevice(e,t,s){if(this.crypto)return await this.crypto.dehydrationManager.setKey(e,t,s),this.crypto.dehydrationManager.dehydrateDevice();this.logger.warn("not dehydrating device if crypto is not enabled")}async exportDevice(){if(this.crypto)return{userId:this.credentials.userId,deviceId:this.deviceId,olmDevice:await this.crypto.olmDevice.export()};this.logger.warn("not exporting device if crypto is not enabled")}clearStores(){if(this.clientRunning)throw new Error("Cannot clear stores while client is running");const e=[];e.push(this.store.deleteAllData()),this.cryptoStore&&e.push(this.cryptoStore.deleteAllData());return e.push((async()=>{let e;try{if(e=s.g.indexedDB,!e)return}catch(e){return}for(const t of[`${ce}::matrix-sdk-crypto`,`${ce}::matrix-sdk-crypto-meta`]){const s=new Promise(((s,i)=>{this.logger.info(`Removing IndexedDB instance ${t}`);const n=e.deleteDatabase(t);n.onsuccess=e=>{this.logger.info(`Removed IndexedDB instance ${t}`),s(0)},n.onerror=e=>{this.logger.warn(`Failed to remove IndexedDB instance ${t}:`,e),s(0)},n.onblocked=e=>{this.logger.info(`cannot yet remove IndexedDB instance ${t}`)}}));await s}})()),Promise.all(e).then()}getUserId(){return this.credentials&&this.credentials.userId?this.credentials.userId:null}getSafeUserId(){const e=this.getUserId();if(!e)throw new Error("Expected logged in user but found none.");return e}getDomain(){return this.credentials&&this.credentials.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){return this.credentials&&this.credentials.userId?this.credentials.userId.split(":")[0].substring(1):null}getDeviceId(){return this.deviceId}getSessionId(){return this.sessionId}supportsVoip(){return this.canSupportVoip}getMediaHandler(){return this.mediaHandler}setForceTURN(e){this.forceTURN=e}setSupportsCallTransfer(e){this.supportsCallTransfer=e}getUseE2eForGroupCall(){return this.useE2eForGroupCall}createCall(e){return(0,d.sv)(this,e)}async createGroupCall(e,t,s,i,n,r){if(this.getGroupCallForRoom(e))throw new Error(`${e} already has an existing group call`);const o=this.getRoom(e);if(!o)throw new Error(`Cannot find room ${e}`);return new Y.eO(this,o,t,s,i,void 0,n||this.isVoipWithNoMediaAllowed,r,this.isVoipWithNoMediaAllowed,this.useLivekitForGroupCalls,this.livekitServiceURL).create()}getLivekitServiceURL(){return this.livekitServiceURL}setLivekitServiceURL(e){this.livekitServiceURL=e}waitUntilRoomReadyForGroupCalls(e){return this.groupCallEventHandler.waitUntilRoomReadyForGroupCalls(e)}getGroupCallForRoom(e){return this.groupCallEventHandler.groupCalls.get(e)||null}getSyncState(){var e,t;return null!==(e=null===(t=this.syncApi)||void 0===t?void 0:t.getSyncState())&&void 0!==e?e:null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){const e=this.getSyncState();return!!e&&(e===r.Lm.Prepared||e===r.Lm.Syncing)}isGuest(){return this.isGuestAccount}setGuest(e){this.isGuestAccount=e}getScheduler(){return this.scheduler}retryImmediately(){var e,t;return this.toDeviceMessageQueue.sendQueue(),null!==(e=null===(t=this.syncApi)||void 0===t?void 0:t.retryImmediately())&&void 0!==e&&e}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(e){this.notifTimelineSet=e}async getCapabilities(){const e=this.serverCapabilitiesService.getCachedCapabilities();return e||this.serverCapabilitiesService.fetchCapabilities()}getCachedCapabilities(){return this.serverCapabilitiesService.getCachedCapabilities()}fetchCapabilities(){return this.serverCapabilitiesService.fetchCapabilities()}async initCrypto(){if(!(0,w.DM)())throw new Error("End-to-end encryption not supported in this js-sdk build: did you remember to load the olm library?");if(this.cryptoBackend)return void this.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");if(!this.cryptoStore)throw new Error("Cannot enable encryption: no cryptoStore provided");this.logger.debug("Crypto: Starting up crypto store..."),await this.cryptoStore.startup();const e=this.getUserId();if(null===e)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");if(null===this.deviceId)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");const t=new w.Qr(this,e,this.deviceId,this.store,this.cryptoStore,this.verificationMethods);this.reEmitter.reEmit(t,[w.cr.KeyBackupFailed,w.cr.KeyBackupSessionsRemaining,w.cr.RoomKeyRequest,w.cr.RoomKeyRequestCancellation,w.cr.Warning,w.cr.DevicesUpdated,w.cr.WillUpdateDevices,w.cr.DeviceVerificationChanged,w.cr.UserTrustStatusChanged,w.cr.KeysChanged]),this.logger.debug("Crypto: initialising crypto object..."),await t.init({exportedOlmDevice:this.exportedOlmDeviceToImport,pickleKey:this.pickleKey}),delete this.exportedOlmDeviceToImport,this.olmVersion=w.Qr.getOlmVersion(),t.registerEventHandlers(this),this.cryptoBackend=this.crypto=t,this.crypto.uploadDeviceKeys().catch((e=>{this.logger.error("Error uploading device keys",e)}))}async initRustCrypto(e={}){var t;if(this.cryptoBackend)return void this.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");const i=this.getUserId();if(null===i)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");const n=this.getDeviceId();if(null===n)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");this.logger.debug("Downloading Rust crypto library");const r=await Promise.all([s.e(5813),s.e(7490),s.e(6656),s.e(4513)]).then(s.bind(s,"./node_modules/matrix-js-sdk/src/rust-crypto/index.ts")),o=await r.initRustCrypto({logger:this.logger,http:this.http,userId:i,deviceId:n,secretStorage:this.secretStorage,cryptoCallbacks:this.cryptoCallbacks,storePrefix:!1===e.useIndexedDB?null:ce,storeKey:e.storageKey,storePassphrase:e.storagePassword,legacyCryptoStore:this.cryptoStore,legacyPickleKey:null!==(t=this.pickleKey)&&void 0!==t?t:"DEFAULT_KEY",legacyMigrationProgressListener:(e,t)=>{this.emit(w.cr.LegacyCryptoStoreMigrationProgress,e,t)}});o.setSupportedVerificationMethods(this.verificationMethods),this.cryptoBackend=o,this.on(O.o.Membership,o.onRoomMembership.bind(o)),this.on(_e.Event,(e=>{o.onLiveEventFromSync(e)})),this.reEmitter.reEmit(o,[w.cr.VerificationRequestReceived,w.cr.UserTrustStatusChanged,w.cr.KeyBackupStatus,w.cr.KeyBackupSessionsRemaining,w.cr.KeyBackupFailed,w.cr.KeyBackupDecryptionKeyCached,w.cr.KeysChanged,w.cr.DevicesUpdated,w.cr.WillUpdateDevices])}get secretStorage(){return this._secretStorage}getCrypto(){return this.cryptoBackend}isCryptoEnabled(){return!!this.cryptoBackend}getDeviceEd25519Key(){var e,t;return null!==(e=null===(t=this.crypto)||void 0===t?void 0:t.getDeviceEd25519Key())&&void 0!==e?e:null}getDeviceCurve25519Key(){var e,t;return null!==(e=null===(t=this.crypto)||void 0===t?void 0:t.getDeviceCurve25519Key())&&void 0!==e?e:null}async uploadKeys(){this.logger.warn("MatrixClient.uploadKeys is deprecated")}downloadKeys(e,t){return this.crypto?this.crypto.downloadKeys(e,t):Promise.reject(new Error("End-to-end encryption disabled"))}getStoredDevicesForUser(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevicesForUser(e)||[]}getStoredDevice(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevice(e,t)||null}setDeviceVerified(e,t,s=!0){const i=this.setDeviceVerification(e,t,s,null,null);return e==this.credentials.userId&&this.checkKeyBackup(),i}setDeviceBlocked(e,t,s=!0){return this.setDeviceVerification(e,t,null,s,null)}setDeviceKnown(e,t,s=!0){return this.setDeviceVerification(e,t,null,null,s)}async setDeviceVerification(e,t,s,i,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.setDeviceVerification(e,t,s,i,n)}requestVerificationDM(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerificationDM(e,t)}findVerificationRequestDMInProgress(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");if(this.crypto)return this.crypto.findVerificationRequestDMInProgress(e)}getVerificationRequestsToDeviceInProgress(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getVerificationRequestsToDeviceInProgress(e)}requestVerification(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerification(e,t)}beginKeyVerification(e,t,s){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.beginKeyVerification(e,t,s)}checkSecretStorageKey(e,t){return this.secretStorage.checkKey(e,t)}setGlobalBlacklistUnverifiedDevices(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.globalBlacklistUnverifiedDevices=e,e}getGlobalBlacklistUnverifiedDevices(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.globalBlacklistUnverifiedDevices}setGlobalErrorOnUnknownDevices(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");this.cryptoBackend.globalErrorOnUnknownDevices=e}getGlobalErrorOnUnknownDevices(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.globalErrorOnUnknownDevices}getCrossSigningId(e=T.n.Master){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getCrossSigningId(e)}getStoredCrossSigningForUser(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.getStoredCrossSigningForUser(e)}checkUserTrust(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.checkUserTrust(e)}checkDeviceTrust(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkDeviceTrust(e,t)}checkIfOwnDeviceCrossSigned(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkIfOwnDeviceCrossSigned(e)}checkOwnCrossSigningTrust(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.checkOwnCrossSigningTrust(e)}checkCrossSigningPrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkCrossSigningPrivateKey(e,t)}legacyDeviceVerification(e,t,s){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.legacyDeviceVerification(e,t,s)}prepareToEncrypt(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");this.cryptoBackend.prepareToEncrypt(e)}userHasCrossSigningKeys(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.userHasCrossSigningKeys()}isCrossSigningReady(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.isCrossSigningReady()}bootstrapCrossSigning(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.bootstrapCrossSigning(e)}getCryptoTrustCrossSignedDevices(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.getTrustCrossSignedDevices()}setCryptoTrustCrossSignedDevices(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");this.cryptoBackend.setTrustCrossSignedDevices(e)}countSessionsNeedingBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.countSessionsNeedingBackup()}getEventEncryptionInfo(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.getEventEncryptionInfo(e)}createRecoveryKeyFromPassphrase(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.createRecoveryKeyFromPassphrase(e)}isSecretStorageReady(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.isSecretStorageReady()}bootstrapSecretStorage(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.bootstrapSecretStorage(e)}addSecretStorageKey(e,t,s){return this.secretStorage.addKey(e,t,s)}hasSecretStorageKey(e){return this.secretStorage.hasKey(e)}storeSecret(e,t,s){return this.secretStorage.store(e,t,s)}getSecret(e){return this.secretStorage.get(e)}isSecretStored(e){return this.secretStorage.isStored(e)}requestSecret(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestSecret(e,t)}getDefaultSecretStorageKeyId(){return this.secretStorage.getDefaultKeyId()}setDefaultSecretStorageKeyId(e){return this.secretStorage.setDefaultKeyId(e)}checkSecretStoragePrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkSecretStoragePrivateKey(e,t)}async getEventSenderDeviceInfo(e){return this.crypto?this.crypto.getEventSenderDeviceInfo(e):null}async isEventSenderVerified(e){const t=await this.getEventSenderDeviceInfo(e);return!!t&&t.isVerified()}getOutgoingRoomKeyRequest(e){if(!this.crypto)throw new Error("End-to-End encryption disabled");const t=e.getWireContent(),s={session_id:t.session_id,sender_key:t.sender_key,algorithm:t.algorithm,room_id:e.getRoomId()};return s.session_id&&s.sender_key&&s.algorithm&&s.room_id?this.crypto.cryptoStore.getOutgoingRoomKeyRequest(s):Promise.resolve(null)}cancelAndResendEventRoomKeyRequest(e){if(!this.crypto)throw new Error("End-to-End encryption disabled");return e.cancelAndResendKeyRequest(this.crypto,this.getUserId())}setRoomEncryption(e,t){if(!this.crypto)throw new Error("End-to-End encryption disabled");return this.crypto.setRoomEncryption(e,t)}isRoomEncrypted(e){var t,s;const i=this.getRoom(e);return!!i&&(!!i.hasEncryptionStateEvent()||null!==(t=null===(s=this.crypto)||void 0===s?void 0:s.isRoomEncrypted(e))&&void 0!==t&&t)}encryptAndSendToDevices(e,t){if(!this.crypto)throw new Error("End-to-End encryption disabled");return this.crypto.encryptAndSendToDevices(e,t)}forceDiscardSession(e){if(!this.cryptoBackend)throw new Error("End-to-End encryption disabled");this.cryptoBackend.forceDiscardSession(e)}exportRoomKeys(){return this.cryptoBackend?this.cryptoBackend.exportRoomKeys():Promise.reject(new Error("End-to-end encryption disabled"))}importRoomKeys(e,t){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.importRoomKeys(e,t)}checkKeyBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.checkKeyBackup()}async getKeyBackupVersion(){let e;try{e=await this.http.authedRequest(E.IT.Get,"/room_keys/version",void 0,void 0,{prefix:E.iD.V3})}catch(e){if("M_NOT_FOUND"===e.errcode)return null;throw e}return j.IO.checkBackupVersion(e),e}isKeyBackupTrusted(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.isKeyBackupTrusted(e)}getKeyBackupEnabled(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.getKeyBackupEnabled()}enableKeyBackup(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.enableKeyBackup(e)}disableKeyBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");this.crypto.backupManager.disableKeyBackup()}async prepareKeyBackupVersion(e,t={secureSecretStorage:!1}){if(!this.crypto)throw new Error("End-to-end encryption disabled");const{algorithm:s,auth_data:i,recovery_key:n,privateKey:r}=await this.crypto.backupManager.prepareKeyBackupVersion(e);return t.secureSecretStorage&&(await this.secretStorage.store("m.megolm_backup.v1",(0,f.WG)(r)),this.logger.info("Key backup private key stored in secret storage")),{algorithm:s,auth_data:i,recovery_key:n}}isKeyBackupKeyStored(){return Promise.resolve(this.secretStorage.isStored("m.megolm_backup.v1"))}async createKeyBackupVersion(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.backupManager.createKeyBackupVersion(e);const t={algorithm:e.algorithm,auth_data:e.auth_data};await this.crypto.signObject(t.auth_data),this.cryptoCallbacks.getCrossSigningKey&&this.crypto.crossSigningInfo.getId()&&await this.crypto.crossSigningInfo.signObject(t.auth_data,"master");const s=await this.http.authedRequest(E.IT.Post,"/room_keys/version",void 0,t);return await this.checkKeyBackup(),this.getKeyBackupEnabled()||this.logger.error("Key backup not usable even though we just created it"),s}async deleteKeyBackupVersion(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");await this.cryptoBackend.deleteKeyBackupVersion(e)}makeKeyBackupPath(e,t,s){let i;i=void 0!==t?h.RR("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):void 0!==e?h.RR("/room_keys/keys/$roomId",{$roomId:e}):"/room_keys/keys";return{path:i,queryData:void 0===s?void 0:{version:s}}}async sendKeyBackup(e,t,s,i){if(!this.crypto)throw new Error("End-to-end encryption disabled");const n=this.makeKeyBackupPath(e,t,s);await this.http.authedRequest(E.IT.Put,n.path,n.queryData,i,{prefix:E.iD.V3})}async scheduleAllGroupSessionsForBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");await this.crypto.backupManager.scheduleAllGroupSessionsForBackup()}flagAllGroupSessionsForBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.flagAllGroupSessionsForBackup()}isValidRecoveryKey(e){try{return(0,le.decodeRecoveryKey)(e),!0}catch(e){return!1}}keyBackupKeyFromPassword(e,t){return(0,ve.c)(t.auth_data,e)}keyBackupKeyFromRecoveryKey(e){return(0,le.decodeRecoveryKey)(e)}async restoreKeyBackupWithPassword(e,t,s,i,n){const r=await(0,ve.c)(i.auth_data,e);return this.restoreKeyBackup(r,t,s,i,n)}async restoreKeyBackupWithSecretStorage(e,t,s,i){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");const n=await this.secretStorage.get("m.megolm_backup.v1"),r=(0,w.D$)(n);if(r){const e=await this.secretStorage.getKey();await this.secretStorage.store("m.megolm_backup.v1",r,[e[0]])}const o=(0,f.y4)(r||n);return this.restoreKeyBackup(o,t,s,e,i)}restoreKeyBackupWithRecoveryKey(e,t,s,i,n){const r=(0,le.decodeRecoveryKey)(e);return this.restoreKeyBackup(r,t,s,i,n)}async restoreKeyBackupWithCache(e,t,s,i){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");const n=await this.cryptoBackend.getSessionBackupPrivateKey();if(!n)throw new Error("Couldn't get key");return this.restoreKeyBackup(n,e,t,s,i)}async restoreKeyBackup(e,t,s,i,n){const r=null==n?void 0:n.cacheCompleteCallback,o=null==n?void 0:n.progressCallback;if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");if(!i.version)throw new Error("Backup version must be defined");const a=i.version;let d=0,c=0,l=0;const u=this.makeKeyBackupPath(t,s,a),h=await this.cryptoBackend.getBackupDecryptor(i,e),m=!h.sourceTrusted;try{if(!(e instanceof Uint8Array))throw new Error(`restoreKeyBackup expects Uint8Array, got ${e}`);this.cryptoBackend.storeSessionBackupPrivateKey(e,a).catch((e=>{this.logger.warn("Error caching session backup key:",e)})).then(r),o&&o({stage:"fetch"});const n=await this.http.authedRequest(E.IT.Get,u.path,u.queryData,void 0,{prefix:E.iD.V3});if(o&&o({stage:"load_keys"}),n.rooms)d=this.getTotalKeyCount(n),await this.handleDecryptionOfAFullBackup(n,h,200,(async e=>{try{const t=i.version;await this.cryptoBackend.importBackedUpRoomKeys(e,t,{untrusted:m}),l+=e.length}catch(t){c+=e.length,S.v.error("Error importing keys from backup",t)}o&&o({total:d,successes:l,stage:"load_keys",failures:c})}));else if(n.sessions){const e=n.sessions;d=Object.keys(e).length;const s=await h.decryptSessions(e);for(const e of s)e.room_id=t;await this.cryptoBackend.importBackedUpRoomKeys(s,a,{progressCallback:o,untrusted:m}),l=s.length}else{d=1;try{const[e]=await h.decryptSessions({[s]:n});e.room_id=t,e.session_id=s,await this.cryptoBackend.importBackedUpRoomKeys([e],a,{progressCallback:o,untrusted:m}),l=1}catch(e){this.logger.debug("Failed to decrypt megolm session from backup",e)}}}finally{h.free()}return await this.cryptoBackend.checkKeyBackupAndEnable(),{total:d,imported:l}}getTotalKeyCount(e){const t=e.rooms;let s=0;for(const e of Object.values(t))e.sessions&&(s+=Object.keys(e.sessions).length);return s}async handleDecryptionOfAFullBackup(e,t,s,i){const n=e.rooms;let r=0,o=new Map;const a=async e=>{const s=[];for(const i of e.keys()){const n=await t.decryptSessions(e.get(i));for(const e in n){const t=n[e];t.room_id=i,s.push(t)}}await i(s)};for(const[e,t]of Object.entries(n))if(t.sessions){o.set(e,{});for(const[i,n]of Object.entries(t.sessions)){o.get(e)[i]=n,r+=1,r>=s&&(await a(o),o=new Map,o.set(e,{}),r=0)}}r>0&&await a(o)}async deleteKeysFromBackup(e,t,s){const i=this.makeKeyBackupPath(e,t,s);await this.http.authedRequest(E.IT.Delete,i.path,i.queryData,void 0,{prefix:E.iD.V3})}async sendSharedHistoryKeys(e,t){var s;if(!this.crypto)throw new Error("End-to-end encryption disabled");const i=null===(s=this.crypto)||void 0===s?void 0:s.getRoomEncryption(e);if(!i)return void this.logger.error("Unknown room.  Not sharing decryption keys");const n=await this.crypto.downloadKeys(t),r=new Map;for(const[e,t]of n)r.set(e,Array.from(t.values()));const o=this.crypto.getRoomDecryptor(e,i.algorithm);o.sendSharedHistoryInboundSessions?await o.sendSharedHistoryInboundSessions(r):this.logger.warn("Algorithm does not support sharing previous keys",i.algorithm)}getMediaConfig(){return this.http.authedRequest(E.IT.Get,"/config",void 0,void 0,{prefix:E.zs.V3})}getRoom(e){return e?this.store.getRoom(e):null}getRooms(){return this.store.getRooms()}getVisibleRooms(e=!1){const t=this.store.getRooms(),s=new Set;for(const n of t){var i;const t=null===(i=n.findPredecessor(e))||void 0===i?void 0:i.roomId;t&&s.add(t)}return t.filter((e=>!e.currentState.getStateEvents(M.Bx.RoomTombstone,"")||!s.has(e.roomId)))}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t){const s=h.RR("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});return(0,E.Y6)(5,(()=>this.http.authedRequest(E.IT.Put,s,void 0,t)))}getAccountData(e){return this.store.getAccountData(e)}async getAccountDataFromServer(e){if(this.isInitialSyncComplete()){const t=this.store.getAccountData(e);return t?t.getContent():null}const t=h.RR("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});try{return await this.http.authedRequest(E.IT.Get,t)}catch(e){var s;if("M_NOT_FOUND"===(null===(s=e.data)||void 0===s?void 0:s.errcode))return null;throw e}}async deleteAccountData(e){const t=this.canSupport.get(de.Xj.AccountDataDeletion);if(t===de.Tj.Unsupported)return void await this.setAccountData(e,{});const s=h.RR("/user/$userId/account_data/$type",{$userId:this.getSafeUserId(),$type:e}),i=t===de.Tj.Unstable?{prefix:"/_matrix/client/unstable/org.matrix.msc3391"}:void 0;return await this.http.authedRequest(E.IT.Delete,s,void 0,void 0,i)}getIgnoredUsers(){const e=this.getAccountData("m.ignored_user_list");return e&&e.getContent()&&e.getContent().ignored_users?Object.keys(e.getContent().ignored_users):[]}setIgnoredUsers(e){const t={ignored_users:{}};return e.forEach((e=>{t.ignored_users[e]={}})),this.setAccountData("m.ignored_user_list",t)}isUserIgnored(e){return this.getIgnoredUsers().includes(e)}async joinRoom(e,t={}){void 0===t.syncRoom&&(t.syncRoom=!0);const s=this.getRoom(e);if(null!=s&&s.hasMembershipState(this.credentials.userId,q.O.Join))return s;let i=Promise.resolve();if(t.inviteSignUrl){const e=new URL(t.inviteSignUrl);e.searchParams.set("mxid",this.credentials.userId),i=this.http.requestOtherUrl(E.IT.Post,e)}const n={};t.viaServers&&(n.server_name=t.viaServers,n.via=t.viaServers);const o={},a=await i;a&&(o.third_party_signed=a);const d=h.RR("/join/$roomid",{$roomid:e}),c=(await this.http.authedRequest(E.IT.Post,d,n,o)).room_id,l=this.getRoom(c);if(null!=l&&l.hasMembershipState(this.credentials.userId,q.O.Join))return l;const u=new r.w_(this,this.clientOpts,this.buildSyncApiOptions()).createRoom(c);return t.syncRoom,u}knockRoom(e,t={}){const s=this.getRoom(e);if(null!=s&&s.hasMembershipState(this.credentials.userId,q.O.Knock))return Promise.resolve({room_id:s.roomId});const i=h.RR("/knock/$roomIdOrAlias",{$roomIdOrAlias:e}),n={};t.viaServers&&(n.server_name=t.viaServers,n.via=t.viaServers);const r={};return t.reason&&(r.reason=t.reason),this.http.authedRequest(E.IT.Post,i,n,r)}resendEvent(e,t){return this.toDeviceMessageQueue.sendQueue(),this.updatePendingEventStatus(t,e,o.fb.SENDING),this.encryptAndSendEvent(t,e)}cancelPendingEvent(e){if(![o.fb.QUEUED,o.fb.NOT_SENT,o.fb.ENCRYPTING].includes(e.status))throw new Error("cannot cancel an event with status "+e.status);e.status===o.fb.ENCRYPTING?this.eventsBeingEncrypted.delete(e.getId()):this.scheduler&&e.status===o.fb.QUEUED&&this.scheduler.removeEventFromQueue(e);const t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,o.fb.CANCELLED)}setRoomName(e,t){return this.sendStateEvent(e,M.Bx.RoomName,{name:t})}setRoomTopic(e,t,s){const i=C.makeTopicContent(t,s);return this.sendStateEvent(e,M.Bx.RoomTopic,i)}getRoomTags(e){const t=h.RR("/user/$userId/rooms/$roomId/tags",{$userId:this.credentials.userId,$roomId:e});return this.http.authedRequest(E.IT.Get,t)}setRoomTag(e,t,s={}){const i=h.RR("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(E.IT.Put,i,void 0,s)}deleteRoomTag(e,t){const s=h.RR("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(E.IT.Delete,s)}setRoomAccountData(e,t,s){const i=h.RR("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest(E.IT.Put,i,void 0,s)}async setPowerLevel(e,t,s){var i;let n;var r;this.clientRunning&&this.isInitialSyncComplete()&&(n=null===(r=this.getRoom(e))||void 0===r||null===(r=r.currentState)||void 0===r||null===(r=r.getStateEvents(M.Bx.RoomPowerLevels,""))||void 0===r?void 0:r.getContent());if(!n)try{n=await this.getStateEvent(e,M.Bx.RoomPowerLevels,"")}catch(e){if(!(e instanceof E.up&&"M_NOT_FOUND"===e.errcode))throw e;n={}}n=h.A4(n),null!==(i=n)&&void 0!==i&&i.users||(n.users={});const o=Array.isArray(t)?t:[t];for(const e of o)null==s?delete n.users[e]:n.users[e]=s;return this.sendStateEvent(e,M.Bx.RoomPowerLevels,n,"")}async unstable_createLiveBeacon(e,t){return this.unstable_setLiveBeacon(e,t)}async unstable_setLiveBeacon(e,t){return this.sendStateEvent(e,ie.E.name,t,this.getUserId())}sendEvent(e,t,s,i,n){let r,o,a,d;return null!=t&&t.startsWith(Ie)||null===t?(d=n,a=i,o=s,r=t):(d=i,a=s,o=t,r=null),this.addThreadRelationIfNeeded(a,r,e),this.sendCompleteEvent(e,r,{type:o,content:a},d)}addThreadRelationIfNeeded(e,t,s){var i;if(t&&(null===(i=e["m.relates_to"])||void 0===i||!i.rel_type)){var n,r;const i=!(null===(n=e["m.relates_to"])||void 0===n||!n["m.in_reply_to"]);e["m.relates_to"]=Se(Se({},e["m.relates_to"]),{},{rel_type:se.RN.name,event_id:t,is_falling_back:!i});const d=null===(r=this.getRoom(s))||void 0===r?void 0:r.getThread(t);var o,a;if(d&&!i)e["m.relates_to"]["m.in_reply_to"]={event_id:null!==(o=null===(a=d.lastReply((e=>e.isRelation(se.RN.name)&&!e.status)))||void 0===a?void 0:a.getId())&&void 0!==o?o:t}}}sendCompleteEvent(e,t,s,i,n){let r,a;"string"==typeof i?a=i:(r=i,a=n),a||(a=this.makeTxnId());const d=new o.kl(Object.assign(s,{event_id:"~"+e+":"+a,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:e,origin_server_ts:(new Date).getTime()})),c=this.getRoom(e),l=t?null==c?void 0:c.getThread(t):void 0;l&&d.setThread(l),r||(this.reEmitter.reEmit(d,[o.OQ.Replaced,o.OQ.VisibilityChange]),null==c||c.reEmitter.reEmit(d,[o.OQ.BeforeRedaction]));const u=d.getAssociatedId();if(null!=u&&u.startsWith("~")){const e=null==c?void 0:c.getPendingEvents().find((e=>e.getId()===u));null==e||e.once(o.OQ.LocalEventIdReplaced,(()=>{d.updateAssociatedId(e.getId())}))}const h=d.getType();return this.logger.debug(`sendEvent of type ${h} in ${e} with txnId ${a}${r?" (delayed event)":""}`),d.setTxnId(a),d.setStatus(o.fb.SENDING),r?this.encryptAndSendEvent(c,d,r):(null==c||c.addPendingEvent(d,a),d.status===o.fb.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(c,d))}async encryptAndSendEvent(e,t,s){if(s)return this.sendEventHttpRequest(t,s);try{let s;this.eventsBeingEncrypted.add(t.getId());try{await this.encryptEventIfNeeded(t,null!=e?e:void 0)}finally{s=!this.eventsBeingEncrypted.delete(t.getId())}if(s)return{};t.status===o.fb.ENCRYPTING&&this.updatePendingEventStatus(e,t,o.fb.SENDING);let i=null;return this.scheduler&&(i=this.scheduler.queueEvent(t),i&&this.scheduler.getQueueForEvent(t).length>1&&this.updatePendingEventStatus(e,t,o.fb.QUEUED)),i||(i=this.sendEventHttpRequest(t),e&&(i=i.then((s=>(e.updatePendingEvent(t,o.fb.SENT,s.event_id),s))))),await i}catch(s){this.logger.error("Error sending event",s);try{t.error=s,this.updatePendingEventStatus(e,t,o.fb.NOT_SENT)}catch(e){this.logger.error("Exception in error handler!",e)}throw s instanceof E.up&&(s.event=t),s}}async encryptEventIfNeeded(e,t){if(t&&await this.shouldEncryptEventForRoom(e,t)&&(this.cryptoBackend||!this.usingExternalCrypto)){if(!this.cryptoBackend)throw new Error("This room is configured to use encryption, but your client does not support encryption.");this.updatePendingEventStatus(t,e,o.fb.ENCRYPTING),await this.cryptoBackend.encryptEvent(e,t)}}async shouldEncryptEventForRoom(e,t){var s;return!e.isEncrypted()&&(e.getType()!==M.Bx.Reaction&&(!e.isRedaction()&&(!!t.hasEncryptionStateEvent()||!!await(null===(s=this.cryptoBackend)||void 0===s?void 0:s.isEncryptionEnabledInRoom(t.roomId)))))}getEncryptedIfNeededEventType(e,t){var s;return t===M.Bx.Reaction?t:null!==(s=this.getRoom(e))&&void 0!==s&&s.hasEncryptionStateEvent()?M.Bx.RoomMessageEncrypted:t}updatePendingEventStatus(e,t,s){e?e.updatePendingEvent(t,s):t.setStatus(s)}sendEventHttpRequest(e,t){let s=e.getTxnId();s||(s=this.makeTxnId(),e.setTxnId(s));const i={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:s};let n;if(e.isState()){let t="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(t="/rooms/$roomId/state/$eventType/$stateKey"),n=h.RR(t,i)}else if(e.isRedaction()&&e.event.redacts){const t="/rooms/$roomId/redact/$redactsEventId/$txnId";n=h.RR(t,Se({$redactsEventId:e.event.redacts},i))}else n=h.RR("/rooms/$roomId/send/$eventType/$txnId",i);const r=e.getWireContent();return t?this.http.authedRequest(E.IT.Put,n,Te(t),r):this.http.authedRequest(E.IT.Put,n,void 0,r).then((t=>(this.logger.debug(`Event sent to ${e.getRoomId()} with event id ${t.event_id}`),t)))}redactEvent(e,t,s,i,n){var r,o,a;null!==(r=s)&&void 0!==r&&r.startsWith(Ie)||(n=i,i=s,s=t,t=null);const d={reason:null===(o=n)||void 0===o?void 0:o.reason};if(void 0!==(null===(a=n)||void 0===a?void 0:a.with_rel_types)){if(this.canSupport.get(de.Xj.RelationBasedRedactions)===de.Tj.Unsupported)throw new Error(`Server does not support relation based redactions roomId ${e} eventId ${s} txnId: ${i} threadId ${t}`);d[this.canSupport.get(de.Xj.RelationBasedRedactions)===de.Tj.Stable?M.Z3.stable:M.Z3.unstable]=n.with_rel_types}return this.sendCompleteEvent(e,t,{type:M.Bx.RoomRedaction,content:d,redacts:s},i)}sendMessage(e,t,s,i){"string"!=typeof t&&null!==t&&(i=s,s=t,t=null);const n=M.Bx.RoomMessage,r=s;return this.sendEvent(e,t,n,r,i)}sendTextMessage(e,t,s,i){var n;null!==(n=t)&&void 0!==n&&n.startsWith(Ie)||null===t||(i=s,s=t,t=null);const r=C.makeTextMessage(s);return this.sendMessage(e,t,r,i)}sendNotice(e,t,s,i){var n;null!==(n=t)&&void 0!==n&&n.startsWith(Ie)||null===t||(i=s,s=t,t=null);const r=C.makeNotice(s);return this.sendMessage(e,t,r,i)}sendEmoteMessage(e,t,s,i){var n;null!==(n=t)&&void 0!==n&&n.startsWith(Ie)||null===t||(i=s,s=t,t=null);const r=C.makeEmoteMessage(s);return this.sendMessage(e,t,r,i)}sendImageMessage(e,t,s,i,n="Image"){var r;null!==(r=t)&&void 0!==r&&r.startsWith(Ie)||null===t||(n=i||"Image",i=s,s=t,t=null);const o={msgtype:M.Wr.Image,url:s,info:i,body:n};return this.sendMessage(e,t,o)}sendStickerMessage(e,t,s,i,n="Sticker"){var r;null!==(r=t)&&void 0!==r&&r.startsWith(Ie)||null===t||(n=i||"Sticker",i=s,s=t,t=null);const o={url:s,info:i,body:n};return this.sendEvent(e,t,M.Bx.Sticker,o)}sendHtmlMessage(e,t,s,i){var n;null!==(n=t)&&void 0!==n&&n.startsWith(Ie)||null===t||(i=s,s=t,t=null);const r=C.makeHtmlMessage(s,i);return this.sendMessage(e,t,r)}sendHtmlNotice(e,t,s,i){var n;null!==(n=t)&&void 0!==n&&n.startsWith(Ie)||null===t||(i=s,s=t,t=null);const r=C.makeHtmlNotice(s,i);return this.sendMessage(e,t,r)}sendHtmlEmote(e,t,s,i){var n;null!==(n=t)&&void 0!==n&&n.startsWith(Ie)||null===t||(i=s,s=t,t=null);const r=C.makeHtmlEmote(s,i);return this.sendMessage(e,t,r)}async _unstable_sendDelayedEvent(e,t,s,i,n,r){if(!await this.doesServerSupportUnstableFeature(we))throw Error("Server does not support the delayed events API");return this.addThreadRelationIfNeeded(n,s,e),this.sendCompleteEvent(e,s,{type:i,content:n},t,r)}async _unstable_sendDelayedStateEvent(e,t,s,i,n="",r={}){if(!await this.doesServerSupportUnstableFeature(we))throw Error("Server does not support the delayed events API");const o={$roomId:e,$eventType:s,$stateKey:n};let a=h.RR("/rooms/$roomId/state/$eventType",o);return void 0!==n&&(a=h.RR(a+"/$stateKey",o)),this.http.authedRequest(E.IT.Put,a,Te(t),i,r)}async _unstable_getDelayedEvents(e){if(!await this.doesServerSupportUnstableFeature(we))throw Error("Server does not support the delayed events API");const t=e?{from:e}:void 0;return await this.http.authedRequest(E.IT.Get,"/delayed_events",t,void 0,{prefix:`${E.iD.Unstable}/${we}`})}async _unstable_updateDelayedEvent(e,t){if(!await this.doesServerSupportUnstableFeature(we))throw Error("Server does not support the delayed events API");const s=h.RR("/delayed_events/$delayId",{$delayId:e}),i={action:t};return await this.http.authedRequest(E.IT.Post,s,void 0,i,{prefix:`${E.iD.Unstable}/${we}`})}async sendReceipt(e,t,s,i=!1){if(this.isGuest())return Promise.resolve({});const n=h.RR("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),r=!i&&this.supportsThreads()?Se(Se({},s),{},{thread_id:Ce(e)}):s,o=this.http.authedRequest(E.IT.Post,n,void 0,r||{}),a=this.getRoom(e.getRoomId());return a&&this.credentials.userId&&a.addLocalEchoReceipt(this.credentials.userId,e,t,i),o}async sendReadReceipt(e,t=ee.L.Read,s=!1){if(!e)return;const i=e.getId(),n=this.getRoom(e.getRoomId());if(null!=n&&n.hasPendingEvent(i))throw new Error(`Cannot set read receipt to a pending event (${i})`);return this.sendReceipt(e,t,{},s)}async setRoomReadMarkers(e,t,s,i){const n=this.getRoom(e);if(null!=n&&n.hasPendingEvent(t))throw new Error(`Cannot set read marker to a pending event (${t})`);let r,o;if(s){if(r=s.getId(),null!=n&&n.hasPendingEvent(r))throw new Error(`Cannot set read receipt to a pending event (${r})`);null==n||n.addLocalEchoReceipt(this.credentials.userId,s,ee.L.Read)}if(i){if(o=i.getId(),null!=n&&n.hasPendingEvent(o))throw new Error(`Cannot set read receipt to a pending event (${o})`);null==n||n.addLocalEchoReceipt(this.credentials.userId,i,ee.L.ReadPrivate)}return await this.setRoomReadMarkersHttpRequest(e,t,r,o)}getUrlPreview(e,t){t=6e4*Math.floor(t/6e4);const s=new URL(e);s.hash="";const i=t+"_"+(e=s.toString());if(i in this.urlPreviewCache)return this.urlPreviewCache[i];const n=this.http.authedRequest(E.IT.Get,"/preview_url",{url:e,ts:t.toString()},void 0,{prefix:E.zs.V3,priority:"low"});return this.urlPreviewCache[i]=n,n}sendTyping(e,t,s){if(this.isGuest())return Promise.resolve({});const i=h.RR("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.getUserId()}),n={typing:t};return t&&(n.timeout=s||2e4),this.http.authedRequest(E.IT.Put,i,void 0,n)}getRoomUpgradeHistory(e,t=!1,s=!1){const i=this.getRoom(e);if(!i)return[];return[...this.findPredecessorRooms(i,t,s),i,...this.findSuccessorRooms(i,t,s)]}findPredecessorRooms(e,t,s){var i;const n=[],r=new Set([e.roomId]);let o=null===(i=e.findPredecessor(s))||void 0===i?void 0:i.roomId;for(;null!==o;){var a;if(o){if(r.has(o))break;r.add(o)}const i=this.getRoom(o);if(null===i)break;if(t){const t=i.currentState.getStateEvents(M.Bx.RoomTombstone,"");if(!t||t.getContent().replacement_room!==e.roomId)break}n.splice(0,0,i),o=null===(a=(e=i).findPredecessor(s))||void 0===a?void 0:a.roomId}return n}findSuccessorRooms(e,t,s){const i=[];let n=e.currentState.getStateEvents(M.Bx.RoomTombstone,"");for(;n;){const o=this.getRoom(n.getContent().replacement_room);if(!o)break;if(o.roomId===e.roomId)break;if(t){var r;const t=null===(r=o.findPredecessor(s))||void 0===r?void 0:r.roomId;if(!t||t!==e.roomId)break}i.push(o);if(new Set(i.map((e=>e.roomId))).size<i.length)return i.slice(0,i.length-1);n=(e=o).currentState.getStateEvents(M.Bx.RoomTombstone,"")}return i}invite(e,t,s){return this.membershipChange(e,t,q.O.Invite,s)}inviteByEmail(e,t){return this.inviteByThreePid(e,"email",t)}async inviteByThreePid(e,t,s){var i;const n=h.RR("/rooms/$roomId/invite",{$roomId:e}),r=this.getIdentityServerUrl(!0);if(!r)return Promise.reject(new E.up({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));const o={id_server:r,medium:t,address:s};if(null!==(i=this.identityServer)&&void 0!==i&&i.getAccessToken){const e=await this.identityServer.getAccessToken();e&&(o.id_access_token=e)}return this.http.authedRequest(E.IT.Post,n,void 0,o)}leave(e){return this.membershipChange(e,void 0,q.O.Leave)}leaveRoomChain(e,t=!0){const s=this.getRoomUpgradeHistory(e);let i=s;if(!t){i=[];for(const t of s)if(i.push(t),t.roomId===e)break}const n={},r=[],o=e=>this.leave(e).then((()=>{delete n[e]})).catch((t=>{n[e]=t}));for(const e of i)r.push(o(e.roomId));return Promise.all(r).then((()=>n))}ban(e,t,s){return this.membershipChange(e,t,q.O.Ban,s)}forget(e,t=!0){const s=this.membershipChange(e,void 0,"forget");return t?s.then((t=>(this.store.removeRoom(e),this.emit(_e.DeleteRoom,e),t))):s}unban(e,t){const s=h.RR("/rooms/$roomId/unban",{$roomId:e}),i={user_id:t};return this.http.authedRequest(E.IT.Post,s,void 0,i)}kick(e,t,s){const i=h.RR("/rooms/$roomId/kick",{$roomId:e}),n={user_id:t,reason:s};return this.http.authedRequest(E.IT.Post,i,void 0,n)}membershipChange(e,t,s,i){const n=h.RR("/rooms/$room_id/$membership",{$room_id:e,$membership:s});return this.http.authedRequest(E.IT.Post,n,void 0,{user_id:t,reason:i})}getPushActionsForEvent(e,t=!1){if(!e.getPushActions()||t){const{actions:t,rule:s}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(t,s)}return e.getPushActions()}getPushDetailsForEvent(e,t=!1){if(!e.getPushDetails()||t){const{actions:t,rule:s}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(t,s)}return e.getPushDetails()}setProfileInfo(e,t){const s=h.RR("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this.http.authedRequest(E.IT.Put,s,void 0,t)}async setDisplayName(e){const t=await this.setProfileInfo("displayname",{displayname:e}),s=this.getUser(this.getUserId());return s&&(s.displayName=e,s.emit(I.U.DisplayName,s.events.presence,s)),t}async setAvatarUrl(e){const t=await this.setProfileInfo("avatar_url",{avatar_url:e}),s=this.getUser(this.getUserId());return s&&(s.avatarUrl=e,s.emit(I.U.AvatarUrl,s.events.presence,s)),t}mxcUrlToHttp(e,t,s,i,n,r,o){return(0,_.y)(this.baseUrl,e,t,s,i,n,r,o)}async setSyncPresence(e){var t;null===(t=this.syncApi)||void 0===t||t.setPresence(e)}async setPresence(e){const t=h.RR("/presence/$userId/status",{$userId:this.credentials.userId});if(-1===["offline","online","unavailable"].indexOf(e.presence))throw new Error("Bad presence value: "+e.presence);await this.http.authedRequest(E.IT.Put,t,void 0,e)}getPresence(e){const t=h.RR("/presence/$userId/status",{$userId:e});return this.http.authedRequest(E.IT.Get,t)}scrollback(e,t=30){let s=0,i=this.ongoingScrollbacks[e.roomId]||{};if(i.promise)return i.promise;if(i.errorTs){const e=Date.now()-i.errorTs;s=Math.max(3e3-e,0)}if(null===e.oldState.paginationToken)return Promise.resolve(e);const n=this.store.scrollback(e,t).length;if(n===t)return Promise.resolve(e);t-=n;const r=new Promise(((i,n)=>{(0,h.yy)(s).then((()=>this.createMessagesRequest(e.roomId,e.oldState.paginationToken,t,m.O.Backward))).then((t=>{var s,n;const r=t.chunk.map(this.getEventMapper());if(t.state){const s=t.state.map(this.getEventMapper());e.currentState.setUnknownStateEvents(s)}const[o,a,d]=e.partitionThreadedEvents(r);this.processAggregatedTimelineEvents(e,o),e.addEventsToTimeline(o,!0,e.getLiveTimeline()),this.processThreadEvents(e,a,!0),d.forEach((t=>e.relations.aggregateChildEvent(t))),e.oldState.paginationToken=null!==(s=t.end)&&void 0!==s?s:null,0===t.chunk.length&&(e.oldState.paginationToken=null),this.store.storeEvents(e,r,null!==(n=t.end)&&void 0!==n?n:null,!0),delete this.ongoingScrollbacks[e.roomId],i(e)})).catch((t=>{this.ongoingScrollbacks[e.roomId]={errorTs:Date.now()},n(t)}))}));return i={promise:r},this.ongoingScrollbacks[e.roomId]=i,r}getEventMapper(e){return function(e,t){let s=Boolean(t.preventReEmit);const i=!1!==t.decrypt;return function n(r){t.toDevice&&delete r.room_id;const a=e.getRoom(r.room_id);let d;a&&void 0===r.state_key&&(d=a.findEventById(r.event_id)),!d||d.status?d=new o.kl(r):(d.setUnsigned(P(P({},d.getUnsigned()),r.unsigned)),s=!0);const c=d.getServerAggregatedRelation(M.zZ.Replace);if(null!=c&&c.content){const e=n(c);d.makeReplaced(e)}const l=null==a?void 0:a.findThreadForEvent(d);return l&&d.setThread(l),d.isEncrypted()&&(s||e.reEmitter.reEmit(d,[o.OQ.Decrypted]),i&&e.decryptEventIfNeeded(d)),s||(e.reEmitter.reEmit(d,[o.OQ.Replaced,o.OQ.VisibilityChange]),null==a||a.reEmitter.reEmit(d,[o.OQ.BeforeRedaction])),d}}(this,e||{})}async getEventTimeline(e,t){var s,i,n,r;if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(null==e||!e.room)throw new Error("getEventTimeline only supports room timelines");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);if(e.thread&&this.supportsThreads())return this.getThreadTimeline(e,t);const o=h.RR("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t});let a;null!==(s=this.clientOpts)&&void 0!==s&&s.lazyLoadMembers&&(a={filter:JSON.stringify(c.d.LAZY_LOADING_MESSAGES_FILTER)});const d=await this.http.authedRequest(E.IT.Get,o,a);if(!d.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);const l=this.getEventMapper(),u=l(d.event);if(u.isRelation(se.RN.name))return void this.logger.warn("Tried loading a regular timeline at the position of a thread event");const p=[...d.events_after.reverse().map(l),u,...d.events_before.map(l)];let g=e.getTimelineForEvent(p[0].getId());g?g.getState(m.q.BACKWARDS).setUnknownStateEvents(d.state.map(l)):(g=e.addTimeline(),g.initialiseState(d.state.map(l)),g.getState(m.q.FORWARDS).paginationToken=d.end);const[v,f,y]=e.room.partitionThreadedEvents(p);return e.addEventsToTimeline(v,!0,g,d.start),this.processThreadEvents(e.room,f,!0),this.processAggregatedTimelineEvents(e.room,v),y.forEach((t=>e.relations.aggregateChildEvent(t))),null!==(i=null!==(n=e.getTimelineForEvent(t))&&void 0!==n?n:null===(r=e.room.findThreadForEvent(u))||void 0===r?void 0:r.liveTimeline)&&void 0!==i?i:g}async getThreadTimeline(e,t){var s;if(!this.supportsThreads())throw new Error("could not get thread timeline: no client support");if(!e.room)throw new Error("could not get thread timeline: not a room timeline");if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");const i=h.RR("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),n={limit:"0"};null!==(s=this.clientOpts)&&void 0!==s&&s.lazyLoadMembers&&(n.filter=JSON.stringify(c.d.LAZY_LOADING_MESSAGES_FILTER));const r=await this.http.authedRequest(E.IT.Get,i,n),o=this.getEventMapper(),a=o(r.event);if(!e.canContain(a))return;const d=this.canSupport.get(de.Xj.RelationsRecursion)!==de.Tj.Unsupported;if(se.jV.hasServerSideSupport){if(se.jV.hasServerSideFwdPaginationSupport){var l,u,p;if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");const s=e.thread,i=await this.fetchRelations(e.room.roomId,s.id,null,null,{dir:m.O.Backward,from:r.start,recurse:d||void 0}),n=await this.fetchRelations(e.room.roomId,s.id,null,null,{dir:m.O.Forward,from:r.end,recurse:d||void 0}),c=[...n.chunk.reverse().filter(me(s.id)).map(o),a,...i.chunk.filter(me(s.id)).map(o)];for(const t of c){var g;await(null===(g=e.thread)||void 0===g?void 0:g.processEvent(t))}let h=e.getTimelineForEvent(a.getId());if(h?h.getState(m.q.BACKWARDS).setUnknownStateEvents(r.state.map(o)):(h=e.addTimeline(),h.initialiseState(r.state.map(o))),e.addEventsToTimeline(c,!0,h,n.next_batch),!i.next_batch){const t=await this.fetchRoomEvent(e.room.roomId,s.id);e.addEventsToTimeline([o(t)],!0,h,null)}return h.setPaginationToken(null!==(l=i.next_batch)&&void 0!==l?l:null,m.O.Backward),h.setPaginationToken(null!==(u=n.next_batch)&&void 0!==u?u:null,m.O.Forward),this.processAggregatedTimelineEvents(e.room,c),null!==(p=e.getTimelineForEvent(t))&&void 0!==p?p:h}{var v;const t=e.thread,s=await this.fetchRelations(e.room.roomId,t.id,se.RN.name,null,{dir:m.O.Backward,from:r.start,recurse:d||void 0}),i=[];let n=r.end;for(;n;){var f;const s=await this.fetchRelations(e.room.roomId,t.id,se.RN.name,null,{dir:m.O.Forward,from:n,recurse:d||void 0});n=null!==(f=s.next_batch)&&void 0!==f?f:null,i.push(...s.chunk)}const c=[...i.reverse().map(o),a,...s.chunk.map(o)];for(const t of c){var y;await(null===(y=e.thread)||void 0===y?void 0:y.processEvent(t))}const l=e.getLiveTimeline();if(l.getState(m.q.BACKWARDS).setUnknownStateEvents(r.state.map(o)),e.addEventsToTimeline(c,!0,l,null),!s.next_batch){const s=await this.fetchRoomEvent(e.room.roomId,t.id);e.addEventsToTimeline([o(s)],!0,l,null)}return l.setPaginationToken(null!==(v=s.next_batch)&&void 0!==v?v:null,m.O.Backward),l.setPaginationToken(null,m.O.Forward),this.processAggregatedTimelineEvents(e.room,c),l}}}async getLatestTimeline(e){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!e.room)throw new Error("getLatestTimeline only supports room timelines");let t;if(null!==e.threadListType){var s;t=null===(s=(await this.createThreadListMessagesRequest(e.room.roomId,null,1,m.O.Backward,e.threadListType,e.getFilter())).chunk)||void 0===s?void 0:s[0]}else if(e.thread&&se.jV.hasServerSideSupport){var i;const s=this.canSupport.get(de.Xj.RelationsRecursion)!==de.Tj.Unsupported;t=null===(i=(await this.fetchRelations(e.room.roomId,e.thread.id,se.RN.name,null,{dir:m.O.Backward,limit:1,recurse:s||void 0})).chunk)||void 0===i?void 0:i[0]}else{var n,r;const s=h.RR("/rooms/$roomId/messages",{$roomId:e.room.roomId}),i={dir:"b"};null!==(n=this.clientOpts)&&void 0!==n&&n.lazyLoadMembers&&(i.filter=JSON.stringify(c.d.LAZY_LOADING_MESSAGES_FILTER));t=null===(r=(await this.http.authedRequest(E.IT.Get,s,i)).chunk)||void 0===r?void 0:r[0]}if(!t)throw new Error("No message returned when trying to construct getLatestTimeline");return this.getEventTimeline(e,t.event_id)}createMessagesRequest(e,t,s=30,i,n){var r;const o=h.RR("/rooms/$roomId/messages",{$roomId:e}),a={limit:s.toString(),dir:i};t&&(a.from=t);let d=null;var l;(null!==(r=this.clientOpts)&&void 0!==r&&r.lazyLoadMembers&&(d=Object.assign({},c.d.LAZY_LOADING_MESSAGES_FILTER)),n)&&(d=d||{},Object.assign(d,null===(l=n.getRoomTimelineFilterComponent())||void 0===l?void 0:l.toJSON()));return d&&(a.filter=JSON.stringify(d)),this.http.authedRequest(E.IT.Get,o,a)}createThreadListMessagesRequest(e,t,s=30,i=m.O.Backward,n=se.x3.All,r){var o;const a=h.RR("/rooms/$roomId/threads",{$roomId:e}),d={limit:s.toString(),dir:i,include:(0,se.UR)(n)};t&&(d.from=t);let l={};var u;(null!==(o=this.clientOpts)&&void 0!==o&&o.lazyLoadMembers&&(l=Se({},c.d.LAZY_LOADING_MESSAGES_FILTER)),r)&&(l=Se(Se({},l),null===(u=r.getRoomTimelineFilterComponent())||void 0===u?void 0:u.toJSON()));Object.keys(l).length&&(d.filter=JSON.stringify(l));const p={prefix:se.jV.hasServerSideListSupport===se.c1.Stable?E.iD.V1:"/_matrix/client/unstable/org.matrix.msc3856"};return this.http.authedRequest(E.IT.Get,a,d,void 0,p).then((e=>{var t;return Se(Se({},e),{},{chunk:null===(t=e.chunk)||void 0===t?void 0:t.reverse(),start:e.prev_batch,end:e.next_batch})}))}paginateEventTimeline(e,t){const s=e.getTimelineSet()===this.notifTimelineSet,i=this.getRoom(e.getRoomId()),n=e.getTimelineSet().threadListType,r=e.getTimelineSet().thread,o=(t=t||{}).backwards||!1;if(s&&!o)throw new Error("paginateNotifTimeline can only paginate backwards");const a=o?m.q.BACKWARDS:m.q.FORWARDS,d=e.getPaginationToken(a),c=e.paginationRequests[a];if(c)return c;let l,u,p;var g;if(s)l="/notifications",u={limit:(null!==(g=t.limit)&&void 0!==g?g:30).toString(),only:"highlight"},d&&"end"!==d&&(u.from=d),p=this.http.authedRequest(E.IT.Get,"/notifications",u).then((async t=>{const s=t.next_token,i=[];t.notifications=t.notifications.filter(h.O5);for(let e=0;e<t.notifications.length;e++){const s=t.notifications[e],n=this.getEventMapper()(s.event);this.getPushDetailsForEvent(n,!0),n.event.room_id=s.room_id,i[e]=n}const n=e.getTimelineSet();return n.addEventsToTimeline(i,o,e,s),this.processAggregatedTimelineEvents(n.room,i),o&&!t.next_token&&e.setPaginationToken(null,a),Boolean(t.next_token)})).finally((()=>{e.paginationRequests[a]=null})),e.paginationRequests[a]=p;else if(null!==n){if(!i)throw new Error("Unknown room "+e.getRoomId());if(!se.jV.hasServerSideFwdPaginationSupport&&a===m.O.Forward)throw new Error("Cannot paginate threads forwards without server-side support for MSC 3715");p=this.createThreadListMessagesRequest(e.getRoomId(),d,t.limit,a,n,e.getFilter()).then((t=>{if(t.state){const s=e.getState(a),i=t.state.filter(h.O5).map(this.getEventMapper());s.setUnknownStateEvents(i)}const s=t.end,n=t.chunk.filter(h.O5).map(this.getEventMapper());return e.getTimelineSet().addEventsToTimeline(n,o,e,s),this.processAggregatedTimelineEvents(i,n),this.processThreadRoots(i,n,o),o&&t.end==t.start&&e.setPaginationToken(null,a),t.end!==t.start})).finally((()=>{e.paginationRequests[a]=null})),e.paginationRequests[a]=p}else if(r){var v,f;const s=this.getRoom(null!==(v=e.getRoomId())&&void 0!==v?v:void 0);if(!s)throw new Error("Unknown room "+e.getRoomId());const i=this.canSupport.get(de.Xj.RelationsRecursion)!==de.Tj.Unsupported;p=this.fetchRelations(null!==(f=e.getRoomId())&&void 0!==f?f:"",r.id,null,null,{dir:a,limit:t.limit,from:null!=d?d:void 0,recurse:i||void 0}).then((async t=>{const i=this.getEventMapper(),n=t.chunk.filter(h.O5).filter(me(r.id)).map(i);for(const e of n.slice().reverse()){await(null==r?void 0:r.processEvent(e));const t=e.getSender();o&&null!==(null==r?void 0:r.getEventReadUpTo(t))||s.addLocalEchoReceipt(t,e,ee.L.Read)}const d=t.next_batch,c=e.getTimelineSet();if(c.addEventsToTimeline(n,o,e,null!=d?d:null),!d&&o){var l,u;const t=null!==(l=r.rootEvent)&&void 0!==l?l:i(await this.fetchRoomEvent(null!==(u=e.getRoomId())&&void 0!==u?u:"",r.id));c.addEventsToTimeline([t],!0,e,null)}return this.processAggregatedTimelineEvents(c.room,n),o&&!d&&e.setPaginationToken(null,a),Boolean(d)})).finally((()=>{e.paginationRequests[a]=null})),e.paginationRequests[a]=p}else{if(!i)throw new Error("Unknown room "+e.getRoomId());p=this.createMessagesRequest(e.getRoomId(),d,t.limit,a,e.getFilter()).then((t=>{if(t.state){const s=e.getState(a),i=t.state.filter(h.O5).map(this.getEventMapper());s.setUnknownStateEvents(i)}const s=t.end,n=t.chunk.filter(h.O5).map(this.getEventMapper()),r=e.getTimelineSet(),[d,,c]=i.partitionThreadedEvents(n);r.addEventsToTimeline(d,o,e,s),this.processAggregatedTimelineEvents(i,d),this.processThreadRoots(i,d.filter((e=>e.getServerAggregatedRelation(se.RN.name))),!1),c.forEach((e=>i.relations.aggregateChildEvent(e)));const l=void 0===t.end||t.end===t.start;return o&&l&&e.setPaginationToken(null,a),!l})).finally((()=>{e.paginationRequests[a]=null})),e.paginationRequests[a]=p}return p}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end")}peekInRoom(e,t=20){var s;return null===(s=this.peekSync)||void 0===s||s.stopPeeking(),this.peekSync=new r.w_(this,this.clientOpts,this.buildSyncApiOptions()),this.peekSync.peek(e,t)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(e,t){const s=this.sendStateEvent(e,M.Bx.RoomGuestAccess,{guest_access:t.allowJoin?x.rF.CanJoin:x.rF.Forbidden},"");let i=Promise.resolve();return t.allowRead&&(i=this.sendStateEvent(e,M.Bx.RoomHistoryVisibility,{history_visibility:x.Jv.WorldReadable},"")),Promise.all([i,s]).then()}requestRegisterEmailToken(e,t,s,i){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:s,next_link:i})}requestRegisterMsisdnToken(e,t,s,i,n){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:s,send_attempt:i,next_link:n})}requestAdd3pidEmailToken(e,t,s,i){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:s,next_link:i})}requestAdd3pidMsisdnToken(e,t,s,i,n){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:s,send_attempt:i,next_link:n})}requestPasswordEmailToken(e,t,s,i){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:s,next_link:i})}requestPasswordMsisdnToken(e,t,s,i,n){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:s,send_attempt:i,next_link:n})}async requestTokenFromEndpoint(e,t){const s=Object.assign({},t);return this.http.request(E.IT.Post,e,void 0,s)}getRoomPushRule(e,t){var s;if(this.pushRules)return null===(s=this.pushRules[e])||void 0===s||null===(s=s.room)||void 0===s?void 0:s.find((e=>e.rule_id===t));throw new Error("SyncApi.sync() must be done before accessing to push rules.")}setRoomMutePushRule(e,t,s){let i,n=!1;const r=this.getRoomPushRule(e,t);if(null!=r&&r.actions.includes(Q.YU.DontNotify)&&(n=!0),s)if(r){if(!n){const s=h.v6();this.deletePushRule(e,Q.Ji.RoomSpecific,r.rule_id).then((()=>{this.addPushRule(e,Q.Ji.RoomSpecific,t,{actions:[Q.YU.DontNotify]}).then((()=>{s.resolve()})).catch((e=>{s.reject(e)}))})).catch((e=>{s.reject(e)})),i=s.promise}}else i=this.addPushRule(e,Q.Ji.RoomSpecific,t,{actions:[Q.YU.DontNotify]});else n&&(i=this.deletePushRule(e,Q.Ji.RoomSpecific,r.rule_id));if(i)return new Promise(((e,t)=>{i.then((()=>{this.getPushRules().then((t=>{this.pushRules=t,e()})).catch((e=>{t(e)}))})).catch((e=>{this.getPushRules().then((s=>{this.pushRules=s,t(e)})).catch((s=>{t(e)}))}))}))}searchMessageText(e){const t={search_term:e.query};return"keys"in e&&(t.keys=e.keys),this.search({body:{search_categories:{room_events:t}}})}searchRoomEvents(e){const t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:z.g.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},s={_query:t,results:[],highlights:[]};return this.search({body:t}).then((e=>this.processRoomEventsSearch(s,e)))}backPaginateRoomEventsSearch(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;const t={body:e._query,next_batch:e.next_batch},s=this.search(t,e.abortSignal).then((t=>this.processRoomEventsSearch(e,t))).finally((()=>{e.pendingRequest=void 0}));return e.pendingRequest=s,s}processRoomEventsSearch(e,t){var s,i;const n=t.search_categories.room_events;e.count=n.count,e.next_batch=n.next_batch;const r=new Set(n.highlights);e.highlights.forEach((e=>{r.add(e)})),e.highlights=Array.from(r);const o=this.getEventMapper(),a=null!==(s=null===(i=n.results)||void 0===i?void 0:i.length)&&void 0!==s?s:0;for(let t=0;t<a;t++){const s=k.q.fromJson(n.results[t],o),i=this.getRoom(s.context.getEvent().getRoomId());if(i)for(const e of s.context.getTimeline()){const t=i.getMember(e.getSender());!e.sender&&t&&(e.sender=t)}e.results.push(s)}return e}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;const e=new r.w_(this,this.clientOpts,this.buildSyncApiOptions());return this.syncLeftRoomsPromise=e.syncLeftRooms(),this.syncLeftRoomsPromise.then((()=>{this.logger.debug("Marking success of sync left room request"),this.syncedLeftRooms=!0})).finally((()=>{this.syncLeftRoomsPromise=void 0})),this.syncLeftRoomsPromise}createFilter(e){const t=h.RR("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest(E.IT.Post,t,void 0,e).then((t=>{const s=c.d.fromJson(this.credentials.userId,t.filter_id,e);return this.store.storeFilter(s),s}))}getFilter(e,t,s){if(s){const s=this.store.getFilter(e,t);if(s)return Promise.resolve(s)}const i=h.RR("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this.http.authedRequest(E.IT.Get,i).then((s=>{const i=c.d.fromJson(e,t,s);return this.store.storeFilter(i),i}))}async getOrCreateFilter(e,t){const s=this.store.getFilterIdByName(e);let i;if(s){try{const e=await this.getFilter(this.credentials.userId,s,!0);if(e){const n=e.getDefinition(),r=t.getDefinition();h.ky(n,r)&&(i=s)}}catch(e){if("M_UNKNOWN"!==e.errcode&&"M_NOT_FOUND"!==e.errcode)throw e}i||this.store.setFilterIdByName(e,void 0)}if(i)return i;const n=await this.createFilter(t.getDefinition());return this.store.setFilterIdByName(e,n.filterId),n.filterId}getOpenIdToken(){const e=h.RR("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest(E.IT.Post,e,void 0,{})}turnServer(){return this.http.authedRequest(E.IT.Get,"/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}get pollingTurnServers(){return void 0!==this.checkTurnServersIntervalID}async checkTurnServers(){if(!this.canSupportVoip)return;let e=!1;const t=this.turnServersExpiry-Date.now();if(t>be)this.logger.debug("TURN creds are valid for another "+t+" ms: not fetching new ones."),e=!0;else{this.logger.debug("Fetching new TURN credentials");try{const t=await this.turnServer();if(t.uris){this.logger.debug("Got TURN URIs: "+t.uris+" refresh in "+t.ttl+" secs");const s={urls:t.uris,username:t.username,credential:t.password};this.turnServers=[s],this.turnServersExpiry=Date.now()+1e3*t.ttl,e=!0,this.emit(_e.TurnServers,this.turnServers)}}catch(e){this.logger.error("Failed to get TURN URIs",e),403===e.httpStatus?(this.logger.info("TURN access unavailable for this account: stopping credentials checks"),null!==this.checkTurnServersIntervalID&&s.g.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,this.emit(_e.TurnServersError,e,!0)):this.emit(_e.TurnServersError,e,!1)}}return e}setFallbackICEServerAllowed(e){this.fallbackICEServerAllowed=e}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){const e=h.RR("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest(E.IT.Get,e,void 0,void 0,{prefix:""}).then((e=>e.admin))}whoisSynapseUser(e){const t=h.RR("/_synapse/admin/v1/whois/$userId",{$userId:e});return this.http.authedRequest(E.IT.Get,t,void 0,void 0,{prefix:""})}deactivateSynapseUser(e){const t=h.RR("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this.http.authedRequest(E.IT.Post,t,void 0,void 0,{prefix:""})}async fetchClientWellKnown(){var e;this.clientWellKnownPromise=g.MN.getRawClientConfig(null!==(e=this.getDomain())&&void 0!==e?e:void 0),this.clientWellKnown=await this.clientWellKnownPromise,this.emit(_e.ClientWellKnown,this.clientWellKnown)}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){if(!this.clientRunning)throw new Error("Client is not running");return this.clientWellKnownPromise}storeClientOptions(){const e=["boolean","string","number"],t=Object.entries(this.clientOpts).filter((([t,s])=>e.includes(typeof s))).reduce(((e,[t,s])=>(e[t]=s,e)),{});return this.store.storeClientOptions(t)}async _unstable_getSharedRooms(e){const t=await this.doesServerSupportUnstableFeature("uk.half-shot.msc2666"),s=await this.doesServerSupportUnstableFeature("uk.half-shot.msc2666.mutual_rooms"),i=await this.doesServerSupportUnstableFeature("uk.half-shot.msc2666.query_mutual_rooms");if(!t&&!s&&!i)throw Error("Server does not support the Mutual Rooms API");let n,r;i?(n="/uk.half-shot.msc2666/user/mutual_rooms",r={user_id:e}):(n=h.RR(`/uk.half-shot.msc2666/user/${s?"mutual_rooms":"shared_rooms"}/$userId`,{$userId:e}),r={});const o=[];let a=null;do{const e={};null!=a&&i&&(e.batch_token=a);const t=await this.http.authedRequest(E.IT.Get,n,Se(Se({},r),e),void 0,{prefix:E.iD.Unstable});o.push(...t.joined),a=void 0!==t.next_batch_token?t.next_batch_token:null}while(null!=a);return o}async getVersions(){if(this.serverVersionsPromise)return this.serverVersionsPromise;this.serverVersionsPromise=this.http.authedRequest(E.IT.Get,"/_matrix/client/versions",void 0,void 0,{prefix:""}).catch((e=>{throw this.serverVersionsPromise=void 0,e}));const e=await this.serverVersionsPromise;return this.canSupport=await(0,de.yk)(e),this.serverVersionsPromise}async isVersionSupported(e){const{versions:t}=await this.getVersions();return t&&t.includes(e)}async doesServerSupportUnstableFeature(e){const t=await this.getVersions();if(!t)return!1;const s=t.unstable_features;return s&&!!s[e]}async doesServerForceEncryptionForPreset(e){const t=await this.getVersions();if(!t)return!1;const s=t.unstable_features,i=e.includes("_chat")?e.substring(0,e.indexOf("_chat")):e;return s&&!!s[`io.element.e2ee_forced.${i}`]}async doesServerSupportThread(){if(await this.isVersionSupported("v1.4"))return{threads:se.c1.Stable,list:se.c1.Stable,fwdPagination:se.c1.Stable};try{const[e,t,s,i,n,r]=await Promise.all([this.doesServerSupportUnstableFeature("org.matrix.msc3440"),this.doesServerSupportUnstableFeature("org.matrix.msc3440.stable"),this.doesServerSupportUnstableFeature("org.matrix.msc3856"),this.doesServerSupportUnstableFeature("org.matrix.msc3856.stable"),this.doesServerSupportUnstableFeature("org.matrix.msc3715"),this.doesServerSupportUnstableFeature("org.matrix.msc3715.stable")]);return{threads:(0,se.FD)(t,e),list:(0,se.FD)(i,s),fwdPagination:(0,se.FD)(r,n)}}catch(e){return{threads:se.c1.None,list:se.c1.None,fwdPagination:se.c1.None}}}hasLazyLoadMembersEnabled(){var e;return!(null===(e=this.clientOpts)||void 0===e||!e.lazyLoadMembers)}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}async relations(e,t,s,i,n={dir:m.O.Backward}){var r,o;const a=i?this.getEncryptedIfNeededEventType(e,i):null,[d,c]=await Promise.all([this.fetchRoomEvent(e,t),this.fetchRelations(e,t,s,a,n)]),l=this.getEventMapper(),u=d?l(d):void 0;let h=c.chunk.map(l);if(a===M.Bx.RoomMessageEncrypted){const e=u?h.concat(u):h;await Promise.all(e.map((e=>this.decryptEventIfNeeded(e)))),null!==i&&(h=h.filter((e=>e.getType()===i)))}return u&&s===M.zZ.Replace&&(h=h.filter((e=>e.getSender()===u.getSender()))),{originalEvent:null!=u?u:null,events:h,nextBatch:null!==(r=c.next_batch)&&void 0!==r?r:null,prevBatch:null!==(o=c.prev_batch)&&void 0!==o?o:null}}getCrossSigningCacheCallbacks(){var e;return null===(e=this.crypto)||void 0===e?void 0:e.crossSigningInfo.getCacheCallbacks()}generateClientSecret(){return(0,U.DU)(32)}decryptEventIfNeeded(e,t){return e.shouldAttemptDecryption()&&this.isCryptoEnabled()&&e.attemptDecryption(this.cryptoBackend,t),e.isBeingDecrypted()?e.getDecryptionPromise():Promise.resolve()}termsUrlForService(e,t){switch(e){case b.S.IS:return this.http.getUrl("/terms",void 0,E.Pw.V2,t);case b.S.IM:return this.http.getUrl("/terms",void 0,"/_matrix/integrations/v1",t);default:throw new Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(e=!1){var t,s;return e&&(null!==(t=this.idBaseUrl)&&void 0!==t&&t.startsWith("http://")||null!==(s=this.idBaseUrl)&&void 0!==s&&s.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(e){this.idBaseUrl=h.hc(e),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}getRefreshToken(){var e;return null!==(e=this.http.opts.refreshToken)&&void 0!==e?e:null}setAccessToken(e){this.http.opts.accessToken=e,this.serverVersionsPromise=void 0}isLoggedIn(){return void 0!==this.http.opts.accessToken}makeTxnId(){return"m"+(new Date).getTime()+"."+this.txnCtr++}isUsernameAvailable(e){return this.http.authedRequest(E.IT.Get,"/register/available",{username:e}).then((e=>e.available)).catch((e=>"M_USER_IN_USE"!==e.errcode&&Promise.reject(e)))}register(e,t,s,i,n,r,o){s&&(i.session=s);const a={auth:i,refresh_token:!0};return null!=e&&(a.username=e),null!=t&&(a.password=t),null!=r&&(a.guest_access_token=r),null!=o&&(a.inhibit_login=o),this.registerRequest(a)}registerGuest({body:e}={}){return this.registerRequest(e||{},"guest")}registerRequest(e,t){const s={};return t&&(s.kind=t),this.http.request(E.IT.Post,"/register",s,e)}refreshToken(e){const t=t=>this.http.authedRequest(E.IT.Post,"/refresh",void 0,{refresh_token:e},{prefix:t,inhibitLogoutEmit:!0});return t(E.iD.V3).catch((e=>{if("M_UNRECOGNIZED"===e.errcode)return t(E.iD.V1);throw e}))}loginFlows(){return this.http.request(E.IT.Get,"/login")}login(e,t){return this.http.authedRequest(E.IT.Post,"/login",void 0,Se(Se({},t),{},{type:e})).then((e=>(e.access_token&&e.user_id&&(this.http.opts.accessToken=e.access_token,this.credentials={userId:e.user_id}),e)))}loginWithPassword(e,t){return this.login("m.login.password",{user:e,password:t})}getCasLoginUrl(e){return this.getSsoLoginUrl(e,"cas")}getSsoLoginUrl(e,t="sso",s,i){let n="/login/"+t+"/redirect";s&&(n+="/"+s);const r={redirectUrl:e,[ke.unstable]:i};return this.http.getUrl(n,r).href}loginWithToken(e){return this.login("m.login.token",{token:e})}async logout(e=!1){var t;if(null!==(t=this.crypto)&&void 0!==t&&null!==(t=t.backupManager)&&void 0!==t&&t.getKeyBackupEnabled())try{for(;await this.crypto.backupManager.backupPendingKeys(200)>0;);}catch(e){this.logger.error("Key backup request failed when logging out. Some keys may be missing from backup",e)}return e&&(this.stopClient(),this.http.abort()),this.http.authedRequest(E.IT.Post,"/logout")}deactivateAccount(e,t){const s={};return e&&(s.auth=e),void 0!==t&&(s.erase=t),this.http.authedRequest(E.IT.Post,"/account/deactivate",void 0,s)}async requestLoginToken(e){const t={auth:e};return this.http.authedRequest(E.IT.Post,"/login/get_token",void 0,t,{prefix:E.iD.V1})}getFallbackAuthUrl(e,t){const s=h.RR("/auth/$loginType/fallback/web",{$loginType:e});return this.http.getUrl(s,{session:t}).href}async createRoom(e){var t;const s=(e.invite_3pid||[]).filter((e=>!e.id_access_token));if(s.length>0&&null!==(t=this.identityServer)&&void 0!==t&&t.getAccessToken){const e=await this.identityServer.getAccessToken();if(e)for(const t of s)t.id_access_token=e}return this.http.authedRequest(E.IT.Post,"/createRoom",void 0,e)}fetchRelations(e,t,s,i,n={dir:m.O.Backward}){let r=n;se.jV.hasServerSideFwdPaginationSupport===se.c1.Experimental&&(r=(0,h.Ab)("dir","org.matrix.msc3715.dir",r)),this.canSupport.get(de.Xj.RelationsRecursion)===de.Tj.Unstable&&(r=(0,h.Ab)("recurse","org.matrix.msc3981.recurse",r));const o=h.hm(r);let a="/rooms/$roomId/relations/$eventId";null!==s?(a+="/$relationType",null!==i&&(a+="/$eventType")):null!==i&&(this.logger.warn(`eventType: ${i} ignored when fetching\n            relations as relationType is null`),i=null);const d=h.RR(a+"?"+o,{$roomId:e,$eventId:t,$relationType:s,$eventType:i});return this.http.authedRequest(E.IT.Get,d,void 0,void 0,{prefix:E.iD.V1})}roomState(e){const t=h.RR("/rooms/$roomId/state",{$roomId:e});return this.http.authedRequest(E.IT.Get,t)}fetchRoomEvent(e,t){const s=h.RR("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(E.IT.Get,s)}members(e,t,s,i){const n={};t&&(n.membership=t),s&&(n.not_membership=s),i&&(n.at=i);const r=h.hm(n),o=h.RR("/rooms/$roomId/members?"+r,{$roomId:e});return this.http.authedRequest(E.IT.Get,o)}upgradeRoom(e,t){const s=h.RR("/rooms/$roomId/upgrade",{$roomId:e});return this.http.authedRequest(E.IT.Post,s,void 0,{new_version:t})}getStateEvent(e,t,s){const i={$roomId:e,$eventType:t,$stateKey:s};let n=h.RR("/rooms/$roomId/state/$eventType",i);return void 0!==s&&(n=h.RR(n+"/$stateKey",i)),this.http.authedRequest(E.IT.Get,n)}sendStateEvent(e,t,s,i="",n={}){const r={$roomId:e,$eventType:t,$stateKey:i};let o=h.RR("/rooms/$roomId/state/$eventType",r);return void 0!==i&&(o=h.RR(o+"/$stateKey",r)),this.http.authedRequest(E.IT.Put,o,void 0,s,n)}roomInitialSync(e,t){var s;const i=h.RR("/rooms/$roomId/initialSync",{$roomId:e});return this.http.authedRequest(E.IT.Get,i,{limit:null!==(s=null==t?void 0:t.toString())&&void 0!==s?s:"30"})}async setRoomReadMarkersHttpRequest(e,t,s,i){const n=h.RR("/rooms/$roomId/read_markers",{$roomId:e}),r={[ee.L.FullyRead]:t,[ee.L.Read]:s};return(await this.doesServerSupportUnstableFeature("org.matrix.msc2285.stable")||await this.isVersionSupported("v1.4"))&&(r[ee.L.ReadPrivate]=i),this.http.authedRequest(E.IT.Post,n,void 0,r)}getJoinedRooms(){const e=h.RR("/joined_rooms",{});return this.http.authedRequest(E.IT.Get,e)}getJoinedRoomMembers(e){const t=h.RR("/rooms/$roomId/joined_members",{$roomId:e});return this.http.authedRequest(E.IT.Get,t)}publicRooms(e={}){let{server:t,limit:s,since:n}=e,r=(0,i.A)(e,fe);if(0===Object.keys(r).length){const e={server:t,limit:s,since:n};return this.http.authedRequest(E.IT.Get,"/publicRooms",e)}{const e={server:t},i=Se({limit:s,since:n},r);return this.http.authedRequest(E.IT.Post,"/publicRooms",e,i)}}createAlias(e,t){const s=h.RR("/directory/room/$alias",{$alias:e}),i={room_id:t};return this.http.authedRequest(E.IT.Put,s,void 0,i)}deleteAlias(e){const t=h.RR("/directory/room/$alias",{$alias:e});return this.http.authedRequest(E.IT.Delete,t)}getLocalAliases(e){const t=h.RR("/rooms/$roomId/aliases",{$roomId:e}),s=E.iD.V3;return this.http.authedRequest(E.IT.Get,t,void 0,void 0,{prefix:s})}getRoomIdForAlias(e){const t=h.RR("/directory/room/$alias",{$alias:e});return this.http.authedRequest(E.IT.Get,t)}getRoomDirectoryVisibility(e){const t=h.RR("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(E.IT.Get,t)}setRoomDirectoryVisibility(e,t){const s=h.RR("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(E.IT.Put,s,void 0,{visibility:t})}searchUserDirectory({term:e,limit:t}){const s={search_term:e};return void 0!==t&&(s.limit=t),this.http.authedRequest(E.IT.Post,"/user_directory/search",void 0,s)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t){const s=t?h.RR("/profile/$userId/$info",{$userId:e,$info:t}):h.RR("/profile/$userId",{$userId:e});return this.http.authedRequest(E.IT.Get,s)}async doesServerSupportExtendedProfiles(){return this.doesServerSupportUnstableFeature("uk.tcpip.msc4133")}async getExtendedProfileRequestPrefix(){return await this.doesServerSupportUnstableFeature("uk.tcpip.msc4133.stable")?E.iD.V3:"/_matrix/client/unstable/uk.tcpip.msc4133"}async getExtendedProfile(e){if(!await this.doesServerSupportExtendedProfiles())throw new Error("Server does not support extended profiles");return this.http.authedRequest(E.IT.Get,h.RR("/profile/$userId",{$userId:e}),void 0,void 0,{prefix:await this.getExtendedProfileRequestPrefix()})}async getExtendedProfileProperty(e,t){if(!await this.doesServerSupportExtendedProfiles())throw new Error("Server does not support extended profiles");return(await this.http.authedRequest(E.IT.Get,h.RR("/profile/$userId/$key",{$userId:e,$key:t}),void 0,void 0,{prefix:await this.getExtendedProfileRequestPrefix()}))[t]}async setExtendedProfileProperty(e,t){if(!await this.doesServerSupportExtendedProfiles())throw new Error("Server does not support extended profiles");const s=this.getUserId();await this.http.authedRequest(E.IT.Put,h.RR("/profile/$userId/$key",{$userId:s,$key:e}),void 0,{[e]:t},{prefix:await this.getExtendedProfileRequestPrefix()})}async deleteExtendedProfileProperty(e){if(!await this.doesServerSupportExtendedProfiles())throw new Error("Server does not support extended profiles");const t=this.getUserId();await this.http.authedRequest(E.IT.Delete,h.RR("/profile/$userId/$key",{$userId:t,$key:e}),void 0,void 0,{prefix:await this.getExtendedProfileRequestPrefix()})}async patchExtendedProfile(e){if(!await this.doesServerSupportExtendedProfiles())throw new Error("Server does not support extended profiles");const t=this.getUserId();return this.http.authedRequest(E.IT.Patch,h.RR("/profile/$userId",{$userId:t}),{},e,{prefix:await this.getExtendedProfileRequestPrefix()})}async setExtendedProfile(e){if(!await this.doesServerSupportExtendedProfiles())throw new Error("Server does not support extended profiles");const t=this.getUserId();await this.http.authedRequest(E.IT.Put,h.RR("/profile/$userId",{$userId:t}),{},e,{prefix:await this.getExtendedProfileRequestPrefix()})}getThreePids(){return this.http.authedRequest(E.IT.Get,"/account/3pid")}async addThreePidOnly(e){return this.http.authedRequest(E.IT.Post,"/account/3pid/add",void 0,e)}async bindThreePid(e){return this.http.authedRequest(E.IT.Post,"/account/3pid/bind",void 0,e)}async unbindThreePid(e,t){const s={medium:e,address:t,id_server:this.getIdentityServerUrl(!0)};return this.http.authedRequest(E.IT.Post,"/account/3pid/unbind",void 0,s)}deleteThreePid(e,t){return this.http.authedRequest(E.IT.Post,"/account/3pid/delete",void 0,{medium:e,address:t})}setPassword(e,t,s){const i={auth:e,new_password:t,logout_devices:s};return this.http.authedRequest(E.IT.Post,"/account/password",void 0,i)}getDevices(){return this.http.authedRequest(E.IT.Get,"/devices")}getDevice(e){const t=h.RR("/devices/$device_id",{$device_id:e});return this.http.authedRequest(E.IT.Get,t)}setDeviceDetails(e,t){const s=h.RR("/devices/$device_id",{$device_id:e});return this.http.authedRequest(E.IT.Put,s,void 0,t)}deleteDevice(e,t){const s=h.RR("/devices/$device_id",{$device_id:e}),i={};return t&&(i.auth=t),this.http.authedRequest(E.IT.Delete,s,void 0,i)}deleteMultipleDevices(e,t){const s={devices:e};t&&(s.auth=t);return this.http.authedRequest(E.IT.Post,"/delete_devices",void 0,s)}async getPushers(){const e=await this.http.authedRequest(E.IT.Get,"/pushers");return await this.doesServerSupportUnstableFeature("org.matrix.msc3881")||(e.pushers=e.pushers.map((e=>(e.hasOwnProperty(M.cr.name)||(e[M.cr.name]=!0),e)))),e}setPusher(e){return this.http.authedRequest(E.IT.Post,"/pushers/set",void 0,e)}removePusher(e,t){const s={pushkey:e,app_id:t,kind:null};return this.http.authedRequest(E.IT.Post,"/pushers/set",void 0,s)}setLocalNotificationSettings(e,t){const s=`${M.Xs.name}.${e}`;return this.setAccountData(s,t)}getPushRules(){return this.http.authedRequest(E.IT.Get,"/pushrules/").then((e=>(this.setPushRules(e),this.pushRules)))}setPushRules(e){this.pushRules=p.j.rewriteDefaultRules(e,this.getUserId()),this.pushProcessor.updateCachedPushRuleKeys(this.pushRules)}addPushRule(e,t,s,i){const n=h.RR("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:s});return this.http.authedRequest(E.IT.Put,n,void 0,i)}deletePushRule(e,t,s){const i=h.RR("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:s});return this.http.authedRequest(E.IT.Delete,i)}setPushRuleEnabled(e,t,s,i){const n=h.RR("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:s});return this.http.authedRequest(E.IT.Put,n,void 0,{enabled:i})}setPushRuleActions(e,t,s,i){const n=h.RR("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:s});return this.http.authedRequest(E.IT.Put,n,void 0,{actions:i})}search({body:e,next_batch:t},s){const i={};return t&&(i.next_batch=t),this.http.authedRequest(E.IT.Post,"/search",i,e,{abortSignal:s})}uploadKeysRequest(e,t){return this.http.authedRequest(E.IT.Post,"/keys/upload",void 0,e)}uploadKeySignatures(e){return this.http.authedRequest(E.IT.Post,"/keys/signatures/upload",void 0,e)}downloadKeysForUsers(e,{token:t}={}){const s={device_keys:{}};return void 0!==t&&(s.token=t),e.forEach((e=>{s.device_keys[e]=[]})),this.http.authedRequest(E.IT.Post,"/keys/query",void 0,s)}claimOneTimeKeys(e,t="signed_curve25519",s){const i={};void 0===t&&(t="signed_curve25519");for(const[s,n]of e){const e=i[s]||{};(0,h.C6)(i,s,e),(0,h.C6)(e,n,t)}const n={one_time_keys:i};s&&(n.timeout=s);return this.http.authedRequest(E.IT.Post,"/keys/claim",void 0,n)}getKeyChanges(e,t){const s={from:e,to:t};return this.http.authedRequest(E.IT.Get,"/keys/changes",s)}uploadDeviceSigningKeys(e,t){const s=Object.assign({},t);return e&&Object.assign(s,{auth:e}),this.http.authedRequest(E.IT.Post,"/keys/device_signing/upload",void 0,s,{prefix:E.iD.Unstable})}registerWithIdentityServer(e){if(!this.idBaseUrl)throw new Error("No identity server base URL set");const t=this.http.getUrl("/account/register",void 0,E.Pw.V2,this.idBaseUrl);return this.http.requestOtherUrl(E.IT.Post,t,e)}requestEmailToken(e,t,s,i,n){const r={client_secret:t,email:e,send_attempt:null==s?void 0:s.toString()};return i&&(r.next_link=i),this.http.idServerRequest(E.IT.Post,"/validate/email/requestToken",r,E.Pw.V2,n)}requestMsisdnToken(e,t,s,i,n,r){const o={client_secret:s,country:e,phone_number:t,send_attempt:null==i?void 0:i.toString()};return n&&(o.next_link=n),this.http.idServerRequest(E.IT.Post,"/validate/msisdn/requestToken",o,E.Pw.V2,r)}submitMsisdnToken(e,t,s,i){const n={sid:e,client_secret:t,token:s};return this.http.idServerRequest(E.IT.Post,"/validate/msisdn/submitToken",n,E.Pw.V2,null!=i?i:void 0)}submitMsisdnTokenOtherUrl(e,t,s,i){const n={sid:t,client_secret:s,token:i};return this.http.requestOtherUrl(E.IT.Post,e,n)}getIdentityHashDetails(e){return this.http.idServerRequest(E.IT.Get,"/hash_details",void 0,E.Pw.V2,e)}async identityHashedLookup(e,t){const s={},i=await this.getIdentityHashDetails(t);if(!i||!i.lookup_pepper||!i.algorithms)throw new Error("Unsupported identity server: bad response");s.pepper=i.lookup_pepper;const n={};if(i.algorithms.includes("sha256"))s.addresses=await Promise.all(e.map((async e=>{const t=e[0].toLowerCase(),i=e[1].toLowerCase(),r=await(0,ge.s)(`${t} ${i} ${s.pepper}`),o=(0,f.A4)(r);return n[o]=e[0],o}))),s.algorithm="sha256";else{if(!i.algorithms.includes("none"))throw new Error("Unsupported identity server: unknown hash algorithm");s.addresses=e.map((e=>{const t=`${e[0].toLowerCase()} ${e[1].toLowerCase()}`;return n[t]=e[0],t})),s.algorithm="none"}const r=await this.http.idServerRequest(E.IT.Post,"/lookup",s,E.Pw.V2,t);if(null==r||!r.mappings)return[];const o=[];for(const e of Object.keys(r.mappings)){const t=r.mappings[e],s=n[e];if(!s)throw new Error("Identity server returned more results than expected");o.push({address:s,mxid:t})}return o}async lookupThreePid(e,t,s){const i=(await this.identityHashedLookup([[t,e]],s)).find((e=>e.address===t));if(!i)return{};return{address:t,medium:e,mxid:i.mxid}}async bulkLookupThreePids(e,t){const s=await this.identityHashedLookup(e.map((e=>[e[1],e[0]])),t),i=[];for(const t of s){const s=e.find((e=>e[1]===t.address));if(!s)throw new Error("Identity sever returned unexpected results");i.push([s[0],t.address,t.mxid])}return{threepids:i}}getIdentityAccount(e){return this.http.idServerRequest(E.IT.Get,"/account",void 0,E.Pw.V2,e)}sendToDevice(e,t,s){const i=h.RR("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:s||this.makeTxnId()}),n={messages:h.HF(t)},r=new Map;for(const[e,s]of t)r.set(e,Array.from(s.keys()));return this.logger.debug(`PUT ${i}`,r),this.http.authedRequest(E.IT.Put,i,void 0,n)}queueToDevice(e){return this.toDeviceMessageQueue.queueBatch(e)}getThirdpartyProtocols(){return this.http.authedRequest(E.IT.Get,"/thirdparty/protocols").then((e=>{if(!e||"object"!=typeof e)throw new Error(`/thirdparty/protocols did not return an object: ${e}`);return e}))}getThirdpartyLocation(e,t){const s=h.RR("/thirdparty/location/$protocol",{$protocol:e});return this.http.authedRequest(E.IT.Get,s,t)}getThirdpartyUser(e,t){const s=h.RR("/thirdparty/user/$protocol",{$protocol:e});return this.http.authedRequest(E.IT.Get,s,t)}getTerms(e,t){const s=this.termsUrlForService(e,t);return this.http.requestOtherUrl(E.IT.Get,s)}agreeToTerms(e,t,s,i){const n=this.termsUrlForService(e,t),r={Authorization:"Bearer "+s};return this.http.requestOtherUrl(E.IT.Post,n,{user_accepts:i},{headers:r})}reportEvent(e,t,s,i){const n=h.RR("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(E.IT.Post,n,void 0,{score:s,reason:i})}getRoomHierarchy(e,t,s,i=!1,n){const r=h.RR("/rooms/$roomId/hierarchy",{$roomId:e}),o={suggested_only:String(i),max_depth:null==s?void 0:s.toString(),from:n,limit:null==t?void 0:t.toString()};return this.http.authedRequest(E.IT.Get,r,o,void 0,{prefix:E.iD.V1}).catch((e=>{if("M_UNRECOGNIZED"===e.errcode)return this.http.authedRequest(E.IT.Get,r,o,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2946"});throw e}))}async unstableCreateFileTree(e){const{room_id:t}=await this.createRoom({name:e,preset:x.k.PrivateChat,power_level_content_override:Se(Se({},H),{},{users:{[this.getUserId()]:100}}),creation_content:{[M.Ct]:M.CJ.Space},initial_state:[{type:M.D7.name,state_key:M.nN.name,content:{[M.ud.name]:!0}},{type:M.Bx.RoomEncryption,state_key:"",content:{algorithm:v.MEGOLM_ALGORITHM}}]});return new J(this,t)}unstableGetFileTreeSpace(e){var t,s;const i=this.getRoom(e);if((null==i?void 0:i.getMyMembership())!==q.O.Join)return null;const n=i.currentState.getStateEvents(M.Bx.RoomCreate,""),r=i.currentState.getStateEvents(M.D7.name,M.nN.name);if(!n)throw new Error("Expected single room create event");return null!=r&&null!==(t=r.getContent())&&void 0!==t&&t[M.ud.name]?(null===(s=n.getContent())||void 0===s?void 0:s[M.Ct])!==M.CJ.Space?null:new J(this,e):null}slidingSync(e,t,s){const i={};e.pos&&(i.pos=e.pos,delete e.pos),e.timeout&&(i.timeout=e.timeout,delete e.timeout);const n=e.clientTimeout;return delete e.clientTimeout,this.http.authedRequest(E.IT.Post,"/sync",i,e,{prefix:"/_matrix/client/unstable/org.matrix.msc3575",baseUrl:t,localTimeoutMs:n,abortSignal:s})}supportsThreads(){var e;return(null===(e=this.clientOpts)||void 0===e?void 0:e.threadSupport)||!1}supportsIntentionalMentions(){return this.canSupport.get(de.Xj.IntentionalMentions)!==de.Tj.Unsupported}async getRoomSummary(e,t){const s={prefix:"/_matrix/client/unstable/im.nheko.summary"};try{const i=h.RR("/summary/$roomid",{$roomid:e});return await this.http.authedRequest(E.IT.Get,i,{via:t},void 0,s)}catch(i){if(i instanceof E.up&&"M_UNRECOGNIZED"===i.errcode){const i=h.RR("/rooms/$roomid/summary",{$roomid:e});return await this.http.authedRequest(E.IT.Get,i,{via:t},void 0,s)}throw i}}processThreadEvents(e,t,s){e.processThreadedEvents(t,s)}processThreadRoots(e,t,s){this.supportsThreads()&&e.processThreadRoots(t,s)}processBeaconEvents(e,t){this.processAggregatedTimelineEvents(e,t)}processAggregatedTimelineEvents(e,t){null!=t&&t.length&&e&&(e.currentState.processBeaconEvents(t,this),e.processPollEvents(t))}async whoami(){return this.http.authedRequest(E.IT.Get,"/account/whoami")}async timestampToEvent(e,t,s){const i=h.RR("/rooms/$roomId/timestamp_to_event",{$roomId:e}),n={ts:t.toString(),dir:s};try{return await this.http.authedRequest(E.IT.Get,i,n,void 0,{prefix:E.iD.V1})}catch(e){if("M_UNRECOGNIZED"===e.errcode&&(400===e.httpStatus||404===e.httpStatus||405===e.httpStatus))return await this.http.authedRequest(E.IT.Get,i,n,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc3030"});throw e}}async getAuthIssuer(){return this.http.request(E.IT.Get,"/auth_issuer",void 0,void 0,{prefix:E.iD.Unstable+"/org.matrix.msc2965"})}}function Te(e){return Object.fromEntries(Object.entries(e).map((([e,t])=>[`${we}.${e}`,t])))}function Ce(e){return Ae(e)?ee.S:e.threadRootId}function Ae(e){if(!e.threadRootId)return!0;if(e.isThreadRoot)return!0;if(!e.isRelation())return S.v.warn(`Event is not a relation or a thread root, but still has a threadRootId! id=${e.getId()}`),!0;if(e.isRelation(se.RN.name))return!1;return e.relationEventId===e.threadRootId}(0,n.A)(Re,"RESTORE_BACKUP_ERROR_BAD_KEY","RESTORE_BACKUP_ERROR_BAD_KEY")},"./node_modules/matrix-js-sdk/src/common-crypto/CryptoBackend.ts":(e,t,s)=>{"use strict";s.d(t,{O:()=>n});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js");class n extends Error{constructor(e,t,s){super(t),(0,i.A)(this,"detailedString",void 0),this.code=e,this.name="DecryptionError",this.detailedString=function(e,t){let s=e.name+"[msg: "+e.message;t&&(s+=", "+Object.keys(t).map((e=>e+": "+t[e])).join(", "));return s+="]",s}(this,s)}}},"./node_modules/matrix-js-sdk/src/common-crypto/key-passphrase.ts":(e,t,s)=>{"use strict";s.d(t,{c:()=>n});var i=s("./node_modules/matrix-js-sdk/src/crypto-api/index.ts");function n(e,t){if(!e.private_key_salt||!e.private_key_iterations)throw new Error("Salt and/or iterations not found: this backup cannot be restored with a passphrase");return(0,i.deriveRecoveryKeyFromPassphrase)(t,e.private_key_salt,e.private_key_iterations,e.private_key_bits)}},"./node_modules/matrix-js-sdk/src/content-helpers.ts":(e,t,s)=>{"use strict";s.d(t,{makeEmoteMessage:()=>h,makeHtmlEmote:()=>c,makeHtmlMessage:()=>a,makeHtmlNotice:()=>d,makeNotice:()=>u,makeTextMessage:()=>l,makeTopicContent:()=>m,parseBeaconContent:()=>g,parseBeaconInfoContent:()=>p});var i=s("./node_modules/matrix-js-sdk/src/@types/event.ts"),n=(s("./node_modules/matrix-js-sdk/src/@types/extensible_events.ts"),s("./node_modules/matrix-js-sdk/src/extensible_events_v1/utilities.ts")),r=s("./node_modules/matrix-js-sdk/src/@types/location.ts"),o=s("./node_modules/matrix-js-sdk/src/@types/topic.ts");function a(e,t){return{msgtype:i.Wr.Text,format:"org.matrix.custom.html",body:e,formatted_body:t}}function d(e,t){return{msgtype:i.Wr.Notice,format:"org.matrix.custom.html",body:e,formatted_body:t}}function c(e,t){return{msgtype:i.Wr.Emote,format:"org.matrix.custom.html",body:e,formatted_body:t}}function l(e){return{msgtype:i.Wr.Text,body:e}}function u(e){return{msgtype:i.Wr.Notice,body:e}}function h(e){return{msgtype:i.Wr.Emote,body:e}}const m=(e,t)=>{const s=[{body:e,mimetype:"text/plain"}];return(0,n.c)(t)&&s.push({body:t,mimetype:"text/html"}),{topic:e,[o.s.name]:s}},p=e=>{var t;const{description:s,timeout:i,live:n}=e,o=null!==(t=r.vo.findIn(e))&&void 0!==t?t:void 0,a=r.J1.findIn(e);return{description:s,timeout:i,live:n,assetType:null==a?void 0:a.type,timestamp:o}},g=e=>{var t;const s=r.M6.findIn(e),i=null!==(t=r.vo.findIn(e))&&void 0!==t?t:void 0;return{description:null==s?void 0:s.description,uri:null==s?void 0:s.uri,timestamp:i}}},"./node_modules/matrix-js-sdk/src/content-repo.ts":(e,t,s)=>{"use strict";s.d(t,{y:()=>n});var i=s("./node_modules/matrix-js-sdk/src/utils.ts");function n(e,t,s,n,r,o=!1,a,d){if("string"!=typeof t||!t)return"";if(0!==t.indexOf("mxc://"))return o?t:"";d&&(a=!0);let c,l=t.slice(6);c=d?"/_matrix/client/v1/media/download/":"/_matrix/media/v3/download/";const u={};s&&(u.width=Math.round(s).toString()),n&&(u.height=Math.round(n).toString()),r&&(u.method=r),Object.keys(u).length>0&&(c=d?"/_matrix/client/v1/media/thumbnail/":"/_matrix/media/v3/thumbnail/"),"boolean"==typeof a&&(u.allow_redirect=JSON.stringify(a));const h=l.indexOf("#");let m="";h>=0&&(m=l.slice(h),l=l.slice(0,h));return e+c+l+(0===Object.keys(u).length?"":"?"+(0,i.hm)(u))+m}},"./node_modules/matrix-js-sdk/src/crypto-api/index.ts":(e,t,s)=>{"use strict";s.d(t,{AllDevicesIsolationMode:()=>c,CrossSigningKey:()=>h,DecryptionFailureCode:()=>a,DeviceIsolationModeKind:()=>d,DeviceVerificationStatus:()=>u,EventShieldColour:()=>m,EventShieldReason:()=>p,UserVerificationStatus:()=>l,decodeRecoveryKey:()=>n.R,deriveRecoveryKeyFromPassphrase:()=>o,encodeRecoveryKey:()=>n.j});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=(s("./node_modules/matrix-js-sdk/src/crypto-api/verification.ts"),s("./node_modules/matrix-js-sdk/src/crypto-api/recovery-key.ts"));const r=256;async function o(e,t,s,i=r){if(!globalThis.crypto.subtle||!TextEncoder)throw new Error("Password-based backup is not available on this platform");const n=await globalThis.crypto.subtle.importKey("raw",(new TextEncoder).encode(e),{name:"PBKDF2"},!1,["deriveBits"]),o=await globalThis.crypto.subtle.deriveBits({name:"PBKDF2",salt:(new TextEncoder).encode(t),iterations:s,hash:"SHA-512"},n,i);return new Uint8Array(o)}let a=function(e){return e.MEGOLM_UNKNOWN_INBOUND_SESSION_ID="MEGOLM_UNKNOWN_INBOUND_SESSION_ID",e.MEGOLM_KEY_WITHHELD="MEGOLM_KEY_WITHHELD",e.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE="MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE",e.OLM_UNKNOWN_MESSAGE_INDEX="OLM_UNKNOWN_MESSAGE_INDEX",e.HISTORICAL_MESSAGE_NO_KEY_BACKUP="HISTORICAL_MESSAGE_NO_KEY_BACKUP",e.HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED="HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED",e.HISTORICAL_MESSAGE_WORKING_BACKUP="HISTORICAL_MESSAGE_WORKING_BACKUP",e.HISTORICAL_MESSAGE_USER_NOT_JOINED="HISTORICAL_MESSAGE_USER_NOT_JOINED",e.SENDER_IDENTITY_PREVIOUSLY_VERIFIED="SENDER_IDENTITY_PREVIOUSLY_VERIFIED",e.UNSIGNED_SENDER_DEVICE="UNSIGNED_SENDER_DEVICE",e.UNKNOWN_SENDER_DEVICE="UNKNOWN_SENDER_DEVICE",e.UNKNOWN_ERROR="UNKNOWN_ERROR",e.MEGOLM_BAD_ROOM="MEGOLM_BAD_ROOM",e.MEGOLM_MISSING_FIELDS="MEGOLM_MISSING_FIELDS",e.OLM_DECRYPT_GROUP_MESSAGE_ERROR="OLM_DECRYPT_GROUP_MESSAGE_ERROR",e.OLM_BAD_ENCRYPTED_MESSAGE="OLM_BAD_ENCRYPTED_MESSAGE",e.OLM_BAD_RECIPIENT="OLM_BAD_RECIPIENT",e.OLM_BAD_RECIPIENT_KEY="OLM_BAD_RECIPIENT_KEY",e.OLM_BAD_ROOM="OLM_BAD_ROOM",e.OLM_BAD_SENDER_CHECK_FAILED="OLM_BAD_SENDER_CHECK_FAILED",e.OLM_BAD_SENDER="OLM_BAD_SENDER",e.OLM_FORWARDED_MESSAGE="OLM_FORWARDED_MESSAGE",e.OLM_MISSING_CIPHERTEXT="OLM_MISSING_CIPHERTEXT",e.OLM_NOT_INCLUDED_IN_RECIPIENTS="OLM_NOT_INCLUDED_IN_RECIPIENTS",e.UNKNOWN_ENCRYPTION_ALGORITHM="UNKNOWN_ENCRYPTION_ALGORITHM",e}({}),d=function(e){return e[e.AllDevicesIsolationMode=0]="AllDevicesIsolationMode",e[e.OnlySignedDevicesIsolationMode=1]="OnlySignedDevicesIsolationMode",e}({});class c{constructor(e){(0,i.A)(this,"kind",d.AllDevicesIsolationMode),this.errorOnVerifiedUserProblems=e}}class l{constructor(e,t,s,n=!1){(0,i.A)(this,"needsUserApproval",void 0),this.crossSigningVerified=e,this.crossSigningVerifiedBefore=t,this.tofu=s,this.needsUserApproval=n}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this.crossSigningVerified}wasCrossSigningVerified(){return this.crossSigningVerifiedBefore}isTofu(){return this.tofu}}class u{constructor(e){var t,s,n,r,o;(0,i.A)(this,"signedByOwner",void 0),(0,i.A)(this,"crossSigningVerified",void 0),(0,i.A)(this,"tofu",void 0),(0,i.A)(this,"localVerified",void 0),(0,i.A)(this,"trustCrossSignedDevices",void 0),this.signedByOwner=null!==(t=e.signedByOwner)&&void 0!==t&&t,this.crossSigningVerified=null!==(s=e.crossSigningVerified)&&void 0!==s&&s,this.tofu=null!==(n=e.tofu)&&void 0!==n&&n,this.localVerified=null!==(r=e.localVerified)&&void 0!==r&&r,this.trustCrossSignedDevices=null!==(o=e.trustCrossSignedDevices)&&void 0!==o&&o}isVerified(){return this.localVerified||this.trustCrossSignedDevices&&this.crossSigningVerified}}let h=function(e){return e.Master="master",e.SelfSigning="self_signing",e.UserSigning="user_signing",e}({}),m=function(e){return e[e.NONE=0]="NONE",e[e.GREY=1]="GREY",e[e.RED=2]="RED",e}({}),p=function(e){return e[e.UNKNOWN=0]="UNKNOWN",e[e.UNVERIFIED_IDENTITY=1]="UNVERIFIED_IDENTITY",e[e.UNSIGNED_DEVICE=2]="UNSIGNED_DEVICE",e[e.UNKNOWN_DEVICE=3]="UNKNOWN_DEVICE",e[e.AUTHENTICITY_NOT_GUARANTEED=4]="AUTHENTICITY_NOT_GUARANTEED",e[e.MISMATCHED_SENDER_KEY=5]="MISMATCHED_SENDER_KEY",e}({})},"./node_modules/matrix-js-sdk/src/crypto-api/recovery-key.ts":(e,t,s)=>{"use strict";s.d(t,{R:()=>c,j:()=>d});const i=function(e){if(e.length>=255)throw new TypeError("Alphabet too long");const t=new Uint8Array(256);for(let e=0;e<t.length;e++)t[e]=255;for(let s=0;s<e.length;s++){const i=e.charAt(s),n=i.charCodeAt(0);if(255!==t[n])throw new TypeError(i+" is ambiguous");t[n]=s}const s=e.length,i=e.charAt(0),n=Math.log(s)/Math.log(256),r=Math.log(256)/Math.log(s);function o(e){if("string"!=typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;let r=0,o=0,a=0;for(;e[r]===i;)o++,r++;const d=(e.length-r)*n+1>>>0,c=new Uint8Array(d);for(;e[r];){let i=t[e.charCodeAt(r)];if(255===i)return;let n=0;for(let e=d-1;(0!==i||n<a)&&-1!==e;e--,n++)i+=s*c[e]>>>0,c[e]=i%256>>>0,i=i/256>>>0;if(0!==i)throw new Error("Non-zero carry");a=n,r++}let l=d-a;for(;l!==d&&0===c[l];)l++;const u=new Uint8Array(o+(d-l));let h=o;for(;l!==d;)u[h++]=c[l++];return u}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";let n=0,o=0,a=0;const d=t.length;for(;a!==d&&0===t[a];)a++,n++;const c=(d-a)*r+1>>>0,l=new Uint8Array(c);for(;a!==d;){let e=t[a],i=0;for(let t=c-1;(0!==e||i<o)&&-1!==t;t--,i++)e+=256*l[t]>>>0,l[t]=e%s>>>0,e=e/s>>>0;if(0!==e)throw new Error("Non-zero carry");o=i,a++}let u=c-o;for(;u!==c&&0===l[u];)u++;let h=i.repeat(n);for(;u<c;++u)h+=e.charAt(l[u]);return h},decodeUnsafe:o,decode:function(e){const t=o(e);if(t)return t;throw new Error("Non-base"+s+" character")}}};const n=i("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz");var r=s("./node_modules/buffer/index.js").hp;const o=[139,1],a=32;function d(e){var t;const s=r.alloc(o.length+e.length+1);s.set(o,0),s.set(e,o.length);let i=0;for(let e=0;e<s.length-1;++e)i^=s[e];s[s.length-1]=i;return null===(t=n.encode(s).match(/.{1,4}/g))||void 0===t?void 0:t.join(" ")}function c(e){const t=n.decode(e.replace(/ /g,""));let s=0;for(const e of t)s^=e;if(0!==s)throw new Error("Incorrect parity");for(let e=0;e<o.length;++e)if(t[e]!==o[e])throw new Error("Incorrect prefix");if(t.length!==o.length+a+1)throw new Error("Incorrect length");return Uint8Array.from(t.slice(o.length,o.length+a))}},"./node_modules/matrix-js-sdk/src/crypto-api/verification.ts":(e,t,s)=>{"use strict";s.d(t,{Dy:()=>o,FM:()=>i,Ji:()=>r,X9:()=>n});let i=function(e){return e.Change="change",e}({}),n=function(e){return e[e.Unsent=1]="Unsent",e[e.Requested=2]="Requested",e[e.Ready=3]="Ready",e[e.Started=4]="Started",e[e.Cancelled=5]="Cancelled",e[e.Done=6]="Done",e}({}),r=function(e){return e.Cancel="cancel",e.ShowSas="show_sas",e.ShowReciprocateQr="show_reciprocate_qr",e}({});function o(e){return e.phase<n.Ready&&!e.accepting&&!e.declining}},"./node_modules/matrix-js-sdk/src/crypto/OlmDevice.ts":(e,t,s)=>{"use strict";s.d(t,{FL:()=>l,nC:()=>u});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/logger.ts"),r=s("./node_modules/matrix-js-sdk/src/crypto/store/indexeddb-crypto-store.ts"),o=s("./node_modules/matrix-js-sdk/src/crypto-api/index.ts"),a=s("./node_modules/matrix-js-sdk/src/common-crypto/CryptoBackend.ts");class d extends Error{constructor(...e){super(...e),(0,i.A)(this,"data",{errcode:"M_TOO_LARGE",error:"Payload too large for encrypted message"})}}function c(e){if(void 0===e)throw new Error("payloadString undefined");if(e.length>49152)throw new d(`Message too long (${e.length} bytes). The maximum for an encrypted message is 49152 bytes.`)}class l{constructor(e){(0,i.A)(this,"pickleKey","DEFAULT_KEY"),(0,i.A)(this,"deviceCurve25519Key",null),(0,i.A)(this,"deviceEd25519Key",null),(0,i.A)(this,"maxOneTimeKeys",null),(0,i.A)(this,"outboundGroupSessionStore",{}),(0,i.A)(this,"inboundGroupSessionMessageIndexes",{}),(0,i.A)(this,"sessionsInProgress",{}),(0,i.A)(this,"olmPrekeyPromise",Promise.resolve()),this.cryptoStore=e}static getOlmVersion(){return s.g.Olm.get_library_version()}async init({pickleKey:e,fromExportedDevice:t}={}){let i;const r=new s.g.Olm.Account;try{t?(e&&n.v.warn("ignoring opts.pickleKey because opts.fromExportedDevice is present."),this.pickleKey=t.pickleKey,await this.initialiseFromExportedDevice(t,r)):(e&&(this.pickleKey=e),await this.initialiseAccount(r)),i=JSON.parse(r.identity_keys()),this.maxOneTimeKeys=r.max_number_of_one_time_keys()}finally{r.free()}this.deviceCurve25519Key=i.curve25519,this.deviceEd25519Key=i.ed25519}async initialiseFromExportedDevice(e,t){await this.cryptoStore.doTxn("readwrite",[r.y.STORE_ACCOUNT,r.y.STORE_SESSIONS],(t=>{this.cryptoStore.storeAccount(t,e.pickledAccount),e.sessions.forEach((e=>{const{deviceKey:s,sessionId:i}=e,n={session:e.session,lastReceivedMessageTs:e.lastReceivedMessageTs};this.cryptoStore.storeEndToEndSession(s,i,n,t)}))})),t.unpickle(this.pickleKey,e.pickledAccount)}async initialiseAccount(e){await this.cryptoStore.doTxn("readwrite",[r.y.STORE_ACCOUNT],(t=>{this.cryptoStore.getAccount(t,(s=>{null!==s?e.unpickle(this.pickleKey,s):(e.create(),s=e.pickle(this.pickleKey),this.cryptoStore.storeAccount(t,s))}))}))}getAccount(e,t){this.cryptoStore.getAccount(e,(e=>{const i=new s.g.Olm.Account;try{i.unpickle(this.pickleKey,e),t(i)}finally{i.free()}}))}storeAccount(e,t){this.cryptoStore.storeAccount(e,t.pickle(this.pickleKey))}async export(){const e={pickleKey:this.pickleKey};return await this.cryptoStore.doTxn("readonly",[r.y.STORE_ACCOUNT,r.y.STORE_SESSIONS],(t=>{this.cryptoStore.getAccount(t,(t=>{e.pickledAccount=t})),e.sessions=[],this.cryptoStore.getAllEndToEndSessions(t,(t=>{e.sessions.push(t)}))})),e}getSession(e,t,s,i){this.cryptoStore.getEndToEndSession(e,t,s,(e=>{this.unpickleSession(e,i)}))}unpickleSession(e,t){const i=new s.g.Olm.Session;try{i.unpickle(this.pickleKey,e.session);t(Object.assign({},e,{session:i}))}finally{i.free()}}saveSession(e,t,s){const i=t.session.session_id();n.v.debug(`Saving Olm session ${i} with device ${e}: ${t.session.describe()}`);const r=Object.assign(t,{session:t.session.pickle(this.pickleKey)});this.cryptoStore.storeEndToEndSession(e,i,r,s)}getUtility(e){const t=new s.g.Olm.Utility;try{return e(t)}finally{t.free()}}async sign(e){let t;return await this.cryptoStore.doTxn("readonly",[r.y.STORE_ACCOUNT],(s=>{this.getAccount(s,(s=>{t=s.sign(e)}))})),t}async getOneTimeKeys(){let e;return await this.cryptoStore.doTxn("readonly",[r.y.STORE_ACCOUNT],(t=>{this.getAccount(t,(t=>{e=JSON.parse(t.one_time_keys())}))})),e}maxNumberOfOneTimeKeys(){var e;return null!==(e=this.maxOneTimeKeys)&&void 0!==e?e:-1}async markKeysAsPublished(){await this.cryptoStore.doTxn("readwrite",[r.y.STORE_ACCOUNT],(e=>{this.getAccount(e,(t=>{t.mark_keys_as_published(),this.storeAccount(e,t)}))}))}generateOneTimeKeys(e){return this.cryptoStore.doTxn("readwrite",[r.y.STORE_ACCOUNT],(t=>{this.getAccount(t,(s=>{s.generate_one_time_keys(e),this.storeAccount(t,s)}))}))}async generateFallbackKey(){await this.cryptoStore.doTxn("readwrite",[r.y.STORE_ACCOUNT],(e=>{this.getAccount(e,(t=>{t.generate_fallback_key(),this.storeAccount(e,t)}))}))}async getFallbackKey(){let e;return await this.cryptoStore.doTxn("readonly",[r.y.STORE_ACCOUNT],(t=>{this.getAccount(t,(t=>{e=JSON.parse(t.unpublished_fallback_key())}))})),e}async forgetOldFallbackKey(){await this.cryptoStore.doTxn("readwrite",[r.y.STORE_ACCOUNT],(e=>{this.getAccount(e,(t=>{t.forget_old_fallback_key(),this.storeAccount(e,t)}))}))}async createOutboundSession(e,t){let i;return await this.cryptoStore.doTxn("readwrite",[r.y.STORE_ACCOUNT,r.y.STORE_SESSIONS],(n=>{this.getAccount(n,(r=>{const o=new s.g.Olm.Session;try{o.create_outbound(r,e,t),i=o.session_id(),this.storeAccount(n,r);const s={session:o,lastReceivedMessageTs:Date.now()};this.saveSession(e,s,n)}finally{o.free()}}))}),n.v.getChild("[createOutboundSession]")),i}async createInboundSession(e,t,i){if(0!==t)throw new Error("Need messageType == 0 to create inbound session");let o;return await this.cryptoStore.doTxn("readwrite",[r.y.STORE_ACCOUNT,r.y.STORE_SESSIONS],(n=>{this.getAccount(n,(r=>{const a=new s.g.Olm.Session;try{a.create_inbound_from(r,e,i),r.remove_one_time_keys(a),this.storeAccount(n,r);const s=a.decrypt(t,i),d={session:a,lastReceivedMessageTs:Date.now()};this.saveSession(e,d,n),o={payload:s,session_id:a.session_id()}}finally{a.free()}}))}),n.v.getChild("[createInboundSession]")),o}async getSessionIdsForDevice(e){const t=n.v.getChild("[getSessionIdsForDevice]");if(e in this.sessionsInProgress){t.debug(`Waiting for Olm session for ${e} to be created`);try{await this.sessionsInProgress[e]}catch(e){}}let s;return await this.cryptoStore.doTxn("readonly",[r.y.STORE_SESSIONS],(t=>{this.cryptoStore.getEndToEndSessions(e,t,(e=>{s=Object.keys(e)}))}),t),s}async getSessionIdForDevice(e,t=!1,s){const i=await this.getSessionInfoForDevice(e,t,s);if(0===i.length)return null;let n=0;for(let e=1;e<i.length;e++){const t=i[e],s=void 0===t.lastReceivedMessageTs?0:t.lastReceivedMessageTs,r=i[n],o=void 0===r.lastReceivedMessageTs?0:r.lastReceivedMessageTs;(s>o||s===o&&t.sessionId<r.sessionId)&&(n=e)}return i[n].sessionId}async getSessionInfoForDevice(e,t=!1,s=n.v){if(s=s.getChild("[getSessionInfoForDevice]"),e in this.sessionsInProgress&&!t){s.debug(`Waiting for Olm session for ${e} to be created`);try{await this.sessionsInProgress[e]}catch(e){}}const i=[];return await this.cryptoStore.doTxn("readonly",[r.y.STORE_SESSIONS],(t=>{this.cryptoStore.getEndToEndSessions(e,t,(e=>{const t=Object.keys(e).sort();for(const s of t)this.unpickleSession(e[s],(e=>{i.push({lastReceivedMessageTs:e.lastReceivedMessageTs,hasReceivedMessage:e.session.has_received_message(),sessionId:s})}))}))}),s),i}async encryptMessage(e,t,s){let i;return c(s),await this.cryptoStore.doTxn("readwrite",[r.y.STORE_SESSIONS],(r=>{this.getSession(e,t,r,(o=>{const a=o.session.describe();n.v.log("encryptMessage: Olm Session ID "+t+" to "+e+": "+a),i=o.session.encrypt(s),this.saveSession(e,o,r)}))}),n.v.getChild("[encryptMessage]")),i}async decryptMessage(e,t,s,i){let o;return await this.cryptoStore.doTxn("readwrite",[r.y.STORE_SESSIONS],(r=>{this.getSession(e,t,r,(a=>{const d=a.session.describe();n.v.log("decryptMessage: Olm Session ID "+t+" from "+e+": "+d),o=a.session.decrypt(s,i),a.lastReceivedMessageTs=Date.now(),this.saveSession(e,a,r)}))}),n.v.getChild("[decryptMessage]")),o}async matchesSession(e,t,s,i){if(0!==s)return!1;let o;return await this.cryptoStore.doTxn("readonly",[r.y.STORE_SESSIONS],(s=>{this.getSession(e,t,s,(e=>{o=e.session.matches_inbound(i)}))}),n.v.getChild("[matchesSession]")),o}async recordSessionProblem(e,t,s){n.v.info(`Recording problem on olm session with ${e} of type ${t}. Recreating: ${s}`),await this.cryptoStore.storeEndToEndSessionProblem(e,t,s)}sessionMayHaveProblems(e,t){return this.cryptoStore.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this.cryptoStore.filterOutNotifiedErrorDevices(e)}saveOutboundGroupSession(e){this.outboundGroupSessionStore[e.session_id()]=e.pickle(this.pickleKey)}getOutboundGroupSession(e,t){const i=this.outboundGroupSessionStore[e];if(void 0===i)throw new Error("Unknown outbound group session "+e);const n=new s.g.Olm.OutboundGroupSession;try{return n.unpickle(this.pickleKey,i),t(n)}finally{n.free()}}createOutboundGroupSession(){const e=new s.g.Olm.OutboundGroupSession;try{return e.create(),this.saveOutboundGroupSession(e),e.session_id()}finally{e.free()}}encryptGroupMessage(e,t){return n.v.log(`encrypting msg with megolm session ${e}`),c(t),this.getOutboundGroupSession(e,(e=>{const s=e.encrypt(t);return this.saveOutboundGroupSession(e),s}))}getOutboundGroupSessionKey(e){return this.getOutboundGroupSession(e,(function(e){return{chain_index:e.message_index(),key:e.session_key()}}))}unpickleInboundGroupSession(e,t){const i=new s.g.Olm.InboundGroupSession;try{return i.unpickle(this.pickleKey,e.session),t(i)}finally{i.free()}}getInboundGroupSession(e,t,s,i,n){this.cryptoStore.getEndToEndInboundGroupSession(t,s,i,((t,s)=>{if(null!==t){if(null!==e&&e!==t.room_id)throw new Error("Mismatched room_id for inbound group session (expected "+t.room_id+", was "+e+")");this.unpickleInboundGroupSession(t,(e=>{n(e,t,s)}))}else n(null,null,s)}))}async addInboundGroupSession(e,t,i,o,a,d,c,l={}){await this.cryptoStore.doTxn("readwrite",[r.y.STORE_INBOUND_GROUP_SESSIONS,r.y.STORE_INBOUND_GROUP_SESSIONS_WITHHELD,r.y.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],(r=>{this.getInboundGroupSession(e,t,o,r,((u,h)=>{const m=new s.g.Olm.InboundGroupSession;try{if(c?m.import_session(a):m.create(a),o!=m.session_id())throw new Error("Mismatched group session ID from senderKey: "+t);if(u&&(n.v.log(`Update for megolm session ${t}|${o}`),u.first_known_index()<=m.first_known_index())){if(!h.untrusted||l.untrusted)return void n.v.log(`Keeping existing megolm session ${t}|${o}`);if(u.first_known_index()<m.first_known_index())return void(u.export_session(m.first_known_index())===m.export_session(m.first_known_index())?(n.v.info(`Upgrading trust of existing megolm session ${t}|${o} based on newly-received trusted session`),h.untrusted=!1,this.cryptoStore.storeEndToEndInboundGroupSession(t,o,h,r)):n.v.warn(`Newly-received megolm session ${t}|$sessionId} does not match existing session! Keeping existing session`))}n.v.debug(`Storing megolm session ${t}|${o} with first index `+m.first_known_index());const s=Object.assign({},l,{room_id:e,session:m.pickle(this.pickleKey),keysClaimed:d,forwardingCurve25519KeyChain:i});this.cryptoStore.storeEndToEndInboundGroupSession(t,o,s,r),!u&&l.sharedHistory&&this.cryptoStore.addSharedHistoryInboundGroupSession(e,t,o,r)}finally{m.free()}}))}),n.v.getChild("[addInboundGroupSession]"))}async addInboundGroupSessionWithheld(e,t,s,i,n){await this.cryptoStore.doTxn("readwrite",[r.y.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(r=>{this.cryptoStore.storeEndToEndInboundGroupSessionWithheld(t,s,{room_id:e,code:i,reason:n},r)}))}async decryptGroupMessage(e,t,s,i,d,c){let l,u=null;if(await this.cryptoStore.doTxn("readwrite",[r.y.STORE_INBOUND_GROUP_SESSIONS,r.y.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(n=>{this.getInboundGroupSession(e,t,s,n,((e,r,m)=>{if(null===e||null===r){if(m){const e="m.unverified"===m.code?o.DecryptionFailureCode.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE:o.DecryptionFailureCode.MEGOLM_KEY_WITHHELD;l=new a.O(e,h(m),{session:t+"|"+s})}return void(u=null)}let p;try{p=e.decrypt(i)}catch(e){if("OLM.UNKNOWN_MESSAGE_INDEX"===(null==e?void 0:e.message)&&m){const e="m.unverified"===m.code?o.DecryptionFailureCode.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE:o.DecryptionFailureCode.MEGOLM_KEY_WITHHELD;l=new a.O(e,h(m),{session:t+"|"+s})}else l=e;return}let g=p.plaintext;if(void 0===g)g=p;else{const e=t+"|"+s+"|"+p.message_index;if(e in this.inboundGroupSessionMessageIndexes){const t=this.inboundGroupSessionMessageIndexes[e];if(t.id!==d||t.timestamp!==c)return void(l=new Error("Duplicate message index, possible replay attack: "+e))}this.inboundGroupSessionMessageIndexes[e]={id:d,timestamp:c}}r.session=e.pickle(this.pickleKey),this.cryptoStore.storeEndToEndInboundGroupSession(t,s,r,n),u={result:g,keysClaimed:r.keysClaimed||{},senderKey:t,forwardingCurve25519KeyChain:r.forwardingCurve25519KeyChain||[],untrusted:!!r.untrusted}}))}),n.v.getChild("[decryptGroupMessage]")),l)throw l;return u}async hasInboundSessionKeys(e,t,s){let i;return await this.cryptoStore.doTxn("readonly",[r.y.STORE_INBOUND_GROUP_SESSIONS,r.y.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(r=>{this.cryptoStore.getEndToEndInboundGroupSession(t,s,r,(r=>{null!==r?e!==r.room_id?(n.v.warn(`requested keys for inbound group session ${t}|${s}, with incorrect room_id (expected ${r.room_id}, was ${e})`),i=!1):i=!0:i=!1}))}),n.v.getChild("[hasInboundSessionKeys]")),i}async getInboundGroupSessionKey(e,t,s,i){let o=null;return await this.cryptoStore.doTxn("readonly",[r.y.STORE_INBOUND_GROUP_SESSIONS,r.y.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(n=>{this.getInboundGroupSession(e,t,s,n,((e,t)=>{if(null===e||null===t)return void(o=null);void 0===i&&(i=e.first_known_index());const s=e.export_session(i),n=(t.keysClaimed||{}).ed25519||null,r=t.forwardingCurve25519KeyChain||[],a="untrusted"in t?t.untrusted:r.length>0;o={chain_index:i,key:s,forwarding_curve25519_key_chain:r,sender_claimed_ed25519_key:n,shared_history:t.sharedHistory||!1,untrusted:a}}))}),n.v.getChild("[getInboundGroupSessionKey]")),o}exportInboundGroupSession(e,t,s){return this.unpickleInboundGroupSession(s,(i=>{const n=i.first_known_index();return{sender_key:e,sender_claimed_keys:s.keysClaimed,room_id:s.room_id,session_id:t,session_key:i.export_session(n),forwarding_curve25519_key_chain:s.forwardingCurve25519KeyChain||[],first_known_index:i.first_known_index(),"org.matrix.msc3061.shared_history":s.sharedHistory||!1}}))}async getSharedHistoryInboundGroupSessions(e){let t;return await this.cryptoStore.doTxn("readonly",[r.y.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],(s=>{t=this.cryptoStore.getSharedHistoryInboundGroupSessions(e,s)}),n.v.getChild("[getSharedHistoryInboundGroupSessionsForRoom]")),t}verifySignature(e,t,s){this.getUtility((function(i){i.ed25519_verify(e,t,s)}))}}const u={"m.unverified":"The sender has disabled encrypting to unverified devices.","m.blacklisted":"The sender has blocked you.","m.unauthorised":"You are not authorised to read the message.","m.no_olm":"Unable to establish a secure channel."};function h(e){return e.code&&e.code in u?u[e.code]:e.reason?e.reason:"decryption key withheld"}},"./node_modules/matrix-js-sdk/src/crypto/OutgoingRoomKeyRequestManager.ts":(e,t,s)=>{"use strict";s.d(t,{j:()=>l,z:()=>u});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/uuid/dist/esm-browser/v4.js"),r=s("./node_modules/matrix-js-sdk/src/logger.ts"),o=s("./node_modules/matrix-js-sdk/src/@types/event.ts"),a=s("./node_modules/matrix-js-sdk/src/utils.ts");function d(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function c(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?d(Object(s),!0).forEach((function(t){(0,i.A)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):d(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let l=function(e){return e[e.Unsent=0]="Unsent",e[e.Sent=1]="Sent",e[e.CancellationPending=2]="CancellationPending",e[e.CancellationPendingAndWillResend=3]="CancellationPendingAndWillResend",e}({});class u{constructor(e,t,s){(0,i.A)(this,"sendOutgoingRoomKeyRequestsTimer",void 0),(0,i.A)(this,"sendOutgoingRoomKeyRequestsRunning",!1),(0,i.A)(this,"clientRunning",!0),this.baseApis=e,this.deviceId=t,this.cryptoStore=s}stop(){r.v.log("stopping OutgoingRoomKeyRequestManager"),this.clientRunning=!1}sendQueuedRequests(){this.startTimer()}async queueRoomKeyRequest(e,t,s=!1){const i=await this.cryptoStore.getOutgoingRoomKeyRequest(e);if(i)switch(i.state){case l.CancellationPendingAndWillResend:case l.Unsent:return;case l.CancellationPending:{const e=s?l.CancellationPendingAndWillResend:l.Sent;await this.cryptoStore.updateOutgoingRoomKeyRequest(i.requestId,l.CancellationPending,{state:e,cancellationTxnId:this.baseApis.makeTxnId()});break}case l.Sent:if(s){const n=l.CancellationPendingAndWillResend,o=await this.cryptoStore.updateOutgoingRoomKeyRequest(i.requestId,l.Sent,{state:n,cancellationTxnId:this.baseApis.makeTxnId(),requestTxnId:this.baseApis.makeTxnId()});if(!o)return this.queueRoomKeyRequest(e,t,s);try{await this.sendOutgoingRoomKeyRequestCancellation(o,!0)}catch(e){r.v.error("Error sending room key request cancellation; will retry later.",e)}}break;default:throw new Error("unhandled state: "+i.state)}else await this.cryptoStore.getOrAddOutgoingRoomKeyRequest({requestBody:e,recipients:t,requestId:this.baseApis.makeTxnId(),state:l.Unsent})}cancelRoomKeyRequest(e){return this.cryptoStore.getOutgoingRoomKeyRequest(e).then((t=>{if(t)switch(t.state){case l.CancellationPending:case l.CancellationPendingAndWillResend:return;case l.Unsent:return r.v.log("deleting unnecessary room key request for "+h(e)),this.cryptoStore.deleteOutgoingRoomKeyRequest(t.requestId,l.Unsent);case l.Sent:return this.cryptoStore.updateOutgoingRoomKeyRequest(t.requestId,l.Sent,{state:l.CancellationPending,cancellationTxnId:this.baseApis.makeTxnId()}).then((t=>{t?this.sendOutgoingRoomKeyRequestCancellation(t).catch((e=>{r.v.error("Error sending room key request cancellation; will retry later.",e),this.startTimer()})):r.v.log("Tried to cancel room key request for "+h(e)+" but it was already cancelled in another tab")}));default:throw new Error("unhandled state: "+t.state)}}))}getOutgoingSentRoomKeyRequest(e,t){return this.cryptoStore.getOutgoingRoomKeyRequestsByTarget(e,t,[l.Sent])}async cancelAndResendAllOutgoingRequests(){const e=await this.cryptoStore.getAllOutgoingRoomKeyRequestsByState(l.Sent);return Promise.all(e.map((({requestBody:e,recipients:t})=>this.queueRoomKeyRequest(e,t,!0))))}startTimer(){if(this.sendOutgoingRoomKeyRequestsTimer)return;this.sendOutgoingRoomKeyRequestsTimer=setTimeout((()=>{if(this.sendOutgoingRoomKeyRequestsRunning)throw new Error("RoomKeyRequestSend already in progress!");this.sendOutgoingRoomKeyRequestsRunning=!0,this.sendOutgoingRoomKeyRequests().finally((()=>{this.sendOutgoingRoomKeyRequestsRunning=!1})).catch((e=>{r.v.warn(`error in OutgoingRoomKeyRequestManager: ${e}`)}))}),500)}async sendOutgoingRoomKeyRequests(){if(!this.clientRunning)return void(this.sendOutgoingRoomKeyRequestsTimer=void 0);const e=await this.cryptoStore.getOutgoingRoomKeyRequestByState([l.CancellationPending,l.CancellationPendingAndWillResend,l.Unsent]);if(e)try{switch(e.state){case l.Unsent:await this.sendOutgoingRoomKeyRequest(e);break;case l.CancellationPending:await this.sendOutgoingRoomKeyRequestCancellation(e);break;case l.CancellationPendingAndWillResend:await this.sendOutgoingRoomKeyRequestCancellation(e,!0)}return this.sendOutgoingRoomKeyRequests()}catch(e){r.v.error("Error sending room key request; will retry later.",e),this.sendOutgoingRoomKeyRequestsTimer=void 0}else this.sendOutgoingRoomKeyRequestsTimer=void 0}sendOutgoingRoomKeyRequest(e){r.v.log(`Requesting keys for ${h(e.requestBody)} from ${m(e.recipients)}(id ${e.requestId})`);const t={action:"request",requesting_device_id:this.deviceId,request_id:e.requestId,body:e.requestBody};return this.sendMessageToDevices(t,e.recipients,e.requestTxnId||e.requestId).then((()=>this.cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,l.Unsent,{state:l.Sent})))}sendOutgoingRoomKeyRequestCancellation(e,t=!1){r.v.log(`Sending cancellation for key request for ${h(e.requestBody)} to ${m(e.recipients)} (cancellation id ${e.cancellationTxnId})`);const s={action:"request_cancellation",requesting_device_id:this.deviceId,request_id:e.requestId};return this.sendMessageToDevices(s,e.recipients,e.cancellationTxnId).then((()=>t?this.cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,l.CancellationPendingAndWillResend,{state:l.Unsent}):this.cryptoStore.deleteOutgoingRoomKeyRequest(e.requestId,l.CancellationPending)))}sendMessageToDevices(e,t,s){const i=new a.kG((()=>new Map));for(const s of t){i.getOrCreate(s.userId).set(s.deviceId,c(c({},e),{},{[o.wt]:(0,n.A)()}))}return this.baseApis.sendToDevice(o.Bx.RoomKeyRequest,i,s)}}function h(e){return e.room_id+" / "+e.session_id}function m(e){return`[${e.map((e=>`${e.userId}:${e.deviceId}`)).join(",")}]`}},"./node_modules/matrix-js-sdk/src/crypto/algorithms/base.ts":(e,t,s)=>{"use strict";s.d(t,{Jn:()=>r,Tb:()=>a,V5:()=>d,l1:()=>n,li:()=>o,x:()=>c});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js");s("./node_modules/matrix-js-sdk/src/common-crypto/CryptoBackend.ts");const n=new Map,r=new Map;class o{constructor(e){(0,i.A)(this,"userId",void 0),(0,i.A)(this,"deviceId",void 0),(0,i.A)(this,"crypto",void 0),(0,i.A)(this,"olmDevice",void 0),(0,i.A)(this,"baseApis",void 0),this.userId=e.userId,this.deviceId=e.deviceId,this.crypto=e.crypto,this.olmDevice=e.olmDevice,this.baseApis=e.baseApis}prepareToEncrypt(e){}onRoomMembership(e,t,s){}}class a{constructor(e){(0,i.A)(this,"userId",void 0),(0,i.A)(this,"crypto",void 0),(0,i.A)(this,"olmDevice",void 0),(0,i.A)(this,"baseApis",void 0),this.userId=e.userId,this.crypto=e.crypto,this.olmDevice=e.olmDevice,this.baseApis=e.baseApis}async onRoomKeyEvent(e){}async importRoomKey(e,t){}hasKeysForKeyRequest(e){return Promise.resolve(!1)}shareKeysWithDevice(e){throw new Error("shareKeysWithDevice not supported for this DecryptionAlgorithm")}async retryDecryptionFromSender(e){return!1}}class d extends Error{constructor(e,t,s){super(e),this.devices=t,this.event=s,this.name="UnknownDeviceError",this.devices=t}}function c(e,t,s){n.set(e,t),r.set(e,s)}},"./node_modules/matrix-js-sdk/src/crypto/algorithms/megolm.ts":(e,t,s)=>{"use strict";s.d(t,{hk:()=>f});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/uuid/dist/esm-browser/v4.js"),r=s("./node_modules/matrix-js-sdk/src/logger.ts"),o=s("./node_modules/matrix-js-sdk/src/crypto/olmlib.ts"),a=s("./node_modules/matrix-js-sdk/src/crypto/algorithms/base.ts"),d=s("./node_modules/matrix-js-sdk/src/crypto/OlmDevice.ts"),c=s("./node_modules/matrix-js-sdk/src/@types/event.ts"),l=s("./node_modules/matrix-js-sdk/src/crypto/OutgoingRoomKeyRequestManager.ts"),u=s("./node_modules/matrix-js-sdk/src/utils.ts"),h=s("./node_modules/matrix-js-sdk/src/@types/membership.ts"),m=s("./node_modules/matrix-js-sdk/src/crypto-api/index.ts"),p=s("./node_modules/matrix-js-sdk/src/common-crypto/CryptoBackend.ts");function g(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function v(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?g(Object(s),!0).forEach((function(t){(0,i.A)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):g(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}function f(e){var t,s;const i=null==e||null===(t=e.currentState)||void 0===t?void 0:t.getStateEvents("m.room.history_visibility",""),n=null==i||null===(s=i.getContent())||void 0===s?void 0:s.history_visibility;return["world_readable","shared"].includes(n)}const y=e=>"string"==typeof e.ciphertext?!!e.ciphertext.length:!!Object.keys(e.ciphertext).length;class S{constructor(e,t=!1){(0,i.A)(this,"useCount",0),(0,i.A)(this,"creationTime",void 0),(0,i.A)(this,"sharedWithDevices",new u.kG((()=>new Map))),(0,i.A)(this,"blockedDevicesNotified",new u.kG((()=>new Map))),this.sessionId=e,this.sharedHistory=t,this.creationTime=(new Date).getTime()}needsRotation(e,t){const s=(new Date).getTime()-this.creationTime;return(this.useCount>=e||s>=t)&&(r.v.log("Rotating megolm session after "+this.useCount+" messages, "+s+"ms"),!0)}markSharedWithDevice(e,t,s,i){this.sharedWithDevices.getOrCreate(e).set(t,{deviceKey:s,messageIndex:i})}markNotifiedBlockedDevice(e,t){this.blockedDevicesNotified.getOrCreate(e).set(t,!0)}sharedWithTooManyDevices(e){for(const[s,i]of this.sharedWithDevices){if(!e.has(s))return r.v.log("Starting new megolm session because we shared with "+s),!0;for(const[n]of i){var t;if(null===(t=e.get(s))||void 0===t||!t.get(n))return r.v.log("Starting new megolm session because we shared with "+s+":"+n),!0}}return!1}}class b extends a.li{constructor(e){var t,s,n,o;super(e),(0,i.A)(this,"setupPromise",Promise.resolve(null)),(0,i.A)(this,"outboundSessions",{}),(0,i.A)(this,"sessionRotationPeriodMsgs",void 0),(0,i.A)(this,"sessionRotationPeriodMs",void 0),(0,i.A)(this,"encryptionPreparation",void 0),(0,i.A)(this,"roomId",void 0),(0,i.A)(this,"prefixedLogger",void 0),this.roomId=e.roomId,this.prefixedLogger=r.v.getChild(`[${this.roomId} encryption]`),this.sessionRotationPeriodMsgs=null!==(t=null===(s=e.config)||void 0===s?void 0:s.rotation_period_msgs)&&void 0!==t?t:100,this.sessionRotationPeriodMs=null!==(n=null===(o=e.config)||void 0===o?void 0:o.rotation_period_ms)&&void 0!==n?n:6048e5}async ensureOutboundSession(e,t,s,i=!1){const n=this.setupPromise.then((async n=>{const r=f(e),o=await this.prepareSession(t,r,n);return await this.shareSession(t,r,i,s,o),o}));return this.setupPromise=n.catch((e=>(this.prefixedLogger.error("Failed to setup outbound session",e),null))),n}async prepareSession(e,t,s){var i,n;return s&&t!==s.sharedHistory&&(s=null),null!==(i=s)&&void 0!==i&&i.needsRotation(this.sessionRotationPeriodMsgs,this.sessionRotationPeriodMs)&&(this.prefixedLogger.debug("Starting new megolm session because we need to rotate."),s=null),null!==(n=s)&&void 0!==n&&n.sharedWithTooManyDevices(e)&&(s=null),s||(this.prefixedLogger.debug("Starting new megolm session"),s=await this.prepareNewSession(t),this.prefixedLogger.debug(`Started new megolm session ${s.sessionId}`),this.outboundSessions[s.sessionId]=s),s}async shareSession(e,t,s,i,n){const r={};for(const[t,s]of e)for(const[e,i]of s){var a;i.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&(null!==(a=n.sharedWithDevices.get(t))&&void 0!==a&&a.get(e)||(r[t]=r[t]||[],r[t].push(i)))}const d=this.olmDevice.getOutboundGroupSessionKey(n.sessionId),c={type:"m.room_key",content:{algorithm:o.MEGOLM_ALGORITHM,room_id:this.roomId,session_id:n.sessionId,session_key:d.key,chain_index:d.chain_index,"org.matrix.msc3061.shared_history":t}},[l,h]=await o.getExistingOlmSessions(this.olmDevice,this.baseApis,r);await Promise.all([(async()=>{const e=Array.from(h.entries()).map((([e,t])=>Array.from(t.entries()).map((([t,s])=>`${e}/${t}: ${s.sessionId}`)))).flat(1);this.prefixedLogger.debug("Sharing keys with devices with existing Olm sessions:",e),await this.shareKeyWithOlmSessions(n,d,c,h),this.prefixedLogger.debug("Shared keys with existing Olm sessions")})(),(async()=>{const e=Array.from(l.entries()).map((([e,t])=>t.map((t=>`${e}/${t.deviceId}`)))).flat(1);this.prefixedLogger.debug("Sharing keys (start phase 1) with devices without existing Olm sessions:",e);const t=[],i=Date.now(),r=[];await this.shareKeyWithDevices(n,d,c,l,t,s?1e4:2e3,r),this.prefixedLogger.debug("Shared keys (end phase 1) with devices without existing Olm sessions"),!s&&Date.now()-i<1e4?(async()=>{const e=new u.kG((()=>[])),s=new Set;for(const e of r)s.add(e);const i=[];for(const{userId:n,deviceInfo:r}of t){const t=n.slice(n.indexOf(":")+1);s.has(t)?e.getOrCreate(n).push(r):i.push({userId:n,deviceInfo:r})}const o=Array.from(e.entries()).map((([e,t])=>t.map((t=>`${e}/${t.deviceId}`)))).flat(1);o.length>0&&(this.prefixedLogger.debug("Sharing keys (start phase 2) with devices without existing Olm sessions:",o),await this.shareKeyWithDevices(n,d,c,e,i,3e4),this.prefixedLogger.debug("Shared keys (end phase 2) with devices without existing Olm sessions")),await this.notifyFailedOlmDevices(n,d,i)})():await this.notifyFailedOlmDevices(n,d,t)})(),(async()=>{this.prefixedLogger.debug(`There are ${i.size} blocked devices:`,Array.from(i.entries()).map((([e,t])=>Array.from(t.entries()).map((([t,s])=>`${e}/${t}`)))).flat(1));const e=new u.kG((()=>new Map));let t=0;for(const[r,o]of i)for(const[i,a]of o){var s;void 0===(null===(s=n.blockedDevicesNotified.get(r))||void 0===s?void 0:s.get(i))&&(e.getOrCreate(r).set(i,{device:a}),t++)}t&&(this.prefixedLogger.debug(`Notifying ${t} newly blocked devices:`,Array.from(e.entries()).map((([e,t])=>Object.entries(t).map((([t,s])=>`${e}/${t}`)))).flat(1)),await this.notifyBlockedDevices(n,e),this.prefixedLogger.debug(`Notified ${t} newly blocked devices`))})()])}async prepareNewSession(e){const t=this.olmDevice.createOutboundGroupSession(),s=this.olmDevice.getOutboundGroupSessionKey(t);return await this.olmDevice.addInboundGroupSession(this.roomId,this.olmDevice.deviceCurve25519Key,[],t,s.key,{ed25519:this.olmDevice.deviceEd25519Key},!1,{sharedHistory:e}),this.crypto.backupManager.backupGroupSession(this.olmDevice.deviceCurve25519Key,t),new S(t,e)}getDevicesWithoutSessions(e,t,s=[]){for(const[i,n]of t){const t=e.get(i);for(const e of n){const n=e.deviceId,r=null==t?void 0:t.get(n);null!=r&&r.sessionId||(s.push({userId:i,deviceInfo:e}),null==t||t.delete(n))}}return s}splitDevices(e){let t=[];const s=[t];for(const[i,n]of e){for(const e of n.values())t.push({userId:i,deviceInfo:e.device});t.length>20&&(t=[],s.push(t))}return 0===t.length&&s.pop(),s}encryptAndSendKeysToDevices(e,t,s,i){return this.crypto.encryptAndSendToDevices(s,i).then((()=>{for(const i of s)e.markSharedWithDevice(i.userId,i.deviceInfo.deviceId,i.deviceInfo.getIdentityKey(),t)})).catch((e=>{throw this.prefixedLogger.error("failed to encryptAndSendToDevices",e),e}))}async sendBlockedNotificationsToDevices(e,t,s){const i=new u.kG((()=>new Map));for(const e of t){const t=e.userId,r=e.deviceInfo,o=r.deviceInfo.deviceId,a=v(v({},s),{},{code:r.code,reason:r.reason,[c.wt]:(0,n.A)()});"m.no_olm"===a.code&&(delete a.room_id,delete a.session_id),i.getOrCreate(t).set(o,a)}await this.baseApis.sendToDevice("m.room_key.withheld",i);for(const[t,s]of i)for(const i of s.keys())e.markNotifiedBlockedDevice(t,i)}async reshareKeyWithDevice(e,t,s,i){var r;const a=this.outboundSessions[t];if(!a)return void this.prefixedLogger.debug(`megolm session ${e}|${t} not found: not re-sharing keys`);if(!a.sharedWithDevices.has(s))return void this.prefixedLogger.debug(`megolm session ${e}|${t} never shared with user ${s}`);const d=null===(r=a.sharedWithDevices.get(s))||void 0===r?void 0:r.get(i.deviceId);if(void 0===d)return void this.prefixedLogger.debug(`megolm session ${e}|${t} never shared with device ${s}:${i.deviceId}`);if(d.deviceKey!==i.getIdentityKey())return void this.prefixedLogger.warn(`Megolm session ${e}|${t} has been shared with device ${i.deviceId} but with identity key ${d.deviceKey}. Key is now ${i.getIdentityKey()}!`);const l=await this.olmDevice.getInboundGroupSessionKey(this.roomId,e,t,d.messageIndex);if(!l)return void this.prefixedLogger.warn(`No inbound session key found for megolm session ${e}|${t}: not re-sharing keys`);await o.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[s,[i]]]));const u={type:"m.forwarded_room_key",content:{algorithm:o.MEGOLM_ALGORITHM,room_id:this.roomId,session_id:t,session_key:l.key,chain_index:l.chain_index,sender_key:e,sender_claimed_ed25519_key:l.sender_claimed_ed25519_key,forwarding_curve25519_key_chain:l.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":l.shared_history||!1}},h={algorithm:o.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[c.wt]:(0,n.A)()};await o.encryptMessageForDevice(h.ciphertext,this.userId,this.deviceId,this.olmDevice,s,i,u),await this.baseApis.sendToDevice("m.room.encrypted",new Map([[s,new Map([[i.deviceId,h]])]])),this.prefixedLogger.debug(`Re-shared key for megolm session ${e}|${t} with ${s}:${i.deviceId}`)}async shareKeyWithDevices(e,t,s,i,n,r,a){const d=await o.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,i,!1,r,a,this.prefixedLogger);this.getDevicesWithoutSessions(d,i,n),await this.shareKeyWithOlmSessions(e,t,s,d)}async shareKeyWithOlmSessions(e,t,s,i){const n=this.splitDevices(i);for(let i=0;i<n.length;i++){const r=`megolm keys for ${e.sessionId} (slice ${i+1}/${n.length})`;try{this.prefixedLogger.debug(`Sharing ${r}`,n[i].map((e=>`${e.userId}/${e.deviceInfo.deviceId}`))),await this.encryptAndSendKeysToDevices(e,t.chain_index,n[i],s),this.prefixedLogger.debug(`Shared ${r}`)}catch(e){throw this.prefixedLogger.error(`Failed to share ${r}`),e}}}async notifyFailedOlmDevices(e,t,s){this.prefixedLogger.debug(`Notifying ${s.length} devices we failed to create Olm sessions`);for(const{userId:i,deviceInfo:n}of s){const s=n.deviceId;e.markSharedWithDevice(i,s,n.getIdentityKey(),t.chain_index)}const i=await this.olmDevice.filterOutNotifiedErrorDevices(s);this.prefixedLogger.debug(`Need to notify ${i.length} failed devices which haven't been notified before`);const n=new u.kG((()=>new Map));for(const{userId:e,deviceInfo:t}of i)n.getOrCreate(e).set(t.deviceId,{device:{code:"m.no_olm",reason:d.nC["m.no_olm"],deviceInfo:t}});await this.notifyBlockedDevices(e,n),this.prefixedLogger.debug(`Notified ${i.length} devices we failed to create Olm sessions`)}async notifyBlockedDevices(e,t){const s={room_id:this.roomId,session_id:e.sessionId,algorithm:o.MEGOLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key},i=this.splitDevices(t);for(let t=0;t<i.length;t++)try{await this.sendBlockedNotificationsToDevices(e,i[t],s),this.prefixedLogger.debug(`Completed blacklist notification for ${e.sessionId} (slice ${t+1}/${i.length})`)}catch(s){throw this.prefixedLogger.debug(`blacklist notification for ${e.sessionId} (slice ${t+1}/${i.length}) failed`),s}}prepareToEncrypt(e){if(e.roomId!==this.roomId)throw new Error("MegolmEncryption.prepareToEncrypt called on unexpected room");if(null!=this.encryptionPreparation){const e=Date.now()-this.encryptionPreparation.startTime;return this.prefixedLogger.debug(`Already started preparing to encrypt for this room ${e}ms ago, skipping`),this.encryptionPreparation.cancel}this.prefixedLogger.debug("Preparing to encrypt events");let t=!1;const s=()=>t;return this.encryptionPreparation={startTime:Date.now(),promise:(async()=>{try{const t=await this.getDevicesInRoom(e,!1,s);if(null===t)return;const[i,n]=t;this.crypto.globalErrorOnUnknownDevices&&this.removeUnknownDevices(i),this.prefixedLogger.debug("Ensuring outbound megolm session"),await this.ensureOutboundSession(e,i,n,!0),this.prefixedLogger.debug("Ready to encrypt events")}catch(e){this.prefixedLogger.error("Failed to prepare to encrypt events",e)}finally{delete this.encryptionPreparation}})(),cancel:()=>{t=!0,delete this.encryptionPreparation}},this.encryptionPreparation.cancel}async encryptMessage(e,t,s){if(this.prefixedLogger.debug("Starting to encrypt event"),null!=this.encryptionPreparation)try{await this.encryptionPreparation.promise}catch(e){}const i=this.isVerificationEvent(t,s),[n,r]=await this.getDevicesInRoom(e,i);this.crypto.globalErrorOnUnknownDevices&&this.checkForUnknownDevices(n);const a=await this.ensureOutboundSession(e,n,r),d={room_id:this.roomId,type:t,content:s},c=this.olmDevice.encryptGroupMessage(a.sessionId,JSON.stringify(d)),l={algorithm:o.MEGOLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:c,session_id:a.sessionId,device_id:this.deviceId};return a.useCount++,l}isVerificationEvent(e,t){switch(e){case c.Bx.KeyVerificationCancel:case c.Bx.KeyVerificationDone:case c.Bx.KeyVerificationMac:case c.Bx.KeyVerificationStart:case c.Bx.KeyVerificationKey:case c.Bx.KeyVerificationReady:case c.Bx.KeyVerificationAccept:return!0;case c.Bx.RoomMessage:return t.msgtype===c.Wr.KeyVerificationRequest;default:return!1}}forceDiscardSession(){this.setupPromise=this.setupPromise.then((()=>null))}checkForUnknownDevices(e){const t=new u.kG((()=>new Map));for(const[s,i]of e)for(const[e,n]of i)n.isUnverified()&&!n.isKnown()&&t.getOrCreate(s).set(e,n);if(t.size)throw new a.V5("This room contains unknown devices which have not been verified. We strongly recommend you verify them before continuing.",t)}removeUnknownDevices(e){for(const[t,s]of e){for(const[e,t]of s)t.isUnverified()&&!t.isKnown()&&s.delete(e);0===s.size&&e.delete(t)}}async getDevicesInRoom(e,t=!1,s){const i=await e.getEncryptionTargetMembers();this.prefixedLogger.debug(`Encrypting for users (shouldEncryptForInvitedMembers: ${e.shouldEncryptForInvitedMembers()}):`,i.map((e=>`${e.userId} (${e.membership})`)));const n=i.map((function(e){return e.userId}));let r=this.crypto.globalBlacklistUnverifiedDevices;const o=e.getBlacklistUnverifiedDevices();"boolean"==typeof o&&(r=o);const a=await this.crypto.downloadKeys(n,!1);if(!0===(null==s?void 0:s()))return null;const c=new u.kG((()=>new Map));for(const[e,i]of a)for(const[n,o]of i){if(void 0!==s&&await(0,u.iH)(),!0===(null==s?void 0:s()))return null;const a=this.crypto.checkDeviceTrust(e,n);if(o.isBlocked()||!a.isVerified()&&r&&!t){const t=c.getOrCreate(e),s=o.isBlocked();t.set(n,{code:s?"m.blacklisted":"m.unverified",reason:d.nC[s?"m.blacklisted":"m.unverified"],deviceInfo:o}),i.delete(n)}}return[a,c]}}class E extends a.Tb{constructor(e){super(e),(0,i.A)(this,"pendingEvents",new Map),(0,i.A)(this,"olmlib",o),(0,i.A)(this,"roomId",void 0),(0,i.A)(this,"prefixedLogger",void 0),this.roomId=e.roomId,this.prefixedLogger=r.v.getChild(`[${this.roomId} decryption]`)}async decryptEvent(e){const t=e.getWireContent();if(!t.sender_key||!t.session_id||!t.ciphertext)throw new p.O(m.DecryptionFailureCode.MEGOLM_MISSING_FIELDS,"Missing fields in input");let s;this.addEventToPendingList(e);try{s=await this.olmDevice.decryptGroupMessage(e.getRoomId(),t.sender_key,t.session_id,t.ciphertext,e.getId(),e.getTs())}catch(s){if("DecryptionError"===s.name)throw s;let i=m.DecryptionFailureCode.OLM_DECRYPT_GROUP_MESSAGE_ERROR;throw"OLM.UNKNOWN_MESSAGE_INDEX"===(null==s?void 0:s.message)&&(this.requestKeysForEvent(e),i=m.DecryptionFailureCode.OLM_UNKNOWN_MESSAGE_INDEX),new p.O(i,s instanceof Error?s.message:"Unknown Error: Error is undefined",{session:t.sender_key+"|"+t.session_id})}if(null===s){this.crypto.backupManager.queryKeyBackupRateLimited(e.getRoomId(),t.session_id).catch((()=>{})),this.requestKeysForEvent(e);const s=await this.olmDevice.sessionMayHaveProblems(t.sender_key,e.getTs()-12e4);if(s){this.prefixedLogger.info(`When handling UISI from ${e.getSender()} (sender key ${t.sender_key}): recent session problem with that sender:`,s);let i=w[s.type]||w.unknown;throw s.fixed&&(i+=" Trying to create a new secure channel and re-requesting the keys."),new p.O(m.DecryptionFailureCode.MEGOLM_UNKNOWN_INBOUND_SESSION_ID,i,{session:t.sender_key+"|"+t.session_id})}throw new p.O(m.DecryptionFailureCode.MEGOLM_UNKNOWN_INBOUND_SESSION_ID,"The sender's device has not sent us the keys for this message.",{session:t.sender_key+"|"+t.session_id})}s.untrusted||this.removeEventFromPendingList(e);const i=JSON.parse(s.result);if(i.room_id!==e.getRoomId())throw new p.O(m.DecryptionFailureCode.MEGOLM_BAD_ROOM,"Message intended for room "+i.room_id);return{clearEvent:i,senderCurve25519Key:s.senderKey,claimedEd25519Key:s.keysClaimed.ed25519,forwardingCurve25519KeyChain:s.forwardingCurve25519KeyChain,untrusted:s.untrusted}}requestKeysForEvent(e){const t=e.getWireContent(),s=e.getKeyRequestRecipients(this.userId);this.crypto.requestRoomKey({room_id:e.getRoomId(),algorithm:t.algorithm,sender_key:t.sender_key,session_id:t.session_id},s)}addEventToPendingList(e){var t;const s=e.getWireContent(),i=s.sender_key,n=s.session_id;this.pendingEvents.has(i)||this.pendingEvents.set(i,new Map);const r=this.pendingEvents.get(i);r.has(n)||r.set(n,new Set),null===(t=r.get(n))||void 0===t||t.add(e)}removeEventFromPendingList(e){const t=e.getWireContent(),s=t.sender_key,i=t.session_id,n=this.pendingEvents.get(s),r=null==n?void 0:n.get(i);r&&(r.delete(e),0===r.size&&n.delete(i),0===n.size&&this.pendingEvents.delete(s))}roomKeyFromEvent(e){const t=e.getSenderKey(),s=e.getContent(),i={};if(!(s.room_id&&s.session_key&&s.session_id&&s.algorithm))return void this.prefixedLogger.error("key event is missing fields");if(!o.isOlmEncrypted(e))return void this.prefixedLogger.error("key event not properly encrypted");s["org.matrix.msc3061.shared_history"]&&(i.sharedHistory=!0);return{senderKey:t,sessionId:s.session_id,sessionKey:s.session_key,extraSessionData:i,exportFormat:!1,roomId:s.room_id,algorithm:s.algorithm,forwardingKeyChain:[],keysClaimed:e.getKeysClaimed()}}forwardedRoomKeyFromEvent(e){const t=this.roomKeyFromEvent(e);if(!t)return;const s=e.getSenderKey(),i=e.getContent(),n=this.baseApis.crypto.deviceList.getUserByIdentityKey(o.OLM_ALGORITHM,s),r=i.sender_key,a=i.sender_claimed_ed25519_key;let d=Array.isArray(i.forwarding_curve25519_key_chain)?i.forwarding_curve25519_key_chain:[];if(d=d.slice(),d.push(s),n!==e.getSender())return void this.prefixedLogger.error("sending device does not belong to the user it claims to be from");if(!r)return void this.prefixedLogger.error("forwarded_room_key event is missing sender_key field");if(!a)return void this.prefixedLogger.error("forwarded_room_key_event is missing sender_claimed_ed25519_key field");const c={ed25519:a};return t.senderKey=r,t.keysClaimed=c,t.exportFormat=!0,t.forwardingKeyChain=d,t.extraSessionData.untrusted=!0,t}async shouldAcceptForwardedKey(e,t){var s;const i=e.getSenderKey(),n=null!==(s=this.crypto.deviceList.getDeviceByIdentityKey(o.OLM_ALGORITHM,i))&&void 0!==s?s:void 0,r=this.crypto.checkDeviceInfoTrust(e.getSender(),n),a=e.getSender()===this.baseApis.getUserId(),d=r.isVerified()&&a,c=await this.wasRoomKeyRequested(e,t),l=this.wasRoomKeyForwardedByInviter(e,t),u=this.wasRoomKeyForwardedAsHistory(t);return c&&d||l&&u}async wasRoomKeyRequested(e,t){return(await this.crypto.cryptoStore.getOutgoingRoomKeyRequestsByTarget(e.getSender(),"*",[l.j.Sent])).some((e=>e.requestBody.room_id===t.roomId&&e.requestBody.session_id===t.sessionId))}wasRoomKeyForwardedByInviter(e,t){var s,i,n;const r=this.baseApis.getRoom(t.roomId),a=e.getSenderKey();if(!a)return!1;const d=this.crypto.deviceList.getUserByIdentityKey(o.OLM_ALGORITHM,a);if(!d)return!1;const c=null==r||null===(s=r.getMember(this.userId))||void 0===s?void 0:s.events.member,l=(null==c?void 0:c.getSender())===d||(null==c||null===(i=c.getUnsigned())||void 0===i?void 0:i.prev_sender)===d&&(null==c||null===(n=c.getPrevContent())||void 0===n?void 0:n.membership)===h.O.Invite;return!(!r||!l)}wasRoomKeyForwardedAsHistory(e){return!(!this.baseApis.getRoom(e.roomId)||!e.extraSessionData.sharedHistory)}shouldParkForwardedKey(e){return!(this.baseApis.getRoom(e.roomId)||!e.extraSessionData.sharedHistory)}async parkForwardedKey(e,t){const s={senderId:e.getSender(),senderKey:t.senderKey,sessionId:t.sessionId,sessionKey:t.sessionKey,keysClaimed:t.keysClaimed,forwardingCurve25519KeyChain:t.forwardingKeyChain};await this.crypto.cryptoStore.doTxn("readwrite",["parked_shared_history"],(e=>this.crypto.cryptoStore.addParkedSharedHistory(t.roomId,s,e)),r.v.getChild("[addParkedSharedHistory]"))}async addRoomKey(e){try{await this.olmDevice.addInboundGroupSession(e.roomId,e.senderKey,e.forwardingKeyChain,e.sessionId,e.sessionKey,e.keysClaimed,e.exportFormat,e.extraSessionData),await this.retryDecryption(e.senderKey,e.sessionId,!e.extraSessionData.untrusted)&&this.crypto.cancelRoomKeyRequest({algorithm:e.algorithm,room_id:e.roomId,session_id:e.sessionId,sender_key:e.senderKey}),await this.crypto.backupManager.backupGroupSession(e.senderKey,e.sessionId)}catch(e){this.prefixedLogger.error(`Error handling m.room_key_event: ${e}`)}}async onForwardedRoomKey(e){const t=this.forwardedRoomKeyFromEvent(e);t&&(await this.shouldAcceptForwardedKey(e,t)?await this.addRoomKey(t):this.shouldParkForwardedKey(t)&&await this.parkForwardedKey(e,t))}async onRoomKeyEvent(e){if("m.forwarded_room_key"==e.getType())await this.onForwardedRoomKey(e);else{const t=this.roomKeyFromEvent(e);if(!t)return;await this.addRoomKey(t)}}async onRoomKeyWithheldEvent(e){const t=e.getContent(),s=t.sender_key;"m.no_olm"===t.code?await this.onNoOlmWithheldEvent(e):"m.unavailable"===t.code||await this.olmDevice.addInboundGroupSessionWithheld(t.room_id,s,t.session_id,t.code,t.reason),t.session_id?await this.retryDecryption(s,t.session_id):await this.retryDecryptionFromSender(s)}async onNoOlmWithheldEvent(e){const t=e.getContent(),s=t.sender_key,i=e.getSender();if(this.prefixedLogger.warn(`${i}:${s} was unable to establish an olm session with us`),await this.olmDevice.getSessionIdForDevice(s))return this.prefixedLogger.debug("New session already created.  Not creating a new one."),void await this.olmDevice.recordSessionProblem(s,"no_olm",!0);let r=this.crypto.deviceList.getDeviceByIdentityKey(t.algorithm,s);if(!r&&(await this.crypto.downloadKeys([i],!1),r=this.crypto.deviceList.getDeviceByIdentityKey(t.algorithm,s),!r))return this.prefixedLogger.info("Couldn't find device for identity key "+s+": not establishing session"),void await this.olmDevice.recordSessionProblem(s,"no_olm",!1);await o.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[i,[r]]]),!1);const a={algorithm:o.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[c.wt]:(0,n.A)()};await o.encryptMessageForDevice(a.ciphertext,this.userId,void 0,this.olmDevice,i,r,{type:"m.dummy"}),await this.olmDevice.recordSessionProblem(s,"no_olm",!0),await this.baseApis.sendToDevice("m.room.encrypted",new Map([[i,new Map([[r.deviceId,a]])]]))}hasKeysForKeyRequest(e){const t=e.requestBody;return this.olmDevice.hasInboundSessionKeys(t.room_id,t.sender_key,t.session_id)}shareKeysWithDevice(e){const t=e.userId,s=e.deviceId,i=this.crypto.getStoredDevice(t,s),r=e.requestBody;this.olmlib.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[t,[i]]])).then((e=>{var i;const n=null===(i=e.get(t))||void 0===i?void 0:i.get(s);return null!=n&&n.sessionId?(this.prefixedLogger.debug("sharing keys for session "+r.sender_key+"|"+r.session_id+" with device "+t+":"+s),this.buildKeyForwardingMessage(r.room_id,r.sender_key,r.session_id)):null})).then((e=>{const r={algorithm:o.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[c.wt]:(0,n.A)()};return this.olmlib.encryptMessageForDevice(r.ciphertext,this.userId,void 0,this.olmDevice,t,i,e).then((()=>this.baseApis.sendToDevice("m.room.encrypted",new Map([[t,new Map([[s,r]])]]))))}))}async buildKeyForwardingMessage(e,t,s){const i=await this.olmDevice.getInboundGroupSessionKey(e,t,s);return{type:"m.forwarded_room_key",content:{algorithm:o.MEGOLM_ALGORITHM,room_id:e,sender_key:t,sender_claimed_ed25519_key:i.sender_claimed_ed25519_key,session_id:s,session_key:i.key,chain_index:i.chain_index,forwarding_curve25519_key_chain:i.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":i.shared_history||!1}}}importRoomKey(e,{untrusted:t,source:s}={}){const i={};return(t||e.untrusted)&&(i.untrusted=!0),e["org.matrix.msc3061.shared_history"]&&(i.sharedHistory=!0),this.olmDevice.addInboundGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0,i).then((()=>{"backup"!==s&&this.crypto.backupManager.backupGroupSession(e.sender_key,e.session_id).catch((e=>{this.prefixedLogger.debug("Failed to back up megolm session",e)})),this.retryDecryption(e.sender_key,e.session_id,!i.untrusted)}))}async retryDecryption(e,t,s){var i;const n=this.pendingEvents.get(e);if(!n)return!0;const r=n.get(t);if(!r)return!0;const o=[...r];return this.prefixedLogger.debug("Retrying decryption on events:",o.map((e=>`${e.getId()}`))),await Promise.all(o.map((async e=>{try{await e.attemptDecryption(this.crypto,{isRetry:!0,forceRedecryptIfUntrusted:s})}catch(e){}}))),!(null!==(i=this.pendingEvents.get(e))&&void 0!==i&&i.has(t))}async retryDecryptionFromSender(e){const t=this.pendingEvents.get(e);return!t||(this.pendingEvents.delete(e),await Promise.all([...t].map((async([e,t])=>{await Promise.all([...t].map((async e=>{try{await e.attemptDecryption(this.crypto)}catch(e){}})))}))),!this.pendingEvents.has(e))}async sendSharedHistoryInboundSessions(e){await o.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,e);const t=await this.olmDevice.getSharedHistoryInboundGroupSessions(this.roomId);this.prefixedLogger.debug(`Sharing history in with users ${Array.from(e.keys())}`,t.map((([e,t])=>`${e}|${t}`)));for(const[s,i]of t){const t=await this.buildKeyForwardingMessage(this.roomId,s,i),r=[],a=new Map;for(const[s,i]of e){const e=new Map;a.set(s,e);for(const a of i){const i={algorithm:o.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[c.wt]:(0,n.A)()};e.set(a.deviceId,i),r.push(o.encryptMessageForDevice(i.ciphertext,this.userId,void 0,this.olmDevice,s,a,t))}}await Promise.all(r);for(const[e,t]of a){for(const[s,i]of t)y(i)||(this.prefixedLogger.debug("No ciphertext for device "+e+":"+s+": pruning"),t.delete(s));0===t.size&&(this.prefixedLogger.debug("Pruned all devices for user "+e),a.delete(e))}if(0===a.size)return void this.prefixedLogger.debug("No users left to send to: aborting");await this.baseApis.sendToDevice("m.room.encrypted",a)}}}const w={no_olm:"The sender was unable to establish a secure channel.",unknown:"The secure channel with the sender was corrupted."};(0,a.x)(o.MEGOLM_ALGORITHM,b,E)},"./node_modules/matrix-js-sdk/src/crypto/api.ts":(e,t,s)=>{"use strict";s.d(t,{n:()=>i.CrossSigningKey});var i=s("./node_modules/matrix-js-sdk/src/crypto-api/index.ts")},"./node_modules/matrix-js-sdk/src/crypto/backup.ts":(e,t,s)=>{"use strict";s.d(t,{IG:()=>I,IO:()=>f,M7:()=>_});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/client.ts"),r=s("./node_modules/matrix-js-sdk/src/logger.ts"),o=s("./node_modules/matrix-js-sdk/src/crypto/olmlib.ts"),a=s("./node_modules/matrix-js-sdk/src/crypto/key_passphrase.ts"),d=s("./node_modules/matrix-js-sdk/src/utils.ts"),c=s("./node_modules/matrix-js-sdk/src/crypto/store/indexeddb-crypto-store.ts"),l=s("./node_modules/matrix-js-sdk/src/NamespacedValue.ts"),u=s("./node_modules/matrix-js-sdk/src/crypto/index.ts"),h=s("./node_modules/matrix-js-sdk/src/http-api/index.ts"),m=s("./node_modules/matrix-js-sdk/src/crypto-api/index.ts"),p=s("./node_modules/matrix-js-sdk/src/utils/decryptAESSecretStorageItem.ts"),g=s("./node_modules/matrix-js-sdk/src/utils/encryptAESSecretStorageItem.ts"),v=s("./node_modules/matrix-js-sdk/src/secret-storage.ts");class f{constructor(e,t){(0,i.A)(this,"algorithm",void 0),(0,i.A)(this,"backupInfo",void 0),(0,i.A)(this,"checkedForBackup",void 0),(0,i.A)(this,"sendingBackups",void 0),(0,i.A)(this,"sessionLastCheckAttemptedTime",{}),(0,i.A)(this,"clientRunning",!0),this.baseApis=e,this.getKey=t,this.checkedForBackup=!1,this.sendingBackups=!1}stop(){this.clientRunning=!1}get version(){return this.backupInfo&&this.backupInfo.version}static checkBackupVersion(e){const t=E[e.algorithm];if(!t)throw new Error("Unknown backup algorithm: "+e.algorithm);if("object"!=typeof e.auth_data)throw new Error("Invalid backup data returned");return t.checkBackupVersion(e)}static makeAlgorithm(e,t){const s=E[e.algorithm];if(!s)throw new Error("Unknown backup algorithm");return s.init(e.auth_data,t)}async enableKeyBackup(e){this.backupInfo=e,this.algorithm&&this.algorithm.free(),this.algorithm=await f.makeAlgorithm(e,this.getKey),this.baseApis.emit(u.cr.KeyBackupStatus,!0),this.scheduleKeyBackupSend()}disableKeyBackup(){this.algorithm&&this.algorithm.free(),this.algorithm=void 0,this.backupInfo=void 0,this.baseApis.emit(u.cr.KeyBackupStatus,!1)}getKeyBackupEnabled(){return this.checkedForBackup?Boolean(this.algorithm):null}async prepareKeyBackupVersion(e,t){const s=t?E[t]:w;if(!s)throw new Error("Unknown backup algorithm");const[i,n]=await s.prepare(e),r=(0,m.encodeRecoveryKey)(i);return{algorithm:s.algorithmName,auth_data:n,recovery_key:r,privateKey:i}}async createKeyBackupVersion(e){this.algorithm=await f.makeAlgorithm(e,this.getKey)}async deleteAllKeyBackupVersions(){var e,t;let s=null!==(e=null===(t=await this.baseApis.getKeyBackupVersion())||void 0===t?void 0:t.version)&&void 0!==e?e:null;for(;null!=s;){var i,n;await this.deleteKeyBackupVersion(s),this.disableKeyBackup(),s=null!==(i=null===(n=await this.baseApis.getKeyBackupVersion())||void 0===n?void 0:n.version)&&void 0!==i?i:null}}async deleteKeyBackupVersion(e){const t=(0,d.RR)("/room_keys/version/$version",{$version:e});await this.baseApis.http.authedRequest(h.IT.Delete,t,void 0,void 0,{prefix:h.iD.V3})}async checkAndStart(){if(r.v.log("Checking key backup status..."),this.baseApis.isGuest())return r.v.log("Skipping key backup check since user is guest"),this.checkedForBackup=!0,null;let e;try{var t;e=null!==(t=await this.baseApis.getKeyBackupVersion())&&void 0!==t?t:void 0}catch(e){return r.v.log("Error checking for active key backup",e),404===e.httpStatus&&(this.checkedForBackup=!0),null}this.checkedForBackup=!0;const s=await this.isKeyBackupTrusted(e);return s.usable&&!this.backupInfo?(r.v.log(`Found usable key backup v${e.version}: enabling key backups`),await this.enableKeyBackup(e)):!s.usable&&this.backupInfo?(r.v.log("No usable key backup: disabling key backup"),this.disableKeyBackup()):s.usable||this.backupInfo?s.usable&&this.backupInfo&&(e.version!==this.backupInfo.version?(r.v.log(`On backup version ${this.backupInfo.version} but found version ${e.version}: switching.`),this.disableKeyBackup(),await this.enableKeyBackup(e),await this.scheduleAllGroupSessionsForBackup()):r.v.log(`Backup version ${e.version} still current`)):r.v.log("No usable key backup: not enabling key backup"),{backupInfo:e,trustInfo:s}}async checkKeyBackup(){return this.checkedForBackup=!1,this.checkAndStart()}async queryKeyBackupRateLimited(e,t){if(!this.backupInfo)return;const s=(new Date).getTime();(!this.sessionLastCheckAttemptedTime[t]||s-this.sessionLastCheckAttemptedTime[t]>5e3)&&(this.sessionLastCheckAttemptedTime[t]=s,await this.baseApis.restoreKeyBackupWithCache(e,t,this.backupInfo,{}))}async isKeyBackupTrusted(e){const t={usable:!1,trusted_locally:!1,sigs:[]};if(!(e&&e.algorithm&&e.auth_data&&e.auth_data.signatures))return r.v.info(`Key backup is absent or missing required data: ${JSON.stringify(e)}`),t;const s=this.baseApis.getUserId(),i=await this.baseApis.crypto.getSessionBackupPrivateKey();if(i){let s=null;try{s=await f.makeAlgorithm(e,(async()=>i)),await s.keyMatches(i)&&(r.v.info("Backup is trusted locally"),t.trusted_locally=!0)}catch{}finally{var n;null===(n=s)||void 0===n||n.free()}}const a=e.auth_data.signatures[s]||{};for(const i of Object.keys(a)){const n=i.split(":");if("ed25519"!==n[0]){r.v.log("Ignoring unknown signature type: "+n[0]);continue}const a={deviceId:n[1]},d=this.baseApis.crypto.crossSigningInfo.getId();if(d===a.deviceId){a.crossSigningId=!0;try{await(0,o.verifySignature)(this.baseApis.crypto.olmDevice,e.auth_data,s,a.deviceId,d),a.valid=!0}catch(e){r.v.warn("Bad signature from cross signing key "+d,e),a.valid=!1}t.sigs.push(a);continue}const c=this.baseApis.crypto.deviceList.getStoredDevice(s,a.deviceId);if(c){a.device=c,a.deviceTrust=this.baseApis.checkDeviceTrust(s,a.deviceId);try{await(0,o.verifySignature)(this.baseApis.crypto.olmDevice,e.auth_data,s,c.deviceId,c.getFingerprint()),a.valid=!0}catch(t){r.v.info("Bad signature from key ID "+i+" userID "+this.baseApis.getUserId()+" device ID "+c.deviceId+" fingerprint: "+c.getFingerprint(),e.auth_data,t),a.valid=!1}}else a.valid=null,r.v.info("Ignoring signature from unknown key "+i);t.sigs.push(a)}return t.usable=t.sigs.some((e=>{var t;return e.valid&&(e.device&&(null===(t=e.deviceTrust)||void 0===t?void 0:t.isVerified())||e.crossSigningId)})),t}async scheduleKeyBackupSend(e=1e4){if(r.v.debug(`Key backup: scheduleKeyBackupSend currentSending:${this.sendingBackups} delay:${e}`),!this.sendingBackups){this.sendingBackups=!0;try{const t=Math.random()*e;if(await(0,d.yy)(t),!this.clientRunning)return void(this.sendingBackups=!1);let s=0;for(;;){if(!this.algorithm)return;try{if(0===await this.backupPendingKeys(200))return void(this.sendingBackups=!1);s=0}catch(e){if(s++,r.v.log("Key backup request failed",e),e instanceof h.up){const t=e.data.errcode;if("M_NOT_FOUND"==t||"M_WRONG_ROOM_KEYS_VERSION"==t)return this.sendingBackups=!1,this.baseApis.crypto.emit(u.cr.KeyBackupFailed,t),void await this.checkKeyBackup()}}if(s&&await(0,d.yy)(1e3*Math.pow(2,Math.min(s-1,4))),!this.clientRunning)return r.v.debug("Key backup send loop aborted, client stopped"),void(this.sendingBackups=!1)}}catch(e){r.v.log(`Backup loop failed ${e}`),this.sendingBackups=!1}}}async backupPendingKeys(e){const t=await this.baseApis.crypto.cryptoStore.getSessionsNeedingBackup(e);if(!t.length)return 0;let s=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();this.baseApis.crypto.emit(u.cr.KeyBackupSessionsRemaining,s);const i={};for(const e of t){var n;const t=e.sessionData.room_id;(0,d.C6)(i,t,i[t]||{sessions:{}});const s=this.baseApis.crypto.olmDevice.exportInboundGroupSession(e.senderKey,e.sessionId,e.sessionData);s.algorithm=o.MEGOLM_ALGORITHM;const r=(s.forwarding_curve25519_key_chain||[]).length,a=this.baseApis.crypto.deviceList.getUserByIdentityKey(o.MEGOLM_ALGORITHM,e.senderKey),c=null!==(n=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(o.MEGOLM_ALGORITHM,e.senderKey))&&void 0!==n?n:void 0,l=this.baseApis.crypto.checkDeviceInfoTrust(a,c).isVerified();(0,d.C6)(i[t].sessions,e.sessionId,{first_message_index:s.first_known_index,forwarded_count:r,is_verified:l,session_data:await this.algorithm.encryptSession(s)})}return await this.baseApis.sendKeyBackup(void 0,void 0,this.backupInfo.version,{rooms:i}),await this.baseApis.crypto.cryptoStore.unmarkSessionsNeedingBackup(t),s=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup(),this.baseApis.crypto.emit(u.cr.KeyBackupSessionsRemaining,s),t.length}async backupGroupSession(e,t){await this.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([{senderKey:e,sessionId:t}]),this.backupInfo&&this.scheduleKeyBackupSend()}async scheduleAllGroupSessionsForBackup(){await this.flagAllGroupSessionsForBackup(),this.scheduleKeyBackupSend(0)}async flagAllGroupSessionsForBackup(){await this.baseApis.crypto.cryptoStore.doTxn("readwrite",[c.y.STORE_INBOUND_GROUP_SESSIONS,c.y.STORE_BACKUP],(e=>{this.baseApis.crypto.cryptoStore.getAllEndToEndInboundGroupSessions(e,(t=>{null!==t&&this.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([t],e)}))}));const e=await this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();return this.baseApis.emit(u.cr.KeyBackupSessionsRemaining,e),e}countSessionsNeedingBackup(){return this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup()}}class y{constructor(e,t,s){this.authData=e,this.publicKey=t,this.getKey=s}static async init(e,t){if(!e||!("public_key"in e))throw new Error("auth_data missing required information");const i=new s.g.Olm.PkEncryption;return i.set_recipient_key(e.public_key),new y(e,i,t)}static async prepare(e){const t=new s.g.Olm.PkDecryption;try{const i={};if(e)if(e instanceof Uint8Array)i.public_key=t.init_with_private_key(e);else{const s=await(0,a.SM)(e);i.private_key_salt=s.salt,i.private_key_iterations=s.iterations,i.public_key=t.init_with_private_key(s.key)}else i.public_key=t.generate_key();return(new s.g.Olm.PkEncryption).set_recipient_key(i.public_key),[t.get_private_key(),i]}finally{t.free()}}static checkBackupVersion(e){if(!("public_key"in e.auth_data))throw new Error("Invalid backup data returned")}get untrusted(){return!0}async encryptSession(e){const t=Object.assign({},e);return delete t.session_id,delete t.room_id,delete t.first_known_index,this.publicKey.encrypt(JSON.stringify(t))}async decryptSessions(e){const t=await this.getKey(),i=new s.g.Olm.PkDecryption;try{if(i.init_with_private_key(t)!==this.authData.public_key)throw new h.up({errcode:n.pB.RESTORE_BACKUP_ERROR_BAD_KEY});const s=[];for(const[t,n]of Object.entries(e))try{const e=JSON.parse(i.decrypt(n.session_data.ephemeral,n.session_data.mac,n.session_data.ciphertext));e.session_id=t,s.push(e)}catch(e){r.v.log("Failed to decrypt megolm session from backup",e,n)}return s}finally{i.free()}}async keyMatches(e){const t=new s.g.Olm.PkDecryption;let i;try{i=t.init_with_private_key(e)}finally{t.free()}return i===this.authData.public_key}free(){this.publicKey.free()}}(0,i.A)(y,"algorithmName","m.megolm_backup.v1.curve25519-aes-sha2");const S=new l.qr("m.megolm_backup.v1.aes-hmac-sha2","org.matrix.msc3270.v1.aes-hmac-sha2");class b{constructor(e,t){this.authData=e,this.key=t}static async init(e,t){if(!e)throw new Error("auth_data missing");const s=await t();if(e.mac){const{mac:t}=await(0,v.calculateKeyCheck)(s,e.iv);if(e.mac.replace(/=+$/g,"")!==t.replace(/=+/g,""))throw new Error("Key does not match")}return new b(e,s)}static async prepare(e){let t;const s={};if(e)if(e instanceof Uint8Array)t=new Uint8Array(e);else{const i=await(0,a.SM)(e);s.private_key_salt=i.salt,s.private_key_iterations=i.iterations,t=i.key}else t=function(e){const t=new Uint8Array(e);return globalThis.crypto.getRandomValues(t),t}(32);const{iv:i,mac:n}=await(0,v.calculateKeyCheck)(t);return s.iv=i,s.mac=n,[t,s]}static checkBackupVersion(e){if(!("iv"in e.auth_data)||!("mac"in e.auth_data))throw new Error("Invalid backup data returned")}get untrusted(){return!1}encryptSession(e){const t=Object.assign({},e);return delete t.session_id,delete t.room_id,delete t.first_known_index,(0,g.A)(JSON.stringify(t),this.key,e.session_id)}async decryptSessions(e){const t=[];for(const[s,i]of Object.entries(e))try{const e=JSON.parse(await(0,p.A)(i.session_data,this.key,s));e.session_id=s,t.push(e)}catch(e){r.v.log("Failed to decrypt megolm session from backup",e,i)}return t}async keyMatches(e){if(this.authData.mac){const{mac:t}=await(0,v.calculateKeyCheck)(e,this.authData.iv);return this.authData.mac.replace(/=+$/g,"")===t.replace(/=+/g,"")}return!0}free(){this.key.fill(0)}}(0,i.A)(b,"algorithmName",S.name);const E={[y.algorithmName]:y,[b.algorithmName]:b},w=y;function I(e){var t;return{trusted:e.usable,matchesDecryptionKey:null!==(t=e.trusted_locally)&&void 0!==t&&t}}class _{constructor(e){(0,i.A)(this,"algorithm",void 0),(0,i.A)(this,"sourceTrusted",void 0),this.algorithm=e,this.sourceTrusted=!e.untrusted}free(){this.algorithm.free()}async decryptSessions(e){return await this.algorithm.decryptSessions(e)}}},"./node_modules/matrix-js-sdk/src/crypto/dehydration.ts":(e,t,s)=>{"use strict";s.d(t,{S:()=>m,v:()=>g});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/another-json/another-json.js"),r=s.n(n),o=s("./node_modules/matrix-js-sdk/src/base64.ts"),a=s("./node_modules/matrix-js-sdk/src/crypto/store/indexeddb-crypto-store.ts"),d=s("./node_modules/matrix-js-sdk/src/logger.ts"),c=s("./node_modules/matrix-js-sdk/src/http-api/index.ts"),l=s("./node_modules/matrix-js-sdk/src/utils/decryptAESSecretStorageItem.ts"),u=s("./node_modules/matrix-js-sdk/src/utils/encryptAESSecretStorageItem.ts"),h=s("./node_modules/buffer/index.js").hp;const m="org.matrix.msc2697.v1.olm.libolm_pickle",p=6048e5;class g{constructor(e){(0,i.A)(this,"inProgress",!1),(0,i.A)(this,"timeoutId",void 0),(0,i.A)(this,"key",void 0),(0,i.A)(this,"keyInfo",void 0),(0,i.A)(this,"deviceDisplayName",void 0),this.crypto=e,this.getDehydrationKeyFromCache()}getDehydrationKeyFromCache(){return this.crypto.cryptoStore.doTxn("readonly",[a.y.STORE_ACCOUNT],(e=>{this.crypto.cryptoStore.getSecretStorePrivateKey(e,(async e=>{if(e){const{key:t,keyInfo:i,deviceDisplayName:n,time:r}=e,a=h.from(this.crypto.olmDevice.pickleKey),d=await(0,l.A)(t,a,m);this.key=(0,o.y4)(d),this.keyInfo=i,this.deviceDisplayName=n;const c=Date.now(),u=Math.max(1,r+p-c);this.timeoutId=s.g.setTimeout(this.dehydrateDevice.bind(this),u)}}),"dehydration")}))}async setKeyAndQueueDehydration(e,t={},s){await this.setKey(e,t,s)||this.dehydrateDevice()}async setKey(e,t={},i){if(!e)return this.timeoutId&&(s.g.clearTimeout(this.timeoutId),this.timeoutId=void 0),await this.crypto.cryptoStore.doTxn("readwrite",[a.y.STORE_ACCOUNT],(e=>{this.crypto.cryptoStore.storeSecretStorePrivateKey(e,"dehydration",null)})),this.key=void 0,void(this.keyInfo=void 0);let n=!!this.key&&e.length==this.key.length;for(let t=0;n&&t<e.length;t++)e[t]!=this.key[t]&&(n=!1);return n||(this.key=e,this.keyInfo=t,this.deviceDisplayName=i),n}async dehydrateDevice(){if(this.inProgress)d.v.log("Dehydration already in progress -- not starting new dehydration");else{this.inProgress=!0,this.timeoutId&&(s.g.clearTimeout(this.timeoutId),this.timeoutId=void 0);try{const e=h.from(this.crypto.olmDevice.pickleKey),t=await(0,u.A)((0,o.WG)(this.key),e,m);await this.crypto.cryptoStore.doTxn("readwrite",[a.y.STORE_ACCOUNT],(e=>{this.crypto.cryptoStore.storeSecretStorePrivateKey(e,"dehydration",{keyInfo:this.keyInfo,key:t,deviceDisplayName:this.deviceDisplayName,time:Date.now()})})),d.v.log("Attempting to dehydrate device"),d.v.log("Creating account");const i=new s.g.Olm.Account;i.create();const n=JSON.parse(i.identity_keys()),l=i.max_number_of_one_time_keys();i.generate_one_time_keys(l/2),i.generate_fallback_key();const g=JSON.parse(i.one_time_keys()),v=JSON.parse(i.fallback_key());i.mark_keys_as_published();const f=i.pickle(new Uint8Array(this.key)),y={algorithm:m,account:f};this.keyInfo.passphrase&&(y.passphrase=this.keyInfo.passphrase),d.v.log("Uploading account to server");const S=(await this.crypto.baseApis.http.authedRequest(c.IT.Put,"/dehydrated_device",void 0,{device_data:y,initial_device_display_name:this.deviceDisplayName},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})).device_id;d.v.log("Preparing device keys",S);const b={algorithms:this.crypto.supportedAlgorithms,device_id:S,user_id:this.crypto.userId,keys:{[`ed25519:${S}`]:n.ed25519,[`curve25519:${S}`]:n.curve25519}},E=i.sign(r().stringify(b));b.signatures={[this.crypto.userId]:{[`ed25519:${S}`]:E}},this.crypto.crossSigningInfo.getId("self_signing")&&await this.crypto.crossSigningInfo.signObject(b,"self_signing"),d.v.log("Preparing one-time keys");const w={};for(const[e,t]of Object.entries(g.curve25519)){const s={key:t},n=i.sign(r().stringify(s));s.signatures={[this.crypto.userId]:{[`ed25519:${S}`]:n}},w[`signed_curve25519:${e}`]=s}d.v.log("Preparing fallback keys");const I={};for(const[e,t]of Object.entries(v.curve25519)){const s={key:t,fallback:!0},n=i.sign(r().stringify(s));s.signatures={[this.crypto.userId]:{[`ed25519:${S}`]:n}},I[`signed_curve25519:${e}`]=s}return d.v.log("Uploading keys to server"),await this.crypto.baseApis.http.authedRequest(c.IT.Post,"/keys/upload/"+encodeURI(S),void 0,{device_keys:b,one_time_keys:w,"org.matrix.msc2732.fallback_keys":I}),d.v.log("Done dehydrating"),this.timeoutId=s.g.setTimeout(this.dehydrateDevice.bind(this),p),S}finally{this.inProgress=!1}}}stop(){this.timeoutId&&(s.g.clearTimeout(this.timeoutId),this.timeoutId=void 0)}}},"./node_modules/matrix-js-sdk/src/crypto/deviceinfo.ts":(e,t,s)=>{"use strict";s.d(t,{V:()=>r});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/models/device.ts");class r{static fromStorage(e,t){const s=new r(t);for(const t in e)e.hasOwnProperty(t)&&(s[t]=e[t]);return s}constructor(e){(0,i.A)(this,"algorithms",[]),(0,i.A)(this,"keys",{}),(0,i.A)(this,"verified",n.u.Unverified),(0,i.A)(this,"known",!1),(0,i.A)(this,"unsigned",{}),(0,i.A)(this,"signatures",{}),this.deviceId=e}toStorage(){return{algorithms:this.algorithms,keys:this.keys,verified:this.verified,known:this.known,unsigned:this.unsigned,signatures:this.signatures}}getFingerprint(){return this.keys["ed25519:"+this.deviceId]}getIdentityKey(){return this.keys["curve25519:"+this.deviceId]}getDisplayName(){return this.unsigned.device_display_name||null}isBlocked(){return this.verified==n.u.Blocked}isVerified(){return this.verified==n.u.Verified}isUnverified(){return this.verified==n.u.Unverified}isKnown(){return!0===this.known}}(0,i.A)(r,"DeviceVerification",{VERIFIED:n.u.Verified,UNVERIFIED:n.u.Unverified,BLOCKED:n.u.Blocked})},"./node_modules/matrix-js-sdk/src/crypto/index.ts":(e,t,s)=>{"use strict";s.d(t,{Qr:()=>It,cr:()=>wt,D$:()=>_t,DM:()=>Et});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/another-json/another-json.js"),r=s.n(n),o=s("./node_modules/uuid/dist/esm-browser/v4.js"),a=s("./node_modules/matrix-js-sdk/src/@types/event.ts"),d=s("./node_modules/matrix-js-sdk/src/ReEmitter.ts"),c=s("./node_modules/matrix-js-sdk/src/logger.ts"),l=s("./node_modules/matrix-js-sdk/src/crypto/OlmDevice.ts"),u=s("./node_modules/matrix-js-sdk/src/crypto/olmlib.ts"),h=s("./node_modules/matrix-js-sdk/src/crypto/deviceinfo.ts"),m=s("./node_modules/matrix-js-sdk/src/crypto/store/indexeddb-crypto-store.ts"),p=s("./node_modules/matrix-js-sdk/src/crypto-api/index.ts"),g=s("./node_modules/matrix-js-sdk/src/base64.ts"),v=s("./node_modules/matrix-js-sdk/src/utils/encryptAESSecretStorageItem.ts"),f=s("./node_modules/matrix-js-sdk/src/utils/decryptAESSecretStorageItem.ts"),y=s("./node_modules/buffer/index.js").hp;function S(e){return Object.values(e.keys)[0]}class b{constructor(e,t={},s={}){(0,i.A)(this,"keys",{}),(0,i.A)(this,"firstUse",!0),(0,i.A)(this,"crossSigningVerifiedBefore",!1),this.userId=e,this.callbacks=t,this.cacheCallbacks=s}static fromStorage(e,t){const s=new b(t);for(const t in e)e.hasOwnProperty(t)&&(s[t]=e[t]);return s}toStorage(){return{keys:this.keys,firstUse:this.firstUse,crossSigningVerifiedBefore:this.crossSigningVerifiedBefore}}async getCrossSigningKey(e,t){const i=["master","self_signing","user_signing"].indexOf(e)>=0;if(!this.callbacks.getCrossSigningKey)throw new Error("No getCrossSigningKey callback supplied");function n(e){if(!e)return;const i=new s.g.Olm.PkSigning,n=i.init_with_seed(e);if(n===t)return[n,i];i.free()}void 0===t&&(t=this.getId(e));let r=null;this.cacheCallbacks.getCrossSigningKeyCache&&i&&(r=await this.cacheCallbacks.getCrossSigningKeyCache(e,t));const o=n(r);if(o)return o;r=await this.callbacks.getCrossSigningKey(e,t);const a=n(r);if(a)return this.cacheCallbacks.storeCrossSigningKeyCache&&i&&await this.cacheCallbacks.storeCrossSigningKeyCache(e,r),a;if(!r)throw new Error("getCrossSigningKey callback for "+e+" returned falsey");throw new Error("Key type "+e+" from getCrossSigningKey callback did not match")}async isStoredInSecretStorage(e){const t=await e.isStored("m.cross_signing.master")||{};function s(e){for(const s of Object.keys(t))e[s]||delete t[s]}for(const t of["self_signing","user_signing"])s(await e.isStored(`m.cross_signing.${t}`)||{});return Object.keys(t).length?t:null}static async storeInSecretStorage(e,t){for(const[s,i]of e){const e=(0,g.WG)(i);await t.store(`m.cross_signing.${s}`,e)}}static async getFromSecretStorage(e,t){const s=await t.get(`m.cross_signing.${e}`);return s?(0,g.y4)(s):null}async isStoredInKeyCache(e){const t=this.cacheCallbacks;if(!t)return!1;const s=e?[e]:["master","self_signing","user_signing"];for(const e of s){var i;if(!await(null===(i=t.getCrossSigningKeyCache)||void 0===i?void 0:i.call(t,e)))return!1}return!0}async getCrossSigningKeysFromCache(){const e=new Map,t=this.cacheCallbacks;if(!t)return e;for(const i of["master","self_signing","user_signing"]){var s;const n=await(null===(s=t.getCrossSigningKeyCache)||void 0===s?void 0:s.call(t,i));n&&e.set(i,n)}return e}getId(e="master"){if(!this.keys[e])return null;return S(this.keys[e])}async resetKeys(e){if(!this.callbacks.saveCrossSigningKeys)throw new Error("No saveCrossSigningKeys callback supplied");if(void 0===e||e&E.MASTER||!this.keys.master)e=E.MASTER|E.USER_SIGNING|E.SELF_SIGNING;else if(0===e)return;const t={},i={};let n,r;try{if(e&E.MASTER?(n=new s.g.Olm.PkSigning,t.master=n.generate_seed(),r=n.init_with_seed(t.master),i.master={user_id:this.userId,usage:["master"],keys:{["ed25519:"+r]:r}}):[r,n]=await this.getCrossSigningKey("master"),e&E.SELF_SIGNING){const e=new s.g.Olm.PkSigning;try{t.self_signing=e.generate_seed();const s=e.init_with_seed(t.self_signing);i.self_signing={user_id:this.userId,usage:["self_signing"],keys:{["ed25519:"+s]:s}},(0,u.pkSign)(i.self_signing,n,this.userId,r)}finally{e.free()}}if(e&E.USER_SIGNING){const e=new s.g.Olm.PkSigning;try{t.user_signing=e.generate_seed();const s=e.init_with_seed(t.user_signing);i.user_signing={user_id:this.userId,usage:["user_signing"],keys:{["ed25519:"+s]:s}},(0,u.pkSign)(i.user_signing,n,this.userId,r)}finally{e.free()}}Object.assign(this.keys,i),this.callbacks.saveCrossSigningKeys(t)}finally{n&&n.free()}}clearKeys(){this.keys={}}setKeys(e){const t={};if(e.master){if(e.master.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in master key from "+this.userId;throw c.v.error(t),new Error(t)}this.keys.master?S(e.master)!==this.getId()&&(this.firstUse=!1):this.firstUse=!0,t.master=e.master}else{if(!this.keys.master)throw new Error("Tried to set cross-signing keys without a master key");t.master=this.keys.master}const s=S(t.master);if(e.user_signing){if(e.user_signing.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in user_signing key from "+this.userId;throw c.v.error(t),new Error(t)}try{(0,u.pkVerify)(e.user_signing,s,this.userId)}catch(e){throw c.v.error("invalid signature on user-signing key"),e}}if(e.self_signing){if(e.self_signing.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in self_signing key from "+this.userId;throw c.v.error(t),new Error(t)}try{(0,u.pkVerify)(e.self_signing,s,this.userId)}catch(e){throw c.v.error("invalid signature on self-signing key"),e}}e.master&&(this.keys.master=e.master,delete this.keys.self_signing,delete this.keys.user_signing),e.self_signing&&(this.keys.self_signing=e.self_signing),e.user_signing&&(this.keys.user_signing=e.user_signing)}updateCrossSigningVerifiedBefore(e){!this.crossSigningVerifiedBefore&&e&&(this.crossSigningVerifiedBefore=!0)}async signObject(e,t){if(!this.keys[t])throw new Error("Attempted to sign with "+t+" key but no such key present");const[s,i]=await this.getCrossSigningKey(t);try{return(0,u.pkSign)(e,i,this.userId,s),e}finally{i.free()}}async signUser(e){if(this.keys.user_signing)return this.signObject(e.keys.master,"user_signing");c.v.info("No user signing key: not signing user")}async signDevice(e,t){if(e!==this.userId)throw new Error(`Trying to sign ${e}'s device; can only sign our own device`);if(this.keys.self_signing)return this.signObject({algorithms:t.algorithms,keys:t.keys,device_id:t.deviceId,user_id:e},"self_signing");c.v.info("No self signing key: not signing device")}checkUserTrust(e){if(this.userId===e.userId&&this.getId()&&this.getId()===e.getId()&&this.getId("self_signing")&&this.getId("self_signing")===e.getId("self_signing"))return new p.UserVerificationStatus(!0,!0,this.firstUse);if(!this.keys.user_signing)return new p.UserVerificationStatus(!1,!1,e.firstUse);let t;const s=e.keys.master,i=this.getId("user_signing");try{(0,u.pkVerify)(s,i,this.userId),t=!0}catch(e){t=!1}return new p.UserVerificationStatus(t,e.crossSigningVerifiedBefore,e.firstUse)}checkDeviceTrust(e,t,s,i){const n=this.checkUserTrust(e),r=e.keys.self_signing;if(!r)return new w(!1,!1,s,i);const o=function(e,t){return{algorithms:e.algorithms,keys:e.keys,device_id:e.deviceId,user_id:t,signatures:e.signatures}}(t,e.userId);try{return(0,u.pkVerify)(r,e.getId(),e.userId),(0,u.pkVerify)(o,S(r),e.userId),w.fromUserTrustLevel(n,s,i)}catch(e){return new w(!1,!1,s,i)}}getCacheCallbacks(){return this.cacheCallbacks}}let E=function(e){return e[e.MASTER=4]="MASTER",e[e.USER_SIGNING=2]="USER_SIGNING",e[e.SELF_SIGNING=1]="SELF_SIGNING",e}({});class w extends p.DeviceVerificationStatus{constructor(e,t,s,i,n=!1){super({crossSigningVerified:e,tofu:t,localVerified:s,trustCrossSignedDevices:i,signedByOwner:n})}static fromUserTrustLevel(e,t,s){return new w(e.isCrossSigningVerified(),e.isTofu(),t,s,!0)}isCrossSigningVerified(){return this.crossSigningVerified}isLocallyVerified(){return this.localVerified}isTofu(){return this.tofu}}function I(e,t){return{getCrossSigningKeyCache:async function(s,i){const n=await new Promise((t=>{e.doTxn("readonly",[m.y.STORE_ACCOUNT],(i=>{e.getSecretStorePrivateKey(i,t,s)}))}));if(n&&n.ciphertext){const e=y.from(t.pickleKey),i=await(0,f.A)(n,e,s);return(0,g.y4)(i)}return n},storeCrossSigningKeyCache:async function(s,i){if(!(i instanceof Uint8Array))throw new Error(`storeCrossSigningKeyCache expects Uint8Array, got ${i}`);const n=y.from(t.pickleKey),r=await(0,v.A)((0,g.WG)(i),n,s);return e.doTxn("readwrite",[m.y.STORE_ACCOUNT],(t=>{e.storeSecretStorePrivateKey(t,s,r)}))}}}var _=s("./node_modules/matrix-js-sdk/src/utils.ts"),k=s("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts");let R=function(e){return e[e.NotTracked=0]="NotTracked",e[e.PendingDownload=1]="PendingDownload",e[e.DownloadInProgress=2]="DownloadInProgress",e[e.UpToDate=3]="UpToDate",e}({});class T extends k.X{constructor(e,t,s,n=250){super(),(0,i.A)(this,"devices",{}),(0,i.A)(this,"crossSigningInfo",{}),(0,i.A)(this,"userByIdentityKey",{}),(0,i.A)(this,"deviceTrackingStatus",{}),(0,i.A)(this,"syncToken",null),(0,i.A)(this,"keyDownloadsInProgressByUser",new Map),(0,i.A)(this,"dirty",!1),(0,i.A)(this,"savePromise",null),(0,i.A)(this,"resolveSavePromise",null),(0,i.A)(this,"savePromiseTime",null),(0,i.A)(this,"saveTimer",null),(0,i.A)(this,"hasFetched",null),(0,i.A)(this,"serialiser",void 0),this.cryptoStore=t,this.keyDownloadChunkSize=n,this.serialiser=new C(e,s,this)}async load(){await this.cryptoStore.doTxn("readonly",[m.y.STORE_DEVICE_DATA],(e=>{this.cryptoStore.getEndToEndDeviceData(e,(e=>{var t;this.hasFetched=Boolean(null==e?void 0:e.devices),this.devices=e?e.devices:{},this.crossSigningInfo=e&&e.crossSigningInfo||{},this.deviceTrackingStatus=e?e.trackingStatus:{},this.syncToken=null!==(t=null==e?void 0:e.syncToken)&&void 0!==t?t:null,this.userByIdentityKey={};for(const e of Object.keys(this.devices)){const t=this.devices[e];for(const s of Object.keys(t)){const i=t[s].keys["curve25519:"+s];void 0!==i&&(this.userByIdentityKey[i]=e)}}}))}));for(const e of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[e]==R.DownloadInProgress&&(this.deviceTrackingStatus[e]=R.PendingDownload)}stop(){null!==this.saveTimer&&clearTimeout(this.saveTimer)}async saveIfDirty(e=500){if(!this.dirty)return Promise.resolve(!1);const t=Date.now()+e;this.savePromiseTime&&t<this.savePromiseTime&&(clearTimeout(this.saveTimer),this.saveTimer=null,this.savePromiseTime=null);let s=this.savePromise;if(null===s&&(s=new Promise((e=>{this.resolveSavePromise=e})),this.savePromise=s),null===this.saveTimer){const s=this.resolveSavePromise;this.savePromiseTime=t,this.saveTimer=setTimeout((()=>{c.v.log("Saving device tracking data",this.syncToken),this.savePromiseTime=null,this.saveTimer=null,this.savePromise=null,this.resolveSavePromise=null,this.cryptoStore.doTxn("readwrite",[m.y.STORE_DEVICE_DATA],(e=>{var t;this.cryptoStore.storeEndToEndDeviceData({devices:this.devices,crossSigningInfo:this.crossSigningInfo,trackingStatus:this.deviceTrackingStatus,syncToken:null!==(t=this.syncToken)&&void 0!==t?t:void 0},e)})).then((()=>{this.dirty=!1,null==s||s(!0)}),(e=>{c.v.error("Failed to save device tracking data",this.syncToken),c.v.error(e)}))}),e)}return s}getSyncToken(){return this.syncToken}setSyncToken(e){this.syncToken=e}downloadKeys(e,t){const s=[],i=[];if(e.forEach((e=>{const n=this.deviceTrackingStatus[e];this.keyDownloadsInProgressByUser.has(e)?(c.v.log(`downloadKeys: already have a download in progress for ${e}: awaiting its result`),i.push(this.keyDownloadsInProgressByUser.get(e))):(t||n!=R.UpToDate)&&s.push(e)})),0!=s.length){c.v.log("downloadKeys: downloading for",s);const e=this.doKeyDownload(s);i.push(e)}return 0===i.length&&c.v.log("downloadKeys: already have all necessary keys"),Promise.all(i).then((()=>this.getDevicesFromStore(e)))}getDevicesFromStore(e){const t=new Map;return e.forEach((e=>{var s;const i=new Map;null===(s=this.getStoredDevicesForUser(e))||void 0===s||s.forEach((function(e){i.set(e.deviceId,e)})),t.set(e,i)})),t}getKnownUserIds(){return Object.keys(this.devices)}getStoredDevicesForUser(e){const t=this.devices[e];if(!t)return null;const s=[];for(const e in t)t.hasOwnProperty(e)&&s.push(h.V.fromStorage(t[e],e));return s}getRawStoredDevicesForUser(e){return this.devices[e]}getStoredCrossSigningForUser(e){return this.crossSigningInfo[e]?b.fromStorage(this.crossSigningInfo[e],e):null}storeCrossSigningForUser(e,t){this.crossSigningInfo[e]=t,this.dirty=!0}getStoredDevice(e,t){const s=this.devices[e];if(null!=s&&s[t])return h.V.fromStorage(s[t],t)}getUserByIdentityKey(e,t){return e!==u.OLM_ALGORITHM&&e!==u.MEGOLM_ALGORITHM?null:this.userByIdentityKey[t]}getDeviceByIdentityKey(e,t){const s=this.getUserByIdentityKey(e,t);if(!s)return null;const i=this.devices[s];if(!i)return null;for(const e in i){if(!i.hasOwnProperty(e))continue;const s=i[e];for(const i in s.keys){if(!s.keys.hasOwnProperty(i))continue;if(0!==i.indexOf("curve25519:"))continue;if(s.keys[i]==t)return h.V.fromStorage(s,e)}}return null}storeDevicesForUser(e,t){this.setRawStoredDevicesForUser(e,t),this.dirty=!0}startTrackingDeviceList(e){if("string"!=typeof e)throw new Error("userId must be a string; was "+e);this.deviceTrackingStatus[e]||(c.v.log("Now tracking device list for "+e),this.deviceTrackingStatus[e]=R.PendingDownload,this.dirty=!0)}stopTrackingDeviceList(e){this.deviceTrackingStatus[e]&&(c.v.log("No longer tracking device list for "+e),this.deviceTrackingStatus[e]=R.NotTracked,this.dirty=!0)}stopTrackingAllDeviceLists(){for(const e of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[e]=R.NotTracked;this.dirty=!0}invalidateUserDeviceList(e){this.deviceTrackingStatus[e]&&(c.v.log("Marking device list outdated for",e),this.deviceTrackingStatus[e]=R.PendingDownload,this.dirty=!0)}refreshOutdatedDeviceLists(){this.saveIfDirty();const e=[];for(const t of Object.keys(this.deviceTrackingStatus)){this.deviceTrackingStatus[t]==R.PendingDownload&&e.push(t)}return this.doKeyDownload(e)}setRawStoredDevicesForUser(e,t){if(void 0!==this.devices[e])for(const[t,s]of Object.entries(this.devices[e])){const e=s.keys["curve25519:"+t];delete this.userByIdentityKey[e]}this.devices[e]=t;for(const[s,i]of Object.entries(t)){const t=i.keys["curve25519:"+s];this.userByIdentityKey[t]=e}}setRawStoredCrossSigningForUser(e,t){this.crossSigningInfo[e]=t}doKeyDownload(e){if(0===e.length)return Promise.resolve();const t=this.serialiser.updateDevicesForUsers(e,this.syncToken).then((()=>{s(!0)}),(t=>{throw c.v.error("Error downloading keys for "+e+":",t),s(!1),t}));e.forEach((e=>{this.keyDownloadsInProgressByUser.set(e,t);this.deviceTrackingStatus[e]==R.PendingDownload&&(this.deviceTrackingStatus[e]=R.DownloadInProgress)}));const s=s=>{this.emit(wt.WillUpdateDevices,e,!this.hasFetched),e.forEach((e=>{if(this.dirty=!0,this.keyDownloadsInProgressByUser.get(e)!==t)return void c.v.log("Another update in the queue for",e,"- not marking up-to-date");this.keyDownloadsInProgressByUser.delete(e);this.deviceTrackingStatus[e]==R.DownloadInProgress&&(s?(this.deviceTrackingStatus[e]=R.UpToDate,c.v.log("Device list for",e,"now up to date")):this.deviceTrackingStatus[e]=R.PendingDownload)})),this.saveIfDirty(),this.emit(wt.DevicesUpdated,e,!this.hasFetched),this.hasFetched=!0};return t}}class C{constructor(e,t,s){(0,i.A)(this,"downloadInProgress",!1),(0,i.A)(this,"keyDownloadsQueuedByUser",{}),(0,i.A)(this,"queuedQueryDeferred",void 0),(0,i.A)(this,"syncToken",void 0),this.baseApis=e,this.olmDevice=t,this.deviceList=s}updateDevicesForUsers(e,t){return e.forEach((e=>{this.keyDownloadsQueuedByUser[e]=!0})),this.queuedQueryDeferred||(this.queuedQueryDeferred=(0,_.v6)()),this.syncToken=t,this.downloadInProgress?(c.v.log("Queued key download for",e),this.queuedQueryDeferred.promise):this.doQueuedQueries()}doQueuedQueries(){if(this.downloadInProgress)throw new Error("DeviceListUpdateSerialiser.doQueuedQueries called with request active");const e=Object.keys(this.keyDownloadsQueuedByUser);this.keyDownloadsQueuedByUser={};const t=this.queuedQueryDeferred;this.queuedQueryDeferred=void 0,c.v.log("Starting key download for",e),this.downloadInProgress=!0;const s={};this.syncToken&&(s.token=this.syncToken);const i=[];for(let t=0;t<e.length;t+=this.deviceList.keyDownloadChunkSize){const n=e.slice(t,t+this.deviceList.keyDownloadChunkSize);i.push((()=>this.baseApis.downloadKeysForUsers(n,s)))}return(0,_.iK)(i,3).then((async t=>{const s=Object.assign({},...t.map((e=>e.device_keys||{}))),i=Object.assign({},...t.map((e=>e.master_keys||{}))),n=Object.assign({},...t.map((e=>e.self_signing_keys||{}))),r=Object.assign({},...t.map((e=>e.user_signing_keys||{})));for(const t of e){await(0,_.yy)(5);try{await this.processQueryResponseForUser(t,s[t],{master:null==i?void 0:i[t],self_signing:null==n?void 0:n[t],user_signing:null==r?void 0:r[t]})}catch(e){c.v.error(`Error processing keys for ${t}:`,e)}}})).then((()=>{c.v.log("Completed key download for "+e),this.downloadInProgress=!1,null==t||t.resolve(),this.queuedQueryDeferred&&this.doQueuedQueries()}),(s=>{c.v.warn("Error downloading keys for "+e+":",s),this.downloadInProgress=!1,null==t||t.reject(s)})),t.promise}async processQueryResponseForUser(e,t,s){c.v.log("got device keys for "+e+":",t),c.v.log("got cross-signing keys for "+e+":",s);{const s={},i=this.deviceList.getRawStoredDevicesForUser(e);i&&Object.keys(i).forEach((e=>{const t=h.V.fromStorage(i[e],e);s[e]=t})),await async function(e,t,s,i,n,r){let o=!1;for(const e in s)if(s.hasOwnProperty(e)&&!(e in i)){if(t===n&&e===r){c.v.warn(`Local device ${e} missing from sync, skipping removal`);continue}c.v.log("Device "+t+":"+e+" has been removed"),delete s[e],o=!0}for(const n in i){if(!i.hasOwnProperty(n))continue;const r=i[n];r.user_id===t?r.device_id===n?await A(e,s,r)&&(o=!0):c.v.warn("Mismatched device_id "+r.device_id+" in keys from "+t+":"+n):c.v.warn("Mismatched user_id "+r.user_id+" in keys from "+t+":"+n)}return o}(this.olmDevice,e,s,t||{},this.baseApis.getUserId(),this.baseApis.deviceId);const n={};Object.keys(s).forEach((e=>{n[e]=s[e].toStorage()})),this.deviceList.setRawStoredDevicesForUser(e,n)}if(s&&(s.master||s.self_signing||s.user_signing)){const t=this.deviceList.getStoredCrossSigningForUser(e)||new b(e);t.setKeys(s),this.deviceList.setRawStoredCrossSigningForUser(e,t.toStorage()),this.deviceList.emit(wt.UserCrossSigningUpdated,e)}}}async function A(e,t,s){if(!s.keys)return!1;const i=s.device_id,n=s.user_id,r="ed25519:"+i,o=s.keys[r];if(!o)return c.v.warn("Device "+n+":"+i+" has no ed25519 key"),!1;const a=s.unsigned||{},d=s.signatures||{};try{await u.verifySignature(e,s,n,i,o)}catch(e){return c.v.warn("Unable to verify signature on device "+n+":"+i+":"+e),!1}let l;if(i in t){if(l=t[i],l.getFingerprint()!=o)return c.v.warn("Ed25519 key for device "+n+":"+i+" has changed"),!1}else t[i]=l=new h.V(i);return l.keys=s.keys||{},l.algorithms=s.algorithms||[],l.unsigned=a,l.signatures=d,!0}var O=s("./node_modules/matrix-js-sdk/src/crypto/algorithms/base.ts"),M=s("./node_modules/matrix-js-sdk/src/common-crypto/CryptoBackend.ts");const x=h.V.DeviceVerification;class D extends O.li{constructor(...e){super(...e),(0,i.A)(this,"sessionPrepared",!1),(0,i.A)(this,"prepPromise",null)}ensureSession(e){return this.prepPromise?this.prepPromise:this.sessionPrepared?Promise.resolve():(this.prepPromise=this.crypto.downloadKeys(e).then((()=>this.crypto.ensureOlmSessionsForUsers(e))).then((()=>{this.sessionPrepared=!0})).finally((()=>{this.prepPromise=null})),this.prepPromise)}async encryptMessage(e,t,s){const i=(await e.getEncryptionTargetMembers()).map((function(e){return e.userId}));await this.ensureSession(i);const n={room_id:e.roomId,type:t,content:s},r={algorithm:u.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{}},o=[];for(const e of i){const t=this.crypto.getStoredDevicesForUser(e)||[];for(const s of t){s.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&(s.verified!=x.BLOCKED&&o.push(u.encryptMessageForDevice(r.ciphertext,this.userId,this.deviceId,this.olmDevice,e,s,n)))}}return Promise.all(o).then((()=>r))}}class P extends O.Tb{async decryptEvent(e){const t=e.getWireContent(),s=t.sender_key,i=t.ciphertext;if(!i)throw new M.O(p.DecryptionFailureCode.OLM_MISSING_CIPHERTEXT,"Missing ciphertext");if(!(this.olmDevice.deviceCurve25519Key in i))throw new M.O(p.DecryptionFailureCode.OLM_NOT_INCLUDED_IN_RECIPIENTS,"Not included in recipients");const n=i[this.olmDevice.deviceCurve25519Key];let r;try{r=await this.decryptMessage(s,n)}catch(e){throw new M.O(p.DecryptionFailureCode.OLM_BAD_ENCRYPTED_MESSAGE,"Bad Encrypted Message",{sender:s,err:e})}const o=JSON.parse(r);if(o.recipient!=this.userId)throw new M.O(p.DecryptionFailureCode.OLM_BAD_RECIPIENT,"Message was intended for "+o.recipient);if(o.recipient_keys.ed25519!=this.olmDevice.deviceEd25519Key)throw new M.O(p.DecryptionFailureCode.OLM_BAD_RECIPIENT_KEY,"Message not intended for this device",{intended:o.recipient_keys.ed25519,our_key:this.olmDevice.deviceEd25519Key});let a=this.crypto.deviceList.getUserByIdentityKey(u.OLM_ALGORITHM,s);if(null==a){try{await this.crypto.deviceList.downloadKeys([e.getSender()],!1)}catch(e){throw new M.O(p.DecryptionFailureCode.OLM_BAD_SENDER_CHECK_FAILED,"Could not verify sender identity",{sender:s,err:e})}a=this.crypto.deviceList.getUserByIdentityKey(u.OLM_ALGORITHM,s)}if(a!==e.getSender()&&null!=a)throw new M.O(p.DecryptionFailureCode.OLM_BAD_SENDER,"Message claimed to be from "+e.getSender(),{real_sender:a});if(o.sender!=e.getSender())throw new M.O(p.DecryptionFailureCode.OLM_FORWARDED_MESSAGE,"Message forwarded from "+o.sender,{reported_sender:e.getSender()});if(o.room_id!==e.getRoomId())throw new M.O(p.DecryptionFailureCode.OLM_BAD_ROOM,"Message intended for room "+o.room_id,{reported_room:e.getRoomId()||"ROOM_ID_UNDEFINED"});return{clearEvent:o,senderCurve25519Key:s,claimedEd25519Key:(o.keys||{}).ed25519||null}}decryptMessage(e,t){if(0!==t.type)return this.reallyDecryptMessage(e,t);{const s=this.olmDevice.olmPrekeyPromise.then((()=>this.reallyDecryptMessage(e,t)));return this.olmDevice.olmPrekeyPromise=s.catch((()=>{})),s}}async reallyDecryptMessage(e,t){const s=await this.olmDevice.getSessionIdsForDevice(e),i={};for(const n of s)try{const s=await this.olmDevice.decryptMessage(e,n,t.type,t.body);return c.v.log("Decrypted Olm message from "+e+" with session "+n),s}catch(s){if(await this.olmDevice.matchesSession(e,n,t.type,t.body))throw new Error("Error decrypting prekey message with existing session id "+n+": "+s.message);i[n]=s.message}if(0!==t.type){if(0===s.length)throw new Error("No existing sessions");throw new Error("Error decrypting non-prekey message with existing sessions: "+JSON.stringify(i))}let n;try{n=await this.olmDevice.createInboundSession(e,t.type,t.body)}catch(e){throw i["(new)"]=e.message,new Error("Error decrypting prekey message: "+JSON.stringify(i))}return c.v.log("created new inbound Olm session ID "+n.session_id+" with "+e),n.payload}}(0,O.x)(u.OLM_ALGORITHM,D,P);s("./node_modules/matrix-js-sdk/src/crypto/algorithms/megolm.ts");var U=s("./node_modules/matrix-js-sdk/src/models/event.ts"),j=s("./node_modules/matrix-js-sdk/src/http-api/index.ts"),L=s("./node_modules/matrix-js-sdk/src/client.ts");class N{constructor(e,t){(0,i.A)(this,"accountDataClientAdapter",void 0),(0,i.A)(this,"crossSigningCallbacks",void 0),(0,i.A)(this,"ssssCryptoCallbacks",void 0),(0,i.A)(this,"crossSigningKeys",void 0),(0,i.A)(this,"keySignatures",void 0),(0,i.A)(this,"keyBackupInfo",void 0),(0,i.A)(this,"sessionBackupPrivateKey",void 0),this.accountDataClientAdapter=new B(e),this.crossSigningCallbacks=new F,this.ssssCryptoCallbacks=new $(t)}addCrossSigningKeys(e,t){this.crossSigningKeys={authUpload:e,keys:t}}addSessionBackup(e){this.keyBackupInfo=e}addSessionBackupPrivateKeyToCache(e){this.sessionBackupPrivateKey=e}addKeySignature(e,t,s){this.keySignatures||(this.keySignatures={});const i=this.keySignatures[e]||{};this.keySignatures[e]=i,i[t]=s}async setAccountData(e,t){await this.accountDataClientAdapter.setAccountData(e,t)}buildOperation(){const e=this.accountDataClientAdapter.values;return new K(e,this.crossSigningKeys,this.keyBackupInfo,this.keySignatures)}async persist(e){if(this.crossSigningKeys){const s=I(e.cryptoStore,e.olmDevice);for(const e of["master","self_signing","user_signing"]){var t;c.v.log(`Cache ${e} cross-signing private key locally`);const i=this.crossSigningCallbacks.privateKeys.get(e);await(null===(t=s.storeCrossSigningKeyCache)||void 0===t?void 0:t.call(s,e,i))}await e.cryptoStore.doTxn("readwrite",[m.y.STORE_ACCOUNT],(t=>{e.cryptoStore.storeCrossSigningKeys(t,this.crossSigningKeys.keys)}))}this.sessionBackupPrivateKey&&await e.storeSessionBackupPrivateKey(this.sessionBackupPrivateKey)}}class K{constructor(e,t,s,i){this.accountData=e,this.crossSigningKeys=t,this.keyBackupInfo=s,this.keySignatures=i}async apply(e){const t=e.baseApis;if(this.crossSigningKeys){var s,i;const n={};for(const[e,t]of Object.entries(this.crossSigningKeys.keys))n[e+"_key"]=t;await(null===(s=(i=this.crossSigningKeys).authUpload)||void 0===s?void 0:s.call(i,(e=>t.uploadDeviceSigningKeys(null!=e?e:void 0,n)))),e.crossSigningInfo.setKeys(this.crossSigningKeys.keys)}if(this.accountData)for(const[e,s]of this.accountData)await t.setAccountData(e,s);this.keySignatures&&await t.uploadKeySignatures(this.keySignatures),this.keyBackupInfo&&(this.keyBackupInfo.version?await t.http.authedRequest(j.IT.Put,"/room_keys/version/"+this.keyBackupInfo.version,void 0,{algorithm:this.keyBackupInfo.algorithm,auth_data:this.keyBackupInfo.auth_data},{prefix:j.iD.V3}):await t.http.authedRequest(j.IT.Post,"/room_keys/version",void 0,this.keyBackupInfo,{prefix:j.iD.V3}),await e.backupManager.checkKeyBackup())}}class B extends k.X{constructor(e){super(),(0,i.A)(this,"values",new Map),this.existingValues=e}getAccountDataFromServer(e){return Promise.resolve(this.getAccountData(e))}getAccountData(e){const t=this.values.get(e);if(t)return t;const s=this.existingValues.get(e);return s?s.getContent():null}setAccountData(e,t){const s=this.values.get(e);return this.values.set(e,t),Promise.resolve().then((()=>{const i=new U.kl({type:e,content:t});return this.emit(L.AU.AccountData,i,s),{}}))}}class F{constructor(){(0,i.A)(this,"privateKeys",new Map)}getCrossSigningKeyCache(e,t){return this.getCrossSigningKey(e,t)}storeCrossSigningKeyCache(e,t){return this.privateKeys.set(e,t),Promise.resolve()}getCrossSigningKey(e,t){var s;return Promise.resolve(null!==(s=this.privateKeys.get(e))&&void 0!==s?s:null)}saveCrossSigningKeys(e){for(const[t,s]of Object.entries(e))this.privateKeys.set(t,s)}}class ${constructor(e){(0,i.A)(this,"privateKeys",new Map),this.delegateCryptoCallbacks=e}async getSecretStorageKey({keys:e},t){var s;for(const t of Object.keys(e)){const e=this.privateKeys.get(t);if(e)return[t,e]}if(null!=this&&null!==(s=this.delegateCryptoCallbacks)&&void 0!==s&&s.getSecretStorageKey){const s=await this.delegateCryptoCallbacks.getSecretStorageKey({keys:e},t);if(s){const[e,t]=s;this.privateKeys.set(e,t)}return s}return null}addPrivateKey(e,t,s){var i,n;this.privateKeys.set(e,s),null===(i=this.delegateCryptoCallbacks)||void 0===i||null===(n=i.cacheSecretStorageKey)||void 0===n||n.call(i,e,t,s)}}var q=s("./node_modules/matrix-js-sdk/src/secret-storage.ts");class V{constructor(e,t){(0,i.A)(this,"requests",new Map),this.baseApis=e,this.cryptoCallbacks=t}request(e,t){const s=this.baseApis.makeTxnId(),i=(0,_.v6)();this.requests.set(s,{name:e,devices:t,deferred:i});const n={name:e,action:"request",requesting_device_id:this.baseApis.deviceId,request_id:s,[a.wt]:(0,o.A)()},r=new Map;for(const e of t)r.set(e,n);return c.v.info(`Request secret ${e} from ${t}, id ${s}`),this.baseApis.sendToDevice("m.secret.request",new Map([[this.baseApis.getUserId(),r]])),{requestId:s,promise:i.promise,cancel:e=>{const n={action:"request_cancellation",requesting_device_id:this.baseApis.deviceId,request_id:s},r=new Map;for(const e of t)r.set(e,n);this.baseApis.sendToDevice("m.secret.request",new Map([[this.baseApis.getUserId(),r]])),i.reject(new Error(e||"Cancelled"))}}}async onRequestReceived(e){const t=e.getSender(),s=e.getContent();if(t!==this.baseApis.getUserId()||!(s.name&&s.action&&s.requesting_device_id&&s.request_id))return;const i=s.requesting_device_id;if("request_cancellation"===s.action);else if("request"===s.action){if(i===this.baseApis.deviceId)return;if(c.v.info("received request for secret ("+t+", "+i+", "+s.request_id+")"),!this.cryptoCallbacks.onSecretRequested)return;const e=await this.cryptoCallbacks.onSecretRequested(t,i,s.request_id,s.name,this.baseApis.checkDeviceTrust(t,i));if(e){c.v.info(`Preparing ${s.name} secret for ${i}`);const n={type:"m.secret.send",content:{request_id:s.request_id,secret:e}},r={algorithm:u.OLM_ALGORITHM,sender_key:this.baseApis.crypto.olmDevice.deviceCurve25519Key,ciphertext:{},[a.wt]:(0,o.A)()};await u.ensureOlmSessionsForDevices(this.baseApis.crypto.olmDevice,this.baseApis,new Map([[t,[this.baseApis.getStoredDevice(t,i)]]])),await u.encryptMessageForDevice(r.ciphertext,this.baseApis.getUserId(),this.baseApis.deviceId,this.baseApis.crypto.olmDevice,t,this.baseApis.getStoredDevice(t,i),n);const d=new Map([[t,new Map([[i,r]])]]);c.v.info(`Sending ${s.name} secret for ${i}`),this.baseApis.sendToDevice("m.room.encrypted",d)}else c.v.info(`Request denied for ${s.name} secret for ${i}`)}}onSecretReceived(e){if(e.getSender()!==this.baseApis.getUserId())return;if(!u.isOlmEncrypted(e))return void c.v.error("secret event not properly encrypted");const t=e.getContent();if(this.baseApis.crypto.deviceList.getUserByIdentityKey(u.OLM_ALGORITHM,e.getSenderKey()||"")!==e.getSender())return void c.v.error("sending device does not belong to the user it claims to be from");c.v.log("got secret share for request",t.request_id);const s=this.requests.get(t.request_id);if(s){const i=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(u.OLM_ALGORITHM,e.getSenderKey());if(!i)return void c.v.log("secret share from unknown device with key",e.getSenderKey());if(!s.devices.includes(i.deviceId))return void c.v.log("unsolicited secret share from device",i.deviceId);if(!this.baseApis.crypto.checkDeviceInfoTrust(e.getSender(),i).isVerified())return void c.v.log("secret share from unverified device");c.v.log(`Successfully received secret ${s.name} from ${i.deviceId}`),s.deferred.resolve(t.secret)}}}class G{constructor(e,t,s){(0,i.A)(this,"storageImpl",void 0),(0,i.A)(this,"sharingImpl",void 0),this.storageImpl=new q.ServerSideSecretStorageImpl(e,t),this.sharingImpl=new V(s,t)}getDefaultKeyId(){return this.storageImpl.getDefaultKeyId()}setDefaultKeyId(e){return this.storageImpl.setDefaultKeyId(e)}addKey(e,t,s){return this.storageImpl.addKey(e,t,s)}getKey(e){return this.storageImpl.getKey(e)}hasKey(e){return this.storageImpl.hasKey(e)}checkKey(e,t){return this.storageImpl.checkKey(e,t)}store(e,t,s){return this.storageImpl.store(e,t,s)}get(e){return this.storageImpl.get(e)}async isStored(e){return this.storageImpl.isStored(e)}request(e,t){return this.sharingImpl.request(e,t)}onRequestReceived(e){return this.sharingImpl.onRequestReceived(e)}onSecretReceived(e){this.sharingImpl.onSecretReceived(e)}}var H=s("./node_modules/matrix-js-sdk/src/crypto/api.ts"),W=s("./node_modules/matrix-js-sdk/src/crypto/OutgoingRoomKeyRequestManager.ts");function J(e,t){return function(s){return function(e,t,s){const i=Object.assign({},{code:e,reason:t},s);return new U.kl({type:a.Bx.KeyVerificationCancel,content:i})}(e,t,s)}}const z=J("m.user","Cancelled by user"),Q=J("m.timeout","Timed out"),Y=J("m.unknown_method","Unknown method"),X=J("m.unexpected_message","Unexpected message"),Z=J("m.key_mismatch","Key mismatch"),ee=J("m.invalid_message","Invalid message");function te(e){const t=e.getContent();if(t){const{code:e,reason:s}=t;return{code:e,reason:s}}return{code:"Unknown error",reason:"m.unknown"}}var se=s("./node_modules/matrix-js-sdk/src/crypto-api/verification.ts");const ie=new Error("Verification timed out");class ne extends Error{constructor(e){super(),this.startEvent=e}}const re=se.Ji;class oe extends k.X{constructor(e,t,s,n,r,o){super(),(0,i.A)(this,"cancelled",!1),(0,i.A)(this,"_done",!1),(0,i.A)(this,"promise",null),(0,i.A)(this,"transactionTimeoutTimer",null),(0,i.A)(this,"expectedEvent",void 0),(0,i.A)(this,"resolve",void 0),(0,i.A)(this,"reject",void 0),(0,i.A)(this,"resolveEvent",void 0),(0,i.A)(this,"rejectEvent",void 0),(0,i.A)(this,"started",void 0),(0,i.A)(this,"doVerification",void 0),this.channel=e,this.baseApis=t,this.userId=s,this.deviceId=n,this.startEvent=r,this.request=o}get initiatedByMe(){if(!this.startEvent)return!0;const e=this.startEvent.getSender(),t=this.startEvent.getContent();return e===this.baseApis.getUserId()&&t.from_device===this.baseApis.getDeviceId()}get hasBeenCancelled(){return this.cancelled}resetTimer(){c.v.info("Refreshing/starting the verification transaction timeout timer"),null!==this.transactionTimeoutTimer&&clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=setTimeout((()=>{this._done||this.cancelled||(c.v.info("Triggering verification timeout"),this.cancel(ie))}),6e5)}endTimer(){null!==this.transactionTimeoutTimer&&(clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=null)}send(e,t){return this.channel.send(e,t)}waitForEvent(e){if(this._done)return Promise.reject(new Error("Verification is already done"));const t=this.request.getEventFromOtherParty(e);return t?Promise.resolve(t):(this.expectedEvent=e,new Promise(((e,t)=>{this.resolveEvent=e,this.rejectEvent=t})))}canSwitchStartEvent(e){return!1}switchStartEvent(e){if(this.canSwitchStartEvent(e))if(c.v.log("Verification Base: switching verification start event",{restartingFlow:!!this.rejectEvent}),this.rejectEvent){const t=this.rejectEvent;this.rejectEvent=void 0,t(new ne(e))}else this.startEvent=e}handleEvent(e){var t;if(!this._done)if(e.getType()===this.expectedEvent)this.expectedEvent!==a.Bx.KeyVerificationDone&&(this.expectedEvent=void 0,this.rejectEvent=void 0,this.resetTimer(),null===(t=this.resolveEvent)||void 0===t||t.call(this,e));else if(e.getType()===a.Bx.KeyVerificationCancel){const t=this.reject;if(this.reject=void 0,t){const s=e.getContent(),{reason:i,code:n}=s;t(new Error(`Other side cancelled verification because ${i} (${n})`))}}else if(this.expectedEvent){const t=new Error("Unexpected message: expecting "+this.expectedEvent+" but got "+e.getType());if(this.expectedEvent=void 0,this.rejectEvent){const e=this.rejectEvent;this.rejectEvent=void 0,e(t)}this.cancel(t)}}async done(){var e;if(this.endTimer(),!this._done)return this.request.onVerifierFinished(),null===(e=this.resolve)||void 0===e||e.call(this),async function(e,t,s){if(e.getUserId()===t)return c.v.log("Cross-signing: Self-verification done; requesting keys"),new Promise(((t,i)=>{const n=e,r=n.crypto.crossSigningInfo,o=new b(r.userId,{getCrossSigningKey:async e=>{c.v.debug("Cross-signing: requesting secret",e,s);const{promise:t}=n.requestSecret(`m.cross_signing.${e}`,[s]),i=await t,r=(0,g.y4)(i);return Uint8Array.from(r)}},r.getCacheCallbacks());o.keys=r.keys;const a=new Promise((e=>{setTimeout(e,6e4,new Error("Timeout"))})),d=(async()=>{if(!await n.crypto.getSessionBackupPrivateKey()){c.v.info("No cached backup key found. Requesting...");const e=n.requestSecret("m.megolm_backup.v1",[s]),t=await e.promise;c.v.info("Got key backup key, decoding...");const i=(0,g.y4)(t);c.v.info("Decoded backup key, storing..."),await n.crypto.storeSessionBackupPrivateKey(Uint8Array.from(i)),c.v.info("Backup key stored. Starting backup restore...");const r=await n.getKeyBackupVersion();n.restoreKeyBackupWithCache(void 0,void 0,r).then((()=>{c.v.info("Backup restored.")}))}})();Promise.race([Promise.all([o.getCrossSigningKey("master"),o.getCrossSigningKey("self_signing"),o.getCrossSigningKey("user_signing"),d]),a]).then(t,i)})).catch((e=>{c.v.warn("Cross-signing: failure while requesting keys:",e)}))}(this.baseApis,this.userId,this.deviceId)}cancel(e){if(this.endTimer(),!this._done){if(this.cancelled=!0,this.request.onVerifierCancelled(),this.userId&&this.deviceId)if(e===ie){const e=Q();this.send(e.getType(),e.getContent())}else if(e instanceof U.kl){if(e.getSender()!==this.userId){const t=e.getContent();e.getType()===a.Bx.KeyVerificationCancel?(t.code=t.code||"m.unknown",t.reason=t.reason||t.body||"Unknown reason",this.send(a.Bx.KeyVerificationCancel,t)):this.send(a.Bx.KeyVerificationCancel,{code:"m.unknown",reason:t.body||"Unknown reason"})}}else this.send(a.Bx.KeyVerificationCancel,{code:"m.unknown",reason:e.toString()});null!==this.promise?this.reject&&this.reject(e):this.promise=Promise.reject(e),this.emit(re.Cancel,e)}}verify(){return this.promise||(this.promise=new Promise(((e,t)=>{this.resolve=(...t)=>{this._done=!0,this.endTimer(),e(...t)},this.reject=e=>{this._done=!0,this.endTimer(),t(e)}})),this.doVerification&&!this.started&&(this.started=!0,this.resetTimer(),new Promise(((e,t)=>{var s;(null===(s=this.baseApis.crypto.deviceList.getStoredCrossSigningForUser(this.userId))||void 0===s?void 0:s.getId())===this.deviceId&&t(new Error("Device ID is the same as the cross-signing ID")),e()})).then((()=>this.doVerification())).then(this.done.bind(this),this.cancel.bind(this)))),this.promise}async verifyKeys(e,t,s){const i=[];for(const[n,r]of Object.entries(t)){const t=n.split(":",2)[1],o=this.baseApis.getStoredDevice(e,t);if(o)s(n,o,r),i.push([t,n,o.keys[n]]);else{const o=this.baseApis.crypto.deviceList.getStoredCrossSigningForUser(e);o&&o.getId()===t?(s(n,h.V.fromStorage({keys:{[n]:t}},t),r),i.push([t,n,t])):c.v.warn(`verification: Could not find device ${t} to verify`)}}if(!i.length)throw new Error("No devices could be verified");c.v.info("Verification completed! Marking devices verified: ",i);for(const[t,s,n]of i)await this.baseApis.crypto.setDeviceVerification(e,t,!0,null,null,{[s]:n});e==this.baseApis.credentials.userId&&await this.baseApis.checkKeyBackup()}get events(){}getShowSasCallbacks(){return null}getReciprocateQrCodeCallbacks(){return null}}var ae=s("./node_modules/matrix-js-sdk/src/types.ts"),de=s("./node_modules/buffer/index.js").hp;const ce=ae.V.ShowQrCode,le=ae.V.ScanQrCode,ue=se.Ji;class he extends oe{constructor(...e){super(...e),(0,i.A)(this,"reciprocateQREvent",void 0),(0,i.A)(this,"doVerification",(async()=>{if(!this.startEvent)throw new Error("It is not currently possible to start verificationwith this method yet.");const{qrCodeData:e}=this.request;if(this.startEvent.getContent().secret!==(null==e?void 0:e.encodedSharedSecret))throw Z();await new Promise(((e,t)=>{this.reciprocateQREvent={confirm:e,cancel:()=>t(z())},this.emit(ue.ShowReciprocateQr,this.reciprocateQREvent)}));const t={};switch(null==e?void 0:e.mode){case me.VerifyOtherUser:{const s=e.otherUserMasterKey;t[`ed25519:${s}`]=s;break}case me.VerifySelfTrusted:{const s=this.request.targetDevice.deviceId;t[`ed25519:${s}`]=e.otherDeviceKey;break}case me.VerifySelfUntrusted:{const s=e.myMasterKey;t[`ed25519:${s}`]=s;break}}await this.verifyKeys(this.userId,t,((e,s,i)=>{const n=t[e];if(!n)throw Z();if(i!==n)throw c.v.error("key ID from key info does not match"),Z();for(const e in s.keys){if(!e.startsWith("ed25519"))continue;const i=t[e];if(!i)throw Z();if(s.keys[e]!==i)throw c.v.error("master key does not match"),Z()}}))}))}static factory(e,t,s,i,n,r){return new he(e,t,s,i,n,r)}static get NAME(){return"m.reciprocate.v1"}getReciprocateQrCodeCallbacks(){var e;return null!==(e=this.reciprocateQREvent)&&void 0!==e?e:null}}var me=function(e){return e[e.VerifyOtherUser=0]="VerifyOtherUser",e[e.VerifySelfTrusted=1]="VerifySelfTrusted",e[e.VerifySelfUntrusted=2]="VerifySelfUntrusted",e}(me||{});class pe{constructor(e,t,s,i,n,r){this.mode=e,this.sharedSecret=t,this.otherUserMasterKey=s,this.otherDeviceKey=i,this.myMasterKey=n,this.buffer=r}static async create(e,t){const s=pe.generateSharedSecret(),i=pe.determineMode(e,t);let n=null,r=null,o=null;if(i===me.VerifyOtherUser){n=t.getStoredCrossSigningForUser(e.otherUserId).getId("master")}else if(i===me.VerifySelfTrusted)r=await pe.getOtherDeviceKey(e,t);else if(i===me.VerifySelfUntrusted){const e=t.getUserId();o=t.getStoredCrossSigningForUser(e).getId("master")}const a=pe.generateQrData(e,t,i,s,n,r,o),d=pe.generateBuffer(a);return new pe(i,s,n,r,o,d)}get encodedSharedSecret(){return this.sharedSecret}getBuffer(){return this.buffer}static generateSharedSecret(){const e=new Uint8Array(11);return globalThis.crypto.getRandomValues(e),(0,g.PP)(e)}static async getOtherDeviceKey(e,t){const s=t.getUserId(),i=e.targetDevice,n=i.deviceId?t.getStoredDevice(s,i.deviceId):void 0;if(!n)throw new Error("could not find device "+(null==i?void 0:i.deviceId));return n.getFingerprint()}static determineMode(e,t){const s=t.getUserId(),i=e.otherUserId;let n=me.VerifyOtherUser;if(s===i){n=t.checkUserTrust(s).isCrossSigningVerified()?me.VerifySelfTrusted:me.VerifySelfUntrusted}return n}static generateQrData(e,t,s,i,n,r,o){const a=t.getUserId(),d={prefix:"MATRIX",version:2,mode:s,transactionId:e.channel.transactionId,firstKeyB64:"",secondKeyB64:"",secretB64:i},c=t.getStoredCrossSigningForUser(a);return s===me.VerifyOtherUser?(d.firstKeyB64=c.getId("master"),d.secondKeyB64=n):s===me.VerifySelfTrusted?(d.firstKeyB64=c.getId("master"),d.secondKeyB64=r):s===me.VerifySelfUntrusted&&(d.firstKeyB64=t.getDeviceEd25519Key(),d.secondKeyB64=o),d}static generateBuffer(e){let t=de.alloc(0);const s=e=>{const s=de.from([e]);t=de.concat([t,s])},i=(e,s,i=!0)=>{const n=de.from(e,s);i&&(e=>{const s=de.alloc(2);s.writeInt16BE(e,0),t=de.concat([t,s])})(n.byteLength),t=de.concat([t,n])},n=e=>{const s=(0,g.y4)(e),i=de.from(s);t=de.concat([t,i])};return i(e.prefix,"ascii",!1),s(e.version),s(e.mode),i(e.transactionId,"utf-8"),n(e.firstKeyB64),n(e.secondKeyB64),n(e.secretB64),t}}var ge=s("./node_modules/matrix-js-sdk/src/crypto/verification/SASDecimal.ts");const ve=a.Bx.KeyVerificationStart,fe=[a.Bx.KeyVerificationAccept,a.Bx.KeyVerificationKey,a.Bx.KeyVerificationMac];let ye;const Se=J("m.mismatched_sas","Mismatched short authentication string"),be=J("m.mismatched_commitment","Mismatched commitment"),Ee=[["","dog"],["","cat"],["","lion"],["","horse"],["","unicorn"],["","pig"],["","elephant"],["","rabbit"],["","panda"],["","rooster"],["","penguin"],["","turtle"],["","fish"],["","octopus"],["","butterfly"],["","flower"],["","tree"],["","cactus"],["","mushroom"],["","globe"],["","moon"],["","cloud"],["","fire"],["","banana"],["","apple"],["","strawberry"],["","corn"],["","pizza"],["","cake"],["","heart"],["","smiley"],["","robot"],["","hat"],["","glasses"],["","spanner"],["","santa"],["","thumbs up"],["","umbrella"],["","hourglass"],["","clock"],["","gift"],["","light bulb"],["","book"],["","pencil"],["","paperclip"],["","scissors"],["","lock"],["","key"],["","hammer"],["","telephone"],["","flag"],["","train"],["","bicycle"],["","aeroplane"],["","rocket"],["","trophy"],["","ball"],["","guitar"],["","trumpet"],["","bell"],["","anchor"],["","headphones"],["","folder"],["","pin"]];const we={decimal:ge.c,emoji:function(e){return[e[0]>>2,(3&e[0])<<4|e[1]>>4,(15&e[1])<<2|e[2]>>6,63&e[2],e[3]>>2,(3&e[3])<<4|e[4]>>4,(15&e[4])<<2|e[5]>>6].map((e=>Ee[e]))}};function Ie(e,t){const s={};for(const i of t)i in we&&(s[i]=we[i](Array.from(e)));return s}const _e={"hkdf-hmac-sha256":"calculate_mac","org.matrix.msc3783.hkdf-hmac-sha256":"calculate_mac_fixed_base64","hkdf-hmac-sha256.v2":"calculate_mac_fixed_base64","hmac-sha256":"calculate_mac_long_kdf"};function ke(e,t){return function(s,i){const n=e[_e[t]](s,i);return c.v.log("SAS calculateMAC:",t,[s,i],n),n}}const Re={"curve25519-hkdf-sha256":function(e,t,s){const i=`${e.baseApis.getUserId()}|${e.baseApis.deviceId}|${e.ourSASPubKey}|`,n=`${e.userId}|${e.deviceId}|${e.theirSASPubKey}|`,r="MATRIX_KEY_VERIFICATION_SAS|"+(e.initiatedByMe?i+n:n+i)+e.channel.transactionId;return t.generate_bytes(r,s)},curve25519:function(e,t,s){const i=`${e.baseApis.getUserId()}${e.baseApis.deviceId}`,n=`${e.userId}${e.deviceId}`,r="MATRIX_KEY_VERIFICATION_SAS"+(e.initiatedByMe?i+n:n+i)+e.channel.transactionId;return t.generate_bytes(r,s)}},Te=["curve25519-hkdf-sha256","curve25519"],Ce=["sha256"],Ae=["hkdf-hmac-sha256.v2","org.matrix.msc3783.hkdf-hmac-sha256","hkdf-hmac-sha256","hmac-sha256"],Oe=Object.keys(we),Me=new Set(Te),xe=new Set(Ce),De=new Set(Ae),Pe=new Set(Oe);function Ue(e,t){return Array.isArray(e)?e.filter((e=>t.has(e))):[]}const je=se.Ji;class Le extends oe{constructor(...e){super(...e),(0,i.A)(this,"waitingForAccept",void 0),(0,i.A)(this,"ourSASPubKey",void 0),(0,i.A)(this,"theirSASPubKey",void 0),(0,i.A)(this,"sasEvent",void 0),(0,i.A)(this,"doVerification",(async()=>{await s.g.Olm.init(),ye=ye||new s.g.Olm.Utility,await this.baseApis.downloadKeys([this.userId]);let e=!1;do{try{return this.initiatedByMe?await this.doSendVerification():await this.doRespondVerification()}catch(t){if(!(t instanceof ne))throw t;this.startEvent=t.startEvent,e=!0}}while(e)}))}static get NAME(){return ae.V.Sas}get events(){return fe}canSwitchStartEvent(e){if(e.getType()!==ve)return!1;const t=e.getContent();return(null==t?void 0:t.method)===Le.NAME&&!!this.waitingForAccept}async sendStart(){const e=this.channel.completeContent(ve,{method:Le.NAME,from_device:this.baseApis.deviceId,key_agreement_protocols:Te,hashes:Ce,message_authentication_codes:Ae,short_authentication_string:Oe});return await this.channel.sendCompleted(ve,e),e}async verifyAndCheckMAC(e,t,s,i){const n=Re[e](this,s,6),r=new Promise(((e,r)=>{this.sasEvent={sas:Ie(n,t),confirm:async()=>{try{await this.sendMAC(s,i),e()}catch(e){r(e)}},cancel:()=>r(z()),mismatch:()=>r(Se())},this.emit(je.ShowSas,this.sasEvent)})),[o]=await Promise.all([this.waitForEvent(a.Bx.KeyVerificationMac).then((e=>(this.expectedEvent=a.Bx.KeyVerificationDone,e))),r]),d=o.getContent();await this.checkMAC(s,d,i)}async doSendVerification(){let e,t;if(this.waitingForAccept=!0,e=this.startEvent?this.channel.completedContentFromEvent(this.startEvent):await this.sendStart(),!this.initiatedByMe)throw new ne(this.startEvent);try{t=await this.waitForEvent(a.Bx.KeyVerificationAccept)}finally{this.waitingForAccept=!1}let i=t.getContent();const n=Ue(i.short_authentication_string,Pe);if(!(Me.has(i.key_agreement_protocol)&&xe.has(i.hash)&&De.has(i.message_authentication_code)&&n.length))throw Y();if("string"!=typeof i.commitment)throw ee();const o=i.key_agreement_protocol,d=i.message_authentication_code,c=i.commitment,l=new s.g.Olm.SAS;try{this.ourSASPubKey=l.get_pubkey(),await this.send(a.Bx.KeyVerificationKey,{key:this.ourSASPubKey}),t=await this.waitForEvent(a.Bx.KeyVerificationKey),i=t.getContent();const s=i.key+r().stringify(e);if(ye.sha256(s)!==c)throw be();this.theirSASPubKey=i.key,l.set_their_key(i.key),await this.verifyAndCheckMAC(o,n,l,d)}finally{l.free()}}async doRespondVerification(){let e=this.channel.completedContentFromEvent(this.startEvent);const t=Ue(Te,new Set(e.key_agreement_protocols))[0],i=Ue(Ce,new Set(e.hashes))[0],n=Ue(Ae,new Set(e.message_authentication_codes))[0],o=Ue(e.short_authentication_string,Pe);if(void 0===t||void 0===i||void 0===n||!o.length)throw Y();const d=new s.g.Olm.SAS;try{const s=d.get_pubkey()+r().stringify(e);await this.send(a.Bx.KeyVerificationAccept,{key_agreement_protocol:t,hash:i,message_authentication_code:n,short_authentication_string:o,commitment:ye.sha256(s)});e=(await this.waitForEvent(a.Bx.KeyVerificationKey)).getContent(),this.theirSASPubKey=e.key,d.set_their_key(e.key),this.ourSASPubKey=d.get_pubkey(),await this.send(a.Bx.KeyVerificationKey,{key:this.ourSASPubKey}),await this.verifyAndCheckMAC(t,o,d,n)}finally{d.free()}}sendMAC(e,t){const s={},i=[],n="MATRIX_KEY_VERIFICATION_MAC"+this.baseApis.getUserId()+this.baseApis.deviceId+this.userId+this.deviceId+this.channel.transactionId,r=`ed25519:${this.baseApis.deviceId}`;s[r]=ke(e,t)(this.baseApis.getDeviceEd25519Key(),n+r),i.push(r);const o=this.baseApis.getCrossSigningId();if(o){const r=`ed25519:${o}`;s[r]=ke(e,t)(o,n+r),i.push(r)}const d=ke(e,t)(i.sort().join(","),n+"KEY_IDS");return this.send(a.Bx.KeyVerificationMac,{mac:s,keys:d})}async checkMAC(e,t,s){const i="MATRIX_KEY_VERIFICATION_MAC"+this.userId+this.deviceId+this.baseApis.getUserId()+this.baseApis.deviceId+this.channel.transactionId;if(t.keys!==ke(e,s)(Object.keys(t.mac).sort().join(","),i+"KEY_IDS"))throw Z();await this.verifyKeys(this.userId,t.mac,((t,n,r)=>{if(r!==ke(e,s)(n.keys[t],i+t))throw Z()}))}getShowSasCallbacks(){var e;return null!==(e=this.sasEvent)&&void 0!==e?e:null}}var Ne=s("./node_modules/matrix-js-sdk/src/crypto/key_passphrase.ts");const Ke="m.key.verification.",Be=Ke+"request",Fe=Ke+"start",$e=Ke+"cancel",qe=Ke+"done",Ve=Ke+"ready",Ge=se.X9.Unsent,He=se.X9.Requested,We=se.X9.Ready,Je=se.X9.Started,ze=se.X9.Cancelled,Qe=se.X9.Done;class Ye extends k.X{constructor(e,t,s){super(),(0,i.A)(this,"eventsByUs",new Map),(0,i.A)(this,"eventsByThem",new Map),(0,i.A)(this,"_observeOnly",!1),(0,i.A)(this,"timeoutTimer",null),(0,i.A)(this,"_accepting",!1),(0,i.A)(this,"_declining",!1),(0,i.A)(this,"verifierHasFinished",!1),(0,i.A)(this,"_cancelled",!1),(0,i.A)(this,"_chosenMethod",null),(0,i.A)(this,"_qrCodeData",null),(0,i.A)(this,"requestReceivedAt",null),(0,i.A)(this,"commonMethods",[]),(0,i.A)(this,"_phase",void 0),(0,i.A)(this,"_cancellingUserId",void 0),(0,i.A)(this,"_verifier",void 0),(0,i.A)(this,"cancelOnTimeout",(async()=>{try{this.initiatedByMe?await this.cancel({reason:"Other party didn't accept in time",code:"m.timeout"}):await this.cancel({reason:"User didn't accept in time",code:"m.timeout"})}catch(e){c.v.error("Error while cancelling verification request",e)}})),this.channel=e,this.verificationMethods=t,this.client=s,this.channel.request=this,this.setPhase(Ge,!1)}static validateEvent(e,t,s){const i=t.getContent();return!(!e||!e.startsWith(Ke))&&(i?e!==Be&&e!==Ve||Array.isArray(i.methods)?e!==Be&&e!==Ve&&e!==Fe||"string"==typeof i.from_device&&0!==i.from_device.length||(c.v.log("VerificationRequest: validateEvent: fail because from_device"),!1):(c.v.log("VerificationRequest: validateEvent: fail because methods"),!1):(c.v.log("VerificationRequest: validateEvent: no content"),!1))}get transactionId(){return this.channel.transactionId}get roomId(){return this.channel.roomId}get invalid(){return this.phase===Ge}get requested(){return this.phase===He}get cancelled(){return this.phase===ze}get ready(){return this.phase===We}get started(){return this.phase===Je}get done(){return this.phase===Qe}get methods(){return this.commonMethods}get chosenMethod(){return this._chosenMethod}calculateEventTimeout(e){let t=this.channel.getTimestamp(e)+6e5;if(this.requestReceivedAt&&!this.initiatedByMe&&this.phase<=He){const e=this.requestReceivedAt+12e4;t=Math.min(t,e)}return Math.max(0,t-Date.now())}get timeout(){const e=this.getEventByEither(Be);return e?this.calculateEventTimeout(e):0}get requestEvent(){return this.getEventByEither(Be)}get phase(){return this._phase}get verifier(){return this._verifier}get canAccept(){return(0,se.Dy)(this)}get accepting(){return this._accepting}get declining(){return this._declining}get pending(){return!this.observeOnly&&this._phase!==Qe&&this._phase!==ze}get qrCodeData(){return this._qrCodeData}getQRCodeBytes(){var e;return null===(e=this._qrCodeData)||void 0===e?void 0:e.getBuffer()}async generateQRCode(){return this.getQRCodeBytes()}otherPartySupportsMethod(e,t=!1){if(!t&&!this.ready&&!this.started)return!1;const s=this.eventsByThem.get(Be)||this.eventsByThem.get(Ve);if(!s){if(this.started&&this.initiatedByMe){const t=this.eventsByUs.get(Fe),s=t&&t.getContent();return e==(s&&s.method)}return!1}const i=s.getContent();if(!i)return!1;const{methods:n}=i;return!!Array.isArray(n)&&n.includes(e)}get initiatedByMe(){const e=this.eventsByUs.size+this.eventsByThem.size===0;if(this._phase===Ge&&e)return!0;const t=this.eventsByUs.has(Be),s=this.eventsByThem.has(Be);if(t&&!s)return!0;if(!t&&s)return!1;const i=this.eventsByUs.has(Fe),n=this.eventsByThem.has(Fe);return!(!i||n)}get requestingUserId(){return this.initiatedByMe?this.client.getUserId():this.otherUserId}get receivingUserId(){return this.initiatedByMe?this.otherUserId:this.client.getUserId()}get otherUserId(){return this.channel.userId}get otherDeviceId(){return this.channel.deviceId}get isSelfVerification(){return this.client.getUserId()===this.otherUserId}get cancellingUserId(){const e=this.eventsByUs.get($e),t=this.eventsByThem.get($e);return e&&(!t||e.getId()<t.getId())?e.getSender():t?t.getSender():void 0}get cancellationCode(){const e=this.getEventByEither($e);return e?e.getContent().code:null}get observeOnly(){return this._observeOnly}get targetDevice(){const e=this.eventsByThem.get(Be)||this.eventsByThem.get(Ve)||this.eventsByThem.get(Fe),t=null==e?void 0:e.getContent(),s=null==t?void 0:t.from_device;return{userId:this.otherUserId,deviceId:s}}beginKeyVerification(e,t=null){if(!this.observeOnly&&!this._verifier){if(this.phase===He||this.phase===We||this.phase===Ge&&this.channel.canCreateRequest(Fe)){if(this.commonMethods.length&&!this.commonMethods.includes(e))throw Y();if(this._verifier=this.createVerifier(e,null,t),!this._verifier)throw Y();this._chosenMethod=e}}return this._verifier}async startVerification(e){const t=this.beginKeyVerification(e);return t.verify(),t}scanQRCode(e){throw new Error("QR code scanning not supported by legacy crypto")}async sendRequest(){if(!this.observeOnly&&this._phase===Ge){const e=[...this.verificationMethods.keys()];await this.channel.send(Be,{methods:e})}}async cancel({reason:e="User declined",code:t="m.user"}={}){if(!this.observeOnly&&this._phase!==ze){if(this._declining=!0,this.emit(se.FM.Change),this._verifier)return this._verifier.cancel(J(t,e)());this._cancellingUserId=this.client.getUserId(),await this.channel.send($e,{code:t,reason:e})}}async accept(){if(!this.observeOnly&&this.phase===He&&!this.initiatedByMe){const e=[...this.verificationMethods.keys()];this._accepting=!0,this.emit(se.FM.Change),await this.channel.send(Ve,{methods:e})}}waitFor(e){return new Promise(((t,s)=>{const i=()=>{let n=!1;return e(this)?(t(this),n=!0):this.cancelled&&(s(new Error("cancelled")),n=!0),n&&this.off(se.FM.Change,i),n};i()||this.on(se.FM.Change,i)}))}setPhase(e,t=!0){this._phase=e,t&&this.emit(se.FM.Change)}getEventByEither(e){return this.eventsByThem.get(e)||this.eventsByUs.get(e)}getEventBy(e,t=!1){return t?this.eventsByThem.get(e):this.eventsByUs.get(e)}calculatePhaseTransitions(){const e=[{phase:Ge}],t=()=>e[e.length-1].phase,s=this.eventsByThem.has(Be),i=this.getEventBy(Be,s);i&&e.push({phase:He,event:i});const n=i&&this.getEventBy(Ve,!s);let r;if(n&&t()===He&&e.push({phase:We,event:n}),n||!i){const e=this.eventsByThem.get(Fe),t=this.eventsByUs.get(Fe);r=e&&t?e.getSender()<t.getSender()?e:t:e||t}else r=this.getEventBy(Fe,!s);if(r){const s=t()===He&&(null==i?void 0:i.getSender())!==r.getSender(),n=t()===Ge&&this.channel.canCreateRequest(Fe);(s||t()===We||n)&&e.push({phase:Je,event:r})}const o=this.eventsByUs.get(qe);(this.verifierHasFinished||o&&t()===Je)&&e.push({phase:Qe});const a=this.getEventByEither($e);return(this._cancelled||a)&&t()!==Qe?(e.push({phase:ze,event:a}),e):e}transitionToPhase(e){const{phase:t,event:s}=e;if((t===He||t===We)&&!this.wasSentByOwnDevice(s)){const e=s.getContent();this.commonMethods=e.methods.filter((e=>this.verificationMethods.has(e)))}if(this.observeOnly||t!==He&&t!==Je&&t!==We||this.channel.receiveStartFromOtherDevices&&this.wasSentByOwnUser(s)&&!this.wasSentByOwnDevice(s)&&(this._observeOnly=!0),t===Je){const{method:e}=s.getContent();this._verifier||this.observeOnly||(this._verifier=this.createVerifier(e,s),this._verifier?this._chosenMethod=e:this.cancel({code:"m.unknown_method",reason:`Unknown method: ${e}`}))}}applyPhaseTransitions(){const e=this.calculatePhaseTransitions(),t=e.findIndex((e=>e.phase===this.phase)),s=e.slice(t+1);for(const e of s)this.transitionToPhase(e);return s}isWinningStartRace(e){if(e.getType()!==Fe)return!1;const t=this._verifier.startEvent;let s,i;if(this.isSelfVerification)if(t){const e=t.getContent();s=e&&e.from_device}else s=this.client.getDeviceId();else s=t?t.getSender():this.client.getUserId();if(this.isSelfVerification){const t=e.getContent();i=t&&t.from_device}else i=e.getSender();return i<s}hasEventId(e){for(const t of this.eventsByUs.values())if(t.getId()===e)return!0;for(const t of this.eventsByThem.values())if(t.getId()===e)return!0;return!1}async handleEvent(e,t,s,i,n){if(this.done||this.cancelled)return;const r=this._observeOnly;if(this.adjustObserveOnly(t,s),!this.observeOnly&&!i&&await this.cancelOnError(e,t))return;if(n?this.eventsByUs.has(e):this.eventsByThem.has(e))return;const o=this.phase;this.addEvent(e,t,n);const a=this.applyPhaseTransitions();try{if(this._verifier&&!this.observeOnly){const s=this.isWinningStartRace(t);if(this._verifier.canSwitchStartEvent(t)&&s)this._verifier.switchStartEvent(t);else if(!i){var d;(e===$e||null!==(d=this._verifier.events)&&void 0!==d&&d.includes(e))&&this._verifier.handleEvent(t)}}if(a.length){if(s&&a.some((e=>e.phase===We))){this.otherPartySupportsMethod(le,!0)&&(this._qrCodeData=await pe.create(this,this.client))}const e=a[a.length-1],{phase:t}=e;this.setupTimeout(t),this.setPhase(t)}else this._observeOnly!==r&&this.emit(se.FM.Change)}finally{c.v.log(`Verification request ${this.channel.transactionId}: ${e} event with id:${t.getId()}, content:${JSON.stringify(t.getContent())} deviceId:${this.channel.deviceId}, sender:${t.getSender()}, isSentByUs:${n}, isLiveEvent:${s}, isRemoteEcho:${i}, phase:${o}=>${this.phase}, observeOnly:${r}=>${this._observeOnly}`)}}setupTimeout(e){if(!this.timeoutTimer&&!this.observeOnly&&e===He&&(this.timeoutTimer=setTimeout(this.cancelOnTimeout,this.timeout)),this.timeoutTimer){(e===Je||e===We||e===Qe||e===ze)&&(clearTimeout(this.timeoutTimer),this.timeoutTimer=null)}}async cancelOnError(e,t){if(e===Fe){const e=t.getContent().method;if(!this.verificationMethods.has(e))return await this.cancel(te(Y())),!0}const s=e===Be&&this.phase!==Ge,i=e===Ve&&this.phase!==He&&this.phase!==Je;if(this.phase!==Ge&&(s||i)){c.v.warn(`Cancelling, unexpected ${e} verification event from ${t.getSender()}`);const s=`Unexpected ${e} event in phase ${this.phase}`;return await this.cancel(te(X({reason:s}))),!0}return!1}adjustObserveOnly(e,t=!1){t||(this._observeOnly=!0),this.calculateEventTimeout(e)<3e3&&(this._observeOnly=!0)}addEvent(e,t,s=!1){if(s?this.eventsByUs.set(e,t):this.eventsByThem.set(e,t),e===Be){for(const[e,t]of this.eventsByThem.entries())t.getSender()!==this.otherUserId&&this.eventsByThem.delete(e);this.requestReceivedAt=Date.now()}}createVerifier(e,t=null,s=null){s||(s=this.targetDevice);const{userId:i,deviceId:n}=s,r=this.verificationMethods.get(e);if(r)return new r(this.channel,this.client,i,n,t,this);c.v.warn("could not find verifier constructor for method",e)}wasSentByOwnUser(e){return(null==e?void 0:e.getSender())===this.client.getUserId()}wasSentByOwnDevice(e){if(!this.wasSentByOwnUser(e))return!1;const t=e.getContent();return!(!t||t.from_device!==this.client.getDeviceId())}onVerifierCancelled(){this._cancelled=!0;const e=this.applyPhaseTransitions();e.length&&this.setPhase(e[e.length-1].phase)}onVerifierFinished(){this.channel.send(a.Bx.KeyVerificationDone,{}),this.verifierHasFinished=!0;const e=this.applyPhaseTransitions();e.length&&this.setPhase(e[e.length-1].phase)}getEventFromOtherParty(e){return this.eventsByThem.get(e)}}const Xe=a.Bx.RoomMessage,Ze="m.reference",et="m.relates_to";class tt{constructor(e,t,s){(0,i.A)(this,"requestEventId",void 0),this.client=e,this.roomId=t,this.userId=s}get receiveStartFromOtherDevices(){return!0}get transactionId(){return this.requestEventId}static getOtherPartyUserId(e,t){if(tt.getEventType(e)!==Be)return;const s=t.getUserId(),i=e.getSender(),n=e.getContent().to;return i===s?n:n===s?i:void 0}getTimestamp(e){return e.getTs()}static canCreateRequest(e){return e===Be}canCreateRequest(e){return tt.canCreateRequest(e)}static getTransactionId(e){if(tt.getEventType(e)===Be)return e.getId();{const t=e.getRelation();if((null==t?void 0:t.rel_type)===Ze)return t.event_id}}static validateEvent(e,t){const s=tt.getTransactionId(e);if("string"!=typeof s||0===s.length)return!1;const i=tt.getEventType(e),n=e.getContent();if(i===Be){if(!n||"string"!=typeof n.to||!n.to.length)return c.v.log("InRoomChannel: validateEvent: no valid to "+n.to),!1;if(!tt.getOtherPartyUserId(e,t))return c.v.log(`InRoomChannel: validateEvent: not directed to or sent by me: ${e.getSender()}, ${n.to}`),!1}return Ye.validateEvent(i,e,t)}static getEventType(e){const t=e.getType();if(t===Xe){const t=e.getContent();if(t){const{msgtype:e}=t;if(e===Be)return Be}}return t&&t!==Be?t:""}async handleEvent(e,t,s=!1){if(t.hasEventId(e.getId()))return;const i=tt.getEventType(e);if(e.getRoomId()!==this.roomId)return;if(!this.userId){const t=tt.getOtherPartyUserId(e,this.client);t&&(this.userId=t)}const n=this.client.getUserId(),r=e.getSender();if(this.userId&&r!==n&&r!==this.userId)return void c.v.log(`InRoomChannel: ignoring verification event from non-participating sender ${r}`);this.requestEventId||(this.requestEventId=tt.getTransactionId(e));const o=!!e.getTxnId(),a=!!e.getUnsigned().transaction_id,d=e.getSender()===this.client.getUserId();return t.handleEvent(i,e,s,o||a,d)}completedContentFromEvent(e){const t=Object.assign({},e.getContent());return t[et]=e.getRelation(),t}completeContent(e,t){return t=Object.assign({},t),e!==Be&&e!==Ve&&e!==Fe||(t.from_device=this.client.getDeviceId()),e===Be?t={body:this.client.getUserId()+" is requesting to verify your key, but your client does not support in-chat key verification.  You will need to use legacy key verification to verify keys.",msgtype:Be,to:this.userId,from_device:t.from_device,methods:t.methods}:t[et]={rel_type:Ze,event_id:this.transactionId},t}send(e,t){const s=this.completeContent(e,t);return this.sendCompleted(e,s)}async sendCompleted(e,t){let s=e;e===Be&&(s=Xe);const i=await this.client.sendEvent(this.roomId,s,t);e===Be&&(this.requestEventId=i.event_id)}}class st{constructor(){(0,i.A)(this,"requestsByRoomId",new Map)}getRequest(e){const t=e.getRoomId(),s=tt.getTransactionId(e);return this.getRequestByTxnId(t,s)}getRequestByChannel(e){return this.getRequestByTxnId(e.roomId,e.transactionId)}getRequestByTxnId(e,t){const s=this.requestsByRoomId.get(e);if(s)return s.get(t)}setRequest(e,t){this.doSetRequest(e.getRoomId(),tt.getTransactionId(e),t)}setRequestByChannel(e,t){this.doSetRequest(e.roomId,e.transactionId,t)}doSetRequest(e,t,s){let i=this.requestsByRoomId.get(e);i||(i=new Map,this.requestsByRoomId.set(e,i)),i.set(t,s)}removeRequest(e){const t=e.getRoomId(),s=this.requestsByRoomId.get(t);s&&(s.delete(tt.getTransactionId(e)),0===s.size&&this.requestsByRoomId.delete(t))}findRequestInProgress(e,t){const s=this.requestsByRoomId.get(e);if(s)for(const e of s.values())if(e.pending&&(void 0===t||e.requestingUserId===t))return e}}var it=s("./node_modules/matrix-js-sdk/src/randomstring.ts");class nt{constructor(e,t,s,n,r){(0,i.A)(this,"request",void 0),this.client=e,this.userId=t,this.devices=s,this.transactionId=n,this.deviceId=r}isToDevices(e){if(e.length===this.devices.length){for(const t of e)if(!this.devices.includes(t))return!1;return!0}return!1}static getEventType(e){return e.getType()}static getTransactionId(e){const t=e.getContent();return t&&t.transaction_id}static canCreateRequest(e){return e===Be||e===Fe}canCreateRequest(e){return nt.canCreateRequest(e)}static validateEvent(e,t){if(e.isCancelled())return c.v.warn("Ignoring flagged verification request from "+e.getSender()),!1;const s=e.getContent();if(!s)return c.v.warn("ToDeviceChannel.validateEvent: invalid: no content"),!1;if(!s.transaction_id)return c.v.warn("ToDeviceChannel.validateEvent: invalid: no transaction_id"),!1;const i=e.getType();if(i===Be){if(!Number.isFinite(s.timestamp))return c.v.warn("ToDeviceChannel.validateEvent: invalid: no timestamp"),!1;if(e.getSender()===t.getUserId()&&s.from_device==t.getDeviceId())return c.v.warn("ToDeviceChannel.validateEvent: invalid: from own device"),!1}return Ye.validateEvent(i,e,t)}getTimestamp(e){const t=e.getContent();return t&&t.timestamp}async handleEvent(e,t,s=!1){const i=e.getType(),n=e.getContent();if(i===Be||i===Ve||i===Fe){this.transactionId||(this.transactionId=n.transaction_id);const e=n.from_device;if(!this.deviceId&&this.devices.includes(e)&&(this.deviceId=e),!this.deviceId||this.deviceId!==e){const t=this.completeContent($e,te(X()));return this.sendToDevices($e,t,[e])}}const r=t.phase===Je||t.phase===We;await t.handleEvent(e.getType(),e,s,!1,!1);const o=t.phase===Je||t.phase===We;if((i===Fe||i===Ve)&&!r&&o&&this.deviceId){const e=this.devices.filter((e=>e!==this.deviceId&&e!==this.client.getDeviceId()));if(e.length){const t=this.completeContent($e,{code:"m.accepted",reason:"Verification request accepted by another device"});await this.sendToDevices($e,t,e)}}}completedContentFromEvent(e){return e.getContent()}completeContent(e,t){return t=Object.assign({},t),this.transactionId&&(t.transaction_id=this.transactionId),e!==Be&&e!==Ve&&e!==Fe||(t.from_device=this.client.getDeviceId()),e===Be&&(t.timestamp=Date.now()),t}send(e,t={}){e!==Be&&e!==Fe||this.transactionId||(this.transactionId=nt.makeTransactionId());const s=this.completeContent(e,t);return this.sendCompleted(e,s)}async sendCompleted(e,t){let s;s=e===Be||e===$e&&!this.deviceId?await this.sendToDevices(e,t,this.devices):await this.sendToDevices(e,t,[this.deviceId]);const i=new U.kl({sender:this.client.getUserId(),content:t,type:e});return await this.request.handleEvent(e,i,!0,!0,!0),s}async sendToDevices(e,t,s){if(s.length){const i=new Map;for(const e of s)i.set(e,t);await this.client.sendToDevice(e,new Map([[this.userId,i]]))}}static makeTransactionId(){return(0,it.DU)(32)}}class rt{constructor(){(0,i.A)(this,"requestsByUserId",new Map)}getRequest(e){return this.getRequestBySenderAndTxnId(e.getSender(),nt.getTransactionId(e))}getRequestByChannel(e){return this.getRequestBySenderAndTxnId(e.userId,e.transactionId)}getRequestBySenderAndTxnId(e,t){const s=this.requestsByUserId.get(e);if(s)return s.get(t)}setRequest(e,t){this.setRequestBySenderAndTxnId(e.getSender(),nt.getTransactionId(e),t)}setRequestByChannel(e,t){this.setRequestBySenderAndTxnId(e.userId,e.transactionId,t)}setRequestBySenderAndTxnId(e,t,s){let i=this.requestsByUserId.get(e);i||(i=new Map,this.requestsByUserId.set(e,i)),i.set(t,s)}removeRequest(e){const t=e.getSender(),s=this.requestsByUserId.get(t);s&&(s.delete(nt.getTransactionId(e)),0===s.size&&this.requestsByUserId.delete(t))}findRequestInProgress(e,t){const s=this.requestsByUserId.get(e);if(s)for(const e of s.values())if(e.pending&&e.channel.isToDevices(t))return e}getRequestsInProgress(e){const t=this.requestsByUserId.get(e);return t?Array.from(t.values()).filter((e=>e.pending)):[]}}class ot extends oe{constructor(...e){super(...e),(0,i.A)(this,"doVerification",(async()=>{throw new Error("Verification is not possible with this method")}))}static factory(e,t,s,i,n,r){return new ot(e,t,s,i,n,r)}static get NAME(){return"org.matrix.illegal_method"}}var at=s("./node_modules/matrix-js-sdk/src/errors.ts"),dt=s("./node_modules/matrix-js-sdk/src/crypto/dehydration.ts"),ct=s("./node_modules/matrix-js-sdk/src/crypto/backup.ts"),lt=s("./node_modules/matrix-js-sdk/src/models/room.ts"),ut=s("./node_modules/matrix-js-sdk/src/models/room-member.ts");class ht{constructor(e){(0,i.A)(this,"roomEncryption",{}),this.cryptoStore=e}async init(){await this.cryptoStore.doTxn("readwrite",[m.y.STORE_ROOMS],(e=>{this.cryptoStore.getEndToEndRooms(e,(e=>{this.roomEncryption=e}))}))}getRoomEncryption(e){return this.roomEncryption[e]||null}isRoomEncrypted(e){return Boolean(this.getRoomEncryption(e))}async setRoomEncryption(e,t){this.roomEncryption[e]=t,await this.cryptoStore.doTxn("readwrite",[m.y.STORE_ROOMS],(s=>{this.cryptoStore.storeEndToEndRoom(e,t,s)}))}}var mt=s("./node_modules/matrix-js-sdk/src/models/room-state.ts"),pt=s("./node_modules/matrix-js-sdk/src/models/device.ts");function gt(e,t){const s=new Map(Object.entries(e.keys)),i=e.getDisplayName()||void 0,n=new Map;if(e.signatures)for(const t in e.signatures)n.set(t,new Map(Object.entries(e.signatures[t])));return new pt.p({deviceId:e.deviceId,userId:t,keys:s,algorithms:e.algorithms,verified:e.verified,signatures:n,displayName:i})}var vt=s("./node_modules/matrix-js-sdk/src/@types/membership.ts"),ft=s("./node_modules/buffer/index.js").hp;function yt(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}const St=h.V.DeviceVerification,bt={[he.NAME]:he,[Le.NAME]:Le,[ce]:ot,[le]:ot};function Et(){return Boolean(globalThis.Olm)}let wt=function(e){return e.DeviceVerificationChanged="deviceVerificationChanged",e.UserTrustStatusChanged="userTrustStatusChanged",e.UserCrossSigningUpdated="userCrossSigningUpdated",e.RoomKeyRequest="crypto.roomKeyRequest",e.RoomKeyRequestCancellation="crypto.roomKeyRequestCancellation",e.KeyBackupStatus="crypto.keyBackupStatus",e.KeyBackupFailed="crypto.keyBackupFailed",e.KeyBackupSessionsRemaining="crypto.keyBackupSessionsRemaining",e.KeyBackupDecryptionKeyCached="crypto.keyBackupDecryptionKeyCached",e.KeySignatureUploadFailure="crypto.keySignatureUploadFailure",e.VerificationRequest="crypto.verification.request",e.VerificationRequestReceived="crypto.verificationRequestReceived",e.Warning="crypto.warning",e.WillUpdateDevices="crypto.willUpdateDevices",e.DevicesUpdated="crypto.devicesUpdated",e.KeysChanged="crossSigning.keysChanged",e.LegacyCryptoStoreMigrationProgress="crypto.legacyCryptoStoreMigrationProgress",e}({});class It extends k.X{static getOlmVersion(){return l.FL.getOlmVersion()}constructor(e,t,s,n,r,o){if(super(),(0,i.A)(this,"backupManager",void 0),(0,i.A)(this,"crossSigningInfo",void 0),(0,i.A)(this,"olmDevice",void 0),(0,i.A)(this,"deviceList",void 0),(0,i.A)(this,"dehydrationManager",void 0),(0,i.A)(this,"secretStorage",void 0),(0,i.A)(this,"roomList",void 0),(0,i.A)(this,"reEmitter",void 0),(0,i.A)(this,"verificationMethods",void 0),(0,i.A)(this,"supportedAlgorithms",void 0),(0,i.A)(this,"outgoingRoomKeyRequestManager",void 0),(0,i.A)(this,"toDeviceVerificationRequests",void 0),(0,i.A)(this,"inRoomVerificationRequests",void 0),(0,i.A)(this,"trustCrossSignedDevices",!0),(0,i.A)(this,"lastOneTimeKeyCheck",null),(0,i.A)(this,"oneTimeKeyCheckInProgress",!1),(0,i.A)(this,"roomEncryptors",new Map),(0,i.A)(this,"roomDecryptors",new Map),(0,i.A)(this,"deviceKeys",{}),(0,i.A)(this,"globalBlacklistUnverifiedDevices",!1),(0,i.A)(this,"globalErrorOnUnknownDevices",!0),(0,i.A)(this,"receivedRoomKeyRequests",[]),(0,i.A)(this,"receivedRoomKeyRequestCancellations",[]),(0,i.A)(this,"processingRoomKeyRequests",!1),(0,i.A)(this,"lazyLoadMembers",!1),(0,i.A)(this,"roomDeviceTrackingState",{}),(0,i.A)(this,"forceNewSessionRetryTime",new _.kG((()=>new _.kG((()=>0))))),(0,i.A)(this,"sendKeyRequestsImmediately",!1),(0,i.A)(this,"oneTimeKeyCount",void 0),(0,i.A)(this,"needsNewFallback",void 0),(0,i.A)(this,"fallbackCleanup",void 0),(0,i.A)(this,"onDeviceListUserCrossSigningUpdated",(async e=>{if(e===this.userId){const t=this.deviceList.getStoredCrossSigningForUser(e),s=t?t.getId():null,i=this.crossSigningInfo.getId();i&&s&&!(i!==s)?await this.checkOwnCrossSigningTrust():(this.storeTrustedSelfKeys(null),this.emit(wt.KeysChanged,{}),this.emit(wt.UserTrustStatusChanged,this.userId,this.checkUserTrust(e)))}else{await this.checkDeviceVerifications(e);const t=this.deviceList.getStoredCrossSigningForUser(e);t&&(t.updateCrossSigningVerifiedBefore(this.checkUserTrust(e).isCrossSigningVerified()),this.deviceList.setRawStoredCrossSigningForUser(e,t.toStorage())),this.emit(wt.UserTrustStatusChanged,e,this.checkUserTrust(e))}})),(0,i.A)(this,"onMembership",((e,t,s)=>{try{this.onRoomMembership(e,t,s)}catch(e){c.v.error("Error handling membership change:",e)}})),(0,i.A)(this,"onToDeviceEvent",(e=>{try{c.v.log(`received to-device ${e.getType()} from: ${e.getSender()} id: ${e.getContent()[a.wt]}`),"m.room_key"==e.getType()||"m.forwarded_room_key"==e.getType()?this.onRoomKeyEvent(e):"m.room_key_request"==e.getType()?this.onRoomKeyRequestEvent(e):"m.secret.request"===e.getType()?this.secretStorage.onRequestReceived(e):"m.secret.send"===e.getType()?this.secretStorage.onSecretReceived(e):"m.room_key.withheld"===e.getType()?this.onRoomKeyWithheldEvent(e):e.getContent().transaction_id?this.onKeyVerificationMessage(e):"m.bad.encrypted"===e.getContent().msgtype?this.onToDeviceBadEncrypted(e):(e.isBeingDecrypted()||e.shouldAttemptDecryption())&&(e.isBeingDecrypted()||e.attemptDecryption(this),e.once(U.OQ.Decrypted,(e=>{this.onToDeviceEvent(e)})))}catch(e){c.v.error("Error handling toDeviceEvent:",e)}})),(0,i.A)(this,"onTimelineEvent",((e,t,s,i,{liveEvent:n=!0}={})=>{if(!tt.validateEvent(e,this.baseApis))return;this.handleVerificationEvent(e,this.inRoomVerificationRequests,(e=>{const t=new tt(this.baseApis,e.getRoomId());return new Ye(t,this.verificationMethods,this.baseApis)}),n)})),this.baseApis=e,this.userId=t,this.deviceId=s,this.clientStore=n,this.cryptoStore=r,c.v.debug("Crypto: initialising roomlist..."),this.roomList=new ht(r),this.reEmitter=new d.Q(this),o){this.verificationMethods=new Map;for(const e of o)"string"==typeof e?bt[e]&&this.verificationMethods.set(e,bt[e]):e.NAME?this.verificationMethods.set(e.NAME,e):c.v.warn(`Excluding unknown verification method ${e}`)}else this.verificationMethods=new Map(Object.entries(bt));this.backupManager=new ct.IO(e,(async()=>{const e=await this.getSessionBackupPrivateKey();if(e)return e;const t=await this.secretStorage.get("m.megolm_backup.v1");if(t){const e=_t(t);if(e){const t=await this.secretStorage.getKey();await this.secretStorage.store("m.megolm_backup.v1",e,[t[0]])}return(0,g.y4)(e||t)}if(this.baseApis.cryptoCallbacks&&this.baseApis.cryptoCallbacks.getBackupKey)return this.baseApis.cryptoCallbacks.getBackupKey();throw new Error("Unable to get private key")})),this.olmDevice=new l.FL(r),this.deviceList=new T(e,r,this.olmDevice),this.deviceList.on(wt.UserCrossSigningUpdated,this.onDeviceListUserCrossSigningUpdated),this.reEmitter.reEmit(this.deviceList,[wt.DevicesUpdated,wt.WillUpdateDevices]),this.supportedAlgorithms=Array.from(O.Jn.keys()),this.outgoingRoomKeyRequestManager=new W.z(e,this.deviceId,this.cryptoStore),this.toDeviceVerificationRequests=new rt,this.inRoomVerificationRequests=new st;const u=this.baseApis.cryptoCallbacks||{},h=I(r,this.olmDevice);this.crossSigningInfo=new b(t,u,h),this.secretStorage=new G(e,u,e),this.dehydrationManager=new dt.v(this),!u.getCrossSigningKey&&u.getSecretStorageKey&&(u.getCrossSigningKey=async e=>b.getFromSecretStorage(e,this.secretStorage))}async init({exportedOlmDevice:e,pickleKey:t}={}){c.v.log("Crypto: initialising Olm..."),await s.g.Olm.init(),c.v.log(e?"Crypto: initialising Olm device from exported device...":"Crypto: initialising Olm device..."),await this.olmDevice.init({fromExportedDevice:e,pickleKey:t}),c.v.log("Crypto: loading device list..."),await this.deviceList.load(),this.deviceKeys["ed25519:"+this.deviceId]=this.olmDevice.deviceEd25519Key,this.deviceKeys["curve25519:"+this.deviceId]=this.olmDevice.deviceCurve25519Key,c.v.log("Crypto: fetching own devices...");let i=this.deviceList.getRawStoredDevicesForUser(this.userId);if(i||(i={}),!i[this.deviceId]){c.v.log("Crypto: adding this device to the store...");const e={keys:this.deviceKeys,algorithms:this.supportedAlgorithms,verified:St.VERIFIED,known:!0};i[this.deviceId]=e,this.deviceList.storeDevicesForUser(this.userId,i),this.deviceList.saveIfDirty()}await this.cryptoStore.doTxn("readonly",[m.y.STORE_ACCOUNT],(e=>{this.cryptoStore.getCrossSigningKeys(e,(e=>{e&&0!==Object.keys(e).length&&(c.v.log("Loaded cross-signing public keys from crypto store"),this.crossSigningInfo.setKeys(e))}))})),this.deviceList.startTrackingDeviceList(this.userId),c.v.debug("Crypto: initialising roomlist..."),await this.roomList.init(),c.v.log("Crypto: checking for key backup..."),this.backupManager.checkAndStart()}setDeviceIsolationMode(e){throw new Error("Not supported")}getVersion(){const e=It.getOlmVersion();return`Olm ${e[0]}.${e[1]}.${e[2]}`}getTrustCrossSignedDevices(){return this.trustCrossSignedDevices}getCryptoTrustCrossSignedDevices(){return this.trustCrossSignedDevices}setTrustCrossSignedDevices(e){this.trustCrossSignedDevices=e;for(const e of this.deviceList.getKnownUserIds()){const t=this.deviceList.getRawStoredDevicesForUser(e);for(const s of Object.keys(t)){const t=this.checkDeviceTrust(e,s);if(!t.isLocallyVerified()&&t.isCrossSigningVerified()){const t=this.deviceList.getStoredDevice(e,s);this.emit(wt.DeviceVerificationChanged,e,s,t)}}}}setCryptoTrustCrossSignedDevices(e){this.setTrustCrossSignedDevices(e)}async createRecoveryKeyFromPassphrase(e){const t=new s.g.Olm.PkDecryption;try{if(e){const s=await(0,Ne.SM)(e);t.init_with_private_key(s.key);const i=t.get_private_key();return{keyInfo:{passphrase:{algorithm:"m.pbkdf2",iterations:s.iterations,salt:s.salt}},privateKey:i,encodedPrivateKey:(0,p.encodeRecoveryKey)(i)}}{t.generate_key();const e=t.get_private_key();return{privateKey:e,encodedPrivateKey:(0,p.encodeRecoveryKey)(e)}}}finally{null==t||t.free()}}async userHasCrossSigningKeys(e=this.userId){return await this.downloadKeys([e]),null!==this.deviceList.getStoredCrossSigningForUser(e)}async isCrossSigningReady(){const e=this.crossSigningInfo.getId(),t=await this.crossSigningInfo.isStoredInKeyCache()||await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage);return!(!e||!t)}async isSecretStorageReady(){const e=await this.secretStorage.hasKey(),t=await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage),s=!this.backupManager.getKeyBackupEnabled()||await this.baseApis.isKeyBackupKeyStored();return!!(e&&t&&s)}async getCrossSigningStatus(){var e,t,s;const i=Boolean(this.crossSigningInfo.getId()),n=Boolean(await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage)),r=this.crossSigningInfo.getCacheCallbacks();return{publicKeysOnDevice:i,privateKeysInSecretStorage:n,privateKeysCachedLocally:{masterKey:Boolean(await(null===(e=r.getCrossSigningKeyCache)||void 0===e?void 0:e.call(r,"master"))),selfSigningKey:Boolean(await(null===(t=r.getCrossSigningKeyCache)||void 0===t?void 0:t.call(r,"self_signing"))),userSigningKey:Boolean(await(null===(s=r.getCrossSigningKeyCache)||void 0===s?void 0:s.call(r,"user_signing")))}}}async bootstrapCrossSigning({authUploadDeviceSigningKeys:e,setupNewCrossSigning:t}={}){c.v.log("Bootstrapping cross-signing");const s=this.baseApis.cryptoCallbacks,i=new N(this.baseApis.store.accountData,s),n=new b(this.userId,i.crossSigningCallbacks,i.crossSigningCallbacks),r=async()=>{n.resetKeys(),await this.signObject(n.keys.master),i.addCrossSigningKeys(e,n.keys);const t=this.deviceList.getStoredDevice(this.userId,this.deviceId),s=await n.signDevice(this.userId,t);i.addKeySignature(this.userId,this.deviceId,s),this.backupManager.backupInfo&&(await n.signObject(this.backupManager.backupInfo.auth_data,"master"),i.addSessionBackup(this.backupManager.backupInfo))},o=this.crossSigningInfo.getId(),a=await this.crossSigningInfo.isStoredInKeyCache(),d=await this.crossSigningInfo.isStoredInSecretStorage(this.secretStorage),l=a||d;c.v.log({setupNewCrossSigning:t,publicKeysOnDevice:o,privateKeysInCache:a,privateKeysInStorage:d,privateKeysExistSomewhere:l}),!l||t?(c.v.log("Cross-signing private keys not found locally or in secret storage, creating new keys"),await r()):o&&a?c.v.log("Cross-signing public keys trusted and private keys found locally"):d&&(c.v.log("Cross-signing private keys not found locally, but they are available in secret storage, reading storage and caching locally"),await this.checkOwnCrossSigningTrust({allowPrivateKeyRequests:!0}));const u=i.crossSigningCallbacks.privateKeys;if(u.size&&!this.baseApis.cryptoCallbacks.saveCrossSigningKeys){const e=new q.ServerSideSecretStorageImpl(i.accountDataClientAdapter,i.ssssCryptoCallbacks);await e.hasKey()&&(c.v.log("Storing new cross-signing private keys in secret storage"),await b.storeInSecretStorage(u,e))}const h=i.buildOperation();await h.apply(this),await i.persist(this),c.v.log("Cross-signing ready")}async bootstrapSecretStorage({createSecretStorageKey:e=async()=>({}),keyBackupInfo:t,setupNewKeyBackup:s,setupNewSecretStorage:i,getKeyBackupPassphrase:n}={}){c.v.log("Bootstrapping Secure Secret Storage");const r=this.baseApis.cryptoCallbacks,o=new N(this.baseApis.store.accountData,r),a=new q.ServerSideSecretStorageImpl(o.accountDataClientAdapter,o.ssssCryptoCallbacks);let d=null;const l=async e=>{const{keyId:t,keyInfo:s}=await a.addKey(q.SECRET_STORAGE_ALGORITHM_V1_AES,e);return o.ssssCryptoCallbacks.addPrivateKey(t,s,e.key),await a.setDefaultKeyId(t),t},u=async(e,t)=>{if(!t.mac){var s,i;const n=await(null===(s=(i=this.baseApis.cryptoCallbacks).getSecretStorageKey)||void 0===s?void 0:s.call(i,{keys:{[e]:t}},""));if(n){const s=n[1];o.ssssCryptoCallbacks.addPrivateKey(e,t,s);const{iv:i,mac:r}=await(0,q.calculateKeyCheck)(s);t.iv=i,t.mac=r,await o.setAccountData(`m.secret_storage.key.${e}`,t)}}},h=async e=>{if(this.crossSigningInfo.getId()&&await this.crossSigningInfo.isStoredInKeyCache("master"))try{c.v.log("Adding cross-signing signature to key backup"),await this.crossSigningInfo.signObject(e,"master")}catch(e){c.v.error("Signing key backup with cross-signing keys failed",e)}else c.v.warn("Cross-signing keys not available, skipping signature on key backup")},m=await this.secretStorage.getKey(),[v,f]=m||[null,null],y=!i&&f&&f.algorithm===q.SECRET_STORAGE_ALGORITHM_V1_AES;if(c.v.log({keyBackupInfo:t,setupNewKeyBackup:s,setupNewSecretStorage:i,storageExists:y,oldKeyInfo:f}),y||t)if(!y&&t){c.v.log("Secret storage does not exist, using key backup key");const e=await this.getSessionBackupPrivateKey()||await(null==n?void 0:n()),s={key:e};t.auth_data.private_key_salt&&t.auth_data.private_key_iterations&&(s.passphrase={algorithm:"m.pbkdf2",iterations:t.auth_data.private_key_iterations,salt:t.auth_data.private_key_salt,bits:256}),d=await l(s),await a.store("m.megolm_backup.v1",(0,g.WG)(e),[d]),await h(t.auth_data),o.addSessionBackup(t)}else c.v.log("Secret storage exists"),f&&f.algorithm===q.SECRET_STORAGE_ALGORITHM_V1_AES&&await u(v,f);else{c.v.log("Secret storage does not exist, creating new storage key");const{keyInfo:t,privateKey:s}=await e();d=await l({passphrase:null==t?void 0:t.passphrase,key:s,name:null==t?void 0:t.name})}if(!this.baseApis.cryptoCallbacks.saveCrossSigningKeys&&await this.isCrossSigningReady()&&(d||!await this.crossSigningInfo.isStoredInSecretStorage(a))){c.v.log("Copying cross-signing private keys from cache to secret storage");const e=await this.crossSigningInfo.getCrossSigningKeysFromCache();await b.storeInSecretStorage(e,a)}if(s&&!t){c.v.log("Creating new message key backup version");const e=await this.baseApis.prepareKeyBackupVersion(null,{secureSecretStorage:!1}),t=(0,p.decodeRecoveryKey)(e.recovery_key);await a.store("m.megolm_backup.v1",(0,g.WG)(t));const s={algorithm:e.algorithm,auth_data:e.auth_data};await h(s.auth_data),await this.signObject(s.auth_data),o.addSessionBackup(s)}const S=await a.get("m.megolm_backup.v1");if(S){c.v.info("Got session backup key from secret storage: caching");const e=_t(S);if(e){const t=d||v;await a.store("m.megolm_backup.v1",e,t?[t]:null)}const t=new Uint8Array((0,g.y4)(e||S));o.addSessionBackupPrivateKeyToCache(t)}else if(this.backupManager.getKeyBackupEnabled()){const e=await this.getSessionBackupPrivateKey()||await(null==n?void 0:n());if(!e)return void c.v.error("Key backup is enabled but couldn't get key backup key!");c.v.info("Got session backup key from cache/user that wasn't in SSSS: saving to SSSS"),await a.store("m.megolm_backup.v1",(0,g.WG)(e))}const E=o.buildOperation();await E.apply(this),await o.persist(this),c.v.log("Secure Secret Storage ready")}async resetKeyBackup(){await this.backupManager.deleteAllKeyBackupVersions();const e=await this.backupManager.prepareKeyBackupVersion();await this.signObject(e.auth_data);const{version:t}=await this.baseApis.http.authedRequest(j.IT.Post,"/room_keys/version",void 0,e,{prefix:j.iD.V3});c.v.log(`Created backup version ${t}`);const s=e.privateKey;await this.secretStorage.store("m.megolm_backup.v1",(0,g.WG)(s)),await this.storeSessionBackupPrivateKey(s),await this.backupManager.checkAndStart(),await this.backupManager.scheduleAllGroupSessionsForBackup()}async deleteKeyBackupVersion(e){await this.backupManager.deleteKeyBackupVersion(e)}addSecretStorageKey(e,t,s){return this.secretStorage.addKey(e,t,s)}hasSecretStorageKey(e){return this.secretStorage.hasKey(e)}getSecretStorageKey(e){return this.secretStorage.getKey(e)}storeSecret(e,t,s){return this.secretStorage.store(e,t,s)}getSecret(e){return this.secretStorage.get(e)}isSecretStored(e){return this.secretStorage.isStored(e)}requestSecret(e,t){return t||(t=Object.keys(this.deviceList.getRawStoredDevicesForUser(this.userId))),this.secretStorage.request(e,t)}getDefaultSecretStorageKeyId(){return this.secretStorage.getDefaultKeyId()}setDefaultSecretStorageKeyId(e){return this.secretStorage.setDefaultKeyId(e)}checkSecretStorageKey(e,t){return this.secretStorage.checkKey(e,t)}checkSecretStoragePrivateKey(e,t){let i=null;try{i=new s.g.Olm.PkDecryption;return i.init_with_private_key(e)===t}finally{var n;null===(n=i)||void 0===n||n.free()}}async getSessionBackupPrivateKey(){const e=await new Promise((e=>{this.cryptoStore.doTxn("readonly",[m.y.STORE_ACCOUNT],(t=>{this.cryptoStore.getSecretStorePrivateKey(t,e,"m.megolm_backup.v1")}))}));let t=null;if("string"==typeof e&&(t=new Uint8Array((0,g.y4)(_t(e)||e)),await this.storeSessionBackupPrivateKey(t)),e&&"object"==typeof e&&"ciphertext"in e){const s=ft.from(this.olmDevice.pickleKey),i=await(0,f.A)(e,s,"m.megolm_backup.v1");t=(0,g.y4)(i)}return t}async storeSessionBackupPrivateKey(e,t){if(!(e instanceof Uint8Array))throw new Error(`storeSessionBackupPrivateKey expects Uint8Array, got ${e}`);const s=ft.from(this.olmDevice.pickleKey),i=await(0,v.A)((0,g.WG)(e),s,"m.megolm_backup.v1");return this.cryptoStore.doTxn("readwrite",[m.y.STORE_ACCOUNT],(e=>{this.cryptoStore.storeSecretStorePrivateKey(e,"m.megolm_backup.v1",i)}))}async getActiveSessionBackupVersion(){var e;return this.backupManager.getKeyBackupEnabled()&&null!==(e=this.backupManager.version)&&void 0!==e?e:null}async isKeyBackupTrusted(e){const t=await this.backupManager.isKeyBackupTrusted(e);return(0,ct.IG)(t)}async checkKeyBackupAndEnable(){const e=await this.backupManager.checkKeyBackup();return e&&e.backupInfo?{backupInfo:e.backupInfo,trustInfo:(0,ct.IG)(e.trustInfo)}:null}checkCrossSigningPrivateKey(e,t){let i=null;try{i=new s.g.Olm.PkSigning;return i.init_with_seed(e)===t}finally{var n;null===(n=i)||void 0===n||n.free()}}async afterCrossSigningLocalKeyChange(){c.v.info("Starting cross-signing key change post-processing");const e=this.deviceList.getStoredDevice(this.userId,this.deviceId),t=await this.crossSigningInfo.signDevice(this.userId,e);c.v.info(`Starting background key sig upload for ${this.deviceId}`);const s=({shouldEmit:e=!1})=>this.baseApis.uploadKeySignatures({[this.userId]:{[this.deviceId]:t}}).then((t=>{const{failures:i}=t||{};if(Object.keys(i||[]).length>0)throw e&&this.baseApis.emit(wt.KeySignatureUploadFailure,i,"afterCrossSigningLocalKeyChange",s),new at.b0("Key upload failed",{failures:i});c.v.info(`Finished background key sig upload for ${this.deviceId}`)})).catch((e=>{c.v.error(`Error during background key sig upload for ${this.deviceId}`,e)}));s({shouldEmit:!0});const i=this.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(i){c.v.info("Starting device verification upgrade");const e={};for(const[t,s]of Object.entries(this.deviceList.crossSigningInfo)){const i=await this.checkForDeviceVerificationUpgrade(t,b.fromStorage(s,t));i&&(e[t]=i)}if(Object.keys(e).length>0){c.v.info(`Found ${Object.keys(e).length} verif users to upgrade`);try{const t=await i({users:e});if(t)for(const s of t)s in e&&await this.baseApis.setDeviceVerified(s,e[s].crossSigningInfo.getId())}catch(e){c.v.log("shouldUpgradeDeviceVerifications threw an error: not upgrading",e)}}c.v.info("Finished device verification upgrade")}c.v.info("Finished cross-signing key change post-processing")}async checkForDeviceVerificationUpgrade(e,t){const s=this.crossSigningInfo.checkUserTrust(t);if(t.firstUse&&!s.isVerified()){const s=this.deviceList.getRawStoredDevicesForUser(e),i=await this.checkForValidDeviceSignature(e,t.keys.master,s);if(i.length)return{devices:i.map((e=>h.V.fromStorage(s[e],e))),crossSigningInfo:t}}}async checkForValidDeviceSignature(e,t,s){const i=[];if(s&&t.signatures&&t.signatures[e])for(const n of Object.keys(t.signatures[e])){const[,r]=n.split(":",2);if(r in s&&s[r].verified===St.VERIFIED)try{await u.verifySignature(this.olmDevice,t,e,r,s[r].keys[n]),i.push(r)}catch(e){}}return i}getCrossSigningKeyId(e=H.n.Master){return Promise.resolve(this.getCrossSigningId(e))}getCrossSigningId(e){return this.crossSigningInfo.getId(e)}getStoredCrossSigningForUser(e){return this.deviceList.getStoredCrossSigningForUser(e)}checkUserTrust(e){const t=this.deviceList.getStoredCrossSigningForUser(e);return t?this.crossSigningInfo.checkUserTrust(t):new p.UserVerificationStatus(!1,!1,!1)}async getUserVerificationStatus(e){return this.checkUserTrust(e)}async pinCurrentUserIdentity(e){throw new Error("not implemented")}async getDeviceVerificationStatus(e,t){const s=this.deviceList.getStoredDevice(e,t);return s?this.checkDeviceInfoTrust(e,s):null}checkDeviceTrust(e,t){const s=this.deviceList.getStoredDevice(e,t);return this.checkDeviceInfoTrust(e,s)}checkDeviceInfoTrust(e,t){const s=!(null==t||!t.isVerified()),i=this.deviceList.getStoredCrossSigningForUser(e);if(t&&i){const n=this.trustCrossSignedDevices||e===this.userId;return this.crossSigningInfo.checkDeviceTrust(i,t,s,n)}return new w(!1,!1,s,!1)}checkIfOwnDeviceCrossSigned(e){var t;const s=this.deviceList.getStoredDevice(this.userId,e);if(!s)return!1;const i=this.deviceList.getStoredCrossSigningForUser(this.userId);return null!==(t=null==i?void 0:i.checkDeviceTrust(i,s,!1,!0).isCrossSigningVerified())&&void 0!==t&&t}async checkOwnCrossSigningTrust({allowPrivateKeyRequests:e=!1}={}){const t=this.userId;await this.downloadKeys([this.userId]);const s=await this.crossSigningInfo.getCrossSigningKeysFromCache(),i=this.deviceList.getStoredCrossSigningForUser(t);if(!i)return void c.v.error("Got cross-signing update event for user "+t+" but no new cross-signing information found!");const n=i.getId(),r=this.crossSigningInfo.getId()!==n,o=i.getId()&&!s.has("master");if(r&&c.v.info("Got new master public key",n),e&&(r||o)){c.v.info("Attempting to retrieve cross-signing master private key");let e=null;try{e=(await this.crossSigningInfo.getCrossSigningKey("master",n))[1],c.v.info("Got cross-signing master private key")}finally{var a;null===(a=e)||void 0===a||a.free()}}const d=this.crossSigningInfo.getId("self_signing"),l=this.crossSigningInfo.getId("user_signing");this.storeTrustedSelfKeys(i.keys);const u=d!==i.getId("self_signing"),h=l!==i.getId("user_signing"),m=i.getId("self_signing")&&!s.has("self_signing"),p=i.getId("user_signing")&&!s.has("user_signing"),g={};if(u&&c.v.info("Got new self-signing key",i.getId("self_signing")),e&&(u||m)){c.v.info("Attempting to retrieve cross-signing self-signing private key");let e=null;try{e=(await this.crossSigningInfo.getCrossSigningKey("self_signing",i.getId("self_signing")))[1],c.v.info("Got cross-signing self-signing private key")}finally{var v;null===(v=e)||void 0===v||v.free()}const t=this.deviceList.getStoredDevice(this.userId,this.deviceId),s=await this.crossSigningInfo.signDevice(this.userId,t);g[this.deviceId]=s}if(h&&c.v.info("Got new user-signing key",i.getId("user_signing")),e&&(h||p)){c.v.info("Attempting to retrieve cross-signing user-signing private key");let e=null;try{e=(await this.crossSigningInfo.getCrossSigningKey("user_signing",i.getId("user_signing")))[1],c.v.info("Got cross-signing user-signing private key")}finally{var f;null===(f=e)||void 0===f||f.free()}}if(r){const e=this.crossSigningInfo.keys.master;await this.signObject(e);const t=e.signatures[this.userId]["ed25519:"+this.deviceId];g[this.crossSigningInfo.getId()]=Object.assign({},e,{signatures:{[this.userId]:{["ed25519:"+this.deviceId]:t}}})}const y=Object.keys(g);if(y.length){const e=({shouldEmit:t=!1})=>(c.v.info(`Starting background key sig upload for ${y}`),this.baseApis.uploadKeySignatures({[this.userId]:g}).then((s=>{const{failures:i}=s||{};if(c.v.info(`Finished background key sig upload for ${y}`),Object.keys(i||[]).length>0)throw t&&this.baseApis.emit(wt.KeySignatureUploadFailure,i,"checkOwnCrossSigningTrust",e),new at.b0("Key upload failed",{failures:i})})).catch((e=>{c.v.error(`Error during background key sig upload for ${y}`,e)})));e({shouldEmit:!0})}this.emit(wt.UserTrustStatusChanged,t,this.checkUserTrust(t)),r&&(this.emit(wt.KeysChanged,{}),await this.afterCrossSigningLocalKeyChange()),await this.backupManager.checkKeyBackup()}async getBackupDecryptor(e,t){if(!(t instanceof Uint8Array))throw new Error("getBackupDecryptor expects Uint8Array");const s=await ct.IO.makeAlgorithm(e,(async()=>t));return await s.keyMatches(t)?new ct.M7(s):Promise.reject(new j.up({errcode:L.pB.RESTORE_BACKUP_ERROR_BAD_KEY}))}importBackedUpRoomKeys(e,t,s={}){return s.source="backup",this.importRoomKeys(e,s)}async storeTrustedSelfKeys(e){e?this.crossSigningInfo.setKeys(e):this.crossSigningInfo.clearKeys(),await this.cryptoStore.doTxn("readwrite",[m.y.STORE_ACCOUNT],(e=>{this.cryptoStore.storeCrossSigningKeys(e,this.crossSigningInfo.keys)}))}async checkDeviceVerifications(e){const t=this.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(t){if(c.v.info(`Starting device verification upgrade for ${e}`),this.crossSigningInfo.keys.user_signing){const s=this.deviceList.getStoredCrossSigningForUser(e);if(s){const i=await this.checkForDeviceVerificationUpgrade(e,s);if(i){(await t({users:{[e]:i}})).includes(e)&&await this.baseApis.setDeviceVerified(e,s.getId())}}}c.v.info(`Finished device verification upgrade for ${e}`)}}enableLazyLoading(){this.lazyLoadMembers=!0}registerEventHandlers(e){e.on(ut.o.Membership,this.onMembership),e.on(L.AU.ToDeviceEvent,this.onToDeviceEvent),e.on(lt.u9.Timeline,this.onTimelineEvent),e.on(U.OQ.Decrypted,this.onTimelineEvent)}start(){c.v.warn("MatrixClient.crypto.start() is deprecated")}stop(){this.outgoingRoomKeyRequestManager.stop(),this.deviceList.stop(),this.dehydrationManager.stop(),this.backupManager.stop()}getDeviceEd25519Key(){return this.olmDevice.deviceEd25519Key}getDeviceCurve25519Key(){return this.olmDevice.deviceCurve25519Key}async getOwnDeviceKeys(){if(!this.olmDevice.deviceCurve25519Key)throw new Error("Curve25519 key not yet created");if(!this.olmDevice.deviceEd25519Key)throw new Error("Ed25519 key not yet created");return{ed25519:this.olmDevice.deviceEd25519Key,curve25519:this.olmDevice.deviceCurve25519Key}}setGlobalBlacklistUnverifiedDevices(e){this.globalBlacklistUnverifiedDevices=e}getGlobalBlacklistUnverifiedDevices(){return this.globalBlacklistUnverifiedDevices}uploadDeviceKeys(){const e={algorithms:this.supportedAlgorithms,device_id:this.deviceId,keys:this.deviceKeys,user_id:this.userId};return this.signObject(e).then((()=>this.baseApis.uploadKeysRequest({device_keys:e})))}getNeedsNewFallback(){return!!this.needsNewFallback}maybeUploadOneTimeKeys(){if(this.oneTimeKeyCheckInProgress)return;const e=Date.now();if(null!==this.lastOneTimeKeyCheck&&e-this.lastOneTimeKeyCheck<6e4)return;this.lastOneTimeKeyCheck=e;const t=this.olmDevice.maxNumberOfOneTimeKeys(),s=Math.floor(t/2),i=async e=>{for(;s>e||this.getNeedsNewFallback();){if(s>e){c.v.info("generating oneTimeKeys");const t=Math.min(s-e,5);await this.olmDevice.generateOneTimeKeys(t)}if(this.getNeedsNewFallback()){const e=await this.olmDevice.getFallbackKey();e.curve25519&&0!=Object.keys(e.curve25519).length||(c.v.info("generating fallback key"),this.fallbackCleanup&&(clearTimeout(this.fallbackCleanup),delete this.fallbackCleanup),await this.olmDevice.generateFallbackKey())}c.v.info("calling uploadOneTimeKeys");const t=await this.uploadOneTimeKeys();if(!t.one_time_key_counts||!t.one_time_key_counts.signed_curve25519)throw new Error("response for uploading keys does not contain one_time_key_counts.signed_curve25519");e=t.one_time_key_counts.signed_curve25519}};this.oneTimeKeyCheckInProgress=!0,Promise.resolve().then((()=>void 0!==this.oneTimeKeyCount?Promise.resolve(this.oneTimeKeyCount):this.baseApis.uploadKeysRequest({}).then((e=>e.one_time_key_counts.signed_curve25519||0)))).then((e=>i(e))).catch((e=>{c.v.error("Error uploading one-time keys",e.stack||e)})).finally((()=>{this.oneTimeKeyCount=void 0,this.oneTimeKeyCheckInProgress=!1}))}async uploadOneTimeKeys(){const e=[];let t;if(this.getNeedsNewFallback()){t={};const s=await this.olmDevice.getFallbackKey();for(const[i,n]of Object.entries(s.curve25519)){const s={key:n,fallback:!0};t["signed_curve25519:"+i]=s,e.push(this.signObject(s))}this.needsNewFallback=!1}const s=await this.olmDevice.getOneTimeKeys(),i={};for(const t in s.curve25519)if(s.curve25519.hasOwnProperty(t)){const n={key:s.curve25519[t]};i["signed_curve25519:"+t]=n,e.push(this.signObject(n))}await Promise.all(e);const n={one_time_keys:i};t&&(n["org.matrix.msc2732.fallback_keys"]=t,n.fallback_keys=t);const r=await this.baseApis.uploadKeysRequest(n);return t&&(this.fallbackCleanup=setTimeout((()=>{delete this.fallbackCleanup,this.olmDevice.forgetOldFallbackKey()}),36e5)),await this.olmDevice.markKeysAsPublished(),r}downloadKeys(e,t){return this.deviceList.downloadKeys(e,!!t)}getStoredDevicesForUser(e){return this.deviceList.getStoredDevicesForUser(e)}async getUserDeviceInfo(e,t=!1){const s=new Map,i=[];for(const t of e){const e=await this.getStoredDevicesForUser(t);if(e){const i=new Map(e.map((e=>[e.deviceId,gt(e,t)])));s.set(t,i)}else i.push(t)}if(t&&i.length>0){(await this.downloadKeys(i)).forEach(((e,t)=>{const i=new Map;e.forEach(((e,s)=>i.set(s,gt(e,t)))),s.set(t,i)}))}return s}getStoredDevice(e,t){return this.deviceList.getStoredDevice(e,t)}saveDeviceList(e){return this.deviceList.saveIfDirty(e)}async setDeviceVerified(e,t,s=!0){await this.setDeviceVerification(e,t,s)}async crossSignDevice(e){await this.setDeviceVerified(this.userId,e,!0)}async setDeviceVerification(e,t,s=null,i=null,n=null,r){const o=this.deviceList.getStoredCrossSigningForUser(e);if((null==o?void 0:o.getId())===t){if(null!==i||null!==n)throw new Error("Cannot set blocked or known for a cross-signing key");if(!s)throw new Error("Cannot set a cross-signing key as unverified");const a=r?Object.values(r)[0]:null;if(r&&(1!==Object.values(r).length||a!==o.getId()))throw new Error(`Key did not match expected value: expected ${o.getId()}, got ${a}`);if(this.crossSigningInfo.getId()||e!==this.crossSigningInfo.userId||(this.storeTrustedSelfKeys(o.keys),this.emit(wt.UserTrustStatusChanged,this.userId,this.checkUserTrust(e))),e!==this.userId){c.v.info("Master key "+o.getId()+" for "+e+" marked verified. Signing...");const s=await this.crossSigningInfo.signUser(o);if(s){const i=async({shouldEmit:n=!1})=>{c.v.info("Uploading signature for "+e+"...");const r=await this.baseApis.uploadKeySignatures({[e]:{[t]:s}}),{failures:o}=r||{};if(Object.keys(o||[]).length>0)throw n&&this.baseApis.emit(wt.KeySignatureUploadFailure,o,"setDeviceVerification",i),new at.b0("Key upload failed",{failures:o})};await i({shouldEmit:!0})}return s}return o}const a=this.deviceList.getRawStoredDevicesForUser(e);if(!a||!a[t])throw new Error("Unknown device "+e+":"+t);const d=a[t];let l=d.verified;if(s){if(r)for(const[e,t]of Object.entries(r))if(d.keys[e]!==t)throw new Error(`Key did not match expected value: expected ${t}, got ${d.keys[e]}`);l=St.VERIFIED}else null!==s&&l==St.VERIFIED&&(l=St.UNVERIFIED);i?l=St.BLOCKED:null!==i&&l==St.BLOCKED&&(l=St.UNVERIFIED);let u=d.known;if(null!==n&&(u=n),d.verified===l&&d.known===u||(d.verified=l,d.known=u,this.deviceList.storeDevicesForUser(e,a),this.deviceList.saveIfDirty()),s&&e===this.userId){let s;c.v.info("Own device "+t+" marked verified: signing");if(this.checkDeviceTrust(e,t).isCrossSigningVerified()?c.v.log(`Own device ${t} already cross-signing verified`):s=await this.crossSigningInfo.signDevice(e,h.V.fromStorage(d,t)),s){const i=async({shouldEmit:n=!1})=>{c.v.info("Uploading signature for "+t);const r=await this.baseApis.uploadKeySignatures({[e]:{[t]:s}}),{failures:o}=r||{};if(Object.keys(o||[]).length>0)throw n&&this.baseApis.emit(wt.KeySignatureUploadFailure,o,"setDeviceVerification",i),new at.b0("Key upload failed",{failures:o})};await i({shouldEmit:!0})}}const m=h.V.fromStorage(d,t);return this.emit(wt.DeviceVerificationChanged,e,t,m),m}findVerificationRequestDMInProgress(e,t){return this.inRoomVerificationRequests.findRequestInProgress(e,t)}getVerificationRequestsToDeviceInProgress(e){return this.toDeviceVerificationRequests.getRequestsInProgress(e)}requestVerificationDM(e,t){const s=this.inRoomVerificationRequests.findRequestInProgress(t);if(s)return Promise.resolve(s);const i=new tt(this.baseApis,t,e);return this.requestVerificationWithChannel(e,i,this.inRoomVerificationRequests)}requestVerification(e,t){t||(t=Object.keys(this.deviceList.getRawStoredDevicesForUser(e)));const s=this.toDeviceVerificationRequests.findRequestInProgress(e,t);if(s)return Promise.resolve(s);const i=new nt(this.baseApis,e,t,nt.makeTransactionId());return this.requestVerificationWithChannel(e,i,this.toDeviceVerificationRequests)}requestOwnUserVerification(){return this.requestVerification(this.userId)}requestDeviceVerification(e,t){return this.requestVerification(e,[t])}async requestVerificationWithChannel(e,t,s){let i=new Ye(t,this.verificationMethods,this.baseApis);t.transactionId&&s.setRequestByChannel(t,i),await i.sendRequest();const n=s.getRequestByChannel(t);return n?i=n:(c.v.log(`Crypto: adding new request to requestsByTxnId with id ${t.transactionId} ${t.roomId}`),s.setRequestByChannel(t,i)),i}beginKeyVerification(e,t,s,i=null){let n;if(i){if(n=this.toDeviceVerificationRequests.getRequestBySenderAndTxnId(t,i),!n)throw new Error(`No request found for user ${t} with transactionId ${i}`)}else{i=nt.makeTransactionId();const e=new nt(this.baseApis,t,[s],i,s);n=new Ye(e,this.verificationMethods,this.baseApis),this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(t,i,n)}return n.beginKeyVerification(e,{userId:t,deviceId:s})}async legacyDeviceVerification(e,t,s){const i=nt.makeTransactionId(),n=new nt(this.baseApis,e,[t],i,t),r=new Ye(n,this.verificationMethods,this.baseApis);this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(e,i,r);const o=r.beginKeyVerification(s,{userId:e,deviceId:t});return await Promise.race([o.verify(),r.waitFor((e=>e.started))]),r}async getOlmSessionsForUser(e){const t=this.getStoredDevicesForUser(e)||[],s={};for(const e of t){const t=e.getIdentityKey(),i=await this.olmDevice.getSessionInfoForDevice(t);s[e.deviceId]={deviceIdKey:t,sessions:i}}return s}getEventSenderDeviceInfo(e){const t=e.getSenderKey(),s=e.getWireContent().algorithm;if(!t||!s)return null;if(e.isKeySourceUntrusted())return null;const i=this.deviceList.getDeviceByIdentityKey(s,t);if(null===i)return null;const n=e.getClaimedEd25519Key();return n?n!==i.getFingerprint()?(c.v.warn("Event "+e.getId()+" claims ed25519 key "+n+" but sender device has key "+i.getFingerprint()),null):i:(c.v.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),null)}getEventEncryptionInfo(e){var t,s;const i={};if(i.senderKey=null!==(t=e.getSenderKey())&&void 0!==t?t:void 0,i.algorithm=e.getWireContent().algorithm,!i.senderKey||!i.algorithm)return i.encrypted=!1,i;i.encrypted=!0,e.isKeySourceUntrusted()?i.authenticated=!1:i.authenticated=!0,i.sender=null!==(s=this.deviceList.getDeviceByIdentityKey(i.algorithm,i.senderKey))&&void 0!==s?s:void 0;const n=e.getClaimedEd25519Key();return n||(c.v.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),i.mismatchedSender=!0),i.sender&&n!==i.sender.getFingerprint()&&(c.v.warn("Event "+e.getId()+" claims ed25519 key "+n+"but sender device has key "+i.sender.getFingerprint()),i.mismatchedSender=!0),i}async getEncryptionInfoForEvent(e){const t=this.getEventEncryptionInfo(e);if(!t.encrypted)return null;const s=e.getSender();if(!s||t.mismatchedSender)return{shieldColour:p.EventShieldColour.RED,shieldReason:p.EventShieldReason.MISMATCHED_SENDER_KEY};if(!this.checkUserTrust(s).isCrossSigningVerified())return t.authenticated?{shieldColour:p.EventShieldColour.NONE,shieldReason:null}:{shieldColour:p.EventShieldColour.GREY,shieldReason:p.EventShieldReason.AUTHENTICITY_NOT_GUARANTEED};const i=s&&t.sender&&await this.getDeviceVerificationStatus(s,t.sender.deviceId);return i?i.isVerified()?t.authenticated?{shieldColour:p.EventShieldColour.NONE,shieldReason:null}:{shieldColour:p.EventShieldColour.GREY,shieldReason:p.EventShieldReason.AUTHENTICITY_NOT_GUARANTEED}:{shieldColour:p.EventShieldColour.RED,shieldReason:p.EventShieldReason.UNSIGNED_DEVICE}:{shieldColour:p.EventShieldColour.GREY,shieldReason:p.EventShieldReason.UNKNOWN_DEVICE}}forceDiscardSession(e){const t=this.roomEncryptors.get(e);if(void 0===t)throw new Error("Room not encrypted");if(void 0===t.forceDiscardSession)throw new Error("Room encryption algorithm doesn't support session discarding");return t.forceDiscardSession(),Promise.resolve()}async setRoomEncryption(e,t,s){const i=this.clientStore.getRoom(e);if(!i)throw new Error(`Unable to enable encryption tracking devices in unknown room ${e}`);await this.setRoomEncryptionImpl(i,t),this.lazyLoadMembers||s||this.deviceList.refreshOutdatedDeviceLists()}async setRoomEncryptionImpl(e,t){const s=e.roomId;if(!t.algorithm)return void c.v.log("Ignoring setRoomEncryption with no algorithm");const i=this.roomList.getRoomEncryption(s);if(i&&JSON.stringify(i)!=JSON.stringify(t))return void c.v.error("Ignoring m.room.encryption event which requests a change of config in "+s);if(this.roomEncryptors.get(s))return;let n=null;i||(n=this.roomList.setRoomEncryption(s,t));const r=O.l1.get(t.algorithm);if(!r)throw new Error("Unable to encrypt with "+t.algorithm);const o=new r({userId:this.userId,deviceId:this.deviceId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:s,config:t});if(this.roomEncryptors.set(s,o),n&&await n,c.v.log(`Enabling encryption in ${s}`),e.membersLoaded())await this.trackRoomDevicesImpl(e);else{const t=i=>{e.off(mt.f.Update,t),e.membersLoaded()&&this.trackRoomDevicesImpl(e).catch((e=>{c.v.error(`Error enabling device tracking in ${s}`,e)}))};e.on(mt.f.Update,t)}}trackRoomDevices(e){const t=this.clientStore.getRoom(e);if(!t)throw new Error(`Unable to start tracking devices in unknown room ${e}`);return this.trackRoomDevicesImpl(t)}trackRoomDevicesImpl(e){const t=e.roomId,s=async()=>{if(!this.roomEncryptors.has(t))return;c.v.log(`Starting to track devices for room ${t} ...`);(await e.getEncryptionTargetMembers()).forEach((e=>{this.deviceList.startTrackingDeviceList(e.userId)}))};let i=this.roomDeviceTrackingState[t];return i||(i=s(),this.roomDeviceTrackingState[t]=i.catch((e=>{throw delete this.roomDeviceTrackingState[t],e}))),i}ensureOlmSessionsForUsers(e,t){const s=new Map;for(const t of e){const e=[];s.set(t,e);const i=this.getStoredDevicesForUser(t)||[];for(const t of i){t.getIdentityKey()!=this.olmDevice.deviceCurve25519Key&&(t.verified!=St.BLOCKED&&e.push(t))}}return u.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,s,t)}async exportRoomKeys(){const e=[];return await this.cryptoStore.doTxn("readonly",[m.y.STORE_INBOUND_GROUP_SESSIONS],(t=>{this.cryptoStore.getAllEndToEndInboundGroupSessions(t,(t=>{if(null===t)return;const s=this.olmDevice.exportInboundGroupSession(t.senderKey,t.sessionId,t.sessionData);delete s.first_known_index,s.algorithm=u.MEGOLM_ALGORITHM,e.push(s)}))})),e}async exportRoomKeysAsJson(){return JSON.stringify(await this.exportRoomKeys())}importRoomKeys(e,t={}){let s=0,i=0;const n=e.length;function r(){var e;null===(e=t.progressCallback)||void 0===e||e.call(t,{stage:"load_keys",successes:s,failures:i,total:n})}return Promise.all(e.map((e=>{if(!e.room_id||!e.algorithm)return c.v.warn("ignoring room key entry with missing fields",e),i++,t.progressCallback&&r(),null;return this.getRoomDecryptor(e.room_id,e.algorithm).importRoomKey(e,t).finally((()=>{s++,t.progressCallback&&r()}))}))).then()}async importRoomKeysAsJson(e,t){return await this.importRoomKeys(JSON.parse(e))}countSessionsNeedingBackup(){return this.backupManager.countSessionsNeedingBackup()}prepareToEncrypt(e){const t=this.roomEncryptors.get(e.roomId);t&&t.prepareToEncrypt(e)}async encryptEvent(e,t){const s=e.getRoomId(),i=this.roomEncryptors.get(s);if(!i)throw new Error("Room "+s+" was previously configured to use encryption, but is no longer. Perhaps the homeserver is hiding the configuration event.");await this.trackRoomDevicesImpl(t);let n=e.getContent();const r=n["m.relates_to"];r&&(n=Object.assign({},n),delete n["m.relates_to"]);const o=n["io.element.performance_metrics"];o&&(n=Object.assign({},n),delete n["io.element.performance_metrics"]);const a=await i.encryptMessage(t,e.getType(),n);r&&(a["m.relates_to"]=r),o&&(a["io.element.performance_metrics"]=o),e.makeEncrypted("m.room.encrypted",a,this.olmDevice.deviceCurve25519Key,this.olmDevice.deviceEd25519Key)}async decryptEvent(e){if(e.isRedacted()){const t=new U.kl(function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?yt(Object(s),!0).forEach((function(t){(0,i.A)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):yt(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({room_id:e.getRoomId()},e.getUnsigned().redacted_because));let s=e.getUnsigned().redacted_because;if(t.isEncrypted())try{s=(await this.decryptEvent(t)).clearEvent}catch(e){c.v.warn("Decryption of redaction failed. Falling back to unencrypted event.",e)}return{clearEvent:{room_id:e.getRoomId(),type:"m.room.message",content:{},unsigned:{redacted_because:s}}}}{const t=e.getWireContent();return this.getRoomDecryptor(e.getRoomId(),t.algorithm).decryptEvent(e)}}async processDeviceLists(e){await this.evalDeviceListChanges(e)}requestRoomKey(e,t,s=!1){return this.outgoingRoomKeyRequestManager.queueRoomKeyRequest(e,t,s).then((()=>{this.sendKeyRequestsImmediately&&this.outgoingRoomKeyRequestManager.sendQueuedRequests()})).catch((e=>{c.v.error("Error requesting key for event",e)}))}cancelRoomKeyRequest(e){this.outgoingRoomKeyRequestManager.cancelRoomKeyRequest(e).catch((e=>{c.v.warn("Error clearing pending room key requests",e)}))}async cancelAndResendAllOutgoingKeyRequests(){await this.outgoingRoomKeyRequestManager.cancelAndResendAllOutgoingRequests()}async onCryptoEvent(e,t){const s=t.getContent();await this.setRoomEncryptionImpl(e,s)}async onSyncWillProcess(e){e.oldSyncToken||(c.v.log("Initial sync performed - resetting device tracking state"),this.deviceList.stopTrackingAllDeviceLists(),this.deviceList.startTrackingDeviceList(this.userId),this.roomDeviceTrackingState={}),this.sendKeyRequestsImmediately=!1}async onSyncCompleted(e){var t;this.deviceList.setSyncToken(null!==(t=e.nextSyncToken)&&void 0!==t?t:null),this.deviceList.saveIfDirty(),this.deviceList.startTrackingDeviceList(this.userId),this.deviceList.refreshOutdatedDeviceLists(),e.catchingUp||(this.maybeUploadOneTimeKeys(),this.processReceivedRoomKeyRequests(),this.outgoingRoomKeyRequestManager.sendQueuedRequests(),this.sendKeyRequestsImmediately=!0)}async evalDeviceListChanges(e){if(Array.isArray(null==e?void 0:e.changed)&&e.changed.forEach((e=>{this.deviceList.invalidateUserDeviceList(e)})),Array.isArray(null==e?void 0:e.left)&&e.left.length){const t=new Set(await this.getTrackedE2eUsers());e.left.forEach((e=>{t.has(e)||this.deviceList.stopTrackingDeviceList(e)}))}}async getTrackedE2eUsers(){const e=[];for(const t of this.getTrackedE2eRooms()){const s=await t.getEncryptionTargetMembers();for(const t of s)e.push(t.userId)}return e}getTrackedE2eRooms(){return this.clientStore.getRooms().filter((e=>{if(!this.roomEncryptors.get(e.roomId))return!1;if(!this.roomDeviceTrackingState[e.roomId])return!1;const t=e.getMyMembership();return t===vt.O.Join||t===vt.O.Invite}))}async encryptAndSendToDevices(e,t){const s={eventType:a.Bx.RoomMessageEncrypted,batch:[]};try{await Promise.all(e.map((async({userId:e,deviceInfo:i})=>{const n=i.deviceId,r={algorithm:u.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[a.wt]:(0,o.A)()};s.batch.push({userId:e,deviceId:n,payload:r}),await u.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[e,[i]]])),await u.encryptMessageForDevice(r.ciphertext,this.userId,this.deviceId,this.olmDevice,e,i,t)}))),s.batch=s.batch.filter((e=>Object.keys(e.payload.ciphertext).length>0||(c.v.log(`No ciphertext for device ${e.userId}:${e.deviceId}: pruning`),!1)));try{await this.baseApis.queueToDevice(s)}catch(e){throw c.v.error("sendToDevice failed",e),e}}catch(e){throw c.v.error("encryptAndSendToDevices promises failed",e),e}}async preprocessToDeviceMessages(e){return e.filter((e=>{var t;return!(e.type===a.Bx.RoomMessageEncrypted&&!["m.olm.v1.curve25519-aes-sha2"].includes(null===(t=e.content)||void 0===t?void 0:t.algorithm))||(c.v.log("Ignoring invalid encrypted to-device event from "+e.sender),!1)}))}updateOneTimeKeyCount(e){if(!isFinite(e))throw new TypeError("Parameter for updateOneTimeKeyCount has to be a number");this.oneTimeKeyCount=e}processKeyCounts(e,t){return void 0!==e&&this.updateOneTimeKeyCount(e.signed_curve25519||0),void 0!==t&&(this.needsNewFallback=!t.includes("signed_curve25519")),Promise.resolve()}onRoomKeyEvent(e){const t=e.getContent();if(!t.room_id||!t.algorithm)return void c.v.error("key event is missing fields");this.backupManager.checkedForBackup||this.backupManager.checkAndStart();this.getRoomDecryptor(t.room_id,t.algorithm).onRoomKeyEvent(e)}onRoomKeyWithheldEvent(e){const t=e.getContent();if(!(("m.no_olm"===t.code||t.room_id&&t.session_id)&&t.algorithm&&t.sender_key))return void c.v.error("key withheld event is missing fields");c.v.info(`Got room key withheld event from ${e.getSender()} for ${t.algorithm} session ${t.sender_key}|${t.session_id} in room ${t.room_id} with code ${t.code} (${t.reason})`);const s=this.getRoomDecryptor(t.room_id,t.algorithm);if(s.onRoomKeyWithheldEvent&&s.onRoomKeyWithheldEvent(e),!t.room_id){const e=this.getRoomDecryptors(t.algorithm);for(const s of e)s.retryDecryptionFromSender(t.sender_key)}}onKeyVerificationMessage(e){if(!nt.validateEvent(e,this.baseApis))return;this.handleVerificationEvent(e,this.toDeviceVerificationRequests,(e=>{if(!nt.canCreateRequest(nt.getEventType(e)))return;const t=e.getContent(),s=t&&t.from_device;if(!s)return;const i=e.getSender(),n=new nt(this.baseApis,i,[s]);return new Ye(n,this.verificationMethods,this.baseApis)}))}async handleVerificationEvent(e,t,s,i=!0){if(e.isSending()&&e.status!=U.fb.SENT){let t,s;try{await new Promise(((i,n)=>{t=i,s=()=>{e.status==U.fb.CANCELLED&&n(new Error("Event status set to CANCELLED."))},e.once(U.OQ.LocalEventIdReplaced,t),e.on(U.OQ.Status,s)}))}catch(e){return void c.v.error("error while waiting for the verification event to be sent: ",e)}finally{e.removeListener(U.OQ.LocalEventIdReplaced,t),e.removeListener(U.OQ.Status,s)}}let n=t.getRequest(e),r=!1;if(!n){if(n=s(e),!n)return void c.v.log(`Crypto: could not find VerificationRequest for ${e.getType()}, and could not create one, so ignoring.`);r=!0,t.setRequest(e,n)}e.setVerificationRequest(n);try{await n.channel.handleEvent(e,n,i)}catch(e){c.v.error("error while handling verification event",e)}r&&!n.initiatedByMe&&!n.invalid&&!n.observeOnly&&(this.baseApis.emit(wt.VerificationRequest,n),this.baseApis.emit(wt.VerificationRequestReceived,n))}async onToDeviceBadEncrypted(e){const t=e.getWireContent(),s=e.getSender(),i=t.algorithm,n=t.sender_key;this.baseApis.emit(L.AU.UndecryptableToDeviceEvent,e);const r=()=>{const e=this.getRoomDecryptors(u.MEGOLM_ALGORITHM);for(const t of e)t.retryDecryptionFromSender(n)};if(void 0===s||void 0===n||void 0===n)return;const d=this.forceNewSessionRetryTime.getOrCreate(s),l=d.getOrCreate(n);if(l>Date.now())return c.v.debug(`New session already forced with device ${s}:${n}: not forcing another until at least ${new Date(l).toUTCString()}`),await this.olmDevice.recordSessionProblem(n,"wedged",!0),void r();d.set(n,Date.now()+3e5);let h=this.deviceList.getDeviceByIdentityKey(i,n);if(!h&&(await this.downloadKeys([s],!1),h=this.deviceList.getDeviceByIdentityKey(i,n),!h))return c.v.info("Couldn't find device for identity key "+n+": not re-establishing session"),await this.olmDevice.recordSessionProblem(n,"wedged",!1),void r();const m=new Map([[s,[h]]]);await u.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,m,!0),d.set(n,Date.now()+36e5);const p={algorithm:u.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[a.wt]:(0,o.A)()};await u.encryptMessageForDevice(p.ciphertext,this.userId,this.deviceId,this.olmDevice,s,h,{type:"m.dummy"}),await this.olmDevice.recordSessionProblem(n,"wedged",!0),r(),await this.baseApis.sendToDevice("m.room.encrypted",new Map([[s,new Map([[h.deviceId,p]])]]));const g=await this.outgoingRoomKeyRequestManager.getOutgoingSentRoomKeyRequest(s,h.deviceId);for(const e of g)this.requestRoomKey(e.requestBody,e.recipients,!0)}onRoomMembership(e,t,s){const i=t.roomId,n=this.roomEncryptors.get(i);if(n){var r;if(i in this.roomDeviceTrackingState)t.membership==vt.O.Join?(c.v.log("Join event for "+t.userId+" in "+i),this.deviceList.startTrackingDeviceList(t.userId)):t.membership==vt.O.Invite&&null!==(r=this.clientStore.getRoom(i))&&void 0!==r&&r.shouldEncryptForInvitedMembers()&&(c.v.log("Invite event for "+t.userId+" in "+i),this.deviceList.startTrackingDeviceList(t.userId));n.onRoomMembership(e,t,s)}}onRoomKeyRequestEvent(e){const t=e.getContent();if("request"===t.action){const t=new kt(e);this.receivedRoomKeyRequests.push(t)}else if("request_cancellation"===t.action){const t=new Rt(e);this.receivedRoomKeyRequestCancellations.push(t)}}async processReceivedRoomKeyRequests(){if(!this.processingRoomKeyRequests){this.processingRoomKeyRequests=!0;try{const e=this.receivedRoomKeyRequests;this.receivedRoomKeyRequests=[];const t=this.receivedRoomKeyRequestCancellations;this.receivedRoomKeyRequestCancellations=[],await Promise.all(e.map((e=>this.processReceivedRoomKeyRequest(e)))),await Promise.all(t.map((e=>this.processReceivedRoomKeyRequestCancellation(e))))}catch(e){c.v.error(`Error processing room key requsts: ${e}`)}finally{this.processingRoomKeyRequests=!1}}}async processReceivedRoomKeyRequest(e){const t=e.userId,s=e.deviceId,i=e.requestBody,n=i.room_id,r=i.algorithm;if(c.v.log(`m.room_key_request from ${t}:${s} for ${n} / ${i.session_id} (id ${e.requestId})`),t!==this.userId){if(!this.roomEncryptors.get(n))return void c.v.debug(`room key request for unencrypted room ${n}`);const e=this.roomEncryptors.get(n),r=this.deviceList.getStoredDevice(t,s);if(!r)return void c.v.debug(`Ignoring keyshare for unknown device ${t}:${s}`);try{await e.reshareKeyWithDevice(i.sender_key,i.session_id,t,r)}catch(e){c.v.warn("Failed to re-share keys for session "+i.session_id+" with device "+t+":"+r.deviceId,e)}return}if(s===this.deviceId)return void c.v.log("Ignoring room key request from ourselves");if(!this.roomDecryptors.has(n))return void c.v.log(`room key request for unencrypted room ${n}`);const o=this.roomDecryptors.get(n).get(r);if(o)if(await o.hasKeysForKeyRequest(e)){if(e.share=()=>{o.shareKeysWithDevice(e)},this.checkDeviceTrust(t,s).isVerified())return c.v.log("device is already verified: sharing keys"),void e.share();this.emit(wt.RoomKeyRequest,e)}else c.v.log(`room key request for unknown session ${n} / `+i.session_id);else c.v.log(`room key request for unknown alg ${r} in room ${n}`)}async processReceivedRoomKeyRequestCancellation(e){c.v.log(`m.room_key_request cancellation for ${e.userId}:${e.deviceId} (id ${e.requestId})`),this.emit(wt.RoomKeyRequestCancellation,e)}getRoomDecryptor(e,t){let s,i;if(e&&(s=this.roomDecryptors.get(e),s||(s=new Map,this.roomDecryptors.set(e,s)),i=s.get(t),i))return i;const n=O.Jn.get(t);if(!n)throw new M.O(p.DecryptionFailureCode.UNKNOWN_ENCRYPTION_ALGORITHM,'Unknown encryption algorithm "'+t+'".');return i=new n({userId:this.userId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:null!=e?e:void 0}),s&&s.set(t,i),i}getRoomDecryptors(e){const t=[];for(const s of this.roomDecryptors.values())s.has(e)&&t.push(s.get(e));return t}async signObject(e){const t=new Map(Object.entries(e.signatures||{})),s=e.unsigned;delete e.signatures,delete e.unsigned;const i=t.get(this.userId)||{};t.set(this.userId,i),i["ed25519:"+this.deviceId]=await this.olmDevice.sign(r().stringify(e)),e.signatures=(0,_.HF)(t),void 0!==s&&(e.unsigned=s)}isRoomEncrypted(e){return this.roomList.isRoomEncrypted(e)}async isEncryptionEnabledInRoom(e){return this.isRoomEncrypted(e)}getRoomEncryption(e){return this.roomList.getRoomEncryption(e)}async isDehydrationSupported(){return!1}async startDehydration(e){throw new Error("Not implemented")}}function _t(e){if("string"!=typeof e||e.indexOf(",")<0)return null;const t=Uint8Array.from(e.split(","),(e=>parseInt(e)));return(0,g.WG)(t)}class kt{constructor(e){(0,i.A)(this,"userId",void 0),(0,i.A)(this,"deviceId",void 0),(0,i.A)(this,"requestId",void 0),(0,i.A)(this,"requestBody",void 0),(0,i.A)(this,"share",void 0);const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id,this.requestBody=t.body||{},this.share=()=>{throw new Error("don't know how to share keys for this request yet")}}}class Rt{constructor(e){(0,i.A)(this,"userId",void 0),(0,i.A)(this,"deviceId",void 0),(0,i.A)(this,"requestId",void 0);const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id}}},"./node_modules/matrix-js-sdk/src/crypto/key_passphrase.ts":(e,t,s)=>{"use strict";s.d(t,{SM:()=>o});var i=s("./node_modules/matrix-js-sdk/src/randomstring.ts"),n=s("./node_modules/matrix-js-sdk/src/crypto-api/index.ts");s("./node_modules/matrix-js-sdk/src/common-crypto/key-passphrase.ts");const r=5e5;async function o(e){const t=(0,i.DU)(32);return{key:await(0,n.deriveRecoveryKeyFromPassphrase)(e,t,r),salt:t,iterations:r}}},"./node_modules/matrix-js-sdk/src/crypto/olmlib.ts":(e,t,s)=>{"use strict";s.r(t),s.d(t,{MEGOLM_ALGORITHM:()=>h,MEGOLM_BACKUP_ALGORITHM:()=>m,OLM_ALGORITHM:()=>u,encryptMessageForDevice:()=>p,ensureOlmSessionsForDevices:()=>v,getExistingOlmSessions:()=>g,isOlmEncrypted:()=>E,pkSign:()=>S,pkVerify:()=>b,verifySignature:()=>y});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/another-json/another-json.js"),r=s.n(n),o=s("./node_modules/matrix-js-sdk/src/logger.ts"),a=s("./node_modules/matrix-js-sdk/src/@types/event.ts"),d=s("./node_modules/matrix-js-sdk/src/utils.ts");function c(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}var l=function(e){return e.Olm="m.olm.v1.curve25519-aes-sha2",e.Megolm="m.megolm.v1.aes-sha2",e.MegolmBackup="m.megolm_backup.v1.curve25519-aes-sha2",e}(l||{});const u=l.Olm,h=l.Megolm,m=l.MegolmBackup;async function p(e,t,s,n,r,a,d){const l=a.getIdentityKey(),u=await n.getSessionIdForDevice(l);if(null===u)return void o.v.log(`[olmlib.encryptMessageForDevice] Unable to find Olm session for device ${r}:${a.deviceId}`);o.v.log(`[olmlib.encryptMessageForDevice] Using Olm session ${u} for device ${r}:${a.deviceId}`);const h=function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?c(Object(s),!0).forEach((function(t){(0,i.A)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):c(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({sender:t,sender_device:s,keys:{ed25519:n.deviceEd25519Key},recipient:r,recipient_keys:{ed25519:a.getFingerprint()}},d);e[l]=await n.encryptMessage(l,u,JSON.stringify(h))}async function g(e,t,s){const i=new d.kG((()=>[])),n=new d.kG((()=>new Map)),r=[];for(const[t,o]of Object.entries(s))for(const s of o){const o=s.deviceId,a=s.getIdentityKey();r.push((async()=>{const r=await e.getSessionIdForDevice(a,!0);null===r?i.getOrCreate(t).push(s):n.getOrCreate(t).set(o,{device:s,sessionId:r})})())}return await Promise.all(r),[i,n]}async function v(e,t,s,i=!1,n,r,a=o.v){const d=[],c=new Map,l=new Map;for(const t of s.values())for(const s of t){const t=s.getIdentityKey();t!==e.deviceCurve25519Key&&(e.sessionsInProgress[t]||(e.sessionsInProgress[t]=new Promise((s=>{l.set(t,(i=>{delete e.sessionsInProgress[t],s(i)}))}))))}for(const[t,n]of s){const s=new Map;c.set(t,s);for(const r of n){const n=r.deviceId,o=r.getIdentityKey();if(o===e.deviceCurve25519Key){a.info("Attempted to start session with ourself! Ignoring"),s.set(n,{device:r,sessionId:null});continue}const c=`for ${o} (${t}:${n})`,u=await e.getSessionIdForDevice(o,!!l.get(o),a),h=l.get(o);null!==u&&h&&h(),(null===u||i)&&(i?a.info(`Forcing new Olm session ${c}`):a.info(`Making new Olm session ${c}`),d.push([t,n])),s.set(n,{device:r,sessionId:u})}}if(0===d.length)return c;const u="signed_curve25519";let h,m=`one-time keys for ${d.length} devices`;try{a.debug(`Claiming ${m}`),h=await t.claimOneTimeKeys(d,u,n),a.debug(`Claimed ${m}`)}catch(e){for(const e of l.values())e();throw a.debug(`Failed to claim ${m}`,e,d),e}r&&"failures"in h&&r.push(...Object.keys(h.failures));const p=h.one_time_keys||{},g=[];for(const[t,n]of s){const s=p[t]||{};for(const r of n){var v;const n=r.deviceId,o=r.getIdentityKey();if(o===e.deviceCurve25519Key)continue;if(null!==(v=c.get(t))&&void 0!==v&&null!==(v=v.get(n))&&void 0!==v&&v.sessionId&&!i)continue;const d=s[n]||{};let h=null;for(const e in d)0===e.indexOf(u+":")&&(h=d[e]);var y;if(h)g.push(f(e,h,t,r).then((e=>{var s,i;null===(s=l.get(o))||void 0===s||s(null!=e?e:void 0);const r=null===(i=c.get(t))||void 0===i?void 0:i.get(n);r&&(r.sessionId=e)}),(e=>{var t;throw null===(t=l.get(o))||void 0===t||t(),e})));else a.warn(`No one-time keys (alg=${u}) for device ${t}:${n}`),null===(y=l.get(o))||void 0===y||y()}}return m=`Olm sessions for ${g.length} devices`,a.debug(`Starting ${m}`),await Promise.all(g),a.debug(`Started ${m}`),c}async function f(e,t,s,i){const n=i.deviceId;try{await y(e,t,s,n,i.getFingerprint())}catch(e){return o.v.error("Unable to verify signature on one-time key for device "+s+":"+n+":",e),null}let r;try{r=await e.createOutboundSession(i.getIdentityKey(),t.key)}catch(e){return o.v.error("Error starting olm session with device "+s+":"+n+": "+e),null}return o.v.log("Started new olm sessionid "+r+" for device "+s+":"+n),r}async function y(e,t,s,i,n){const o="ed25519:"+i,a=((t.signatures||{})[s]||{})[o];if(!a)throw Error("No signature");const d=Object.assign({},t);"unsigned"in d&&delete d.unsigned,delete d.signatures;const c=r().stringify(d);e.verifySignature(n,c,a)}function S(e,t,i,n){let o=!1;if(t instanceof Uint8Array){const e=new s.g.Olm.PkSigning;n=e.init_with_seed(t),t=e,o=!0}const a=e.signatures||{};delete e.signatures;const d=e.unsigned;e.unsigned&&delete e.unsigned;try{const s=a[i]||{};return a[i]=s,s["ed25519:"+n]=t.sign(r().stringify(e))}finally{e.signatures=a,d&&(e.unsigned=d),o&&t.free()}}function b(e,t,i){const n="ed25519:"+t;if(!(e.signatures&&e.signatures[i]&&e.signatures[i][n]))throw new Error("No signature");const o=e.signatures[i][n],a=new s.g.Olm.Utility,d=e.signatures;delete e.signatures;const c=e.unsigned;e.unsigned&&delete e.unsigned;try{a.ed25519_verify(t,r().stringify(e),o)}finally{e.signatures=d,c&&(e.unsigned=c),a.free()}}function E(e){return e.getSenderKey()?!(e.getWireType()!==a.Bx.RoomMessageEncrypted||!["m.olm.v1.curve25519-aes-sha2"].includes(e.getWireContent().algorithm))||(o.v.error("Event was not encrypted using an appropriate algorithm"),!1):(o.v.error("Event has no sender key (not encrypted?)"),!1)}},"./node_modules/matrix-js-sdk/src/crypto/store/base.ts":(e,t,s)=>{"use strict";s.d(t,{Il:()=>n,Nv:()=>i,oT:()=>r});const i="migrationState";let n=function(e){return e[e.NOT_STARTED=0]="NOT_STARTED",e[e.INITIAL_DATA_MIGRATED=1]="INITIAL_DATA_MIGRATED",e[e.OLM_SESSIONS_MIGRATED=2]="OLM_SESSIONS_MIGRATED",e[e.MEGOLM_SESSIONS_MIGRATED=3]="MEGOLM_SESSIONS_MIGRATED",e[e.ROOM_SETTINGS_MIGRATED=4]="ROOM_SETTINGS_MIGRATED",e[e.INITIAL_OWN_KEY_QUERY_DONE=5]="INITIAL_OWN_KEY_QUERY_DONE",e}({});const r=50},"./node_modules/matrix-js-sdk/src/crypto/store/indexeddb-crypto-store.ts":(e,t,s)=>{"use strict";s.d(t,{y:()=>v});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/logger.ts"),r=s("./node_modules/matrix-js-sdk/src/crypto/store/localStorage-crypto-store.ts"),o=s("./node_modules/matrix-js-sdk/src/crypto/store/memory-crypto-store.ts"),a=s("./node_modules/matrix-js-sdk/src/utils.ts"),d=s("./node_modules/matrix-js-sdk/src/crypto/store/base.ts");class c{constructor(e){(0,i.A)(this,"nextTxnId",0),this.db=e,e.onversionchange=()=>{n.v.log(`versionchange for indexeddb ${this.db.name}: closing`),e.close()}}async containsData(){throw Error("Not implemented for Backend")}async startup(){return this}async deleteAllData(){throw Error("This is not implemented, call IDBFactory::deleteDatabase(dbName) instead.")}async getMigrationState(){let e=d.Il.NOT_STARTED;return await this.doTxn("readonly",[v.STORE_ACCOUNT],(t=>{const s=t.objectStore(v.STORE_ACCOUNT).get(d.Nv);s.onsuccess=()=>{var t;e=null!==(t=s.result)&&void 0!==t?t:d.Il.NOT_STARTED}})),e}async setMigrationState(e){await this.doTxn("readwrite",[v.STORE_ACCOUNT],(t=>{t.objectStore(v.STORE_ACCOUNT).put(e,d.Nv)}))}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return new Promise(((s,i)=>{const r=this.db.transaction("outgoingRoomKeyRequests","readwrite");r.onerror=i,this._getOutgoingRoomKeyRequest(r,t,(i=>{if(i)return n.v.log(`already have key request outstanding for ${t.room_id} / ${t.session_id}: not sending another`),void s(i);n.v.log(`enqueueing key request for ${t.room_id} / `+t.session_id),r.oncomplete=()=>{s(e)};r.objectStore("outgoingRoomKeyRequests").add(e)}))}))}getOutgoingRoomKeyRequest(e){return new Promise(((t,s)=>{const i=this.db.transaction("outgoingRoomKeyRequests","readonly");i.onerror=s,this._getOutgoingRoomKeyRequest(i,e,(e=>{t(e)}))}))}_getOutgoingRoomKeyRequest(e,t,s){const i=e.objectStore("outgoingRoomKeyRequests").index("session").openCursor([t.room_id,t.session_id]);i.onsuccess=()=>{const e=i.result;if(!e)return void s(null);const n=e.value;(0,a.ky)(n.requestBody,t)?s(n):e.continue()}}getOutgoingRoomKeyRequestByState(e){if(0===e.length)return Promise.resolve(null);let t,s=0;const i=this.db.transaction("outgoingRoomKeyRequests","readonly"),n=i.objectStore("outgoingRoomKeyRequests"),r=e[s];return n.index("state").openCursor(r).onsuccess=function i(){const n=this.result;if(n)return void(t=n.value);if(s++,s>=e.length)return;const r=e[s];this.source.openCursor(r).onsuccess=i},m(i).then((()=>t))}getAllOutgoingRoomKeyRequestsByState(e){return new Promise(((t,s)=>{const i=this.db.transaction("outgoingRoomKeyRequests","readonly").objectStore("outgoingRoomKeyRequests").index("state").getAll(e);i.onsuccess=()=>t(i.result),i.onerror=()=>s(i.error)}))}getOutgoingRoomKeyRequestsByTarget(e,t,s){let i=0;const n=[];const r=this.db.transaction("outgoingRoomKeyRequests","readonly"),o=r.objectStore("outgoingRoomKeyRequests"),a=s[i];return o.index("state").openCursor(a).onsuccess=function r(){const o=this.result;if(o){const s=o.value;s.recipients.some((s=>s.userId===e&&s.deviceId===t))&&n.push(s),o.continue()}else{if(i++,i>=s.length)return;const e=s[i];this.source.openCursor(e).onsuccess=r}},m(r).then((()=>n))}updateOutgoingRoomKeyRequest(e,t,s){let i=null;const r=this.db.transaction("outgoingRoomKeyRequests","readwrite");return r.objectStore("outgoingRoomKeyRequests").openCursor(e).onsuccess=function(){const e=this.result;if(!e)return;const r=e.value;r.state==t?(Object.assign(r,s),e.update(r),i=r):n.v.warn(`Cannot update room key request from ${t} as it was already updated to ${r.state}`)},m(r).then((()=>i))}deleteOutgoingRoomKeyRequest(e,t){const s=this.db.transaction("outgoingRoomKeyRequests","readwrite"),i=s.objectStore("outgoingRoomKeyRequests").openCursor(e);return i.onsuccess=()=>{const e=i.result;if(!e)return;const s=e.value;s.state==t?e.delete():n.v.warn(`Cannot delete room key request in state ${s.state} (expected ${t})`)},m(s)}getAccount(e,t){const s=e.objectStore("account").get("-");s.onsuccess=function(){try{t(s.result||null)}catch(t){h(e,t)}}}storeAccount(e,t){e.objectStore("account").put(t,"-")}getCrossSigningKeys(e,t){const s=e.objectStore("account").get("crossSigningKeys");s.onsuccess=function(){try{t(s.result||null)}catch(t){h(e,t)}}}getSecretStorePrivateKey(e,t,s){const i=e.objectStore("account").get(`ssss_cache:${s}`);i.onsuccess=function(){try{t(i.result||null)}catch(t){h(e,t)}}}storeCrossSigningKeys(e,t){e.objectStore("account").put(t,"crossSigningKeys")}storeSecretStorePrivateKey(e,t,s){e.objectStore("account").put(s,`ssss_cache:${t}`)}countEndToEndSessions(e,t){const s=e.objectStore("sessions").count();s.onsuccess=function(){try{t(s.result)}catch(t){h(e,t)}}}getEndToEndSessions(e,t,s){const i=t.objectStore("sessions").index("deviceKey").openCursor(e),n={};i.onsuccess=function(){const e=i.result;if(e)n[e.value.sessionId]={session:e.value.session,lastReceivedMessageTs:e.value.lastReceivedMessageTs},e.continue();else try{s(n)}catch(e){h(t,e)}}}getEndToEndSession(e,t,s,i){const n=s.objectStore("sessions").get([e,t]);n.onsuccess=function(){try{n.result?i({session:n.result.session,lastReceivedMessageTs:n.result.lastReceivedMessageTs}):i(null)}catch(e){h(s,e)}}}getAllEndToEndSessions(e,t){const s=e.objectStore("sessions").openCursor();s.onsuccess=function(){try{const e=s.result;e?(t(e.value),e.continue()):t(null)}catch(t){h(e,t)}}}storeEndToEndSession(e,t,s,i){i.objectStore("sessions").put({deviceKey:e,sessionId:t,session:s.session,lastReceivedMessageTs:s.lastReceivedMessageTs})}async storeEndToEndSessionProblem(e,t,s){const i=this.db.transaction("session_problems","readwrite");i.objectStore("session_problems").put({deviceKey:e,type:t,fixed:s,time:Date.now()}),await m(i)}async getEndToEndSessionProblem(e,t){let s=null;const i=this.db.transaction("session_problems","readwrite"),n=i.objectStore("session_problems").index("deviceKey").getAll(e);return n.onsuccess=()=>{const e=n.result;if(!e.length)return void(s=null);e.sort(((e,t)=>e.time-t.time));const i=e[e.length-1];for(const n of e)if(n.time>t)return void(s=Object.assign({},n,{fixed:i.fixed}));s=i.fixed?null:i},await m(i),s}async filterOutNotifiedErrorDevices(e){const t=this.db.transaction("notified_error_devices","readwrite").objectStore("notified_error_devices"),s=[];return await Promise.all(e.map((e=>new Promise((i=>{const{userId:n,deviceInfo:r}=e,o=t.get([n,r.deviceId]);o.onsuccess=function(){o.result||(t.put({userId:n,deviceId:r.deviceId}),s.push(e)),i()}}))))),s}async getEndToEndSessionsBatch(){const e=[];return await this.doTxn("readonly",[v.STORE_SESSIONS],(t=>{const s=t.objectStore(v.STORE_SESSIONS).openCursor();s.onsuccess=function(){try{const t=s.result;t&&(e.push(t.value),e.length<d.oT&&t.continue())}catch(e){h(t,e)}}})),0===e.length?null:e}async deleteEndToEndSessionsBatch(e){await this.doTxn("readwrite",[v.STORE_SESSIONS],(async t=>{try{const s=t.objectStore(v.STORE_SESSIONS);for(const{deviceKey:t,sessionId:i}of e){const e=s.delete([t,i]);await new Promise((t=>{e.onsuccess=t}))}}catch(e){h(t,e)}}))}getEndToEndInboundGroupSession(e,t,s,i){let n=!1,r=!1;const o=s.objectStore("inbound_group_sessions").get([e,t]);o.onsuccess=function(){try{n=o.result?o.result.session:null,!1!==r&&i(n,r)}catch(e){h(s,e)}};const a=s.objectStore("inbound_group_sessions_withheld").get([e,t]);a.onsuccess=function(){try{r=a.result?a.result.session:null,!1!==n&&i(n,r)}catch(e){h(s,e)}}}getAllEndToEndInboundGroupSessions(e,t){const s=e.objectStore("inbound_group_sessions").openCursor();s.onsuccess=function(){const i=s.result;if(i){try{t({senderKey:i.value.senderCurve25519Key,sessionId:i.value.sessionId,sessionData:i.value.session})}catch(t){h(e,t)}i.continue()}else try{t(null)}catch(t){h(e,t)}}}addEndToEndInboundGroupSession(e,t,s,i){const r=i.objectStore("inbound_group_sessions").add({senderCurve25519Key:e,sessionId:t,session:s});r.onerror=s=>{var o;"ConstraintError"===(null===(o=r.error)||void 0===o?void 0:o.name)?(s.stopPropagation(),s.preventDefault(),n.v.log("Ignoring duplicate inbound group session: "+e+" / "+t)):h(i,new Error("Failed to add inbound group session: "+r.error))}}storeEndToEndInboundGroupSession(e,t,s,i){i.objectStore("inbound_group_sessions").put({senderCurve25519Key:e,sessionId:t,session:s})}storeEndToEndInboundGroupSessionWithheld(e,t,s,i){i.objectStore("inbound_group_sessions_withheld").put({senderCurve25519Key:e,sessionId:t,session:s})}async countEndToEndInboundGroupSessions(){let e=0;return await this.doTxn("readonly",[v.STORE_INBOUND_GROUP_SESSIONS],(t=>{const s=t.objectStore(v.STORE_INBOUND_GROUP_SESSIONS).count();s.onsuccess=()=>{e=s.result}})),e}async getEndToEndInboundGroupSessionsBatch(){const e=[];return await this.doTxn("readonly",[v.STORE_INBOUND_GROUP_SESSIONS,v.STORE_BACKUP],(t=>{const s=t.objectStore(v.STORE_INBOUND_GROUP_SESSIONS),i=t.objectStore(v.STORE_BACKUP),n=s.openCursor();n.onsuccess=function(){try{const t=n.result;if(t){const s=i.get(t.key);s.onsuccess=()=>{e.push({senderKey:t.value.senderCurve25519Key,sessionId:t.value.sessionId,sessionData:t.value.session,needsBackup:void 0!==s.result}),e.length<d.oT&&t.continue()}}}catch(e){h(t,e)}}})),0===e.length?null:e}async deleteEndToEndInboundGroupSessionsBatch(e){await this.doTxn("readwrite",[v.STORE_INBOUND_GROUP_SESSIONS],(async t=>{try{const s=t.objectStore(v.STORE_INBOUND_GROUP_SESSIONS);for(const{senderKey:t,sessionId:i}of e){const e=s.delete([t,i]);await new Promise((t=>{e.onsuccess=t}))}}catch(e){h(t,e)}}))}getEndToEndDeviceData(e,t){const s=e.objectStore("device_data").get("-");s.onsuccess=function(){try{t(s.result||null)}catch(t){h(e,t)}}}storeEndToEndDeviceData(e,t){t.objectStore("device_data").put(e,"-")}storeEndToEndRoom(e,t,s){s.objectStore("rooms").put(t,e)}getEndToEndRooms(e,t){const s={},i=e.objectStore("rooms").openCursor();i.onsuccess=function(){const n=i.result;if(n)s[n.key]=n.value,n.continue();else try{t(s)}catch(t){h(e,t)}}}getSessionsNeedingBackup(e){return new Promise(((t,s)=>{const i=[],n=this.db.transaction(["sessions_needing_backup","inbound_group_sessions"],"readonly");n.onerror=s,n.oncomplete=function(){t(i)};const r=n.objectStore("sessions_needing_backup"),o=n.objectStore("inbound_group_sessions"),a=r.openCursor();a.onsuccess=function(){const t=a.result;if(t){const s=o.get(t.key);s.onsuccess=function(){i.push({senderKey:s.result.senderCurve25519Key,sessionId:s.result.sessionId,sessionData:s.result.session})},(!e||i.length<e)&&t.continue()}}}))}countSessionsNeedingBackup(e){e||(e=this.db.transaction("sessions_needing_backup","readonly"));const t=e.objectStore("sessions_needing_backup");return new Promise(((e,s)=>{const i=t.count();i.onerror=s,i.onsuccess=()=>e(i.result)}))}async unmarkSessionsNeedingBackup(e,t){t||(t=this.db.transaction("sessions_needing_backup","readwrite"));const s=t.objectStore("sessions_needing_backup");await Promise.all(e.map((e=>new Promise(((t,i)=>{const n=s.delete([e.senderKey,e.sessionId]);n.onsuccess=t,n.onerror=i})))))}async markSessionsNeedingBackup(e,t){t||(t=this.db.transaction("sessions_needing_backup","readwrite"));const s=t.objectStore("sessions_needing_backup");await Promise.all(e.map((e=>new Promise(((t,i)=>{const n=s.put({senderCurve25519Key:e.senderKey,sessionId:e.sessionId});n.onsuccess=t,n.onerror=i})))))}addSharedHistoryInboundGroupSession(e,t,s,i){i||(i=this.db.transaction("shared_history_inbound_group_sessions","readwrite"));const n=i.objectStore("shared_history_inbound_group_sessions"),r=n.get([e]);r.onsuccess=()=>{const{sessions:i}=r.result||{sessions:[]};i.push([t,s]),n.put({roomId:e,sessions:i})}}getSharedHistoryInboundGroupSessions(e,t){t||(t=this.db.transaction("shared_history_inbound_group_sessions","readonly"));const s=t.objectStore("shared_history_inbound_group_sessions").get([e]);return new Promise(((e,t)=>{s.onsuccess=()=>{const{sessions:t}=s.result||{sessions:[]};e(t)},s.onerror=t}))}addParkedSharedHistory(e,t,s){s||(s=this.db.transaction("parked_shared_history","readwrite"));const i=s.objectStore("parked_shared_history"),n=i.get([e]);n.onsuccess=()=>{const{parked:s}=n.result||{parked:[]};s.push(t),i.put({roomId:e,parked:s})}}takeParkedSharedHistory(e,t){t||(t=this.db.transaction("parked_shared_history","readwrite"));const s=t.objectStore("parked_shared_history").openCursor(e);return new Promise(((e,t)=>{s.onsuccess=()=>{const t=s.result;if(!t)return void e([]);const i=t.value;t.delete(),e(i)},s.onerror=t}))}doTxn(e,t,s,i=n.v){const r=this.db.transaction(t,e),o=m(r),a=s(r);return o.then((()=>a))}}const l=[e=>{!function(e){const t=e.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});t.createIndex("session",["requestBody.room_id","requestBody.session_id"]),t.createIndex("state","state")}(e)},e=>{e.createObjectStore("account")},e=>{e.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]}).createIndex("deviceKey","deviceKey")},e=>{e.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]})},e=>{e.createObjectStore("device_data")},e=>{e.createObjectStore("rooms")},e=>{e.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]})},e=>{e.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]})},e=>{e.createObjectStore("session_problems",{keyPath:["deviceKey","time"]}).createIndex("deviceKey","deviceKey"),e.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})},e=>{e.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})},e=>{e.createObjectStore("parked_shared_history",{keyPath:["roomId"]})}],u=l.length;function h(e,t){e._mx_abortexception=t;try{e.abort()}catch(t){}}function m(e){return new Promise(((t,s)=>{e.oncomplete=()=>{void 0!==e._mx_abortexception&&s(e._mx_abortexception),t(null)},e.onerror=t=>{void 0!==e._mx_abortexception?s(e._mx_abortexception):(n.v.log("Error performing indexeddb txn",t),s(e.error))},e.onabort=t=>{void 0!==e._mx_abortexception?s(e._mx_abortexception):(n.v.log("Error performing indexeddb txn",t),s(e.error))}}))}var p=s("./node_modules/matrix-js-sdk/src/errors.ts"),g=s("./node_modules/matrix-js-sdk/src/indexeddb-helpers.ts");class v{static exists(e,t){return g.t(e,t)}static existsAndIsNotMigrated(e,t){return new Promise(((s,i)=>{let n=!0;const r=e.open(t);r.onupgradeneeded=()=>{n=!1},r.onblocked=()=>i(r.error),r.onsuccess=()=>{const o=r.result;if(n){const e=o.transaction([v.STORE_ACCOUNT],"readonly").objectStore(v.STORE_ACCOUNT).get(d.Nv);e.onsuccess=()=>{var t;const i=null!==(t=e.result)&&void 0!==t?t:d.Il.NOT_STARTED;s(i===d.Il.NOT_STARTED)},e.onerror=()=>{i(e.error)},o.close()}else o.close(),e.deleteDatabase(t),s(!1)},r.onerror=()=>i(r.error)}))}constructor(e,t){(0,i.A)(this,"backendPromise",void 0),(0,i.A)(this,"backend",void 0),this.indexedDB=e,this.dbName=t}async containsData(){return v.exists(this.indexedDB,this.dbName)}startup(){return this.backendPromise||(this.backendPromise=new Promise(((e,t)=>{if(!this.indexedDB)return void t(new Error("no indexeddb support available"));n.v.log(`connecting to indexeddb ${this.dbName}`);const s=this.indexedDB.open(this.dbName,u);s.onupgradeneeded=e=>{!function(e,t){n.v.log(`Upgrading IndexedDBCryptoStore from version ${t} to ${u}`),l.forEach(((s,i)=>{t<=i&&s(e)}))}(s.result,e.oldVersion)},s.onblocked=()=>{n.v.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},s.onerror=e=>{n.v.log("Error connecting to indexeddb",e),t(s.error)},s.onsuccess=()=>{const t=s.result;n.v.log(`connected to indexeddb ${this.dbName}`),e(new c(t))}})).then((e=>e.doTxn("readonly",[v.STORE_INBOUND_GROUP_SESSIONS,v.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(t=>{e.getEndToEndInboundGroupSession("","",t,(()=>{}))})).then((()=>e)))).catch((e=>{if("VersionError"===e.name)throw n.v.warn("Crypto DB is too new for us to use!",e),new p.E5(p.hP.TooNew);n.v.warn(`unable to connect to indexeddb ${this.dbName}: falling back to localStorage store: ${e}`);try{return new r.F(s.g.localStorage)}catch(e){return n.v.warn(`unable to open localStorage: falling back to in-memory store: ${e}`),new o._}})).then((e=>(this.backend=e,e)))),this.backendPromise}deleteAllData(){return new Promise(((e,t)=>{if(!this.indexedDB)return void t(new Error("no indexeddb support available"));n.v.log(`Removing indexeddb instance: ${this.dbName}`);const s=this.indexedDB.deleteDatabase(this.dbName);s.onblocked=()=>{n.v.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},s.onerror=e=>{n.v.log("Error deleting data from indexeddb",e),t(s.error)},s.onsuccess=()=>{n.v.log(`Removed indexeddb instance: ${this.dbName}`),e()}})).catch((e=>{n.v.warn(`unable to delete IndexedDBCryptoStore: ${e}`)}))}getMigrationState(){return this.backend.getMigrationState()}setMigrationState(e){return this.backend.setMigrationState(e)}getOrAddOutgoingRoomKeyRequest(e){return this.backend.getOrAddOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequest(e){return this.backend.getOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequestByState(e){return this.backend.getOutgoingRoomKeyRequestByState(e)}getAllOutgoingRoomKeyRequestsByState(e){return this.backend.getAllOutgoingRoomKeyRequestsByState(e)}getOutgoingRoomKeyRequestsByTarget(e,t,s){return this.backend.getOutgoingRoomKeyRequestsByTarget(e,t,s)}updateOutgoingRoomKeyRequest(e,t,s){return this.backend.updateOutgoingRoomKeyRequest(e,t,s)}deleteOutgoingRoomKeyRequest(e,t){return this.backend.deleteOutgoingRoomKeyRequest(e,t)}getAccount(e,t){this.backend.getAccount(e,t)}storeAccount(e,t){this.backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this.backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,s){this.backend.getSecretStorePrivateKey(e,t,s)}storeCrossSigningKeys(e,t){this.backend.storeCrossSigningKeys(e,t)}storeSecretStorePrivateKey(e,t,s){this.backend.storeSecretStorePrivateKey(e,t,s)}countEndToEndSessions(e,t){this.backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,s,i){this.backend.getEndToEndSession(e,t,s,i)}getEndToEndSessions(e,t,s){this.backend.getEndToEndSessions(e,t,s)}getAllEndToEndSessions(e,t){this.backend.getAllEndToEndSessions(e,t)}storeEndToEndSession(e,t,s,i){this.backend.storeEndToEndSession(e,t,s,i)}storeEndToEndSessionProblem(e,t,s){return this.backend.storeEndToEndSessionProblem(e,t,s)}getEndToEndSessionProblem(e,t){return this.backend.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this.backend.filterOutNotifiedErrorDevices(e)}countEndToEndInboundGroupSessions(){return this.backend.countEndToEndInboundGroupSessions()}getEndToEndSessionsBatch(){return this.backend.getEndToEndSessionsBatch()}deleteEndToEndSessionsBatch(e){return this.backend.deleteEndToEndSessionsBatch(e)}getEndToEndInboundGroupSession(e,t,s,i){this.backend.getEndToEndInboundGroupSession(e,t,s,i)}getAllEndToEndInboundGroupSessions(e,t){this.backend.getAllEndToEndInboundGroupSessions(e,t)}addEndToEndInboundGroupSession(e,t,s,i){this.backend.addEndToEndInboundGroupSession(e,t,s,i)}storeEndToEndInboundGroupSession(e,t,s,i){this.backend.storeEndToEndInboundGroupSession(e,t,s,i)}storeEndToEndInboundGroupSessionWithheld(e,t,s,i){this.backend.storeEndToEndInboundGroupSessionWithheld(e,t,s,i)}getEndToEndInboundGroupSessionsBatch(){return this.backend.getEndToEndInboundGroupSessionsBatch()}deleteEndToEndInboundGroupSessionsBatch(e){return this.backend.deleteEndToEndInboundGroupSessionsBatch(e)}storeEndToEndDeviceData(e,t){this.backend.storeEndToEndDeviceData(e,t)}getEndToEndDeviceData(e,t){this.backend.getEndToEndDeviceData(e,t)}storeEndToEndRoom(e,t,s){this.backend.storeEndToEndRoom(e,t,s)}getEndToEndRooms(e,t){this.backend.getEndToEndRooms(e,t)}getSessionsNeedingBackup(e){return this.backend.getSessionsNeedingBackup(e)}countSessionsNeedingBackup(e){return this.backend.countSessionsNeedingBackup(e)}unmarkSessionsNeedingBackup(e,t){return this.backend.unmarkSessionsNeedingBackup(e,t)}markSessionsNeedingBackup(e,t){return this.backend.markSessionsNeedingBackup(e,t)}addSharedHistoryInboundGroupSession(e,t,s,i){this.backend.addSharedHistoryInboundGroupSession(e,t,s,i)}getSharedHistoryInboundGroupSessions(e,t){return this.backend.getSharedHistoryInboundGroupSessions(e,t)}addParkedSharedHistory(e,t,s){this.backend.addParkedSharedHistory(e,t,s)}takeParkedSharedHistory(e,t){return this.backend.takeParkedSharedHistory(e,t)}doTxn(e,t,s,i){return this.backend.doTxn(e,t,s,i)}}(0,i.A)(v,"STORE_ACCOUNT","account"),(0,i.A)(v,"STORE_SESSIONS","sessions"),(0,i.A)(v,"STORE_INBOUND_GROUP_SESSIONS","inbound_group_sessions"),(0,i.A)(v,"STORE_INBOUND_GROUP_SESSIONS_WITHHELD","inbound_group_sessions_withheld"),(0,i.A)(v,"STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS","shared_history_inbound_group_sessions"),(0,i.A)(v,"STORE_PARKED_SHARED_HISTORY","parked_shared_history"),(0,i.A)(v,"STORE_DEVICE_DATA","device_data"),(0,i.A)(v,"STORE_ROOMS","rooms"),(0,i.A)(v,"STORE_BACKUP","sessions_needing_backup")},"./node_modules/matrix-js-sdk/src/crypto/store/localStorage-crypto-store.ts":(e,t,s)=>{"use strict";s.d(t,{F:()=>w});var i=s("./node_modules/matrix-js-sdk/src/logger.ts"),n=s("./node_modules/matrix-js-sdk/src/crypto/store/memory-crypto-store.ts"),r=s("./node_modules/matrix-js-sdk/src/crypto/store/base.ts"),o=s("./node_modules/matrix-js-sdk/src/utils.ts");const a="crypto.",d=a+"migration",c=a+"account",l=a+"cross_signing_keys",u=a+"notified_error_devices",h=a+"device_data",m=a+"inboundgroupsessions/",p=a+"inboundgroupsessions.withheld/",g=a+"rooms/",v=a+"sessionsneedingbackup";function f(e){return a+"sessions/"+e}function y(e){return a+"session.problems/"+e}function S(e,t){return m+e+"/"+t}function b(e,t){return p+e+"/"+t}function E(e){return g+e}class w extends n._{static exists(e){const t=e.length;for(let i=0;i<t;i++){var s;if(null!==(s=e.key(i))&&void 0!==s&&s.startsWith(a))return!0}return!1}constructor(e){super(),this.store=e}async containsData(){return w.exists(this.store)}async getMigrationState(){var e;return null!==(e=I(this.store,d))&&void 0!==e?e:r.Il.NOT_STARTED}async setMigrationState(e){_(this.store,d,e)}countEndToEndSessions(e,t){let s=0;for(let e=0;e<this.store.length;++e){const t=this.store.key(e);if(null!=t&&t.startsWith(f(""))){const e=I(this.store,t);s+=Object.keys(null!=e?e:{}).length}}t(s)}_getEndToEndSessions(e){const t=I(this.store,f(e)),s={};for(const[e,i]of Object.entries(t||{}))s[e]="string"==typeof i?{session:i}:i;return s}getEndToEndSession(e,t,s,i){i(this._getEndToEndSessions(e)[t]||{})}getEndToEndSessions(e,t,s){s(this._getEndToEndSessions(e)||{})}getAllEndToEndSessions(e,t){for(let e=0;e<this.store.length;++e){var s;if(null!==(s=this.store.key(e))&&void 0!==s&&s.startsWith(f(""))){const s=this.store.key(e).split("/")[1];for(const e of Object.values(this._getEndToEndSessions(s)))t(e)}}}storeEndToEndSession(e,t,s,i){const n=this._getEndToEndSessions(e)||{};n[t]=s,_(this.store,f(e),n)}async storeEndToEndSessionProblem(e,t,s){const i=y(e),n=I(this.store,i)||[];n.push({type:t,fixed:s,time:Date.now()}),n.sort(((e,t)=>e.time-t.time)),_(this.store,i,n)}async getEndToEndSessionProblem(e,t){const s=y(e),i=I(this.store,s)||[];if(!i.length)return null;const n=i[i.length-1];for(const e of i)if(e.time>t)return Object.assign({},e,{fixed:n.fixed});return n.fixed?null:n}async filterOutNotifiedErrorDevices(e){const t=I(this.store,u)||{},s=[];for(const i of e){const{userId:e,deviceInfo:n}=i;e in t?n.deviceId in t[e]||(s.push(i),(0,o.C6)(t[e],n.deviceId,!0)):(s.push(i),(0,o.C6)(t,e,{[n.deviceId]:!0}))}return _(this.store,u,t),s}async getEndToEndSessionsBatch(){const e=[];for(let s=0;s<this.store.length;++s){var t;if(null!==(t=this.store.key(s))&&void 0!==t&&t.startsWith(f(""))){const t=this.store.key(s).split("/")[1];for(const s of Object.values(this._getEndToEndSessions(t)))if(e.push(s),e.length>=r.oT)return e}}return 0===e.length?null:e}async deleteEndToEndSessionsBatch(e){for(const{deviceKey:t,sessionId:s}of e){const e=this._getEndToEndSessions(t)||{};delete e[s],0===Object.keys(e).length?this.store.removeItem(f(t)):_(this.store,f(t),e)}}getEndToEndInboundGroupSession(e,t,s,i){i(I(this.store,S(e,t)),I(this.store,b(e,t)))}getAllEndToEndInboundGroupSessions(e,t){for(let e=0;e<this.store.length;++e){const s=this.store.key(e);null!=s&&s.startsWith(m)&&t({senderKey:s.slice(28,71),sessionId:s.slice(72),sessionData:I(this.store,s)})}t(null)}addEndToEndInboundGroupSession(e,t,s,i){I(this.store,S(e,t))||this.storeEndToEndInboundGroupSession(e,t,s,i)}storeEndToEndInboundGroupSession(e,t,s,i){_(this.store,S(e,t),s)}storeEndToEndInboundGroupSessionWithheld(e,t,s,i){_(this.store,b(e,t),s)}async countEndToEndInboundGroupSessions(){let e=0;for(let t=0;t<this.store.length;++t){const s=this.store.key(t);null!=s&&s.startsWith(m)&&(e+=1)}return e}async getEndToEndInboundGroupSessionsBatch(){const e=I(this.store,v)||{},t=[];for(let s=0;s<this.store.length;++s){const i=this.store.key(s);if(null!=i&&i.startsWith(m)){const s=i.slice(28);if(t.push({senderKey:s.slice(0,43),sessionId:s.slice(44),sessionData:I(this.store,i),needsBackup:s in e}),t.length>=r.oT)return t}}return 0===t.length?null:t}async deleteEndToEndInboundGroupSessionsBatch(e){for(const{senderKey:t,sessionId:s}of e){const e=S(t,s);this.store.removeItem(e)}}getEndToEndDeviceData(e,t){t(I(this.store,h))}storeEndToEndDeviceData(e,t){_(this.store,h,e)}storeEndToEndRoom(e,t,s){_(this.store,E(e),t)}getEndToEndRooms(e,t){const s={},i=E("");for(let e=0;e<this.store.length;++e){const t=this.store.key(e);if(null!=t&&t.startsWith(i)){s[t.slice(i.length)]=I(this.store,t)}}t(s)}getSessionsNeedingBackup(e){const t=I(this.store,v)||{},s=[];for(const i in t)if(Object.prototype.hasOwnProperty.call(t,i)){const t=i.slice(0,43),n=i.slice(44);if(this.getEndToEndInboundGroupSession(t,n,null,(e=>{s.push({senderKey:t,sessionId:n,sessionData:e})})),e&&s.length>=e)break}return Promise.resolve(s)}countSessionsNeedingBackup(){const e=I(this.store,v)||{};return Promise.resolve(Object.keys(e).length)}unmarkSessionsNeedingBackup(e){const t=I(this.store,v)||{};for(const s of e)delete t[s.senderKey+"/"+s.sessionId];return _(this.store,v,t),Promise.resolve()}markSessionsNeedingBackup(e){const t=I(this.store,v)||{};for(const s of e)t[s.senderKey+"/"+s.sessionId]=!0;return _(this.store,v,t),Promise.resolve()}deleteAllData(){return this.store.removeItem(c),Promise.resolve()}getAccount(e,t){t(I(this.store,c))}storeAccount(e,t){_(this.store,c,t)}getCrossSigningKeys(e,t){t(I(this.store,l))}getSecretStorePrivateKey(e,t,s){t(I(this.store,a+`ssss_cache.${s}`))}storeCrossSigningKeys(e,t){_(this.store,l,t)}storeSecretStorePrivateKey(e,t,s){_(this.store,a+`ssss_cache.${t}`,s)}doTxn(e,t,s){return Promise.resolve(s(null))}}function I(e,t){try{return JSON.parse(e.getItem(t))}catch(e){i.v.log("Error: Failed to get key %s: %s",t,e.message),i.v.log(e.stack)}return null}function _(e,t,s){e.setItem(t,JSON.stringify(s))}},"./node_modules/matrix-js-sdk/src/crypto/store/memory-crypto-store.ts":(e,t,s)=>{"use strict";s.d(t,{_:()=>u});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/logger.ts"),r=s("./node_modules/matrix-js-sdk/src/utils.ts"),o=s("./node_modules/matrix-js-sdk/src/crypto/store/base.ts");function a(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function d(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?a(Object(s),!0).forEach((function(t){(0,i.A)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):a(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}function c(e,t){return encodeURIComponent(e)+"/"+encodeURIComponent(t)}function l(e){const t=e.split("/");return{senderKey:decodeURIComponent(t[0]),sessionId:decodeURIComponent(t[1])}}class u{constructor(){(0,i.A)(this,"migrationState",o.Il.NOT_STARTED),(0,i.A)(this,"outgoingRoomKeyRequests",[]),(0,i.A)(this,"account",null),(0,i.A)(this,"crossSigningKeys",null),(0,i.A)(this,"privateKeys",{}),(0,i.A)(this,"sessions",{}),(0,i.A)(this,"sessionProblems",{}),(0,i.A)(this,"notifiedErrorDevices",{}),(0,i.A)(this,"inboundGroupSessions",{}),(0,i.A)(this,"inboundGroupSessionsWithheld",{}),(0,i.A)(this,"deviceData",null),(0,i.A)(this,"rooms",{}),(0,i.A)(this,"sessionsNeedingBackup",{}),(0,i.A)(this,"sharedHistoryInboundGroupSessions",{}),(0,i.A)(this,"parkedSharedHistory",new Map)}async containsData(){return null!==this.account}async startup(){return this}deleteAllData(){return Promise.resolve()}async getMigrationState(){return this.migrationState}async setMigrationState(e){this.migrationState=e}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return(0,r.j0)((()=>{const s=this._getOutgoingRoomKeyRequest(t);return s?(n.v.log(`already have key request outstanding for ${t.room_id} / ${t.session_id}: not sending another`),s):(n.v.log(`enqueueing key request for ${t.room_id} / `+t.session_id),this.outgoingRoomKeyRequests.push(e),e)}))}getOutgoingRoomKeyRequest(e){return Promise.resolve(this._getOutgoingRoomKeyRequest(e))}_getOutgoingRoomKeyRequest(e){for(const t of this.outgoingRoomKeyRequests)if((0,r.ky)(t.requestBody,e))return t;return null}getOutgoingRoomKeyRequestByState(e){for(const t of this.outgoingRoomKeyRequests)for(const s of e)if(t.state===s)return Promise.resolve(t);return Promise.resolve(null)}getAllOutgoingRoomKeyRequestsByState(e){return Promise.resolve(this.outgoingRoomKeyRequests.filter((t=>t.state==e)))}getOutgoingRoomKeyRequestsByTarget(e,t,s){const i=[];for(const n of this.outgoingRoomKeyRequests)for(const r of s)n.state===r&&n.recipients.some((s=>s.userId===e&&s.deviceId===t))&&i.push(n);return Promise.resolve(i)}updateOutgoingRoomKeyRequest(e,t,s){for(const i of this.outgoingRoomKeyRequests)if(i.requestId===e)return i.state!==t?(n.v.warn(`Cannot update room key request from ${t} as it was already updated to ${i.state}`),Promise.resolve(null)):(Object.assign(i,s),Promise.resolve(i));return Promise.resolve(null)}deleteOutgoingRoomKeyRequest(e,t){for(let s=0;s<this.outgoingRoomKeyRequests.length;s++){const i=this.outgoingRoomKeyRequests[s];if(i.requestId===e)return i.state!=t?(n.v.warn(`Cannot delete room key request in state ${i.state} (expected ${t})`),Promise.resolve(null)):(this.outgoingRoomKeyRequests.splice(s,1),Promise.resolve(i))}return Promise.resolve(null)}getAccount(e,t){t(this.account)}storeAccount(e,t){this.account=t}getCrossSigningKeys(e,t){t(this.crossSigningKeys)}getSecretStorePrivateKey(e,t,s){t(this.privateKeys[s]||null)}storeCrossSigningKeys(e,t){this.crossSigningKeys=t}storeSecretStorePrivateKey(e,t,s){this.privateKeys[t]=s}countEndToEndSessions(e,t){let s=0;for(const e of Object.values(this.sessions))s+=Object.keys(e).length;t(s)}getEndToEndSession(e,t,s,i){i((this.sessions[e]||{})[t]||null)}getEndToEndSessions(e,t,s){s(this.sessions[e]||{})}getAllEndToEndSessions(e,t){Object.entries(this.sessions).forEach((([e,s])=>{Object.entries(s).forEach((([s,i])=>{t(d(d({},i),{},{deviceKey:e,sessionId:s}))}))}))}storeEndToEndSession(e,t,s,i){let n=this.sessions[e];void 0===n&&(n={},this.sessions[e]=n),(0,r.C6)(n,t,s)}async storeEndToEndSessionProblem(e,t,s){const i=this.sessionProblems[e]=this.sessionProblems[e]||[];i.push({type:t,fixed:s,time:Date.now()}),i.sort(((e,t)=>e.time-t.time))}async getEndToEndSessionProblem(e,t){const s=this.sessionProblems[e]||[];if(!s.length)return null;const i=s[s.length-1];for(const e of s)if(e.time>t)return Object.assign({},e,{fixed:i.fixed});return i.fixed?null:i}async filterOutNotifiedErrorDevices(e){const t=this.notifiedErrorDevices,s=[];for(const i of e){const{userId:e,deviceInfo:n}=i;e in t?n.deviceId in t[e]||(s.push(i),(0,r.C6)(t[e],n.deviceId,!0)):(s.push(i),(0,r.C6)(t,e,{[n.deviceId]:!0}))}return s}async getEndToEndSessionsBatch(){const e=[];for(const t of Object.values(this.sessions))for(const s of Object.values(t))if(e.push(s),e.length>=o.oT)return e;return 0===e.length?null:e}async deleteEndToEndSessionsBatch(e){for(const{deviceKey:t,sessionId:s}of e){const e=this.sessions[t]||{};delete e[s],0===Object.keys(e).length&&delete this.sessions[t]}}getEndToEndInboundGroupSession(e,t,s,i){const n=c(e,t);i(this.inboundGroupSessions[n]||null,this.inboundGroupSessionsWithheld[n]||null)}getAllEndToEndInboundGroupSessions(e,t){for(const e of Object.keys(this.inboundGroupSessions))t(d(d({},l(e)),{},{sessionData:this.inboundGroupSessions[e]}));t(null)}addEndToEndInboundGroupSession(e,t,s,i){const n=c(e,t);void 0===this.inboundGroupSessions[n]&&(this.inboundGroupSessions[n]=s)}storeEndToEndInboundGroupSession(e,t,s,i){const n=c(e,t);this.inboundGroupSessions[n]=s}storeEndToEndInboundGroupSessionWithheld(e,t,s,i){const n=c(e,t);this.inboundGroupSessionsWithheld[n]=s}async countEndToEndInboundGroupSessions(){return Object.keys(this.inboundGroupSessions).length}async getEndToEndInboundGroupSessionsBatch(){const e=[];for(const[t,s]of Object.entries(this.inboundGroupSessions))if(e.push(d(d({},l(t)),{},{sessionData:s,needsBackup:t in this.sessionsNeedingBackup})),e.length>=o.oT)return e;return 0===e.length?null:e}async deleteEndToEndInboundGroupSessionsBatch(e){for(const{senderKey:t,sessionId:s}of e){const e=c(t,s);delete this.inboundGroupSessions[e]}}getEndToEndDeviceData(e,t){t(this.deviceData)}storeEndToEndDeviceData(e,t){this.deviceData=e}storeEndToEndRoom(e,t,s){this.rooms[e]=t}getEndToEndRooms(e,t){t(this.rooms)}getSessionsNeedingBackup(e){const t=[];for(const s in this.sessionsNeedingBackup)if(this.inboundGroupSessions[s]&&(t.push(d(d({},l(s)),{},{sessionData:this.inboundGroupSessions[s]})),e&&s.length>=e))break;return Promise.resolve(t)}countSessionsNeedingBackup(){return Promise.resolve(Object.keys(this.sessionsNeedingBackup).length)}unmarkSessionsNeedingBackup(e){for(const t of e){const e=c(t.senderKey,t.sessionId);delete this.sessionsNeedingBackup[e]}return Promise.resolve()}markSessionsNeedingBackup(e){for(const t of e){const e=c(t.senderKey,t.sessionId);this.sessionsNeedingBackup[e]=!0}return Promise.resolve()}addSharedHistoryInboundGroupSession(e,t,s){const i=this.sharedHistoryInboundGroupSessions[e]||[];i.push([t,s]),this.sharedHistoryInboundGroupSessions[e]=i}getSharedHistoryInboundGroupSessions(e){return Promise.resolve(this.sharedHistoryInboundGroupSessions[e]||[])}addParkedSharedHistory(e,t){var s;const i=null!==(s=this.parkedSharedHistory.get(e))&&void 0!==s?s:[];i.push(t),this.parkedSharedHistory.set(e,i)}takeParkedSharedHistory(e){var t;const s=null!==(t=this.parkedSharedHistory.get(e))&&void 0!==t?t:[];return this.parkedSharedHistory.delete(e),Promise.resolve(s)}doTxn(e,t,s){return Promise.resolve(s(null))}}},"./node_modules/matrix-js-sdk/src/crypto/verification/SASDecimal.ts":(e,t,s)=>{"use strict";function i(e){return[1e3+(e[0]<<5|e[1]>>3),1e3+((7&e[1])<<10|e[2]<<2|e[3]>>6),1e3+((63&e[3])<<7|e[4]>>1)]}s.d(t,{c:()=>i})},"./node_modules/matrix-js-sdk/src/digest.ts":(e,t,s)=>{"use strict";async function i(e){if(!globalThis.crypto.subtle)throw new Error("Crypto.subtle is not available: insecure context?");const t=(new TextEncoder).encode(e);return await globalThis.crypto.subtle.digest("SHA-256",t)}s.d(t,{s:()=>i})},"./node_modules/matrix-js-sdk/src/errors.ts":(e,t,s)=>{"use strict";s.d(t,{E5:()=>r,LA:()=>a,b0:()=>o,hP:()=>n});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js");let n=function(e){return e.TooNew="TOO_NEW",e}({});class r extends Error{constructor(e){super(`Crypto store is invalid because ${e}, please stop the client, delete all data and start the client again`),this.reason=e,this.name="InvalidCryptoStoreError"}}(0,i.A)(r,"TOO_NEW",n.TooNew);class o extends Error{constructor(e,t){super(e),this.value=t}}class a extends Error{constructor(){super("MatrixClient has been stopped")}}},"./node_modules/matrix-js-sdk/src/extensible_events_v1/utilities.ts":(e,t,s)=>{"use strict";function i(e){return null!=e}s.d(t,{c:()=>i})},"./node_modules/matrix-js-sdk/src/feature.ts":(e,t,s)=>{"use strict";s.d(t,{Tj:()=>i,Xj:()=>n,yk:()=>o});let i=function(e){return e[e.Stable=0]="Stable",e[e.Unstable=1]="Unstable",e[e.Unsupported=2]="Unsupported",e}({}),n=function(e){return e.Thread="Thread",e.ThreadUnreadNotifications="ThreadUnreadNotifications",e.LoginTokenRequest="LoginTokenRequest",e.RelationBasedRedactions="RelationBasedRedactions",e.AccountDataDeletion="AccountDataDeletion",e.RelationsRecursion="RelationsRecursion",e.IntentionalMentions="IntentionalMentions",e}({});const r={[n.Thread]:{unstablePrefixes:["org.matrix.msc3440"],matrixVersion:"v1.3"},[n.ThreadUnreadNotifications]:{unstablePrefixes:["org.matrix.msc3771","org.matrix.msc3773"],matrixVersion:"v1.4"},[n.LoginTokenRequest]:{unstablePrefixes:["org.matrix.msc3882"]},[n.RelationBasedRedactions]:{unstablePrefixes:["org.matrix.msc3912"]},[n.AccountDataDeletion]:{unstablePrefixes:["org.matrix.msc3391"]},[n.RelationsRecursion]:{unstablePrefixes:["org.matrix.msc3981"]},[n.IntentionalMentions]:{unstablePrefixes:["org.matrix.msc3952_intentional_mentions"],matrixVersion:"v1.7"}};async function o(e){const t=new Map;for(const[d,c]of Object.entries(r)){var s,n,o,a;const r=null!==(s=null===(n=e.versions)||void 0===n?void 0:n.includes(c.matrixVersion||""))&&void 0!==s&&s,l=null!==(o=null===(a=c.unstablePrefixes)||void 0===a?void 0:a.every((t=>{var s;return!0===(null===(s=e.unstable_features)||void 0===s?void 0:s[t])})))&&void 0!==o&&o;r?t.set(d,i.Stable):l?t.set(d,i.Unstable):t.set(d,i.Unsupported)}return t}},"./node_modules/matrix-js-sdk/src/filter.ts":(e,t,s)=>{"use strict";s.d(t,{d:()=>l});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/@types/sync.ts"),r=s("./node_modules/matrix-js-sdk/src/models/thread.ts");class o{constructor(e,t){this.filterJson=e,this.userId=t}check(e){var t,s;const i=(null===(t=e.getUnsigned())||void 0===t?void 0:t["m.relations"])||{},n=Object.keys(i),o=[];return this.userId&&null!=i&&null!==(s=i[r.RN.name])&&void 0!==s&&s.current_user_participated&&o.push(this.userId),this.checkFields(e.getRoomId(),e.getSender(),e.getType(),!!e.getContent()&&void 0!==e.getContent().url,n,o)}toJSON(){return{types:this.filterJson.types||null,not_types:this.filterJson.not_types||[],rooms:this.filterJson.rooms||null,not_rooms:this.filterJson.not_rooms||[],senders:this.filterJson.senders||null,not_senders:this.filterJson.not_senders||[],contains_url:this.filterJson.contains_url||null,[r.o1.name]:this.filterJson[r.o1.name]||[],[r.H.name]:this.filterJson[r.H.name]||[]}}checkFields(e,t,s,i,n,o){const a={rooms:function(t){return e===t},senders:function(e){return t===e},types:function(e){return function(e,t){if(t.endsWith("*")){const s=t.slice(0,-1);return e.slice(0,s.length)===s}return e===t}(s,e)}};for(const e in a){const t=a[e],s="not_"+e,i=this.filterJson[s];if(null!=i&&i.some(t))return!1;const n=this.filterJson[e];if(n&&!n.some(t))return!1}const d=this.filterJson.contains_url;if(void 0!==d&&d!==i)return!1;const c=this.filterJson[r.H.name];if(void 0!==c&&!this.arrayMatchesFilter(c,n))return!1;const l=this.filterJson[r.o1.name];return!(void 0!==l&&!this.arrayMatchesFilter(l,o))}arrayMatchesFilter(e,t){return t.length>0&&e.every((e=>t.includes(e)))}filter(e){return e.filter(this.check,this)}limit(){return void 0!==this.filterJson.limit?this.filterJson.limit:10}}function a(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function d(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?a(Object(s),!0).forEach((function(t){(0,i.A)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):a(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}function c(e,t,s){const i=t.split(".");let n=e;for(let e=0;e<i.length-1;e++)n[i[e]]||(n[i[e]]={}),n=n[i[e]];n[i[i.length-1]]=s}class l{static fromJson(e,t,s){const i=new l(e,t);return i.setDefinition(s),i}constructor(e,t){(0,i.A)(this,"definition",{}),(0,i.A)(this,"roomFilter",void 0),(0,i.A)(this,"roomTimelineFilter",void 0),this.userId=e,this.filterId=t}getFilterId(){return this.filterId}getDefinition(){return this.definition}setDefinition(e){this.definition=e;const t=e.room,s={};t&&(t.rooms&&(s.rooms=t.rooms),t.rooms&&(s.not_rooms=t.not_rooms)),this.roomFilter=new o(s,this.userId),this.roomTimelineFilter=new o((null==t?void 0:t.timeline)||{},this.userId)}getRoomTimelineFilterComponent(){return this.roomTimelineFilter}filterRoomTimeline(e){return this.roomFilter&&(e=this.roomFilter.filter(e)),this.roomTimelineFilter&&(e=this.roomTimelineFilter.filter(e)),e}setTimelineLimit(e){c(this.definition,"room.timeline.limit",e)}setUnreadThreadNotifications(e){var t,s;this.definition=d(d({},this.definition),{},{room:d(d({},null===(t=this.definition)||void 0===t?void 0:t.room),{},{timeline:d(d({},null===(s=this.definition)||void 0===s||null===(s=s.room)||void 0===s?void 0:s.timeline),{},{[n.a.name]:e})})})}setLazyLoadMembers(e){c(this.definition,"room.state.lazy_load_members",e)}setIncludeLeaveRooms(e){c(this.definition,"room.include_leave",e)}}(0,i.A)(l,"LAZY_LOADING_MESSAGES_FILTER",{lazy_load_members:!0})},"./node_modules/matrix-js-sdk/src/http-api/index.ts":(e,t,s)=>{"use strict";s.d(t,{iD:()=>b,Pw:()=>E,up:()=>a,ED:()=>x,zs:()=>w,IT:()=>r,fZ:()=>v,Y6:()=>g,_:()=>h});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/utils.ts");let r=function(e){return e.Get="GET",e.Put="PUT",e.Post="POST",e.Delete="DELETE",e.Options="OPTIONS",e.Head="HEAD",e.Patch="PATCH",e}({});class o extends Error{constructor(e,t){super(e),this.httpStatus=t}}class a extends o{constructor(e={},t,s,n){let r=e.error||"Unknown message";t&&(r=`[${t}] ${r}`),s&&(r=`${r} (${s})`),super(`MatrixError: ${r}`,t),(0,i.A)(this,"errcode",void 0),(0,i.A)(this,"data",void 0),this.httpStatus=t,this.url=s,this.event=n,this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.data=e}}class d extends Error{constructor(e,t){super(e+(t?`: ${t.message}`:""))}get name(){return"ConnectionError"}}let c=function(e){return e.SessionLoggedOut="Session.logged_out",e.NoConsent="no_consent",e}({});var l=s("./node_modules/content-type/index.js"),u=s("./node_modules/matrix-js-sdk/src/logger.ts");function h(e){const t=new AbortController;return setTimeout((()=>{t.abort()}),e),t.signal}function m(e,t){var s,i;let n;try{n=function(e){let t;t=p(e)?e.getResponseHeader("Content-Type"):e.headers.get("Content-Type");if(!t)return null;try{return(0,l.q)(t)}catch(e){throw new Error(`Error parsing Content-Type '${t}': ${e}`)}}(e)}catch(e){return e}return"application/json"===(null===(s=n)||void 0===s?void 0:s.type)&&t?new a(JSON.parse(t),e.status,p(e)?e.responseURL:e.url):"text/plain"===(null===(i=n)||void 0===i?void 0:i.type)?new o(`Server returned ${e.status} error: ${t}`,e.status):new o(`Server returned ${e.status} error`,e.status)}function p(e){return"getResponseHeader"in e}async function g(e,t){let s=0,i=null;for(;s<e;)try{if(s>0){const e=1e3*Math.pow(2,s);u.v.log(`network operation failed ${s} times, retrying in ${e}ms...`),await(0,n.yy)(e)}return await t()}catch(e){if(!(e instanceof d))throw e;s+=1,i=e}throw i}function v(e,t,s){if(t>4)return-1;if(e instanceof d&&!s)return-1;if(e.httpStatus&&(400===e.httpStatus||403===e.httpStatus||401===e.httpStatus))return-1;if("AbortError"===e.name)return-1;if("M_TOO_LARGE"===e.name)return-1;if("M_LIMIT_EXCEEDED"===e.name){const t=e.data.retry_after_ms;if(t>0)return t}return 1e3*Math.pow(2,t)}function f(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function y(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?f(Object(s),!0).forEach((function(t){(0,i.A)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):f(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class S{constructor(e,t){var s;(0,i.A)(this,"abortController",new AbortController),this.eventEmitter=e,this.opts=t,(0,n.UB)(t,["baseUrl","prefix"]),t.onlyData=!!t.onlyData,t.useAuthorizationHeader=null===(s=t.useAuthorizationHeader)||void 0===s||s}abort(){this.abortController.abort(),this.abortController=new AbortController}fetch(e,t){return this.opts.fetchFn?this.opts.fetchFn(e,t):s.g.fetch(e,t)}setIdBaseUrl(e){this.opts.idBaseUrl=e}idServerRequest(e,t,s,i,n){if(!this.opts.idBaseUrl)throw new Error("No identity server base URL set");let o,a;e===r.Get?o=s:a=s;const d=this.getUrl(t,o,i,this.opts.idBaseUrl),c={json:!0,headers:{}};return n&&(c.headers.Authorization=`Bearer ${n}`),this.requestOtherUrl(e,d,a,c)}async authedRequest(e,t,s,i,n={}){s||(s={});const r=y({},n);this.opts.accessToken&&(this.opts.useAuthorizationHeader?(r.headers||(r.headers={}),r.headers.Authorization||(r.headers.Authorization="Bearer "+this.opts.accessToken),s.access_token&&delete s.access_token):s.access_token||(s.access_token=this.opts.accessToken));try{return await this.request(e,t,s,i,r)}catch(o){const a=o;if("M_UNKNOWN_TOKEN"===a.errcode&&!r.doNotAttemptTokenRefresh){if(await this.tryRefreshToken())return this.authedRequest(e,t,s,i,y(y({},n),{},{doNotAttemptTokenRefresh:!0}))}throw"M_UNKNOWN_TOKEN"!=a.errcode||null!=r&&r.inhibitLogoutEmit?"M_CONSENT_NOT_GIVEN"==a.errcode&&this.eventEmitter.emit(c.NoConsent,a.message,a.data.consent_uri):this.eventEmitter.emit(c.SessionLoggedOut,a),a}}async tryRefreshToken(){if(!this.opts.refreshToken||!this.opts.tokenRefreshFunction)return!1;try{const{accessToken:e,refreshToken:t}=await this.opts.tokenRefreshFunction(this.opts.refreshToken);return this.opts.accessToken=e,this.opts.refreshToken=t,!0}catch(t){var e;return null===(e=this.opts.logger)||void 0===e||e.warn("Failed to refresh token",t),!1}}request(e,t,s,i,n){const r=this.getUrl(t,s,null==n?void 0:n.prefix,null==n?void 0:n.baseUrl);return this.requestOtherUrl(e,r,i,n)}async requestOtherUrl(e,t,s,i={}){var n,r,o,a,c;const l=this.sanitizeUrlForLogs(t);null===(n=this.opts.logger)||void 0===n||n.debug(`FetchHttpApi: --\x3e ${e} ${l}`);const u=Object.assign({},i.headers||{}),p=null===(r=i.json)||void 0===r||r,g=p&&(null==s||null===(o=s.constructor)||void 0===o?void 0:o.name)===Object.name;p&&(g&&!u["Content-Type"]&&(u["Content-Type"]="application/json"),u.Accept||(u.Accept="application/json"));const v=null!==(a=i.localTimeoutMs)&&void 0!==a?a:this.opts.localTimeoutMs,f=null!==(c=i.keepAlive)&&void 0!==c&&c,y=[this.abortController.signal];let S;void 0!==v&&y.push(h(v)),i.abortSignal&&y.push(i.abortSignal),S=g?JSON.stringify(s):s;const{signal:b,cleanup:E}=function(e){const t=new AbortController;function s(){for(const t of e)t.removeEventListener("abort",i)}function i(){t.abort(),s()}for(const t of e){if(t.aborted){i();break}t.addEventListener("abort",i)}return{signal:t.signal,cleanup:s}}(y);let w;const I=Date.now();try{var _;w=await this.fetch(t,{signal:b,method:e,body:S,headers:u,mode:"cors",redirect:"follow",referrer:"",referrerPolicy:"no-referrer",cache:"no-cache",credentials:"omit",keepalive:f,priority:i.priority}),null===(_=this.opts.logger)||void 0===_||_.debug(`FetchHttpApi: <-- ${e} ${l} [${Date.now()-I}ms ${w.status}]`)}catch(t){var k;if(null===(k=this.opts.logger)||void 0===k||k.debug(`FetchHttpApi: <-- ${e} ${l} [${Date.now()-I}ms ${t}]`),"AbortError"===t.name)throw t;throw new d("fetch failed",t)}finally{E()}if(!w.ok)throw m(w,await w.text());return this.opts.onlyData?p?w.json():w.text():w}sanitizeUrlForLogs(e){try{let t;t="string"==typeof e?new URL(e):e;const s=new URLSearchParams;for(const e of t.searchParams.keys())s.append(e,"xxx");const i=s.toString(),n=i?`?${i}`:"";return t.origin+t.pathname+n}catch(e){return"??"}}getUrl(e,t,s,i){const r=null!=i?i:this.opts.baseUrl,o=r.endsWith("/")?r.slice(0,-1):r,a=new URL(o+(null!=s?s:this.opts.prefix)+e);return t&&(0,n.hm)(t,a.searchParams),a}}let b=function(e){return e.V1="/_matrix/client/v1",e.V3="/_matrix/client/v3",e.Unstable="/_matrix/client/unstable",e}({}),E=function(e){return e.V2="/_matrix/identity/v2",e}({}),w=function(e){return e.V1="/_matrix/media/v1",e.V3="/_matrix/media/v3",e}({});const I=1e3;let _,k=0;const R=[],T=function(...e){};function C(e,t,...s){(t=t||0)<0&&(t=0);const i=Date.now()+t,n=k++;T("setTimeout: scheduling cb",n,"at",i,"(delay",t,")");const r={runAt:i,func:e,params:s,key:n},o=function(e,t){let s=0,i=e.length;for(;s<i;){const n=s+i>>1;t(e[n])>0?i=n:s=n+1}return s}(R,(function(e){return e.runAt-i}));return R.splice(o,0,r),O(),n}function A(e){if(0===R.length)return;let t;for(t=0;t<R.length;t++){if(R[t].key==e){R.splice(t,1);break}}0===t&&O()}function O(){_&&s.g.clearTimeout(_);const e=R[0];if(!e)return void T("scheduleRealCallback: no more callbacks, not rescheduling");const t=Date.now(),i=Math.min(e.runAt-t,I);T("scheduleRealCallback: now:",t,"delay:",i),_=s.g.setTimeout(M,i)}function M(){const e=Date.now();T("runCallbacks: now:",e);const t=[];for(;;){const s=R[0];if(!s||s.runAt>e)break;const i=R.shift();T("runCallbacks: popping",i.key),t.push(i)}O();for(const e of t)try{e.func.apply(s.g,e.params)}catch(e){u.v.error("Uncaught exception in callback function",e)}}class x extends S{constructor(...e){super(...e),(0,i.A)(this,"uploads",[])}uploadContent(e,t={}){var i,o,a,c;const l=null===(i=t.includeFilename)||void 0===i||i,u=null!==(o=t.abortController)&&void 0!==o?o:new AbortController,h=(null!==(a=t.type)&&void 0!==a?a:e.type)||"application/octet-stream",p=null!==(c=t.name)&&void 0!==c?c:e.name,g={loaded:0,total:0,abortController:u},v=(0,n.v6)();if(s.g.XMLHttpRequest){const i=new s.g.XMLHttpRequest,n=function(){i.abort(),v.reject(new Error("Timeout"))};let o=C(n,3e4);i.onreadystatechange=function(){if(i.readyState===s.g.XMLHttpRequest.DONE){A(o);try{if(0===i.status)throw new DOMException(i.statusText,"AbortError");if(!i.responseText)throw new Error("No response body.");i.status>=400?v.reject(m(i,i.responseText)):v.resolve(JSON.parse(i.responseText))}catch(e){if("AbortError"===e.name)return void v.reject(e);v.reject(new d("request failed",e))}}},i.upload.onprogress=e=>{var s;A(o),g.loaded=e.loaded,g.total=e.total,o=C(n,3e4),null===(s=t.progressHandler)||void 0===s||s.call(t,{loaded:e.loaded,total:e.total})};const a=this.getUrl("/upload",void 0,w.V3);l&&p&&a.searchParams.set("filename",encodeURIComponent(p)),!this.opts.useAuthorizationHeader&&this.opts.accessToken&&a.searchParams.set("access_token",encodeURIComponent(this.opts.accessToken)),i.open(r.Post,a.href),this.opts.useAuthorizationHeader&&this.opts.accessToken&&i.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),i.setRequestHeader("Content-Type",h),i.send(e),u.signal.addEventListener("abort",(()=>{i.abort()}))}else{const t={};l&&p&&(t.filename=p);const s={"Content-Type":h};this.authedRequest(r.Post,"/upload",t,e,{prefix:w.V3,headers:s,abortSignal:u.signal}).then((e=>this.opts.onlyData?e:e.json())).then(v.resolve,v.reject)}return g.promise=v.promise.finally((()=>{(0,n.Nz)(this.uploads,(e=>e===g))})),u.signal.addEventListener("abort",(()=>{(0,n.Nz)(this.uploads,(e=>e===g)),v.reject(new DOMException("Aborted","AbortError"))})),this.uploads.push(g),g.promise}cancelUpload(e){const t=this.uploads.find((t=>t.promise===e));return!!t&&(t.abortController.abort(),!0)}getCurrentUploads(){return this.uploads}getContentUri(){return{base:this.opts.baseUrl,path:w.V3+"/upload",params:{access_token:this.opts.accessToken}}}}},"./node_modules/matrix-js-sdk/src/indexeddb-helpers.ts":(e,t,s)=>{"use strict";function i(e,t){return new Promise(((s,i)=>{let n=!0;const r=e.open(t);r.onupgradeneeded=()=>{n=!1},r.onblocked=()=>i(r.error),r.onsuccess=()=>{r.result.close(),n||e.deleteDatabase(t),s(n)},r.onerror=()=>i(r.error)}))}s.d(t,{t:()=>i})},"./node_modules/matrix-js-sdk/src/logger.ts":(e,t,s)=>{"use strict";s.d(t,{T:()=>c,v:()=>d});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/loglevel/lib/loglevel.js"),r=s.n(n);const o="matrix";function a(e){const t=e;t.getChild=t.withPrefix=function(e){return function(e){const t=r().getLogger(`${o}-${e}`);t.prefix!==e&&(a(t),t.prefix=e,t.setLevel(r().levels.DEBUG,!1));return t}((this.prefix||"")+e)}}r().methodFactory=function(e,t,s){return function(...t){this.prefix&&t.unshift(this.prefix);return"error"===e||"warn"===e||"trace"===e||"info"===e||"debug"===e?console[e](...t):console.log(...t)}};const d=r().getLogger(o);d.setLevel(r().levels.DEBUG,!1),a(d);class c{constructor(e,t){(0,i.A)(this,"name",void 0),this.parent=e,this.name=t+":"}trace(...e){this.parent.trace(this.name,...e)}debug(...e){this.parent.debug(this.name,...e)}info(...e){this.parent.info(this.name,...e)}warn(...e){this.parent.warn(this.name,...e)}error(...e){this.parent.error(this.name,...e)}}},"./node_modules/matrix-js-sdk/src/matrixrtc/CallMembership.ts":(e,t,s)=>{"use strict";s.d(t,{_D:()=>o,pK:()=>a});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/utils.ts"),r=s("./node_modules/matrix-js-sdk/src/matrixrtc/LivekitFocus.ts");const o=e=>"membershipID"in e;class a{static equal(e,t){return(0,n.ky)(e.membershipData,t.membershipData)}constructor(e,t){(0,i.A)(this,"membershipData",void 0),this.parentEvent=e;const s=[],n=[];if(!((e,t)=>{var s;const i="Malformed session membership event: ";return"string"!=typeof e.device_id&&t.push(i+"device_id must be string"),"string"!=typeof e.call_id&&t.push(i+"call_id must be string"),"string"!=typeof e.application&&t.push(i+"application must be a string"),"string"!=typeof(null===(s=e.focus_active)||void 0===s?void 0:s.type)&&t.push(i+"focus_active.type must be a string"),Array.isArray(e.foci_preferred)||t.push(i+"foci_preferred must be an array"),e.created_ts&&"number"!=typeof e.created_ts&&t.push(i+"created_ts must be number"),e.scope&&"string"!=typeof e.scope&&t.push(i+"scope must be string"),0===t.length})(t,s)&&!((e,t)=>{const s="Malformed legacy rtc membership event: ";return"expires"in e||"expires_ts"in e||t.push(s+"expires_ts or expires must be present"),"expires"in e&&"number"!=typeof e.expires&&t.push(s+"expires must be numeric"),"expires_ts"in e&&"number"!=typeof e.expires_ts&&t.push(s+"expires_ts must be numeric"),"string"!=typeof e.device_id&&t.push(s+"device_id must be string"),"string"!=typeof e.call_id&&t.push(s+"call_id must be string"),"string"!=typeof e.application&&t.push(s+"application must be a string"),"string"!=typeof e.membershipID&&t.push(s+"membershipID must be a string"),e.created_ts&&"number"!=typeof e.created_ts&&t.push(s+"created_ts must be number"),e.scope&&"string"!=typeof e.scope&&t.push(s+"scope must be string"),0===t.length})(t,n))throw Error(`unknown CallMembership data. Does not match legacy call.member (${n.join(" & ")}) events nor MSC4143 (${s.join(" & ")})`);this.membershipData=t}get sender(){return this.parentEvent.getSender()}get eventId(){return this.parentEvent.getId()}get callId(){return this.membershipData.call_id}get deviceId(){return this.membershipData.device_id}get application(){return this.membershipData.application}get scope(){return this.membershipData.scope}get membershipID(){return o(this.membershipData)?this.membershipData.membershipID:this.createdTs().toString()}createdTs(){var e;return null!==(e=this.membershipData.created_ts)&&void 0!==e?e:this.parentEvent.getTs()}getAbsoluteExpiry(){if(o(this.membershipData))return"expires"in this.membershipData?this.createdTs()+this.membershipData.expires:this.membershipData.expires_ts}getLocalExpiry(){if(o(this.membershipData)){if("expires"in this.membershipData){const e=this.parentEvent.getTs()-this.createdTs();return this.parentEvent.localTimestamp-e+this.membershipData.expires}return this.membershipData.expires_ts}}getMsUntilExpiry(){if(o(this.membershipData))return this.getAbsoluteExpiry()-Date.now()}isExpired(){return!!o(this.membershipData)&&this.getMsUntilExpiry()<=0}getPreferredFoci(){var e;return o(this.membershipData)?null!==(e=this.membershipData.foci_active)&&void 0!==e?e:[]:this.membershipData.foci_preferred}getFocusSelection(){if(o(this.membershipData))return"oldest_membership";{const e=this.membershipData.focus_active;if((0,r.vv)(e))return e.focus_selection}}}},"./node_modules/matrix-js-sdk/src/matrixrtc/LivekitFocus.ts":(e,t,s)=>{"use strict";s.d(t,{vv:()=>i});const i=e=>"livekit"===e.type&&"focus_selection"in e},"./node_modules/matrix-js-sdk/src/matrixrtc/MatrixRTCSession.ts":(e,t,s)=>{"use strict";s.d(t,{n:()=>w});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/logger.ts"),r=s("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),o=s("./node_modules/matrix-js-sdk/src/models/event-timeline.ts"),a=s("./node_modules/matrix-js-sdk/src/@types/event.ts"),d=s("./node_modules/matrix-js-sdk/src/@types/requests.ts"),c=s("./node_modules/matrix-js-sdk/src/matrixrtc/CallMembership.ts"),l=s("./node_modules/matrix-js-sdk/src/models/room-state.ts"),u=s("./node_modules/matrix-js-sdk/src/randomstring.ts"),h=s("./node_modules/matrix-js-sdk/src/base64.ts"),m=s("./node_modules/matrix-js-sdk/src/@types/membership.ts"),p=s("./node_modules/matrix-js-sdk/src/matrixrtc/LivekitFocus.ts");function g(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}const v=n.v.getChild("MatrixRTCSession"),f=36e5,y=12e4,S=(e,t)=>`${e}:${t}`,b=e=>S(e.sender,e.deviceId);let E=function(e){return e.MembershipsChanged="memberships_changed",e.JoinStateChanged="join_state_changed",e.EncryptionKeyChanged="encryption_key_changed",e}({});class w extends r.X{get callId(){return this._callId}static callMembershipsForRoom(e){const t=e.getLiveTimeline().getState(o.q.FORWARDS);if(!t)throw v.warn("Couldn't get state for room "+e.roomId),new Error("Could't get state for room "+e.roomId);const s=t.getStateEvents(a.Bx.GroupCallMemberPrefix),i=[];for(const t of s){const s=t.getContent(),r=Object.keys(s).length;if(0===r)continue;let o=[];if(r>1&&"focus_active"in s)o.push(s);else if(1===r&&"memberships"in s){if(!Array.isArray(s.memberships)){v.warn(`Malformed member event from ${t.getSender()}: memberships is not an array`);continue}o=s.memberships}if(0!==o.length)for(const s of o)try{var n;const r=new c.pK(t,s);if(""!==r.callId||"m.room"!==r.scope){v.info("Ignoring user-scoped call");continue}if(r.isExpired()){v.info(`Ignoring expired device membership ${r.sender}/${r.deviceId}`);continue}if(!e.hasMembershipState(null!==(n=r.sender)&&void 0!==n?n:"",m.O.Join)){v.info(`Ignoring membership of user ${r.sender} who is not in the room.`);continue}i.push(r)}catch(e){v.warn("Couldn't construct call membership: ",e)}}return i.sort(((e,t)=>e.createdTs()-t.createdTs())),i.length>1&&v.debug(`Call memberships in room ${e.roomId}, in order: `,i.map((e=>[e.createdTs(),e.sender]))),i}static roomSessionForRoom(e,t){const s=w.callMembershipsForRoom(t);return new w(e,t,s)}constructor(e,t,s){var n;super(),(0,i.A)(this,"_callId",void 0),(0,i.A)(this,"relativeExpiry",void 0),(0,i.A)(this,"membershipId",void 0),(0,i.A)(this,"memberEventTimeout",void 0),(0,i.A)(this,"expiryTimeout",void 0),(0,i.A)(this,"keysEventUpdateTimeout",void 0),(0,i.A)(this,"makeNewKeyTimeout",void 0),(0,i.A)(this,"setNewKeyTimeouts",new Set),(0,i.A)(this,"ownFocusActive",void 0),(0,i.A)(this,"ownFociPreferred",void 0),(0,i.A)(this,"updateCallMembershipRunning",!1),(0,i.A)(this,"needCallMembershipUpdate",!1),(0,i.A)(this,"manageMediaKeys",!1),(0,i.A)(this,"useLegacyMemberEvents",!0),(0,i.A)(this,"encryptionKeys",new Map),(0,i.A)(this,"lastEncryptionKeyUpdateRequest",void 0),(0,i.A)(this,"lastMembershipFingerprints",void 0),(0,i.A)(this,"currentEncryptionKeyIndex",-1),(0,i.A)(this,"statistics",{counters:{roomEventEncryptionKeysSent:0,roomEventEncryptionKeysReceived:0},totals:{roomEventEncryptionKeysReceivedTotalAge:0}}),(0,i.A)(this,"sendEncryptionKeysEvent",(async e=>{if(void 0!==this.keysEventUpdateTimeout&&(clearTimeout(this.keysEventUpdateTimeout),this.keysEventUpdateTimeout=void 0),this.lastEncryptionKeyUpdateRequest=Date.now(),!this.isJoined())return;v.info(`Sending encryption keys event. indexToSend=${e}`);const t=this.client.getUserId(),s=this.client.getDeviceId();if(!t)throw new Error("No userId");if(!s)throw new Error("No deviceId");const i=this.getKeysForParticipant(t,s);if(!i)return void v.warn("Tried to send encryption keys event but no keys found!");if("number"!=typeof e&&-1===this.currentEncryptionKeyIndex)return void v.warn("Tried to send encryption keys event but no current key index found!");const n=null!=e?e:this.currentEncryptionKeyIndex,r=i[n];try{const e={keys:[{index:n,key:(0,h.PP)(r)}],device_id:s,call_id:"",sent_ts:Date.now()};this.statistics.counters.roomEventEncryptionKeysSent+=1,await this.client.sendEvent(this.room.roomId,a.Bx.CallEncryptionKeysPrefix,e),v.debug(`Embedded-E2EE-LOG updateEncryptionKeyEvent participantId=${t}:${s} numKeys=${i.length} currentKeyIndex=${this.currentEncryptionKeyIndex} keyIndexToSend=${n}`,this.encryptionKeys)}catch(e){const t=e;if(t.event&&this.client.cancelPendingEvent(t.event),void 0===this.keysEventUpdateTimeout){var o,d;const s=null!==(o=null===(d=t.data)||void 0===d?void 0:d.retry_after_ms)&&void 0!==o?o:5e3;v.warn(`Failed to send m.call.encryption_key, retrying in ${s}`,e),this.keysEventUpdateTimeout=setTimeout(this.sendEncryptionKeysEvent,s)}else v.info("Not scheduling key resend as another re-send is already pending")}})),(0,i.A)(this,"onCallEncryption",(e=>{const t=e.getSender(),s=e.getContent(),i=s.device_id,n=s.call_id;if(!t)return void v.warn(`Received m.call.encryption_keys with no userId: callId=${n}`);if(""!==n)return void v.warn(`Received m.call.encryption_keys with unsupported callId: userId=${t}, deviceId=${i}, callId=${n}`);if(!Array.isArray(s.keys))return void v.warn(`Received m.call.encryption_keys where keys wasn't an array: callId=${n}`);if(t===this.client.getUserId()&&i===this.client.getDeviceId())return void v.info("Ignoring our own keys event");this.statistics.counters.roomEventEncryptionKeysReceived+=1;const r=Date.now()-("number"==typeof s.sent_ts?s.sent_ts:e.getTs());this.statistics.totals.roomEventEncryptionKeysReceivedTotalAge+=r;for(const o of s.keys){if(!o){v.info("Ignoring false-y key in keys event");continue}const s=o.key,a=o.index;s&&null!=a&&null!=n&&"string"==typeof i&&"string"==typeof n&&"string"==typeof s&&"number"==typeof a?(v.debug(`Embedded-E2EE-LOG onCallEncryption userId=${t}:${i} encryptionKeyIndex=${a} age=${r}ms`,this.encryptionKeys),this.setEncryptionKey(t,i,a,s,e.getTs())):v.warn(`Malformed call encryption_key: userId=${t}, deviceId=${i}, encryptionKeyIndex=${a} callId=${n}`)}})),(0,i.A)(this,"isMyMembership",(e=>e.sender===this.client.getUserId()&&e.deviceId===this.client.getDeviceId())),(0,i.A)(this,"onMembershipUpdate",(()=>{var e,t;const s=this.memberships;this.memberships=w.callMembershipsForRoom(this.room),this._callId=null!==(e=this._callId)&&void 0!==e?e:null===(t=this.memberships[0])||void 0===t?void 0:t.callId;if((s.length!=this.memberships.length||s.some(((e,t)=>!c.pK.equal(e,this.memberships[t]))))&&(v.info(`Memberships for call in room ${this.room.roomId} have changed: emitting`),this.emit(E.MembershipsChanged,s,this.memberships)),this.manageMediaKeys&&this.isJoined()&&void 0===this.makeNewKeyTimeout){const e=new Set(s.filter((e=>!this.isMyMembership(e))).map(b)),t=new Set(this.memberships.filter((e=>!this.isMyMembership(e))).map(b)),i=Array.from(e).some((e=>!t.has(e))),n=Array.from(t).some((t=>!e.has(t))),r=this.lastMembershipFingerprints;if(this.storeLastMembershipFingerprints(),i)v.debug("Member(s) have left: queueing sender key rotation"),this.makeNewKeyTimeout=setTimeout(this.onRotateKeyTimeout,3e3);else if(n)v.debug("New member(s) have joined: queueing sender key rotation"),this.makeNewKeyTimeout=setTimeout(this.onRotateKeyTimeout,3e3);else if(r){const e=this.lastMembershipFingerprints;(Array.from(r).some((t=>!e.has(t)))||Array.from(e).some((e=>!r.has(e))))&&(v.debug("Member(s) have updated/reconnected: re-sending keys to everyone"),this.requestKeyEventSend())}}this.setExpiryTimer()})),(0,i.A)(this,"triggerCallMembershipEventUpdate",(async()=>{if(this.updateCallMembershipRunning)this.needCallMembershipUpdate=!0;else{this.updateCallMembershipRunning=!0;try{do{this.needCallMembershipUpdate=!1,await this.updateCallMembershipEvent()}while(this.needCallMembershipUpdate)}finally{this.updateCallMembershipRunning=!1}}})),(0,i.A)(this,"onRotateKeyTimeout",(()=>{if(!this.manageMediaKeys)return;this.makeNewKeyTimeout=void 0,v.info("Making new sender key for key rotation");const e=this.makeNewSenderKey(!0);this.sendEncryptionKeysEvent(e)})),this.client=e,this.room=t,this.memberships=s,this._callId=null===(n=s[0])||void 0===n?void 0:n.callId;const r=this.room.getLiveTimeline().getState(o.q.FORWARDS);null==r||r.on(l.f.Members,this.onMembershipUpdate),this.setExpiryTimer()}isJoined(){return void 0!==this.relativeExpiry}async stop(){await this.leaveRoomSession(1e3),this.expiryTimeout&&(clearTimeout(this.expiryTimeout),this.expiryTimeout=void 0),this.memberEventTimeout&&(clearTimeout(this.memberEventTimeout),this.memberEventTimeout=void 0);const e=this.room.getLiveTimeline().getState(o.q.FORWARDS);null==e||e.off(l.f.Members,this.onMembershipUpdate)}joinRoomSession(e,t,s){var i,n;this.isJoined()?v.info(`Already joined to session in room ${this.room.roomId}: ignoring join call`):(this.ownFocusActive=t,this.ownFociPreferred=e,this.relativeExpiry=f,this.manageMediaKeys=null!==(i=null==s?void 0:s.manageMediaKeys)&&void 0!==i?i:this.manageMediaKeys,this.useLegacyMemberEvents=null!==(n=null==s?void 0:s.useLegacyMemberEvents)&&void 0!==n?n:this.useLegacyMemberEvents,this.membershipId=(0,u.DU)(5),v.info(`Joining call session in room ${this.room.roomId} with manageMediaKeys=${this.manageMediaKeys}`),null!=s&&s.manageMediaKeys&&(this.makeNewSenderKey(),this.requestKeyEventSend()),this.triggerCallMembershipEventUpdate(),this.emit(E.JoinStateChanged,!0))}async leaveRoomSession(e=void 0){if(!this.isJoined())return v.info(`Not joined to session in room ${this.room.roomId}: ignoring leave call`),new Promise((e=>e(!1)));const t=this.client.getUserId(),s=this.client.getDeviceId();if(!t)throw new Error("No userId");if(!s)throw new Error("No deviceId");this.encryptionKeys.set(S(t,s),[]),void 0!==this.makeNewKeyTimeout&&(clearTimeout(this.makeNewKeyTimeout),this.makeNewKeyTimeout=void 0);for(const e of this.setNewKeyTimeouts)clearTimeout(e);this.setNewKeyTimeouts.clear(),v.info(`Leaving call session in room ${this.room.roomId}`),this.relativeExpiry=void 0,this.ownFocusActive=void 0,this.manageMediaKeys=!1,this.membershipId=void 0,this.emit(E.JoinStateChanged,!1);const i=new Promise((t=>{e&&setTimeout(t,e,"timeout")}));return new Promise((e=>{Promise.race([this.triggerCallMembershipEventUpdate(),i]).then((t=>{e("timeout"!=t)}))}))}getActiveFocus(){if(this.ownFocusActive&&(0,p.vv)(this.ownFocusActive)&&"oldest_membership"===this.ownFocusActive.focus_selection){const e=this.getOldestMembership();return null==e?void 0:e.getPreferredFoci()[0]}if(!this.ownFocusActive){const e=this.getOldestMembership();return null==e?void 0:e.getPreferredFoci()[0]}}reemitEncryptionKeys(){this.encryptionKeys.forEach(((e,t)=>{e.forEach(((e,s)=>{this.emit(E.EncryptionKeyChanged,e.key,s,t)}))}))}getKeysForParticipant(e,t){return this.getKeysForParticipantInternal(e,t)}getKeysForParticipantInternal(e,t){var s;return null===(s=this.encryptionKeys.get(S(e,t)))||void 0===s?void 0:s.map((e=>e.key))}getEncryptionKeys(){return Array.from(this.encryptionKeys.entries()).map((([e,t])=>[e,t.map((e=>e.key))])).values()}getNewEncryptionKeyIndex(){return-1===this.currentEncryptionKeyIndex?0:(this.currentEncryptionKeyIndex+1)%256}setEncryptionKey(e,t,s,i,n,r=!1){const o=(0,h.y4)(i),a=S(e,t);this.encryptionKeys.has(a)||this.encryptionKeys.set(a,[]);const d=this.encryptionKeys.get(a),c=d[s];if(c){if(c.timestamp>n)return void v.info(`Ignoring new key at index ${s} for ${a} as it is older than existing known key`);if((l=c.key)===(u=o)||l&&u&&l.length===u.length&&l.every(((e,t)=>e===u[t])))return void(c.timestamp=n)}var l,u;if(d[s]={key:o,timestamp:n},r){const i=setTimeout((()=>{this.setNewKeyTimeouts.delete(i),v.info(`Delayed-emitting key changed event for ${a} idx ${s}`),e===this.client.getUserId()&&t===this.client.getDeviceId()&&(this.currentEncryptionKeyIndex=s),this.emit(E.EncryptionKeyChanged,o,s,a)}),5e3);this.setNewKeyTimeouts.add(i)}else e===this.client.getUserId()&&t===this.client.getDeviceId()&&(this.currentEncryptionKeyIndex=s),this.emit(E.EncryptionKeyChanged,o,s,a)}makeNewSenderKey(e=!1){const t=this.client.getUserId(),s=this.client.getDeviceId();if(!t)throw new Error("No userId");if(!s)throw new Error("No deviceId");const i=(0,u.rl)(16),n=this.getNewEncryptionKeyIndex();return v.info("Generated new key at index "+n),this.setEncryptionKey(t,s,n,i,Date.now(),e),n}requestKeyEventSend(){if(this.manageMediaKeys)return this.lastEncryptionKeyUpdateRequest&&this.lastEncryptionKeyUpdateRequest+3e3>Date.now()?(v.info("Last encryption key event sent too recently: postponing"),void(void 0===this.keysEventUpdateTimeout&&(this.keysEventUpdateTimeout=setTimeout(this.sendEncryptionKeysEvent,3e3)))):void this.sendEncryptionKeysEvent()}setExpiryTimer(){let e;this.expiryTimeout&&(clearTimeout(this.expiryTimeout),this.expiryTimeout=void 0);for(const t of this.memberships){const s=t.getMsUntilExpiry();void 0!==s&&(void 0===e||s<e)&&(e=s)}null!=e&&(this.expiryTimeout=setTimeout(this.onMembershipUpdate,e))}getOldestMembership(){return this.memberships[0]}getFocusInUse(){const e=this.getOldestMembership();if("oldest_membership"===(null==e?void 0:e.getFocusSelection()))return e.getPreferredFoci()[0]}storeLastMembershipFingerprints(){this.lastMembershipFingerprints=new Set(this.memberships.filter((e=>!this.isMyMembership(e))).map((e=>`${b(e)}:${e.membershipID}:${e.createdTs()}`)))}makeMyMembershipLegacy(e,t){if(void 0===this.relativeExpiry)throw new Error("Tried to create our own membership event when we're not joined!");if(void 0===this.membershipId)throw new Error("Tried to create our own membership event when we have no membership ID!");const s=null==t?void 0:t.createdTs();return function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?g(Object(s),!0).forEach((function(t){(0,i.A)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):g(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({call_id:"",scope:"m.room",application:"m.call",device_id:e,expires:this.relativeExpiry,expires_ts:this.relativeExpiry+(null!=s?s:Date.now()),foci_active:this.ownFociPreferred,membershipID:this.membershipId},s?{created_ts:s}:{})}makeMyMembership(e){var t;return{call_id:"",scope:"m.room",application:"m.call",device_id:e,focus_active:{type:"livekit",focus_selection:"oldest_membership"},foci_preferred:null!==(t=this.ownFociPreferred)&&void 0!==t?t:[]}}membershipEventNeedsUpdate(e,t){if(t&&void 0===t.getMsUntilExpiry())return!1;if(!this.isJoined())return!!e;if(!t)return!0;const s=t.getMsUntilExpiry();return void 0!==s&&s<18e5&&(this.relativeExpiry+=f,!0)}makeNewMembership(e){return this.isJoined()?this.makeMyMembership(e):{}}makeNewLegacyMemberships(e,t,s,i){let n=e.filter((e=>{let t;try{t=new c.pK(s,e)}catch(e){return!1}return!t.isExpired()})).filter((e=>e.device_id!==t));return n=n.map((e=>(void 0===e.created_ts&&(e.created_ts=s.getTs()),e))),this.isJoined()&&n.push(this.makeMyMembershipLegacy(t,i)),{memberships:n}}async updateCallMembershipEvent(){this.memberEventTimeout&&(clearTimeout(this.memberEventTimeout),this.memberEventTimeout=void 0);const e=this.room.getLiveTimeline().getState(o.q.FORWARDS);if(!e)throw new Error("Couldn't get room state for room "+this.room.roomId);const t=this.client.getUserId(),s=this.client.getDeviceId();if(!t||!s)throw new Error("User ID or device ID was null!");const i=e.events.get(a.Bx.GroupCallMemberPrefix),n=this.stateEventsContainOngoingLegacySession(i);let r={};if(n){var d;const e=null==i?void 0:i.get(t),n=null!==(d=null==e?void 0:e.getContent())&&void 0!==d?d:{};let o;const a=Array.isArray(n.memberships)?n.memberships:[],l=a.find((e=>e.device_id===s));try{e&&l&&(0,c._D)(l)&&l.membershipID===this.membershipId&&(o=new c.pK(e,l))}catch(e){v.warn("Our previous call membership was invalid - this shouldn't happen.",e)}if(o&&v.debug(`${o.getMsUntilExpiry()} until our membership expires`),!this.membershipEventNeedsUpdate(l,o))return void(this.memberEventTimeout=setTimeout(this.triggerCallMembershipEventUpdate,y));r=this.makeNewLegacyMemberships(a,s,e,o)}else r=this.makeNewMembership(s);const l=n?t:this.makeMembershipStateKey(t,s);try{if(await this.client.sendStateEvent(this.room.roomId,a.Bx.GroupCallMemberPrefix,r,l),v.info("Sent updated call member event."),this.isJoined())if(n)this.memberEventTimeout=setTimeout(this.triggerCallMembershipEventUpdate,y);else try{const e=await this.client._unstable_sendDelayedStateEvent(this.room.roomId,{delay:8e3},a.Bx.GroupCallMemberPrefix,{},l);this.scheduleDelayDisconnection(e.delay_id)}catch(e){v.error("Failed to send delayed event:",e)}}catch(e){const t=3e3+2e3*Math.random();v.warn(`Failed to send call member event (retrying in ${t}): ${e}`),await new Promise((e=>setTimeout(e,t))),await this.triggerCallMembershipEventUpdate()}}scheduleDelayDisconnection(e){this.memberEventTimeout=setTimeout((()=>this.delayDisconnection(e)),5e3)}async delayDisconnection(e){try{await this.client._unstable_updateDelayedEvent(e,d.e.Restart),this.scheduleDelayDisconnection(e)}catch(e){v.error("Failed to delay our disconnection event",e)}}stateEventsContainOngoingLegacySession(e){if(null==e||!e.size)return this.useLegacyMemberEvents;let t=!1,s=!1;for(const i of e.values()){const e=i.getContent();if(Array.isArray(e.memberships)){for(const t of e.memberships)if(!new c.pK(i,t).isExpired())return!0}else Object.keys(e).length>0&&(t||(t=!0),s||(s=!("focus_active"in e)))}return!(t&&!s)&&this.useLegacyMemberEvents}makeMembershipStateKey(e,t){const s=`${e}_${t}`;return/^org\.matrix\.msc(3757|3779)\b/.exec(this.room.getVersion())?s:`_${s}`}}},"./node_modules/matrix-js-sdk/src/matrixrtc/MatrixRTCSessionManager.ts":(e,t,s)=>{"use strict";s.d(t,{I:()=>m});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/logger.ts"),r=s("./node_modules/matrix-js-sdk/src/client.ts"),o=s("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),a=s("./node_modules/matrix-js-sdk/src/models/room.ts"),d=s("./node_modules/matrix-js-sdk/src/models/room-state.ts"),c=s("./node_modules/matrix-js-sdk/src/matrixrtc/MatrixRTCSession.ts"),l=s("./node_modules/matrix-js-sdk/src/@types/event.ts");const u=n.v.getChild("MatrixRTCSessionManager");let h=function(e){return e.SessionStarted="session_started",e.SessionEnded="session_ended",e}({});class m extends o.X{constructor(e){super(),(0,i.A)(this,"roomSessions",new Map),(0,i.A)(this,"onTimeline",(e=>{this.consumeCallEncryptionEvent(e)})),(0,i.A)(this,"onRoom",(e=>{this.refreshRoom(e)})),(0,i.A)(this,"onRoomState",((e,t)=>{const s=this.client.getRoom(e.getRoomId());s?e.getType()==l.Bx.GroupCallMemberPrefix&&this.refreshRoom(s):u.error(`Got room state event for unknown room ${e.getRoomId()}!`)})),this.client=e}start(){for(const t of null!==(e=this.client.getRooms())&&void 0!==e?e:[]){var e;const s=c.n.roomSessionForRoom(this.client,t);s.memberships.length>0&&this.roomSessions.set(t.roomId,s)}this.client.on(r.AU.Room,this.onRoom),this.client.on(a.u9.Timeline,this.onTimeline),this.client.on(d.f.Events,this.onRoomState)}stop(){for(const e of this.roomSessions.values())e.stop();this.roomSessions.clear(),this.client.off(r.AU.Room,this.onRoom),this.client.off(a.u9.Timeline,this.onTimeline),this.client.off(d.f.Events,this.onRoomState)}getActiveRoomSession(e){return this.roomSessions.get(e.roomId)}getRoomSession(e){return this.roomSessions.has(e.roomId)||this.roomSessions.set(e.roomId,c.n.roomSessionForRoom(this.client,e)),this.roomSessions.get(e.roomId)}async consumeCallEncryptionEvent(e,t=!1){if(await this.client.decryptEventIfNeeded(e),e.isDecryptionFailure())return void(t?u.warn(`Decryption failed for event ${e.getId()}: ${e.decryptionFailureReason}`):(u.warn(`Decryption failed for event ${e.getId()}: ${e.decryptionFailureReason} will retry once only`),setTimeout((()=>this.consumeCallEncryptionEvent(e,!0)),1e3)));if(t&&u.info(`Decryption succeeded for event ${e.getId()} after retry`),e.getType()!==l.Bx.CallEncryptionKeysPrefix)return Promise.resolve();const s=this.client.getRoom(e.getRoomId());if(!s)return u.error(`Got room state event for unknown room ${e.getRoomId()}!`),Promise.resolve();this.getRoomSession(s).onCallEncryption(e)}refreshRoom(e){const t=!this.roomSessions.has(e.roomId),s=this.getRoomSession(e),i=s.memberships.length>0&&!t;s.onMembershipUpdate();const n=s.memberships.length>0;i&&!n?this.emit(h.SessionEnded,e.roomId,this.roomSessions.get(e.roomId)):!i&&n&&this.emit(h.SessionStarted,e.roomId,this.roomSessions.get(e.roomId))}}},"./node_modules/matrix-js-sdk/src/models/beacon.ts":(e,t,s)=>{"use strict";s.d(t,{HF:()=>l,JH:()=>a,M9:()=>c});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/content-helpers.ts"),r=s("./node_modules/matrix-js-sdk/src/utils.ts"),o=s("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts");let a=function(e){return e.New="Beacon.new",e.Update="Beacon.update",e.LivenessChange="Beacon.LivenessChange",e.Destroy="Beacon.Destroy",e.LocationUpdate="Beacon.LocationUpdate",e}({});const d=(e,t,s)=>s>=e&&e+t>=s,c=e=>`${e.getRoomId()}_${e.getStateKey()}`;class l extends o.X{constructor(e){super(),(0,i.A)(this,"roomId",void 0),(0,i.A)(this,"_beaconInfo",void 0),(0,i.A)(this,"_isLive",void 0),(0,i.A)(this,"livenessWatchTimeout",void 0),(0,i.A)(this,"_latestLocationEvent",void 0),(0,i.A)(this,"clearLatestLocation",(()=>{this._latestLocationEvent=void 0,this.emit(a.LocationUpdate,this.latestLocationState)})),this.rootEvent=e,this.roomId=this.rootEvent.getRoomId(),this.setBeaconInfo(this.rootEvent)}get isLive(){return!!this._isLive}get identifier(){return c(this.rootEvent)}get beaconInfoId(){return this.rootEvent.getId()}get beaconInfoOwner(){return this.rootEvent.getStateKey()}get beaconInfoEventType(){return this.rootEvent.getType()}get beaconInfo(){return this._beaconInfo}get latestLocationState(){return this._latestLocationEvent&&(0,n.parseBeaconContent)(this._latestLocationEvent.getContent())}get latestLocationEvent(){return this._latestLocationEvent}update(e){if(c(e)!==this.identifier)throw new Error("Invalid updating event");e.getTs()<this.rootEvent.getTs()||(this.rootEvent=e,this.setBeaconInfo(this.rootEvent),this.emit(a.Update,e,this),this.clearLatestLocation())}destroy(){this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this._isLive=!1,this.emit(a.Destroy,this.identifier)}monitorLiveness(){if(this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this.checkLiveness(),this.beaconInfo)if(this.isLive){const e=this.beaconInfo.timestamp+this.beaconInfo.timeout-Date.now();e>1&&(this.livenessWatchTimeout=setTimeout((()=>{this.monitorLiveness()}),e))}else this.beaconInfo.timestamp>Date.now()&&(this.livenessWatchTimeout=setTimeout((()=>{this.monitorLiveness()}),this.beaconInfo.timestamp-Date.now()))}addLocations(e){var t;if(!this.isLive)return;const s=null===(t=e.filter((e=>{const t=e.getContent(),s=(0,n.parseBeaconContent)(t);if(!s.uri||!s.timestamp)return!1;const{timestamp:i}=s;return this._beaconInfo.timestamp&&d(this._beaconInfo.timestamp,this._beaconInfo.timeout,i)&&(!this.latestLocationState||i>this.latestLocationState.timestamp)})).sort(r.Fq))||void 0===t?void 0:t[0];s&&(this._latestLocationEvent=s,this.emit(a.LocationUpdate,this.latestLocationState))}setBeaconInfo(e){this._beaconInfo=(0,n.parseBeaconInfoContent)(e.getContent()),this.checkLiveness()}checkLiveness(){const e=this.isLive;if(!this.beaconInfo)return;const t=this.beaconInfo.timestamp>Date.now()?this.beaconInfo.timestamp-36e4:this.beaconInfo.timestamp;this._isLive=!!this._beaconInfo.live&&!!t&&d(t,this._beaconInfo.timeout,Date.now()),e!==this.isLive&&this.emit(a.LivenessChange,this.isLive,this)}}},"./node_modules/matrix-js-sdk/src/models/device.ts":(e,t,s)=>{"use strict";s.d(t,{p:()=>r,u:()=>n});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js");let n=function(e){return e[e.Blocked=-1]="Blocked",e[e.Unverified=0]="Unverified",e[e.Verified=1]="Verified",e}({});class r{constructor(e){(0,i.A)(this,"deviceId",void 0),(0,i.A)(this,"userId",void 0),(0,i.A)(this,"algorithms",void 0),(0,i.A)(this,"keys",void 0),(0,i.A)(this,"verified",void 0),(0,i.A)(this,"signatures",void 0),(0,i.A)(this,"displayName",void 0),(0,i.A)(this,"dehydrated",!1),this.deviceId=e.deviceId,this.userId=e.userId,this.algorithms=e.algorithms,this.keys=e.keys,this.verified=e.verified||n.Unverified,this.signatures=e.signatures||new Map,this.displayName=e.displayName,this.dehydrated=!!e.dehydrated}getFingerprint(){return this.keys.get(`ed25519:${this.deviceId}`)}getIdentityKey(){return this.keys.get(`curve25519:${this.deviceId}`)}}},"./node_modules/matrix-js-sdk/src/models/event-status.ts":(e,t,s)=>{"use strict";s.d(t,{f:()=>i});let i=function(e){return e.NOT_SENT="not_sent",e.ENCRYPTING="encrypting",e.SENDING="sending",e.QUEUED="queued",e.SENT="sent",e.CANCELLED="cancelled",e}({})},"./node_modules/matrix-js-sdk/src/models/event-timeline-set.ts":(e,t,s)=>{"use strict";s.d(t,{m:()=>u,x:()=>l});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/models/event-timeline.ts"),r=s("./node_modules/matrix-js-sdk/src/logger.ts"),o=s("./node_modules/matrix-js-sdk/src/models/room.ts"),a=s("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),d=s("./node_modules/matrix-js-sdk/src/models/relations-container.ts");let c;c=r.v.log.bind(r.v);let l=function(e){return e.Ignore="ignore",e.Replace="replace",e}({});class u extends a.X{constructor(e,t={},s,r,o=null){var a,c,l;super(),(0,i.A)(this,"relations",void 0),(0,i.A)(this,"timelineSupport",void 0),(0,i.A)(this,"displayPendingEvents",void 0),(0,i.A)(this,"liveTimeline",void 0),(0,i.A)(this,"timelines",void 0),(0,i.A)(this,"_eventIdToTimeline",new Map),(0,i.A)(this,"filter",void 0),this.room=e,this.thread=r,this.threadListType=o,this.timelineSupport=Boolean(t.timelineSupport),this.liveTimeline=new n.q(this),this.displayPendingEvents=!1!==t.pendingEvents,this.timelines=[this.liveTimeline],this._eventIdToTimeline=new Map,this.filter=t.filter,this.relations=null!==(a=null===(c=this.room)||void 0===c?void 0:c.relations)&&void 0!==a?a:new d.t(null!==(l=null==e?void 0:e.client)&&void 0!==l?l:s)}getTimelines(){return this.timelines}getFilter(){return this.filter}setFilter(e){this.filter=e}getPendingEvents(){return this.room&&this.displayPendingEvents?this.room.getPendingEvents():[]}getLiveTimeline(){return this.liveTimeline}setLiveTimeline(e){this.liveTimeline=e}eventIdToTimeline(e){return this._eventIdToTimeline.get(e)}replaceEventId(e,t){const s=this._eventIdToTimeline.get(e);s&&(this._eventIdToTimeline.delete(e),this._eventIdToTimeline.set(t,s))}resetLiveTimeline(e,t){const s=!this.timelineSupport||!t,i=this.liveTimeline,r=s?i.forkLive(n.q.FORWARDS):i.fork(n.q.FORWARDS);s?(this.timelines=[r],this._eventIdToTimeline=new Map):this.timelines.push(r),t&&i.setPaginationToken(t,n.q.FORWARDS),r.setPaginationToken(null!=e?e:null,n.q.BACKWARDS),this.liveTimeline=r,this.emit(o.u9.TimelineReset,this.room,this,s)}getTimelineForEvent(e){if(null==e)return null;const t=this._eventIdToTimeline.get(e);return void 0===t?null:t}findEventById(e){const t=this.getTimelineForEvent(e);if(t)return t.getEvents().find((function(t){return t.getId()==e}))}addTimeline(){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");const e=new n.q(this);return this.timelines.push(e),e}addEventsToTimeline(e,t,s,i){if(!s)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&s==this.liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(this.filter&&!(e=this.filter.filterRoomTimeline(e)).length)return;const o=t?n.q.BACKWARDS:n.q.FORWARDS,a=t?n.q.FORWARDS:n.q.BACKWARDS;let d=!1,l=!1;for(const i of e){const e=i.getId(),u=this._eventIdToTimeline.get(e);if(!u){this.addEventToTimeline(i,s,{toStartOfTimeline:t}),l=!0,d=!0;continue}if(l=!1,u==s){c("Event "+e+" already in timeline "+s);continue}const h=s.getNeighbouringTimeline(o);if(h){c(u==h?"Event "+e+" in neighbouring timeline - switching to "+u:"Event "+e+" already in a different timeline "+u),s=u;continue}r.v.info("Already have timeline for "+e+" - joining timeline "+s+" to "+u);const m=u===this.liveTimeline,p=s===this.liveTimeline,g=o===n.q.BACKWARDS&&m,v=o===n.q.FORWARDS&&p;g||v?(g&&r.v.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+u+")"),v&&r.v.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+s+")")):(s.setNeighbouringTimeline(u,o),u.setNeighbouringTimeline(s,a),s=u,d=!0)}if(l||!d){if(o===n.q.FORWARDS&&s===this.liveTimeline)return r.v.warn({lastEventWasNew:l,didUpdate:d}),void r.v.warn(`Refusing to set forwards pagination token of live timeline ${s} to ${i}`);s.setPaginationToken(null!=i?i:null,o)}}addLiveEvent(e,{duplicateStrategy:t,fromCache:s,roomState:i,timelineWasEmpty:r}={}){if(this.filter){if(!this.filter.filterRoomTimeline([e]).length)return}const o=this._eventIdToTimeline.get(e.getId());if(o)if(t===l.Replace){c("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());const t=o.getEvents();for(let s=0;s<t.length;s++)if(t[s].getId()===e.getId()){i||(i=o.getState(n.q.FORWARDS)),n.q.setEventMetadata(e,i,!1),t[s]=e;break}}else c("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());else this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,fromCache:s,roomState:i,timelineWasEmpty:r})}addEventToTimeline(e,t,s,i=!1,n){let a,d=!!s;var c;if("object"==typeof s?({toStartOfTimeline:d,fromCache:i=!1,roomState:n,timelineWasEmpty:a}=s):void 0!==s&&r.v.warn("Overload deprecated: `EventTimelineSet.addEventToTimeline(event, timeline, toStartOfTimeline, fromCache?, roomState?)` is deprecated in favor of the overload with `EventTimelineSet.addEventToTimeline(event, timeline, IAddEventToTimelineOptions)`"),t.getTimelineSet()!==this)throw new Error(`EventTimelineSet.addEventToTimeline: Timeline=${t.toString()} does not belong " +\n                "in timelineSet(threadId=${null===(c=this.thread)||void 0===c?void 0:c.id})`);const l=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var u;let s=`event=${l}`;return e.threadRootId&&(s+=`(belongs to thread=${e.threadRootId})`),void r.v.warn(`EventTimelineSet.addEventToTimeline: Ignoring ${s} that does not belong in timeline=${t.toString()} timelineSet(threadId=${null===(u=this.thread)||void 0===u?void 0:u.id})`)}t.addEvent(e,{toStartOfTimeline:d,roomState:n,timelineWasEmpty:a}),this._eventIdToTimeline.set(l,t);const h={timeline:t,liveEvent:!d&&t==this.liveTimeline&&!i};this.emit(o.u9.Timeline,e,this.room,Boolean(d),!1,h)}insertEventIntoTimeline(e,t,s){var i;if(t.getTimelineSet()!==this)throw new Error(`EventTimelineSet.insertEventIntoTimeline: Timeline=${t.toString()} does not belong " +\n                "in timelineSet(threadId=${null===(i=this.thread)||void 0===i?void 0:i.id})`);const n=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var a;let s=`event=${n}`;return e.threadRootId&&(s+=`(belongs to thread=${e.threadRootId})`),void r.v.warn(`EventTimelineSet.insertEventIntoTimeline: Ignoring ${s} that does not belong in timeline=${t.toString()} timelineSet(threadId=${null===(a=this.thread)||void 0===a?void 0:a.id})`)}const d=e.relationEventId;if(!d)return void this.addEventToTimeline(e,t,{toStartOfTimeline:!1,fromCache:!1,timelineWasEmpty:!1,roomState:s});const c=this.findEventById(d),l=t.getEvents();let u=void 0!==c?l.indexOf(c):0;for(;u<l.length;u++){if(l[u].getTs()>e.getTs())break}t.insertEvent(e,u,s),this._eventIdToTimeline.set(n,t);const h={timeline:t,liveEvent:!1};this.emit(o.u9.Timeline,e,this.room,!1,!1,h)}handleRemoteEcho(e,t,s){const i=this._eventIdToTimeline.get(t);i?(this._eventIdToTimeline.delete(t),this._eventIdToTimeline.set(s,i)):this.filter&&!this.filter.filterRoomTimeline([e]).length||this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1})}removeEvent(e){const t=this._eventIdToTimeline.get(e);if(!t)return null;const s=t.removeEvent(e);if(s){this._eventIdToTimeline.delete(e);const i={timeline:t};this.emit(o.u9.Timeline,s,this.room,void 0,!0,i)}return s}compareEventOrdering(e,t){if(e==t)return 0;const s=this._eventIdToTimeline.get(e),i=this._eventIdToTimeline.get(t);if(void 0===s)return null;if(void 0===i)return null;if(s===i){let i,n;const r=s.getEvents();for(let s=0;s<r.length&&(void 0===i||void 0===n);s++){const o=r[s].getId();o==e&&(i=s),o==t&&(n=s)}const o=i-n;return o<0?-1:o>0?1:0}let r=s;for(;r;){if(r===i)return-1;r=r.getNeighbouringTimeline(n.q.FORWARDS)}for(r=s;r;){if(r===i)return 1;r=r.getNeighbouringTimeline(n.q.BACKWARDS)}return null}canContain(e){if(!this.room)throw new Error("Cannot call `EventTimelineSet::canContain without a `room` set. Set the room when creating the EventTimelineSet to call this method.");const{threadId:t,shouldLiveInRoom:s,shouldLiveInThread:i}=this.room.eventShouldLiveIn(e);if(this.thread)return this.thread.id===t;var n;s||i||r.v.warn(`EventTimelineSet:canContain event encountered which cannot be added to any timeline roomId=${null===(n=this.room)||void 0===n?void 0:n.roomId} eventId=${e.getId()} threadId=${e.threadRootId}`);return s}}},"./node_modules/matrix-js-sdk/src/models/event-timeline.ts":(e,t,s)=>{"use strict";s.d(t,{O:()=>o,q:()=>a});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/models/room-state.ts"),r=s("./node_modules/matrix-js-sdk/src/@types/event.ts");let o=function(e){return e.Backward="b",e.Forward="f",e}({});class a{static setEventMetadata(e,t,s){var i,n;null!==(i=e.sender)&&void 0!==i&&null!==(i=i.events)&&void 0!==i&&i.member||(e.sender=t.getSentinelMember(e.getSender())),null!==(n=e.target)&&void 0!==n&&null!==(n=n.events)&&void 0!==n&&n.member||e.getType()!==r.Bx.RoomMember||(e.target=t.getSentinelMember(e.getStateKey())),e.isState()&&s&&(e.forwardLooking=!1)}constructor(e){var t,s;(0,i.A)(this,"roomId",void 0),(0,i.A)(this,"name",void 0),(0,i.A)(this,"events",[]),(0,i.A)(this,"baseIndex",0),(0,i.A)(this,"startState",void 0),(0,i.A)(this,"endState",void 0),(0,i.A)(this,"startToken",null),(0,i.A)(this,"endToken",null),(0,i.A)(this,"prevTimeline",null),(0,i.A)(this,"nextTimeline",null),(0,i.A)(this,"paginationRequests",{[o.Backward]:null,[o.Forward]:null}),this.eventTimelineSet=e,this.roomId=null!==(t=null===(s=e.room)||void 0===s?void 0:s.roomId)&&void 0!==t?t:null,this.roomId&&(this.startState=new n.H(this.roomId,void 0,!0),this.endState=new n.H(this.roomId)),this.paginationRequests={b:null,f:null},this.name=this.roomId+":"+(new Date).toISOString()}initialiseState(e,{timelineWasEmpty:t}={}){var s,i;if(this.events.length>0)throw new Error("Cannot initialise state after events are added");null===(s=this.startState)||void 0===s||s.setStateEvents(e,{timelineWasEmpty:t}),null===(i=this.endState)||void 0===i||i.setStateEvents(e,{timelineWasEmpty:t})}forkLive(e){const t=this.getState(e),s=new a(this.eventTimelineSet);return s.startState=null==t?void 0:t.clone(),s.endState=t,this.endState=null==t?void 0:t.clone(),s}fork(e){const t=this.getState(e),s=new a(this.eventTimelineSet);return s.startState=null==t?void 0:t.clone(),s.endState=null==t?void 0:t.clone(),s}getRoomId(){return this.roomId}getFilter(){return this.eventTimelineSet.getFilter()}getTimelineSet(){return this.eventTimelineSet}getBaseIndex(){return this.baseIndex}getEvents(){return this.events}getState(e){if(e==a.BACKWARDS)return this.startState;if(e==a.FORWARDS)return this.endState;throw new Error("Invalid direction '"+e+"'")}getPaginationToken(e){return this.roomId?this.getState(e).paginationToken:e===o.Backward?this.startToken:this.endToken}setPaginationToken(e,t){this.roomId?this.getState(t).paginationToken=e:t===o.Backward?this.startToken=e:this.endToken=e}getNeighbouringTimeline(e){if(e==a.BACKWARDS)return this.prevTimeline;if(e==a.FORWARDS)return this.nextTimeline;throw new Error("Invalid direction '"+e+"'")}setNeighbouringTimeline(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==a.BACKWARDS)this.prevTimeline=e;else{if(t!=a.FORWARDS)throw new Error("Invalid direction '"+t+"'");this.nextTimeline=e}this.setPaginationToken(null,t)}addEvent(e,{toStartOfTimeline:t,roomState:s,timelineWasEmpty:i}={toStartOfTimeline:!1}){s||(s=t?this.startState:this.endState);const n=this.getTimelineSet();var o;n.room&&(a.setEventMetadata(e,s,t),e.isState()&&n.room.getUnfilteredTimelineSet()===n&&(null===(o=s)||void 0===o||o.setStateEvents([e],{timelineWasEmpty:i}),e.sender&&(e.getType()!==r.Bx.RoomMember||t)||a.setEventMetadata(e,s,t)));let d;d=t?0:this.events.length,this.events.splice(d,0,e),t&&this.baseIndex++}insertEvent(e,t,s){const i=this.getTimelineSet();i.room&&(a.setEventMetadata(e,s,!1),e.isState()&&i.room.getUnfilteredTimelineSet()===i&&(s.setStateEvents([e],{}),e.sender&&e.getType()!==r.Bx.RoomMember||a.setEventMetadata(e,s,!1))),this.events.splice(t,0,e)}removeEvent(e){for(let t=this.events.length-1;t>=0;t--){const s=this.events[t];if(s.getId()==e)return this.events.splice(t,1),t<this.baseIndex&&this.baseIndex--,s}return null}toString(){return this.name}}(0,i.A)(a,"BACKWARDS",o.Backward),(0,i.A)(a,"FORWARDS",o.Forward)},"./node_modules/matrix-js-sdk/src/models/event.ts":(e,t,s)=>{"use strict";s.d(t,{OQ:()=>v,fb:()=>p.f,kl:()=>f});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-events-sdk/lib/index.js"),r=s("./node_modules/matrix-js-sdk/src/logger.ts"),o=s("./node_modules/matrix-js-sdk/src/@types/event.ts"),a=s("./node_modules/matrix-js-sdk/src/utils.ts"),d=s("./node_modules/matrix-js-sdk/src/models/thread.ts"),c=s("./node_modules/matrix-js-sdk/src/ReEmitter.ts"),l=s("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),u=s("./node_modules/matrix-js-sdk/src/common-crypto/CryptoBackend.ts"),h=s("./node_modules/matrix-js-sdk/src/models/event-timeline.ts"),m=s("./node_modules/matrix-js-sdk/src/crypto-api/index.ts"),p=s("./node_modules/matrix-js-sdk/src/models/event-status.ts");const g=Object.freeze({visible:!0});let v=function(e){return e.Decrypted="Event.decrypted",e.BeforeRedaction="Event.beforeRedaction",e.VisibilityChange="Event.visibilityChange",e.LocalEventIdReplaced="Event.localEventIdReplaced",e.Status="Event.status",e.Replaced="Event.replaced",e.RelationsCreated="Event.relationsCreated",e}({});class f extends l.X{constructor(e={}){var t;super(),(0,i.A)(this,"pushDetails",{}),(0,i.A)(this,"_replacingEvent",null),(0,i.A)(this,"_localRedactionEvent",null),(0,i.A)(this,"_isCancelled",!1),(0,i.A)(this,"clearEvent",void 0),(0,i.A)(this,"visibility",g),(0,i.A)(this,"_hasCachedExtEv",!1),(0,i.A)(this,"_cachedExtEv",void 0),(0,i.A)(this,"_decryptionFailureReason",null),(0,i.A)(this,"senderCurve25519Key",null),(0,i.A)(this,"claimedEd25519Key",null),(0,i.A)(this,"forwardingCurve25519KeyChain",[]),(0,i.A)(this,"untrusted",null),(0,i.A)(this,"decryptionPromise",null),(0,i.A)(this,"retryDecryption",!1),(0,i.A)(this,"txnId",void 0),(0,i.A)(this,"thread",void 0),(0,i.A)(this,"threadId",void 0),(0,i.A)(this,"localTimestamp",void 0),(0,i.A)(this,"sender",null),(0,i.A)(this,"target",null),(0,i.A)(this,"status",null),(0,i.A)(this,"error",null),(0,i.A)(this,"forwardLooking",!0),(0,i.A)(this,"verificationRequest",void 0),(0,i.A)(this,"reEmitter",void 0),this.event=e,["state_key","type","sender","room_id","membership"].forEach((t=>{"string"==typeof e[t]&&(e[t]=(0,a.yD)(e[t]))})),["membership","avatar_url","displayname"].forEach((t=>{var s;"string"==typeof(null===(s=e.content)||void 0===s?void 0:s[t])&&(e.content[t]=(0,a.yD)(e.content[t]))})),["rel_type"].forEach((t=>{var s;"string"==typeof(null===(s=e.content)||void 0===s||null===(s=s["m.relates_to"])||void 0===s?void 0:s[t])&&(e.content["m.relates_to"][t]=(0,a.yD)(e.content["m.relates_to"][t]))})),this.txnId=e.txn_id;const s=this.getAge();this.localTimestamp=void 0!==s?Date.now()-s:null!==(t=this.getTs())&&void 0!==t?t:Date.now(),this.reEmitter=new c.Q(this)}get unstableExtensibleEvent(){return this._hasCachedExtEv||(this._cachedExtEv=n.ExtensibleEvents.parse(this.getEffectiveEvent())),this._cachedExtEv}invalidateExtensibleEvent(){this._hasCachedExtEv=!1}getEffectiveEvent(){const e=Object.assign({},this.getContent());if(this.getWireType()===o.Bx.RoomMessageEncrypted)for(const[t,s]of Object.entries(this.getWireContent()))["algorithm","ciphertext","device_id","sender_key","session_id"].includes(t)||void 0===e[t]&&(e[t]=s);return Object.assign({},this.event,this.clearEvent,{content:e})}getId(){return this.event.event_id}getSender(){return this.event.sender}getType(){return this.clearEvent?this.clearEvent.type:this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getDetails(){const e=this.getRoomId();var t;if(e)return`id=${this.getId()} type=${this.getWireType()} sender=${this.getSender()} room=${e} ts=${null===(t=this.getDate())||void 0===t?void 0:t.toISOString()}`;return`msgid=${this.getContent()[o.wt]} type=${this.getWireType()} sender=${this.getSender()}`}getOriginalContent(){return this._localRedactionEvent?{}:this.clearEvent?this.clearEvent.content||{}:this.event.content||{}}getContent(){return this._localRedactionEvent?{}:this._replacingEvent?this._replacingEvent.getContent()["m.new_content"]||{}:this.getOriginalContent()}getWireContent(){return this.event.content||{}}get threadRootId(){var e;if(this.isState())return;const t=null===(e=this.getWireContent())||void 0===e?void 0:e["m.relates_to"];if((null==t?void 0:t.rel_type)===d.RN.name)return t.event_id;if(this.thread)return this.thread.id;if(void 0!==this.threadId)return this.threadId;const s=this.getUnsigned();return"string"==typeof s[o.Sr.name]?s[o.Sr.name]:void 0}get isThreadRoot(){if(this.isState())return!1;return!!this.getServerAggregatedRelation(d.RN.name)||this.threadRootId===this.getId()}get replyEventId(){var e;return null===(e=this.getWireContent()["m.relates_to"])||void 0===e||null===(e=e["m.in_reply_to"])||void 0===e?void 0:e.event_id}get relationEventId(){var e;return null===(e=this.getWireContent())||void 0===e||null===(e=e["m.relates_to"])||void 0===e?void 0:e.event_id}getPrevContent(){return this.getUnsigned().prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.event.state_key}isState(){return void 0!==this.event.state_key}getMembershipAtEvent(){const e=this.getUnsigned();return o.SY.findIn(e)}makeEncrypted(e,t,s,i){this.clearEvent={type:this.event.type,content:this.event.content},this.event.type=e,this.event.content=t,this.senderCurve25519Key=s,this.claimedEd25519Key=i}isBeingDecrypted(){return null!=this.decryptionPromise}getDecryptionPromise(){return this.decryptionPromise}isDecryptionFailure(){return null!==this._decryptionFailureReason}get decryptionFailureReason(){return this._decryptionFailureReason}get isEncryptedDisabledForUnverifiedDevices(){return this.decryptionFailureReason===m.DecryptionFailureCode.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE}shouldAttemptDecryption(){return!this.isRedacted()&&(!this.isBeingDecrypted()&&(!this.clearEvent&&!!this.isEncrypted()))}async attemptDecryption(e,t={}){if(!this.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");const s=this.clearEvent&&!this.isDecryptionFailure(),i=t.forceRedecryptIfUntrusted&&this.isKeySourceUntrusted();if(s&&!i)throw new Error("Attempt to decrypt event which has already been decrypted");return this.decryptionPromise?(r.v.log(`Event ${this.getId()} already being decrypted; queueing a retry`),this.retryDecryption=!0,this.decryptionPromise):(this.decryptionPromise=this.decryptionLoop(e,t),this.decryptionPromise)}cancelAndResendKeyRequest(e,t){const s=this.getWireContent();return e.requestRoomKey({algorithm:s.algorithm,room_id:this.getRoomId(),session_id:s.session_id,sender_key:s.sender_key},this.getKeyRequestRecipients(t),!0)}getKeyRequestRecipients(e){return[{userId:e,deviceId:"*"}]}async decryptionLoop(e,t={}){for(await Promise.resolve();;){let s;this.retryDecryption=!1;try{const s=await e.decryptEvent(this);!0===t.isRetry&&r.v.info(`Decrypted event on retry (${this.getDetails()})`),this.setClearData(s),this._decryptionFailureReason=null}catch(e){const t=e instanceof u.O?e.detailedString:String(e);if(s=e,this.retryDecryption){r.v.log(`Error decrypting event (${this.getDetails()}), but retrying: ${t}`);continue}r.v.warn(`Error decrypting event (${this.getDetails()}): ${t}`),this.setClearDataForDecryptionFailure(String(e)),this._decryptionFailureReason=e instanceof u.O?e.code:m.DecryptionFailureCode.UNKNOWN_ERROR}return this.decryptionPromise=null,this.retryDecryption=!1,this.setPushDetails(),void(!1!==t.emit&&this.emit(v.Decrypted,this,s))}}setClearData(e){var t,s;this.clearEvent=e.clearEvent,this.senderCurve25519Key=null!==(t=e.senderCurve25519Key)&&void 0!==t?t:null,this.claimedEd25519Key=null!==(s=e.claimedEd25519Key)&&void 0!==s?s:null,this.forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain||[],this.untrusted=e.untrusted||!1,this.invalidateExtensibleEvent()}setClearDataForDecryptionFailure(e){this.clearEvent={type:o.Bx.RoomMessage,content:{msgtype:"m.bad.encrypted",body:`** Unable to decrypt: ${e} **`}},this.senderCurve25519Key=null,this.claimedEd25519Key=null,this.forwardingCurve25519KeyChain=[],this.untrusted=!1,this.invalidateExtensibleEvent()}getClearContent(){return this.clearEvent?this.clearEvent.content:null}isEncrypted(){return!this.isState()&&this.event.type===o.Bx.RoomMessageEncrypted}getSenderKey(){return this.senderCurve25519Key}getKeysClaimed(){return this.claimedEd25519Key?{ed25519:this.claimedEd25519Key}:{}}getClaimedEd25519Key(){return this.claimedEd25519Key}getForwardingCurve25519KeyChain(){return this.forwardingCurve25519KeyChain}isKeySourceUntrusted(){return!!this.untrusted}getUnsigned(){return this.event.unsigned||{}}setUnsigned(e){this.event.unsigned=e}unmarkLocallyRedacted(){const e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=void 0),!!e}markLocallyRedacted(e){this._localRedactionEvent||(this.emit(v.BeforeRedaction,this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)}applyVisibilityEvent(e){var t,s;const i=null===(t=null==e?void 0:e.visible)||void 0===t||t,n=null!==(s=null==e?void 0:e.reason)&&void 0!==s?s:null;let r=!1;this.visibility.visible!==i?r=!0:this.visibility.visible||this.visibility.reason===n||(r=!0),r&&(this.visibility=i?g:Object.freeze({visible:!1,reason:n}),this.emit(v.VisibilityChange,this,i))}messageVisibility(){return this.visibility}makeRedacted(e,t){if(!e.event)throw new Error("invalid redactionEvent in makeRedacted");this._localRedactionEvent=null,this.emit(v.BeforeRedaction,this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event;for(const e in this.event)this.event.hasOwnProperty(e)&&!y.has(e)&&delete this.event[e];this.isEncrypted()&&(this.clearEvent=void 0);const s=this.getType()in S?S[this.getType()]:{},i=this.getContent();for(const e in i)i.hasOwnProperty(e)&&!s[e]&&delete i[e];!this.isThreadRoot&&this.threadRootId&&this.threadRootId!==this.getId()&&(this.moveAllRelatedToMainTimeline(t),e.moveToMainTimeline(t)),this.invalidateExtensibleEvent()}moveAllRelatedToMainTimeline(e){const t=this.thread;if(this.moveToMainTimeline(e),t)for(const i of t.events){var s;(null===(s=i.getRelation())||void 0===s?void 0:s.event_id)===this.getId()&&i.moveAllRelatedToMainTimeline(e)}}moveToMainTimeline(e){var t;null===(t=this.thread)||void 0===t||t.timelineSet.removeEvent(this.getId()),this.setThread(void 0);const s=e.getLiveTimeline();s.getTimelineSet().insertEventIntoTimeline(this,s,s.getState(h.q.FORWARDS))}isRedacted(){return Boolean(this.getUnsigned().redacted_because)}isRedaction(){return this.getType()===o.Bx.RoomRedaction}asVisibilityChange(){if(!o.Yg.matches(this.getType()))return null;const e=this.getRelation();if(!e||"m.reference"!=e.rel_type)return null;const t=e.event_id;if(!t)return null;const s=this.getWireContent(),i=!!s.visible,n=s.reason;return n&&"string"!=typeof n?null:{visible:i,reason:n,eventId:t}}isVisibilityEvent(){return o.Yg.matches(this.getType())}getRedactionEvent(){var e,t,s,i;return this.isRedacted()?null!==(e=this.clearEvent)&&void 0!==e&&e.unsigned?null!==(s=null===(i=this.clearEvent)||void 0===i?void 0:i.unsigned.redacted_because)&&void 0!==s?s:null:null!==(t=this.event.unsigned)&&void 0!==t&&t.redacted_because?this.event.unsigned.redacted_because:{}:null}getPushActions(){return this.pushDetails.actions||null}getPushDetails(){return this.pushDetails}setPushDetails(e,t){this.pushDetails={actions:e,rule:t}}handleRemoteEcho(e){const t=this.getUnsigned(),s=this.getId();this.event=e,t.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=t.redacted_because),this.setStatus(null),this.getId()!==s&&this.emit(v.LocalEventIdReplaced,this),this.localTimestamp=Date.now()-this.getAge()}isSending(){return!!this.status}setStatus(e){this.status=e,this.emit(v.Status,this,e)}replaceLocalEventId(e){this.event.event_id=e,this.emit(v.LocalEventIdReplaced,this)}isRelation(e){var t;const s=null===(t=this.getWireContent())||void 0===t?void 0:t["m.relates_to"];return!(this.isState()&&null!=s&&s.rel_type&&[o.zZ.Replace,o.zZ.Thread].includes(s.rel_type))&&!(null==s||!s.rel_type||!s.event_id||e&&s.rel_type!==e)}getRelation(){var e;return this.isRelation()&&null!==(e=this.getWireContent()["m.relates_to"])&&void 0!==e?e:null}makeReplaced(e){this.isRedacted()&&e||this.isState()||this._replacingEvent!==e&&(this._replacingEvent=null!=e?e:null,this.emit(v.Replaced,this),this.invalidateExtensibleEvent())}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(e){var t;return null===(t=this.getUnsigned()["m.relations"])||void 0===t?void 0:t[e]}replacingEventId(){const e=this.getServerAggregatedRelation(o.zZ.Replace);return e?e.event_id:this._replacingEvent?this._replacingEvent.getId():void 0}replacingEvent(){return this._replacingEvent}replacingEventDate(){const e=this.getServerAggregatedRelation(o.zZ.Replace);if(e){const t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent){var t;return null!==(t=this._replacingEvent.getDate())&&void 0!==t?t:void 0}}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){const e=this.getRelation();return this.replyEventId?this.replyEventId:e?e.event_id:this.isRedaction()?this.event.redacts:void 0}hasAssociation(){return!!this.getAssociatedId()}updateAssociatedId(e){const t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)}flagCancelled(e=!0){this._isCancelled=e}isCancelled(){return this._isCancelled}toSnapshot(){const e=new f(JSON.parse(JSON.stringify(this.event)));for(const[t,s]of Object.entries(this))"event"!==t&&(e[t]=s);return e}isEquivalentTo(e){if(!e)return!1;if(e===this)return!0;const t=(0,a.hl)(this.event),s=(0,a.hl)(e.event);return JSON.stringify(t)===JSON.stringify(s)}toJSON(){const e=this.getEffectiveEvent();return this.isEncrypted()?{decrypted:e,encrypted:this.event}:e}setVerificationRequest(e){this.verificationRequest=e}setTxnId(e){this.txnId=e}getTxnId(){return this.txnId}setThread(e){this.isState()||(this.thread&&this.reEmitter.stopReEmitting(this.thread,[d.ju.Update]),this.thread=e,this.setThreadId(null==e?void 0:e.id),e&&this.reEmitter.reEmit(e,[d.ju.Update]))}getThread(){return this.thread}setThreadId(e){this.threadId=e}}const y=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),S={[o.Bx.RoomMember]:{membership:1},[o.Bx.RoomJoinRules]:{join_rule:1},[o.Bx.RoomPowerLevels]:{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1}}},"./node_modules/matrix-js-sdk/src/models/invites-ignorer.ts":(e,t,s)=>{"use strict";s.d(t,{bp:()=>m});var i=s("./node_modules/matrix-events-sdk/lib/index.js"),n=s("./node_modules/matrix-js-sdk/src/models/event-timeline.ts"),r=s("./node_modules/matrix-js-sdk/src/@types/partials.ts"),o=s("./node_modules/matrix-js-sdk/src/utils.ts"),a=s("./node_modules/matrix-js-sdk/src/@types/event.ts");const d=new i.UnstableValue("m.policies","org.matrix.msc3847.policies"),c=new i.UnstableValue("m.ignore.invites","org.matrix.msc3847.ignore.invites");let l=function(e){return e.Ban="m.ban",e}({}),u=function(e){return e.User="m.policy.user",e.Room="m.policy.room",e.Server="m.policy.server",e}({});const h={[u.User]:a.Bx.PolicyRuleUser,[u.Room]:a.Bx.PolicyRuleRoom,[u.Server]:a.Bx.PolicyRuleServer};class m{constructor(e){this.client=e}async addRule(e,t,s){const i=await this.getOrCreateTargetRoom();return(await this.client.sendStateEvent(i.roomId,h[e],{entity:t,reason:s,recommendation:l.Ban})).event_id}async removeRule(e){await this.client.redactEvent(e.getRoomId(),e.getId())}async addSource(e){await this.client.joinRoom(e);const t=(await this.getOrCreateSourceRooms()).map((e=>e.roomId));return!t.includes(e)&&(t.push(e),await this.withIgnoreInvitesPolicies((e=>{e.sources=t})),!0)}async getRuleForInvite({sender:e,roomId:t}){const s=await this.getOrCreateSourceRooms(),i=e.split(":")[1],r=t.split(":")[1];for(const a of s){const s=a.getUnfilteredTimelineSet().getLiveTimeline().getState(n.q.FORWARDS);for(const{scope:n,entities:a}of[{scope:u.Room,entities:[t]},{scope:u.User,entities:[e]},{scope:u.Server,entities:[i,r]}]){const e=s.getStateEvents(h[n]);for(const t of e){const e=t.getContent();if((null==e?void 0:e.recommendation)!=l.Ban)continue;const s=null==e?void 0:e.entity;if(!s)continue;let i;try{i=new RegExp((0,o.dn)(s))}catch(e){continue}for(const e of a)if(e&&i.test(e))return t}}}return null}async getOrCreateTargetRoom(){let e=this.getIgnoreInvitesPolicies().target;if("string"!=typeof e&&(e=null),e){const t=this.client.getRoom(e);if(t)return t;e=null}return e=(await this.client.createRoom({name:"Individual Policy Room",preset:r.k.PrivateChat})).room_id,await this.withIgnoreInvitesPolicies((t=>{t.target=e})),this.client.getRoom(e)}async getOrCreateSourceRooms(){let e=this.getIgnoreInvitesPolicies().sources,t=!1;Array.isArray(e)||(t=!0,e=[]);let s=e.filter((e=>"string"==typeof e)).map((e=>this.client.getRoom(e))).filter((e=>!!e));if(s.length!=e.length&&(t=!0),0==s.length){t=!0,s=[await this.getOrCreateTargetRoom()]}return t&&await this.withIgnoreInvitesPolicies((t=>{t.sources=e})),s}getIgnoreInvitesPolicies(){return this.getPoliciesAndIgnoreInvitesPolicies().ignoreInvitesPolicies}async withIgnoreInvitesPolicies(e){const{policies:t,ignoreInvitesPolicies:s}=this.getPoliciesAndIgnoreInvitesPolicies();e(s),t[c.name]=s,await this.client.setAccountData(d.name,t)}getPoliciesAndIgnoreInvitesPolicies(){let e={};for(const s of[d.name,d.altName]){var t;if(!s)continue;const i=null===(t=this.client.getAccountData(s))||void 0===t?void 0:t.getContent();if(i){e=i;break}}let s={},i=!1;for(const t of[c.name,c.altName]){if(!t)continue;const n=e[t];if(n&&"object"==typeof n){s=n,i=!0;break}}return i||(e[c.name]=s),{policies:e,ignoreInvitesPolicies:s}}}},"./node_modules/matrix-js-sdk/src/models/poll.ts":(e,t,s)=>{"use strict";s.d(t,{Wi:()=>u,sP:()=>l,sn:()=>d});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-events-sdk/lib/index.js"),r=s("./node_modules/matrix-js-sdk/src/@types/polls.ts"),o=s("./node_modules/matrix-js-sdk/src/models/relations.ts"),a=s("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts");let d=function(e){return e.New="Poll.new",e.End="Poll.end",e.Update="Poll.update",e.Responses="Poll.Responses",e.Destroy="Poll.Destroy",e.UndecryptableRelations="Poll.UndecryptableRelations",e}({});const c=(e,t)=>({responseEvents:e.filter((e=>{if(!e.isDecryptionFailure())return r.qN.matches(e.getType())&&e.getTs()<=t}))});class l extends a.X{constructor(e,t,s){if(super(),(0,i.A)(this,"roomId",void 0),(0,i.A)(this,"pollEvent",void 0),(0,i.A)(this,"_isFetchingResponses",!1),(0,i.A)(this,"relationsNextBatch",void 0),(0,i.A)(this,"responses",null),(0,i.A)(this,"endEvent",void 0),(0,i.A)(this,"undecryptableRelationEventIds",new Set),(0,i.A)(this,"countUndecryptableEvents",(e=>{const t=e.filter((e=>e.isDecryptionFailure())).map((e=>e.getId())),s=this.undecryptableRelationsCount;this.undecryptableRelationEventIds=new Set([...this.undecryptableRelationEventIds,...t]),this.undecryptableRelationsCount!==s&&this.emit(d.UndecryptableRelations,this.undecryptableRelationsCount)})),this.rootEvent=e,this.matrixClient=t,this.room=s,!this.rootEvent.getRoomId()||!this.rootEvent.getId())throw new Error("Invalid poll start event.");this.roomId=this.rootEvent.getRoomId(),this.pollEvent=this.rootEvent.unstableExtensibleEvent}get pollId(){return this.rootEvent.getId()}get endEventId(){var e;return null===(e=this.endEvent)||void 0===e?void 0:e.getId()}get isEnded(){return!!this.endEvent}get isFetchingResponses(){return this._isFetchingResponses}get undecryptableRelationsCount(){return this.undecryptableRelationEventIds.size}async getResponses(){return this.responses||this.isFetchingResponses||await this.fetchResponses(),this.responses}onNewRelation(e){var t;if(r.cI.matches(e.getType())&&this.validateEndEvent(e)&&(this.endEvent=e,this.refilterResponsesOnEnd(),this.emit(d.End)),!this.responses)return;const s=(null===(t=this.endEvent)||void 0===t?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:i}=c([e],s);this.countUndecryptableEvents([e]),i.length&&(i.forEach((e=>{this.responses.addEvent(e)})),this.emit(d.Responses,this.responses))}async fetchResponses(){var e,t;this._isFetchingResponses=!0;const s=await this.matrixClient.relations(this.roomId,this.rootEvent.getId(),"m.reference",void 0,{from:this.relationsNextBatch||void 0});await Promise.all(s.events.map((e=>this.matrixClient.decryptEventIfNeeded(e))));const i=this.responses||new o.s("m.reference",r.qN.name,this.matrixClient,[r.qN.altName]),n=s.events.find((e=>r.cI.matches(e.getType())));this.validateEndEvent(n)&&(this.endEvent=n,this.refilterResponsesOnEnd(),this.emit(d.End));const a=(null===(e=this.endEvent)||void 0===e?void 0:e.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:l}=c(s.events,a);l.forEach((e=>{i.addEvent(e)})),this.relationsNextBatch=null!==(t=s.nextBatch)&&void 0!==t?t:void 0,this.responses=i,this.countUndecryptableEvents(s.events),this.relationsNextBatch?this.fetchResponses():this._isFetchingResponses=!1,this.emit(d.Responses,this.responses)}refilterResponsesOnEnd(){var e;if(!this.responses)return;const t=(null===(e=this.endEvent)||void 0===e?void 0:e.getTs())||Number.MAX_SAFE_INTEGER;this.responses.getRelations().forEach((e=>{var s;e.getTs()>t&&(null===(s=this.responses)||void 0===s||s.removeEvent(e))})),this.emit(d.Responses,this.responses)}validateEndEvent(e){if(!e)return!1;if(this.endEvent&&this.endEvent.getTs()<e.getTs())return!1;const t=this.room.currentState,s=e.getSender();return!!s&&(s===this.rootEvent.getSender()||t.maySendRedactionForEvent(this.rootEvent,s))}}const u=e=>{const t=e.getType();return n.M_POLL_START.matches(t)||r.qN.matches(t)||r.cI.matches(t)}},"./node_modules/matrix-js-sdk/src/models/read-receipt.ts":(e,t,s)=>{"use strict";s.d(t,{D:()=>p,h:()=>g});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/@types/read_receipts.ts"),r=s("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),o=s("./node_modules/matrix-js-sdk/src/utils.ts"),a=s("./node_modules/matrix-js-sdk/src/models/event.ts"),d=s("./node_modules/matrix-js-sdk/src/@types/event.ts"),c=s("./node_modules/matrix-js-sdk/src/models/room.ts"),l=s("./node_modules/matrix-js-sdk/src/logger.ts"),u=s("./node_modules/matrix-js-sdk/src/client.ts");function h(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function m(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?h(Object(s),!0).forEach((function(t){(0,i.A)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):h(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}function p(e,t,s,i=!1){return new a.kl({content:{[t.getId()]:{[s]:{[e]:m({ts:t.getTs()},!i&&{thread_id:(0,u.Xb)(t)})}}},type:d.Bx.Receipt,room_id:t.getRoomId()})}class g extends r.X{constructor(...e){super(...e),(0,i.A)(this,"receipts",new o.kG((()=>new Map))),(0,i.A)(this,"receiptCacheByEventId",new Map)}getReadReceiptForUserId(e,t=!1,s=n.L.Read){var i,r;const[o,a]=null!==(i=null===(r=this.receipts.get(s))||void 0===r?void 0:r.get(e))&&void 0!==i?i:[null,null];return t?o:null!=a?a:o}compareReceipts(e,t){var s;return null!==(s=this.getUnfilteredTimelineSet().compareEventOrdering(e.eventId,t.eventId))&&void 0!==s?s:e.data.ts-t.data.ts}getEventReadUpTo(e,t=!1){const s=this.getLatestReceipt(e,t);return s&&this.receiptPointsAtConsistentEvent(s)?s.eventId:null}receiptPointsAtConsistentEvent(e){var t;const s=this.findEventById(e.eventId);if(!s)return!1;if(null===(t=e.data)||void 0===t||!t.thread_id)return!0;if(e.data.thread_id===n.S){if((0,u.fN)(s))return!0}else if(s.threadRootId===e.data.thread_id)return!0;return l.v.warn(`Ignoring receipt because its thread_id (${e.data.thread_id}) disagrees with the thread root (${s.threadRootId}) of the referenced event (event ID = ${e.eventId})`),!1}getLatestReceipt(e,t){var s,i;const r=this.getReadReceiptForUserId(e,t,n.L.Read),o=this.getReadReceiptForUserId(e,t,n.L.ReadPrivate);let a;return null!=r&&r.eventId&&null!=o&&o.eventId&&(a=this.compareReceipts(r,o)),a?null!==(i=a<0?o:r)&&void 0!==i?i:null:null!==(s=null!=o?o:r)&&void 0!==s?s:null}addReceiptToStructure(e,t,s,i,n){var r,o;const a=this.receipts.getOrCreate(t);let d=a.get(s);d||(d=[null,null],a.set(s,d));let c=d[0];var l;n&&(c=null!==(l=d[1])&&void 0!==l?l:d[0]);const u={eventId:e,data:i};if(c){if(this.compareReceipts(c,u)>=0)return}const h=n?d[0]:u,m=n?u:d[1];let p=null;h&&m&&(p=this.getUnfilteredTimelineSet().compareEventOrdering(h.eventId,m.eventId));const g=null===p||p<0,v=null!==(r=d[1])&&void 0!==r?r:d[0];n&&g?d[1]=u:n||(d[0]=u,g||(d[1]=null));if(v!==(null!==(o=d[1])&&void 0!==o?o:d[0])){if(v&&this.receiptCacheByEventId.get(v.eventId)){const e=v.eventId;this.receiptCacheByEventId.set(e,this.receiptCacheByEventId.get(e).filter((e=>e.type!==t||e.userId!==s))),this.receiptCacheByEventId.get(e).length<1&&this.receiptCacheByEventId.delete(e)}this.receiptCacheByEventId.get(e)||this.receiptCacheByEventId.set(e,[]),this.receiptCacheByEventId.get(e).push({userId:s,type:t,data:i})}}getReceiptsForEvent(e){return this.receiptCacheByEventId.get(e.getId())||[]}fixupNotifications(e){const t=this.getReadReceiptForUserId(e,!1),s=this.timeline[this.timeline.length-1];s&&(null==t?void 0:t.eventId)===s.getId()&&e===s.getSender()&&(this.setUnread(c.X5.Total,0),this.setUnread(c.X5.Highlight,0))}addLocalEchoReceipt(e,t,s,i=!1){this.addReceipt(p(e,t,s,i),!0)}getUsersReadUpTo(e){return this.getReceiptsForEvent(e).filter((function(e){return(0,o.ll)(e.type)})).map((function(e){return e.userId}))}}},"./node_modules/matrix-js-sdk/src/models/relations-container.ts":(e,t,s)=>{"use strict";s.d(t,{t:()=>o});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/models/relations.ts"),r=s("./node_modules/matrix-js-sdk/src/models/event.ts");class o{constructor(e,t){(0,i.A)(this,"relations",new Map),this.client=e,this.room=t}getChildEventsForEvent(e,t,s){var i;return null===(i=this.relations.get(e))||void 0===i||null===(i=i.get(t))||void 0===i?void 0:i.get(s)}getAllChildEventsForEvent(e){var t;const s=null!==(t=this.relations.get(e))&&void 0!==t?t:new Map,i=[];for(const e of s.values())for(const t of e.values())i.push(...t.getRelations());return i}aggregateParentEvent(e){const t=this.relations.get(e.getId());if(t)for(const s of t.values())for(const t of s.values())t.setTargetEvent(e)}aggregateChildEvent(e,t){if(e.isRedacted()||e.status===r.fb.CANCELLED)return;const s=e.getRelation();if(!s)return;const i=()=>{e.isDecryptionFailure()?e.once(r.OQ.Decrypted,i):this.aggregateChildEvent(e,t)};if(e.isBeingDecrypted()||e.shouldAttemptDecryption())return void e.once(r.OQ.Decrypted,i);const{event_id:o,rel_type:a}=s,d=e.getType();let c=this.relations.get(o);c||(c=new Map,this.relations.set(o,c));let l=c.get(a);l||(l=new Map,c.set(a,l));let u=l.get(d);if(!u){var h,m,p;u=new n.s(a,d,this.client),l.set(d,u);const e=null!==(h=this.room)&&void 0!==h?h:null==t?void 0:t.room,s=null!==(m=null!==(p=null==t?void 0:t.findEventById(o))&&void 0!==p?p:null==e?void 0:e.findEventById(o))&&void 0!==m?m:null==e?void 0:e.getPendingEvent(o);s&&u.setTargetEvent(s)}u.addEvent(e)}}},"./node_modules/matrix-js-sdk/src/models/relations.ts":(e,t,s)=>{"use strict";s.d(t,{s:()=>l});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/models/event.ts"),r=s("./node_modules/matrix-js-sdk/src/logger.ts"),o=s("./node_modules/matrix-js-sdk/src/@types/event.ts"),a=s("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),d=s("./node_modules/matrix-js-sdk/src/models/room.ts");let c=function(e){return e.Add="Relations.add",e.Remove="Relations.remove",e.Redaction="Relations.redaction",e}({});class l extends a.X{constructor(e,t,s,r){super(),(0,i.A)(this,"relationEventIds",new Set),(0,i.A)(this,"relations",new Set),(0,i.A)(this,"annotationsByKey",{}),(0,i.A)(this,"annotationsBySender",{}),(0,i.A)(this,"sortedAnnotationsByKey",[]),(0,i.A)(this,"targetEvent",null),(0,i.A)(this,"creationEmitted",!1),(0,i.A)(this,"client",void 0),(0,i.A)(this,"onEventStatus",((e,t)=>{e.isSending()?t===n.fb.CANCELLED&&(e.removeListener(n.OQ.Status,this.onEventStatus),this.removeEvent(e)):e.removeListener(n.OQ.Status,this.onEventStatus)})),(0,i.A)(this,"onBeforeRedaction",(async e=>{if(this.relations.has(e)){if(this.relations.delete(e),this.relationType===o.zZ.Annotation)this.removeAnnotationFromAggregation(e);else if(this.relationType===o.zZ.Replace&&this.targetEvent&&!this.targetEvent.isState()){const e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}e.removeListener(n.OQ.BeforeRedaction,this.onBeforeRedaction),this.emit(c.Redaction,e)}})),this.relationType=e,this.eventType=t,this.altEventTypes=r,this.client=s instanceof d.Wv?s.client:s}async addEvent(e){if(this.relationEventIds.has(e.getId()))return;const t=e.getRelation();if(!t)return void r.v.error("Event must have relation info");const s=t.rel_type,i=e.getType();if(this.relationType===s&&((e,t,s=[])=>[t,...s].includes(e))(i,this.eventType,this.altEventTypes)){if(e.isSending()&&e.on(n.OQ.Status,this.onEventStatus),this.relations.add(e),this.relationEventIds.add(e.getId()),this.relationType===o.zZ.Annotation)this.addAnnotationToAggregation(e);else if(this.relationType===o.zZ.Replace&&this.targetEvent&&!this.targetEvent.isState()){const e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}e.on(n.OQ.BeforeRedaction,this.onBeforeRedaction),this.emit(c.Add,e),this.maybeEmitCreated()}else r.v.error("Event relation info doesn't match this container")}async removeEvent(e){if(this.relations.has(e)){if(this.relations.delete(e),this.relationType===o.zZ.Annotation)this.removeAnnotationFromAggregation(e);else if(this.relationType===o.zZ.Replace&&this.targetEvent&&!this.targetEvent.isState()){const e=await this.getLastReplacement();this.targetEvent.makeReplaced(e)}this.emit(c.Remove,e)}}getRelations(){return[...this.relations]}addAnnotationToAggregation(e){var t;const{key:s}=null!==(t=e.getRelation())&&void 0!==t?t:{};if(!s)return;let i=this.annotationsByKey[s];i||(i=this.annotationsByKey[s]=new Set,this.sortedAnnotationsByKey.push([s,i])),i.add(e),this.sortedAnnotationsByKey.sort(((e,t)=>{const s=e[1];return t[1].size-s.size}));const n=e.getSender();let r=this.annotationsBySender[n];r||(r=this.annotationsBySender[n]=new Set),r.add(e)}removeAnnotationFromAggregation(e){var t;const{key:s}=null!==(t=e.getRelation())&&void 0!==t?t:{};if(!s)return;const i=this.annotationsByKey[s];i&&(i.delete(e),this.sortedAnnotationsByKey.sort(((e,t)=>{const s=e[1];return t[1].size-s.size})));const n=e.getSender(),r=this.annotationsBySender[n];r&&r.delete(e)}getSortedAnnotationsByKey(){return this.relationType!==o.zZ.Annotation?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return this.relationType!==o.zZ.Annotation?null:this.annotationsBySender}async getLastReplacement(){if(this.relationType!==o.zZ.Replace)return null;if(!this.targetEvent)return null;const e=this.targetEvent.getServerAggregatedRelation(o.zZ.Replace),t=null==e?void 0:e.origin_server_ts,s=this.getRelations().reduce(((e,s)=>s.getSender()!==this.targetEvent.getSender()||t&&t>s.getTs()||e&&e.getTs()>s.getTs()?e:s),null);return null!=s&&s.shouldAttemptDecryption()&&this.client.isCryptoEnabled()?await s.attemptDecryption(this.client.crypto):null!=s&&s.isBeingDecrypted()&&await s.getDecryptionPromise(),s}async setTargetEvent(e){if(!this.targetEvent){if(this.targetEvent=e,this.relationType===o.zZ.Replace&&!this.targetEvent.isState()){const e=await this.getLastReplacement();e&&this.targetEvent.makeReplaced(e)}this.maybeEmitCreated()}}maybeEmitCreated(){this.creationEmitted||this.targetEvent&&this.relations.size&&(this.creationEmitted=!0,this.targetEvent.emit(n.OQ.RelationsCreated,this.relationType,this.eventType))}}},"./node_modules/matrix-js-sdk/src/models/room-member.ts":(e,t,s)=>{"use strict";s.d(t,{Y:()=>u,o:()=>l});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/content-repo.ts"),r=s("./node_modules/matrix-js-sdk/src/utils.ts"),o=s("./node_modules/matrix-js-sdk/src/logger.ts"),a=s("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),d=s("./node_modules/matrix-js-sdk/src/@types/event.ts"),c=s("./node_modules/matrix-js-sdk/src/@types/membership.ts");let l=function(e){return e.Membership="RoomMember.membership",e.Name="RoomMember.name",e.PowerLevel="RoomMember.powerLevel",e.Typing="RoomMember.typing",e}({});class u extends a.X{constructor(e,t){super(),(0,i.A)(this,"_isOutOfBand",!1),(0,i.A)(this,"modified",-1),(0,i.A)(this,"requestedProfileInfo",!1),(0,i.A)(this,"typing",!1),(0,i.A)(this,"name",void 0),(0,i.A)(this,"rawDisplayName",void 0),(0,i.A)(this,"powerLevel",0),(0,i.A)(this,"powerLevelNorm",0),(0,i.A)(this,"user",void 0),(0,i.A)(this,"membership",void 0),(0,i.A)(this,"disambiguate",!1),(0,i.A)(this,"events",{}),this.roomId=e,this.userId=t,this.name=t,this.rawDisplayName=t,this.updateModifiedTime()}markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}setMembershipEvent(e,t){var s,i;const n=null!==(s=e.getDirectionalContent().displayname)&&void 0!==s?s:"";if(e.getType()!==d.Bx.RoomMember)return;this._isOutOfBand=!1,this.events.member=e;const a=this.membership;this.membership=e.getDirectionalContent().membership,void 0===this.membership&&o.v.trace(`membership event with membership undefined (forwardLooking: ${e.forwardLooking})!`,e.getContent(),"prevcontent is ",e.getPrevContent()),this.disambiguate=function(e,t,s){if(!t||t===e)return!1;if(!(0,r.Gp)(t))return!1;if(!s)return!1;if(h.test(t))return!0;if(m.test(t))return!0;const i=s.getUserIdsWithDisplayName(t);return!!i.some((t=>t!==e))}(this.userId,n,t);const c=this.name;this.name=function(e,t,s){return t&&t!==e?s?(0,r.d7)(t)+" ("+e+")":(0,r.Gp)(t)?(0,r.d7)(t):e:e}(this.userId,n,this.disambiguate),this.rawDisplayName=(0,r.d7)(null!==(i=e.getDirectionalContent().displayname)&&void 0!==i?i:""),this.rawDisplayName&&(0,r.Gp)(this.rawDisplayName)||(this.rawDisplayName=this.userId),a!==this.membership&&(this.updateModifiedTime(),this.emit(l.Membership,e,this,a)),c!==this.name&&(this.updateModifiedTime(),this.emit(l.Name,e,this,c))}setPowerLevelEvent(e){if(e.getType()!==d.Bx.RoomPowerLevels||""!==e.getStateKey())return;const t=e.getDirectionalContent();let s=t.users_default||0;const i=t.users||{};Object.values(i).forEach((e=>{s=Math.max(s,e)}));const n=this.powerLevel,r=this.powerLevelNorm;void 0!==i[this.userId]&&Number.isInteger(i[this.userId])?this.powerLevel=i[this.userId]:void 0!==t.users_default?this.powerLevel=t.users_default:this.powerLevel=0,this.powerLevelNorm=0,s>0&&(this.powerLevelNorm=100*this.powerLevel/s),n===this.powerLevel&&r===this.powerLevelNorm||(this.updateModifiedTime(),this.emit(l.PowerLevel,e,this))}setTypingEvent(e){if("m.typing"!==e.getType())return;const t=this.typing;this.typing=!1;const s=e.getContent().user_ids;Array.isArray(s)&&(-1!==s.indexOf(this.userId)&&(this.typing=!0),t!==this.typing&&(this.updateModifiedTime(),this.emit(l.Typing,e,this)))}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}isKicked(){return this.membership===c.O.Leave&&void 0!==this.events.member&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){const e=this.events.member;let t=e.getContent(),s=e.getSender();if(t.membership===c.O.Join&&(t=e.getPrevContent(),s=e.getUnsigned().prev_sender),t.membership===c.O.Invite&&t.is_direct)return s}}getAvatarUrl(e,t,s,i,r=!0,o){const a=this.getMxcAvatarUrl();if(!a&&!r)return null;const d=(0,n.y)(e,a,t,s,i,o);return d||null}getMxcAvatarUrl(){return this.events.member?this.events.member.getDirectionalContent().avatar_url:this.user?this.user.avatarUrl:void 0}}const h=/@.+:.+/,m=/[\u200E\u200F\u202A-\u202F]/},"./node_modules/matrix-js-sdk/src/models/room-state.ts":(e,t,s)=>{"use strict";s.d(t,{H:()=>f,f:()=>v});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/models/room-member.ts"),r=s("./node_modules/matrix-js-sdk/src/logger.ts"),o=s("./node_modules/matrix-js-sdk/src/utils.ts"),a=s("./node_modules/matrix-js-sdk/src/@types/event.ts"),d=s("./node_modules/matrix-js-sdk/src/models/event.ts"),c=s("./node_modules/matrix-js-sdk/src/@types/partials.ts"),l=s("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),u=s("./node_modules/matrix-js-sdk/src/models/beacon.ts"),h=s("./node_modules/matrix-js-sdk/src/ReEmitter.ts"),m=s("./node_modules/matrix-js-sdk/src/@types/beacon.ts"),p=s("./node_modules/matrix-js-sdk/src/@types/membership.ts"),g=function(e){return e[e.NotStarted=0]="NotStarted",e[e.InProgress=1]="InProgress",e[e.Finished=2]="Finished",e}(g||{});let v=function(e){return e.Events="RoomState.events",e.Members="RoomState.members",e.NewMember="RoomState.newMember",e.Update="RoomState.update",e.BeaconLiveness="RoomState.BeaconLiveness",e.Marker="RoomState.Marker",e}({});class f extends l.X{constructor(e,t={status:g.NotStarted},s=!1){super(),(0,i.A)(this,"reEmitter",new h.Q(this)),(0,i.A)(this,"sentinels",{}),(0,i.A)(this,"displayNameToUserIds",new Map),(0,i.A)(this,"userIdsToDisplayNames",{}),(0,i.A)(this,"tokenToInvite",{}),(0,i.A)(this,"joinedMemberCount",null),(0,i.A)(this,"summaryJoinedMemberCount",null),(0,i.A)(this,"invitedMemberCount",null),(0,i.A)(this,"summaryInvitedMemberCount",null),(0,i.A)(this,"modified",-1),(0,i.A)(this,"members",{}),(0,i.A)(this,"events",new Map),(0,i.A)(this,"paginationToken",null),(0,i.A)(this,"beacons",new Map),(0,i.A)(this,"_liveBeaconIds",[]),this.roomId=e,this.oobMemberFlags=t,this.isStartTimelineState=s,this.updateModifiedTime()}getJoinedMemberCount(){return null!==this.summaryJoinedMemberCount?this.summaryJoinedMemberCount:(null===this.joinedMemberCount&&(this.joinedMemberCount=this.getMembers().reduce(((e,t)=>t.membership===p.O.Join?e+1:e),0)),this.joinedMemberCount)}setJoinedMemberCount(e){this.summaryJoinedMemberCount=e}getInvitedMemberCount(){return null!==this.summaryInvitedMemberCount?this.summaryInvitedMemberCount:(null===this.invitedMemberCount&&(this.invitedMemberCount=this.getMembers().reduce(((e,t)=>t.membership===p.O.Invite?e+1:e),0)),this.invitedMemberCount)}setInvitedMemberCount(e){this.summaryInvitedMemberCount=e}getMembers(){return Object.values(this.members)}getMembersExcept(e){return this.getMembers().filter((t=>!e.includes(t.userId)))}getMember(e){return this.members[e]||null}getSentinelMember(e){if(!e)return null;let t=this.sentinels[e];if(void 0===t){t=new n.Y(this.roomId,e);const s=this.members[e];null!=s&&s.events.member&&t.setMembershipEvent(s.events.member,this),this.sentinels[e]=t}return t}getStateEvents(e,t){if(!this.events.has(e))return void 0===t?[]:null;if(void 0===t)return Array.from(this.events.get(e).values());const s=this.events.get(e).get(t);return s||null}get hasLiveBeacons(){var e;return!(null===(e=this.liveBeaconIds)||void 0===e||!e.length)}get liveBeaconIds(){return this._liveBeaconIds}clone(){const e=new f(this.roomId,this.oobMemberFlags),t=this.oobMemberFlags.status;return this.oobMemberFlags.status=g.NotStarted,Array.from(this.events.values()).forEach((t=>{e.setStateEvents(Array.from(t.values()))})),this.oobMemberFlags.status=t,null!==this.summaryInvitedMemberCount&&e.setInvitedMemberCount(this.getInvitedMemberCount()),null!==this.summaryJoinedMemberCount&&e.setJoinedMemberCount(this.getJoinedMemberCount()),this.oobMemberFlags.status==g.Finished&&this.getMembers().forEach((t=>{var s;t.isOutOfBand()&&(null===(s=e.getMember(t.userId))||void 0===s||s.markOutOfBand())})),e}setUnknownStateEvents(e){const t=e.filter((e=>!this.events.has(e.getType())||!this.events.get(e.getType()).has(e.getStateKey())));this.setStateEvents(t)}setStateEvents(e,t){this.updateModifiedTime(),e.forEach((e=>{var t,s;if(e.getRoomId()!==this.roomId||!e.isState())return;m.E.matches(e.getType())&&this.setBeacon(e);const i=this.getStateEventMatching(e),n=null==i||null===(t=i.event.unsigned)||void 0===t?void 0:t.replaces_state,r=null==i?void 0:i.event.event_id,o=null===(s=e.event.unsigned)||void 0===s?void 0:s.replaces_state,d=e.event.event_id;if(this.isStartTimelineState){if(o&&r&&o===r)return}else if(n&&d&&n===d)return;var c;(this.setStateEvent(e),e.getType()===a.Bx.RoomMember)&&(this.updateDisplayNameCache(e.getStateKey(),null!==(c=e.getContent().displayname)&&void 0!==c?c:""),this.updateThirdPartyTokenCache(e));this.emit(v.Events,e,this,i)})),this.onBeaconLivenessChange(),e.forEach((e=>{if(e.getRoomId()===this.roomId&&e.isState())if(e.getType()===a.Bx.RoomMember){const t=e.getStateKey();e.getContent().membership!==p.O.Leave&&e.getContent().membership!==p.O.Ban||(e.getContent().avatar_url=e.getContent().avatar_url||e.getPrevContent().avatar_url,e.getContent().displayname=e.getContent().displayname||e.getPrevContent().displayname);const s=this.getOrCreateMember(t,e);s.setMembershipEvent(e,this),this.updateMember(s),this.emit(v.Members,e,this,s)}else if(e.getType()===a.Bx.RoomPowerLevels){if(""!==e.getStateKey())return;Object.values(this.members).forEach((t=>{const s=t.getLastModifiedTime();t.setPowerLevelEvent(e),s!==t.getLastModifiedTime()&&this.emit(v.Members,e,this,t)})),this.sentinels={}}else a.ge.matches(e.getType())&&this.emit(v.Marker,e,t)})),this.emit(v.Update,this)}async processBeaconEvents(e,t){if(!e.length||!this.beacons.size)return;const s=[...this.beacons.values()].reduce(((e,t)=>(e[t.beaconInfoId]=t,e)),{}),i=(e,t)=>{if(!m.z.matches(t.getType()))return;const i=s[e];i&&i.addLocations([t])};for(const r of e){var n;const e=null===(n=r.getRelation())||void 0===n?void 0:n.event_id;if(!e||!s[e])return;if(!m.z.matches(r.getType())&&!r.isEncrypted())return;try{await t.decryptEventIfNeeded(r),i(e,r)}catch{r.isDecryptionFailure()&&r.once(d.OQ.Decrypted,(async()=>{i(e,r)}))}}}getOrCreateMember(e,t){let s=this.members[e];return s||(s=new n.Y(this.roomId,e),this.members[e]=s,this.emit(v.NewMember,t,this,s)),s}setStateEvent(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)}setBeacon(e){const t=(0,u.M9)(e);if(this.beacons.has(t)){const i=this.beacons.get(t);var s;return e.isRedacted()?void(i.beaconInfoId===(null===(s=e.getRedactionEvent())||void 0===s?void 0:s.redacts)&&(i.destroy(),this.beacons.delete(t))):i.update(e)}if(e.isRedacted())return;const i=new u.HF(e);this.reEmitter.reEmit(i,[u.JH.New,u.JH.Update,u.JH.Destroy,u.JH.LivenessChange]),this.emit(u.JH.New,e,i),i.on(u.JH.LivenessChange,this.onBeaconLivenessChange.bind(this)),i.on(u.JH.Destroy,this.onBeaconLivenessChange.bind(this)),this.beacons.set(i.identifier,i)}onBeaconLivenessChange(){this._liveBeaconIds=Array.from(this.beacons.values()).filter((e=>e.isLive)).map((e=>e.identifier)),this.emit(v.BeaconLiveness,this,this.hasLiveBeacons)}getStateEventMatching(e){var t,s;return null!==(t=null===(s=this.events.get(e.getType()))||void 0===s?void 0:s.get(e.getStateKey()))&&void 0!==t?t:null}updateMember(e){const t=this.getStateEvents(a.Bx.RoomPowerLevels,"");t&&e.setPowerLevelEvent(t),delete this.sentinels[e.userId],this.members[e.userId]=e,this.joinedMemberCount=null,this.invitedMemberCount=null}needsOutOfBandMembers(){return this.oobMemberFlags.status===g.NotStarted}outOfBandMembersReady(){return this.oobMemberFlags.status===g.Finished}markOutOfBandMembersStarted(){this.oobMemberFlags.status===g.NotStarted&&(this.oobMemberFlags.status=g.InProgress)}markOutOfBandMembersFailed(){this.oobMemberFlags.status===g.InProgress&&(this.oobMemberFlags.status=g.NotStarted)}clearOutOfBandMembers(){let e=0;Object.keys(this.members).forEach((t=>{this.members[t].isOutOfBand()&&(++e,delete this.members[t])})),r.v.log(`LL: RoomState removed ${e} members...`),this.oobMemberFlags.status=g.NotStarted}setOutOfBandMembers(e){r.v.log(`LL: RoomState about to set ${e.length} OOB members ...`),this.oobMemberFlags.status===g.InProgress&&(r.v.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=g.Finished,e.forEach((e=>this.setOutOfBandMember(e))),this.emit(v.Update,this))}setOutOfBandMember(e){if(e.getType()!==a.Bx.RoomMember)return;const t=e.getStateKey(),s=this.getMember(t);if(s&&!s.isOutOfBand())return;const i=this.getOrCreateMember(t,e);i.setMembershipEvent(e,this),i.markOutOfBand(),this.updateDisplayNameCache(i.userId,i.name),this.setStateEvent(e),this.updateMember(i),this.emit(v.Members,e,this,i)}setTypingEvent(e){Object.values(this.members).forEach((function(t){t.setTypingEvent(e)}))}getInviteForThreePidToken(e){return this.tokenToInvite[e]||null}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getUserIdsWithDisplayName(e){var t;return null!==(t=this.displayNameToUserIds.get((0,o.Gp)(e)))&&void 0!==t?t:[]}maySendRedactionForEvent(e,t){const s=this.getMember(t);if(!s||s.membership===p.O.Leave)return!1;if(e.status||e.isRedacted())return!1;return!!this.maySendEvent(a.Bx.RoomRedaction,t)&&(e.getSender()===t||this.hasSufficientPowerLevelFor("redact",s.powerLevel))}hasSufficientPowerLevelFor(e,t){const s=this.getStateEvents(a.Bx.RoomPowerLevels,"");let i={};s&&(i=s.getContent());let n=50;return(0,o.Et)(i[e])&&(n=i[e]),t>=n}maySendMessage(e){return this.maySendEventOfType(a.Bx.RoomMessage,e,!1)}maySendEvent(e,t){return this.maySendEventOfType(e,t,!1)}mayClientSendStateEvent(e,t){return!(t.isGuest()||!t.credentials.userId)&&this.maySendStateEvent(e,t.credentials.userId)}maySendStateEvent(e,t){return this.maySendEventOfType(e,t,!0)}maySendEventOfType(e,t,s){const i=this.getStateEvents(a.Bx.RoomPowerLevels,"");let n,r={},o=0,d=0,c=0;if(i){n=i.getContent(),r=n.events||{},o=Number.isSafeInteger(n.state_default)?n.state_default:50;const e=n.users&&n.users[t];Number.isSafeInteger(e)?c=e:Number.isSafeInteger(n.users_default)&&(c=n.users_default),Number.isSafeInteger(n.events_default)&&(d=n.events_default)}let l=s?o:d;return Number.isSafeInteger(r[e])&&(l=r[e]),c>=l}mayTriggerNotifOfType(e,t){const s=this.getMember(t);if(!s)return!1;const i=this.getStateEvents(a.Bx.RoomPowerLevels,"");let n=50;return i&&i.getContent()&&i.getContent().notifications&&(0,o.Et)(i.getContent().notifications[e])&&(n=i.getContent().notifications[e]),s.powerLevel>=n}getJoinRule(){var e;const t=this.getStateEvents(a.Bx.RoomJoinRules,"");return(null!==(e=null==t?void 0:t.getContent())&&void 0!==e?e:{}).join_rule||c.dx.Invite}getHistoryVisibility(){var e;const t=this.getStateEvents(a.Bx.RoomHistoryVisibility,"");return(null!==(e=null==t?void 0:t.getContent())&&void 0!==e?e:{}).history_visibility||c.Jv.Shared}getGuestAccess(){var e;const t=this.getStateEvents(a.Bx.RoomGuestAccess,"");return(null!==(e=null==t?void 0:t.getContent())&&void 0!==e?e:{}).guest_access||c.rF.Forbidden}findPredecessor(e=!1){if(e){const e=this.getStateEvents(a.Bx.RoomPredecessor,"");if(e){const t=e.getContent(),s=t.predecessor_room_id;let i=t.last_known_event_id;"string"!=typeof i&&(i=void 0);let n=t.via_servers;if(Array.isArray(n)||(n=void 0),"string"==typeof s)return{roomId:s,eventId:i,viaServers:n}}}const t=this.getStateEvents(a.Bx.RoomCreate,"");if(t){const e=t.getContent().predecessor;if(e){const t=e.room_id;if("string"==typeof t){let s=e.event_id;return"string"==typeof s&&""!==s||(s=void 0),{roomId:t,eventId:s}}}}return null}updateThirdPartyTokenCache(e){if(!e.getContent().third_party_invite)return;const t=(e.getContent().third_party_invite.signed||{}).token;if(!t)return;this.getStateEvents(a.Bx.RoomThirdPartyInvite,t)&&(this.tokenToInvite[t]=e)}updateDisplayNameCache(e,t){const s=this.userIdsToDisplayNames[e];if(delete this.userIdsToDisplayNames[e],s){const t=(0,o.Gp)(s),i=this.displayNameToUserIds.get(t);if(i){const s=i.filter((t=>t!==e));this.displayNameToUserIds.set(t,s)}}this.userIdsToDisplayNames[e]=t;const i=t&&(0,o.Gp)(t);if(i){var n;const t=null!==(n=this.displayNameToUserIds.get(i))&&void 0!==n?n:[];t.push(e),this.displayNameToUserIds.set(i,t)}}}},"./node_modules/matrix-js-sdk/src/models/room-summary.ts":(e,t,s)=>{"use strict";s.d(t,{c:()=>i});class i{constructor(e,t){this.roomId=e}}},"./node_modules/matrix-js-sdk/src/models/room.ts":(e,t,s)=>{"use strict";s.d(t,{X5:()=>F,Wv:()=>q,u9:()=>$});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-events-sdk/lib/index.js"),r=s("./node_modules/matrix-js-sdk/src/models/event-timeline-set.ts"),o=s("./node_modules/matrix-js-sdk/src/models/event-timeline.ts"),a=s("./node_modules/matrix-js-sdk/src/content-repo.ts"),d=s("./node_modules/matrix-js-sdk/src/utils.ts"),c=s("./node_modules/matrix-js-sdk/src/models/event.ts"),l=s("./node_modules/matrix-js-sdk/src/models/event-status.ts"),u=s("./node_modules/matrix-js-sdk/src/models/room-member.ts"),h=s("./node_modules/matrix-js-sdk/src/models/room-summary.ts"),m=s("./node_modules/matrix-js-sdk/src/logger.ts"),p=s("./node_modules/matrix-js-sdk/src/ReEmitter.ts"),g=s("./node_modules/matrix-js-sdk/src/@types/event.ts"),v=s("./node_modules/matrix-js-sdk/src/client.ts"),f=s("./node_modules/matrix-js-sdk/src/filter.ts"),y=s("./node_modules/matrix-js-sdk/src/models/room-state.ts"),S=s("./node_modules/matrix-js-sdk/src/models/beacon.ts"),b=s("./node_modules/matrix-js-sdk/src/models/thread.ts"),E=s("./node_modules/matrix-js-sdk/src/@types/read_receipts.ts"),w=s("./node_modules/matrix-js-sdk/src/models/relations-container.ts"),I=s("./node_modules/matrix-js-sdk/src/models/read-receipt.ts"),_=s("./node_modules/matrix-js-sdk/src/models/poll.ts");class k{constructor(e){(0,i.A)(this,"room",void 0),(0,i.A)(this,"threadedReceipts",void 0),(0,i.A)(this,"unthreadedReceipts",void 0),(0,i.A)(this,"danglingReceipts",void 0),(0,i.A)(this,"onTimelineEvent",(e=>{const t=e.getId();if(!t)return;const s=this.danglingReceipts.remove(t);null==s||s.forEach((e=>{e.receipt.thread_id?this.threadedReceipts.set(e.receipt.thread_id,e.eventId,e.receiptType,e.userId,e.receipt.ts,e.synthetic):this.unthreadedReceipts.set(t,e.receiptType,e.userId,e.receipt.ts,e.synthetic)}))})),this.room=e,this.threadedReceipts=new O(e),this.unthreadedReceipts=new A(e),this.danglingReceipts=new M,e.on($.Timeline,this.onTimelineEvent)}add(e,t){for(const[s,i]of Object.entries(e))for(const[e,n]of Object.entries(i))for(const[i,r]of Object.entries(n)){this.room.findEventById(s)?r.thread_id?this.threadedReceipts.set(r.thread_id,s,e,i,r.ts,t):this.unthreadedReceipts.set(s,e,i,r.ts,t):this.danglingReceipts.add(new T(s,e,i,r,t))}}hasUserReadEvent(e,t){const s=this.unthreadedReceipts.get(e);if(s&&D(s.eventId,t,this.room))return!0;const i=this.room.findEventById(t);if(!i)return m.v.warn(`hasUserReadEvent event ID ${t} not found in room ${this.room.roomId}: this shouldn't happen!`),!1;const n=(0,v.Xb)(i),r=this.threadedReceipts.get(n,e);return!(!r||!D(r.eventId,t,this.room))||!!this.userSentLatestEventInThread(n,e)}userSentLatestEventInThread(e,t){var s;const i=e===E.S?this.room.getLiveTimeline().getEvents():null===(s=this.room.getThread(e))||void 0===s?void 0:s.timeline;return!!(i&&i.length>0&&i[i.length-1].getSender()===t)}}class R{constructor(e,t,s){this.eventId=e,this.receiptType=t,this.ts=s}}class T{constructor(e,t,s,i,n){this.eventId=e,this.receiptType=t,this.userId=s,this.receipt=i,this.synthetic=n}}class C{constructor(e){(0,i.A)(this,"room",void 0),(0,i.A)(this,"real",void 0),(0,i.A)(this,"synthetic",void 0),this.room=e,this.real=void 0,this.synthetic=void 0}set(e,t){e?this.synthetic=t:this.real=t,this.synthetic&&this.real&&D(this.real.eventId,this.synthetic.eventId,this.room)&&(this.synthetic=void 0)}get(){var e;return null!==(e=this.synthetic)&&void 0!==e?e:this.real}getByType(e){return e?this.synthetic:this.real}}class A{constructor(e){(0,i.A)(this,"room",void 0),(0,i.A)(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,s,i,n){const r=x(this.data,s,(()=>new C(this.room))),o=r.getByType(n);o&&function(e,t,s){const i=s.compareEventOrdering(e,t);return null!==i&&i>0}(o.eventId,e,this.room)||r.set(n,new R(e,t,i))}get(e){var t;return null===(t=this.data.get(e))||void 0===t?void 0:t.get()}}class O{constructor(e){(0,i.A)(this,"room",void 0),(0,i.A)(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,s,i,n,r){x(this.data,e,(()=>new A(this.room))).set(t,s,i,n,r)}get(e,t){var s;return null===(s=this.data.get(e))||void 0===s?void 0:s.get(t)}}class M{constructor(){(0,i.A)(this,"data",new Map)}add(e){x(this.data,e.eventId,(()=>[])).push(e)}remove(e){const t=this.data.get(e);return this.data.delete(e),t}}function x(e,t,s){const i=e.get(t);if(i)return i;{const i=s();return e.set(t,i),i}}function D(e,t,s){const i=s.compareEventOrdering(e,t);return null!==i&&i>=0}function P(e,t,s){const i=e.findEventById(t),n=e.findEventById(s);if(!i||!n)return null;const r=(0,v.fN)(i),o=(0,v.fN)(n);return r&&o?function(e,t,s,i,n){const r=e.getUnfilteredTimelineSet(),o=r.compareEventOrdering(t,s);if(null!==o)return o;const a=r.getTimelineForEvent(t);if(a===r.getLiveTimeline())return 1;const d=r.getTimelineForEvent(s);if(d===r.getLiveTimeline())return-1;return U(i,n)}(e,t,s,i,n):function(e,t,s,i){const n=(0,v.Xb)(s),r=(0,v.Xb)(i),o=s.getThread();return o&&n===r?o.timelineSet.compareEventOrdering(e,t):U(s,i)}(t,s,i,n)}function U(e,t){const s=e.getTs(),i=t.getTs();return s<i?-1:s>i?1:0}var j=s("./node_modules/matrix-js-sdk/src/@types/membership.ts"),L=s("./node_modules/matrix-js-sdk/src/serverCapabilities.ts");function N(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function K(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?N(Object(s),!0).forEach((function(t){(0,i.A)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):N(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const B=["1","2","3","4","5","6","7","8","9","10"];let F=function(e){return e.Highlight="highlight",e.Total="total",e}({}),$=function(e){return e.MyMembership="Room.myMembership",e.Tags="Room.tags",e.AccountData="Room.accountData",e.Receipt="Room.receipt",e.Name="Room.name",e.Redaction="Room.redaction",e.RedactionCancelled="Room.redactionCancelled",e.LocalEchoUpdated="Room.localEchoUpdated",e.Timeline="Room.timeline",e.TimelineReset="Room.timelineReset",e.TimelineRefresh="Room.TimelineRefresh",e.OldStateUpdated="Room.OldStateUpdated",e.CurrentStateUpdated="Room.CurrentStateUpdated",e.HistoryImportedWithinTimeline="Room.historyImportedWithinTimeline",e.UnreadNotifications="Room.UnreadNotifications",e.Summary="Room.Summary",e}({});class q extends I.h{constructor(e,t,s,n={}){super(),(0,i.A)(this,"reEmitter",void 0),(0,i.A)(this,"txnToEvent",new Map),(0,i.A)(this,"notificationCounts",{}),(0,i.A)(this,"threadNotifications",new Map),(0,i.A)(this,"cachedThreadReadReceipts",new Map),(0,i.A)(this,"oldestThreadedReceiptTs",1/0),(0,i.A)(this,"unthreadedReceipts",new Map),(0,i.A)(this,"timelineSets",void 0),(0,i.A)(this,"polls",new Map),(0,i.A)(this,"threadsTimelineSets",[]),(0,i.A)(this,"filteredTimelineSets",{}),(0,i.A)(this,"timelineNeedsRefresh",!1),(0,i.A)(this,"pendingEventList",void 0),(0,i.A)(this,"blacklistUnverifiedDevices",void 0),(0,i.A)(this,"selfMembership",void 0),(0,i.A)(this,"summaryHeroes",null),(0,i.A)(this,"getTypeWarning",!1),(0,i.A)(this,"getVersionWarning",!1),(0,i.A)(this,"membersPromise",void 0),(0,i.A)(this,"name",void 0),(0,i.A)(this,"normalizedName",void 0),(0,i.A)(this,"tags",{}),(0,i.A)(this,"accountData",new Map),(0,i.A)(this,"summary",null),(0,i.A)(this,"oldState",void 0),(0,i.A)(this,"currentState",void 0),(0,i.A)(this,"relations",void 0),(0,i.A)(this,"threads",new Map),(0,i.A)(this,"visibilityEvents",new Map),(0,i.A)(this,"roomReceipts",new k(this)),(0,i.A)(this,"threadTimelineSetsPromise",null),(0,i.A)(this,"threadsReady",!1),(0,i.A)(this,"updateThreadRootEvents",((e,t,s)=>{var i,n;e.length&&(this.updateThreadRootEvent(null===(i=this.threadsTimelineSets)||void 0===i?void 0:i[0],e,t,s),e.hasCurrentUserParticipated&&this.updateThreadRootEvent(null===(n=this.threadsTimelineSets)||void 0===n?void 0:n[1],e,t,s))})),(0,i.A)(this,"updateThreadRootEvent",((e,t,s,i)=>{e&&t.rootEvent&&(i&&e.removeEvent(t.id),b.jV.hasServerSideSupport?e.addLiveEvent(t.rootEvent,{duplicateStrategy:r.x.Replace,fromCache:!1,roomState:this.currentState}):e.addEventToTimeline(t.rootEvent,e.getLiveTimeline(),{toStartOfTimeline:s}))})),(0,i.A)(this,"applyRedaction",(e=>{if(e.isRedaction()){const t=e.event.redacts,s=t?this.findEventById(t):void 0;if(s){const i=s.threadRootId;if(s.makeRedacted(e,this),s.isState()){const e=this.currentState.getStateEvents(s.getType(),s.getStateKey());(null==e?void 0:e.getId())===s.getId()&&this.currentState.setStateEvents([s])}this.emit($.Redaction,e,this,i),this.visibilityEvents.delete(t),s.isVisibilityEvent()&&this.redactVisibilityChangeEvent(e)}}})),this.roomId=e,this.client=t,this.myUserId=s,this.opts=n,this.setMaxListeners(100),this.reEmitter=new p.Q(this),n.pendingEventOrdering=n.pendingEventOrdering||v.eO.Chronological,this.name=e,this.normalizedName=e,this.relations=new w.t(this.client,this),this.on($.Receipt,this.onReceipt),this.timelineSets=[new r.m(this,n)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),[$.Timeline,$.TimelineReset]),this.fixUpLegacyTimelineFields(),this.opts.pendingEventOrdering===v.eO.Detached&&(this.pendingEventList=[],this.client.store.getPendingEvents(this.roomId).then((e=>{const s=this.client.getEventMapper({toDevice:!1,decrypt:!1});e.forEach((async e=>{const i=s(e);await t.decryptEventIfNeeded(i),i.setStatus(l.f.NOT_SENT),this.addPendingEvent(i,i.getTxnId())}))}))),this.opts.lazyLoadMembers?this.membersPromise=void 0:this.membersPromise=Promise.resolve(!1)}async createThreadsTimelineSets(){var e;if(this.threadTimelineSetsPromise)return this.threadTimelineSetsPromise;if(null!==(e=this.client)&&void 0!==e&&e.supportsThreads())try{this.threadTimelineSetsPromise=Promise.all([this.createThreadTimelineSet(),this.createThreadTimelineSet(b.x3.My)]);const e=await this.threadTimelineSetsPromise;return this.threadsTimelineSets[0]=e[0],this.threadsTimelineSets[1]=e[1],e}catch(e){return this.threadTimelineSetsPromise=null,null}return null}async decryptCriticalEvents(){if(!this.client.isCryptoEnabled())return;const e=this.getEventReadUpTo(this.client.getUserId(),!0),t=this.getLiveTimeline().getEvents(),s=t.findIndex((t=>t.event.event_id===e)),i=t.slice(s).reverse().map((e=>this.client.decryptEventIfNeeded(e)));await Promise.allSettled(i)}async decryptAllEvents(){if(!this.client.isCryptoEnabled())return;const e=this.getUnfilteredTimelineSet().getLiveTimeline().getEvents().slice(0).reverse().map((e=>this.client.decryptEventIfNeeded(e)));await Promise.allSettled(e)}getCreator(){var e;const t=this.currentState.getStateEvents(g.Bx.RoomCreate,"");return null!==(e=null==t?void 0:t.getSender())&&void 0!==e?e:null}getVersion(){var e;const t=this.currentState.getStateEvents(g.Bx.RoomCreate,"");return t?null!==(e=t.getContent().room_version)&&void 0!==e?e:"1":(this.getVersionWarning||(m.v.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1")}async getRecommendedVersion(){let e={};try{e=await this.client.getCapabilities()}catch(e){}let t=e["m.room_versions"];if(!t){t={default:"10",available:{}};for(const e of B)t.available[e]=L.L.Stable}let s=this.checkVersionAgainstCapability(t);if(s.urgent&&s.needsUpgrade){m.v.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about.");try{e=await this.client.fetchCapabilities()}catch(e){m.v.warn("Failed to refresh room version capabilities",e)}if(t=e["m.room_versions"],!t)return m.v.warn("No room version capability - assuming upgrade required."),s;s=this.checkVersionAgainstCapability(t)}return s}checkVersionAgainstCapability(e){const t=this.getVersion();m.v.log(`[${this.roomId}] Current version: ${t}`),m.v.log(`[${this.roomId}] Version capability: `,e);const s={version:t,needsUpgrade:!1,urgent:!1};if(t===e.default)return s;return Object.keys(e.available).filter((t=>"stable"===e.available[t])).includes(t)||(s.version=e.default,s.needsUpgrade=!0,s.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),s.urgent?m.v.warn(`URGENT upgrade required on ${this.roomId}`):m.v.warn(`Non-urgent upgrade required on ${this.roomId}`)),s}userMayUpgradeRoom(e){return this.currentState.maySendStateEvent(g.Bx.RoomTombstone,e)}getPendingEvents(){if(!this.pendingEventList)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList}removePendingEvent(e){if(!this.pendingEventList)throw new Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);const t=(0,d.Nz)(this.pendingEventList,(function(t){return t.getId()==e}),!1);return this.savePendingEvents(),t}hasPendingEvent(e){var t,s;return null!==(t=null===(s=this.pendingEventList)||void 0===s?void 0:s.some((t=>t.getId()===e)))&&void 0!==t&&t}getPendingEvent(e){var t,s;return null!==(t=null===(s=this.pendingEventList)||void 0===s?void 0:s.find((t=>t.getId()===e)))&&void 0!==t?t:null}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}get timeline(){return this.getLiveTimeline().getEvents()}getLastActiveTimestamp(){const e=this.getLiveTimeline().getEvents();if(e.length){return e[e.length-1].getTs()}return Number.MIN_SAFE_INTEGER}getLastLiveEvent(){var e,t;const s=this.getLiveTimeline().getEvents(),i=s[s.length-1],n=this.getLastThread();if(!n)return i;const r=n.events[n.events.length-1];return(null!==(e=null==i?void 0:i.getTs())&&void 0!==e?e:0)>(null!==(t=null==r?void 0:r.getTs())&&void 0!==t?t:0)?i:r}getLastThread(){return this.getThreads().reduce(((e,t)=>{var s,i;if(!e)return t;const n=t.events[t.events.length-1],r=e.events[e.events.length-1];return(null!==(s=null==n?void 0:n.getTs())&&void 0!==s?s:0)>=(null!==(i=null==r?void 0:r.getTs())&&void 0!==i?i:0)?t:e}),void 0)}getMyMembership(){var e;return null!==(e=this.selfMembership)&&void 0!==e?e:j.O.Leave}getDMInviter(){const e=this.getMember(this.myUserId);if(e)return e.getDMInviter();if(this.selfMembership===j.O.Invite){var t;if(2===this.getInvitedAndJoinedMemberCount())return null===(t=this.summaryHeroes)||void 0===t?void 0:t[0]}}guessDMUserId(){const e=this.getMember(this.myUserId);if(e){const t=e.getDMInviter();if(t)return t}if(Array.isArray(this.summaryHeroes)&&this.summaryHeroes.length)return this.summaryHeroes[0];const t=this.currentState.getMembers().find((e=>e.userId!==this.myUserId));return t?t.userId:this.myUserId}getFunctionalMembers(){const e=this.currentState.getStateEvents(g.Ng.name,"");return Array.isArray(null==e?void 0:e.getContent().service_members)?e.getContent().service_members:[]}getAvatarFallbackMember(){var e;const t=this.getFunctionalMembers();let s=0;if(this.getMembers().forEach((e=>{"join"!==e.membership&&"invite"!==e.membership||t.includes(e.userId)||s++})),s>2)return;const i=null===(e=this.summaryHeroes)||void 0===e?void 0:e.filter((e=>!t.includes(e))),n=Array.isArray(i)&&i.length;if(n){const e=i.map((e=>this.getMember(e))).find((e=>!!e));if(e)return e}const r=this.getMembers(),o=null==r?void 0:r.filter((e=>!t.includes(e.userId)));if(o.length<=2){const e=o.find((e=>e.userId!==this.myUserId));if(e)return e}if(n){const e=i.map((e=>this.client.getUser(e))).find((e=>!!e));if(e){const t=new u.Y(this.roomId,e.userId);return t.user=e,t}}}updateMyMembership(e){const t=this.selfMembership;this.selfMembership=e,t!==e&&(e===j.O.Leave&&this.cleanupAfterLeaving(),this.emit($.MyMembership,this,e,t))}async loadMembersFromServer(){const e=this.client.store.getSyncToken();return(await this.client.members(this.roomId,void 0,j.O.Leave,null!=e?e:void 0)).chunk}async loadMembers(){let e=!1,t=await this.client.store.getOutOfBandMembers(this.roomId);(null===t||this.hasEncryptionStateEvent())&&(e=!0,t=await this.loadMembersFromServer(),m.v.log(`LL: got ${t.length} members from server for room ${this.roomId}`));return{memberEvents:t.filter(d.O5).map(this.client.getEventMapper()),fromServer:e}}membersLoaded(){return!this.opts.lazyLoadMembers||this.currentState.outOfBandMembersReady()}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();const e=this.loadMembers().then((e=>(this.currentState.setOutOfBandMembers(e.memberEvents),e.fromServer))).catch((e=>{throw this.membersPromise=void 0,this.currentState.markOutOfBandMembersFailed(),e}));return e.then((e=>{if(e){const e=this.currentState.getMembers().filter((e=>e.isOutOfBand())).map((e=>{var t;return null===(t=e.events.member)||void 0===t?void 0:t.event}));m.v.log(`LL: telling store to write ${e.length} members for room ${this.roomId}`);return this.client.store.setOutOfBandMembers(this.roomId,e).catch((e=>{m.v.log("LL: storing OOB room members failed, oh well",e)}))}})).catch((e=>{m.v.error(e)})),this.membersPromise=e,this.membersPromise}async clearLoadedMembersIfNeeded(){this.opts.lazyLoadMembers&&this.membersPromise&&(await this.loadMembersIfNeeded(),await this.client.store.clearOutOfBandMembers(this.roomId),this.currentState.clearOutOfBandMembers(),this.membersPromise=void 0)}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch((e=>{m.v.error(`error after clearing loaded members from room ${this.roomId} after leaving`),m.v.log(e)}))}async refreshLiveTimeline(){const e=this.getLiveTimeline(),t=e.getPaginationToken(o.q.FORWARDS),s=e.getPaginationToken(o.q.BACKWARDS),i=e.getEvents(),n=i[i.length-1];m.v.log(`[refreshLiveTimeline for ${this.roomId}] at mostRecentEventInTimeline=${n&&n.getId()} liveTimelineBefore=${e.toString()} forwardPaginationToken=${t} backwardPaginationToken=${s}`);const r=this.getUnfilteredTimelineSet();let a;n?(this.resetLiveTimeline(null,null),this.emit($.TimelineRefresh,this,r),a=await this.client.getEventTimeline(r,n.getId())):a=await this.client.getLatestTimeline(r);const d=r.getLiveTimeline();!d||null===d.getPaginationToken(o.O.Forward)&&null===d.getPaginationToken(o.O.Backward)&&0===d.getEvents().length?(m.v.log(`[refreshLiveTimeline for ${this.roomId}] using our new live timeline`),a.setPaginationToken(t,o.q.FORWARDS),r.setLiveTimeline(a),this.fixUpLegacyTimelineFields()):m.v.log(`[refreshLiveTimeline for ${this.roomId}] \`/sync\` or some other request beat us to creating a new live timeline after we reset it. We'll use that instead since any events in the scrollback from this timeline will include the history.`),this.setTimelineNeedsRefresh(!1),this.emit($.TimelineRefresh,this,r)}resetLiveTimeline(e,t){for(const s of this.timelineSets)s.resetLiveTimeline(null!=e?e:void 0,null!=t?t:void 0);for(const s of this.threads.values())s.resetLiveTimeline(e,t);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){const e=this.oldState,t=this.currentState;this.oldState=this.getLiveTimeline().getState(o.q.BACKWARDS),this.currentState=this.getLiveTimeline().getState(o.q.FORWARDS),e!==this.oldState&&this.emit($.OldStateUpdated,this,e,this.oldState),t!==this.currentState&&(this.emit($.CurrentStateUpdated,this,t,this.currentState),this.reEmitter.stopReEmitting(t,[y.f.Events,y.f.Members,y.f.NewMember,y.f.Update,y.f.Marker,S.JH.New,S.JH.Update,S.JH.Destroy,S.JH.LivenessChange]),this.reEmitter.reEmit(this.currentState,[y.f.Events,y.f.Members,y.f.NewMember,y.f.Update,y.f.Marker,S.JH.New,S.JH.Update,S.JH.Destroy,S.JH.LivenessChange]))}onReceipt(e){this.hasEncryptionStateEvent()&&this.clearNotificationsOnReceipt(e)}clearNotificationsOnReceipt(e){let t=[],s=!1;const i=e.getContent();for(const e of Object.values(i))for(const[i,n]of Object.entries(e))if(d.ll(i)&&n)for(const[e,i]of Object.entries(n)){if(!i||"object"!=typeof i)continue;const n=i;e===this.client.getUserId()&&(void 0===n.thread_id?s=!0:"string"==typeof n.thread_id&&t.push(n.thread_id))}s&&(t=this.getThreads().filter((e=>this.getThreadUnreadNotificationCount(e.id,F.Total)>0||this.getThreadUnreadNotificationCount(e.id,F.Highlight)>0)).map((e=>e.id)),t.push("main"));for(const e of t){var n;const t=20,s="main"===e?this.getLiveTimeline():null===(n=this.getThread(e))||void 0===n?void 0:n.liveTimeline;if(!s){m.v.warn(`Couldn't find timeline for thread ID ${e} in room ${this.roomId}`);continue}const i=s.getEvents();let o=0;for(let e=i.length-1;e>=0;e--){var r;if(e===i.length-t)return;const s=i[e];if(this.hasUserReadEvent(this.client.getUserId(),s.getId()))break;const n=this.client.getPushActionsForEvent(s);o+=null!=n&&null!==(r=n.tweaks)&&void 0!==r&&r.highlight?1:0}"main"===e?this.setUnreadNotificationCount(F.Highlight,o):this.setThreadUnreadNotificationCount(e,F.Highlight,o)}}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(e){const t=this.findEventById(e),s=this.findThreadForEvent(t);return s?s.timelineSet.getTimelineForEvent(e):this.getUnfilteredTimelineSet().getTimelineForEvent(e)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}setTimelineNeedsRefresh(e){this.timelineNeedsRefresh=e}getTimelineNeedsRefresh(){return this.timelineNeedsRefresh}findEventById(e){let t=this.getUnfilteredTimelineSet().findEventById(e);if(!t){const s=this.getThreads();for(let i=0;i<s.length;i++){if(t=s[i].findEventById(e),t)return t}}return t}getUnreadNotificationCount(e=F.Total){let t=this.getRoomUnreadNotificationCount(e);for(const i of this.threadNotifications.values()){var s;t+=null!==(s=i[e])&&void 0!==s?s:0}return t}getUnreadCountForEventContext(e=F.Total,t){var s;return null!==(s=!!t.threadRootId&&!t.isThreadRoot?this.getThreadUnreadNotificationCount(t.threadRootId,e):this.getRoomUnreadNotificationCount(e))&&void 0!==s?s:0}getRoomUnreadNotificationCount(e=F.Total){var t;return null!==(t=this.notificationCounts[e])&&void 0!==t?t:0}getThreadUnreadNotificationCount(e,t=F.Total){var s,i;return null!==(s=null===(i=this.threadNotifications.get(e))||void 0===i?void 0:i[t])&&void 0!==s?s:0}hasThreadUnreadNotification(){for(const s of this.threadNotifications.values()){var e,t;if((null!==(e=s.highlight)&&void 0!==e?e:0)>0||(null!==(t=s.total)&&void 0!==t?t:0)>0)return!0}return!1}setThreadUnreadNotificationCount(e,t,s){var i,n;const r=K({highlight:null===(i=this.threadNotifications.get(e))||void 0===i?void 0:i.highlight,total:null===(n=this.threadNotifications.get(e))||void 0===n?void 0:n.total},{[t]:s});this.threadNotifications.set(e,r),this.emit($.UnreadNotifications,r,e)}get threadsAggregateNotificationType(){let e=null;for(const i of this.threadNotifications.values()){var t,s;if((null!==(t=i.highlight)&&void 0!==t?t:0)>0)return F.Highlight;(null!==(s=i.total)&&void 0!==s?s:0)>0&&!e&&(e=F.Total)}return e}resetThreadUnreadNotificationCountFromSync(e=[]){const t=this.hasEncryptionStateEvent();for(const[s,i]of this.threadNotifications)e.includes(s)||(i.total=0,t||(i.highlight=0));this.emit($.UnreadNotifications)}setUnreadNotificationCount(e,t){this.notificationCounts[e]=t,this.emit($.UnreadNotifications,this.notificationCounts)}setUnread(e,t){return this.setUnreadNotificationCount(e,t)}setSummary(e){const t=e["m.heroes"],s=e["m.joined_member_count"],i=e["m.invited_member_count"];Number.isInteger(s)&&this.currentState.setJoinedMemberCount(s),Number.isInteger(i)&&this.currentState.setInvitedMemberCount(i),Array.isArray(t)&&(this.summaryHeroes=t.filter((e=>e!==this.myUserId))),this.emit($.Summary,e)}setBlacklistUnverifiedDevices(e){this.blacklistUnverifiedDevices=e}getBlacklistUnverifiedDevices(){return void 0===this.blacklistUnverifiedDevices?null:this.blacklistUnverifiedDevices}getAvatarUrl(e,t,s,i,n=!0){const r=this.currentState.getStateEvents(g.Bx.RoomAvatar,"");if(!r&&!n)return null;const o=r?r.getContent().url:null;return o?(0,a.y)(e,o,t,s,i):null}getMxcAvatarUrl(){var e;return(null===(e=this.currentState.getStateEvents(g.Bx.RoomAvatar,""))||void 0===e||null===(e=e.getContent())||void 0===e?void 0:e.url)||null}getCanonicalAlias(){const e=this.currentState.getStateEvents(g.Bx.RoomCanonicalAlias,"");return e&&e.getContent().alias||null}getAltAliases(){const e=this.currentState.getStateEvents(g.Bx.RoomCanonicalAlias,"");return e&&e.getContent().alt_aliases||[]}addEventsToTimeline(e,t,s,i){s.getTimelineSet().addEventsToTimeline(e,t,s,i)}getThread(e){var t;return null!==(t=this.threads.get(e))&&void 0!==t?t:null}getThreads(){return Array.from(this.threads.values())}getMember(e){return this.currentState.getMember(e)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership(j.O.Join)}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(e){return this.currentState.getMembers().filter((function(t){return t.membership===e}))}async getEncryptionTargetMembers(){await this.loadMembersIfNeeded();let e=this.getMembersWithMembership(j.O.Join);return this.shouldEncryptForInvitedMembers()&&(e=e.concat(this.getMembersWithMembership(j.O.Invite))),e}shouldEncryptForInvitedMembers(){var e;const t=this.currentState.getStateEvents(g.Bx.RoomHistoryVisibility,"");return"joined"!==(null==t||null===(e=t.getContent())||void 0===e?void 0:e.history_visibility)}getDefaultRoomName(e){return this.calculateRoomName(e,!0)}hasMembershipState(e,t){const s=this.getMember(e);return!!s&&s.membership===t}getOrCreateFilteredTimelineSet(e,{prepopulateTimeline:t=!0,useSyncEvents:s=!0,pendingEvents:i=!0}={}){if(this.filteredTimelineSets[e.filterId])return this.filteredTimelineSets[e.filterId];const n=Object.assign({filter:e,pendingEvents:i},this.opts),a=new r.m(this,n);this.reEmitter.reEmit(a,[$.Timeline,$.TimelineReset]),s&&(this.filteredTimelineSets[e.filterId]=a,this.timelineSets.push(a));const d=this.getLiveTimeline();if(t){d.getEvents().forEach((function(e){a.addLiveEvent(e)}));let e=d;for(;e.getNeighbouringTimeline(o.q.BACKWARDS);)e=e.getNeighbouringTimeline(o.q.BACKWARDS);a.getLiveTimeline().setPaginationToken(e.getPaginationToken(o.q.BACKWARDS),o.q.BACKWARDS)}else if(s){const e=d.getPaginationToken(o.O.Forward);a.getLiveTimeline().setPaginationToken(e,o.O.Backward)}return a}async getThreadListFilter(e=b.x3.All){const t=this.client.getUserId(),s=new f.d(t),i={room:{timeline:{[b.H.name]:[b.RN.name]}}};e===b.x3.My&&(i.room.timeline[b.o1.name]=[t]),s.setDefinition(i);const n=await this.client.getOrCreateFilter(`THREAD_PANEL_${this.roomId}_${e}`,s);return s.filterId=n,s}async createThreadTimelineSet(e){let t;if(b.jV.hasServerSideListSupport)t=new r.m(this,K(K({},this.opts),{},{pendingEvents:!1}),void 0,void 0,null!=e?e:b.x3.All),this.reEmitter.reEmit(t,[$.Timeline,$.TimelineReset]);else if(b.jV.hasServerSideSupport){const s=await this.getThreadListFilter(e);t=this.getOrCreateFilteredTimelineSet(s,{prepopulateTimeline:!1,useSyncEvents:!1,pendingEvents:!1})}else t=new r.m(this,{pendingEvents:!1}),Array.from(this.threads).forEach((([,s])=>{if(0===s.length)return;const i=s.timeline.some((e=>e.getSender()===this.client.getUserId()));(e!==b.x3.My||i)&&t.getLiveTimeline().addEvent(s.rootEvent,{toStartOfTimeline:!1})}));return t}processThreadRoots(e,t){if(this.client.supportsThreads())for(const s of e)o.q.setEventMetadata(s,this.currentState,t),this.getThread(s.getId())||this.createThread(s.getId(),s,[],t)}async fetchRoomThreads(){if(!this.threadsReady&&this.client.supportsThreads()){if(b.jV.hasServerSideListSupport)await Promise.all([this.fetchRoomThreadList(b.x3.All),this.fetchRoomThreadList(b.x3.My)]);else{const s=await this.getThreadListFilter(),{chunk:i}=await this.client.createMessagesRequest(this.roomId,"",Number.MAX_SAFE_INTEGER,o.O.Backward,s);if(!i.length)return;const n=i.map(this.client.getEventMapper()).sort(((e,t)=>{const s=e.getServerAggregatedRelation(b.RN.name),i=t.getServerAggregatedRelation(b.RN.name);return s.latest_event.origin_server_ts-i.latest_event.origin_server_ts}));let a;const d=this.getLiveTimeline().getState(o.q.FORWARDS);for(const s of n){var e;const i={duplicateStrategy:r.x.Ignore,fromCache:!1,roomState:d};null===(e=this.threadsTimelineSets[0])||void 0===e||e.addLiveEvent(s,i);const n=s.getServerAggregatedRelation(b.RN.name);var t;if(null!=n&&n.current_user_participated)null===(t=this.threadsTimelineSets[1])||void 0===t||t.addLiveEvent(s,i),a=s}this.processThreadRoots(n,!0),this.client.decryptEventIfNeeded(n[n.length-1]),a&&this.client.decryptEventIfNeeded(a)}this.on(b.ju.NewReply,this.onThreadReply),this.on(b.ju.Update,this.onThreadUpdate),this.on(b.ju.Delete,this.onThreadDelete),this.threadsReady=!0}}async processPollEvents(e){for(const t of e)try{if(!t.isEncrypted()&&!(0,_.Wi)(t))continue;await this.client.decryptEventIfNeeded(t),this.processPollEvent(t)}catch(e){m.v.warn("Error processing poll event",t.getId(),e)}}async processPollEvent(e){if(e.isDecryptionFailure())return void e.once(c.OQ.Decrypted,(e=>{this.processPollEvent(e)}));if(n.M_POLL_START.matches(e.getType())){try{const t=new _.sP(e,this.client,this);this.polls.set(e.getId(),t),this.emit(_.sn.New,t),e.once(c.OQ.BeforeRedaction,(e=>{this.polls.delete(e.getId())}))}catch{}return}const t=e.relationEventId;if(t&&this.polls.has(t)){const s=this.polls.get(t);null==s||s.onNewRelation(e)}}async fetchRoomThreadList(e){if(!this.client.supportsThreads())return;if(0===this.threadsTimelineSets.length)return;const t=e===b.x3.My?this.threadsTimelineSets[1]:this.threadsTimelineSets[0],{chunk:s,end:i}=await this.client.createThreadListMessagesRequest(this.roomId,null,void 0,o.O.Backward,t.threadListType,t.getFilter());if(t.getLiveTimeline().setPaginationToken(null!=i?i:null,o.O.Backward),!s.length)return;const n=s.map(this.client.getEventMapper());this.processThreadRoots(n,!0);const a=this.getLiveTimeline().getState(o.q.FORWARDS);for(const e of n)t.addLiveEvent(e,{duplicateStrategy:r.x.Replace,fromCache:!1,roomState:a})}onThreadUpdate(e){this.updateThreadRootEvents(e,!1,!1)}onThreadReply(e){this.updateThreadRootEvents(e,!1,!0)}onThreadDelete(e){var t;this.threads.delete(e.id);const s=this.getTimelineForEvent(e.id),i=null==s||null===(t=s.getEvents())||void 0===t?void 0:t.find((t=>t.getId()===e.id));i?e.clearEventMetadata(i):m.v.debug("onThreadDelete: Could not find root event in room timeline");for(const t of this.threadsTimelineSets)t.removeEvent(e.id)}removeFilteredTimelineSet(e){const t=this.filteredTimelineSets[e.filterId];delete this.filteredTimelineSets[e.filterId];const s=this.timelineSets.indexOf(t);s>-1&&this.timelineSets.splice(s,1)}eventShouldLiveIn(e,t,s){var i;if(null===(i=this.client)||void 0===i||!i.supportsThreads())return{shouldLiveInRoom:!0,shouldLiveInThread:!1};if(e.isThreadRoot||null!=s&&s.has(e.getId()))return{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.getId()};const n=e.isRelation(b.RN.name),r=e.getAssociatedId(),o=e.threadRootId;if(r&&!n&&(o===r||null!=s&&s.has(r)))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};let a;var d;r&&(a=null!==(d=this.findEventById(r))&&void 0!==d?d:null==t?void 0:t.find((e=>e.getId()===r)));return a&&!n?this.eventShouldLiveIn(a,t,s):null!=o?{shouldLiveInRoom:!1,shouldLiveInThread:!0,threadId:o}:!r||e.replyEventId?{shouldLiveInRoom:!0,shouldLiveInThread:!1}:{shouldLiveInRoom:!1,shouldLiveInThread:!1}}findThreadForEvent(e){if(!e)return null;const{threadId:t}=this.eventShouldLiveIn(e);return t?this.getThread(t):null}addThreadedEvents(e,t,s=!1){const i=this.getThread(e);if(i)i.addEvents(t,s);else{var n;const i=null!==(n=this.findEventById(e))&&void 0!==n?n:t.find((t=>t.getId()===e));this.createThread(e,i,t,s)}}processThreadedEvents(e,t){e.forEach(this.applyRedaction);const s={};for(const t of e){var i;const{threadId:e,shouldLiveInThread:n}=this.eventShouldLiveIn(t);n&&!s[e]&&(s[e]=[]),null===(i=s[e])||void 0===i||i.push(t)}Object.entries(s).map((([e,s])=>this.addThreadedEvents(e,s,t)))}createThread(e,t,s=[],i){var n;if(this.threads.has(e))return this.threads.get(e);if(t){const e=this.relations.getAllChildEventsForEvent(t.getId());null!=e&&e.length&&(s=s.concat(e.filter((e=>!e.isRelation(g.zZ.Replace)))))}const r=new b.jV(e,t,{room:this,client:this.client,pendingEventOrdering:this.opts.pendingEventOrdering,receipts:null!==(n=this.cachedThreadReadReceipts.get(e))&&void 0!==n?n:[]});return this.reEmitter.reEmit(r,[b.ju.Delete,b.ju.Update,b.ju.NewReply,$.Timeline,$.TimelineReset]),this.cachedThreadReadReceipts.delete(e),this.threads.set(r.id,r),r.addEvents(s,!1),this.threadsReady&&r.initialEventsFetched&&this.updateThreadRootEvents(r,i,!1),this.emit(b.ju.New,r,i),r}processLiveEvent(e){this.applyRedaction(e),e.isVisibilityEvent()&&this.applyNewVisibilityEvent(e),this.applyPendingVisibilityEvents(e);if(!e.getUnsigned().transaction_id&&e.getSender()===this.myUserId)for(const[t,s]of this.txnToEvent)if(s.getId()===e.getId()){m.v.debug("processLiveEvent: found sent event without txn ID: ",t,e.getId());const s=e.getUnsigned();s.transaction_id=t,e.setUnsigned(s);break}}addLiveEvent(e,t){const{duplicateStrategy:s,timelineWasEmpty:i,fromCache:n}=t;for(const t of this.timelineSets)t.addLiveEvent(e,{duplicateStrategy:s,fromCache:n,timelineWasEmpty:i});e.sender&&e.getType()!==g.Bx.RoomRedaction&&this.addReceipt((0,I.D)(e.sender.userId,e,E.L.Read),!0)}addPendingEvent(e,t){if(e.status!==l.f.SENDING&&e.status!==l.f.NOT_SENT)throw new Error("addPendingEvent called on an event with status "+e.status);if(this.txnToEvent.get(t))throw new Error("addPendingEvent called on an event with known txnId "+t);if(o.q.setEventMetadata(e,this.getLiveTimeline().getState(o.q.FORWARDS),!1),this.txnToEvent.set(t,e),this.pendingEventList){if(this.pendingEventList.some((e=>e.status===l.f.NOT_SENT))&&(m.v.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(l.f.NOT_SENT)),this.pendingEventList.push(e),this.savePendingEvents(),e.isRelation()&&this.aggregateNonLiveRelation(e),e.isRedaction()){const t=e.event.redacts;let s=this.pendingEventList.find((e=>e.getId()===t));!s&&t&&(s=this.findEventById(t)),s&&(s.markLocallyRedacted(e),this.emit($.Redaction,e,this,s.threadRootId))}}else for(const t of this.timelineSets)t.getFilter()?t.getFilter().filterRoomTimeline([e]).length&&t.addEventToTimeline(e,t.getLiveTimeline(),{toStartOfTimeline:!1}):t.addEventToTimeline(e,t.getLiveTimeline(),{toStartOfTimeline:!1});this.emit($.LocalEchoUpdated,e,this)}savePendingEvents(){if(this.pendingEventList){const e=this.pendingEventList.map((e=>K(K({},e.event),{},{txn_id:e.getTxnId()}))).filter((e=>{const t=e.type===g.Bx.RoomMessageEncrypted,s=this.hasEncryptionStateEvent();return t||!s}));this.client.store.setPendingEvents(this.roomId,e)}}aggregateNonLiveRelation(e){this.relations.aggregateChildEvent(e)}getEventForTxnId(e){return this.txnToEvent.get(e)}handleRemoteEcho(e,t){const s=t.getId(),i=e.getId(),n=t.status;m.v.debug(`Got remote echo for event ${s} -> ${i} old status ${n}`),this.txnToEvent.delete(e.getUnsigned().transaction_id),this.pendingEventList&&this.removePendingEvent(s),t.handleRemoteEcho(e.event);const{shouldLiveInRoom:r,threadId:o}=this.eventShouldLiveIn(e),a=o?this.getThread(o):null;if(null==a||a.setEventMetadata(t),null==a||a.timelineSet.handleRemoteEcho(t,s,i),r)for(const e of this.timelineSets)e.handleRemoteEcho(t,s,i);this.emit($.LocalEchoUpdated,t,this,s,n)}updatePendingEvent(e,t,s){if(m.v.log(`setting pendingEvent status to ${t} in ${e.getRoomId()} event ID ${e.getId()} -> ${s}`),t==l.f.SENT&&!s)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==l.f.SENT){if(this.getTimelineForEvent(s)){const t=this.findEventById(s);if(!(null==t?void 0:t.getUnsigned().transaction_id)&&t){const s=t.getUnsigned();s.transaction_id=e.getTxnId(),t.setUnsigned(s),this.removeEvent(t.getId()),this.handleRemoteEcho(t,e)}return}}const i=e.status,n=e.getId();if(!i)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");const r=V[i];if(null==r||!r.includes(t))throw new Error(`Invalid EventStatus transition ${i}->${t}`);if(e.setStatus(t),t==l.f.SENT){e.replaceLocalEventId(s);const{shouldLiveInRoom:t,threadId:i}=this.eventShouldLiveIn(e),r=i?this.getThread(i):void 0;if(null==r||r.setEventMetadata(e),null==r||r.timelineSet.replaceEventId(n,s),t)for(const e of this.timelineSets)e.replaceEventId(n,s)}else if(t==l.f.CANCELLED){if(this.pendingEventList){const e=this.getPendingEvent(n);this.removePendingEvent(n),null!=e&&e.isRedaction()&&this.revertRedactionLocalEcho(e)}this.removeEvent(n)}this.savePendingEvents(),this.emit($.LocalEchoUpdated,e,this,n,i)}revertRedactionLocalEcho(e){const t=e.event.redacts;if(!t)return;const s=this.getUnfilteredTimelineSet().findEventById(t);s&&(s.unmarkLocallyRedacted(),this.emit($.RedactionCancelled,e,this),s.isRelation()&&this.aggregateNonLiveRelation(s))}async addLiveEvents(e,t){const{duplicateStrategy:s,fromCache:i,timelineWasEmpty:n=!1}=null!=t?t:{};if(s&&-1===["replace","ignore"].indexOf(s))throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");for(let e=0;e<this.timelineSets.length;e++){const t=this.timelineSets[e].getLiveTimeline();if(t.getPaginationToken(o.q.FORWARDS))throw new Error("live timeline "+e+" is no longer live - it has a pagination token ("+t.getPaginationToken(o.q.FORWARDS)+")");if(t.getNeighbouringTimeline(o.q.FORWARDS))throw new Error(`live timeline ${e} is no longer live - it has a neighbouring timeline`)}const r=this.findThreadRoots(e),a={},d={duplicateStrategy:s,fromCache:i,timelineWasEmpty:n},l=[...e];for(const t of e){var u,h,p;if(this.processLiveEvent(t),t.getUnsigned().transaction_id){const e=this.txnToEvent.get(t.getUnsigned().transaction_id);if(e){this.handleRemoteEcho(t,e);continue}}let{shouldLiveInRoom:e,shouldLiveInThread:s,threadId:i}=this.eventShouldLiveIn(t,l,r);if(!s&&!e&&t.isRelation())try{const n=new c.kl(await this.client.fetchRoomEvent(this.roomId,t.relationEventId));if(l.push(n),n.threadRootId){r.add(n.threadRootId);const e=t.getUnsigned();e[g.Sr.name]=n.threadRootId,t.setUnsigned(e)}({shouldLiveInRoom:e,shouldLiveInThread:s,threadId:i}=this.eventShouldLiveIn(t,l,r))}catch(e){m.v.error("Failed to load parent event of unhandled relation",e)}var v;if(s&&!a[null!==(u=i)&&void 0!==u?u:""])a[null!==(v=i)&&void 0!==v?v:""]=[];null===(h=a[null!==(p=i)&&void 0!==p?p:""])||void 0===h||h.push(t),e?this.addLiveEvent(t,d):!s&&t.isRelation()&&this.relations.aggregateChildEvent(t)}Object.entries(a).forEach((([e,t])=>{this.addThreadedEvents(e,t,!1)}))}partitionThreadedEvents(e){if(this.client.supportsThreads()){const t=this.findThreadRoots(e);return e.reduce(((s,i)=>{const{shouldLiveInRoom:n,shouldLiveInThread:r,threadId:o}=this.eventShouldLiveIn(i,e,t);return n&&s[0].push(i),r&&(i.setThreadId(null!=o?o:""),s[1].push(i)),r||n||s[2].push(i),s}),[[],[],[]])}return[e,[],[]]}findThreadRoots(e){const t=new Set;for(const s of e){const e=s.threadRootId;null!=e&&t.add(e)}return t}addReceipt(e,t=!1){const s=e.getContent();this.roomReceipts.add(s,t),Object.keys(s).forEach((e=>{Object.keys(s[e]).forEach((i=>{Object.keys(s[e][i]).forEach((n=>{var r,o,a;const d=s[e][i][n],c=!d.thread_id||d.thread_id===E.S,l=c?this:this.threads.get(null!==(r=d.thread_id)&&void 0!==r?r:"");var u;if(l){if(l.addReceiptToStructure(e,i,n,d,t),!t&&this.client.isInitialSyncComplete()&&n===this.client.getUserId()){const t=l.timeline[l.timeline.length-1];t&&e===t.getId()&&n===t.getSender()&&(l.setUnread(F.Total,0),l.setUnread(F.Highlight,0))}}else this.cachedThreadReadReceipts.set(d.thread_id,[...null!==(u=this.cachedThreadReadReceipts.get(d.thread_id))&&void 0!==u?u:[],{eventId:e,receiptType:i,userId:n,receipt:d,synthetic:t}]);n===this.client.getUserId()&&!c&&d.ts<this.oldestThreadedReceiptTs&&(this.oldestThreadedReceiptTs=d.ts),!d.thread_id&&d.ts>(null!==(o=null===(a=this.unthreadedReceipts.get(n))||void 0===a?void 0:a.ts)&&void 0!==o?o:0)&&this.unthreadedReceipts.set(n,d)}))}))})),this.emit($.Receipt,e,this)}addEphemeralEvents(e){for(const t of e)t.getType()===g.Bx.Typing?this.currentState.setTypingEvent(t):t.getType()===g.Bx.Receipt&&this.addReceipt(t)}removeEvents(e){for(const t of e)this.removeEvent(t)}removeEvent(e){let t=!1;for(const s of this.timelineSets){const i=s.removeEvent(e);i&&(i.isRedaction()&&this.revertRedactionLocalEcho(i),t=!0)}return t}recalculate(){const e=this.currentState.getStateEvents(g.Bx.RoomMember,this.myUserId);if(e){const t=e.getContent().membership;if(this.updateMyMembership(t),t===j.O.Invite){(e.getUnsigned().invite_room_state||[]).forEach((e=>{this.currentState.getStateEvents(e.type,e.state_key)||this.currentState.setStateEvents([new c.kl({type:e.type,state_key:e.state_key,content:e.content,event_id:"$fake"+Date.now(),room_id:this.roomId,sender:this.myUserId})])}))}}const t=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=(0,d.S8)(this.name),this.summary=new h.c(this.roomId,{title:this.name}),t!==this.name&&this.emit($.Name,this)}addTags(e){this.tags=e.getContent().tags||{},this.emit($.Tags,e,this)}addAccountData(e){for(const t of e){"m.tag"===t.getType()&&this.addTags(t);const e=t.getType(),s=this.accountData.get(e);this.accountData.set(e,t),this.emit($.AccountData,t,this,s)}}getAccountData(e){return this.accountData.get(e)}maySendMessage(){return this.getMyMembership()===j.O.Join&&(this.hasEncryptionStateEvent()?this.currentState.maySendEvent(g.Bx.RoomMessageEncrypted,this.myUserId):this.currentState.maySendEvent(g.Bx.RoomMessage,this.myUserId))}canInvite(e){let t=this.getMyMembership()===j.O.Join;const s=this.currentState.getStateEvents(g.Bx.RoomPowerLevels,""),i=s&&s.getContent(),n=this.getMember(e);return i&&n&&i.invite>n.powerLevel&&(t=!1),t}getJoinRule(){return this.currentState.getJoinRule()}getHistoryVisibility(){return this.currentState.getHistoryVisibility()}getGuestAccess(){return this.currentState.getGuestAccess()}getType(){const e=this.currentState.getStateEvents(g.Bx.RoomCreate,"");if(e)return e.getContent()[g.Ct];this.getTypeWarning||(m.v.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0)}isSpaceRoom(){return this.getType()===g.CJ.Space}isCallRoom(){return this.getType()===g.CJ.UnstableCall}isElementVideoRoom(){return this.getType()===g.CJ.ElementVideo}findPredecessor(e=!1){const t=this.getLiveTimeline().getState(o.q.FORWARDS);return t?t.findPredecessor(e):null}roomNameGenerator(e){if(this.client.roomNameGenerator){const t=this.client.roomNameGenerator(this.roomId,e);if(null!==t)return t}switch(e.type){case G.Actual:return e.name;case G.Generated:return"Inviting"===e.subtype?`Inviting ${H(e.names,e.count)}`:H(e.names,e.count);case G.EmptyRoom:return e.oldName?`Empty room (was ${e.oldName})`:"Empty room"}}calculateRoomName(e,t=!1){if(!t){const e=this.currentState.getStateEvents(g.Bx.RoomName,"");if(null!=e&&e.getContent().name)return this.roomNameGenerator({type:G.Actual,name:e.getContent().name})}const s=this.getCanonicalAlias();if(s)return this.roomNameGenerator({type:G.Actual,name:s});let i=this.currentState.getJoinedMemberCount()+this.currentState.getInvitedMemberCount()-1;const n=this.getFunctionalMembers();let r=[];if(this.summaryHeroes)this.summaryHeroes.forEach((e=>{if(n.includes(e))return void i--;const t=this.getMember(e);r.push(t?t.name:e)}));else{let t=this.currentState.getMembers().filter((t=>t.userId!==e&&(t.membership===j.O.Invite||t.membership===j.O.Join)));t=t.filter((({userId:e})=>!n.includes(e)||(i--,!1)));const s=new Intl.Collator;t.sort(((e,t)=>s.compare(e.userId,t.userId))),t=t.slice(0,5),r=t.map((e=>e.name))}if(i)return this.roomNameGenerator({type:G.Generated,names:r,count:i});if(this.getMyMembership()==j.O.Join){const e=this.currentState.getStateEvents(g.Bx.RoomThirdPartyInvite);if(null!=e&&e.length){const t=e.map((e=>e.getContent().display_name));return this.roomNameGenerator({type:G.Generated,subtype:"Inviting",names:t,count:t.length+1})}}let o,a=r;return a.length||(a=this.currentState.getMembers().filter((t=>t.userId!==e&&t.membership!==j.O.Invite&&t.membership!==j.O.Join)).map((e=>e.name))),a.length&&(o=this.roomNameGenerator({type:G.Generated,names:a,count:a.length+1})),this.roomNameGenerator({type:G.EmptyRoom,oldName:o})}applyNewVisibilityEvent(e){const t=e.asVisibilityChange();if(!t)return;const s=e.getSender();if(!s)return;if(!(g.Yg.name&&this.currentState.maySendStateEvent(g.Yg.name,s)||g.Yg.altName&&this.currentState.maySendStateEvent(g.Yg.altName,s)))return;const i=this.visibilityEvents.get(t.eventId);if(i){let t=i.length-1;const s=Math.max(0,i.length-30);for(;t>=s;--t){if(i[t].getTs()<e.getTs())break}-1===t?i.unshift(e):i.splice(t+1,0,e)}else this.visibilityEvents.set(t.eventId,[e]);const n=this.findEventById(t.eventId);n&&n.applyVisibilityEvent(t)}redactVisibilityChangeEvent(e){if(!e.isVisibilityEvent)throw new Error("expected a visibility change event");const t=e.getRelation(),s=null==t?void 0:t.event_id,i=this.visibilityEvents.get(s);if(!i)return;const n=i.findIndex((t=>t.getId()===e.getId()));if(-1!==n&&(i.splice(n,1),n===i.length)){const e=this.findEventById(s);if(!e)return;if(0===n)this.visibilityEvents.delete(s),e.applyVisibilityEvent();else{const t=i[i.length-1].asVisibilityChange();if(!t)throw new Error("at this stage, visibility changes should be well-formed");e.applyVisibilityEvent(t)}}}applyPendingVisibilityEvents(e){const t=this.visibilityEvents.get(e.getId());if(!t||0==t.length)return;const s=t[t.length-1],i=s.asVisibilityChange();i&&(i.visible,s.getTs()<e.getTs()||e.applyVisibilityEvent(i))}getOldestThreadedReceiptTs(){return this.oldestThreadedReceiptTs}hasUserReadEvent(e,t){return this.roomReceipts.hasUserReadEvent(e,t)}getLastUnthreadedReceiptFor(e){return this.unthreadedReceipts.get(e)}fixupNotifications(e){super.fixupNotifications(e);const t=this.getThreads().filter((e=>this.getThreadUnreadNotificationCount(e.id,F.Total)>0));for(const s of t)s.fixupNotifications(e)}compareEventOrdering(e,t){return P(this,e,t)}hasEncryptionStateEvent(){var e;return Boolean(null===(e=this.getLiveTimeline().getState(o.q.FORWARDS))||void 0===e?void 0:e.getStateEvents(g.Bx.RoomEncryption,""))}}const V={[l.f.ENCRYPTING]:[l.f.SENDING,l.f.NOT_SENT,l.f.CANCELLED],[l.f.SENDING]:[l.f.ENCRYPTING,l.f.QUEUED,l.f.NOT_SENT,l.f.SENT],[l.f.QUEUED]:[l.f.SENDING,l.f.NOT_SENT,l.f.CANCELLED],[l.f.SENT]:[],[l.f.NOT_SENT]:[l.f.SENDING,l.f.QUEUED,l.f.CANCELLED],[l.f.CANCELLED]:[]};let G=function(e){return e[e.EmptyRoom=0]="EmptyRoom",e[e.Generated=1]="Generated",e[e.Actual=2]="Actual",e}({});function H(e,t){const s=t-1;if(e.length){if(1===e.length&&s<=1)return e[0];if(2===e.length&&s<=2)return`${e[0]} and ${e[1]}`;return s>1?`${e[0]} and ${s} others`:`${e[0]} and 1 other`}return"Empty room"}},"./node_modules/matrix-js-sdk/src/models/search-result.ts":(e,t,s)=>{"use strict";s.d(t,{q:()=>o});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/models/event-timeline.ts");class r{constructor(e){(0,i.A)(this,"timeline",void 0),(0,i.A)(this,"ourEventIndex",0),(0,i.A)(this,"paginateTokens",{[n.O.Backward]:null,[n.O.Forward]:null}),this.ourEvent=e,this.timeline=[e]}getEvent(){return this.timeline[this.ourEventIndex]}getTimeline(){return this.timeline}getOurEventIndex(){return this.ourEventIndex}getPaginateToken(e=!1){return this.paginateTokens[e?n.O.Backward:n.O.Forward]}setPaginateToken(e,t=!1){this.paginateTokens[t?n.O.Backward:n.O.Forward]=null!=e?e:null}addEvents(e,t=!1){t?(this.timeline=e.concat(this.timeline),this.ourEventIndex+=e.length):this.timeline=this.timeline.concat(e)}}class o{static fromJson(e,t){const s=e.context||{};let i=(s.events_before||[]).map(t),n=(s.events_after||[]).map(t);const a=new r(t(e.result)),d=a.ourEvent.threadRootId;return i=i.filter((e=>e.threadRootId===d)),n=n.filter((e=>e.threadRootId===d)),a.setPaginateToken(s.start,!0),a.addEvents(i,!0),a.addEvents(n,!1),a.setPaginateToken(s.end,!1),new o(e.rank,a)}constructor(e,t){this.rank=e,this.context=t}}},"./node_modules/matrix-js-sdk/src/models/thread.ts":(e,t,s)=>{"use strict";s.d(t,{FD:()=>b,H:()=>_,RN:()=>k,UR:()=>T,c1:()=>S,jV:()=>E,ju:()=>y,o1:()=>I,x3:()=>R});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/client.ts"),r=s("./node_modules/matrix-js-sdk/src/ReEmitter.ts"),o=s("./node_modules/matrix-js-sdk/src/@types/event.ts"),a=s("./node_modules/matrix-js-sdk/src/models/event.ts"),d=s("./node_modules/matrix-js-sdk/src/models/event-timeline.ts"),c=s("./node_modules/matrix-js-sdk/src/models/event-timeline-set.ts"),l=s("./node_modules/matrix-js-sdk/src/models/room.ts"),u=s("./node_modules/matrix-js-sdk/src/NamespacedValue.ts"),h=s("./node_modules/matrix-js-sdk/src/logger.ts"),m=s("./node_modules/matrix-js-sdk/src/models/read-receipt.ts"),p=s("./node_modules/matrix-js-sdk/src/@types/read_receipts.ts"),g=s("./node_modules/matrix-js-sdk/src/feature.ts");function v(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function f(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?v(Object(s),!0).forEach((function(t){(0,i.A)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):v(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let y=function(e){return e.New="Thread.new",e.Update="Thread.update",e.NewReply="Thread.newReply",e.ViewThread="Thread.viewThread",e.Delete="Thread.delete",e}({}),S=function(e){return e[e.None=0]="None",e[e.Experimental=1]="Experimental",e[e.Stable=2]="Stable",e}({});function b(e,t){return e?S.Stable:t?S.Experimental:S.None}class E extends m.h{constructor(e,t,s){var o;if(super(),(0,i.A)(this,"timelineSet",void 0),(0,i.A)(this,"_currentUserParticipated",!1),(0,i.A)(this,"reEmitter",void 0),(0,i.A)(this,"lastEvent",void 0),(0,i.A)(this,"replyCount",0),(0,i.A)(this,"lastPendingEvent",void 0),(0,i.A)(this,"pendingReplyCount",0),(0,i.A)(this,"room",void 0),(0,i.A)(this,"client",void 0),(0,i.A)(this,"pendingEventOrdering",void 0),(0,i.A)(this,"processRootEventPromise",void 0),(0,i.A)(this,"initialEventsFetched",!E.hasServerSideSupport),(0,i.A)(this,"initalEventFetchProm",void 0),(0,i.A)(this,"replayEvents",[]),(0,i.A)(this,"onTimelineReset",(async()=>{await this.processRootEventPromise,this.processRootEventPromise=void 0})),(0,i.A)(this,"onBeforeRedaction",((e,t)=>{null!=e&&e.isRelation(k.name)&&this.room.eventShouldLiveIn(e).threadId===this.id&&e.getId()!==this.id&&!t.status&&(this.replyCount--,this.updatePendingReplyCount(),this.emit(y.Update,this))})),(0,i.A)(this,"onRedaction",(async(e,t,s)=>{if(s===this.id)if(this.replyCount<=0){for(const e of this.timeline)this.clearEventMetadata(e);this.lastEvent=this.rootEvent,this._currentUserParticipated=!1,this.emit(y.Delete,this)}else{var i;(null===(i=this.lastEvent)||void 0===i?void 0:i.getId())===e.getAssociatedId()&&(await this.processRootEventPromise,this.processRootEventPromise=void 0),await this.updateThreadMetadata()}})),(0,i.A)(this,"onTimelineEvent",((e,t,s)=>{if(!s){const s=e.getSender();s&&t&&this.shouldSendLocalEchoReceipt(s,e)&&t.addLocalEchoReceipt(s,e,p.L.Read),e.getId()!==this.id&&e.isRelation(k.name)&&this.replyCount++}this.onEcho(e,null!=s&&s)})),(0,i.A)(this,"onLocalEcho",(e=>{this.onEcho(e,!1)})),(0,i.A)(this,"onEcho",(async(e,t)=>{e.threadRootId===this.id&&this.lastEvent!==e&&(await this.updateThreadMetadata(),e.isRelation(k.name)&&(t||(this.lastEvent=void 0,this.emit(y.NewReply,this,e))))})),this.id=e,this.rootEvent=t,this.setMaxListeners(1e3),null==s||!s.room)throw new Error("element-web#22141: A thread requires a room in order to function");this.room=s.room,this.client=s.client,this.pendingEventOrdering=null!==(o=s.pendingEventOrdering)&&void 0!==o?o:n.eO.Chronological,this.timelineSet=new c.m(this.room,{timelineSupport:!0,pendingEvents:!0},this.client,this),this.reEmitter=new r.Q(this),this.reEmitter.reEmit(this.timelineSet,[l.u9.Timeline,l.u9.TimelineReset]),this.room.on(a.OQ.BeforeRedaction,this.onBeforeRedaction),this.room.on(l.u9.Redaction,this.onRedaction),this.room.on(l.u9.LocalEchoUpdated,this.onLocalEcho),this.room.on(l.u9.TimelineReset,this.onTimelineReset),this.timelineSet.on(l.u9.Timeline,this.onTimelineEvent),this.processReceipts(s.receipts),this.updateThreadMetadata(),this.setEventMetadata(this.rootEvent)}async fetchRootEvent(){try{const e=await this.client.fetchRoomEvent(this.roomId,this.id),t=this.client.getEventMapper();this.rootEvent=t(e)}catch(e){h.v.error("Failed to fetch thread root to construct thread with",e)}await this.processEvent(this.rootEvent)}static setServerSideSupport(e){E.hasServerSideSupport=e,e!==S.Stable&&(I.setPreferUnstable(!0),_.setPreferUnstable(!0),k.setPreferUnstable(!0))}static setServerSideListSupport(e){E.hasServerSideListSupport=e}static setServerSideFwdPaginationSupport(e){E.hasServerSideFwdPaginationSupport=e}shouldSendLocalEchoReceipt(e,t){var s;if((null!==(s=this.client.canSupport.get(g.Xj.RelationsRecursion))&&void 0!==s?s:g.Tj.Unsupported)===g.Tj.Unsupported){var i;const s=null===(i=this.getReadReceiptForUserId(e))||void 0===i?void 0:i.eventId;if(s){const e=this.findEventById(s);if(e&&e.getTs()>t.getTs())return!1}}return!0}get roomState(){return this.room.getLiveTimeline().getState(d.q.FORWARDS)}addEventToTimeline(e,t){this.findEventById(e.getId())||this.timelineSet.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:t,fromCache:!1,roomState:this.roomState})}insertEventIntoTimeline(e){const t=e.getId();t&&(this.findEventById(t)||this.timelineSet.insertEventIntoTimeline(e,this.liveTimeline,this.roomState))}addEvents(e,t){e.forEach((e=>this.addEvent(e,t,!1))),this.updateThreadMetadata()}addEvent(e,t,s=!0){this.setEventMetadata(e);const i=this.lastReply(),n=!i||e.localTimestamp>=i.localTimestamp;if(E.hasServerSideSupport){if(e.isRelation(o.zZ.Annotation)||e.isRelation(o.zZ.Replace))return void this.addRelatedThreadEvent(e,t);!t&&n?(this.addEventToTimeline(e,!1),this.fetchEditsWhereNeeded(e)):t?this.addEventToTimeline(e,t):this.insertEventIntoTimeline(e)}else this.addEventToTimeline(e,t),this.client.decryptEventIfNeeded(e);e.getId()!==this.id&&e.isRelation(k.name)&&!t&&n&&(this.lastEvent=void 0),s&&(this.emit(y.NewReply,this,e),this.updateThreadMetadata())}addRelatedThreadEvent(e,t){var s,i;if(this.initialEventsFetched){var n;(null!==(n=this.client.canSupport.get(g.Xj.RelationsRecursion))&&void 0!==n?n:g.Tj.Unsupported)===g.Tj.Unsupported?this.insertEventIntoTimeline(e):this.addEventToTimeline(e,t)}else{var r;null===(r=this.replayEvents)||void 0===r||r.push(e)}null===(s=this.timelineSet.relations)||void 0===s||s.aggregateParentEvent(e),null===(i=this.timelineSet.relations)||void 0===i||i.aggregateChildEvent(e,this.timelineSet)}async processEvent(e){e&&(this.setEventMetadata(e),await this.fetchEditsWhereNeeded(e))}processReceipts(e=[]){for(const{eventId:t,receiptType:s,userId:i,receipt:n,synthetic:r}of e)this.addReceiptToStructure(t,s,i,n,r)}getRootEventBundledRelationship(e=this.rootEvent){return null==e?void 0:e.getServerAggregatedRelation(k.name)}async processRootEvent(){const e=this.getRootEventBundledRelationship();if(E.hasServerSideSupport&&e){this.replyCount=e.count,this._currentUserParticipated=!!e.current_user_participated;const t=this.client.getEventMapper();this.lastEvent=t(f(f({},e.latest_event),{},{room_id:this.roomId})),this.updatePendingReplyCount(),await this.processEvent(this.lastEvent)}}updatePendingReplyCount(){const e=(this.pendingEventOrdering===n.eO.Detached?this.room.getPendingEvents():this.events).filter((e=>{var t;return e.threadRootId===this.id&&e.isRelation(k.name)&&null!==e.status&&e.getId()!==(null===(t=this.lastEvent)||void 0===t?void 0:t.getId())}));this.lastPendingEvent=e.length?e[e.length-1]:void 0,this.pendingReplyCount=e.length}async resetLiveTimeline(e,t){const s=this.liveTimeline;this.timelineSet.resetLiveTimeline(null!=e?e:void 0,null!=t?t:void 0);const i=this.liveTimeline;let n,r;if(e){n=(await this.client.createMessagesRequest(this.roomId,e,1,d.O.Forward)).end}if(t){r=(await this.client.createMessagesRequest(this.roomId,t,1,d.O.Backward)).start}var o,a;t&&s.getPaginationToken(d.O.Forward)===t&&s.setPaginationToken(null!==(o=r)&&void 0!==o?o:null,d.O.Forward);e&&i.getPaginationToken(d.O.Backward)===e&&i.setPaginationToken(null!==(a=n)&&void 0!==a?a:null,d.O.Backward)}async updateThreadFromRootEvent(){E.hasServerSideSupport&&(this.initialEventsFetched||this.lastEvent||await this.processRootEvent(),await this.fetchRootEvent()),await this.processRootEvent()}async updateThreadMetadata(){if(this.updatePendingReplyCount(),this.processRootEventPromise||(this.processRootEventPromise=this.updateThreadFromRootEvent()),await this.processRootEventPromise,!this.initialEventsFetched)if(this.initalEventFetchProm)await this.initalEventFetchProm;else try{this.timelineSet.resetLiveTimeline(),0===this.replyCount&&this.rootEvent?(this.timelineSet.addEventsToTimeline([this.rootEvent],!0,this.liveTimeline,null),this.liveTimeline.setPaginationToken(null,d.O.Backward)):(this.initalEventFetchProm=this.client.paginateEventTimeline(this.liveTimeline,{backwards:!0}),await this.initalEventFetchProm),this.initialEventsFetched=!0;for(const e of this.replayEvents)this.addEvent(e,!1);this.replayEvents=null,this.emit(l.u9.TimelineReset,this.room,this.timelineSet,!0)}catch(e){h.v.error("Failed to load start of newly created thread: ",e),this.initialEventsFetched=!1}this.emit(y.Update,this)}async fetchEditsWhereNeeded(...e){var t;if((null!==(t=this.client.canSupport.get(g.Xj.RelationsRecursion))&&void 0!==t?t:g.Tj.Unsupported)===g.Tj.Unsupported)return Promise.all(e.filter(w).map((async e=>{try{const t=await this.client.relations(this.roomId,e.getId(),o.zZ.Replace,e.getType(),{limit:1});if(t.events.length){const s=t.events[0];e.makeReplaced(s),this.insertEventIntoTimeline(s)}}catch(e){h.v.error("Failed to load edits for encrypted thread event",e)}})))}setEventMetadata(e){e&&(d.q.setEventMetadata(e,this.roomState,!1),e.setThread(this))}clearEventMetadata(e){var t;e&&(e.setThread(void 0),null===(t=e.event)||void 0===t||null===(t=t.unsigned)||void 0===t||null===(t=t["m.relations"])||void 0===t||delete t[k.name])}findEventById(e){return this.timelineSet.findEventById(e)}lastReply(e=e=>e.isRelation(k.name)){for(let t=this.timeline.length-1;t>=0;t--){const s=this.timeline[t];if(e(s))return s}return null}get roomId(){return this.room.roomId}get length(){return this.replyCount+this.pendingReplyCount}get replyToEvent(){var e,t;return null!==(e=null!==(t=this.lastPendingEvent)&&void 0!==t?t:this.lastEvent)&&void 0!==e?e:this.lastReply()}get timeline(){return this.events}get events(){return this.liveTimeline.getEvents()}has(e){return this.timelineSet.findEventById(e)instanceof a.kl}get hasCurrentUserParticipated(){return this._currentUserParticipated}get liveTimeline(){return this.timelineSet.getLiveTimeline()}getUnfilteredTimelineSet(){return this.timelineSet}addReceipt(e,t){throw new Error("Unsupported function on the thread model")}getEventReadUpTo(e,t){const s=e===this.client.getUserId(),i=this.timeline[this.timeline.length-1];if(s&&i){const e=i.getTs()<this.room.getOldestThreadedReceiptTs(),t=i.getId();if(e&&t)return t}const n=super.getEventReadUpTo(e,t);if(i){const t=this.room.getLastUnthreadedReceiptFor(e);if(!t)return n;for(let e=(null===(r=this.timeline)||void 0===r?void 0:r.length)-1;e>=0;--e){var r,o;const s=this.timeline[e];if(s.getId()===n)return n;if(s.getTs()<t.ts)return null!==(o=s.getId())&&void 0!==o?o:n}}return n}hasUserReadEvent(e,t){if(e===this.client.getUserId()){var s,i,n,r,o,a;const t=(null!==(s=null===(i=this.lastReply())||void 0===i?void 0:i.getTs())&&void 0!==s?s:0)<this.room.getOldestThreadedReceiptTs(),d=null!==(n=null===(r=this.room.getLastUnthreadedReceiptFor(e))||void 0===r?void 0:r.ts)&&void 0!==n?n:0,c=(null!==(o=null==this||null===(a=this.lastReply())||void 0===a?void 0:a.getTs())&&void 0!==o?o:0)<d;if(t||c)return!0}return this.room.hasUserReadEvent(e,t)}setUnread(e,t){return this.room.setThreadUnreadNotificationCount(this.id,e,t)}getLastUnthreadedReceiptFor(e){return this.room.getLastUnthreadedReceiptFor(e)}}function w(e){return e.isEncrypted()&&(e.isRelation(k.name)||e.isThreadRoot)}(0,i.A)(E,"hasServerSideSupport",S.None),(0,i.A)(E,"hasServerSideListSupport",S.None),(0,i.A)(E,"hasServerSideFwdPaginationSupport",S.None);const I=new u.M6("related_by_senders","io.element.relation_senders"),_=new u.M6("related_by_rel_types","io.element.relation_types"),k=new u.M6("m.thread","io.element.thread");let R=function(e){return e[e.My=0]="My",e[e.All=1]="All",e}({});function T(e){return e===R.My?"participated":"all"}},"./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts":(e,t,s)=>{"use strict";s.d(t,{X:()=>r,u:()=>n});var i=s("./node_modules/events/events.js");let n=function(e){return e.NewListener="newListener",e.RemoveListener="removeListener",e.Error="error",e}({});class r extends i.EventEmitter{addListener(e,t){return super.addListener(e,t)}emit(e,...t){return super.emit(e,...t)}async emitPromised(e,...t){const s=this.listeners(e);return Promise.allSettled(s.map((e=>e(...t)))).then((()=>s.length>0))}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}off(e,t){return super.off(e,t)}on(e,t){return super.on(e,t)}once(e,t){return super.once(e,t)}prependListener(e,t){return super.prependListener(e,t)}prependOnceListener(e,t){return super.prependOnceListener(e,t)}removeAllListeners(e){return void 0===e?super.removeAllListeners():super.removeAllListeners(e)}removeListener(e,t){return super.removeListener(e,t)}rawListeners(e){return super.rawListeners(e)}}},"./node_modules/matrix-js-sdk/src/models/user.ts":(e,t,s)=>{"use strict";s.d(t,{K:()=>o,U:()=>r});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts");let r=function(e){return e.DisplayName="User.displayName",e.AvatarUrl="User.avatarUrl",e.Presence="User.presence",e.CurrentlyActive="User.currentlyActive",e.LastPresenceTs="User.lastPresenceTs",e}({});class o extends n.X{constructor(e){super(),(0,i.A)(this,"modified",-1),(0,i.A)(this,"displayName",void 0),(0,i.A)(this,"rawDisplayName",void 0),(0,i.A)(this,"avatarUrl",void 0),(0,i.A)(this,"presenceStatusMsg",void 0),(0,i.A)(this,"presence","offline"),(0,i.A)(this,"lastActiveAgo",0),(0,i.A)(this,"lastPresenceTs",0),(0,i.A)(this,"currentlyActive",!1),(0,i.A)(this,"events",{}),this.userId=e,this.displayName=e,this.rawDisplayName=e,this.updateModifiedTime()}static createUser(e,t){const s=new o(e);return t.reEmitter.reEmit(s,[r.AvatarUrl,r.DisplayName,r.Presence,r.CurrentlyActive,r.LastPresenceTs]),s}setPresenceEvent(e){if("m.presence"!==e.getType())return;const t=null===this.events.presence;this.events.presence=e;const s=[];(e.getContent().presence!==this.presence||t)&&s.push(r.Presence),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&s.push(r.AvatarUrl),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&s.push(r.DisplayName),void 0!==e.getContent().currently_active&&e.getContent().currently_active!==this.currentlyActive&&s.push(r.CurrentlyActive),this.presence=e.getContent().presence,s.push(r.LastPresenceTs),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this.updateModifiedTime();for(const t of s)this.emit(t,e,this)}setDisplayName(e){const t=this.displayName;this.displayName=e,e!==t&&this.updateModifiedTime()}setRawDisplayName(e){this.rawDisplayName=e}setAvatarUrl(e){const t=this.avatarUrl;this.avatarUrl=e,e!==t&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}}},"./node_modules/matrix-js-sdk/src/pushprocessor.ts":(e,t,s)=>{"use strict";s.d(t,{j:()=>f});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/utils.ts"),r=s("./node_modules/matrix-js-sdk/src/logger.ts"),o=s("./node_modules/matrix-js-sdk/src/@types/PushRules.ts"),a=s("./node_modules/matrix-js-sdk/src/@types/event.ts");function d(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function c(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?d(Object(s),!0).forEach((function(t){(0,i.A)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):d(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const l=[o.Ji.Override,o.Ji.ContentSpecific,o.Ji.RoomSpecific,o.Ji.SenderSpecific,o.Ji.Underride],u={".m.rule.is_room_mention":{rule_id:".m.rule.is_room_mention",default:!0,enabled:!0,conditions:[{kind:o.wp.EventPropertyIs,key:"content.m\\.mentions.room",value:!0},{kind:o.wp.SenderNotificationPermission,key:"room"}],actions:[o.YU.Notify,{set_tweak:o.QN.Highlight}]},".m.rule.reaction":{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:o.wp.EventMatch,key:"type",pattern:"m.reaction"}],actions:[o.YU.DontNotify]},".org.matrix.msc3786.rule.room.server_acl":{rule_id:".org.matrix.msc3786.rule.room.server_acl",default:!0,enabled:!0,conditions:[{kind:o.wp.EventMatch,key:"type",pattern:a.Bx.RoomServerAcl},{kind:o.wp.EventMatch,key:"state_key",pattern:""}],actions:[]}},h=Symbol("UserDefinedRules"),m=[o.kq.Master,h,o.kq.SuppressNotices,o.kq.InviteToSelf,o.kq.MemberEvent,o.kq.IsUserMention,o.kq.ContainsDisplayName,o.kq.IsRoomMention,o.kq.AtRoomNotification,o.kq.Tombstone,".m.rule.reaction",".m.rule.room.server_acl",".org.matrix.msc3786.rule.room.server_acl",".m.rule.suppress_edits"],p={".org.matrix.msc3914.rule.room.call":{rule_id:".org.matrix.msc3914.rule.room.call",default:!0,enabled:!0,conditions:[{kind:o.wp.EventMatch,key:"type",pattern:"org.matrix.msc3401.call"},{kind:o.wp.CallStarted}],actions:[o.YU.Notify,{set_tweak:o.QN.Sound,value:"default"}]}},g=[h,o.kq.IncomingCall,".org.matrix.msc3914.rule.room.call",o.kq.EncryptedDM,o.kq.DM,o.kq.Message,o.kq.EncryptedMessage];function v(e,t,s,i){const n=t.filter((e=>e.default)),o=t.filter((e=>!e.default));function a(t){t===h?c.push(...o):t in s?(r.v.warn(`Adding default global ${e} push rule ${t}`),c.push(s[t])):r.v.warn(`Missing default global ${e} push rule ${t}`)}let d=0;const c=[];for(const e of n){const t=i.indexOf(e.rule_id);if(-1!==t){for(;t>d;){a(i[d]),d+=1}c.push(e),d+=1}else c.push(e)}for(const e of i.slice(d))a(e);return c}class f{constructor(e){(0,i.A)(this,"parsedKeys",new Map),this.client=e}static actionListToActionsObject(e){const t={notify:!1,tweaks:{}};for(const s of e)s===o.YU.Notify?t.notify=!0:"object"==typeof s&&(void 0===s.value&&(s.value=!0),t.tweaks[s.set_tweak]=s.value);return t}static rewriteDefaultRules(e,t=void 0){let s=JSON.parse(JSON.stringify(e));return s||(s={}),s.global||(s.global={}),s.global.override||(s.global.override=[]),s.global.underride||(s.global.underride=[]),s.global.override=v(o.Ji.Override,s.global.override,u,m),s.global.underride=v(o.Ji.Underride,s.global.underride,p,g),s}updateCachedPushRuleKeys(e){e||(e={}),e.global||(e.global={}),e.global.override||(e.global.override=[]),e.global.room||(e.global.room=[]),e.global.sender||(e.global.sender=[]),e.global.underride||(e.global.underride=[]);const t=new Set(this.parsedKeys.keys());for(const s of[e.global.override,e.global.room,e.global.sender,e.global.underride])for(const e of s)if(e.conditions)for(const s of e.conditions)s.kind===o.wp.EventMatch&&(t.delete(s.key),this.parsedKeys.set(s.key,f.partsForDottedKey(s.key)));t.forEach((e=>this.parsedKeys.delete(e)))}matchingRuleFromKindSet(e,t){for(const s of l){const i=t[s];if(i)for(const t of i){if(!t.enabled)continue;const i=this.templateRuleToRaw(s,t);if(i&&this.ruleMatchesEvent(i,e))return c(c({},t),{},{kind:s})}}return null}templateRuleToRaw(e,t){const s={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case o.Ji.Underride:case o.Ji.Override:s.conditions=t.conditions;break;case o.Ji.RoomSpecific:if(!t.rule_id)return null;s.conditions.push({kind:o.wp.EventMatch,key:"room_id",value:t.rule_id});break;case o.Ji.SenderSpecific:if(!t.rule_id)return null;s.conditions.push({kind:o.wp.EventMatch,key:"user_id",value:t.rule_id});break;case o.Ji.ContentSpecific:if(!t.pattern)return null;s.conditions.push({kind:o.wp.EventMatch,key:"content.body",pattern:t.pattern})}return s}eventFulfillsCondition(e,t){switch(e.kind){case o.wp.EventMatch:return this.eventFulfillsEventMatchCondition(e,t);case o.wp.EventPropertyIs:return this.eventFulfillsEventPropertyIsCondition(e,t);case o.wp.EventPropertyContains:return this.eventFulfillsEventPropertyContains(e,t);case o.wp.ContainsDisplayName:return this.eventFulfillsDisplayNameCondition(e,t);case o.wp.RoomMemberCount:return this.eventFulfillsRoomMemberCountCondition(e,t);case o.wp.SenderNotificationPermission:return this.eventFulfillsSenderNotifPermCondition(e,t);case o.wp.CallStarted:case o.wp.CallStartedPrefix:return this.eventFulfillsCallStartedCondition(e,t)}return!1}eventFulfillsSenderNotifPermCondition(e,t){const s=e.key;if(!s)return!1;const i=this.client.getRoom(t.getRoomId());return!(null==i||!i.currentState)&&i.currentState.mayTriggerNotifOfType(s,t.getSender())}eventFulfillsRoomMemberCountCondition(e,t){if(!e.is)return!1;const s=this.client.getRoom(t.getRoomId());if(!s||!s.currentState||!s.currentState.members)return!1;const i=s.currentState.getJoinedMemberCount(),n=e.is.match(/^([=<>]*)(\d*)$/);if(!n)return!1;const r=n[1],o=parseInt(n[2]);if(isNaN(o))return!1;switch(r){case"":case"==":return i==o;case"<":return i<o;case">":return i>o;case"<=":return i<=o;case">=":return i>=o;default:return!1}}eventFulfillsDisplayNameCondition(e,t){var s;let i=t.getContent();if(t.isEncrypted()&&t.getClearContent()&&(i=t.getClearContent()),!i||!i.body||"string"!=typeof i.body)return!1;const r=this.client.getRoom(t.getRoomId()),o=null==r||null===(s=r.currentState)||void 0===s?void 0:s.getMember(this.client.credentials.userId);if(!o)return!1;const a=o.name,d=new RegExp("(^|\\W)"+(0,n.Nt)(a)+"(\\W|$)","i");return i.body.search(d)>-1}eventFulfillsEventMatchCondition(e,t){if(!e.key)return!1;const s=this.valueForDottedKey(e.key,t);if("string"!=typeof s)return!1;if(e.value)return e.value===s;if("string"!=typeof e.pattern)return!1;const i="content.body"===e.key?this.createCachedRegex("(^|\\W)",e.pattern,"(\\W|$)"):this.createCachedRegex("^",e.pattern,"$");return!!s.match(i)}eventFulfillsEventPropertyIsCondition(e,t){return!(!e.key||void 0===e.value)&&e.value===this.valueForDottedKey(e.key,t)}eventFulfillsEventPropertyContains(e,t){if(!e.key||void 0===e.value)return!1;const s=this.valueForDottedKey(e.key,t);return!!Array.isArray(s)&&s.includes(e.value)}eventFulfillsCallStartedCondition(e,t){return["m.ring","m.prompt"].includes(t.getContent()["m.intent"])&&!("m.terminated"in t.getContent())&&(t.getPrevContent()["m.terminated"]!==t.getContent()["m.terminated"]||(0,n.ky)(t.getPrevContent(),{}))}createCachedRegex(e,t,s){return f.cachedGlobToRegex[t]||(f.cachedGlobToRegex[t]=new RegExp(e+(0,n.dn)(t)+s,"i")),f.cachedGlobToRegex[t]}static partsForDottedKey(e){const t=[];let s="",i=!1;for(const n of e)i?(s+="\\"===n||"."===n?n:"\\"+n,i=!1):"."==n?(t.push(s),s=""):"\\"==n?i=!0:s+=n;return i&&(s+="\\"),t.push(s),t}valueForDottedKey(e,t){let s,i=this.parsedKeys.get(e);void 0===i&&(i=f.partsForDottedKey(e),this.parsedKeys.set(e,i));const r=i[0];let o=0;for("content"===r?(s=t.getContent(),++o):"type"===r?(s=t.getType(),++o):s=t.event;o<i.length;++o){if((0,n.hX)(s))return;s=s[i[o]]}return s}matchingRuleForEventWithRulesets(e,t){return t?e.getSender()===this.client.getSafeUserId()?null:this.matchingRuleFromKindSet(e,t.global):null}pushActionsForEventAndRulesets(e,t){const s=this.matchingRuleForEventWithRulesets(e,t);if(!s)return{};const i=f.actionListToActionsObject(s.actions);return void 0===i.tweaks.highlight&&(i.tweaks.highlight=s.kind==o.Ji.ContentSpecific),{actions:i,rule:s}}ruleMatchesEvent(e,t){var s;return(!this.client.supportsIntentionalMentions()||void 0===t.getContent()["m.mentions"]||e.rule_id!==o.kq.ContainsUserName&&e.rule_id!==o.kq.ContainsDisplayName&&e.rule_id!==o.kq.AtRoomNotification)&&!(null!==(s=e.conditions)&&void 0!==s&&s.some((e=>!this.eventFulfillsCondition(e,t))))}actionsForEvent(e){const{actions:t}=this.pushActionsForEventAndRulesets(e,this.client.pushRules);return t||{}}actionsAndRuleForEvent(e){return this.pushActionsForEventAndRulesets(e,this.client.pushRules)}getPushRuleById(e){var t;const s=this.getPushRuleAndKindById(e);return null!==(t=null==s?void 0:s.rule)&&void 0!==t?t:null}getPushRuleAndKindById(e){for(const s of["global"]){var t;if(void 0!==(null===(t=this.client.pushRules)||void 0===t?void 0:t[s]))for(const t of l)if(void 0!==this.client.pushRules[s][t])for(const i of this.client.pushRules[s][t])if(i.rule_id===e)return{rule:i,kind:t}}return null}}(0,i.A)(f,"cachedGlobToRegex",{})},"./node_modules/matrix-js-sdk/src/randomstring.ts":(e,t,s)=>{"use strict";s.d(t,{DU:()=>d,rl:()=>a});var i=s("./node_modules/matrix-js-sdk/src/base64.ts");const n="abcdefghijklmnopqrstuvwxyz",r="ABCDEFGHIJKLMNOPQRSTUVWXYZ",o="0123456789";function a(e){const t=new Uint8Array(e);return globalThis.crypto.getRandomValues(t),(0,i.A4)(t)}function d(e){return c(e,r+n+o)}function c(e,t){let s="";for(let i=0;i<e;++i)s+=t.charAt(Math.floor(Math.random()*t.length));return s}},"./node_modules/matrix-js-sdk/src/scheduler.ts":(e,t,s)=>{"use strict";s.d(t,{b:()=>d});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/logger.ts"),r=s("./node_modules/matrix-js-sdk/src/@types/event.ts"),o=s("./node_modules/matrix-js-sdk/src/utils.ts"),a=s("./node_modules/matrix-js-sdk/src/http-api/index.ts");class d{static RETRY_BACKOFF_RATELIMIT(e,t,s){return(0,a.fZ)(s,t,!1)}static QUEUE_MESSAGES(e){return e.getType()===r.Bx.RoomMessage||e.hasAssociation()?"message":null}constructor(e=d.RETRY_BACKOFF_RATELIMIT,t=d.QUEUE_MESSAGES){(0,i.A)(this,"queues",{}),(0,i.A)(this,"activeQueues",[]),(0,i.A)(this,"procFn",null),(0,i.A)(this,"processQueue",(e=>{const t=this.peekNextEvent(e);t?(c("Queue '%s' has %s pending events",e,this.queues[e].length),Promise.resolve().then((()=>this.procFn(t.event))).then((s=>{this.removeNextEvent(e),c("Queue '%s' sent event %s",e,t.event.getId()),t.defer.resolve(s),this.processQueue(e)}),(s=>{t.attempts+=1;const i=this.retryAlgorithm(t.event,t.attempts,s);c("retry(%s) err=%s event_id=%s waitTime=%s",t.attempts,s,t.event.getId(),i),-1===i?(n.v.info("Queue '%s' giving up on event %s",e,t.event.getId()),this.clearQueue(e,s)):setTimeout(this.processQueue,i,e)}))):this.disableQueue(e)})),this.retryAlgorithm=e,this.queueAlgorithm=t}getQueueForEvent(e){const t=this.queueAlgorithm(e);return t&&this.queues[t]?this.queues[t].map((function(e){return e.event})):null}removeEventFromQueue(e){const t=this.queueAlgorithm(e);if(!t||!this.queues[t])return!1;let s=!1;return(0,o.Nz)(this.queues[t],(t=>t.event.getId()===e.getId()&&(s=!0,!0))),s}setProcessFunction(e){this.procFn=e,this.startProcessingQueues()}queueEvent(e){const t=this.queueAlgorithm(e);if(!t)return null;this.queues[t]||(this.queues[t]=[]);const s=(0,o.v6)();return this.queues[t].push({event:e,defer:s,attempts:0}),c("Queue algorithm dumped event %s into queue '%s'",e.getId(),t),this.startProcessingQueues(),s.promise}startProcessingQueues(){this.procFn&&Object.keys(this.queues).filter((e=>-1===this.activeQueues.indexOf(e)&&this.queues[e].length>0)).forEach((e=>{this.activeQueues.push(e),c("Spinning up queue: '%s'",e),this.processQueue(e)}))}disableQueue(e){const t=this.activeQueues.indexOf(e);t>=0&&this.activeQueues.splice(t,1),n.v.info("Stopping queue '%s' as it is now empty",e)}clearQueue(e,t){let s;for(n.v.info("clearing queue '%s'",e);s=this.removeNextEvent(e);)s.defer.reject(t);this.disableQueue(e)}peekNextEvent(e){const t=this.queues[e];if(Array.isArray(t))return t[0]}removeNextEvent(e){const t=this.queues[e];if(Array.isArray(t))return t.shift()}}function c(...e){false}},"./node_modules/matrix-js-sdk/src/secret-storage.ts":(e,t,s)=>{"use strict";s.d(t,{SECRET_STORAGE_ALGORITHM_V1_AES:()=>d,ServerSideSecretStorageImpl:()=>c,calculateKeyCheck:()=>h});var i=s("./node_modules/matrix-js-sdk/src/client.ts"),n=s("./node_modules/matrix-js-sdk/src/randomstring.ts"),r=s("./node_modules/matrix-js-sdk/src/logger.ts"),o=s("./node_modules/matrix-js-sdk/src/utils/encryptAESSecretStorageItem.ts"),a=s("./node_modules/matrix-js-sdk/src/utils/decryptAESSecretStorageItem.ts");const d="m.secret_storage.v1.aes-hmac-sha2";class c{constructor(e,t){this.accountDataAdapter=e,this.callbacks=t}async getDefaultKeyId(){const e=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.default_key");return e?e.key:null}setDefaultKeyId(e){return new Promise(((t,s)=>{const n=s=>{"m.secret_storage.default_key"===s.getType()&&s.getContent().key===e&&(this.accountDataAdapter.removeListener(i.AU.AccountData,n),t())};this.accountDataAdapter.on(i.AU.AccountData,n),this.accountDataAdapter.setAccountData("m.secret_storage.default_key",{key:e}).catch((e=>{this.accountDataAdapter.removeListener(i.AU.AccountData,n),s(e)}))}))}async addKey(e,t,s){if(e!==d)throw new Error(`Unknown key algorithm ${e}`);const i={algorithm:e};t.name&&(i.name=t.name),t.passphrase&&(i.passphrase=t.passphrase);const{iv:r,mac:o}=await h(t.key);if(i.iv=r,i.mac=o,!s)do{s=(0,n.DU)(32)}while(await this.accountDataAdapter.getAccountDataFromServer(`m.secret_storage.key.${s}`));return await this.accountDataAdapter.setAccountData(`m.secret_storage.key.${s}`,i),{keyId:s,keyInfo:i}}async getKey(e){if(e||(e=await this.getDefaultKeyId()),!e)return null;const t=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e);return t?[e,t]:null}async hasKey(e){const t=await this.getKey(e);return Boolean(t)}async checkKey(e,t){if(t.algorithm===d){if(t.mac){const{mac:s}=await h(e,t.iv);return l(t.mac)===l(s)}return!0}throw new Error("Unknown algorithm")}async store(e,t,s){const i={};if(!s){const e=await this.getDefaultKeyId();if(!e)throw new Error("No keys specified and no default key present");s=[e]}if(0===s.length)throw new Error("Zero keys given to encrypt with!");for(const n of s){const s=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+n);if(!s)throw new Error("Unknown key: "+n);if(s.algorithm===d){const r={[n]:s},[,o]=await this.getSecretStorageKey(r,e);i[n]=await o.encrypt(t)}else r.v.warn("unknown algorithm for secret storage key "+n+": "+s.algorithm)}await this.accountDataAdapter.setAccountData(e,{encrypted:i})}async get(e){const t=await this.accountDataAdapter.getAccountDataFromServer(e);if(!t)return;if(!t.encrypted)throw new Error("Content is not encrypted!");const s={};for(const e of Object.keys(t.encrypted)){const i=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e),n=t.encrypted[e];(null==i?void 0:i.algorithm)===d&&n.iv&&n.ciphertext&&n.mac&&(s[e]=i)}if(0===Object.keys(s).length)throw new Error(`Could not decrypt ${e} because none of the keys it is encrypted with are for a supported algorithm`);const[i,n]=await this.getSecretStorageKey(s,e),r=t.encrypted[i];return n.decrypt(r)}async isStored(e){const t=await this.accountDataAdapter.getAccountDataFromServer(e);if(null==t||!t.encrypted)return null;const s={};for(const e of Object.keys(t.encrypted)){const i=await this.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key."+e);if(!i)continue;const n=t.encrypted[e];i.algorithm===d&&n.iv&&n.ciphertext&&n.mac&&(s[e]=i)}return Object.keys(s).length?s:null}async getSecretStorageKey(e,t){if(!this.callbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");const s=await this.callbacks.getSecretStorageKey({keys:e},t);if(!s)throw new Error("getSecretStorageKey callback returned falsey");if(s.length<2)throw new Error("getSecretStorageKey callback returned invalid data");const[i,n]=s;if(!e[i])throw new Error("App returned unknown key from getSecretStorageKey!");if(e[i].algorithm===d){return[i,{encrypt:function(e){return(0,o.A)(e,n,t)},decrypt:function(e){return(0,a.A)(e,n,t)}}]}throw new Error("Unknown key type: "+e[i].algorithm)}}function l(e){let t=e.length;for(;t>=1&&61==e.charCodeAt(t-1);)t--;return t<e.length?e.substring(0,t):e}const u="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0";function h(e,t){return(0,o.A)(u,e,"",t)}},"./node_modules/matrix-js-sdk/src/serverCapabilities.ts":(e,t,s)=>{"use strict";s.d(t,{K:()=>a,L:()=>o});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/http-api/index.ts"),r=s("./node_modules/matrix-js-sdk/src/logger.ts");let o=function(e){return e.Stable="stable",e.Unstable="unstable",e}({});class a{constructor(e){(0,i.A)(this,"capabilities",void 0),(0,i.A)(this,"retryTimeout",void 0),(0,i.A)(this,"refreshTimeout",void 0),(0,i.A)(this,"fetchCapabilities",(async()=>{const e=await this.http.authedRequest(n.IT.Get,"/capabilities");return this.capabilities=e.capabilities,this.capabilities})),(0,i.A)(this,"poll",(async()=>{try{await this.fetchCapabilities(),this.clearTimeouts(),this.refreshTimeout=setTimeout(this.poll,216e5),r.v.debug("Fetched new server capabilities")}catch(e){this.clearTimeouts();const t=Math.floor(3e4+5e3*Math.random());this.retryTimeout=setTimeout(this.poll,t),r.v.warn(`Failed to refresh capabilities: retrying in ${t}ms`,e)}})),this.http=e}start(){this.poll().then()}stop(){this.clearTimeouts()}getCachedCapabilities(){return this.capabilities}clearTimeouts(){this.refreshTimeout&&(clearInterval(this.refreshTimeout),this.refreshTimeout=void 0),this.retryTimeout&&(clearTimeout(this.retryTimeout),this.retryTimeout=void 0)}}},"./node_modules/matrix-js-sdk/src/service-types.ts":(e,t,s)=>{"use strict";s.d(t,{S:()=>i});let i=function(e){return e.IS="SERVICE_TYPE_IS",e.IM="SERVICE_TYPE_IM",e}({})},"./node_modules/matrix-js-sdk/src/sliding-sync-sdk.ts":(e,t,s)=>{"use strict";s.d(t,{m:()=>E});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/models/room.ts"),r=s("./node_modules/matrix-js-sdk/src/logger.ts"),o=s("./node_modules/matrix-js-sdk/src/utils.ts"),a=s("./node_modules/matrix-js-sdk/src/models/event-timeline.ts"),d=s("./node_modules/matrix-js-sdk/src/client.ts"),c=s("./node_modules/matrix-js-sdk/src/sync.ts"),l=s("./node_modules/matrix-js-sdk/src/http-api/index.ts"),u=s("./node_modules/matrix-js-sdk/src/sliding-sync.ts"),h=s("./node_modules/matrix-js-sdk/src/@types/event.ts"),m=s("./node_modules/matrix-js-sdk/src/models/room-state.ts"),p=s("./node_modules/matrix-js-sdk/src/models/room-member.ts"),g=s("./node_modules/matrix-js-sdk/src/@types/membership.ts");class v{constructor(e){this.crypto=e}name(){return"e2ee"}when(){return u.HY.PreProcess}onRequest(e){if(e)return{enabled:!0}}async onResponse(e){e.device_lists&&await this.crypto.processDeviceLists(e.device_lists),await this.crypto.processKeyCounts(e.device_one_time_keys_count,e.device_unused_fallback_key_types||e["org.matrix.msc2732.device_unused_fallback_key_types"]),this.crypto.onSyncCompleted({})}}class f{constructor(e,t){(0,i.A)(this,"nextBatch",null),this.client=e,this.cryptoCallbacks=t}name(){return"to_device"}when(){return u.HY.PreProcess}onRequest(e){const t={since:null!==this.nextBatch?this.nextBatch:void 0};return e&&(t.limit=100,t.enabled=!0),t}async onResponse(e){const t=[];let s=e.events||[];s.length>0&&this.cryptoCallbacks&&(s=await this.cryptoCallbacks.preprocessToDeviceMessages(s)),s.map(this.client.getEventMapper()).map((e=>{if("m.key.verification.cancel"===e.getType()){const s=e.getContent().transaction_id;s&&t.push(s)}return e})).forEach((e=>{const s=e.getContent();if("m.room.message"!=e.getType()||"m.bad.encrypted"!=s.msgtype){if("m.key.verification.start"===e.getType()||"m.key.verification.request"===e.getType()){const i=s.transaction_id;t.includes(i)&&e.flagCancelled()}this.client.emit(d.AU.ToDeviceEvent,e)}else r.v.log("Ignoring undecryptable to-device event from "+e.getSender())})),this.nextBatch=e.next_batch}}class y{constructor(e){this.client=e}name(){return"account_data"}when(){return u.HY.PostProcess}onRequest(e){if(e)return{enabled:!0}}async onResponse(e){e.global&&e.global.length>0&&this.processGlobalAccountData(e.global);for(const t in e.rooms){const s=w(this.client,t,e.rooms[t]),i=this.client.getRoom(t);i?(i.addAccountData(s),s.forEach((e=>{this.client.emit(d.AU.Event,e)}))):r.v.warn("got account data for room but room doesn't exist on client:",t)}}processGlobalAccountData(e){const t=w(this.client,void 0,e),s=t.reduce(((e,t)=>(e[t.getType()]=this.client.store.getAccountData(t.getType()),e)),{});this.client.store.storeAccountDataEvents(t),t.forEach((e=>{if(e.getType()===h.Bx.PushRules){const t=e.getContent();this.client.setPushRules(t)}const t=s[e.getType()];return this.client.emit(d.AU.AccountData,e,t),e}))}}class S{constructor(e){this.client=e}name(){return"typing"}when(){return u.HY.PostProcess}onRequest(e){if(e)return{enabled:!0}}async onResponse(e){if(null!=e&&e.rooms)for(const t in e.rooms)I(this.client,t,[e.rooms[t]])}}class b{constructor(e){this.client=e}name(){return"receipts"}when(){return u.HY.PostProcess}onRequest(e){if(e)return{enabled:!0}}async onResponse(e){if(null!=e&&e.rooms)for(const t in e.rooms)I(this.client,t,[e.rooms[t]])}}class E{constructor(e,t,s,r){(0,i.A)(this,"opts",void 0),(0,i.A)(this,"syncOpts",void 0),(0,i.A)(this,"syncState",null),(0,i.A)(this,"syncStateData",void 0),(0,i.A)(this,"lastPos",null),(0,i.A)(this,"failCount",0),(0,i.A)(this,"notifEvents",[]),this.slidingSync=e,this.client=t,this.opts=(0,c.Bn)(s),this.syncOpts=(0,c.Fe)(r),t.getNotifTimelineSet()&&t.reEmitter.reEmit(t.getNotifTimelineSet(),[n.u9.Timeline,n.u9.TimelineReset]),this.slidingSync.on(u.cQ.Lifecycle,this.onLifecycle.bind(this)),this.slidingSync.on(u.cQ.RoomData,this.onRoomData.bind(this));const o=[new f(this.client,this.syncOpts.cryptoCallbacks),new y(this.client),new S(this.client),new b(this.client)];this.syncOpts.crypto&&o.push(new v(this.syncOpts.crypto)),o.forEach((e=>{this.slidingSync.registerExtension(e)}))}async onRoomData(e,t){let s=this.client.store.getRoom(e);if(!s){if(!t.initial)return void r.v.debug("initial flag not set but no stored room exists for room ",e,t);s=(0,c.M)(this.client,e,this.opts)}await this.processRoomData(this.client,s,t)}onLifecycle(e,t,s){switch(s&&r.v.debug("onLifecycle",e,s),e){case u.ns.Complete:if(this.purgeNotifications(),!t)break;this.lastPos||this.updateSyncState(c.Lm.Prepared,{oldSyncToken:void 0,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.updateSyncState(c.Lm.Syncing,{oldSyncToken:this.lastPos,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.lastPos=t.pos;break;case u.ns.RequestFinished:if(s){if(this.failCount+=1,this.updateSyncState(this.failCount>3?c.Lm.Error:c.Lm.Reconnecting,{error:new l.up(s)}),this.shouldAbortSync(new l.up(s)))return}else this.failCount=0}}async syncLeftRooms(){return[]}async peek(e){return null}stopPeeking(){}setPresence(e){}getSyncState(){return this.syncState}getSyncStateData(){var e;return null!==(e=this.syncStateData)&&void 0!==e?e:null}createRoom(e){const{timelineSupport:t}=this.client,s=new n.Wv(e,this.client,this.client.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:t});return this.client.reEmitter.reEmit(s,[n.u9.Name,n.u9.Redaction,n.u9.RedactionCancelled,n.u9.Receipt,n.u9.Tags,n.u9.LocalEchoUpdated,n.u9.AccountData,n.u9.MyMembership,n.u9.Timeline,n.u9.TimelineReset]),this.registerStateListeners(s),s}registerStateListeners(e){this.client.reEmitter.reEmit(e.currentState,[m.f.Events,m.f.Members,m.f.NewMember,m.f.Update]),e.currentState.on(m.f.NewMember,((e,t,s)=>{var i;s.user=null!==(i=this.client.getUser(s.userId))&&void 0!==i?i:void 0,this.client.reEmitter.reEmit(s,[p.o.Name,p.o.Typing,p.o.PowerLevel,p.o.Membership])}))}shouldAbortSync(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(r.v.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(c.Lm.Error,{error:e}),!0)}async processRoomData(e,t,s){s=function(e,t,s){if(!s.name)return s;for(const e of s.required_state)if(e.type===h.Bx.RoomName&&""===e.state_key)return e.content={name:s.name},s;return s.required_state.push({event_id:"$fake-sliding-sync-name-event-"+t,state_key:"",type:h.Bx.RoomName,content:{name:s.name},sender:e.getUserId(),origin_server_ts:(new Date).getTime()}),s}(e,t.roomId,s);const i=w(this.client,t.roomId,s.required_state);let r=w(this.client,t.roomId,s.timeline,!1);const c=[];if(s.initial){const e=new Set;t.getLiveTimeline().getEvents().forEach((t=>{e.add(t.getId())}));const i=[],n=[];let o=!1;for(let t=r.length-1;t>=0;t--){const s=r[t];e.has(s.getId())?o=!0:o?i.push(s):n.unshift(s)}r=n,i.length>0&&t.addEventsToTimeline(i,!0,t.getLiveTimeline(),s.prev_batch)}const l=t.hasEncryptionStateEvent();if(null!=s.notification_count&&t.setUnreadNotificationCount(n.X5.Total,s.notification_count),null!=s.highlight_count&&(!l||l&&t.getUnreadNotificationCount(n.X5.Highlight)<=0)&&t.setUnreadNotificationCount(n.X5.Highlight,s.highlight_count),Number.isInteger(s.invited_count)&&t.currentState.setInvitedMemberCount(s.invited_count),Number.isInteger(s.joined_count)&&t.currentState.setJoinedMemberCount(s.joined_count),s.invite_state){const e=w(this.client,t.roomId,s.invite_state);return await this.injectRoomEvents(t,e),s.initial&&(t.recalculate(),this.client.store.storeRoom(t),this.client.emit(d.AU.Room,t)),e.forEach((e=>{this.client.emit(d.AU.Event,e)})),void t.updateMyMembership(g.O.Invite)}var u;s.initial&&t.getLiveTimeline().setPaginationToken(null!==(u=s.prev_batch)&&void 0!==u?u:null,a.q.BACKWARDS);await this.injectRoomEvents(t,i,r,s.num_live),t.addEphemeralEvents(c),t.updateMyMembership(g.O.Join),t.recalculate(),s.initial&&(e.store.storeRoom(t),e.emit(d.AU.Room,t)),this.addNotifications(r);const m=async s=>{e.emit(d.AU.Event,s),s.isState()&&s.getType()==h.Bx.RoomEncryption&&this.syncOpts.cryptoCallbacks&&await this.syncOpts.cryptoCallbacks.onCryptoEvent(t,s)};await(0,o.d8)(i,m),await(0,o.d8)(r,m),c.forEach((function(t){e.emit(d.AU.Event,t)})),t.decryptCriticalEvents()}async injectRoomEvents(e,t,s,i){s=s||[],t=t||[],i=i||0;const n=e.getLiveTimeline(),r=0==n.getEvents().length;if(r){for(const e of t)this.client.getPushActionsForEvent(e);n.initialiseState(t)}r||(e.oldState.setStateEvents(t),e.currentState.setStateEvents(t));let o=[];i>0&&(o=s.slice(-1*i),s=s.slice(0,-1*o.length)),await e.addLiveEvents(s,{fromCache:!0}),o.length>0&&await e.addLiveEvents(o,{fromCache:!1}),e.recalculate(),this.resolveInvites(e)}resolveInvites(e){if(!e||!this.opts.resolveInvitesToProfiles)return;const t=this.client;e.getMembersWithMembership(g.O.Invite).forEach((function(s){if(s.requestedProfileInfo)return;s.requestedProfileInfo=!0;const i=t.getUser(s.userId);let n;n=i?Promise.resolve({avatar_url:i.avatarUrl,displayname:i.displayName}):t.getProfileInfo(s.userId),n.then((function(t){const i=s.events.member;i.getContent().membership===g.O.Invite&&(i.getContent().avatar_url=t.avatar_url,i.getContent().displayname=t.displayname,s.setMembershipEvent(i,e.currentState))}),(function(e){}))}))}retryImmediately(){return!0}async sync(){for(r.v.debug("Sliding sync init loop");!this.client.isGuest();)try{r.v.debug("Getting push rules...");const e=await this.client.getPushRules();r.v.debug("Got push rules"),this.client.pushRules=e;break}catch(e){if(r.v.error("Getting push rules failed",e),this.shouldAbortSync(e))return}await this.slidingSync.start()}stop(){r.v.debug("SyncApi.stop"),this.slidingSync.stop()}updateSyncState(e,t){const s=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(d.AU.Sync,this.syncState,s,t)}addNotifications(e){if(this.client.getNotifTimelineSet())for(const t of e){const e=this.client.getPushActionsForEvent(t);e&&e.notify&&e.tweaks&&e.tweaks.highlight&&this.notifEvents.push(t)}}purgeNotifications(){this.notifEvents.sort((function(e,t){return e.getTs()-t.getTs()})),this.notifEvents.forEach((e=>{var t;null===(t=this.client.getNotifTimelineSet())||void 0===t||t.addLiveEvent(e)})),this.notifEvents=[]}}function w(e,t,s,i=!0){const n=e.getEventMapper({decrypt:i});return s.map((function(e){return e.room_id=t,n(e)}))}function I(e,t,s){const i=w(e,t,s),n=e.getRoom(t);n?(n.addEphemeralEvents(i),i.forEach((t=>{e.emit(d.AU.Event,t)}))):r.v.warn("got ephemeral events for room but room doesn't exist on client:",t)}},"./node_modules/matrix-js-sdk/src/sliding-sync.ts":(e,t,s)=>{"use strict";s.d(t,{HY:()=>r,cQ:()=>o,ns:()=>n});s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s("./node_modules/matrix-js-sdk/src/logger.ts");var i=s("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts");s("./node_modules/matrix-js-sdk/src/utils.ts");let n=function(e){return e.RequestFinished="FINISHED",e.Complete="COMPLETE",e}({});let r=function(e){return e.PreProcess="ExtState.PreProcess",e.PostProcess="ExtState.PostProcess",e}({}),o=function(e){return e.RoomData="SlidingSync.RoomData",e.Lifecycle="SlidingSync.Lifecycle",e.List="SlidingSync.List",e}({});i.X},"./node_modules/matrix-js-sdk/src/sync.ts":(e,t,s)=>{"use strict";s.d(t,{Bn:()=>R,Fe:()=>T,Lm:()=>E,M:()=>A,w_:()=>C});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/models/user.ts"),r=s("./node_modules/matrix-js-sdk/src/models/room.ts"),o=s("./node_modules/matrix-js-sdk/src/utils.ts"),a=s("./node_modules/matrix-js-sdk/src/filter.ts"),d=s("./node_modules/matrix-js-sdk/src/models/event-timeline.ts"),c=s("./node_modules/matrix-js-sdk/src/logger.ts"),l=s("./node_modules/matrix-js-sdk/src/client.ts"),u=s("./node_modules/matrix-js-sdk/src/http-api/index.ts"),h=s("./node_modules/matrix-js-sdk/src/@types/event.ts"),m=s("./node_modules/matrix-js-sdk/src/models/room-state.ts"),p=s("./node_modules/matrix-js-sdk/src/models/room-member.ts"),g=s("./node_modules/matrix-js-sdk/src/models/beacon.ts"),v=s("./node_modules/matrix-js-sdk/src/@types/sync.ts"),f=s("./node_modules/matrix-js-sdk/src/feature.ts"),y=s("./node_modules/matrix-js-sdk/src/@types/membership.ts");function S(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function b(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?S(Object(s),!0).forEach((function(t){(0,i.A)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):S(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let E=function(e){return e.Error="ERROR",e.Prepared="PREPARED",e.Stopped="STOPPED",e.Syncing="SYNCING",e.Catchup="CATCHUP",e.Reconnecting="RECONNECTING",e}({});const w=["org.matrix.msc2716v3"];function I(e,t){return`FILTER_SYNC_${e}`+(t?"_"+t:"")}function _(...e){c.v.log(...e)}let k=function(e){return e.Offline="offline",e.Online="online",e.Unavailable="unavailable",e}({});function R(e){return b({initialSyncLimit:8,resolveInvitesToProfiles:!1,pollTimeout:3e4,pendingEventOrdering:l.eO.Chronological,threadSupport:!1},e)}function T(e){return b({canResetEntireTimeline:e=>!1},e)}class C{constructor(e,t,s){(0,i.A)(this,"opts",void 0),(0,i.A)(this,"syncOpts",void 0),(0,i.A)(this,"_peekRoom",null),(0,i.A)(this,"currentSyncRequest",void 0),(0,i.A)(this,"abortController",void 0),(0,i.A)(this,"syncState",null),(0,i.A)(this,"syncStateData",void 0),(0,i.A)(this,"catchingUp",!1),(0,i.A)(this,"running",!1),(0,i.A)(this,"keepAliveTimer",void 0),(0,i.A)(this,"connectionReturnedDefer",void 0),(0,i.A)(this,"notifEvents",[]),(0,i.A)(this,"failedSyncCount",0),(0,i.A)(this,"storeIsInvalid",!1),(0,i.A)(this,"presence",void 0),(0,i.A)(this,"getPushRules",(async()=>{try{_("Getting push rules...");const e=await this.client.getPushRules();_("Got push rules"),this.client.pushRules=e}catch(e){if(c.v.error("Getting push rules failed",e),this.shouldAbortSync(e))return;return _("Waiting for saved sync before retrying push rules..."),await this.recoverFromSyncStartupError(this.savedSyncPromise,e),this.getPushRules()}})),(0,i.A)(this,"buildDefaultFilter",(()=>{const e=new a.d(this.client.credentials.userId);return this.client.canSupport.get(f.Xj.ThreadUnreadNotifications)!==f.Tj.Unsupported&&e.setUnreadThreadNotifications(!0),e})),(0,i.A)(this,"prepareLazyLoadingForSync",(async()=>{var e;(_("Prepare lazy loading for sync..."),this.client.isGuest()&&(this.opts.lazyLoadMembers=!1),this.opts.lazyLoadMembers&&(_("Enabling lazy load on sync filter..."),this.opts.filter||(this.opts.filter=this.buildDefaultFilter()),this.opts.filter.setLazyLoadMembers(!0)),this.opts.lazyLoadMembers)&&(null===(e=this.syncOpts.crypto)||void 0===e||e.enableLazyLoading())})),(0,i.A)(this,"storeClientOptions",(async()=>{try{_("Storing client options..."),await this.client.storeClientOptions(),_("Stored client options")}catch(e){throw c.v.error("Storing client options failed",e),e}})),(0,i.A)(this,"getFilter",(async()=>{let e,t;_("Getting filter..."),e=this.opts.filter?this.opts.filter:this.buildDefaultFilter();try{t=await this.client.getOrCreateFilter(I(this.client.credentials.userId),e)}catch(e){return c.v.error("Getting filter failed",e),this.shouldAbortSync(e)?{}:(_("Waiting for saved sync before retrying filter..."),await this.recoverFromSyncStartupError(this.savedSyncPromise,e),this.getFilter())}return{filter:e,filterId:t}})),(0,i.A)(this,"savedSyncPromise",void 0),(0,i.A)(this,"onOnline",(()=>{_("Browser thinks we are back online"),this.startKeepAlives(0)})),this.client=e,this.opts=R(t),this.syncOpts=T(s),e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),[r.u9.Timeline,r.u9.TimelineReset])}createRoom(e){const t=A(this.client,e,this.opts);return t.on(m.f.Marker,((e,s)=>{this.onMarkerStateEvent(t,e,s)})),t}onMarkerStateEvent(e,t,{timelineWasEmpty:s}={}){if(s)return void c.v.debug(`MarkerState: Ignoring markerEventId=${t.getId()} in roomId=${e.roomId} because the timeline was empty before the marker arrived which means there is nothing to refresh.`);w.includes(e.getVersion())||t.getSender()===e.getCreator()?(c.v.debug(`MarkerState: Timeline needs to be refreshed because a new markerEventId=${t.getId()} was sent in roomId=${e.roomId}`),e.setTimelineNeedsRefresh(!0),e.emit(r.u9.HistoryImportedWithinTimeline,t,e)):c.v.debug(`MarkerState: Ignoring markerEventId=${t.getId()} in roomId=${e.roomId} because MSC2716 is not supported in the room version or for any room version, the marker wasn't sent by the room creator.`)}async syncLeftRooms(){var e;const t=this.client,s=new a.d(this.client.credentials.userId);s.setTimelineLimit(1),s.setIncludeLeaveRooms(!0);const i=this.opts.pollTimeout+8e4,n={timeout:0,filter:await t.getOrCreateFilter(I(t.credentials.userId,"LEFT_ROOMS"),s)},r=await t.http.authedRequest(u.IT.Get,"/sync",n,void 0,{localTimeoutMs:i});let o=[];null!==(e=r.rooms)&&void 0!==e&&e.leave&&(o=this.mapSyncResponseToRoomArray(r.rooms.leave));return(await Promise.all(o.map((async e=>{const s=e.room;if(!e.isBrandNewRoom)return;e.timeline=e.timeline||{prev_batch:null,events:[]};const i=this.mapSyncEventsFormat(e.timeline,s),n=this.mapSyncEventsFormat(e.state,s);return s.getLiveTimeline().setPaginationToken(e.timeline.prev_batch,d.q.BACKWARDS),await this.injectRoomEvents(s,n,i),s.recalculate(),t.store.storeRoom(s),t.emit(l.AU.Room,s),this.processEventsForNotifs(s,i),s})))).filter(Boolean)}peek(e,t=20){var s;if((null===(s=this._peekRoom)||void 0===s?void 0:s.roomId)===e)return Promise.resolve(this._peekRoom);const i=this.client;return this._peekRoom=this.createRoom(e),this.client.roomInitialSync(e,t).then((t=>{var s;if((null===(s=this._peekRoom)||void 0===s?void 0:s.roomId)!==e)throw new Error("Peeking aborted");t.messages=t.messages||{chunk:[]},t.messages.chunk=t.messages.chunk||[],t.state=t.state||[];const r=(0,o.A4)(t.state).map(i.getEventMapper()),a=t.state.map(i.getEventMapper()),d=t.messages.chunk.map(i.getEventMapper());return Array.isArray(t.presence)&&t.presence.map(i.getEventMapper()).forEach((function(e){let t=i.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):(t=n.K.createUser(e.getContent().user_id,i),t.setPresenceEvent(e),i.store.storeUser(t)),i.emit(l.AU.Event,e)})),t.messages.start&&(this._peekRoom.oldState.paginationToken=t.messages.start),this._peekRoom.oldState.setStateEvents(r),this._peekRoom.currentState.setStateEvents(a),this.resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(d.reverse(),!0,this._peekRoom.getLiveTimeline(),t.messages.start),i.store.storeRoom(this._peekRoom),i.emit(l.AU.Room,this._peekRoom),this.peekPoll(this._peekRoom),this._peekRoom}))}stopPeeking(){this._peekRoom=null}peekPoll(e,t){var s;this._peekRoom===e?this.client.http.authedRequest(u.IT.Get,"/events",{room_id:e.roomId,timeout:String(3e4),from:t},void 0,{localTimeoutMs:5e4,abortSignal:null===(s=this.abortController)||void 0===s?void 0:s.signal}).then((async t=>{if(this._peekRoom!==e)return void _("Stopped peeking in room %s",e.roomId);t.chunk.filter((function(e){return"m.presence"===e.type})).map(this.client.getEventMapper()).forEach((e=>{let t=this.client.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):(t=n.K.createUser(e.getContent().user_id,this.client),t.setPresenceEvent(e),this.client.store.storeUser(t)),this.client.emit(l.AU.Event,e)}));const s=t.chunk.filter((function(t){return t.room_id===e.roomId&&t.event_id})).map(this.client.getEventMapper());await e.addLiveEvents(s),this.peekPoll(e,t.end)}),(s=>{c.v.error("[%s] Peek poll failed: %s",e.roomId,s),setTimeout((()=>{this.peekPoll(e,t)}),3e4)})):_("Stopped peeking in room %s",e.roomId)}getSyncState(){return this.syncState}getSyncStateData(){var e;return null!==(e=this.syncStateData)&&void 0!==e?e:null}async recoverFromSyncStartupError(e,t){await e;const s=this.startKeepAlives();this.updateSyncState(E.Error,{error:t}),await s}shouldAbortSync(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(c.v.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(E.Error,{error:e}),!0)}async sync(){var e,t;if(this.running=!0,this.abortController=new AbortController,null===(e=s.g.window)||void 0===e||null===(t=e.addEventListener)||void 0===t||t.call(e,"online",this.onOnline,!1),this.client.isGuest())return this.doSync({});_("Getting saved sync token...");const i=this.client.store.getSavedSyncToken().then((e=>(_("Got saved sync token"),e)));this.savedSyncPromise=this.client.store.getSavedSync().then((e=>{if(_(`Got reply from saved sync, exists? ${!!e}`),e)return this.syncFromCache(e)})).catch((e=>{c.v.error("Getting saved sync failed",e)})),await this.getPushRules(),await this.prepareLazyLoadingForSync(),await this.storeClientOptions();const{filterId:n,filter:r}=await this.getFilter();if(r){if(this.client.resetNotifTimelineSet(),!this.currentSyncRequest){let e=n;const t=await i;if(t)_("Sending first sync request...");else{_("Sending initial sync request...");const t=this.buildDefaultFilter();t.setDefinition(r.getDefinition()),t.setTimelineLimit(this.opts.initialSyncLimit),e=JSON.stringify(t.getDefinition())}this.currentSyncRequest=this.doSyncRequest({filter:e},t)}return _("Waiting for saved sync before starting sync processing..."),await this.savedSyncPromise,this.doSync({filter:n})}}stop(){var e,t,i;_("SyncApi.stop"),null===(e=s.g.window)||void 0===e||null===(t=e.removeEventListener)||void 0===t||t.call(e,"online",this.onOnline,!1),this.running=!1,null===(i=this.abortController)||void 0===i||i.abort(),this.keepAliveTimer&&(clearTimeout(this.keepAliveTimer),this.keepAliveTimer=void 0)}retryImmediately(){return!!this.connectionReturnedDefer&&(this.startKeepAlives(0),!0)}async syncFromCache(e){_("sync(): not doing HTTP hit, instead returning stored /sync data");const t=e.nextBatch;this.client.store.setSyncToken(t);const s={nextSyncToken:t,catchingUp:!1,fromCache:!0},i={next_batch:t,rooms:e.roomsData,account_data:{events:e.accountData}};try{await this.processSyncResponse(s,i)}catch(e){c.v.error("Error processing cached sync",e)}this.storeIsInvalid||this.updateSyncState(E.Prepared,s)}async doSync(e){for(;this.running;){const t=this.client.store.getSyncToken();let s;try{this.currentSyncRequest||(this.currentSyncRequest=this.doSyncRequest(e,t)),s=await this.currentSyncRequest}catch(e){if(await this.onSyncError(e))return;continue}finally{this.currentSyncRequest=void 0}this.client.store.setSyncToken(s.next_batch),this.failedSyncCount=0;const i={oldSyncToken:null!=t?t:void 0,nextSyncToken:s.next_batch,catchingUp:this.catchingUp};this.syncOpts.crypto&&await this.syncOpts.crypto.onSyncWillProcess(i);try{await this.processSyncResponse(i,s)}catch(e){c.v.error("Caught /sync error",e),this.client.emit(l.AU.SyncUnexpectedError,e)}await this.client.store.setSyncData(s),i.catchingUp=this.catchingUp,e.hasSyncedBefore||(this.updateSyncState(E.Prepared,i),e.hasSyncedBefore=!0),this.syncOpts.cryptoCallbacks&&await this.syncOpts.cryptoCallbacks.onSyncCompleted(i),this.updateSyncState(E.Syncing,i),this.client.store.wantsSave()&&(this.syncOpts.crypto&&await this.syncOpts.crypto.saveDeviceList(0),await this.client.store.save())}this.running||(_("Sync no longer running: exiting."),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject(),this.connectionReturnedDefer=void 0),this.updateSyncState(E.Stopped))}doSyncRequest(e,t){var s;const i=this.getSyncParams(e,t);return this.client.http.authedRequest(u.IT.Get,"/sync",i,void 0,{localTimeoutMs:i.timeout+8e4,abortSignal:null===(s=this.abortController)||void 0===s?void 0:s.signal})}getSyncParams(e,t){let s=this.opts.pollTimeout;(this.getSyncState()!==E.Syncing||this.catchingUp)&&(this.catchingUp=!0,s=0);let i=e.filter;this.client.isGuest()&&!i&&(i=this.getGuestFilter());const n={filter:i,timeout:s};return this.opts.disablePresence?n.set_presence=k.Offline:void 0!==this.presence&&(n.set_presence=this.presence),t?n.since=t:n._cacheBuster=Date.now(),[E.Reconnecting,E.Error].includes(this.getSyncState())&&(n.timeout=0),n}setPresence(e){this.presence=e}async onSyncError(e){if(!this.running)return _("Sync no longer running: exiting"),this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject(),this.connectionReturnedDefer=void 0),this.updateSyncState(E.Stopped),!0;if(c.v.error("/sync error %s",e),this.shouldAbortSync(e))return!0;this.failedSyncCount++,c.v.log("Number of consecutive failed sync requests:",this.failedSyncCount),_("Starting keep-alive");const t=this.startKeepAlives();this.currentSyncRequest=void 0,this.updateSyncState(this.failedSyncCount>=3?E.Error:E.Reconnecting,{error:e});return await t&&this.getSyncState()===E.Error&&this.updateSyncState(E.Catchup,{catchingUp:!0}),!1}async processSyncResponse(e,t){var s,i,a,u;const m=this.client;if(Array.isArray(null===(s=t.presence)||void 0===s?void 0:s.events)&&t.presence.events.filter(o.O5).map(m.getEventMapper()).forEach((function(e){let t=m.store.getUser(e.getSender());t?t.setPresenceEvent(e):(t=n.K.createUser(e.getSender(),m),t.setPresenceEvent(e),m.store.storeUser(t)),m.emit(l.AU.Event,e)})),Array.isArray(null===(i=t.account_data)||void 0===i?void 0:i.events)){const e=t.account_data.events.filter(o.O5).map(m.getEventMapper()),s=e.reduce(((e,t)=>(e[t.getType()]=m.store.getAccountData(t.getType()),e)),{});m.store.storeAccountDataEvents(e),e.forEach((function(e){if(e.getType()===h.Bx.PushRules){const t=e.getContent();m.setPushRules(t)}const t=s[e.getType()];return m.emit(l.AU.AccountData,e,t),e}))}if(t.to_device&&Array.isArray(t.to_device.events)&&t.to_device.events.length>0){let e=t.to_device.events.filter(o.O5);this.syncOpts.cryptoCallbacks&&(e=await this.syncOpts.cryptoCallbacks.preprocessToDeviceMessages(e));const s=[];e.map(m.getEventMapper({toDevice:!0})).map((e=>{if("m.key.verification.cancel"===e.getType()){const t=e.getContent().transaction_id;t&&s.push(t)}return e})).forEach((function(e){const t=e.getContent();if("m.room.message"!=e.getType()||"m.bad.encrypted"!=t.msgtype){if("m.key.verification.start"===e.getType()||"m.key.verification.request"===e.getType()){const i=t.transaction_id;s.includes(i)&&e.flagCancelled()}m.emit(l.AU.ToDeviceEvent,e)}else c.v.log("Ignoring undecryptable to-device event from "+e.getSender())}))}else this.catchingUp=!1;let p=[],g=[],f=[],y=[];t.rooms&&(t.rooms.invite&&(p=this.mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(g=this.mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(f=this.mapSyncResponseToRoomArray(t.rooms.leave)),t.rooms.knock&&(y=this.mapSyncResponseToRoomArray(t.rooms.knock))),this.notifEvents=[],await(0,o.d8)(p,(async e=>{var t;const s=e.room,i=this.mapSyncEventsFormat(e.invite_state,s);await this.injectRoomEvents(s,i);const n=null===(t=s.currentState.getStateEvents(h.Bx.RoomMember,m.getUserId()))||void 0===t?void 0:t.getSender(),r=m.crypto;if(r){const e=await r.cryptoStore.takeParkedSharedHistory(s.roomId);for(const t of e)t.senderId===n&&await r.olmDevice.addInboundGroupSession(s.roomId,t.senderKey,t.forwardingCurve25519KeyChain,t.sessionId,t.sessionKey,t.keysClaimed,!0,{sharedHistory:!0,untrusted:!0})}e.isBrandNewRoom?(s.recalculate(),m.store.storeRoom(s),m.emit(l.AU.Room,s)):s.recalculate(),i.forEach((function(e){m.emit(l.AU.Event,e)}))})),await(0,o.d8)(g,(async t=>{var s;const i=t.room,n=this.mapSyncEventsFormat(t.state,i),o=this.mapSyncEventsFormat(t.timeline,i,!1),a=this.mapSyncEventsFormat(t.ephemeral),u=this.mapSyncEventsFormat(t.account_data),p=this.isRoomEncrypted(i,n,o);if(t.unread_notifications){var g,f;if(!p||0===t.unread_notifications.notification_count)i.setUnreadNotificationCount(r.X5.Total,null!==(g=t.unread_notifications.notification_count)&&void 0!==g?g:0);if(!p||i.getUnreadNotificationCount(r.X5.Highlight)<=0)i.setUnreadNotificationCount(r.X5.Highlight,null!==(f=t.unread_notifications.highlight_count)&&void 0!==f?f:0)}const y=null!==(s=t[v.a.name])&&void 0!==s?s:t[v.a.altName];if(y){i.resetThreadUnreadNotificationCountFromSync(Object.keys(y));for(const[e,t]of Object.entries(y)){var S;if(!p||0===t.notification_count)i.setThreadUnreadNotificationCount(e,r.X5.Total,null!==(S=t.notification_count)&&void 0!==S?S:0);const s=i.getThreadUnreadNotificationCount(e,r.X5.Highlight)<=0;var b;if(!p||p&&s)i.setThreadUnreadNotificationCount(e,r.X5.Highlight,null!==(b=t.highlight_count)&&void 0!==b?b:0)}}else i.resetThreadUnreadNotificationCountFromSync();if(t.timeline=t.timeline||{},t.isBrandNewRoom)null!==t.timeline.prev_batch&&i.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,d.q.BACKWARDS);else if(t.timeline.limited){let s=!0;for(let e=o.length-1;e>=0;e--){const t=o[e].getId();if(i.getTimelineForEvent(t)){_(`Already have event ${t} in limited sync - not resetting`),s=!1,o.splice(0,e);break}}var E;if(s)i.resetLiveTimeline(t.timeline.prev_batch,this.syncOpts.canResetEntireTimeline(i.roomId)?null:null!==(E=e.oldSyncToken)&&void 0!==E?E:null),m.resetNotifTimelineSet()}if(this.syncOpts.cryptoCallbacks)for(const e of n.concat(o))e.isState()&&e.getType()===h.Bx.RoomEncryption&&""===e.getStateKey()&&await this.syncOpts.cryptoCallbacks.onCryptoEvent(i,e);try{await this.injectRoomEvents(i,n,o,e.fromCache)}catch(e){c.v.error(`Failed to process events on room ${i.roomId}:`,e)}t.summary&&i.setSummary(t.summary),i.addEphemeralEvents(a),i.addAccountData(u),i.recalculate(),t.isBrandNewRoom&&(m.store.storeRoom(i),m.emit(l.AU.Room,i)),this.processEventsForNotifs(i,o);const w=e=>m.emit(l.AU.Event,e);n.forEach(w),o.forEach(w),a.forEach(w),u.forEach(w),i.decryptCriticalEvents()})),await(0,o.d8)(f,(async e=>{const t=e.room,s=this.mapSyncEventsFormat(e.state,t),i=this.mapSyncEventsFormat(e.timeline,t),n=this.mapSyncEventsFormat(e.account_data);await this.injectRoomEvents(t,s,i),t.addAccountData(n),t.recalculate(),e.isBrandNewRoom&&(m.store.storeRoom(t),m.emit(l.AU.Room,t)),this.processEventsForNotifs(t,i),s.forEach((function(e){m.emit(l.AU.Event,e)})),i.forEach((function(e){m.emit(l.AU.Event,e)})),n.forEach((function(e){m.emit(l.AU.Event,e)}))})),await(0,o.d8)(y,(async e=>{const t=e.room,s=this.mapSyncEventsFormat(e.knock_state,t);await this.injectRoomEvents(t,s),e.isBrandNewRoom?(t.recalculate(),m.store.storeRoom(t),m.emit(l.AU.Room,t)):t.recalculate(),s.forEach((function(e){m.emit(l.AU.Event,e)}))})),e.oldSyncToken&&this.notifEvents.length&&(this.notifEvents.sort((function(e,t){return e.getTs()-t.getTs()})),this.notifEvents.forEach((function(e){var t;null===(t=m.getNotifTimelineSet())||void 0===t||t.addLiveEvent(e)}))),t.device_lists&&this.syncOpts.cryptoCallbacks&&await this.syncOpts.cryptoCallbacks.processDeviceLists(t.device_lists),await(null===(a=this.syncOpts.cryptoCallbacks)||void 0===a?void 0:a.processKeyCounts(t.device_one_time_keys_count,null!==(u=t.device_unused_fallback_key_types)&&void 0!==u?u:t["org.matrix.msc2732.device_unused_fallback_key_types"]))}startKeepAlives(e){return void 0===e&&(e=2e3+Math.floor(5e3*Math.random())),null!==this.keepAliveTimer&&clearTimeout(this.keepAliveTimer),e>0?this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this),e):this.pokeKeepAlive(),this.connectionReturnedDefer||(this.connectionReturnedDefer=(0,o.v6)()),this.connectionReturnedDefer.promise}pokeKeepAlive(e=!1){var t;if(!this.running)return clearTimeout(this.keepAliveTimer),void(this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject("SyncApi.stop() was called"),this.connectionReturnedDefer=void 0));const s=()=>{clearTimeout(this.keepAliveTimer),this.connectionReturnedDefer&&(this.connectionReturnedDefer.resolve(e),this.connectionReturnedDefer=void 0)};this.client.http.request(u.IT.Get,"/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15e3,abortSignal:null===(t=this.abortController)||void 0===t?void 0:t.signal}).then((()=>{s()}),(t=>{400==t.httpStatus||404==t.httpStatus?this.keepAliveTimer=setTimeout(s,2e3):(e=!0,this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this,e),5e3+Math.floor(5e3*Math.random())),this.updateSyncState(E.Error,{error:t}))}))}mapSyncResponseToRoomArray(e){const t=this.client;return Object.keys(e).filter((e=>!(0,o.YY)(e))).map((s=>{let i=t.store.getRoom(s),n=!1;return i||(i=this.createRoom(s),n=!0),b(b({},e[s]),{},{room:i,isBrandNewRoom:n})}))}mapSyncEventsFormat(e,t,s=!0){if(!e||!Array.isArray(e.events))return[];const i=this.client.getEventMapper({decrypt:s});return e.events.filter(o.O5).map((function(e){return t&&(e.room_id=t.roomId),i(e)}))}resolveInvites(e){if(!e||!this.opts.resolveInvitesToProfiles)return;const t=this.client;e.getMembersWithMembership(y.O.Invite).forEach((function(s){if(s.requestedProfileInfo)return;s.requestedProfileInfo=!0;const i=t.getUser(s.userId);let n;n=i?Promise.resolve({avatar_url:i.avatarUrl,displayname:i.displayName}):t.getProfileInfo(s.userId),n.then((function(t){const i=s.events.member;(null==i?void 0:i.getContent().membership)===y.O.Invite&&(i.getContent().avatar_url=t.avatar_url,i.getContent().displayname=t.displayname,s.setMembershipEvent(i,e.currentState))}),(function(e){}))}))}findEncryptionEvent(e){return null==e?void 0:e.find((e=>e.getType()===h.Bx.RoomEncryption&&""===e.getStateKey()))}isRoomEncrypted(e,t,s){return e.hasEncryptionStateEvent()||!!this.findEncryptionEvent(t)||!!this.findEncryptionEvent(s)}async injectRoomEvents(e,t,s,i=!1){const n=e.getLiveTimeline(),r=0==n.getEvents().length;if(r){for(const e of t)this.client.getPushActionsForEvent(e);n.initialiseState(t,{timelineWasEmpty:r})}this.resolveInvites(e),e.recalculate(),r||(e.oldState.setStateEvents(t||[]),e.currentState.setStateEvents(t||[])),await e.addLiveEvents(s||[],{fromCache:i,timelineWasEmpty:r}),this.client.processBeaconEvents(e,s)}processEventsForNotifs(e,t){if(this.client.getNotifTimelineSet())for(const e of t){var s;const t=this.client.getPushActionsForEvent(e);null!=t&&t.notify&&null!==(s=t.tweaks)&&void 0!==s&&s.highlight&&this.notifEvents.push(e)}}getGuestFilter(){return"{}"}updateSyncState(e,t){const s=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(l.AU.Sync,this.syncState,s,t)}}function A(e,t,s){const{timelineSupport:i}=e,n=new r.Wv(t,e,e.getUserId(),{lazyLoadMembers:s.lazyLoadMembers,pendingEventOrdering:s.pendingEventOrdering,timelineSupport:i});return e.reEmitter.reEmit(n,[r.u9.Name,r.u9.Redaction,r.u9.RedactionCancelled,r.u9.Receipt,r.u9.Tags,r.u9.LocalEchoUpdated,r.u9.AccountData,r.u9.MyMembership,r.u9.Timeline,r.u9.TimelineReset,m.f.Events,m.f.Members,m.f.NewMember,m.f.Update,g.JH.New,g.JH.Update,g.JH.Destroy,g.JH.LivenessChange]),n.on(m.f.NewMember,((t,s,i)=>{var n;i.user=null!==(n=e.getUser(i.userId))&&void 0!==n?n:void 0,e.reEmitter.reEmit(i,[p.o.Name,p.o.Typing,p.o.PowerLevel,p.o.Membership])})),n}},"./node_modules/matrix-js-sdk/src/types.ts":(e,t,s)=>{"use strict";s.d(t,{V:()=>i});s("./node_modules/matrix-js-sdk/src/@types/membership.ts");let i=function(e){return e.Sas="m.sas.v1",e.ShowQrCode="m.qr_code.show.v1",e.ScanQrCode="m.qr_code.scan.v1",e.Reciprocate="m.reciprocate.v1",e}({})},"./node_modules/matrix-js-sdk/src/utils.ts":(e,t,s)=>{"use strict";s.d(t,{$9:()=>V,A4:()=>S,Ab:()=>g,Bi:()=>W,C6:()=>te,CC:()=>N,Et:()=>w,Fq:()=>z,Gp:()=>I,HF:()=>Z,Mf:()=>K,NQ:()=>M,Nt:()=>T,Nz:()=>f,O5:()=>se,RR:()=>v,S8:()=>k,UB:()=>y,YY:()=>ee,aw:()=>H,d7:()=>_,d8:()=>U,dn:()=>C,hX:()=>D,hc:()=>A,hl:()=>E,hm:()=>p,iH:()=>x,iK:()=>L,j0:()=>j,kG:()=>ie,kg:()=>Y,ky:()=>b,ll:()=>Q,sy:()=>q,v6:()=>P,yD:()=>m,yy:()=>O,zR:()=>G});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/unhomoglyph/index.js"),r=s.n(n),o=s("./node_modules/p-retry/index.js"),a=s.n(o),d=s("./node_modules/matrix-js-sdk/src/@types/location.ts"),c=s("./node_modules/matrix-js-sdk/src/@types/read_receipts.ts");function l(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function u(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?l(Object(s),!0).forEach((function(t){(0,i.A)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):l(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const h=new Map;function m(e){return e instanceof String&&(e=e.toString()),h.has(e)||h.set(e,e),h.get(e)}function p(e,t){const s=null!=t?t:new URLSearchParams;for(const[t,i]of Object.entries(e))null!=i&&(Array.isArray(i)?i.forEach((e=>{s.append(t,String(e))})):s.append(t,String(i)));return s}function g(e,t,s){const i=u(u({},s),{},{[t]:s[e]});return delete i[e],i}function v(e,t){for(const s in t){if(!t.hasOwnProperty(s))continue;const i=t[s];null!=i&&(e=e.replace(s,encodeURIComponent(i)))}return e}function f(e,t,s){let i;if(s){for(i=e.length-1;i>=0;i--)if(t(e[i],i,e))return e.splice(i,1),!0}else for(i=0;i<e.length;i++)if(t(e[i],i,e))return e.splice(i,1),!0;return!1}function y(e,t){for(const s of t)if(!e.hasOwnProperty(s))throw new Error("Missing required key: "+s)}function S(e){return JSON.parse(JSON.stringify(e))}function b(e,t){if(e===t)return!0;if(typeof e!=typeof t)return!1;if("number"==typeof e&&isNaN(e)&&isNaN(t))return!0;if(null===e||null===t)return e===t;if(!(e instanceof Object))return!1;if(e.constructor!==t.constructor||e.prototype!==t.prototype)return!1;if(e instanceof RegExp||e instanceof Date)return e.toString()===t.toString();if(Array.isArray(e)){if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(!b(e[s],t[s]))return!1}else{for(const s in t)if(t.hasOwnProperty(s)!==e.hasOwnProperty(s))return!1;for(const s in e)if(t.hasOwnProperty(s)!==e.hasOwnProperty(s)||!b(e[s],t[s]))return!1}return!0}function E(e){if("object"!=typeof e)return e;if(null==e||Array.isArray(e))return e;const t=[];for(const[s,i]of Object.entries(e))t.push([s,E(i)]);return t.sort(((e,t)=>H(e[0],t[0]))),t}function w(e){return"number"==typeof e&&isFinite(e)}function I(e){return"string"==typeof e?r()(e.normalize("NFD").replace(R,"")):""}function _(e){return"string"==typeof e?e.replace(/[\u202d-\u202e]/g,""):""}function k(e){return I(e.toLowerCase()).replace(/[\\'!"#$%&()*+,\-./:;<=>?@[\]^_`{|}~\u2000-\u206f\u2e00-\u2e7f]/g,"").toLowerCase()}const R=/[\u2000-\u200F\u202A-\u202F\u0300-\u036F\uFEFF\u061C\u2800\u2062-\u2063\s]/g;function T(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function C(e){return T(e).replace(/\\\*/g,".*").replace(/\?/g,".")}function A(e){return null!=e&&e.endsWith("/")?e.slice(0,-1):e}function O(e,t){return new Promise((s=>{setTimeout(s,e,t)}))}async function M(e,t,s){const i=Date.now();try{return await s()}finally{const s=Date.now();e.debug(`[Perf]: ${t} took ${s-i}ms`)}}function x(){return new Promise((e=>setTimeout(e)))}function D(e){return null==e}function P(){let e,t;const s=new Promise(((s,i)=>{e=s,t=i}));return{resolve:e,reject:t,promise:s}}async function U(e,t){for(const s of e)await t(await s)}function j(e){return Promise.resolve(e())}async function L(e,t){const s=[];for(let i=0;i<e.length;i+=t)s.push(...await Promise.all(e.slice(i,i+t).map((e=>e()))));return s}function N(e){return a()((t=>e(t)),{forever:!0,factor:2,minTimeout:3e3,maxTimeout:15e3})}const K=(()=>{let e="";for(let t=32;t<=126;t++)e+=String.fromCharCode(t);return e})();function B(e,t,s=K){return e.padEnd(t,s[0])}function F(e,t=K){const s=BigInt(t.length);var i;if(e<=s)return null!==(i=t[Number(e)-1])&&void 0!==i?i:"";let n=e/s,r=Number(e%s)-1;return r<0&&(n-=BigInt(Math.abs(r)),r=Number(s)-1),F(n,t)+t[r]}function $(e,t=K){const s=BigInt(t.length);let i=BigInt(0);for(let n=e.length-1,r=BigInt(0);n>=0;n--,r++){const o=e.charCodeAt(n)-t.charCodeAt(0);i+=BigInt(1+o)*s**r}return i}function q(e,t,s=K){const i=Math.max(e.length,t.length),n=$(B(e,i,s),s),r=$(B(t,i,s),s),o=(n+r)/BigInt(2);return o===n||o==r?F(o,s)+s[0]:F(o,s)}function V(e,t=K){return F($(e,t)+BigInt(1),t)}function G(e,t=K){return F($(e,t)-BigInt(1),t)}function H(e,t){return e<t?-1:e>t?1:0}function W(e,t,s=!1){for(const[i,n]of Object.entries(t))e[i]instanceof Object&&n?W(e[i],n):null==n&&s||te(e,i,n);return e}function J(e){var t;return null!==(t=d.vo.findIn(e.getContent()))&&void 0!==t?t:-1}function z(e,t){return J(t)-J(e)}function Q(e){return[c.L.Read,c.L.ReadPrivate].includes(e)}function Y(e,t,s=(e,t)=>e===t){if(e.size!==t.size)return!1;for(const[i,n]of e){const e=t.get(i);if(void 0===e||!s(n,e))return!1}return!0}function X(e){return e instanceof Map?Z(e):Array.isArray(e)?e.map((e=>X(e))):e}function Z(e){const t=new Map;for(const[s,i]of e)t.set(s,X(i));return Object.fromEntries(t.entries())}function ee(e){return"__proto__"===e||"prototype"===e||"constructor"===e}function te(e,t,s){if(ee(t))throw new Error("Trying to modify prototype or constructor");e[t]=s}function se(e){return!(ee(e.room_id)||ee(e.sender)||ee(e.event_id))}class ie extends Map{constructor(e){super(),this.createDefault=e}getOrCreate(e){return this.has(e)||this.set(e,this.createDefault()),this.get(e)}}},"./node_modules/matrix-js-sdk/src/utils/decryptAESSecretStorageItem.ts":(e,t,s)=>{"use strict";s.d(t,{A:()=>r});var i=s("./node_modules/matrix-js-sdk/src/base64.ts"),n=s("./node_modules/matrix-js-sdk/src/utils/internal/deriveKeys.ts");async function r(e,t,s){const[r,o]=await(0,n.C)(t,s),a=(0,i.y4)(e.ciphertext);if(!await globalThis.crypto.subtle.verify({name:"HMAC"},o,(0,i.y4)(e.mac),a))throw new Error(`Error decrypting secret ${s}: bad MAC`);const d=await globalThis.crypto.subtle.decrypt({name:"AES-CTR",counter:(0,i.y4)(e.iv),length:64},r,a);return(new TextDecoder).decode(new Uint8Array(d))}},"./node_modules/matrix-js-sdk/src/utils/encryptAESSecretStorageItem.ts":(e,t,s)=>{"use strict";s.d(t,{A:()=>r});var i=s("./node_modules/matrix-js-sdk/src/base64.ts"),n=s("./node_modules/matrix-js-sdk/src/utils/internal/deriveKeys.ts");async function r(e,t,s,r){let o;r?o=(0,i.y4)(r):(o=new Uint8Array(16),globalThis.crypto.getRandomValues(o),o[8]&=127);const[a,d]=await(0,n.C)(t,s),c=(new TextEncoder).encode(e),l=await globalThis.crypto.subtle.encrypt({name:"AES-CTR",counter:o,length:64},a,c),u=await globalThis.crypto.subtle.sign({name:"HMAC"},d,l);return{iv:(0,i.WG)(o),ciphertext:(0,i.WG)(l),mac:(0,i.WG)(u)}}},"./node_modules/matrix-js-sdk/src/utils/internal/deriveKeys.ts":(e,t,s)=>{"use strict";s.d(t,{C:()=>n});const i=new Uint8Array(8);async function n(e,t){const s=await globalThis.crypto.subtle.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),n=await globalThis.crypto.subtle.deriveBits({name:"HKDF",salt:i,info:(new TextEncoder).encode(t),hash:"SHA-256"},s,512),r=n.slice(0,32),o=n.slice(32),a=globalThis.crypto.subtle.importKey("raw",r,{name:"AES-CTR"},!1,["encrypt","decrypt"]),d=globalThis.crypto.subtle.importKey("raw",o,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return Promise.all([a,d])}},"./node_modules/matrix-js-sdk/src/version-support.ts":(e,t,s)=>{"use strict";s.d(t,{Hr:()=>i});const i=["v1.1","v1.2","v1.3","v1.4","v1.5","v1.6","v1.7","v1.8","v1.9"];i[0],i[i.length-1]},"./node_modules/matrix-js-sdk/src/webrtc/call.ts":(e,t,s)=>{"use strict";s.d(t,{$E:()=>w,Il:()=>I,QO:()=>b,RA:()=>k,WE:()=>R,iP:()=>y,ms:()=>O,sj:()=>M,sv:()=>x});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/uuid/dist/esm-browser/v4.js"),r=s("./node_modules/sdp-transform/lib/index.js"),o=s("./node_modules/matrix-js-sdk/src/logger.ts"),a=s("./node_modules/matrix-js-sdk/src/utils.ts"),d=s("./node_modules/matrix-js-sdk/src/@types/event.ts"),c=s("./node_modules/matrix-js-sdk/src/randomstring.ts"),l=s("./node_modules/matrix-js-sdk/src/webrtc/callEventTypes.ts"),u=s("./node_modules/matrix-js-sdk/src/webrtc/callFeed.ts"),h=s("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),m=s("./node_modules/matrix-js-sdk/src/crypto/deviceinfo.ts"),p=s("./node_modules/matrix-js-sdk/src/webrtc/groupCall.ts"),g=s("./node_modules/matrix-js-sdk/src/http-api/index.ts");function v(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function f(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?v(Object(s),!0).forEach((function(t){(0,i.A)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):v(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let y=function(e){return e.Fledgling="fledgling",e.InviteSent="invite_sent",e.WaitLocalMedia="wait_local_media",e.CreateOffer="create_offer",e.CreateAnswer="create_answer",e.Connecting="connecting",e.Connected="connected",e.Ringing="ringing",e.Ended="ended",e}({}),S=function(e){return e.Voice="voice",e.Video="video",e}({}),b=function(e){return e.Inbound="inbound",e.Outbound="outbound",e}({}),E=function(e){return e.Local="local",e.Remote="remote",e}({}),w=function(e){return e.Hangup="hangup",e.State="state",e.Error="error",e.Replaced="replaced",e.LocalHoldUnhold="local_hold_unhold",e.RemoteHoldUnhold="remote_hold_unhold",e.HoldUnhold="hold_unhold",e.FeedsChanged="feeds_changed",e.AssertedIdentityChanged="asserted_identity_changed",e.LengthChanged="length_changed",e.DataChannel="datachannel",e.SendVoipEvent="send_voip_event",e.PeerConnectionCreated="peer_connection_created",e}({}),I=function(e){return e.UserHangup="user_hangup",e.LocalOfferFailed="local_offer_failed",e.NoUserMedia="no_user_media",e.UnknownDevices="unknown_devices",e.SendInvite="send_invite",e.CreateAnswer="create_answer",e.CreateOffer="create_offer",e.SendAnswer="send_answer",e.SetRemoteDescription="set_remote_description",e.SetLocalDescription="set_local_description",e.AnsweredElsewhere="answered_elsewhere",e.IceFailed="ice_failed",e.InviteTimeout="invite_timeout",e.Replaced="replaced",e.SignallingFailed="signalling_timeout",e.UserBusy="user_busy",e.Transferred="transferred",e.NewSession="new_session",e}({});const _=6e4;class k extends Error{constructor(e,t,s){super(t+": "+s),(0,i.A)(this,"code",void 0),this.code=e}}function R(){return Date.now().toString()+(0,c.DU)(16)}function T(e){return[{mediaType:"audio",codec:"opus",enableDtx:!0,maxAverageBitrate:e?12e3:void 0}]}function C(e,t){return e+":"+t}class A extends h.X{constructor(e){var t;if(super(),(0,i.A)(this,"roomId",void 0),(0,i.A)(this,"callId",void 0),(0,i.A)(this,"invitee",void 0),(0,i.A)(this,"hangupParty",void 0),(0,i.A)(this,"hangupReason",void 0),(0,i.A)(this,"direction",void 0),(0,i.A)(this,"ourPartyId",void 0),(0,i.A)(this,"peerConn",void 0),(0,i.A)(this,"toDeviceSeq",0),(0,i.A)(this,"isPtt",!1),(0,i.A)(this,"_state",y.Fledgling),(0,i.A)(this,"client",void 0),(0,i.A)(this,"forceTURN",void 0),(0,i.A)(this,"turnServers",void 0),(0,i.A)(this,"candidateSendQueue",[]),(0,i.A)(this,"candidateSendTries",0),(0,i.A)(this,"candidatesEnded",!1),(0,i.A)(this,"feeds",[]),(0,i.A)(this,"transceivers",new Map),(0,i.A)(this,"inviteOrAnswerSent",!1),(0,i.A)(this,"waitForLocalAVStream",!1),(0,i.A)(this,"successor",void 0),(0,i.A)(this,"opponentMember",void 0),(0,i.A)(this,"opponentVersion",void 0),(0,i.A)(this,"opponentPartyId",void 0),(0,i.A)(this,"opponentCaps",void 0),(0,i.A)(this,"iceDisconnectedTimeout",void 0),(0,i.A)(this,"iceReconnectionTimeOut",void 0),(0,i.A)(this,"inviteTimeout",void 0),(0,i.A)(this,"removeTrackListeners",new Map),(0,i.A)(this,"remoteOnHold",!1),(0,i.A)(this,"callStatsAtEnd",void 0),(0,i.A)(this,"makingOffer",!1),(0,i.A)(this,"ignoreOffer",!1),(0,i.A)(this,"isSettingRemoteAnswerPending",!1),(0,i.A)(this,"responsePromiseChain",void 0),(0,i.A)(this,"remoteCandidateBuffer",new Map),(0,i.A)(this,"remoteAssertedIdentity",void 0),(0,i.A)(this,"remoteSDPStreamMetadata",void 0),(0,i.A)(this,"callLengthInterval",void 0),(0,i.A)(this,"callStartTime",void 0),(0,i.A)(this,"opponentDeviceId",void 0),(0,i.A)(this,"opponentDeviceInfo",void 0),(0,i.A)(this,"opponentSessionId",void 0),(0,i.A)(this,"groupCallId",void 0),(0,i.A)(this,"stopVideoTrackTimer",void 0),(0,i.A)(this,"isOnlyDataChannelAllowed",void 0),(0,i.A)(this,"stats",void 0),(0,i.A)(this,"gotLocalIceCandidate",(e=>{if(e.candidate){if(this.candidatesEnded&&o.v.warn(`Call ${this.callId} gotLocalIceCandidate() got candidate after candidates have ended!`),o.v.debug(`Call ${this.callId} got local ICE ${e.candidate.sdpMid} ${e.candidate.candidate}`),this.callHasEnded())return;""===e.candidate.candidate?this.queueCandidate(null):this.queueCandidate(e.candidate)}})),(0,i.A)(this,"onIceGatheringStateChange",(e=>{var t;o.v.debug(`Call ${this.callId} onIceGatheringStateChange() ice gathering state changed to ${this.peerConn.iceGatheringState}`),"complete"===(null===(t=this.peerConn)||void 0===t?void 0:t.iceGatheringState)&&(this.queueCandidate(null),o.v.debug(`Call ${this.callId} onIceGatheringStateChange() ice gathering state complete, set candidates have ended`))})),(0,i.A)(this,"getLocalOfferFailed",(e=>{o.v.error(`Call ${this.callId} getLocalOfferFailed() running`,e),this.emit(w.Error,new k(I.LocalOfferFailed,"Failed to get local offer!",e),this),this.terminate(E.Local,I.LocalOfferFailed,!1)})),(0,i.A)(this,"getUserMediaFailed",(e=>{this.successor?this.successor.getUserMediaFailed(e):(o.v.warn(`Call ${this.callId} getUserMediaFailed() failed to get user media - ending call`,e),this.emit(w.Error,new k(I.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",e),this),this.terminate(E.Local,I.NoUserMedia,!1))})),(0,i.A)(this,"placeCallFailed",(e=>{this.successor?this.successor.placeCallFailed(e):(o.v.warn(`Call ${this.callId} placeCallWithCallFeeds() failed - ending call`,e),this.emit(w.Error,new k(I.IceFailed,"Couldn't start call! Invalid ICE server configuration.",e),this),this.terminate(E.Local,I.IceFailed,!1))})),(0,i.A)(this,"onIceConnectionStateChanged",(()=>{var e,t,s,i,n,r;if(!this.callHasEnded()){if(o.v.debug(`Call ${this.callId} onIceConnectionStateChanged() running (state=${null===(e=this.peerConn)||void 0===e?void 0:e.iceConnectionState}, conn=${null===(t=this.peerConn)||void 0===t?void 0:t.connectionState})`),["connected","completed"].includes(null!==(s=null===(i=this.peerConn)||void 0===i?void 0:i.iceConnectionState)&&void 0!==s?s:""))clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0,this.iceReconnectionTimeOut&&clearTimeout(this.iceReconnectionTimeOut),this.state=y.Connected,this.callLengthInterval||this.callStartTime||(this.callStartTime=Date.now(),this.callLengthInterval=setInterval((()=>{this.emit(w.LengthChanged,Math.round((Date.now()-this.callStartTime)/1e3),this)}),1e3));else if("failed"==(null===(n=this.peerConn)||void 0===n?void 0:n.iceConnectionState)){var a,d;if(this.candidatesEnded=!1,null!==(a=this.peerConn)&&void 0!==a&&a.restartIce)this.candidatesEnded=!1,o.v.debug(`Call ${this.callId} onIceConnectionStateChanged() ice restart (state=${null===(d=this.peerConn)||void 0===d?void 0:d.iceConnectionState})`),this.peerConn.restartIce();else o.v.info(`Call ${this.callId} onIceConnectionStateChanged() hanging up call (ICE failed and no ICE restart method)`),this.hangup(I.IceFailed,!1)}else"disconnected"==(null===(r=this.peerConn)||void 0===r?void 0:r.iceConnectionState)&&(this.candidatesEnded=!1,this.iceReconnectionTimeOut=setTimeout((()=>{var e,t,s;o.v.info(`Call ${this.callId} onIceConnectionStateChanged() ICE restarting because of ICE disconnected, (state=${null===(e=this.peerConn)||void 0===e?void 0:e.iceConnectionState}, conn=${null===(t=this.peerConn)||void 0===t?void 0:t.connectionState})`),null!==(s=this.peerConn)&&void 0!==s&&s.restartIce&&(this.candidatesEnded=!1,this.peerConn.restartIce()),this.iceReconnectionTimeOut=void 0}),2e3),this.iceDisconnectedTimeout=setTimeout((()=>{o.v.info(`Call ${this.callId} onIceConnectionStateChanged() hanging up call (ICE disconnected for too long)`),this.hangup(I.IceFailed,!1)}),3e4),this.state=y.Connecting);if(this.isPtt&&["failed","disconnected"].includes(this.peerConn.iceConnectionState))for(const e of this.getRemoteFeeds())e.setAudioVideoMuted(!0,!0)}})),(0,i.A)(this,"onSignallingStateChanged",(()=>{var e;o.v.debug(`Call ${this.callId} onSignallingStateChanged() running (state=${null===(e=this.peerConn)||void 0===e?void 0:e.signalingState})`)})),(0,i.A)(this,"onTrack",(e=>{if(0===e.streams.length)return void o.v.warn(`Call ${this.callId} onTrack() called with streamless track streamless (kind=${e.track.kind})`);const t=e.streams[0];if(this.pushRemoteFeed(t),!this.removeTrackListeners.has(t)){const e=()=>{0===t.getTracks().length&&(o.v.info(`Call ${this.callId} onTrack() removing track (streamId=${t.id})`),this.deleteFeedByStream(t),t.removeEventListener("removetrack",e),this.removeTrackListeners.delete(t))};t.addEventListener("removetrack",e),this.removeTrackListeners.set(t,e)}})),(0,i.A)(this,"onDataChannel",(e=>{this.emit(w.DataChannel,e.channel,this)})),(0,i.A)(this,"onNegotiationNeeded",(async()=>{o.v.info(`Call ${this.callId} onNegotiationNeeded() negotiation is needed!`),this.state===y.CreateOffer||0!==this.opponentVersion?this.queueGotLocalOffer():o.v.info(`Call ${this.callId} onNegotiationNeeded() opponent does not support renegotiation: ignoring negotiationneeded event`)})),(0,i.A)(this,"onHangupReceived",(e=>{o.v.debug(`Call ${this.callId} onHangupReceived() running`),this.partyIdMatches(e)||this.state===y.Ringing?this.terminate(E.Remote,e.reason||I.UserHangup,!0):o.v.info(`Call ${this.callId} onHangupReceived() ignoring message from party ID ${e.party_id}: our partner is ${this.opponentPartyId}`)})),(0,i.A)(this,"onRejectReceived",(e=>{o.v.debug(`Call ${this.callId} onRejectReceived() running`);[y.InviteSent,y.Ringing].includes(this.state)||this.state===y.Fledgling&&this.direction===b.Inbound?this.terminate(E.Remote,e.reason||I.UserHangup,!0):o.v.debug(`Call ${this.callId} onRejectReceived() called in wrong state (state=${this.state})`)})),(0,i.A)(this,"onAnsweredElsewhere",(e=>{o.v.debug(`Call ${this.callId} onAnsweredElsewhere() running`),this.terminate(E.Remote,I.AnsweredElsewhere,!0)})),this.roomId=e.roomId,this.invitee=e.invitee,this.client=e.client,!this.client.deviceId)throw new Error("Client must have a device ID to start calls");this.forceTURN=null!==(t=e.forceTURN)&&void 0!==t&&t,this.ourPartyId=this.client.deviceId,this.opponentDeviceId=e.opponentDeviceId,this.opponentSessionId=e.opponentSessionId,this.groupCallId=e.groupCallId,this.turnServers=e.turnServers||[],0===this.turnServers.length&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:["stun:turn.matrix.org"]});for(const e of this.turnServers)(0,a.UB)(e,["urls"]);this.callId=R(),this.isOnlyDataChannelAllowed=this.client.isVoipWithNoMediaAllowed}async placeVoiceCall(){await this.placeCall(!0,!1)}async placeVideoCall(){await this.placeCall(!0,!0)}createDataChannel(e,t){const s=this.peerConn.createDataChannel(e,t);return this.emit(w.DataChannel,s,this),s}getOpponentMember(){return this.opponentMember}getOpponentDeviceId(){return this.opponentDeviceId}getOpponentSessionId(){return this.opponentSessionId}opponentCanBeTransferred(){return Boolean(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}opponentSupportsDTMF(){return Boolean(this.opponentCaps&&this.opponentCaps["m.call.dtmf"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(w.State,e,t,this)}get type(){return this.hasUserMediaVideoSender||this.hasRemoteUserMediaVideoTrack?S.Video:S.Voice}get hasLocalUserMediaVideoTrack(){var e;return!(null===(e=this.localUsermediaStream)||void 0===e||!e.getVideoTracks().length)}get hasRemoteUserMediaVideoTrack(){return this.getRemoteFeeds().some((e=>{var t;return e.purpose===l.h.Usermedia&&(null===(t=e.stream)||void 0===t?void 0:t.getVideoTracks().length)}))}get hasLocalUserMediaAudioTrack(){var e;return!(null===(e=this.localUsermediaStream)||void 0===e||!e.getAudioTracks().length)}get hasRemoteUserMediaAudioTrack(){return this.getRemoteFeeds().some((e=>{var t;return e.purpose===l.h.Usermedia&&!(null===(t=e.stream)||void 0===t||!t.getAudioTracks().length)}))}get hasUserMediaAudioSender(){var e;return Boolean(null===(e=this.transceivers.get(C(l.h.Usermedia,"audio")))||void 0===e?void 0:e.sender)}get hasUserMediaVideoSender(){var e;return Boolean(null===(e=this.transceivers.get(C(l.h.Usermedia,"video")))||void 0===e?void 0:e.sender)}get localUsermediaFeed(){return this.getLocalFeeds().find((e=>e.purpose===l.h.Usermedia))}get localScreensharingFeed(){return this.getLocalFeeds().find((e=>e.purpose===l.h.Screenshare))}get localUsermediaStream(){var e;return null===(e=this.localUsermediaFeed)||void 0===e?void 0:e.stream}get localScreensharingStream(){var e;return null===(e=this.localScreensharingFeed)||void 0===e?void 0:e.stream}get remoteUsermediaFeed(){return this.getRemoteFeeds().find((e=>e.purpose===l.h.Usermedia))}get remoteScreensharingFeed(){return this.getRemoteFeeds().find((e=>e.purpose===l.h.Screenshare))}get remoteUsermediaStream(){var e;return null===(e=this.remoteUsermediaFeed)||void 0===e?void 0:e.stream}get remoteScreensharingStream(){var e;return null===(e=this.remoteScreensharingFeed)||void 0===e?void 0:e.stream}getFeedByStreamId(e){return this.getFeeds().find((t=>t.stream.id===e))}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter((e=>e.isLocal()))}getRemoteFeeds(){return this.feeds.filter((e=>!e.isLocal()))}async initOpponentCrypto(){var e,t;if(!this.opponentDeviceId)return;if(!this.client.getUseE2eForGroupCall())return;if(!this.client.isCryptoEnabled())return void(this.opponentDeviceInfo=new m.V(this.opponentDeviceId));if(!this.client.crypto)throw new Error("Crypto is not initialised.");const s=this.invitee||(null===(e=this.getOpponentMember())||void 0===e?void 0:e.userId);if(!s)throw new Error("Couldn't find opponent user ID to init crypto");const i=await this.client.crypto.deviceList.downloadKeys([s],!1);if(this.opponentDeviceInfo=null===(t=i.get(s))||void 0===t?void 0:t.get(this.opponentDeviceId),void 0===this.opponentDeviceInfo)throw new p.Iy(s)}getLocalSDPStreamMetadata(e=!1){const t={};for(const s of this.getLocalFeeds())e&&(s.sdpMetadataStreamId=s.stream.id),t[s.sdpMetadataStreamId]={purpose:s.purpose,audio_muted:s.isAudioMuted(),video_muted:s.isVideoMuted()};return t}noIncomingFeeds(){return!this.feeds.some((e=>!e.isLocal()))}pushRemoteFeed(e){if(!this.opponentSupportsSDPStreamMetadata())return void this.pushRemoteFeedWithoutMetadata(e);const t=this.getOpponentMember().userId,s=this.remoteSDPStreamMetadata[e.id].purpose,i=this.remoteSDPStreamMetadata[e.id].audio_muted,n=this.remoteSDPStreamMetadata[e.id].video_muted;s?this.getFeedByStreamId(e.id)?o.v.warn(`Call ${this.callId} pushRemoteFeed() ignoring stream because we already have a feed for it (streamId=${e.id})`):(this.feeds.push(new u.Hh({client:this.client,call:this,roomId:this.roomId,userId:t,deviceId:this.getOpponentDeviceId(),stream:e,purpose:s,audioMuted:i,videoMuted:n})),this.emit(w.FeedsChanged,this.feeds,this),o.v.info(`Call ${this.callId} pushRemoteFeed() pushed stream (streamId=${e.id}, active=${e.active}, purpose=${s})`)):o.v.warn(`Call ${this.callId} pushRemoteFeed() ignoring stream because we didn't get any metadata about it (streamId=${e.id})`)}pushRemoteFeedWithoutMetadata(e){var t;const s=this.getOpponentMember().userId,i=l.h.Usermedia,n=null===(t=this.feeds.find((e=>!e.isLocal())))||void 0===t?void 0:t.stream;n&&e.id!==n.id?o.v.warn(`Call ${this.callId} pushRemoteFeedWithoutMetadata() ignoring new stream because we already have stream (streamId=${e.id})`):this.getFeedByStreamId(e.id)?o.v.warn(`Call ${this.callId} pushRemoteFeedWithoutMetadata() ignoring stream because we already have a feed for it (streamId=${e.id})`):(this.feeds.push(new u.Hh({client:this.client,call:this,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:s,deviceId:this.getOpponentDeviceId(),stream:e,purpose:i})),this.emit(w.FeedsChanged,this.feeds,this),o.v.info(`Call ${this.callId} pushRemoteFeedWithoutMetadata() pushed stream (streamId=${e.id}, active=${e.active})`))}pushNewLocalFeed(e,t,s=!0){const i=this.client.getUserId();O(e.getAudioTracks(),!0),O(e.getVideoTracks(),!0),this.getFeedByStreamId(e.id)?o.v.warn(`Call ${this.callId} pushNewLocalFeed() ignoring stream because we already have a feed for it (streamId=${e.id})`):this.pushLocalFeed(new u.Hh({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:i,deviceId:this.getOpponentDeviceId(),stream:e,purpose:t}),s)}pushLocalFeed(e,t=!0){if(this.feeds.some((t=>e.stream.id===t.stream.id)))o.v.info(`Call ${this.callId} pushLocalFeed() ignoring duplicate local stream (streamId=${e.stream.id})`);else{if(this.feeds.push(e),t)for(const t of e.stream.getTracks()){o.v.info(`Call ${this.callId} pushLocalFeed() adding track to peer connection (id=${t.id}, kind=${t.kind}, streamId=${e.stream.id}, streamPurpose=${e.purpose}, enabled=${t.enabled})`);const s=C(e.purpose,t.kind);if(this.transceivers.has(s)){const e=this.transceivers.get(s);e.sender.replaceTrack(t),e.direction="inactive"===e.direction?"sendonly":"sendrecv"}else{const i=this.peerConn.addTrack(t,e.stream),n=this.peerConn.getTransceivers().find((e=>e.sender===i));n?this.transceivers.set(s,n):o.v.warn(`Call ${this.callId} pushLocalFeed() didn't find a matching transceiver after adding track!`)}}o.v.info(`Call ${this.callId} pushLocalFeed() pushed stream (id=${e.stream.id}, active=${e.stream.active}, purpose=${e.purpose})`),this.emit(w.FeedsChanged,this.feeds,this)}}removeLocalFeed(e){const t=C(e.purpose,"audio"),s=C(e.purpose,"video");for(const e of[t,s])if(this.transceivers.has(e)){const t=this.transceivers.get(e);t.sender&&this.peerConn.removeTrack(t.sender)}e.purpose===l.h.Screenshare&&this.client.getMediaHandler().stopScreensharingStream(e.stream),this.deleteFeed(e)}deleteAllFeeds(){for(const e of this.feeds)e.isLocal()&&this.groupCallId||e.dispose();this.feeds=[],this.emit(w.FeedsChanged,this.feeds,this)}deleteFeedByStream(e){const t=this.getFeedByStreamId(e.id);t?this.deleteFeed(t):o.v.warn(`Call ${this.callId} deleteFeedByStream() didn't find the feed to delete (streamId=${e.id})`)}deleteFeed(e){e.dispose(),this.feeds.splice(this.feeds.indexOf(e),1),this.emit(w.FeedsChanged,this.feeds,this)}async getCurrentCallStats(){return this.callHasEnded()?this.callStatsAtEnd:this.collectCallStats()}async collectCallStats(){if(!this.peerConn)return;const e=await this.peerConn.getStats(),t=[];return e.forEach((e=>{t.push(e)})),t}async initWithInvite(e){var t;const s=e.getContent();this.direction=b.Inbound;await this.client.checkTurnServers()||o.v.warn(`Call ${this.callId} initWithInvite() failed to get TURN credentials! Proceeding with call anyway...`);const i=s[l.A];i?this.updateRemoteSDPStreamMetadata(i):o.v.debug(`Call ${this.callId} initWithInvite() did not get any SDPStreamMetadata! Can not send/receive multiple streams`),this.peerConn=this.createPeerConnection(),this.emit(w.PeerConnectionCreated,this.peerConn,this),this.chooseOpponent(e),await this.initOpponentCrypto();try{await this.peerConn.setRemoteDescription(s.offer),o.v.debug(`Call ${this.callId} initWithInvite() set remote description: ${s.offer.type}`),await this.addBufferedIceCandidates()}catch(e){return o.v.debug(`Call ${this.callId} initWithInvite() failed to set remote description`,e),void this.terminate(E.Local,I.SetRemoteDescription,!1)}const n=null===(t=this.feeds.find((e=>!e.isLocal())))||void 0===t?void 0:t.stream;if(!(this.isOnlyDataChannelAllowed||n&&0!==n.getTracks().length))return o.v.error(`Call ${this.callId} initWithInvite() no remote stream or no tracks after setting remote description!`),void this.terminate(E.Local,I.SetRemoteDescription,!1);if(this.state=y.Ringing,e.getLocalAge()){const t=setTimeout((()=>{var e;this.state==y.Ringing&&(o.v.debug(`Call ${this.callId} initWithInvite() invite has expired. Hanging up.`),this.hangupParty=E.Remote,this.state=y.Ended,this.stopAllMedia(),"closed"!=this.peerConn.signalingState&&this.peerConn.close(),null===(e=this.stats)||void 0===e||e.removeStatsReportGatherer(this.callId),this.emit(w.Hangup,this))}),s.lifetime-e.getLocalAge()),i=e=>{e!==y.Ringing&&(clearTimeout(t),this.off(w.State,i))};this.on(w.State,i)}}initWithHangup(e){this.state=y.Ended}shouldAnswerWithMediaType(e,t,s){return e&&!t?(o.v.warn(`Call ${this.callId} shouldAnswerWithMediaType() unable to answer with ${s} because the other side isn't sending it either.`),!1):(0,a.hX)(e)||e===t||this.opponentSupportsSDPStreamMetadata()?null!=e?e:t:(o.v.warn(`Call ${this.callId} shouldAnswerWithMediaType() unable to answer with ${s}=${e} because the other side doesn't support it. Answering with ${s}=${t}.`),t)}async answer(e,t){if(!this.inviteOrAnswerSent){if(!1===e&&!1===t)throw new Error("You CANNOT answer a call without media");if(this.localUsermediaStream||this.waitForLocalAVStream)this.waitForLocalAVStream&&(this.state=y.WaitLocalMedia);else{const i=this.state,n=this.shouldAnswerWithMediaType(e,this.hasRemoteUserMediaAudioTrack,"audio"),r=this.shouldAnswerWithMediaType(t,this.hasRemoteUserMediaVideoTrack,"video");this.state=y.WaitLocalMedia,this.waitForLocalAVStream=!0;try{var s;const e=await this.client.getMediaHandler().getUserMediaStream(n,r);this.waitForLocalAVStream=!1;const t=[new u.Hh({client:this.client,roomId:this.roomId,userId:this.client.getUserId(),deviceId:null!==(s=this.client.getDeviceId())&&void 0!==s?s:void 0,stream:e,purpose:l.h.Usermedia,audioMuted:!1,videoMuted:!1})];this.localScreensharingFeed&&t.push(this.localScreensharingFeed),this.answerWithCallFeeds(t)}catch(e){if(!r)return void this.getUserMediaFailed(e);o.v.warn(`Call ${this.callId} answer() failed to getUserMedia(), trying to getUserMedia() without video`),this.state=i,this.waitForLocalAVStream=!1,await this.answer(n,!1)}}}}answerWithCallFeeds(e){this.inviteOrAnswerSent||this.queueGotCallFeedsForAnswer(e)}replacedBy(e){o.v.debug(`Call ${this.callId} replacedBy() running (newCallId=${e.callId})`),this.state===y.WaitLocalMedia?(o.v.debug(`Call ${this.callId} replacedBy() telling new call to wait for local media (newCallId=${e.callId})`),e.waitForLocalAVStream=!0):[y.CreateOffer,y.InviteSent].includes(this.state)&&(e.direction===b.Outbound?e.queueGotCallFeedsForAnswer([]):(o.v.debug(`Call ${this.callId} replacedBy() handing local stream to new call(newCallId=${e.callId})`),e.queueGotCallFeedsForAnswer(this.getLocalFeeds().map((e=>e.clone()))))),this.successor=e,this.emit(w.Replaced,e,this),this.hangup(I.Replaced,!0)}hangup(e,t){if(this.callHasEnded())return;if(o.v.debug(`Call ${this.callId} hangup() ending call (reason=${e})`),this.terminate(E.Local,e,!t),[y.Fledgling,y.WaitLocalMedia].includes(this.state))return;const s={};(this.opponentVersion&&0!==this.opponentVersion||e!==I.UserHangup)&&(s.reason=e),this.sendVoipEvent(d.Bx.CallHangup,s)}reject(){if(this.state!==y.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(0===this.opponentVersion)return o.v.info(`Call ${this.callId} reject() opponent version is less than 1: sending hangup instead of reject (opponentVersion=${this.opponentVersion})`),void this.hangup(I.UserHangup,!0);o.v.debug("Rejecting call: "+this.callId),this.terminate(E.Local,I.UserHangup,!0),this.sendVoipEvent(d.Bx.CallReject,{})}async upgradeCall(e,t){if((e||t)&&this.opponentSupportsSDPStreamMetadata())try{o.v.debug(`Call ${this.callId} upgradeCall() upgrading call (audio=${e}, video=${t})`);const s=e||this.hasLocalUserMediaAudioTrack,i=t||this.hasLocalUserMediaVideoTrack,n=await this.client.getMediaHandler().getUserMediaStream(s,i,!1);await this.updateLocalUsermediaStream(n,e,t)}catch(e){o.v.error(`Call ${this.callId} upgradeCall() failed to upgrade the call`,e),this.emit(w.Error,new k(I.NoUserMedia,"Failed to get camera access: ",e),this)}}opponentSupportsSDPStreamMetadata(){return Boolean(this.remoteSDPStreamMetadata)}isScreensharing(){return Boolean(this.localScreensharingStream)}async setScreensharingEnabled(e,t){if(e&&this.isScreensharing())return o.v.warn(`Call ${this.callId} setScreensharingEnabled() there is already a screensharing stream - there is nothing to do!`),!0;if(!e&&!this.isScreensharing())return o.v.warn(`Call ${this.callId} setScreensharingEnabled() there already isn't a screensharing stream - there is nothing to do!`),!1;if(!this.opponentSupportsSDPStreamMetadata())return this.setScreensharingEnabledWithoutMetadataSupport(e,t);if(o.v.debug(`Call ${this.callId} setScreensharingEnabled() running (enabled=${e})`),!e){const e=this.transceivers.get(C(l.h.Screenshare,"audio")),t=this.transceivers.get(C(l.h.Screenshare,"video"));for(const s of[e,t])s&&s.sender&&this.peerConn.removeTrack(s.sender);return this.client.getMediaHandler().stopScreensharingStream(this.localScreensharingStream),this.deleteFeedByStream(this.localScreensharingStream),!1}try{const e=await this.client.getMediaHandler().getScreensharingStream(t);return!!e&&(this.pushNewLocalFeed(e,l.h.Screenshare),!0)}catch(e){return o.v.error(`Call ${this.callId} setScreensharingEnabled() failed to get screen-sharing stream:`,e),!1}}async setScreensharingEnabledWithoutMetadataSupport(e,t){if(o.v.debug(`Call ${this.callId} setScreensharingEnabledWithoutMetadataSupport() running (enabled=${e})`),!e){var s,i;const e=null===(s=this.localUsermediaStream)||void 0===s?void 0:s.getTracks().find((e=>"video"===e.kind)),t=null===(i=this.transceivers.get(C(l.h.Usermedia,"video")))||void 0===i?void 0:i.sender;return null==t||t.replaceTrack(null!=e?e:null),this.client.getMediaHandler().stopScreensharingStream(this.localScreensharingStream),this.deleteFeedByStream(this.localScreensharingStream),!1}try{var n;const e=await this.client.getMediaHandler().getScreensharingStream(t);if(!e)return!1;const s=e.getTracks().find((e=>"video"===e.kind)),i=null===(n=this.transceivers.get(C(l.h.Usermedia,"video")))||void 0===n?void 0:n.sender;return null==i||i.replaceTrack(null!=s?s:null),this.pushNewLocalFeed(e,l.h.Screenshare,!1),!0}catch(e){return o.v.error(`Call ${this.callId} setScreensharingEnabledWithoutMetadataSupport() failed to get screen-sharing stream:`,e),!1}}async updateLocalUsermediaStream(e,t=!1,s=!1){const i=this.localUsermediaFeed,n=t||!i.isAudioMuted()&&!this.remoteOnHold,r=s||!i.isVideoMuted()&&!this.remoteOnHold;o.v.log(`Call ${this.callId} updateLocalUsermediaStream() running (streamId=${e.id}, audio=${n}, video=${r})`),O(e.getAudioTracks(),n),O(e.getVideoTracks(),r);for(const e of this.localUsermediaStream.getTracks())this.localUsermediaStream.removeTrack(e),e.stop();for(const t of e.getTracks())this.localUsermediaStream.addTrack(t);for(const t of e.getTracks()){const s=C(l.h.Usermedia,t.kind),n=this.transceivers.get(s),r=null==n?void 0:n.sender;let a=!1;if(r)try{o.v.info(`Call ${this.callId} updateLocalUsermediaStream() replacing track (id=${t.id}, kind=${t.kind}, streamId=${e.id}, streamPurpose=${i.purpose})`),await r.replaceTrack(t),n.direction="inactive"===n.direction?"sendonly":"sendrecv",a=!0}catch(e){o.v.warn(`Call ${this.callId} updateLocalUsermediaStream() replaceTrack failed: adding new transceiver instead`,e)}if(!a){o.v.info(`Call ${this.callId} updateLocalUsermediaStream() adding track to peer connection (id=${t.id}, kind=${t.kind}, streamId=${e.id}, streamPurpose=${i.purpose})`);const n=this.peerConn.addTrack(t,this.localUsermediaStream),r=this.peerConn.getTransceivers().find((e=>e.sender===n));r?this.transceivers.set(s,r):o.v.warn(`Call ${this.callId} updateLocalUsermediaStream() couldn't find matching transceiver for newly added track!`)}}}async setLocalVideoMuted(e){var t,s;if(o.v.log(`Call ${this.callId} setLocalVideoMuted() running ${e}`),e||void 0===this.stopVideoTrackTimer||(clearTimeout(this.stopVideoTrackTimer),this.stopVideoTrackTimer=void 0),!await this.client.getMediaHandler().hasVideoDevice())return this.isLocalVideoMuted();if(!this.hasUserMediaVideoSender&&!e)return null===(s=this.localUsermediaFeed)||void 0===s||s.setAudioVideoMuted(null,e),await this.upgradeCall(!1,!0),this.isLocalVideoMuted();if(!e&&0===this.localUsermediaStream.getVideoTracks().length){const e=await this.client.getMediaHandler().getUserMediaStream(!0,!0);await this.updateLocalUsermediaStream(e)}return null===(t=this.localUsermediaFeed)||void 0===t||t.setAudioVideoMuted(null,e),this.updateMuteStatus(),await this.sendMetadataUpdate(),e&&(this.stopVideoTrackTimer=setTimeout((()=>{for(const e of this.localUsermediaStream.getVideoTracks())e.stop(),this.localUsermediaStream.removeTrack(e)}),120)),this.isLocalVideoMuted()}isLocalVideoMuted(){var e,t;return null!==(e=null===(t=this.localUsermediaFeed)||void 0===t?void 0:t.isVideoMuted())&&void 0!==e&&e}async setMicrophoneMuted(e){var t;return o.v.log(`Call ${this.callId} setMicrophoneMuted() running ${e}`),await this.client.getMediaHandler().hasAudioDevice()?e||this.hasUserMediaAudioSender&&this.hasLocalUserMediaAudioTrack?(null===(t=this.localUsermediaFeed)||void 0===t||t.setAudioVideoMuted(e,null),this.updateMuteStatus(),await this.sendMetadataUpdate(),this.isMicrophoneMuted()):(await this.upgradeCall(!0,!1),this.isMicrophoneMuted()):this.isMicrophoneMuted()}isMicrophoneMuted(){var e,t;return null!==(e=null===(t=this.localUsermediaFeed)||void 0===t?void 0:t.isAudioMuted())&&void 0!==e&&e}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(e){if(this.isRemoteOnHold()!==e){this.remoteOnHold=e;for(const t of this.peerConn.getTransceivers())t.direction=e?"sendonly":"sendrecv";this.updateMuteStatus(),this.sendMetadataUpdate(),this.emit(w.RemoteHoldUnhold,this.remoteOnHold,this)}}isLocalOnHold(){if(this.state!==y.Connected)return!1;let e=!0;for(const t of this.peerConn.getTransceivers()){["inactive","recvonly"].includes(t.currentDirection)||(e=!1)}return e}sendDtmfDigit(e){for(const s of this.peerConn.getSenders()){var t;if("audio"===(null===(t=s.track)||void 0===t?void 0:t.kind)&&s.dtmf)return void s.dtmf.insertDTMF(e)}throw new Error("Unable to find a track to send DTMF on")}updateMuteStatus(){const e=this.isMicrophoneMuted()||this.remoteOnHold,t=this.isLocalVideoMuted()||this.remoteOnHold;o.v.log(`Call ${this.callId} updateMuteStatus stream ${this.localUsermediaStream.id} micShouldBeMuted ${e} vidShouldBeMuted ${t}`),O(this.localUsermediaStream.getAudioTracks(),!e),O(this.localUsermediaStream.getVideoTracks(),!t)}async sendMetadataUpdate(){await this.sendVoipEvent(d.Bx.CallSDPStreamMetadataChangedPrefix,{[l.A]:this.getLocalSDPStreamMetadata()})}gotCallFeedsForInvite(e,t=!1){if(this.successor)this.successor.queueGotCallFeedsForAnswer(e);else if(this.callHasEnded())this.stopAllMedia();else{for(const t of e)this.pushLocalFeed(t);t&&this.peerConn.addTransceiver("video",{direction:"recvonly"}),this.state=y.CreateOffer,o.v.debug(`Call ${this.callId} gotUserMediaForInvite() run`)}}async sendAnswer(){const e={answer:{sdp:this.peerConn.localDescription.sdp,type:this.peerConn.localDescription.type},[l.A]:this.getLocalSDPStreamMetadata(!0)};e.capabilities={"m.call.transferee":this.client.supportsCallTransfer,"m.call.dtmf":!1};const t=this.discardDuplicateCandidates();o.v.info(`Call ${this.callId} sendAnswer() discarding ${t} candidates that will be sent in answer`);try{await this.sendVoipEvent(d.Bx.CallAnswer,e),this.inviteOrAnswerSent=!0}catch(e){this.state=y.Ringing,e instanceof g.up&&e.event&&this.client.cancelPendingEvent(e.event);let t=I.SendAnswer,s="Failed to send answer";throw"UnknownDeviceError"==e.name&&(t=I.UnknownDevices,s="Unknown devices present in the room"),this.emit(w.Error,new k(t,s,e),this),e}this.sendCandidateQueue()}queueGotCallFeedsForAnswer(e){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then((()=>this.gotCallFeedsForAnswer(e))):this.responsePromiseChain=this.gotCallFeedsForAnswer(e)}mungeSdp(e,t){const s=(0,r.qg)(e.sdp);s.media.forEach((e=>{const s=new Map,i=new Map;for(const t of e.rtp)s.set(t.payload,t.codec),i.set(t.codec,t.payload);for(const n of t){if(n.mediaType!==e.type)continue;if(!i.has(n.codec)){o.v.info(`Call ${this.callId} mungeSdp() ignoring SDP modifications for ${n.codec} as it's not present.`);continue}const t=[];void 0!==n.enableDtx&&t.push("usedtx="+(n.enableDtx?"1":"0")),void 0!==n.maxAverageBitrate&&t.push(`maxaveragebitrate=${n.maxAverageBitrate}`);let r=!1;for(const i of e.fmtp)s.get(i.payload)===n.codec&&(r=!0,i.config+=";"+t.join(";"));r||e.fmtp.push({payload:i.get(n.codec),config:t.join(";")})}})),e.sdp=(0,r.M9)(s)}async createOffer(){const e=await this.peerConn.createOffer();return this.mungeSdp(e,T(this.isPtt)),e}async createAnswer(){const e=await this.peerConn.createAnswer();return this.mungeSdp(e,T(this.isPtt)),e}async gotCallFeedsForAnswer(e){if(this.callHasEnded())return;this.waitForLocalAVStream=!1;for(const t of e)this.pushLocalFeed(t);let t;this.state=y.CreateAnswer;try{this.getRidOfRTXCodecs(),t=await this.createAnswer()}catch(e){return o.v.debug(`Call ${this.callId} gotCallFeedsForAnswer() failed to create answer: `,e),void this.terminate(E.Local,I.CreateAnswer,!0)}try{if(await this.peerConn.setLocalDescription(t),this.callHasEnded())return;if(this.state=y.Connecting,await new Promise((e=>{setTimeout(e,200)})),this.callHasEnded())return;this.sendAnswer()}catch(e){return o.v.debug(`Call ${this.callId} gotCallFeedsForAnswer() error setting local description!`,e),void this.terminate(E.Local,I.SetLocalDescription,!0)}}async onRemoteIceCandidatesReceived(e){if(this.callHasEnded())return;const t=e.getContent(),s=t.candidates;if(!s)return void o.v.info(`Call ${this.callId} onRemoteIceCandidatesReceived() ignoring candidates event with no candidates!`);const i=0===t.version?null:t.party_id||null;if(void 0!==this.opponentPartyId)this.partyIdMatches(t)?await this.addIceCandidates(s):o.v.info(`Call ${this.callId} onRemoteIceCandidatesReceived() ignoring candidates from party ID ${t.party_id}: we have chosen party ID ${this.opponentPartyId}`);else if(i){o.v.info(`Call ${this.callId} onRemoteIceCandidatesReceived() buffering ${s.length} candidates until we pick an opponent`);const e=this.remoteCandidateBuffer.get(i)||[];e.push(...s),this.remoteCandidateBuffer.set(i,e)}}async onAnswerReceived(e){const t=e.getContent();if(o.v.debug(`Call ${this.callId} onAnswerReceived() running (hangupParty=${t.party_id})`),this.callHasEnded())return void o.v.debug(`Call ${this.callId} onAnswerReceived() ignoring answer because call has ended`);if(void 0!==this.opponentPartyId)return void o.v.info(`Call ${this.callId} onAnswerReceived() ignoring answer from party ID ${t.party_id}: we already have an answer/reject from ${this.opponentPartyId}`);this.chooseOpponent(e),await this.addBufferedIceCandidates(),this.state=y.Connecting;const s=t[l.A];s?this.updateRemoteSDPStreamMetadata(s):o.v.warn(`Call ${this.callId} onAnswerReceived() did not get any SDPStreamMetadata! Can not send/receive multiple streams`);try{this.isSettingRemoteAnswerPending=!0,await this.peerConn.setRemoteDescription(t.answer),this.isSettingRemoteAnswerPending=!1,o.v.debug(`Call ${this.callId} onAnswerReceived() set remote description: ${t.answer.type}`)}catch(e){return this.isSettingRemoteAnswerPending=!1,o.v.debug(`Call ${this.callId} onAnswerReceived() failed to set remote description`,e),void this.terminate(E.Local,I.SetRemoteDescription,!1)}if(null!==this.opponentPartyId)try{await this.sendVoipEvent(d.Bx.CallSelectAnswer,{selected_party_id:this.opponentPartyId})}catch(e){o.v.warn(`Call ${this.callId} onAnswerReceived() failed to send select_answer event`,e)}}async onSelectAnswerReceived(e){if(this.direction!==b.Inbound)return void o.v.warn(`Call ${this.callId} onSelectAnswerReceived() got select_answer for an outbound call: ignoring`);const t=e.getContent().selected_party_id;null!=t?t!==this.ourPartyId&&(o.v.info(`Call ${this.callId} onSelectAnswerReceived() got select_answer for party ID ${t}: we are party ID ${this.ourPartyId}.`),await this.terminate(E.Remote,I.AnsweredElsewhere,!0)):o.v.warn(`Call ${this.callId} onSelectAnswerReceived() got nonsensical select_answer with null/undefined selected_party_id: ignoring`)}async onNegotiateReceived(e){const t=e.getContent(),s=t.description;if(!s||!s.sdp||!s.type)return void o.v.info(`Call ${this.callId} onNegotiateReceived() ignoring invalid m.call.negotiate event`);const i=this.direction===b.Inbound,n=!this.makingOffer&&("stable"===this.peerConn.signalingState||this.isSettingRemoteAnswerPending),r="offer"===s.type&&!n;if(this.ignoreOffer=!i&&r,this.ignoreOffer)return void o.v.info(`Call ${this.callId} onNegotiateReceived() ignoring colliding negotiate event because we're impolite`);const a=this.isLocalOnHold(),c=t[l.A];c?this.updateRemoteSDPStreamMetadata(c):o.v.warn(`Call ${this.callId} onNegotiateReceived() received negotiation event without SDPStreamMetadata!`);try{if(this.isSettingRemoteAnswerPending="answer"==s.type,await this.peerConn.setRemoteDescription(s),this.isSettingRemoteAnswerPending=!1,o.v.debug(`Call ${this.callId} onNegotiateReceived() set remote description: ${s.type}`),"offer"===s.type){var u;let e;try{this.getRidOfRTXCodecs(),e=await this.createAnswer()}catch(e){return o.v.debug(`Call ${this.callId} onNegotiateReceived() failed to create answer: `,e),void this.terminate(E.Local,I.CreateAnswer,!0)}await this.peerConn.setLocalDescription(e),o.v.debug(`Call ${this.callId} onNegotiateReceived() create an answer`),this.sendVoipEvent(d.Bx.CallNegotiate,{lifetime:_,description:null===(u=this.peerConn.localDescription)||void 0===u?void 0:u.toJSON(),[l.A]:this.getLocalSDPStreamMetadata(!0)})}}catch(e){this.isSettingRemoteAnswerPending=!1,o.v.warn(`Call ${this.callId} onNegotiateReceived() failed to complete negotiation`,e)}const h=this.isLocalOnHold();a!==h&&(this.emit(w.LocalHoldUnhold,h,this),this.emit(w.HoldUnhold,h))}updateRemoteSDPStreamMetadata(e){this.remoteSDPStreamMetadata=(0,a.Bi)(this.remoteSDPStreamMetadata||{},e,!0);for(const e of this.getRemoteFeeds()){var t;const s=e.stream.id,i=this.remoteSDPStreamMetadata[s];e.setAudioVideoMuted(null==i?void 0:i.audio_muted,null==i?void 0:i.video_muted),e.purpose=null===(t=this.remoteSDPStreamMetadata[s])||void 0===t?void 0:t.purpose}}onSDPStreamMetadataChangedReceived(e){const t=e.getContent()[l.A];this.updateRemoteSDPStreamMetadata(t)}async onAssertedIdentityReceived(e){const t=e.getContent();t.asserted_identity&&(this.remoteAssertedIdentity={id:t.asserted_identity.id,displayName:t.asserted_identity.display_name},this.emit(w.AssertedIdentityChanged,this))}callHasEnded(){return this.state===y.Ended}queueGotLocalOffer(){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then((()=>this.wrappedGotLocalOffer())):this.responsePromiseChain=this.wrappedGotLocalOffer()}async wrappedGotLocalOffer(){this.makingOffer=!0;try{await this.gotLocalOffer()}catch(e){return void this.getLocalOfferFailed(e)}finally{this.makingOffer=!1}}async gotLocalOffer(){if(o.v.debug(`Call ${this.callId} gotLocalOffer() running`),this.callHasEnded())return void o.v.debug(`Call ${this.callId} gotLocalOffer() ignoring newly created offer because the call has ended"`);let e;try{this.getRidOfRTXCodecs(),e=await this.createOffer()}catch(e){return o.v.debug(`Call ${this.callId} gotLocalOffer() failed to create offer: `,e),void this.terminate(E.Local,I.CreateOffer,!0)}try{await this.peerConn.setLocalDescription(e)}catch(e){return o.v.debug(`Call ${this.callId} gotLocalOffer() error setting local description!`,e),void this.terminate(E.Local,I.SetLocalDescription,!0)}if("gathering"===this.peerConn.iceGatheringState&&await new Promise((e=>{setTimeout(e,200)})),this.callHasEnded())return;const t=this.state===y.CreateOffer?d.Bx.CallInvite:d.Bx.CallNegotiate,s={lifetime:_};var i,n;(t===d.Bx.CallInvite&&this.invitee&&(s.invitee=this.invitee),this.state===y.CreateOffer)?s.offer=null===(i=this.peerConn.localDescription)||void 0===i?void 0:i.toJSON():s.description=null===(n=this.peerConn.localDescription)||void 0===n?void 0:n.toJSON();s.capabilities={"m.call.transferee":this.client.supportsCallTransfer,"m.call.dtmf":!1},s[l.A]=this.getLocalSDPStreamMetadata(!0);const r=this.discardDuplicateCandidates();o.v.info(`Call ${this.callId} gotLocalOffer() discarding ${r} candidates that will be sent in offer`);try{await this.sendVoipEvent(t,s)}catch(e){o.v.error(`Call ${this.callId} gotLocalOffer() failed to send invite`,e),e instanceof g.up&&e.event&&this.client.cancelPendingEvent(e.event);let t=I.SignallingFailed,s="Signalling failed";return this.state===y.CreateOffer&&(t=I.SendInvite,s="Failed to send invite"),"UnknownDeviceError"==e.name&&(t=I.UnknownDevices,s="Unknown devices present in the room"),this.emit(w.Error,new k(t,s,e),this),void this.terminate(E.Local,t,!1)}this.sendCandidateQueue(),this.state===y.CreateOffer&&(this.inviteOrAnswerSent=!0,this.state=y.InviteSent,this.inviteTimeout=setTimeout((()=>{this.inviteTimeout=void 0,this.state===y.InviteSent&&this.hangup(I.InviteTimeout,!1)}),_))}getRidOfRTXCodecs(){if(!RTCRtpReceiver.getCapabilities||!RTCRtpSender.getCapabilities)return;const e=this.transceivers.get(C(l.h.Screenshare,"video"));if(!e||!e.setCodecPreferences)return;const t=RTCRtpReceiver.getCapabilities("video").codecs,s=RTCRtpSender.getCapabilities("video").codecs,i=[];for(const n of[...t,...s])if("video/rtx"!==n.mimeType){i.push(n);try{e.setCodecPreferences(i)}catch(e){o.v.info("Working around buggy WebRTC impl: claimed to support codec but threw when setting codec preferences",n,e),i.pop()}}}async sendVoipEvent(e,t){const s=f(f({},t),{},{version:"1",call_id:this.callId,party_id:this.ourPartyId,conf_id:this.groupCallId});if(this.opponentDeviceId){var i;const t=this.toDeviceSeq++,r=f(f({},s),{},{device_id:this.client.deviceId,sender_session_id:this.client.getSessionId(),dest_session_id:this.opponentSessionId,seq:t,[d.wt]:(0,n.A)()});this.emit(w.SendVoipEvent,{type:"toDevice",eventType:e,userId:this.invitee||(null===(i=this.getOpponentMember())||void 0===i?void 0:i.userId),opponentDeviceId:this.opponentDeviceId,content:r},this);const a=this.invitee||this.getOpponentMember().userId;if(this.client.getUseE2eForGroupCall()){if(!this.opponentDeviceInfo)return void o.v.warn(`Call ${this.callId} sendVoipEvent() failed: we do not have opponentDeviceInfo`);await this.client.encryptAndSendToDevices([{userId:a,deviceInfo:this.opponentDeviceInfo}],{type:e,content:r})}else await this.client.sendToDevice(e,new Map([[a,new Map([[this.opponentDeviceId,r]])]]))}else{var r;this.emit(w.SendVoipEvent,{type:"sendEvent",eventType:e,roomId:this.roomId,content:s,userId:this.invitee||(null===(r=this.getOpponentMember())||void 0===r?void 0:r.userId)},this),await this.client.sendEvent(this.roomId,e,s)}}queueCandidate(e){if(e?this.candidateSendQueue.push(e):this.candidatesEnded=!0,this.state===y.Ringing||!this.inviteOrAnswerSent)return;const t=this.direction===b.Inbound?500:2e3;0===this.candidateSendTries&&setTimeout((()=>{this.sendCandidateQueue()}),t)}discardDuplicateCandidates(){let e=0;const t=[];for(let s=0;s<this.candidateSendQueue.length;s++){const i=this.candidateSendQueue[s];""===i.candidate?t.push(i):e++}return this.candidateSendQueue=t,e}async transfer(e){const t=await this.client.getProfileInfo(e),s=R(),i={replacement_id:R(),target_user:{id:e,display_name:t.displayname,avatar_url:t.avatar_url},create_call:s};await this.sendVoipEvent(d.Bx.CallReplaces,i),await this.terminate(E.Local,I.Transferred,!0)}async transferToCall(e){var t,s;const i=null===(t=e.getOpponentMember())||void 0===t?void 0:t.userId,n=i?await this.client.getProfileInfo(i):void 0,r=null===(s=this.getOpponentMember())||void 0===s?void 0:s.userId,o=r?await this.client.getProfileInfo(r):void 0,a=R(),c={replacement_id:R(),target_user:{id:r,display_name:null==o?void 0:o.displayname,avatar_url:null==o?void 0:o.avatar_url},await_call:a};await e.sendVoipEvent(d.Bx.CallReplaces,c);const l={replacement_id:R(),target_user:{id:i,display_name:null==n?void 0:n.displayname,avatar_url:null==n?void 0:n.avatar_url},create_call:a};await this.sendVoipEvent(d.Bx.CallReplaces,l),await this.terminate(E.Local,I.Transferred,!0),await e.terminate(E.Local,I.Transferred,!0)}async terminate(e,t,s){var i;if(!this.callHasEnded()){this.hangupParty=e,this.hangupReason=t,this.state=y.Ended,this.inviteTimeout&&(clearTimeout(this.inviteTimeout),this.inviteTimeout=void 0),void 0!==this.iceDisconnectedTimeout&&(clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0),this.callLengthInterval&&(clearInterval(this.callLengthInterval),this.callLengthInterval=void 0),void 0!==this.stopVideoTrackTimer&&(clearTimeout(this.stopVideoTrackTimer),this.stopVideoTrackTimer=void 0);for(const[e,t]of this.removeTrackListeners)e.removeEventListener("removetrack",t);this.removeTrackListeners.clear(),this.callStatsAtEnd=await this.collectCallStats(),this.stopAllMedia(),this.deleteAllFeeds(),this.peerConn&&"closed"!==this.peerConn.signalingState&&this.peerConn.close(),null===(i=this.stats)||void 0===i||i.removeStatsReportGatherer(this.callId),s&&this.emit(w.Hangup,this),this.client.callEventHandler.calls.delete(this.callId)}}stopAllMedia(){o.v.debug(`Call ${this.callId} stopAllMedia() running`);for(const e of this.feeds)if(e.isLocal()&&e.purpose===l.h.Usermedia)this.client.getMediaHandler().stopUserMediaStream(e.stream);else if(e.isLocal()&&e.purpose===l.h.Screenshare)this.client.getMediaHandler().stopScreensharingStream(e.stream);else if(!e.isLocal()){o.v.debug(`Call ${this.callId} stopAllMedia() stopping stream (streamId=${e.stream.id})`);for(const t of e.stream.getTracks())t.stop()}}checkForErrorListener(){if(0===this.listeners(h.u.Error).length)throw new Error("You MUST attach an error listener using call.on('error', function() {})")}async sendCandidateQueue(){if(0===this.candidateSendQueue.length||this.callHasEnded())return;const e=this.candidateSendQueue;this.candidateSendQueue=[],++this.candidateSendTries;const t={candidates:e.map((e=>e.toJSON()))};this.candidatesEnded&&t.candidates.push({candidate:""}),o.v.debug(`Call ${this.callId} sendCandidateQueue() attempting to send ${e.length} candidates`);try{await this.sendVoipEvent(d.Bx.CallCandidates,t),this.candidateSendTries=0,this.sendCandidateQueue()}catch(t){if(t instanceof g.up&&t.event&&this.client.cancelPendingEvent(t.event),this.candidateSendQueue.push(...e),this.candidateSendTries>5){o.v.debug(`Call ${this.callId} sendCandidateQueue() failed to send candidates on attempt ${this.candidateSendTries}. Giving up on this call.`,t);const e=I.SignallingFailed,s="Signalling failed";return this.emit(w.Error,new k(e,s,t),this),void this.hangup(e,!1)}const s=500*Math.pow(2,this.candidateSendTries);++this.candidateSendTries,o.v.debug(`Call ${this.callId} sendCandidateQueue() failed to send candidates. Retrying in ${s}ms`,t),setTimeout((()=>{this.sendCandidateQueue()}),s)}}async placeCall(e,t){if(!e)throw new Error("You CANNOT start a call without audio");let s;this.state=y.WaitLocalMedia;try{var i;const n=await this.client.getMediaHandler().getUserMediaStream(e,t);O(n.getAudioTracks(),!0),O(n.getVideoTracks(),!0),s=new u.Hh({client:this.client,roomId:this.roomId,userId:this.client.getUserId(),deviceId:null!==(i=this.client.getDeviceId())&&void 0!==i?i:void 0,stream:n,purpose:l.h.Usermedia,audioMuted:!1,videoMuted:!1})}catch(e){return void this.getUserMediaFailed(e)}try{await this.placeCallWithCallFeeds([s])}catch(e){return void this.placeCallFailed(e)}}async placeCallWithCallFeeds(e,t=!1){this.checkForErrorListener(),this.direction=b.Outbound,await this.initOpponentCrypto(),this.client.callEventHandler.calls.set(this.callId,this);await this.client.checkTurnServers()||o.v.warn(`Call ${this.callId} placeCallWithCallFeeds() failed to get TURN credentials! Proceeding with call anyway...`),this.peerConn=this.createPeerConnection(),this.emit(w.PeerConnectionCreated,this.peerConn,this),this.gotCallFeedsForInvite(e,t)}createPeerConnection(){var e;const t=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers.length?this.turnServers:void 0,iceCandidatePoolSize:this.client.iceCandidatePoolSize,bundlePolicy:"max-bundle"});t.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),t.addEventListener("signalingstatechange",this.onSignallingStateChanged),t.addEventListener("icecandidate",this.gotLocalIceCandidate),t.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),t.addEventListener("track",this.onTrack),t.addEventListener("negotiationneeded",this.onNegotiationNeeded),t.addEventListener("datachannel",this.onDataChannel);const s=this.getOpponentMember(),i=s?s.userId:"unknown";return null===(e=this.stats)||void 0===e||e.addStatsReportGatherer(this.callId,i,t),t}partyIdMatches(e){return(0===e.version?null:e.party_id||null)===this.opponentPartyId}chooseOpponent(e){var t;const s=e.getContent();var i;(o.v.debug(`Call ${this.callId} chooseOpponent() running (partyId=${s.party_id})`),this.opponentVersion=s.version,0===this.opponentVersion?this.opponentPartyId=null:this.opponentPartyId=s.party_id||null,this.opponentCaps=s.capabilities||{},this.opponentMember=null!==(t=this.client.getRoom(this.roomId).getMember(e.getSender()))&&void 0!==t?t:void 0,this.opponentMember)&&(null===(i=this.stats)||void 0===i||i.updateOpponentMember(this.callId,this.opponentMember.userId))}async addBufferedIceCandidates(){const e=this.remoteCandidateBuffer.get(this.opponentPartyId);e&&(o.v.info(`Call ${this.callId} addBufferedIceCandidates() adding ${e.length} buffered candidates for opponent ${this.opponentPartyId}`),await this.addIceCandidates(e)),this.remoteCandidateBuffer.clear()}async addIceCandidates(e){for(const t of e){null!==t.sdpMid&&void 0!==t.sdpMid||null!==t.sdpMLineIndex&&void 0!==t.sdpMLineIndex?o.v.debug(`Call ${this.callId} addIceCandidates() got remote ICE candidate (sdpMid=${t.sdpMid}, candidate=${t.candidate})`):o.v.debug(`Call ${this.callId} addIceCandidates() got remote ICE end-of-candidates`);try{await this.peerConn.addIceCandidate(t)}catch(e){this.ignoreOffer?o.v.debug(`Call ${this.callId} addIceCandidates() failed to add remote ICE candidate because ignoring offer`,e):o.v.info(`Call ${this.callId} addIceCandidates() failed to add remote ICE candidate`,e)}}}get hasPeerConnection(){return Boolean(this.peerConn)}initStats(e,t="unknown"){this.stats=e,this.stats.start()}}function O(e,t){for(const s of e)s.enabled=t}function M(){if("undefined"==typeof window||"undefined"==typeof document)return!1;try{if(!Boolean(window.RTCPeerConnection||window.RTCSessionDescription||window.RTCIceCandidate||navigator.mediaDevices))return o.v.error("WebRTC is not supported in this browser / environment"),!1}catch(e){return o.v.error("Exception thrown when trying to access WebRTC",e),!1}return!0}function x(e,t,s){if(!M())return null;const i=!!s&&s.forceTURN,n={client:e,roomId:t,invitee:null==s?void 0:s.invitee,turnServers:e.getTurnServers(),forceTURN:e.forceTURN||i,opponentDeviceId:null==s?void 0:s.opponentDeviceId,opponentSessionId:null==s?void 0:s.opponentSessionId,groupCallId:null==s?void 0:s.groupCallId},r=new A(n);return e.reEmitter.reEmit(r,Object.values(w)),r}},"./node_modules/matrix-js-sdk/src/webrtc/callEventHandler.ts":(e,t,s)=>{"use strict";s.d(t,{B:()=>l,N:()=>u});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/logger.ts"),r=s("./node_modules/matrix-js-sdk/src/webrtc/call.ts"),o=s("./node_modules/matrix-js-sdk/src/@types/event.ts"),a=s("./node_modules/matrix-js-sdk/src/client.ts"),d=s("./node_modules/matrix-js-sdk/src/webrtc/groupCall.ts"),c=s("./node_modules/matrix-js-sdk/src/models/room.ts");let l=function(e){return e.Incoming="Call.incoming",e}({});class u{constructor(e){(0,i.A)(this,"calls",void 0),(0,i.A)(this,"callEventBuffer",void 0),(0,i.A)(this,"nextSeqByCall",new Map),(0,i.A)(this,"toDeviceEventBuffers",new Map),(0,i.A)(this,"client",void 0),(0,i.A)(this,"candidateEventsByCall",void 0),(0,i.A)(this,"eventBufferPromiseChain",void 0),(0,i.A)(this,"onSync",(()=>{const e=this.callEventBuffer;this.callEventBuffer=[],this.eventBufferPromiseChain?this.eventBufferPromiseChain=this.eventBufferPromiseChain.then((()=>this.evaluateEventBuffer(e))):this.eventBufferPromiseChain=this.evaluateEventBuffer(e)})),(0,i.A)(this,"onRoomTimeline",(e=>{this.callEventBuffer.push(e)})),(0,i.A)(this,"onToDeviceEvent",(e=>{const t=e.getContent();if(!t.call_id)return void this.callEventBuffer.push(e);if(this.nextSeqByCall.has(t.call_id)||this.nextSeqByCall.set(t.call_id,0),void 0===t.seq)return void this.callEventBuffer.push(e);const s=this.nextSeqByCall.get(t.call_id)||0;if(t.seq!==s){this.toDeviceEventBuffers.has(t.call_id)||this.toDeviceEventBuffers.set(t.call_id,[]);const s=this.toDeviceEventBuffers.get(t.call_id),i=s.findIndex((e=>e.getContent().seq>t.seq));-1===i?s.push(e):s.splice(i,0,e)}else{const s=t.call_id;this.callEventBuffer.push(e),this.nextSeqByCall.set(s,t.seq+1);const i=this.toDeviceEventBuffers.get(s);let n=i&&i.shift();for(;n&&n.getContent().seq===this.nextSeqByCall.get(s);)this.callEventBuffer.push(n),this.nextSeqByCall.set(s,n.getContent().seq+1),n=i.shift()}})),this.client=e,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}start(){this.client.on(a.AU.Sync,this.onSync),this.client.on(c.u9.Timeline,this.onRoomTimeline),this.client.on(a.AU.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.removeListener(a.AU.Sync,this.onSync),this.client.removeListener(c.u9.Timeline,this.onRoomTimeline),this.client.removeListener(a.AU.ToDeviceEvent,this.onToDeviceEvent)}async evaluateEventBuffer(e){await Promise.all(e.map((e=>this.client.decryptEventIfNeeded(e))));const t=e.filter((e=>{const t=e.getType();return t.startsWith("m.call.")||t.startsWith("org.matrix.call.")})),s=new Set;for(const e of t){const t=e.getType();t!==o.Bx.CallAnswer&&t!==o.Bx.CallHangup||s.add(e.getContent().call_id)}for(const e of t){const t=e.getType(),i=e.getContent().call_id;if(t!==o.Bx.CallInvite||!s.has(i))try{await this.handleCallEvent(e)}catch(e){n.v.error("CallEventHandler evaluateEventBuffer() caught exception handling call event",e)}}}async handleCallEvent(e){var t;this.client.emit(a.AU.ReceivedVoipEvent,e);const s=e.getContent(),i=e.getRoomId()||(null===(t=this.client.groupCallEventHandler.getGroupCallById(s.conf_id))||void 0===t||null===(t=t.room)||void 0===t?void 0:t.roomId),c=s.conf_id,u=e.getType(),h=e.getSender();let m,p,g=s.call_id?this.calls.get(s.call_id):void 0;if(c){if(p=this.client.groupCallEventHandler.getGroupCallById(c),!p)return void n.v.warn(`CallEventHandler handleCallEvent() could not find a group call - ignoring event (groupCallId=${c}, type=${u})`);if(m=s.device_id,!m)return n.v.warn(`CallEventHandler handleCallEvent() could not find a device id - ignoring event (senderId=${h})`),void p.emit(d.AZ.Error,new d.Iy(h));if(s.dest_session_id!==this.client.getSessionId())return void n.v.warn("CallEventHandler handleCallEvent() call event does not match current session id - ignoring")}const v=h===this.client.credentials.userId&&(void 0===m||m===this.client.getDeviceId());if(i)if(u!==o.Bx.CallInvite)if(u!==o.Bx.CallCandidates){var f;if([o.Bx.CallHangup,o.Bx.CallReject].includes(u))g?g.state!==r.iP.Ended&&(u===o.Bx.CallHangup?g.onHangupReceived(s):g.onRejectReceived(s),g.state===r.iP.Ended&&this.calls.delete(s.call_id)):(g=null!==(f=(0,r.sv)(this.client,i,{opponentDeviceId:m,opponentSessionId:s.sender_session_id}))&&void 0!==f?f:void 0,g&&(g.callId=s.call_id,g.initWithHangup(e),this.calls.set(s.call_id,g)));else if(g&&g.hasPeerConnection){if(e.getContent().party_id!==g.ourPartyId)switch(u){case o.Bx.CallAnswer:v?g.state===r.iP.Ringing&&g.onAnsweredElsewhere(s):g.onAnswerReceived(e);break;case o.Bx.CallSelectAnswer:g.onSelectAnswerReceived(e);break;case o.Bx.CallNegotiate:g.onNegotiateReceived(e);break;case o.Bx.CallAssertedIdentity:case o.Bx.CallAssertedIdentityPrefix:g.onAssertedIdentityReceived(e);break;case o.Bx.CallSDPStreamMetadataChanged:case o.Bx.CallSDPStreamMetadataChangedPrefix:g.onSDPStreamMetadataChangedReceived(e)}}else n.v.info(`CallEventHandler handleCallEvent() discarding possible call event as we don't have a call (type=${u})`)}else{if(v)return;g?g.onRemoteIceCandidatesReceived(e):(this.candidateEventsByCall.has(s.call_id)||this.candidateEventsByCall.set(s.call_id,[]),this.candidateEventsByCall.get(s.call_id).push(e))}else{var y,S,b;if(v)return;if(e.getLocalAge()>s.lifetime-3e3)return;if(g&&g.state===r.iP.Ended)return;if(g&&n.v.warn(`CallEventHandler handleCallEvent() already has a call but got an invite - clobbering (callId=${s.call_id})`),s.invitee&&s.invitee!==this.client.getUserId())return;const t=(null!==(y=this.client.getTurnServersExpiry())&&void 0!==y?y:0)-Date.now();if(n.v.info("CallEventHandler handleCallEvent() current turn creds expire in "+t+" ms"),g=null!==(S=(0,r.sv)(this.client,i,{forceTURN:this.client.forceTURN,opponentDeviceId:m,groupCallId:c,opponentSessionId:s.sender_session_id}))&&void 0!==S?S:void 0,!g)return void n.v.log(`CallEventHandler handleCallEvent() this client does not support WebRTC (callId=${s.call_id})`);g.callId=s.call_id;const o=null===(b=p)||void 0===b?void 0:b.getGroupCallStats();o&&g.initStats(o);try{await g.initWithInvite(e)}catch(e){var E;if(e instanceof r.RA)if(e.code===d.BF.UnknownDevice)null===(E=p)||void 0===E||E.emit(d.AZ.Error,e);else n.v.error(e)}if(this.calls.set(g.callId,g),this.candidateEventsByCall.get(g.callId))for(const e of this.candidateEventsByCall.get(g.callId))g.onRemoteIceCandidatesReceived(e);let a;for(const e of this.calls.values()){var w;const t=[r.iP.WaitLocalMedia,r.iP.CreateOffer,r.iP.InviteSent].includes(e.state);if(g.roomId===e.roomId&&e.direction===r.QO.Outbound&&(null===(w=g.getOpponentMember())||void 0===w?void 0:w.userId)===e.invitee&&t){a=e;break}}a?a.callId>g.callId?(n.v.log(`CallEventHandler handleCallEvent() detected glare - answering incoming call and canceling outgoing call (incomingId=${g.callId}, outgoingId=${a.callId})`),a.replacedBy(g)):(n.v.log(`CallEventHandler handleCallEvent() detected glare - hanging up incoming call (incomingId=${g.callId}, outgoingId=${a.callId})`),g.hangup(r.Il.Replaced,!0)):this.client.emit(l.Incoming,g)}}}},"./node_modules/matrix-js-sdk/src/webrtc/callEventTypes.ts":(e,t,s)=>{"use strict";s.d(t,{A:()=>i,h:()=>n});const i="org.matrix.msc3077.sdp_stream_metadata";let n=function(e){return e.Usermedia="m.usermedia",e.Screenshare="m.screenshare",e}({})},"./node_modules/matrix-js-sdk/src/webrtc/callFeed.ts":(e,t,s)=>{"use strict";s.d(t,{Hh:()=>h,Tw:()=>l});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/webrtc/callEventTypes.ts");let r=null,o=0;var a=s("./node_modules/matrix-js-sdk/src/logger.ts"),d=s("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),c=s("./node_modules/matrix-js-sdk/src/webrtc/call.ts");const l=-60;let u=function(e){return e.NewStream="new_stream",e.MuteStateChanged="mute_state_changed",e.LocalVolumeChanged="local_volume_changed",e.VolumeChanged="volume_changed",e.ConnectedChanged="connected_changed",e.Speaking="speaking",e.Disposed="disposed",e}({});class h extends d.X{constructor(e){super(),(0,i.A)(this,"stream",void 0),(0,i.A)(this,"sdpMetadataStreamId",void 0),(0,i.A)(this,"userId",void 0),(0,i.A)(this,"deviceId",void 0),(0,i.A)(this,"purpose",void 0),(0,i.A)(this,"speakingVolumeSamples",void 0),(0,i.A)(this,"client",void 0),(0,i.A)(this,"call",void 0),(0,i.A)(this,"roomId",void 0),(0,i.A)(this,"audioMuted",void 0),(0,i.A)(this,"videoMuted",void 0),(0,i.A)(this,"localVolume",1),(0,i.A)(this,"measuringVolumeActivity",!1),(0,i.A)(this,"audioContext",void 0),(0,i.A)(this,"analyser",void 0),(0,i.A)(this,"frequencyBinCount",void 0),(0,i.A)(this,"speakingThreshold",l),(0,i.A)(this,"speaking",!1),(0,i.A)(this,"volumeLooperTimeout",void 0),(0,i.A)(this,"_disposed",!1),(0,i.A)(this,"_connected",!1),(0,i.A)(this,"onAddTrack",(()=>{this.emit(u.NewStream,this.stream)})),(0,i.A)(this,"onCallState",(e=>{e===c.iP.Connected?this.connected=!0:e===c.iP.Connecting&&(this.connected=!1)})),(0,i.A)(this,"volumeLooper",(()=>{if(!this.analyser)return;if(!this.measuringVolumeActivity)return;this.analyser.getFloatFrequencyData(this.frequencyBinCount);let e=-1/0;for(const t of this.frequencyBinCount)t>e&&(e=t);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(e),this.emit(u.VolumeChanged,e);let t=!1;for(const e of this.speakingVolumeSamples)if(e>this.speakingThreshold){t=!0;break}this.speaking!==t&&(this.speaking=t,this.emit(u.Speaking,this.speaking)),this.volumeLooperTimeout=setTimeout(this.volumeLooper,200)})),this.client=e.client,this.call=e.call,this.roomId=e.roomId,this.userId=e.userId,this.deviceId=e.deviceId,this.purpose=e.purpose,this.audioMuted=e.audioMuted,this.videoMuted=e.videoMuted,this.speakingVolumeSamples=new Array(8).fill(-1/0),this.sdpMetadataStreamId=e.stream.id,this.updateStream(null,e.stream),this.stream=e.stream,this.hasAudioTrack&&this.initVolumeMeasuring(),e.call&&(e.call.addListener(c.$E.State,this.onCallState),this.onCallState(e.call.state))}get connected(){return this.isLocal()||this._connected}set connected(e){this._connected=e,this.emit(u.ConnectedChanged,this.connected)}get hasAudioTrack(){return this.stream.getAudioTracks().length>0}updateStream(e,t){if(t===e)return;const s=this.measuringVolumeActivity;e&&(e.removeEventListener("addtrack",this.onAddTrack),this.measureVolumeActivity(!1)),this.stream=t,t.addEventListener("addtrack",this.onAddTrack),this.hasAudioTrack?(this.initVolumeMeasuring(),s&&this.measureVolumeActivity(!0)):this.measureVolumeActivity(!1),this.emit(u.NewStream,this.stream)}initVolumeMeasuring(){if(!this.hasAudioTrack)return;this.audioContext||(this.audioContext=(null===r&&(r=new AudioContext),o++,r)),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1;this.audioContext.createMediaStreamSource(this.stream).connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount)}getMember(){var e;const t=this.client.getRoom(this.roomId);return null!==(e=null==t?void 0:t.getMember(this.userId))&&void 0!==e?e:null}isLocal(){return this.userId===this.client.getUserId()&&(void 0===this.deviceId||this.deviceId===this.client.getDeviceId())}isAudioMuted(){return 0===this.stream.getAudioTracks().length||this.audioMuted}isVideoMuted(){return 0===this.stream.getVideoTracks().length||this.videoMuted}isSpeaking(){return this.speaking}setNewStream(e){this.updateStream(this.stream,e)}setAudioVideoMuted(e,t){null!==e&&(this.audioMuted!==e&&this.speakingVolumeSamples.fill(-1/0),this.audioMuted=e),null!==t&&(this.videoMuted=t),this.emit(u.MuteStateChanged,this.audioMuted,this.videoMuted)}measureVolumeActivity(e){if(e){if(!this.analyser||!this.frequencyBinCount||!this.hasAudioTrack)return;this.measuringVolumeActivity=!0,this.volumeLooper()}else this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.emit(u.VolumeChanged,-1/0)}setSpeakingThreshold(e){this.speakingThreshold=e}clone(){const e=this.client.getMediaHandler(),t=this.stream.clone();return a.v.log(`CallFeed clone() cloning stream (originalStreamId=${this.stream.id}, newStreamId${t.id})`),this.purpose===n.h.Usermedia?e.userMediaStreams.push(t):e.screensharingStreams.push(t),new h({client:this.client,roomId:this.roomId,userId:this.userId,deviceId:this.deviceId,stream:t,purpose:this.purpose,audioMuted:this.audioMuted,videoMuted:this.videoMuted})}dispose(){var e,t,s;clearTimeout(this.volumeLooperTimeout),null===(e=this.stream)||void 0===e||e.removeEventListener("addtrack",this.onAddTrack),null===(t=this.call)||void 0===t||t.removeListener(c.$E.State,this.onCallState),this.audioContext&&(this.audioContext=void 0,this.analyser=void 0,o--,0===o&&(null===(s=r)||void 0===s||s.close(),r=null)),this._disposed=!0,this.emit(u.Disposed)}get disposed(){return this._disposed}set disposed(e){this._disposed=e}getLocalVolume(){return this.localVolume}setLocalVolume(e){this.localVolume=e,this.emit(u.LocalVolumeChanged,e)}}},"./node_modules/matrix-js-sdk/src/webrtc/groupCall.ts":(e,t,s)=>{"use strict";s.d(t,{eO:()=>J,BF:()=>$,AZ:()=>B,MC:()=>L,F_:()=>G,Ad:()=>N,Iy:()=>V});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),r=s("./node_modules/matrix-js-sdk/src/webrtc/callFeed.ts"),o=s("./node_modules/matrix-js-sdk/src/webrtc/call.ts"),a=s("./node_modules/matrix-js-sdk/src/models/room-state.ts"),d=s("./node_modules/matrix-js-sdk/src/logger.ts"),c=s("./node_modules/matrix-js-sdk/src/ReEmitter.ts"),l=s("./node_modules/matrix-js-sdk/src/webrtc/callEventTypes.ts"),u=s("./node_modules/matrix-js-sdk/src/@types/event.ts"),h=s("./node_modules/matrix-js-sdk/src/webrtc/callEventHandler.ts"),m=s("./node_modules/matrix-js-sdk/src/webrtc/groupCallEventHandler.ts"),p=s("./node_modules/matrix-js-sdk/src/utils.ts");class g{constructor(){(0,i.A)(this,"bandwidth",{}),(0,i.A)(this,"bitrate",{}),(0,i.A)(this,"packetLoss",{}),(0,i.A)(this,"transport",[])}}class v{static buildBandwidthReport(e){const t=e.availableIncomingBitrate,s=e.availableOutgoingBitrate;return{download:t?Math.round(t/1e3):0,upload:s?Math.round(s/1e3):0}}}class f{static buildReport(e,t,s,i){const n=null==e?void 0:e.get(t.localCandidateId),r=null==e?void 0:e.get(t.remoteCandidateId);if(r&&n){const e=`${void 0!==r.ip?r.ip:r.address}:${r.port}`,o=`${void 0!==n.ip?n.ip:n.address}:${n.port}`,a=r.protocol;s.some((t=>t.ip===e&&t.type===a&&t.localIp===o))||s.push({ip:e,type:a,localIp:o,isFocus:i,localCandidateType:n.candidateType,remoteCandidateType:r.candidateType,networkType:n.networkType,rtt:t.currentRoundTripTime?1e3*t.currentRoundTripTime:NaN})}return s}}var y=s("./node_modules/sdp-transform/lib/index.js");class S{constructor(){(0,i.A)(this,"ssrcToMid",{local:new Map,remote:new Map})}findMidBySsrc(e,t){let s;return this.ssrcToMid[t].forEach(((t,i)=>{t.find((t=>t==e))&&(s=i)})),s}parse(e,t){const s=(0,y.qg)(e),i=new Map;s.media.forEach((e=>{if(e.mid&&"video"===e.type||"audio"===e.type){var t;const s=[];null===(t=e.ssrcs)||void 0===t||t.forEach((e=>{"cname"===e.attribute&&s.push(`${e.id}`)})),i.set(`${e.mid}`,s)}})),this.ssrcToMid[t]=i}getSsrcToMidMap(e){return this.ssrcToMid[e]}}class b{constructor(e){this.pc=e}getLocalTracks(e){return this.pc.getTransceivers().filter((e=>"sendonly"===e.currentDirection||"sendrecv"===e.currentDirection)).filter((e=>null!==e.sender)).map((e=>e.sender)).map((e=>e.track)).filter((t=>null!==t&&t.kind===e))}getTackById(e){return this.pc.getTransceivers().map((t=>null!==(null==t?void 0:t.sender.track)&&t.sender.track.id===e?t.sender.track:null!==(null==t?void 0:t.receiver.track)&&t.receiver.track.id===e?t.receiver.track:void 0)).find((e=>void 0!==e))}getLocalTrackIdByMid(e){const t=this.pc.getTransceivers().find((t=>t.mid===e));if(void 0!==t&&t.sender&&t.sender.track)return t.sender.track.id}getRemoteTrackIdByMid(e){const t=this.pc.getTransceivers().find((t=>t.mid===e));if(void 0!==t&&t.receiver&&t.receiver.track)return t.receiver.track.id}getActiveSimulcastStreams(){return 3}getTransceiverByTrackId(e){return this.pc.getTransceivers().find((t=>t.receiver.track.id===e||null!==t.sender.track&&t.sender.track.id===e))}}class E{constructor(e,t,s){(0,i.A)(this,"loss",{packetsTotal:0,packetsLost:0,isDownloadStream:!1}),(0,i.A)(this,"bitrate",{download:0,upload:0}),(0,i.A)(this,"resolution",{width:-1,height:-1}),(0,i.A)(this,"audioConcealment",{concealedAudio:0,totalAudioDuration:0}),(0,i.A)(this,"framerate",0),(0,i.A)(this,"jitter",0),(0,i.A)(this,"codec",""),(0,i.A)(this,"isAlive",!0),(0,i.A)(this,"isMuted",!1),(0,i.A)(this,"isEnabled",!0),this.trackId=e,this.type=t,this.kind=s}getType(){return this.type}setLoss(e){this.loss=e}getLoss(){return this.loss}setResolution(e){this.resolution=e}getResolution(){return this.resolution}setFramerate(e){this.framerate=e}getFramerate(){return this.framerate}setBitrate(e){this.bitrate=e}getBitrate(){return this.bitrate}setCodec(e){return this.codec=e,!0}getCodec(){return this.codec}resetBitrate(){this.bitrate={download:0,upload:0}}set alive(e){this.isAlive=e}get alive(){return this.isAlive}set muted(e){this.isMuted=e}get muted(){return this.isMuted}set enabled(e){this.isEnabled=e}get enabled(){return this.isEnabled}setJitter(e){this.jitter=e}getJitter(){return this.jitter}setAudioConcealment(e,t){this.audioConcealment.concealedAudio=e,this.audioConcealment.totalAudioDuration=t}getAudioConcealment(){return this.audioConcealment}}class w{constructor(e,t){(0,i.A)(this,"track2stats",new Map),this.mediaSsrcHandler=e,this.mediaTrackHandler=t}findTrack2Stats(e,t){let s;if(e.trackIdentifier)s=e.trackIdentifier;else if(e.mid)s="remote"===t?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid);else if(e.ssrc){if(!this.mediaSsrcHandler.findMidBySsrc(e.ssrc,t))return;s="remote"===t?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid)}if(!s)return;let i=this.track2stats.get(s);if(!i){const e=this.mediaTrackHandler.getTackById(s);if(void 0===e)return;{const n="audio"===e.kind?e.kind:"video";i=new E(s,t,n),this.track2stats.set(s,i)}}return i}findLocalVideoTrackStats(e){if(0!==this.mediaTrackHandler.getLocalTracks("video").length)return this.findTrack2Stats(e,"local")}getTrack2stats(){return this.track2stats}findTransceiverByTrackId(e){return this.mediaTrackHandler.getTransceiverByTrackId(e)}}class I{static getNonNegativeValue(e){let t=e;return"number"!=typeof t&&(t=Number(t)),isNaN(t)?0:Math.max(0,t)}}class _{static buildFramerateResolution(e,t){const s={height:t.frameHeight,width:t.frameWidth},i=t.framesPerSecond;s.height&&s.width&&e.setResolution(s),e.setFramerate(Math.round(i||0))}static calculateSimulcastFramerate(e,t,s,i){let n=e.getFramerate();if(!n){if(s){const e=t.timestamp-s.timestamp;if(e>0&&t.framesSent){n=(t.framesSent-s.framesSent)/e*1e3}}if(!n)return}n=i?Math.round(n/i):0,e.setFramerate(n)}static buildCodec(e,t,s){const i=null==e?void 0:e.get(s.codecId);if(i){const e=i.mimeType.split("/")[1];e&&t.setCodec(e)}}static buildBitrateReceived(e,t,s){e.setBitrate({download:_.calculateBitrate(t.bytesReceived,s.bytesReceived,t.timestamp,s.timestamp),upload:0})}static buildBitrateSend(e,t,s){e.setBitrate({download:0,upload:this.calculateBitrate(t.bytesSent,s.bytesSent,t.timestamp,s.timestamp)})}static buildPacketsLost(e,t,s){const i="outbound-rtp"===t.type?"packetsSent":"packetsReceived";let n=t[i];(!n||n<0)&&(n=0);const r=I.getNonNegativeValue(s[i]),o=Math.max(0,n-r),a=I.getNonNegativeValue(t.packetsLost),d=I.getNonNegativeValue(s.packetsLost),c=Math.max(0,a-d);e.setLoss({packetsTotal:o+c,packetsLost:c,isDownloadStream:"outbound-rtp"!==t.type})}static calculateBitrate(e,t,s,i){const n=I.getNonNegativeValue(e),r=I.getNonNegativeValue(t),o=Math.max(0,n-r),a=s-i;let d=0;return a>0&&(d=Math.round(8*o/a)),d}static setTrackStatsState(e,t){var s;if(void 0===t)return void(e.alive=!1);const i="remote"===e.getType()?t.receiver.track:null==t||null===(s=t.sender)||void 0===s?void 0:s.track;null!=i&&"ended"!==i.readyState?(e.muted=i.muted,e.enabled=i.enabled,e.alive=!0):e.alive=!1}static buildTrackSummary(e){const t={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},s={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},i=e.filter((e=>"remote"===e.getType())),n=i.filter((e=>"audio"===e.kind));return i.forEach((e=>{const i="video"===e.kind?t:s;var r,o;(i.count++,e.alive&&e.muted&&i.muted++,i.maxJitter<e.getJitter()&&(i.maxJitter=e.getJitter()),i.maxPacketLoss<e.getLoss().packetsLost&&(i.maxPacketLoss=e.getLoss().packetsLost),n.length>0)&&(i.concealedAudio+=null===(r=e.getAudioConcealment())||void 0===r?void 0:r.concealedAudio,i.totalAudio+=null===(o=e.getAudioConcealment())||void 0===o?void 0:o.totalAudioDuration)})),{audioTrackSummary:s,videoTrackSummary:t}}static buildJitter(e,t){if("inbound-rtp"!==t.type)return;const s=null==t?void 0:t.jitter;if(void 0!==s){const t=I.getNonNegativeValue(s);e.setJitter(Math.round(1e3*t))}else e.setJitter(-1)}static buildAudioConcealment(e,t){if("inbound-rtp"!==t.type)return;const s=1e3*(null==t?void 0:t.totalSamplesDuration)/(null==t?void 0:t.totalSamplesReceived)*(null==t?void 0:t.concealedSamples),i=1e3*(null==t?void 0:t.totalSamplesDuration);e.setAudioConcealment(s,i)}}class k{static build(e){const t={},s={download:0,upload:0},i={download:0,upload:0};let n=0,r=0;const o={local:new Map,remote:new Map},a={local:new Map,remote:new Map},d={local:new Map,remote:new Map},c=new Map,l=new Map;let u=0,h=0,m=0,p=0,g=0,v=0;for(const[t,f]of e){const e=f.getLoss(),y=e.isDownloadStream?"download":"upload";if(s[y]+=e.packetsTotal,i[y]+=e.packetsLost,n+=f.getBitrate().download,r+=f.getBitrate().upload,"audio"===f.kind){const e=f.getAudioConcealment();g+=e.concealedAudio,v+=e.totalAudioDuration,u+=f.getBitrate().download,h+=f.getBitrate().upload}else m+=f.getBitrate().download,p+=f.getBitrate().upload;o[f.getType()].set(t,f.getResolution()),a[f.getType()].set(t,f.getFramerate()),d[f.getType()].set(t,f.getCodec()),"remote"===f.getType()&&(c.set(t,f.getJitter()),"audio"===f.kind&&l.set(t,f.getAudioConcealment())),f.resetBitrate()}return t.bitrate={upload:r,download:n},t.bitrate.audio={upload:h,download:u},t.bitrate.video={upload:p,download:m},t.packetLoss={total:k.calculatePacketLoss(i.download+i.upload,s.download+s.upload),download:k.calculatePacketLoss(i.download,s.download),upload:k.calculatePacketLoss(i.upload,s.upload)},t.audioConcealment=l,t.totalAudioConcealment={concealedAudio:g,totalAudioDuration:v},t.framerate=a,t.resolution=o,t.codec=d,t.jitter=c,t}static calculatePacketLoss(e,t){return!t||t<=0||!e||e<=0?0:Math.round(e/t*100)}}class R{static buildCallFeedReport(e,t,s){const i=s.getTransceivers(),n=[];return i.forEach((e=>{var t;const s=null!==(t=e.sender)&&void 0!==t&&t.track?R.buildTrackStats(e.sender.track,"sender"):null,i=R.buildTrackStats(e.receiver.track,"receiver");n.push({mid:null==e.mid?"null":e.mid,direction:e.direction,currentDirection:null==e.currentDirection?"null":e.currentDirection,sender:s,receiver:i})})),{callId:e,opponentMemberId:t,transceiver:n,callFeeds:[]}}static buildTrackStats(e,t="--"){var s,i;const n=null===(s=e.getSettings())||void 0===s?void 0:s.deviceId,r=null===(i=e.getConstraints())||void 0===i?void 0:i.deviceId;return{id:e.id,kind:e.kind,settingDeviceId:n||"unknown",constrainDeviceId:r||"unknown",muted:e.muted,enabled:e.enabled,readyState:e.readyState,label:t}}static expandCallFeedReport(e,t,s="unknown"){return e.callFeeds||(e.callFeeds=[]),t.forEach((t=>{const i=t.stream.getAudioTracks(),n=t.stream.getVideoTracks(),r=i.length>0?R.buildTrackStats(t.stream.getAudioTracks()[0],t.purpose):null,o=n.length>0?R.buildTrackStats(t.stream.getVideoTracks()[0],t.purpose):null,a={stream:t.stream.id,type:t.isLocal()?"local":"remote",audio:r,video:o,purpose:t.purpose,prefix:s,isVideoMuted:t.isVideoMuted(),isAudioMuted:t.isAudioMuted()};e.callFeeds.push(a)})),e}}function T(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function C(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?T(Object(s),!0).forEach((function(t){(0,i.A)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):T(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class A{constructor(e,t,s,n,r=!0){(0,i.A)(this,"isActive",!0),(0,i.A)(this,"previousStatsReport",void 0),(0,i.A)(this,"currentStatsReport",void 0),(0,i.A)(this,"connectionStats",new g),(0,i.A)(this,"trackStats",void 0),this.callId=e,this.opponentMemberId=t,this.pc=s,this.emitter=n,this.isFocus=r,s.addEventListener("signalingstatechange",this.onSignalStateChange.bind(this)),this.trackStats=new w(new S,new b(s))}async processStats(e,t){const s={isFirstCollection:void 0===this.previousStatsReport,receivedMedia:0,receivedAudioMedia:0,receivedVideoMedia:0,audioTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0},videoTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0}};if(this.isActive){const i=this.pc.getStats();if("function"==typeof(null==i?void 0:i.then))return i.then((i=>{var n,r;this.currentStatsReport="function"==typeof(null==i?void 0:i.result)?i.result():i;try{this.processStatsReport(e,t)}catch(e){return this.handleError(e),s}this.previousStatsReport=this.currentStatsReport,s.receivedMedia=this.connectionStats.bitrate.download,s.receivedAudioMedia=(null===(n=this.connectionStats.bitrate.audio)||void 0===n?void 0:n.download)||0,s.receivedVideoMedia=(null===(r=this.connectionStats.bitrate.video)||void 0===r?void 0:r.download)||0;const o=_.buildTrackSummary(Array.from(this.trackStats.getTrack2stats().values()));return C(C({},s),{},{audioTrackSummary:o.audioTrackSummary,videoTrackSummary:o.videoTrackSummary})})).catch((e=>(this.handleError(e),s)));this.isActive=!1}return Promise.resolve(s)}processStatsReport(e,t){var s;const i=new Map;i.callId=this.callId,i.opponentMemberId=this.opponentMemberId,null===(s=this.currentStatsReport)||void 0===s||s.forEach((e=>{const t=this.previousStatsReport?this.previousStatsReport.get(e.id):null;if("candidate-pair"===e.type&&e.nominated&&"succeeded"===e.state)this.connectionStats.bandwidth=v.buildBandwidthReport(e),this.connectionStats.transport=f.buildReport(this.currentStatsReport,e,this.connectionStats.transport,this.isFocus);else if("inbound-rtp"===e.type||"outbound-rtp"===e.type){const s=this.trackStats.findTrack2Stats(e,"inbound-rtp"===e.type?"remote":"local");if(!s)return;if(t&&_.buildPacketsLost(s,e,t),"inbound-rtp"===e.type){_.buildFramerateResolution(s,e),t&&_.buildBitrateReceived(s,e,t);const i=this.trackStats.findTransceiverByTrackId(s.trackId);_.setTrackStatsState(s,i),_.buildJitter(s,e),_.buildAudioConcealment(s,e)}else t&&(i.set(s.trackId,I.getNonNegativeValue(e.bytesSent)),_.buildBitrateSend(s,e,t));_.buildCodec(this.currentStatsReport,s,e)}else if("track"===e.type&&"video"===e.kind&&!e.remoteSource){const s=this.trackStats.findLocalVideoTrackStats(e);if(!s)return;_.buildFramerateResolution(s,e),_.calculateSimulcastFramerate(s,e,t,this.trackStats.mediaTrackHandler.getActiveSimulcastStreams())}})),this.emitter.emitByteSendReport(i),this.emitter.emitCallFeedReport(R.buildCallFeedReport(this.callId,this.opponentMemberId,this.pc)),this.processAndEmitConnectionStatsReport()}setActive(e){this.isActive=e}getActive(){return this.isActive}handleError(e){this.isActive=!1,d.v.warn(`CallStatsReportGatherer ${this.callId} processStatsReport fails and set to inactive ${e}`)}processAndEmitConnectionStatsReport(){const e=k.build(this.trackStats.getTrack2stats());e.callId=this.callId,e.opponentMemberId=this.opponentMemberId,this.connectionStats.bandwidth=e.bandwidth,this.connectionStats.bitrate=e.bitrate,this.connectionStats.packetLoss=e.packetLoss,this.emitter.emitConnectionStatsReport(C(C({},e),{},{transport:this.connectionStats.transport})),this.connectionStats.transport=[]}stopProcessingStats(){}onSignalStateChange(){"stable"===this.pc.signalingState&&(this.pc.currentRemoteDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentRemoteDescription.sdp,"remote"),this.pc.currentLocalDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentLocalDescription.sdp,"local"))}setOpponentMemberId(e){this.opponentMemberId=e}}var O=s("./node_modules/matrix-js-sdk/src/webrtc/stats/statsReport.ts");class M extends n.X{emitByteSendReport(e){this.emit(O.I.BYTE_SENT_STATS,e)}emitConnectionStatsReport(e){this.emit(O.I.CONNECTION_STATS,e)}emitCallFeedReport(e){this.emit(O.I.CALL_FEED_REPORT,e)}emitSummaryStatsReport(e){this.emit(O.I.SUMMARY_STATS,e)}}class x{constructor(e){this.emitter=e}build(e){const t=e.filter((e=>!e.isFirstCollection)),s=t.length,i=e.length;if(0===s)return;const n={receivedAudio:0,receivedVideo:0,receivedMedia:0,concealedAudio:0,totalAudio:0};let r=0,o=0;t.forEach((e=>{this.countTrackListReceivedMedia(n,e),this.countConcealedAudio(n,e),r=this.buildMaxJitter(r,e),o=this.buildMaxPacketLoss(o,e)}));const a={percentageReceivedMedia:Number((n.receivedMedia/s).toFixed(5)),percentageReceivedVideoMedia:Number((n.receivedVideo/s).toFixed(5)),percentageReceivedAudioMedia:Number((n.receivedAudio/s).toFixed(5)),maxJitter:r,maxPacketLoss:o,percentageConcealedAudio:Number(n.totalAudio>0?(n.concealedAudio/n.totalAudio).toFixed(5):0),peerConnections:i};this.emitter.emitSummaryStatsReport(a)}static extendSummaryReport(e,t){const s=[],i=[];for(const e of t){i.push(e);for(const t of e[1])s.push(t)}e.opponentDevicesInCall=Math.max(0,s.length-1),e.opponentUsersInCall=Math.max(0,i.length-1),e.diffDevicesToPeerConnections=Math.max(0,s.length-1)-e.peerConnections,e.ratioPeerConnectionToDevices=0==Math.max(0,s.length-1)?0:e.peerConnections/(s.length-1)}countTrackListReceivedMedia(e,t){let s=!1,i=!1;(t.receivedAudioMedia>0||0===t.audioTrackSummary.count)&&(e.receivedAudio++,s=!0),(t.receivedVideoMedia>0||0===t.videoTrackSummary.count||t.videoTrackSummary.muted>0&&t.videoTrackSummary.muted===t.videoTrackSummary.count)&&(e.receivedVideo++,i=!0),i&&s&&e.receivedMedia++}buildMaxJitter(e,t){return e<t.videoTrackSummary.maxJitter&&(e=t.videoTrackSummary.maxJitter),e<t.audioTrackSummary.maxJitter&&(e=t.audioTrackSummary.maxJitter),e}buildMaxPacketLoss(e,t){return e<t.videoTrackSummary.maxPacketLoss&&(e=t.videoTrackSummary.maxPacketLoss),e<t.audioTrackSummary.maxPacketLoss&&(e=t.audioTrackSummary.maxPacketLoss),e}countConcealedAudio(e,t){e.concealedAudio+=t.audioTrackSummary.concealedAudio,e.totalAudio+=t.audioTrackSummary.totalAudio}}class D{constructor(e,t,s=1e4){(0,i.A)(this,"timer",void 0),(0,i.A)(this,"gatherers",new Map),(0,i.A)(this,"reports",new M),(0,i.A)(this,"summaryStatsReportGatherer",new x(this.reports)),this.groupCallId=e,this.userId=t,this.interval=s}start(){void 0===this.timer&&this.interval>0&&(this.timer=setInterval((()=>{this.processStats()}),this.interval))}stop(){void 0!==this.timer&&(clearInterval(this.timer),this.gatherers.forEach((e=>e.stopProcessingStats())))}hasStatsReportGatherer(e){return this.gatherers.has(e)}addStatsReportGatherer(e,t,s){return!this.hasStatsReportGatherer(e)&&(this.gatherers.set(e,new A(e,t,s,this.reports)),!0)}removeStatsReportGatherer(e){return this.gatherers.delete(e)}getStatsReportGatherer(e){return this.hasStatsReportGatherer(e)?this.gatherers.get(e):void 0}updateOpponentMember(e,t){var s;null===(s=this.getStatsReportGatherer(e))||void 0===s||s.setOpponentMemberId(t)}processStats(){const e=[];this.gatherers.forEach((t=>{e.push(t.processStats(this.groupCallId,this.userId))})),Promise.all(e).then((e=>this.summaryStatsReportGatherer.build(e))).catch((e=>{d.v.error("Could not build summary stats report",e)}))}setInterval(e){this.interval=e}}var P=s("./node_modules/matrix-js-sdk/src/@types/membership.ts");function U(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function j(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?U(Object(s),!0).forEach((function(t){(0,i.A)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):U(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let L=function(e){return e.Ring="m.ring",e.Prompt="m.prompt",e.Room="m.room",e}({}),N=function(e){return e.Video="m.video",e.Voice="m.voice",e}({}),K=function(e){return e.CallEnded="call_ended",e}({}),B=function(e){return e.GroupCallStateChanged="group_call_state_changed",e.ActiveSpeakerChanged="active_speaker_changed",e.CallsChanged="calls_changed",e.UserMediaFeedsChanged="user_media_feeds_changed",e.ScreenshareFeedsChanged="screenshare_feeds_changed",e.LocalScreenshareStateChanged="local_screenshare_state_changed",e.LocalMuteStateChanged="local_mute_state_changed",e.ParticipantsChanged="participants_changed",e.Error="group_call_error",e}({}),F=function(e){return e.ConnectionStats="GroupCall.connection_stats",e.ByteSentStats="GroupCall.byte_sent_stats",e.SummaryStats="GroupCall.summary_stats",e.CallFeedStats="GroupCall.call_feed_stats",e}({}),$=function(e){return e.NoUserMedia="no_user_media",e.UnknownDevice="unknown_device",e.PlaceCallFailed="place_call_failed",e}({});class q extends Error{constructor(e,t,s){s?(super(t+": "+s),(0,i.A)(this,"code",void 0)):(super(t),(0,i.A)(this,"code",void 0)),this.code=e}}class V extends q{constructor(e){super($.UnknownDevice,"No device found for "+e),this.userId=e}}Error;let G=function(e){return e.LocalCallFeedUninitialized="local_call_feed_uninitialized",e.InitializingLocalCallFeed="initializing_local_call_feed",e.LocalCallFeedInitialized="local_call_feed_initialized",e.Entered="entered",e.Ended="ended",e}({});const H=36e5;function W(e){var t;return(null===(t=e.getOpponentMember())||void 0===t?void 0:t.userId)||e.invitee||null}class J extends n.X{constructor(e,t,s,n,l,h,m,p,g,v=!1,f){var y,S;super(),(0,i.A)(this,"activeSpeakerInterval",1e3),(0,i.A)(this,"retryCallInterval",5e3),(0,i.A)(this,"participantTimeout",15e3),(0,i.A)(this,"pttMaxTransmitTime",2e4),(0,i.A)(this,"activeSpeaker",void 0),(0,i.A)(this,"localCallFeed",void 0),(0,i.A)(this,"localScreenshareFeed",void 0),(0,i.A)(this,"localDesktopCapturerSourceId",void 0),(0,i.A)(this,"userMediaFeeds",[]),(0,i.A)(this,"screenshareFeeds",[]),(0,i.A)(this,"groupCallId",void 0),(0,i.A)(this,"allowCallWithoutVideoAndAudio",void 0),(0,i.A)(this,"calls",new Map),(0,i.A)(this,"callHandlers",new Map),(0,i.A)(this,"activeSpeakerLoopInterval",void 0),(0,i.A)(this,"retryCallLoopInterval",void 0),(0,i.A)(this,"retryCallCounts",new Map),(0,i.A)(this,"reEmitter",void 0),(0,i.A)(this,"transmitTimer",null),(0,i.A)(this,"participantsExpirationTimer",null),(0,i.A)(this,"resendMemberStateTimer",null),(0,i.A)(this,"initWithAudioMuted",!1),(0,i.A)(this,"initWithVideoMuted",!1),(0,i.A)(this,"initCallFeedPromise",void 0),(0,i.A)(this,"_livekitServiceURL",void 0),(0,i.A)(this,"stats",void 0),(0,i.A)(this,"statsCollectIntervalTime",0),(0,i.A)(this,"onConnectionStats",(e=>{this.emit(F.ConnectionStats,{report:e})})),(0,i.A)(this,"onByteSentStats",(e=>{this.emit(F.ByteSentStats,{report:e})})),(0,i.A)(this,"onSummaryStats",(e=>{x.extendSummaryReport(e,this.participants),this.emit(F.SummaryStats,{report:e})})),(0,i.A)(this,"onCallFeedReport",(e=>{this.localCallFeed&&(e=R.expandCallFeedReport(e,[this.localCallFeed],"from-local-feed"));const t=[];this.forEachCall((s=>{s.callId===e.callId&&s.getFeeds().forEach((e=>t.push(e)))})),e=R.expandCallFeedReport(e,t,"from-call-feed"),this.emit(F.CallFeedStats,{report:e})})),(0,i.A)(this,"_state",G.LocalCallFeedUninitialized),(0,i.A)(this,"_participants",new Map),(0,i.A)(this,"_creationTs",null),(0,i.A)(this,"_enteredViaAnotherSession",!1),(0,i.A)(this,"onIncomingCall",(e=>{var t,s;if(e.roomId!==this.room.roomId)return;if(e.state!==o.iP.Ringing)return void d.v.warn(`GroupCall ${this.groupCallId} onIncomingCall() incoming call no longer in ringing state - ignoring`);if(!e.groupCallId||e.groupCallId!==this.groupCallId)return d.v.log(`GroupCall ${this.groupCallId} onIncomingCall() ignored because it doesn't match the current group call`),void e.reject();const i=null===(t=e.getOpponentMember())||void 0===t?void 0:t.userId;if(void 0===i)return void d.v.warn(`GroupCall ${this.groupCallId} onIncomingCall() incoming call with no member - ignoring`);if(this.useLivekit)return void d.v.info("Received incoming call whilst in signaling-only mode! Ignoring.");const n=null!==(s=this.calls.get(i))&&void 0!==s?s:new Map,r=n.get(e.getOpponentDeviceId());if((null==r?void 0:r.callId)===e.callId)return;d.v.log(`GroupCall ${this.groupCallId} onIncomingCall() incoming call (userId=${i}, callId=${e.callId})`),r&&r.hangup(o.Il.Replaced,!1),n.set(e.getOpponentDeviceId(),e),this.calls.set(i,n),this.initCall(e);const a=this.getLocalFeeds().map((e=>e.clone()));if(!this.callExpected(e))for(const e of a)(0,o.ms)(e.stream.getAudioTracks(),!1),(0,o.ms)(e.stream.getVideoTracks(),!1);e.answerWithCallFeeds(a),this.emit(B.CallsChanged,this.calls)})),(0,i.A)(this,"onRetryCallLoop",(()=>{let e=!1;for(const[{userId:i},n]of this.participants){const r=this.calls.get(i);let o=this.retryCallCounts.get(i);for(const[a,d]of n){var t,s;const n=null==r?void 0:r.get(a),c=null!==(t=null===(s=o)||void 0===s?void 0:s.get(a))&&void 0!==t?t:0;(null==n?void 0:n.getOpponentSessionId())!==d.sessionId&&this.wantsOutgoingCall(i,a)&&c<3&&(void 0===o&&(o=new Map,this.retryCallCounts.set(i,o)),o.set(a,c+1),e=!0)}}e&&this.placeOutgoingCalls()})),(0,i.A)(this,"onCallFeedsChanged",(e=>{const t=W(e),s=e.getOpponentDeviceId();if(!t)throw new Error("Cannot change call feeds without user id");const i=this.getUserMediaFeed(t,s),n=e.remoteUsermediaFeed,r=n!==i,o=this.calls.get(t),a=null==o?void 0:o.get(s);if((null==a?void 0:a.callId)!==e.callId)return;r&&(!i&&n?this.addUserMediaFeed(n):i&&n?this.replaceUserMediaFeed(i,n):i&&!n&&this.removeUserMediaFeed(i));const d=this.getScreenshareFeed(t,s),c=e.remoteScreensharingFeed;c!==d&&(!d&&c?this.addScreenshareFeed(c):d&&c?this.replaceScreenshareFeed(d,c):d&&!c&&this.removeScreenshareFeed(d))})),(0,i.A)(this,"onCallStateChanged",((e,t,s)=>{var i;if(t===o.iP.Ended)return;const n=this.localCallFeed.isAudioMuted();e.localUsermediaStream&&e.isMicrophoneMuted()!==n&&e.setMicrophoneMuted(n);const r=this.localCallFeed.isVideoMuted();e.localUsermediaStream&&e.isLocalVideoMuted()!==r&&e.setLocalVideoMuted(r);const a=null===(i=e.getOpponentMember())||void 0===i?void 0:i.userId;if(t===o.iP.Connected&&a){const t=this.retryCallCounts.get(a);null==t||t.delete(e.getOpponentDeviceId()),0===(null==t?void 0:t.size)&&this.retryCallCounts.delete(a)}})),(0,i.A)(this,"onCallHangup",(e=>{var t,s;if(e.hangupReason===o.Il.Replaced)return;const i=null!==(t=null===(s=e.getOpponentMember())||void 0===s?void 0:s.userId)&&void 0!==t?t:this.room.getMember(e.invitee).userId,n=this.calls.get(i);(null==n?void 0:n.get(e.getOpponentDeviceId()))===e&&(this.disposeCall(e,e.hangupReason),n.delete(e.getOpponentDeviceId()),0===n.size&&this.calls.delete(i),this.emit(B.CallsChanged,this.calls))})),(0,i.A)(this,"onCallReplaced",((e,t)=>{const s=e.getOpponentMember().userId;let i=this.calls.get(s);void 0===i&&(i=new Map,this.calls.set(s,i)),e.hangup(o.Il.Replaced,!1),this.initCall(t),i.set(e.getOpponentDeviceId(),t),this.emit(B.CallsChanged,this.calls)})),(0,i.A)(this,"onActiveSpeakerLoop",(()=>{let e,t;for(const s of this.userMediaFeeds){if(s.isLocal()&&this.userMediaFeeds.length>1)continue;const i=s.speakingVolumeSamples.reduce(((e,t)=>e+Math.max(t,r.Tw)))/s.speakingVolumeSamples.length;(!e||i>e)&&(e=i,t=s)}t&&this.activeSpeaker!==t&&e&&e>r.Tw&&(this.activeSpeaker=t,this.emit(B.ActiveSpeakerChanged,this.activeSpeaker))})),(0,i.A)(this,"onRoomState",(()=>this.updateParticipants())),(0,i.A)(this,"onParticipantsChanged",(()=>{this.forEachCall((e=>{const t=this.callExpected(e);for(const s of e.getLocalFeeds())(0,o.ms)(s.stream.getAudioTracks(),!s.isAudioMuted()&&t),(0,o.ms)(s.stream.getVideoTracks(),!s.isVideoMuted()&&t)})),this.state!==G.Entered||this.useLivekit||this.placeOutgoingCalls()})),(0,i.A)(this,"onStateChanged",((e,t)=>{e!==G.Entered&&t!==G.Entered&&e!==G.Ended||(this.updateParticipants(),this.updateMemberState().catch((e=>d.v.error(`GroupCall ${this.groupCallId} onStateChanged() failed to update member state devices"`,e))))})),(0,i.A)(this,"onLocalFeedsChanged",(()=>{this.state===G.Entered&&this.updateMemberState().catch((e=>d.v.error(`GroupCall ${this.groupCallId} onLocalFeedsChanged() failed to update member state feeds`,e)))})),this.client=e,this.room=t,this.type=s,this.isPtt=n,this.intent=l,this.dataChannelsEnabled=m,this.dataChannelOptions=p,this.useLivekit=v,this.reEmitter=new c.K(this),this.groupCallId=null!=h?h:(0,o.WE)(),this._livekitServiceURL=f,this.creationTs=null!==(y=null===(S=t.currentState.getStateEvents(u.Bx.GroupCallPrefix,this.groupCallId))||void 0===S?void 0:S.getTs())&&void 0!==y?y:null,this.updateParticipants(),t.on(a.f.Update,this.onRoomState),this.on(B.ParticipantsChanged,this.onParticipantsChanged),this.on(B.GroupCallStateChanged,this.onStateChanged),this.on(B.LocalScreenshareStateChanged,this.onLocalFeedsChanged),this.allowCallWithoutVideoAndAudio=!!g}async create(){return this.creationTs=Date.now(),this.client.groupCallEventHandler.groupCalls.set(this.room.roomId,this),this.client.emit(m.o.Outgoing,this),await this.sendCallStateEvent(),this}async sendCallStateEvent(){const e={"m.intent":this.intent,"m.type":this.type,"io.element.ptt":this.isPtt,dataChannelsEnabled:this.dataChannelsEnabled,dataChannelOptions:this.dataChannelsEnabled?this.dataChannelOptions:void 0};this.livekitServiceURL&&(e["io.element.livekit_service_url"]=this.livekitServiceURL),await this.client.sendStateEvent(this.room.roomId,u.Bx.GroupCallPrefix,e,this.groupCallId)}get livekitServiceURL(){return this._livekitServiceURL}updateLivekitServiceURL(e){return this._livekitServiceURL=e,this.sendCallStateEvent()}get state(){return this._state}set state(e){const t=this._state;e!==t&&(this._state=e,this.emit(B.GroupCallStateChanged,e,t))}get participants(){return this._participants}set participants(e){const t=this._participants,s=(e,t)=>e.sessionId===t.sessionId&&e.screensharing===t.screensharing;(0,p.kg)(e,t,((e,t)=>(0,p.kg)(e,t,s)))||(this._participants=e,this.emit(B.ParticipantsChanged,e))}get creationTs(){return this._creationTs}set creationTs(e){this._creationTs=e}get enteredViaAnotherSession(){return this._enteredViaAnotherSession}set enteredViaAnotherSession(e){this._enteredViaAnotherSession=e,this.updateParticipants()}forEachCall(e){for(const t of this.calls.values())for(const s of t.values())e(s)}getLocalFeeds(){const e=[];return this.localCallFeed&&e.push(this.localCallFeed),this.localScreenshareFeed&&e.push(this.localScreenshareFeed),e}hasLocalParticipant(){var e,t;return null!==(e=null===(t=this.participants.get(this.room.getMember(this.client.getUserId())))||void 0===t?void 0:t.has(this.client.getDeviceId()))&&void 0!==e&&e}callExpected(e){var t;const s=W(e),i=null===s?null:this.room.getMember(s),n=e.getOpponentDeviceId();return null!==i&&void 0!==n&&void 0!==(null===(t=this.participants.get(i))||void 0===t?void 0:t.get(n))}async initLocalCallFeed(){if(this.useLivekit)d.v.info("Livekit group call: not starting local call feed.");else{if(this.state!==G.LocalCallFeedUninitialized)throw new Error(`Cannot initialize local call feed in the "${this.state}" state.`);if(this.state=G.InitializingLocalCallFeed,this.initCallFeedPromise)return this.initCallFeedPromise;try{this.initCallFeedPromise=this.initLocalCallFeedInternal(),await this.initCallFeedPromise}finally{this.initCallFeedPromise=void 0}}}async initLocalCallFeedInternal(){let e;d.v.log(`GroupCall ${this.groupCallId} initLocalCallFeedInternal() running`);try{e=await this.client.getMediaHandler().getUserMediaStream(!0,this.type===N.Video)}catch(t){if(!this.allowCallWithoutVideoAndAudio)throw this.state=G.LocalCallFeedUninitialized,t;e=new MediaStream}if(this._state!==G.InitializingLocalCallFeed)throw this.client.getMediaHandler().stopUserMediaStream(e),new Error("Group call disposed while gathering media stream");const t=new r.Hh({client:this.client,roomId:this.room.roomId,userId:this.client.getUserId(),deviceId:this.client.getDeviceId(),stream:e,purpose:l.h.Usermedia,audioMuted:this.initWithAudioMuted||0===e.getAudioTracks().length||this.isPtt,videoMuted:this.initWithVideoMuted||0===e.getVideoTracks().length});(0,o.ms)(e.getAudioTracks(),!t.isAudioMuted()),(0,o.ms)(e.getVideoTracks(),!t.isVideoMuted()),this.localCallFeed=t,this.addUserMediaFeed(t),this.state=G.LocalCallFeedInitialized}async updateLocalUsermediaStream(e){if(this.localCallFeed){const t=this.localCallFeed.stream;this.localCallFeed.setNewStream(e);const s=this.localCallFeed.isAudioMuted(),i=this.localCallFeed.isVideoMuted();d.v.log(`GroupCall ${this.groupCallId} updateLocalUsermediaStream() (oldStreamId=${t.id}, newStreamId=${e.id}, micShouldBeMuted=${s}, vidShouldBeMuted=${i})`),(0,o.ms)(e.getAudioTracks(),!s),(0,o.ms)(e.getVideoTracks(),!i),this.client.getMediaHandler().stopUserMediaStream(t)}}async enter(){if(this.state===G.LocalCallFeedUninitialized)await this.initLocalCallFeed();else if(this.state!==G.LocalCallFeedInitialized)throw new Error(`Cannot enter call in the "${this.state}" state`);d.v.log(`GroupCall ${this.groupCallId} enter() running`),this.state=G.Entered,this.client.on(h.B.Incoming,this.onIncomingCall);for(const e of this.client.callEventHandler.calls.values())this.onIncomingCall(e);this.useLivekit||(this.retryCallLoopInterval=setInterval(this.onRetryCallLoop,this.retryCallInterval),this.activeSpeaker=void 0,this.onActiveSpeakerLoop(),this.activeSpeakerLoopInterval=setInterval(this.onActiveSpeakerLoop,this.activeSpeakerInterval))}dispose(){var e;this.localCallFeed&&(this.removeUserMediaFeed(this.localCallFeed),this.localCallFeed=void 0),this.localScreenshareFeed&&(this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0),this.client.getMediaHandler().stopAllStreams(),null!==this.transmitTimer&&(clearTimeout(this.transmitTimer),this.transmitTimer=null),void 0!==this.retryCallLoopInterval&&(clearInterval(this.retryCallLoopInterval),this.retryCallLoopInterval=void 0),null!==this.participantsExpirationTimer&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===G.Entered&&(this.forEachCall((e=>e.hangup(o.Il.UserHangup,!1))),this.activeSpeaker=void 0,clearInterval(this.activeSpeakerLoopInterval),this.retryCallCounts.clear(),clearInterval(this.retryCallLoopInterval),this.client.removeListener(h.B.Incoming,this.onIncomingCall),null===(e=this.stats)||void 0===e||e.stop())}leave(){this.dispose(),this.state=G.LocalCallFeedUninitialized}async terminate(e=!0){if(this.dispose(),this.room.off(a.f.Update,this.onRoomState),this.client.groupCallEventHandler.groupCalls.delete(this.room.roomId),this.client.emit(m.o.Ended,this),this.state=G.Ended,e){const e=this.room.currentState.getStateEvents(u.Bx.GroupCallPrefix,this.groupCallId);await this.client.sendStateEvent(this.room.roomId,u.Bx.GroupCallPrefix,j(j({},e.getContent()),{},{"m.terminated":K.CallEnded}),this.groupCallId)}}isLocalVideoMuted(){return!this.localCallFeed||this.localCallFeed.isVideoMuted()}isMicrophoneMuted(){return!this.localCallFeed||this.localCallFeed.isAudioMuted()}async setMicrophoneMuted(e){if(!e&&!await this.client.getMediaHandler().hasAudioDevice())return!1;const t=!e&&this.isPtt;this.isPtt&&(!e&&this.isMicrophoneMuted()?this.transmitTimer=setTimeout((()=>{this.setMicrophoneMuted(!0)}),this.pttMaxTransmitTime):e&&!this.isMicrophoneMuted()&&(null!==this.transmitTimer&&clearTimeout(this.transmitTimer),this.transmitTimer=null)),this.forEachCall((t=>{var s;return null===(s=t.localUsermediaFeed)||void 0===s?void 0:s.setAudioVideoMuted(e,null)}));const s=async()=>{const e=[];this.forEachCall((t=>e.push(t.sendMetadataUpdate()))),await Promise.all(e).catch((e=>d.v.info(`GroupCall ${this.groupCallId} setMicrophoneMuted() failed to send some metadata updates`,e)))};if(t&&await s(),this.localCallFeed){d.v.log(`GroupCall ${this.groupCallId} setMicrophoneMuted() (streamId=${this.localCallFeed.stream.id}, muted=${e})`);if(!await this.checkAudioPermissionIfNecessary(e))return!1;this.localCallFeed.setAudioVideoMuted(e,null),(0,o.ms)(this.localCallFeed.stream.getAudioTracks(),!e)}else d.v.log(`GroupCall ${this.groupCallId} setMicrophoneMuted() no stream muted (muted=${e})`),this.initWithAudioMuted=e;return this.forEachCall((t=>(0,o.ms)(t.localUsermediaFeed.stream.getAudioTracks(),!e&&this.callExpected(t)))),this.emit(B.LocalMuteStateChanged,e,this.isLocalVideoMuted()),t||await s(),!0}async checkAudioPermissionIfNecessary(e){try{if(!e&&this.localCallFeed&&!this.localCallFeed.hasAudioTrack){const t=await this.client.getMediaHandler().getUserMediaStream(!0,!this.localCallFeed.isVideoMuted());if(0===(null==t?void 0:t.getTracks().length))return d.v.log(`GroupCall ${this.groupCallId} setMicrophoneMuted() no device to receive local stream, muted=${e}`),!1}}catch(t){return d.v.log(`GroupCall ${this.groupCallId} setMicrophoneMuted() no device or permission to receive local stream, muted=${e}`),!1}return!0}async setLocalVideoMuted(e){if(!e&&!await this.client.getMediaHandler().hasVideoDevice())return!1;if(this.localCallFeed){d.v.log(`GroupCall ${this.groupCallId} setLocalVideoMuted() (stream=${this.localCallFeed.stream.id}, muted=${e})`);try{const t=await this.client.getMediaHandler().getUserMediaStream(!0,!e);await this.updateLocalUsermediaStream(t),this.localCallFeed.setAudioVideoMuted(null,e),(0,o.ms)(this.localCallFeed.stream.getVideoTracks(),!e)}catch(t){return d.v.log(`GroupCall ${this.groupCallId} setLocalVideoMuted() no device or permission to receive local stream, muted=${e}`),!1}}else d.v.log(`GroupCall ${this.groupCallId} setLocalVideoMuted() no stream muted (muted=${e})`),this.initWithVideoMuted=e;const t=[];return this.forEachCall((s=>t.push(s.setLocalVideoMuted(e)))),await Promise.all(t),this.forEachCall((t=>(0,o.ms)(t.localUsermediaFeed.stream.getVideoTracks(),!e&&this.callExpected(t)))),this.emit(B.LocalMuteStateChanged,this.isMicrophoneMuted(),e),!0}async setScreensharingEnabled(e,t={}){if(e===this.isScreensharing())return e;if(!e)return this.forEachCall((e=>{e.localScreensharingFeed&&e.removeLocalFeed(e.localScreensharingFeed)})),this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0,this.emit(B.LocalScreenshareStateChanged,!1,void 0,void 0),!1;try{d.v.log(`GroupCall ${this.groupCallId} setScreensharingEnabled() is asking for screensharing permissions`);const e=await this.client.getMediaHandler().getScreensharingStream(t);for(const t of e.getTracks()){const e=()=>{this.setScreensharingEnabled(!1),t.removeEventListener("ended",e)};t.addEventListener("ended",e)}return d.v.log(`GroupCall ${this.groupCallId} setScreensharingEnabled() granted screensharing permissions. Setting screensharing enabled on all calls`),this.localDesktopCapturerSourceId=t.desktopCapturerSourceId,this.localScreenshareFeed=new r.Hh({client:this.client,roomId:this.room.roomId,userId:this.client.getUserId(),deviceId:this.client.getDeviceId(),stream:e,purpose:l.h.Screenshare,audioMuted:!1,videoMuted:!1}),this.addScreenshareFeed(this.localScreenshareFeed),this.emit(B.LocalScreenshareStateChanged,!0,this.localScreenshareFeed,this.localDesktopCapturerSourceId),this.forEachCall((e=>e.pushLocalFeed(this.localScreenshareFeed.clone()))),!0}catch(e){if(t.throwOnFail)throw e;return d.v.error(`GroupCall ${this.groupCallId} setScreensharingEnabled() enabling screensharing error`,e),this.emit(B.Error,new q($.NoUserMedia,"Failed to get screen-sharing stream: ",e)),!1}}isScreensharing(){return!!this.localScreenshareFeed}wantsOutgoingCall(e,t){const s=this.client.getUserId(),i=this.client.getDeviceId();return e>=s&&(e!==s||t>i)}placeOutgoingCalls(){let e=!1;for(const[{userId:s},i]of this.participants){var t;const n=null!==(t=this.calls.get(s))&&void 0!==t?t:new Map;for(const[t,r]of i){const i=n.get(t);if((null==i?void 0:i.getOpponentSessionId())!==r.sessionId&&this.wantsOutgoingCall(s,t)){e=!0,void 0!==i&&(d.v.debug(`GroupCall ${this.groupCallId} placeOutgoingCalls() replacing call (userId=${s}, deviceId=${t}, callId=${i.callId})`),i.hangup(o.Il.NewSession,!1));const a=(0,o.sv)(this.client,this.room.roomId,{invitee:s,opponentDeviceId:t,opponentSessionId:r.sessionId,groupCallId:this.groupCallId});null===a?(d.v.error(`GroupCall ${this.groupCallId} placeOutgoingCalls() failed to create call (userId=${s}, device=${t})`),n.delete(t)):(this.initCall(a),n.set(t,a),d.v.debug(`GroupCall ${this.groupCallId} placeOutgoingCalls() placing call (userId=${s}, deviceId=${t}, sessionId=${r.sessionId})`),a.placeCallWithCallFeeds(this.getLocalFeeds().map((e=>e.clone())),r.screensharing).then((()=>{this.dataChannelsEnabled&&a.createDataChannel("datachannel",this.dataChannelOptions)})).catch((e=>{d.v.warn(`GroupCall ${this.groupCallId} placeOutgoingCalls() failed to place call (userId=${s})`,e),e instanceof o.RA&&e.code===$.UnknownDevice?this.emit(B.Error,e):this.emit(B.Error,new q($.PlaceCallFailed,`Failed to place call to ${s}`)),a.hangup(o.Il.SignallingFailed,!1),n.get(t)===a&&n.delete(t)})))}}n.size>0?this.calls.set(s,n):this.calls.delete(s)}e&&this.emit(B.CallsChanged,this.calls)}getMemberStateEvents(e){return void 0===e?this.room.currentState.getStateEvents(u.Bx.GroupCallMemberPrefix):this.room.currentState.getStateEvents(u.Bx.GroupCallMemberPrefix,e)}initCall(e){const t=W(e);if(!t)throw new Error("Cannot init call without user id");const s=()=>this.onCallFeedsChanged(e),i=(t,s)=>this.onCallStateChanged(e,t,s),n=this.onCallHangup,r=t=>this.onCallReplaced(e,t);let a=this.callHandlers.get(t);void 0===a&&(a=new Map,this.callHandlers.set(t,a)),a.set(e.getOpponentDeviceId(),{onCallFeedsChanged:s,onCallStateChanged:i,onCallHangup:n,onCallReplaced:r}),e.on(o.$E.FeedsChanged,s),e.on(o.$E.State,i),e.on(o.$E.Hangup,n),e.on(o.$E.Replaced,r),e.isPtt=this.isPtt,this.reEmitter.reEmit(e,Object.values(o.$E)),e.initStats(this.getGroupCallStats()),s()}disposeCall(e,t){const s=W(e),i=e.getOpponentDeviceId();if(!s)throw new Error("Cannot dispose call without user id");const n=this.callHandlers.get(s),{onCallFeedsChanged:r,onCallStateChanged:a,onCallHangup:d,onCallReplaced:c}=n.get(i);if(e.removeListener(o.$E.FeedsChanged,r),e.removeListener(o.$E.State,a),e.removeListener(o.$E.Hangup,d),e.removeListener(o.$E.Replaced,c),n.delete(s),0===n.size&&this.callHandlers.delete(s),e.hangupReason===o.Il.Replaced)return;const l=this.getUserMediaFeed(s,i);l&&this.removeUserMediaFeed(l);const u=this.getScreenshareFeed(s,i);u&&this.removeScreenshareFeed(u)}getUserMediaFeed(e,t){return this.userMediaFeeds.find((s=>s.userId===e&&s.deviceId===t))}addUserMediaFeed(e){this.userMediaFeeds.push(e),e.measureVolumeActivity(!0),this.emit(B.UserMediaFeedsChanged,this.userMediaFeeds)}replaceUserMediaFeed(e,t){const s=this.userMediaFeeds.findIndex((t=>t.userId===e.userId&&t.deviceId===e.deviceId));if(-1===s)throw new Error("Couldn't find user media feed to replace");this.userMediaFeeds.splice(s,1,t),e.dispose(),t.measureVolumeActivity(!0),this.emit(B.UserMediaFeedsChanged,this.userMediaFeeds)}removeUserMediaFeed(e){const t=this.userMediaFeeds.findIndex((t=>t.userId===e.userId&&t.deviceId===e.deviceId));if(-1===t)throw new Error("Couldn't find user media feed to remove");this.userMediaFeeds.splice(t,1),e.dispose(),this.emit(B.UserMediaFeedsChanged,this.userMediaFeeds),this.activeSpeaker===e&&(this.activeSpeaker=this.userMediaFeeds[0],this.emit(B.ActiveSpeakerChanged,this.activeSpeaker))}getScreenshareFeed(e,t){return this.screenshareFeeds.find((s=>s.userId===e&&s.deviceId===t))}addScreenshareFeed(e){this.screenshareFeeds.push(e),this.emit(B.ScreenshareFeedsChanged,this.screenshareFeeds)}replaceScreenshareFeed(e,t){const s=this.screenshareFeeds.findIndex((t=>t.userId===e.userId&&t.deviceId===e.deviceId));if(-1===s)throw new Error("Couldn't find screenshare feed to replace");this.screenshareFeeds.splice(s,1,t),e.dispose(),this.emit(B.ScreenshareFeedsChanged,this.screenshareFeeds)}removeScreenshareFeed(e){const t=this.screenshareFeeds.findIndex((t=>t.userId===e.userId&&t.deviceId===e.deviceId));if(-1===t)throw new Error("Couldn't find screenshare feed to remove");this.screenshareFeeds.splice(t,1),e.dispose(),this.emit(B.ScreenshareFeedsChanged,this.screenshareFeeds)}updateParticipants(){const e=this.room.getMember(this.client.getUserId());if(!e)return void d.v.warn(`GroupCall ${this.groupCallId} updateParticipants() tried to update participants before local room member is available`);if(null!==this.participantsExpirationTimer&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===G.Ended)return void(this.participants=new Map);const t=new Map,s=Date.now(),i=this.state===G.Entered||this.enteredViaAnotherSession;let n=1/0;for(const e of this.getMemberStateEvents()){const r=this.room.getMember(e.getStateKey()),o=e.getContent(),a=(Array.isArray(o["m.calls"])?o["m.calls"]:[]).find((e=>e["m.call_id"]===this.groupCallId));let d=(Array.isArray(null==a?void 0:a["m.devices"])?a["m.devices"]:[]).filter((e=>"string"==typeof e.device_id&&"string"==typeof e.session_id&&"number"==typeof e.expires_ts&&e.expires_ts>s&&Array.isArray(e.feeds)));if(i||(null==r?void 0:r.userId)!==this.client.getUserId()||(d=d.filter((e=>e.device_id!==this.client.getDeviceId()))),d.length>0&&(null==r?void 0:r.membership)===P.O.Join){const e=new Map;t.set(r,e);for(const t of d)e.set(t.device_id,{sessionId:t.session_id,screensharing:t.feeds.some((e=>e.purpose===l.h.Screenshare))}),t.expires_ts<n&&(n=t.expires_ts)}}if(i){let s=t.get(e);void 0===s&&(s=new Map,t.set(e,s)),s.has(this.client.getDeviceId())||s.set(this.client.getDeviceId(),{sessionId:this.client.getSessionId(),screensharing:this.getLocalFeeds().some((e=>e.purpose===l.h.Screenshare))})}this.participants=t,n<1/0&&(this.participantsExpirationTimer=setTimeout((()=>this.updateParticipants()),n-s))}async updateDevices(e,t=!1){var s;const i=Date.now(),n=this.client.getUserId(),r=this.getMemberStateEvents(n),o=null!==(s=null==r?void 0:r.getContent())&&void 0!==s?s:{},a=Array.isArray(o["m.calls"])?o["m.calls"]:[];let d=null;const c=[];for(const e of a)e["m.call_id"]===this.groupCallId?d=e:c.push(e);null===d&&(d={});const l=e((Array.isArray(d["m.devices"])?d["m.devices"]:[]).filter((e=>"string"==typeof e.device_id&&"string"==typeof e.session_id&&"number"==typeof e.expires_ts&&e.expires_ts>i&&Array.isArray(e.feeds))));if(null===l)return;const h=[...c];l.length>0&&h.push(j(j({},d),{},{"m.call_id":this.groupCallId,"m.devices":l}));const m={"m.calls":h};await this.client.sendStateEvent(this.room.roomId,u.Bx.GroupCallMemberPrefix,m,n,{keepAlive:t})}async addDeviceToMemberState(){await this.updateDevices((e=>[...e.filter((e=>e.device_id!==this.client.getDeviceId())),{device_id:this.client.getDeviceId(),session_id:this.client.getSessionId(),expires_ts:Date.now()+H,feeds:this.getLocalFeeds().map((e=>({purpose:e.purpose})))}]))}async updateMemberState(){null!==this.resendMemberStateTimer&&(clearInterval(this.resendMemberStateTimer),this.resendMemberStateTimer=null),this.state===G.Entered?(await this.addDeviceToMemberState(),this.resendMemberStateTimer=setInterval((async()=>{d.v.log(`GroupCall ${this.groupCallId} updateMemberState() resending call member state"`);try{await this.addDeviceToMemberState()}catch(e){d.v.error(`GroupCall ${this.groupCallId} updateMemberState() failed to resend call member state`,e)}}),27e5)):await this.updateDevices((e=>e.filter((e=>e.device_id!==this.client.getDeviceId()))),!0)}async cleanMemberState(){const{devices:e}=await this.client.getDevices(),t=new Map(e.map((e=>[e.device_id,e])));await this.updateDevices((e=>{const s=e.filter((e=>{const s=t.get(e.device_id);return void 0!==(null==s?void 0:s.last_seen_ts)&&!(e.device_id===this.client.getDeviceId()&&this.state!==G.Entered&&!this.enteredViaAnotherSession)}));return s.length===e.length?null:s}))}getGroupCallStats(){if(void 0===this.stats){const e=this.client.getUserId()||"unknown";this.stats=new D(this.groupCallId,e,this.statsCollectIntervalTime),this.stats.reports.on(O.I.CONNECTION_STATS,this.onConnectionStats),this.stats.reports.on(O.I.BYTE_SENT_STATS,this.onByteSentStats),this.stats.reports.on(O.I.SUMMARY_STATS,this.onSummaryStats),this.stats.reports.on(O.I.CALL_FEED_REPORT,this.onCallFeedReport)}return this.stats}setGroupCallStatsInterval(e){this.statsCollectIntervalTime=e,void 0!==this.stats&&(this.stats.stop(),this.stats.setInterval(e),e>0&&this.stats.start())}}},"./node_modules/matrix-js-sdk/src/webrtc/groupCallEventHandler.ts":(e,t,s)=>{"use strict";s.d(t,{e:()=>u,o:()=>l});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/client.ts"),r=s("./node_modules/matrix-js-sdk/src/webrtc/groupCall.ts"),o=s("./node_modules/matrix-js-sdk/src/models/room-state.ts"),a=s("./node_modules/matrix-js-sdk/src/logger.ts"),d=s("./node_modules/matrix-js-sdk/src/@types/event.ts"),c=s("./node_modules/matrix-js-sdk/src/sync.ts");let l=function(e){return e.Incoming="GroupCall.incoming",e.Outgoing="GroupCall.outgoing",e.Ended="GroupCall.ended",e.Participants="GroupCall.participants",e}({});class u{constructor(e){(0,i.A)(this,"groupCalls",new Map),(0,i.A)(this,"roomDeferreds",new Map),(0,i.A)(this,"onRoomsChanged",(e=>{this.createGroupCallForRoom(e)})),(0,i.A)(this,"onRoomStateChanged",((e,t)=>{if(e.getType()===d.Bx.GroupCallPrefix){const s=e.getStateKey(),i=e.getContent(),n=this.groupCalls.get(t.roomId);n||i["m.terminated"]||e.isRedacted()?n&&n.groupCallId===s?i["m.terminated"]||e.isRedacted()?n.terminate(!1):i["m.type"]!==n.type&&a.v.warn(`GroupCallEventHandler onRoomStateChanged() currently does not support changing type (roomId=${t.roomId})`):n&&n.groupCallId!==s&&a.v.warn(`GroupCallEventHandler onRoomStateChanged() currently does not support multiple calls (roomId=${t.roomId})`):this.createGroupCallFromRoomStateEvent(e)}})),this.client=e}async start(){this.client.getSyncState()!==c.Lm.Syncing&&(a.v.debug("GroupCallEventHandler start() waiting for client to start syncing"),await new Promise((e=>{const t=()=>{if(this.client.getSyncState()===c.Lm.Syncing)return this.client.off(n.AU.Sync,t),e()};this.client.on(n.AU.Sync,t)})));const e=this.client.getRooms();for(const t of e)this.createGroupCallForRoom(t);this.client.on(n.AU.Room,this.onRoomsChanged),this.client.on(o.f.Events,this.onRoomStateChanged)}stop(){this.client.removeListener(n.AU.Room,this.onRoomsChanged),this.client.removeListener(o.f.Events,this.onRoomStateChanged)}getRoomDeferred(e){let t=this.roomDeferreds.get(e);if(void 0===t){let s;t={prom:new Promise((e=>{s=e}))},t.resolve=s,this.roomDeferreds.set(e,t)}return t}waitUntilRoomReadyForGroupCalls(e){return this.getRoomDeferred(e).prom}getGroupCallById(e){return[...this.groupCalls.values()].find((t=>t.groupCallId===e))}createGroupCallForRoom(e){const t=e.currentState.getStateEvents(d.Bx.GroupCallPrefix),s=t.sort(((e,t)=>t.getTs()-e.getTs()));for(const i of s){if(!i.getContent()["m.terminated"]&&!i.isRedacted()){a.v.debug(`GroupCallEventHandler createGroupCallForRoom() choosing group call from possible calls (stateKey=${i.getStateKey()}, ts=${i.getTs()}, roomId=${e.roomId}, numOfPossibleCalls=${t.length})`),this.createGroupCallFromRoomStateEvent(i);break}}this.getRoomDeferred(e.roomId).resolve()}createGroupCallFromRoomStateEvent(e){const t=e.getRoomId(),s=e.getContent(),i=this.client.getRoom(t);if(!i)return void a.v.warn(`GroupCallEventHandler createGroupCallFromRoomStateEvent() couldn't find room for call (roomId=${t})`);const n=e.getStateKey(),o=s["m.type"];if(!Object.values(r.Ad).includes(o))return void a.v.warn(`GroupCallEventHandler createGroupCallFromRoomStateEvent() received invalid call type (type=${o}, roomId=${t})`);const d=s["m.intent"];if(!Object.values(r.MC).includes(d))return void a.v.warn(`Received invalid group call intent (type=${o}, roomId=${t})`);const c=Boolean(s["io.element.ptt"]);let u;if(null!=s&&s.dataChannelsEnabled&&null!=s&&s.dataChannelOptions){const{ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:n}=s.dataChannelOptions;u={ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:n}}const h=new r.eO(this.client,i,o,c,d,n,(null==s?void 0:s.dataChannelsEnabled)||this.client.isVoipWithNoMediaAllowed,u,this.client.isVoipWithNoMediaAllowed,this.client.useLivekitForGroupCalls,s["io.element.livekit_service_url"]);return this.groupCalls.set(i.roomId,h),this.client.emit(l.Incoming,h),h}}},"./node_modules/matrix-js-sdk/src/webrtc/mediaHandler.ts":(e,t,s)=>{"use strict";s.d(t,{L:()=>d});var i=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=s("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),r=s("./node_modules/matrix-js-sdk/src/webrtc/groupCall.ts"),o=s("./node_modules/matrix-js-sdk/src/logger.ts");let a=function(e){return e.LocalStreamsChanged="local_streams_changed",e}({});class d extends n.X{constructor(e){super(),(0,i.A)(this,"audioInput",void 0),(0,i.A)(this,"audioSettings",void 0),(0,i.A)(this,"videoInput",void 0),(0,i.A)(this,"localUserMediaStream",void 0),(0,i.A)(this,"userMediaStreams",[]),(0,i.A)(this,"screensharingStreams",[]),(0,i.A)(this,"getMediaStreamPromise",void 0),this.client=e}restoreMediaSettings(e,t){this.audioInput=e,this.videoInput=t}async setAudioInput(e){o.v.info(`MediaHandler setAudioInput() running (deviceId=${e})`),this.audioInput!==e&&(this.audioInput=e,await this.updateLocalUsermediaStreams())}async setAudioSettings(e){o.v.info(`MediaHandler setAudioSettings() running (opts=${JSON.stringify(e)})`),this.audioSettings=Object.assign({},e),await this.updateLocalUsermediaStreams()}async setVideoInput(e){o.v.info(`MediaHandler setVideoInput() running (deviceId=${e})`),this.videoInput!==e&&(this.videoInput=e,await this.updateLocalUsermediaStreams())}async setMediaInputs(e,t){o.v.log(`MediaHandler setMediaInputs() running (audioInput: ${e} videoInput: ${t})`),this.audioInput=e,this.videoInput=t,await this.updateLocalUsermediaStreams()}async updateLocalUsermediaStreams(){if(0===this.userMediaStreams.length)return;const e=new Map;for(const t of this.client.callEventHandler.calls.values())e.set(t.callId,{audio:t.hasLocalUserMediaAudioTrack,video:t.hasLocalUserMediaVideoTrack});for(const e of this.userMediaStreams){o.v.log(`MediaHandler updateLocalUsermediaStreams() stopping all tracks (streamId=${e.id})`);for(const t of e.getTracks())t.stop()}this.userMediaStreams=[],this.localUserMediaStream=void 0;for(const t of this.client.callEventHandler.calls.values()){if(t.callHasEnded()||!e.has(t.callId))continue;const{audio:s,video:i}=e.get(t.callId);o.v.log(`MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (callId=${t.callId})`);const n=await this.getUserMediaStream(s,i);t.callHasEnded()||await t.updateLocalUsermediaStream(n)}for(const e of this.client.groupCallEventHandler.groupCalls.values()){if(!e.localCallFeed)continue;o.v.log(`MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (groupCallId=${e.groupCallId})`);const t=await this.getUserMediaStream(!0,e.type===r.Ad.Video);e.state!==r.F_.Ended&&await e.updateLocalUsermediaStream(t)}this.emit(a.LocalStreamsChanged)}async hasAudioDevice(){try{return(await navigator.mediaDevices.enumerateDevices()).filter((e=>"audioinput"===e.kind)).length>0}catch(e){return o.v.log("MediaHandler hasAudioDevice() calling navigator.mediaDevices.enumerateDevices with error",e),!1}}async hasVideoDevice(){try{return(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind)).length>0}catch(e){return o.v.log("MediaHandler hasVideoDevice() calling navigator.mediaDevices.enumerateDevices with error",e),!1}}async getUserMediaStream(e,t,s=!0){return this.getMediaStreamPromise?this.getMediaStreamPromise=this.getMediaStreamPromise.then((()=>this.getUserMediaStreamInternal(e,t,s))):this.getMediaStreamPromise=this.getUserMediaStreamInternal(e,t,s),this.getMediaStreamPromise}async getUserMediaStreamInternal(e,t,s){const i=e&&await this.hasAudioDevice(),n=t&&await this.hasVideoDevice();let r,d=!0;var c,l;this.localUserMediaStream?(i!==this.localUserMediaStream.getAudioTracks().length>0&&(d=!1),n!==this.localUserMediaStream.getVideoTracks().length>0&&(d=!1),i&&(null===(c=this.localUserMediaStream.getAudioTracks()[0])||void 0===c||null===(c=c.getSettings())||void 0===c?void 0:c.deviceId)!==this.audioInput&&(d=!1),n&&(null===(l=this.localUserMediaStream.getVideoTracks()[0])||void 0===l||null===(l=l.getSettings())||void 0===l?void 0:l.deviceId)!==this.videoInput&&(d=!1)):d=!1;if(d){var u;if(r=this.localUserMediaStream.clone(),o.v.log(`MediaHandler getUserMediaStreamInternal() cloning (oldStreamId=${null===(u=this.localUserMediaStream)||void 0===u?void 0:u.id} newStreamId=${r.id} shouldRequestAudio=${i} shouldRequestVideo=${n})`),!i)for(const e of r.getAudioTracks())r.removeTrack(e);if(!n)for(const e of r.getVideoTracks())r.removeTrack(e)}else{const e=this.getUserMediaContraints(i,n);r=await navigator.mediaDevices.getUserMedia(e),o.v.log(`MediaHandler getUserMediaStreamInternal() calling getUserMediaStream (streamId=${r.id}, shouldRequestAudio=${i}, shouldRequestVideo=${n}, constraints=${JSON.stringify(e)})`);for(const e of r.getTracks()){const t=e.getSettings();"audio"===e.kind?this.audioInput=t.deviceId:"video"===e.kind&&(this.videoInput=t.deviceId)}s&&(this.localUserMediaStream=r)}return s&&this.userMediaStreams.push(r),this.emit(a.LocalStreamsChanged),r}stopUserMediaStream(e){o.v.log(`MediaHandler stopUserMediaStream() stopping (streamId=${e.id})`);for(const t of e.getTracks())t.stop();const t=this.userMediaStreams.indexOf(e);if(-1!==t&&(o.v.debug(`MediaHandler stopUserMediaStream() splicing usermedia stream out stream array (streamId=${e.id})`,e.id),this.userMediaStreams.splice(t,1)),this.emit(a.LocalStreamsChanged),this.localUserMediaStream===e)this.localUserMediaStream=void 0;else for(const t of e.getTracks()){var s;if(null!==(s=this.localUserMediaStream)&&void 0!==s&&s.getTrackById(t.id)){this.stopUserMediaStream(this.localUserMediaStream);break}}}async getScreensharingStream(e={},t=!0){let s;if(0===this.screensharingStreams.length){const t=this.getScreenshareContraints(e);e.desktopCapturerSourceId?(o.v.debug(`MediaHandler getScreensharingStream() calling getUserMedia() (opts=${JSON.stringify(e)})`),s=await navigator.mediaDevices.getUserMedia(t)):(o.v.debug(`MediaHandler getScreensharingStream() calling getDisplayMedia() (opts=${JSON.stringify(e)})`),s=await navigator.mediaDevices.getDisplayMedia(t))}else{const e=this.screensharingStreams[this.screensharingStreams.length-1];o.v.log(`MediaHandler getScreensharingStream() cloning (streamId=${e.id})`),s=e.clone()}return t&&this.screensharingStreams.push(s),this.emit(a.LocalStreamsChanged),s}stopScreensharingStream(e){o.v.debug(`MediaHandler stopScreensharingStream() stopping stream (streamId=${e.id})`);for(const t of e.getTracks())t.stop();const t=this.screensharingStreams.indexOf(e);-1!==t&&(o.v.debug(`MediaHandler stopScreensharingStream() splicing stream out (streamId=${e.id})`),this.screensharingStreams.splice(t,1)),this.emit(a.LocalStreamsChanged)}stopAllStreams(){for(const e of this.userMediaStreams){o.v.log(`MediaHandler stopAllStreams() stopping (streamId=${e.id})`);for(const t of e.getTracks())t.stop()}for(const e of this.screensharingStreams)for(const t of e.getTracks())t.stop();this.userMediaStreams=[],this.screensharingStreams=[],this.localUserMediaStream=void 0,this.emit(a.LocalStreamsChanged)}getUserMediaContraints(e,t){const s=!!navigator.webkitGetUserMedia;return{audio:!!e&&{deviceId:this.audioInput?{ideal:this.audioInput}:void 0,autoGainControl:this.audioSettings?{ideal:this.audioSettings.autoGainControl}:void 0,echoCancellation:this.audioSettings?{ideal:this.audioSettings.echoCancellation}:void 0,noiseSuppression:this.audioSettings?{ideal:this.audioSettings.noiseSuppression}:void 0},video:!!t&&{deviceId:this.videoInput?{ideal:this.videoInput}:void 0,width:s?{exact:640}:{ideal:640},height:s?{exact:360}:{ideal:360}}}}getScreenshareContraints(e){const{desktopCapturerSourceId:t,audio:s}=e;return t?{audio:null!=s&&s,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t}}}:{audio:null!=s&&s,video:!0}}}},"./node_modules/matrix-js-sdk/src/webrtc/stats/statsReport.ts":(e,t,s)=>{"use strict";s.d(t,{I:()=>i});let i=function(e){return e.CONNECTION_STATS="StatsReport.connection_stats",e.CALL_FEED_REPORT="StatsReport.call_feed_report",e.BYTE_SENT_STATS="StatsReport.byte_sent_stats",e.SUMMARY_STATS="StatsReport.summary_stats",e}({})},"./src/serviceworker/index.ts":(e,t,s)=>{"use strict";function i(){try{var e;return null!==(e=self)&&void 0!==e&&e.indexedDB?self.indexedDB:window.indexedDB}catch(e){}}let n=null;async function r(){if(!i())throw new Error("IndexedDB not available");n=await new Promise(((e,t)=>{const s=i().open("matrix-react-sdk",1);s.onerror=t,s.onsuccess=()=>{e(s.result)},s.onupgradeneeded=()=>{const e=s.result;e.createObjectStore("pickleKey"),e.createObjectStore("account")}}))}async function o(e,t){return n||await r(),new Promise(((s,i)=>{const r=n.transaction([e],"readonly");r.onerror=i;const o=r.objectStore(e).get(t);o.onerror=i,o.onsuccess=e=>{s(o.result)}}))}s("./node_modules/matrix-js-sdk/src/utils/encryptAESSecretStorageItem.ts");var a=s("./node_modules/matrix-js-sdk/src/utils/decryptAESSecretStorageItem.ts"),d=(s("./node_modules/matrix-js-sdk/src/secret-storage.ts"),s("./node_modules/matrix-js-sdk/src/logger.ts"));const c="access_token";async function l(e){const t=new Uint8Array(e.length);for(let s=0;s<e.length;s++)t[s]=e.charCodeAt(s);const s=await crypto.subtle.importKey("raw",t,"HKDF",!1,["deriveBits"]);return t.fill(0),new Uint8Array(await crypto.subtle.deriveBits({name:"HKDF",hash:"SHA-256",salt:new Uint8Array(32),info:new Uint8Array(0)},s,256))}const u=e=>!!e&&"string"!=typeof e;var h=s("./node_modules/matrix-js-sdk/src/base64.ts");function m(e,t){const s=new Uint8Array(e.length+t.length+1);for(let t=0;t<e.length;t++)s[t]=e.charCodeAt(t);s[e.length]=124;for(let i=0;i<t.length;i++)s[e.length+1+i]=t.charCodeAt(i);return s}const p={};function g(e){if(e)return{headers:{Authorization:`Bearer ${e}`}}}s.g.addEventListener("install",(e=>{e.waitUntil(skipWaiting())})),s.g.addEventListener("activate",(e=>{e.waitUntil(clients.claim())})),s.g.addEventListener("fetch",(e=>{if("GET"!==e.request.method)return;let t=e.request.url;(t.includes("/_matrix/media/v3/download")||t.includes("/_matrix/media/v3/thumbnail"))&&e.respondWith((async()=>{let i;try{const n=t.substring(0,t.indexOf("/_matrix/media/v3"));await new Promise((e=>setTimeout((()=>e()),10*Math.random())));const r=await s.g.clients.get(e.clientId);i=await async function(e){const t=await o("account","mx_access_token"),{userId:i,deviceId:n}=await async function(e){return new Promise(((t,i)=>{const n=setTimeout((()=>i(new Error("timeout in postMessage"))),1e3),r=Math.random().toString(36),o=e=>{var i;(null===(i=e.data)||void 0===i?void 0:i.responseKey)===r&&(clearTimeout(n),t(e.data),s.g.removeEventListener("message",o))};s.g.addEventListener("message",o),e.postMessage({responseKey:r,type:"userinfo"})}))}(e),r=await o("pickleKey",[i,n]);if(r&&(!r.encrypted||!r.iv||!r.cryptoKey))return void console.error("SW: Invalid pickle key loaded - ignoring");try{const e=await async function(e,t,s){var i;if(null!==(i=crypto)&&void 0!==i&&i.subtle&&e&&e.encrypted&&e.iv&&e.cryptoKey)try{const i=m(t,s),n=await crypto.subtle.decrypt({name:"AES-GCM",iv:e.iv,additionalData:i},e.cryptoKey,e.encrypted);if(n)return(0,h.PP)(n)}catch(e){d.v.error("Error decrypting pickle key")}}(r,i,n);return async function(e,t,s){if(e&&u(t)){const i=await l(e),n=await(0,a.A)(t,i,s);return i.fill(0),n}if("string"==typeof t)return t}(e,t,c)}catch(e){return void console.error("SW: Error decrypting access token.",e)}}(r),await async function(e,t){var s,i;if((null===(s=p[e])||void 0===s?void 0:s.cacheExpiryTimeMs)>(new Date).getTime())return;const n=g(t),r=await(await fetch(`${e}/_matrix/client/versions`,n)).json();console.log(`[ServiceWorker] /versions response for '${e}': ${JSON.stringify(r)}`),p[e]={supportsAuthedMedia:Boolean(null==r||null===(i=r.versions)||void 0===i?void 0:i.includes("v1.11")),cacheExpiryTimeMs:(new Date).getTime()+72e5},console.log(`[ServiceWorker] serverSupportMap update for '${e}': ${JSON.stringify(p[e])}`)}(n,i),p[n].supportsAuthedMedia&&i&&(t=t.replace(/\/media\/v3\/(.*)\//,"/client/v1/media/$1/"))}catch(e){console.error("SW: Error in request rewrite.",e)}return fetch(t,g(i))})())}))},"./node_modules/base64-js/index.js":(e,t)=>{"use strict";t.byteLength=function(e){var t=a(e),s=t[0],i=t[1];return 3*(s+i)/4-i},t.toByteArray=function(e){var t,s,r=a(e),o=r[0],d=r[1],c=new n(function(e,t,s){return 3*(t+s)/4-s}(0,o,d)),l=0,u=d>0?o-4:o;for(s=0;s<u;s+=4)t=i[e.charCodeAt(s)]<<18|i[e.charCodeAt(s+1)]<<12|i[e.charCodeAt(s+2)]<<6|i[e.charCodeAt(s+3)],c[l++]=t>>16&255,c[l++]=t>>8&255,c[l++]=255&t;2===d&&(t=i[e.charCodeAt(s)]<<2|i[e.charCodeAt(s+1)]>>4,c[l++]=255&t);1===d&&(t=i[e.charCodeAt(s)]<<10|i[e.charCodeAt(s+1)]<<4|i[e.charCodeAt(s+2)]>>2,c[l++]=t>>8&255,c[l++]=255&t);return c},t.fromByteArray=function(e){for(var t,i=e.length,n=i%3,r=[],o=16383,a=0,c=i-n;a<c;a+=o)r.push(d(e,a,a+o>c?c:a+o));1===n?(t=e[i-1],r.push(s[t>>2]+s[t<<4&63]+"==")):2===n&&(t=(e[i-2]<<8)+e[i-1],r.push(s[t>>10]+s[t>>4&63]+s[t<<2&63]+"="));return r.join("")};for(var s=[],i=[],n="undefined"!=typeof Uint8Array?Uint8Array:Array,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o=0;o<64;++o)s[o]=r[o],i[r.charCodeAt(o)]=o;function a(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var s=e.indexOf("=");return-1===s&&(s=t),[s,s===t?0:4-s%4]}function d(e,t,i){for(var n,r,o=[],a=t;a<i;a+=3)n=(e[a]<<16&16711680)+(e[a+1]<<8&65280)+(255&e[a+2]),o.push(s[(r=n)>>18&63]+s[r>>12&63]+s[r>>6&63]+s[63&r]);return o.join("")}i["-".charCodeAt(0)]=62,i["_".charCodeAt(0)]=63},"./node_modules/buffer/index.js":(e,t,s)=>{"use strict";const i=s("./node_modules/base64-js/index.js"),n=s("./node_modules/ieee754/index.js"),r="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;t.hp=d,t.IS=50;const o=2147483647;function a(e){if(e>o)throw new RangeError('The value "'+e+'" is invalid for option "size"');const t=new Uint8Array(e);return Object.setPrototypeOf(t,d.prototype),t}function d(e,t,s){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return u(e)}return c(e,t,s)}function c(e,t,s){if("string"==typeof e)return function(e,t){"string"==typeof t&&""!==t||(t="utf8");if(!d.isEncoding(t))throw new TypeError("Unknown encoding: "+t);const s=0|g(e,t);let i=a(s);const n=i.write(e,t);n!==s&&(i=i.slice(0,n));return i}(e,t);if(ArrayBuffer.isView(e))return function(e){if(z(e,Uint8Array)){const t=new Uint8Array(e);return m(t.buffer,t.byteOffset,t.byteLength)}return h(e)}(e);if(null==e)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(z(e,ArrayBuffer)||e&&z(e.buffer,ArrayBuffer))return m(e,t,s);if("undefined"!=typeof SharedArrayBuffer&&(z(e,SharedArrayBuffer)||e&&z(e.buffer,SharedArrayBuffer)))return m(e,t,s);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');const i=e.valueOf&&e.valueOf();if(null!=i&&i!==e)return d.from(i,t,s);const n=function(e){if(d.isBuffer(e)){const t=0|p(e.length),s=a(t);return 0===s.length||e.copy(s,0,0,t),s}if(void 0!==e.length)return"number"!=typeof e.length||Q(e.length)?a(0):h(e);if("Buffer"===e.type&&Array.isArray(e.data))return h(e.data)}(e);if(n)return n;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return d.from(e[Symbol.toPrimitive]("string"),t,s);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function l(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function u(e){return l(e),a(e<0?0:0|p(e))}function h(e){const t=e.length<0?0:0|p(e.length),s=a(t);for(let i=0;i<t;i+=1)s[i]=255&e[i];return s}function m(e,t,s){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(s||0))throw new RangeError('"length" is outside of buffer bounds');let i;return i=void 0===t&&void 0===s?new Uint8Array(e):void 0===s?new Uint8Array(e,t):new Uint8Array(e,t,s),Object.setPrototypeOf(i,d.prototype),i}function p(e){if(e>=o)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+o.toString(16)+" bytes");return 0|e}function g(e,t){if(d.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||z(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);const s=e.length,i=arguments.length>2&&!0===arguments[2];if(!i&&0===s)return 0;let n=!1;for(;;)switch(t){case"ascii":case"latin1":case"binary":return s;case"utf8":case"utf-8":return H(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*s;case"hex":return s>>>1;case"base64":return W(e).length;default:if(n)return i?-1:H(e).length;t=(""+t).toLowerCase(),n=!0}}function v(e,t,s){let i=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===s||s>this.length)&&(s=this.length),s<=0)return"";if((s>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return O(this,t,s);case"utf8":case"utf-8":return R(this,t,s);case"ascii":return C(this,t,s);case"latin1":case"binary":return A(this,t,s);case"base64":return k(this,t,s);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return M(this,t,s);default:if(i)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),i=!0}}function f(e,t,s){const i=e[t];e[t]=e[s],e[s]=i}function y(e,t,s,i,n){if(0===e.length)return-1;if("string"==typeof s?(i=s,s=0):s>2147483647?s=2147483647:s<-2147483648&&(s=-2147483648),Q(s=+s)&&(s=n?0:e.length-1),s<0&&(s=e.length+s),s>=e.length){if(n)return-1;s=e.length-1}else if(s<0){if(!n)return-1;s=0}if("string"==typeof t&&(t=d.from(t,i)),d.isBuffer(t))return 0===t.length?-1:S(e,t,s,i,n);if("number"==typeof t)return t&=255,"function"==typeof Uint8Array.prototype.indexOf?n?Uint8Array.prototype.indexOf.call(e,t,s):Uint8Array.prototype.lastIndexOf.call(e,t,s):S(e,[t],s,i,n);throw new TypeError("val must be string, number or Buffer")}function S(e,t,s,i,n){let r,o=1,a=e.length,d=t.length;if(void 0!==i&&("ucs2"===(i=String(i).toLowerCase())||"ucs-2"===i||"utf16le"===i||"utf-16le"===i)){if(e.length<2||t.length<2)return-1;o=2,a/=2,d/=2,s/=2}function c(e,t){return 1===o?e[t]:e.readUInt16BE(t*o)}if(n){let i=-1;for(r=s;r<a;r++)if(c(e,r)===c(t,-1===i?0:r-i)){if(-1===i&&(i=r),r-i+1===d)return i*o}else-1!==i&&(r-=r-i),i=-1}else for(s+d>a&&(s=a-d),r=s;r>=0;r--){let s=!0;for(let i=0;i<d;i++)if(c(e,r+i)!==c(t,i)){s=!1;break}if(s)return r}return-1}function b(e,t,s,i){s=Number(s)||0;const n=e.length-s;i?(i=Number(i))>n&&(i=n):i=n;const r=t.length;let o;for(i>r/2&&(i=r/2),o=0;o<i;++o){const i=parseInt(t.substr(2*o,2),16);if(Q(i))return o;e[s+o]=i}return o}function E(e,t,s,i){return J(H(t,e.length-s),e,s,i)}function w(e,t,s,i){return J(function(e){const t=[];for(let s=0;s<e.length;++s)t.push(255&e.charCodeAt(s));return t}(t),e,s,i)}function I(e,t,s,i){return J(W(t),e,s,i)}function _(e,t,s,i){return J(function(e,t){let s,i,n;const r=[];for(let o=0;o<e.length&&!((t-=2)<0);++o)s=e.charCodeAt(o),i=s>>8,n=s%256,r.push(n),r.push(i);return r}(t,e.length-s),e,s,i)}function k(e,t,s){return 0===t&&s===e.length?i.fromByteArray(e):i.fromByteArray(e.slice(t,s))}function R(e,t,s){s=Math.min(e.length,s);const i=[];let n=t;for(;n<s;){const t=e[n];let r=null,o=t>239?4:t>223?3:t>191?2:1;if(n+o<=s){let s,i,a,d;switch(o){case 1:t<128&&(r=t);break;case 2:s=e[n+1],128==(192&s)&&(d=(31&t)<<6|63&s,d>127&&(r=d));break;case 3:s=e[n+1],i=e[n+2],128==(192&s)&&128==(192&i)&&(d=(15&t)<<12|(63&s)<<6|63&i,d>2047&&(d<55296||d>57343)&&(r=d));break;case 4:s=e[n+1],i=e[n+2],a=e[n+3],128==(192&s)&&128==(192&i)&&128==(192&a)&&(d=(15&t)<<18|(63&s)<<12|(63&i)<<6|63&a,d>65535&&d<1114112&&(r=d))}}null===r?(r=65533,o=1):r>65535&&(r-=65536,i.push(r>>>10&1023|55296),r=56320|1023&r),i.push(r),n+=o}return function(e){const t=e.length;if(t<=T)return String.fromCharCode.apply(String,e);let s="",i=0;for(;i<t;)s+=String.fromCharCode.apply(String,e.slice(i,i+=T));return s}(i)}d.TYPED_ARRAY_SUPPORT=function(){try{const e=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(e,t),42===e.foo()}catch(e){return!1}}(),d.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(d.prototype,"parent",{enumerable:!0,get:function(){if(d.isBuffer(this))return this.buffer}}),Object.defineProperty(d.prototype,"offset",{enumerable:!0,get:function(){if(d.isBuffer(this))return this.byteOffset}}),d.poolSize=8192,d.from=function(e,t,s){return c(e,t,s)},Object.setPrototypeOf(d.prototype,Uint8Array.prototype),Object.setPrototypeOf(d,Uint8Array),d.alloc=function(e,t,s){return function(e,t,s){return l(e),e<=0?a(e):void 0!==t?"string"==typeof s?a(e).fill(t,s):a(e).fill(t):a(e)}(e,t,s)},d.allocUnsafe=function(e){return u(e)},d.allocUnsafeSlow=function(e){return u(e)},d.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==d.prototype},d.compare=function(e,t){if(z(e,Uint8Array)&&(e=d.from(e,e.offset,e.byteLength)),z(t,Uint8Array)&&(t=d.from(t,t.offset,t.byteLength)),!d.isBuffer(e)||!d.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;let s=e.length,i=t.length;for(let n=0,r=Math.min(s,i);n<r;++n)if(e[n]!==t[n]){s=e[n],i=t[n];break}return s<i?-1:i<s?1:0},d.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},d.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return d.alloc(0);let s;if(void 0===t)for(t=0,s=0;s<e.length;++s)t+=e[s].length;const i=d.allocUnsafe(t);let n=0;for(s=0;s<e.length;++s){let t=e[s];if(z(t,Uint8Array))n+t.length>i.length?(d.isBuffer(t)||(t=d.from(t)),t.copy(i,n)):Uint8Array.prototype.set.call(i,t,n);else{if(!d.isBuffer(t))throw new TypeError('"list" argument must be an Array of Buffers');t.copy(i,n)}n+=t.length}return i},d.byteLength=g,d.prototype._isBuffer=!0,d.prototype.swap16=function(){const e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let t=0;t<e;t+=2)f(this,t,t+1);return this},d.prototype.swap32=function(){const e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let t=0;t<e;t+=4)f(this,t,t+3),f(this,t+1,t+2);return this},d.prototype.swap64=function(){const e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let t=0;t<e;t+=8)f(this,t,t+7),f(this,t+1,t+6),f(this,t+2,t+5),f(this,t+3,t+4);return this},d.prototype.toString=function(){const e=this.length;return 0===e?"":0===arguments.length?R(this,0,e):v.apply(this,arguments)},d.prototype.toLocaleString=d.prototype.toString,d.prototype.equals=function(e){if(!d.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===d.compare(this,e)},d.prototype.inspect=function(){let e="";const s=t.IS;return e=this.toString("hex",0,s).replace(/(.{2})/g,"$1 ").trim(),this.length>s&&(e+=" ... "),"<Buffer "+e+">"},r&&(d.prototype[r]=d.prototype.inspect),d.prototype.compare=function(e,t,s,i,n){if(z(e,Uint8Array)&&(e=d.from(e,e.offset,e.byteLength)),!d.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===s&&(s=e?e.length:0),void 0===i&&(i=0),void 0===n&&(n=this.length),t<0||s>e.length||i<0||n>this.length)throw new RangeError("out of range index");if(i>=n&&t>=s)return 0;if(i>=n)return-1;if(t>=s)return 1;if(this===e)return 0;let r=(n>>>=0)-(i>>>=0),o=(s>>>=0)-(t>>>=0);const a=Math.min(r,o),c=this.slice(i,n),l=e.slice(t,s);for(let e=0;e<a;++e)if(c[e]!==l[e]){r=c[e],o=l[e];break}return r<o?-1:o<r?1:0},d.prototype.includes=function(e,t,s){return-1!==this.indexOf(e,t,s)},d.prototype.indexOf=function(e,t,s){return y(this,e,t,s,!0)},d.prototype.lastIndexOf=function(e,t,s){return y(this,e,t,s,!1)},d.prototype.write=function(e,t,s,i){if(void 0===t)i="utf8",s=this.length,t=0;else if(void 0===s&&"string"==typeof t)i=t,s=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(s)?(s>>>=0,void 0===i&&(i="utf8")):(i=s,s=void 0)}const n=this.length-t;if((void 0===s||s>n)&&(s=n),e.length>0&&(s<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");i||(i="utf8");let r=!1;for(;;)switch(i){case"hex":return b(this,e,t,s);case"utf8":case"utf-8":return E(this,e,t,s);case"ascii":case"latin1":case"binary":return w(this,e,t,s);case"base64":return I(this,e,t,s);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return _(this,e,t,s);default:if(r)throw new TypeError("Unknown encoding: "+i);i=(""+i).toLowerCase(),r=!0}},d.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};const T=4096;function C(e,t,s){let i="";s=Math.min(e.length,s);for(let n=t;n<s;++n)i+=String.fromCharCode(127&e[n]);return i}function A(e,t,s){let i="";s=Math.min(e.length,s);for(let n=t;n<s;++n)i+=String.fromCharCode(e[n]);return i}function O(e,t,s){const i=e.length;(!t||t<0)&&(t=0),(!s||s<0||s>i)&&(s=i);let n="";for(let i=t;i<s;++i)n+=Y[e[i]];return n}function M(e,t,s){const i=e.slice(t,s);let n="";for(let e=0;e<i.length-1;e+=2)n+=String.fromCharCode(i[e]+256*i[e+1]);return n}function x(e,t,s){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>s)throw new RangeError("Trying to access beyond buffer length")}function D(e,t,s,i,n,r){if(!d.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>n||t<r)throw new RangeError('"value" argument is out of bounds');if(s+i>e.length)throw new RangeError("Index out of range")}function P(e,t,s,i,n){$(t,i,n,e,s,7);let r=Number(t&BigInt(4294967295));e[s++]=r,r>>=8,e[s++]=r,r>>=8,e[s++]=r,r>>=8,e[s++]=r;let o=Number(t>>BigInt(32)&BigInt(4294967295));return e[s++]=o,o>>=8,e[s++]=o,o>>=8,e[s++]=o,o>>=8,e[s++]=o,s}function U(e,t,s,i,n){$(t,i,n,e,s,7);let r=Number(t&BigInt(4294967295));e[s+7]=r,r>>=8,e[s+6]=r,r>>=8,e[s+5]=r,r>>=8,e[s+4]=r;let o=Number(t>>BigInt(32)&BigInt(4294967295));return e[s+3]=o,o>>=8,e[s+2]=o,o>>=8,e[s+1]=o,o>>=8,e[s]=o,s+8}function j(e,t,s,i,n,r){if(s+i>e.length)throw new RangeError("Index out of range");if(s<0)throw new RangeError("Index out of range")}function L(e,t,s,i,r){return t=+t,s>>>=0,r||j(e,0,s,4),n.write(e,t,s,i,23,4),s+4}function N(e,t,s,i,r){return t=+t,s>>>=0,r||j(e,0,s,8),n.write(e,t,s,i,52,8),s+8}d.prototype.slice=function(e,t){const s=this.length;(e=~~e)<0?(e+=s)<0&&(e=0):e>s&&(e=s),(t=void 0===t?s:~~t)<0?(t+=s)<0&&(t=0):t>s&&(t=s),t<e&&(t=e);const i=this.subarray(e,t);return Object.setPrototypeOf(i,d.prototype),i},d.prototype.readUintLE=d.prototype.readUIntLE=function(e,t,s){e>>>=0,t>>>=0,s||x(e,t,this.length);let i=this[e],n=1,r=0;for(;++r<t&&(n*=256);)i+=this[e+r]*n;return i},d.prototype.readUintBE=d.prototype.readUIntBE=function(e,t,s){e>>>=0,t>>>=0,s||x(e,t,this.length);let i=this[e+--t],n=1;for(;t>0&&(n*=256);)i+=this[e+--t]*n;return i},d.prototype.readUint8=d.prototype.readUInt8=function(e,t){return e>>>=0,t||x(e,1,this.length),this[e]},d.prototype.readUint16LE=d.prototype.readUInt16LE=function(e,t){return e>>>=0,t||x(e,2,this.length),this[e]|this[e+1]<<8},d.prototype.readUint16BE=d.prototype.readUInt16BE=function(e,t){return e>>>=0,t||x(e,2,this.length),this[e]<<8|this[e+1]},d.prototype.readUint32LE=d.prototype.readUInt32LE=function(e,t){return e>>>=0,t||x(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},d.prototype.readUint32BE=d.prototype.readUInt32BE=function(e,t){return e>>>=0,t||x(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},d.prototype.readBigUInt64LE=X((function(e){q(e>>>=0,"offset");const t=this[e],s=this[e+7];void 0!==t&&void 0!==s||V(e,this.length-8);const i=t+256*this[++e]+65536*this[++e]+this[++e]*2**24,n=this[++e]+256*this[++e]+65536*this[++e]+s*2**24;return BigInt(i)+(BigInt(n)<<BigInt(32))})),d.prototype.readBigUInt64BE=X((function(e){q(e>>>=0,"offset");const t=this[e],s=this[e+7];void 0!==t&&void 0!==s||V(e,this.length-8);const i=t*2**24+65536*this[++e]+256*this[++e]+this[++e],n=this[++e]*2**24+65536*this[++e]+256*this[++e]+s;return(BigInt(i)<<BigInt(32))+BigInt(n)})),d.prototype.readIntLE=function(e,t,s){e>>>=0,t>>>=0,s||x(e,t,this.length);let i=this[e],n=1,r=0;for(;++r<t&&(n*=256);)i+=this[e+r]*n;return n*=128,i>=n&&(i-=Math.pow(2,8*t)),i},d.prototype.readIntBE=function(e,t,s){e>>>=0,t>>>=0,s||x(e,t,this.length);let i=t,n=1,r=this[e+--i];for(;i>0&&(n*=256);)r+=this[e+--i]*n;return n*=128,r>=n&&(r-=Math.pow(2,8*t)),r},d.prototype.readInt8=function(e,t){return e>>>=0,t||x(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},d.prototype.readInt16LE=function(e,t){e>>>=0,t||x(e,2,this.length);const s=this[e]|this[e+1]<<8;return 32768&s?4294901760|s:s},d.prototype.readInt16BE=function(e,t){e>>>=0,t||x(e,2,this.length);const s=this[e+1]|this[e]<<8;return 32768&s?4294901760|s:s},d.prototype.readInt32LE=function(e,t){return e>>>=0,t||x(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},d.prototype.readInt32BE=function(e,t){return e>>>=0,t||x(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},d.prototype.readBigInt64LE=X((function(e){q(e>>>=0,"offset");const t=this[e],s=this[e+7];void 0!==t&&void 0!==s||V(e,this.length-8);const i=this[e+4]+256*this[e+5]+65536*this[e+6]+(s<<24);return(BigInt(i)<<BigInt(32))+BigInt(t+256*this[++e]+65536*this[++e]+this[++e]*2**24)})),d.prototype.readBigInt64BE=X((function(e){q(e>>>=0,"offset");const t=this[e],s=this[e+7];void 0!==t&&void 0!==s||V(e,this.length-8);const i=(t<<24)+65536*this[++e]+256*this[++e]+this[++e];return(BigInt(i)<<BigInt(32))+BigInt(this[++e]*2**24+65536*this[++e]+256*this[++e]+s)})),d.prototype.readFloatLE=function(e,t){return e>>>=0,t||x(e,4,this.length),n.read(this,e,!0,23,4)},d.prototype.readFloatBE=function(e,t){return e>>>=0,t||x(e,4,this.length),n.read(this,e,!1,23,4)},d.prototype.readDoubleLE=function(e,t){return e>>>=0,t||x(e,8,this.length),n.read(this,e,!0,52,8)},d.prototype.readDoubleBE=function(e,t){return e>>>=0,t||x(e,8,this.length),n.read(this,e,!1,52,8)},d.prototype.writeUintLE=d.prototype.writeUIntLE=function(e,t,s,i){if(e=+e,t>>>=0,s>>>=0,!i){D(this,e,t,s,Math.pow(2,8*s)-1,0)}let n=1,r=0;for(this[t]=255&e;++r<s&&(n*=256);)this[t+r]=e/n&255;return t+s},d.prototype.writeUintBE=d.prototype.writeUIntBE=function(e,t,s,i){if(e=+e,t>>>=0,s>>>=0,!i){D(this,e,t,s,Math.pow(2,8*s)-1,0)}let n=s-1,r=1;for(this[t+n]=255&e;--n>=0&&(r*=256);)this[t+n]=e/r&255;return t+s},d.prototype.writeUint8=d.prototype.writeUInt8=function(e,t,s){return e=+e,t>>>=0,s||D(this,e,t,1,255,0),this[t]=255&e,t+1},d.prototype.writeUint16LE=d.prototype.writeUInt16LE=function(e,t,s){return e=+e,t>>>=0,s||D(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},d.prototype.writeUint16BE=d.prototype.writeUInt16BE=function(e,t,s){return e=+e,t>>>=0,s||D(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},d.prototype.writeUint32LE=d.prototype.writeUInt32LE=function(e,t,s){return e=+e,t>>>=0,s||D(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},d.prototype.writeUint32BE=d.prototype.writeUInt32BE=function(e,t,s){return e=+e,t>>>=0,s||D(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},d.prototype.writeBigUInt64LE=X((function(e,t=0){return P(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))})),d.prototype.writeBigUInt64BE=X((function(e,t=0){return U(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))})),d.prototype.writeIntLE=function(e,t,s,i){if(e=+e,t>>>=0,!i){const i=Math.pow(2,8*s-1);D(this,e,t,s,i-1,-i)}let n=0,r=1,o=0;for(this[t]=255&e;++n<s&&(r*=256);)e<0&&0===o&&0!==this[t+n-1]&&(o=1),this[t+n]=(e/r|0)-o&255;return t+s},d.prototype.writeIntBE=function(e,t,s,i){if(e=+e,t>>>=0,!i){const i=Math.pow(2,8*s-1);D(this,e,t,s,i-1,-i)}let n=s-1,r=1,o=0;for(this[t+n]=255&e;--n>=0&&(r*=256);)e<0&&0===o&&0!==this[t+n+1]&&(o=1),this[t+n]=(e/r|0)-o&255;return t+s},d.prototype.writeInt8=function(e,t,s){return e=+e,t>>>=0,s||D(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},d.prototype.writeInt16LE=function(e,t,s){return e=+e,t>>>=0,s||D(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},d.prototype.writeInt16BE=function(e,t,s){return e=+e,t>>>=0,s||D(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},d.prototype.writeInt32LE=function(e,t,s){return e=+e,t>>>=0,s||D(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},d.prototype.writeInt32BE=function(e,t,s){return e=+e,t>>>=0,s||D(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},d.prototype.writeBigInt64LE=X((function(e,t=0){return P(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),d.prototype.writeBigInt64BE=X((function(e,t=0){return U(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),d.prototype.writeFloatLE=function(e,t,s){return L(this,e,t,!0,s)},d.prototype.writeFloatBE=function(e,t,s){return L(this,e,t,!1,s)},d.prototype.writeDoubleLE=function(e,t,s){return N(this,e,t,!0,s)},d.prototype.writeDoubleBE=function(e,t,s){return N(this,e,t,!1,s)},d.prototype.copy=function(e,t,s,i){if(!d.isBuffer(e))throw new TypeError("argument should be a Buffer");if(s||(s=0),i||0===i||(i=this.length),t>=e.length&&(t=e.length),t||(t=0),i>0&&i<s&&(i=s),i===s)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(s<0||s>=this.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("sourceEnd out of bounds");i>this.length&&(i=this.length),e.length-t<i-s&&(i=e.length-t+s);const n=i-s;return this===e&&"function"==typeof Uint8Array.prototype.copyWithin?this.copyWithin(t,s,i):Uint8Array.prototype.set.call(e,this.subarray(s,i),t),n},d.prototype.fill=function(e,t,s,i){if("string"==typeof e){if("string"==typeof t?(i=t,t=0,s=this.length):"string"==typeof s&&(i=s,s=this.length),void 0!==i&&"string"!=typeof i)throw new TypeError("encoding must be a string");if("string"==typeof i&&!d.isEncoding(i))throw new TypeError("Unknown encoding: "+i);if(1===e.length){const t=e.charCodeAt(0);("utf8"===i&&t<128||"latin1"===i)&&(e=t)}}else"number"==typeof e?e&=255:"boolean"==typeof e&&(e=Number(e));if(t<0||this.length<t||this.length<s)throw new RangeError("Out of range index");if(s<=t)return this;let n;if(t>>>=0,s=void 0===s?this.length:s>>>0,e||(e=0),"number"==typeof e)for(n=t;n<s;++n)this[n]=e;else{const r=d.isBuffer(e)?e:d.from(e,i),o=r.length;if(0===o)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(n=0;n<s-t;++n)this[n+t]=r[n%o]}return this};const K={};function B(e,t,s){K[e]=class extends s{constructor(){super(),Object.defineProperty(this,"message",{value:t.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${e}]`,this.stack,delete this.name}get code(){return e}set code(e){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:e,writable:!0})}toString(){return`${this.name} [${e}]: ${this.message}`}}}function F(e){let t="",s=e.length;const i="-"===e[0]?1:0;for(;s>=i+4;s-=3)t=`_${e.slice(s-3,s)}${t}`;return`${e.slice(0,s)}${t}`}function $(e,t,s,i,n,r){if(e>s||e<t){const i="bigint"==typeof t?"n":"";let n;throw n=r>3?0===t||t===BigInt(0)?`>= 0${i} and < 2${i} ** ${8*(r+1)}${i}`:`>= -(2${i} ** ${8*(r+1)-1}${i}) and < 2 ** ${8*(r+1)-1}${i}`:`>= ${t}${i} and <= ${s}${i}`,new K.ERR_OUT_OF_RANGE("value",n,e)}!function(e,t,s){q(t,"offset"),void 0!==e[t]&&void 0!==e[t+s]||V(t,e.length-(s+1))}(i,n,r)}function q(e,t){if("number"!=typeof e)throw new K.ERR_INVALID_ARG_TYPE(t,"number",e)}function V(e,t,s){if(Math.floor(e)!==e)throw q(e,s),new K.ERR_OUT_OF_RANGE(s||"offset","an integer",e);if(t<0)throw new K.ERR_BUFFER_OUT_OF_BOUNDS;throw new K.ERR_OUT_OF_RANGE(s||"offset",`>= ${s?1:0} and <= ${t}`,e)}B("ERR_BUFFER_OUT_OF_BOUNDS",(function(e){return e?`${e} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"}),RangeError),B("ERR_INVALID_ARG_TYPE",(function(e,t){return`The "${e}" argument must be of type number. Received type ${typeof t}`}),TypeError),B("ERR_OUT_OF_RANGE",(function(e,t,s){let i=`The value of "${e}" is out of range.`,n=s;return Number.isInteger(s)&&Math.abs(s)>2**32?n=F(String(s)):"bigint"==typeof s&&(n=String(s),(s>BigInt(2)**BigInt(32)||s<-(BigInt(2)**BigInt(32)))&&(n=F(n)),n+="n"),i+=` It must be ${t}. Received ${n}`,i}),RangeError);const G=/[^+/0-9A-Za-z-_]/g;function H(e,t){let s;t=t||1/0;const i=e.length;let n=null;const r=[];for(let o=0;o<i;++o){if(s=e.charCodeAt(o),s>55295&&s<57344){if(!n){if(s>56319){(t-=3)>-1&&r.push(239,191,189);continue}if(o+1===i){(t-=3)>-1&&r.push(239,191,189);continue}n=s;continue}if(s<56320){(t-=3)>-1&&r.push(239,191,189),n=s;continue}s=65536+(n-55296<<10|s-56320)}else n&&(t-=3)>-1&&r.push(239,191,189);if(n=null,s<128){if((t-=1)<0)break;r.push(s)}else if(s<2048){if((t-=2)<0)break;r.push(s>>6|192,63&s|128)}else if(s<65536){if((t-=3)<0)break;r.push(s>>12|224,s>>6&63|128,63&s|128)}else{if(!(s<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;r.push(s>>18|240,s>>12&63|128,s>>6&63|128,63&s|128)}}return r}function W(e){return i.toByteArray(function(e){if((e=(e=e.split("=")[0]).trim().replace(G,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function J(e,t,s,i){let n;for(n=0;n<i&&!(n+s>=t.length||n>=e.length);++n)t[n+s]=e[n];return n}function z(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function Q(e){return e!=e}const Y=function(){const e="0123456789abcdef",t=new Array(256);for(let s=0;s<16;++s){const i=16*s;for(let n=0;n<16;++n)t[i+n]=e[s]+e[n]}return t}();function X(e){return"undefined"==typeof BigInt?Z:e}function Z(){throw new Error("BigInt not supported")}},"./node_modules/content-type/index.js":(e,t)=>{"use strict";var s=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,i=/^[\u000b\u0020-\u007e\u0080-\u00ff]+$/,n=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,r=/\\([\u000b\u0020-\u00ff])/g,o=/([\\"])/g,a=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/;function d(e){var t=String(e);if(n.test(t))return t;if(t.length>0&&!i.test(t))throw new TypeError("invalid parameter value");return'"'+t.replace(o,"\\$1")+'"'}function c(e){this.parameters=Object.create(null),this.type=e}t.q=function(e){if(!e)throw new TypeError("argument string is required");var t="object"==typeof e?function(e){var t;"function"==typeof e.getHeader?t=e.getHeader("content-type"):"object"==typeof e.headers&&(t=e.headers&&e.headers["content-type"]);if("string"!=typeof t)throw new TypeError("content-type header is missing from object");return t}(e):e;if("string"!=typeof t)throw new TypeError("argument string is required to be a string");var i=t.indexOf(";"),n=-1!==i?t.slice(0,i).trim():t.trim();if(!a.test(n))throw new TypeError("invalid media type");var o=new c(n.toLowerCase());if(-1!==i){var d,l,u;for(s.lastIndex=i;l=s.exec(t);){if(l.index!==i)throw new TypeError("invalid parameter format");i+=l[0].length,d=l[1].toLowerCase(),34===(u=l[2]).charCodeAt(0)&&-1!==(u=u.slice(1,-1)).indexOf("\\")&&(u=u.replace(r,"$1")),o.parameters[d]=u}if(i!==t.length)throw new TypeError("invalid parameter format")}return o}},"./node_modules/events/events.js":e=>{"use strict";var t,s="object"==typeof Reflect?Reflect:null,i=s&&"function"==typeof s.apply?s.apply:function(e,t,s){return Function.prototype.apply.call(e,t,s)};t=s&&"function"==typeof s.ownKeys?s.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var n=Number.isNaN||function(e){return e!=e};function r(){r.init.call(this)}e.exports=r,e.exports.once=function(e,t){return new Promise((function(s,i){function n(s){e.removeListener(t,r),i(s)}function r(){"function"==typeof e.removeListener&&e.removeListener("error",n),s([].slice.call(arguments))}g(e,t,r,{once:!0}),"error"!==t&&function(e,t,s){"function"==typeof e.on&&g(e,"error",t,s)}(e,n,{once:!0})}))},r.EventEmitter=r,r.prototype._events=void 0,r.prototype._eventsCount=0,r.prototype._maxListeners=void 0;var o=10;function a(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function d(e){return void 0===e._maxListeners?r.defaultMaxListeners:e._maxListeners}function c(e,t,s,i){var n,r,o,c;if(a(s),void 0===(r=e._events)?(r=e._events=Object.create(null),e._eventsCount=0):(void 0!==r.newListener&&(e.emit("newListener",t,s.listener?s.listener:s),r=e._events),o=r[t]),void 0===o)o=r[t]=s,++e._eventsCount;else if("function"==typeof o?o=r[t]=i?[s,o]:[o,s]:i?o.unshift(s):o.push(s),(n=d(e))>0&&o.length>n&&!o.warned){o.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=o.length,c=l,console&&console.warn&&console.warn(c)}return e}function l(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function u(e,t,s){var i={fired:!1,wrapFn:void 0,target:e,type:t,listener:s},n=l.bind(i);return n.listener=s,i.wrapFn=n,n}function h(e,t,s){var i=e._events;if(void 0===i)return[];var n=i[t];return void 0===n?[]:"function"==typeof n?s?[n.listener||n]:[n]:s?function(e){for(var t=new Array(e.length),s=0;s<t.length;++s)t[s]=e[s].listener||e[s];return t}(n):p(n,n.length)}function m(e){var t=this._events;if(void 0!==t){var s=t[e];if("function"==typeof s)return 1;if(void 0!==s)return s.length}return 0}function p(e,t){for(var s=new Array(t),i=0;i<t;++i)s[i]=e[i];return s}function g(e,t,s,i){if("function"==typeof e.on)i.once?e.once(t,s):e.on(t,s);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function n(r){i.once&&e.removeEventListener(t,n),s(r)}))}}Object.defineProperty(r,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(e){if("number"!=typeof e||e<0||n(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");o=e}}),r.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},r.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||n(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},r.prototype.getMaxListeners=function(){return d(this)},r.prototype.emit=function(e){for(var t=[],s=1;s<arguments.length;s++)t.push(arguments[s]);var n="error"===e,r=this._events;if(void 0!==r)n=n&&void 0===r.error;else if(!n)return!1;if(n){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var d=r[e];if(void 0===d)return!1;if("function"==typeof d)i(d,this,t);else{var c=d.length,l=p(d,c);for(s=0;s<c;++s)i(l[s],this,t)}return!0},r.prototype.addListener=function(e,t){return c(this,e,t,!1)},r.prototype.on=r.prototype.addListener,r.prototype.prependListener=function(e,t){return c(this,e,t,!0)},r.prototype.once=function(e,t){return a(t),this.on(e,u(this,e,t)),this},r.prototype.prependOnceListener=function(e,t){return a(t),this.prependListener(e,u(this,e,t)),this},r.prototype.removeListener=function(e,t){var s,i,n,r,o;if(a(t),void 0===(i=this._events))return this;if(void 0===(s=i[e]))return this;if(s===t||s.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,s.listener||t));else if("function"!=typeof s){for(n=-1,r=s.length-1;r>=0;r--)if(s[r]===t||s[r].listener===t){o=s[r].listener,n=r;break}if(n<0)return this;0===n?s.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(s,n),1===s.length&&(i[e]=s[0]),void 0!==i.removeListener&&this.emit("removeListener",e,o||t)}return this},r.prototype.off=r.prototype.removeListener,r.prototype.removeAllListeners=function(e){var t,s,i;if(void 0===(s=this._events))return this;if(void 0===s.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==s[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete s[e]),this;if(0===arguments.length){var n,r=Object.keys(s);for(i=0;i<r.length;++i)"removeListener"!==(n=r[i])&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=s[e]))this.removeListener(e,t);else if(void 0!==t)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this},r.prototype.listeners=function(e){return h(this,e,!0)},r.prototype.rawListeners=function(e){return h(this,e,!1)},r.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):m.call(e,t)},r.prototype.listenerCount=m,r.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}},"./node_modules/ieee754/index.js":(e,t)=>{t.read=function(e,t,s,i,n){var r,o,a=8*n-i-1,d=(1<<a)-1,c=d>>1,l=-7,u=s?n-1:0,h=s?-1:1,m=e[t+u];for(u+=h,r=m&(1<<-l)-1,m>>=-l,l+=a;l>0;r=256*r+e[t+u],u+=h,l-=8);for(o=r&(1<<-l)-1,r>>=-l,l+=i;l>0;o=256*o+e[t+u],u+=h,l-=8);if(0===r)r=1-c;else{if(r===d)return o?NaN:1/0*(m?-1:1);o+=Math.pow(2,i),r-=c}return(m?-1:1)*o*Math.pow(2,r-i)},t.write=function(e,t,s,i,n,r){var o,a,d,c=8*r-n-1,l=(1<<c)-1,u=l>>1,h=23===n?Math.pow(2,-24)-Math.pow(2,-77):0,m=i?0:r-1,p=i?1:-1,g=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,o=l):(o=Math.floor(Math.log(t)/Math.LN2),t*(d=Math.pow(2,-o))<1&&(o--,d*=2),(t+=o+u>=1?h/d:h*Math.pow(2,1-u))*d>=2&&(o++,d/=2),o+u>=l?(a=0,o=l):o+u>=1?(a=(t*d-1)*Math.pow(2,n),o+=u):(a=t*Math.pow(2,u-1)*Math.pow(2,n),o=0));n>=8;e[s+m]=255&a,m+=p,a/=256,n-=8);for(o=o<<n|a,c+=n;c>0;e[s+m]=255&o,m+=p,o/=256,c-=8);e[s+m-p]|=128*g}},"./node_modules/loglevel/lib/loglevel.js":function(e,t,s){var i,n;!function(){"use strict";i=function(){var e=function(){},t="undefined",s=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),i=["trace","debug","info","warn","error"],n={},r=null;function o(e,t){var s=e[t];if("function"==typeof s.bind)return s.bind(e);try{return Function.prototype.bind.call(s,e)}catch(t){return function(){return Function.prototype.apply.apply(s,[e,arguments])}}}function a(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function d(i){return"debug"===i&&(i="log"),typeof console!==t&&("trace"===i&&s?a:void 0!==console[i]?o(console,i):void 0!==console.log?o(console,"log"):e)}function c(){for(var s=this.getLevel(),n=0;n<i.length;n++){var r=i[n];this[r]=n<s?e:this.methodFactory(r,s,this.name)}if(this.log=this.debug,typeof console===t&&s<this.levels.SILENT)return"No console available for logging"}function l(e){return function(){typeof console!==t&&(c.call(this),this[e].apply(this,arguments))}}function u(e,t,s){return d(e)||l.apply(this,arguments)}function h(e,s){var o,a,d,l=this,h="loglevel";function m(e){var s=(i[e]||"silent").toUpperCase();if(typeof window!==t&&h){try{return void(window.localStorage[h]=s)}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"="+s+";"}catch(e){}}}function p(){var e;if(typeof window!==t&&h){try{e=window.localStorage[h]}catch(e){}if(typeof e===t)try{var s=window.document.cookie,i=encodeURIComponent(h),n=s.indexOf(i+"=");-1!==n&&(e=/^([^;]+)/.exec(s.slice(n+i.length+1))[1])}catch(e){}return void 0===l.levels[e]&&(e=void 0),e}}function g(){if(typeof window!==t&&h){try{window.localStorage.removeItem(h)}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}function v(e){var t=e;if("string"==typeof t&&void 0!==l.levels[t.toUpperCase()]&&(t=l.levels[t.toUpperCase()]),"number"==typeof t&&t>=0&&t<=l.levels.SILENT)return t;throw new TypeError("log.setLevel() called with invalid level: "+e)}"string"==typeof e?h+=":"+e:"symbol"==typeof e&&(h=void 0),l.name=e,l.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},l.methodFactory=s||u,l.getLevel=function(){return null!=d?d:null!=a?a:o},l.setLevel=function(e,t){return d=v(e),!1!==t&&m(d),c.call(l)},l.setDefaultLevel=function(e){a=v(e),p()||l.setLevel(e,!1)},l.resetLevel=function(){d=null,g(),c.call(l)},l.enableAll=function(e){l.setLevel(l.levels.TRACE,e)},l.disableAll=function(e){l.setLevel(l.levels.SILENT,e)},l.rebuild=function(){if(r!==l&&(o=v(r.getLevel())),c.call(l),r===l)for(var e in n)n[e].rebuild()},o=v(r?r.getLevel():"WARN");var f=p();null!=f&&(d=v(f)),c.call(l)}(r=new h).getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=n[e];return t||(t=n[e]=new h(e,r.methodFactory)),t};var m=typeof window!==t?window.log:void 0;return r.noConflict=function(){return typeof window!==t&&window.log===r&&(window.log=m),r},r.getLoggers=function(){return n},r.default=r,r},void 0===(n="function"==typeof i?i.call(t,s,t,e):i)||(e.exports=n)}()},"./node_modules/matrix-events-sdk/lib/ExtensibleEvents.js":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExtensibleEvents=void 0;var i=s("./node_modules/matrix-events-sdk/lib/NamespacedMap.js"),n=s("./node_modules/matrix-events-sdk/lib/InvalidEventError.js"),r=s("./node_modules/matrix-events-sdk/lib/interpreters/legacy/MRoomMessage.js"),o=s("./node_modules/matrix-events-sdk/lib/interpreters/modern/MMessage.js"),a=s("./node_modules/matrix-events-sdk/lib/events/message_types.js"),d=s("./node_modules/matrix-events-sdk/lib/events/poll_types.js"),c=s("./node_modules/matrix-events-sdk/lib/interpreters/modern/MPoll.js");function l(e,t){var s="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!s){if(Array.isArray(e)||(s=function(e,t){if(!e)return;if("string"==typeof e)return u(e,t);var s=Object.prototype.toString.call(e).slice(8,-1);"Object"===s&&e.constructor&&(s=e.constructor.name);if("Map"===s||"Set"===s)return Array.from(e);if("Arguments"===s||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s))return u(e,t)}(e))||t&&e&&"number"==typeof e.length){s&&(e=s);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,o=!0,a=!1;return{s:function(){s=s.call(e)},n:function(){var e=s.next();return o=e.done,e},e:function(e){a=!0,r=e},f:function(){try{o||null==s.return||s.return()}finally{if(a)throw r}}}}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var s=0,i=new Array(t);s<t;s++)i[s]=e[s];return i}function h(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function m(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}var p=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),m(this,"interpreters",new i.NamespacedMap([[r.LEGACY_M_ROOM_MESSAGE,r.parseMRoomMessage],[a.M_MESSAGE,o.parseMMessage],[a.M_EMOTE,o.parseMMessage],[a.M_NOTICE,o.parseMMessage],[d.M_POLL_START,c.parseMPoll],[d.M_POLL_RESPONSE,c.parseMPoll],[d.M_POLL_END,c.parseMPoll]])),m(this,"_unknownInterpretOrder",[a.M_MESSAGE])}var t,s,u;return t=e,u=[{key:"defaultInstance",get:function(){return e._defaultInstance}},{key:"unknownInterpretOrder",get:function(){return e.defaultInstance.unknownInterpretOrder},set:function(t){e.defaultInstance.unknownInterpretOrder=t}},{key:"registerInterpreter",value:function(t,s){e.defaultInstance.registerInterpreter(t,s)}},{key:"parse",value:function(t){return e.defaultInstance.parse(t)}}],(s=[{key:"unknownInterpretOrder",get:function(){var e;return null!==(e=this._unknownInterpretOrder)&&void 0!==e?e:[]},set:function(e){this._unknownInterpretOrder=e}},{key:"registerInterpreter",value:function(e,t){this.interpreters.set(e,t)}},{key:"parse",value:function(e){try{if(this.interpreters.hasNamespaced(e.type))return this.interpreters.getNamespaced(e.type)(e);var t,s=l(this.unknownInterpretOrder);try{for(s.s();!(t=s.n()).done;){var i=t.value;if(this.interpreters.has(i)){var r=this.interpreters.get(i)(e);if(r)return r}}}catch(e){s.e(e)}finally{s.f()}return null}catch(e){if(e instanceof n.InvalidEventError)return null;throw e}}}])&&h(t.prototype,s),u&&h(t,u),Object.defineProperty(t,"prototype",{writable:!1}),e}();t.ExtensibleEvents=p,m(p,"_defaultInstance",new p)},"./node_modules/matrix-events-sdk/lib/IPartialEvent.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-events-sdk/lib/InvalidEventError.js":(e,t)=>{"use strict";function s(e){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s(e)}function i(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function n(e){var t=a();return function(){var i,n=c(e);if(t){var r=c(this).constructor;i=Reflect.construct(n,arguments,r)}else i=n.apply(this,arguments);return function(e,t){if(t&&("object"===s(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(this,i)}}function r(e){var t="function"==typeof Map?new Map:void 0;return r=function(e){if(null===e||(s=e,-1===Function.toString.call(s).indexOf("[native code]")))return e;var s;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return o(e,arguments,c(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),d(i,e)},r(e)}function o(e,t,s){return o=a()?Reflect.construct:function(e,t,s){var i=[null];i.push.apply(i,t);var n=new(Function.bind.apply(e,i));return s&&d(n,s.prototype),n},o.apply(null,arguments)}function a(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function d(e,t){return d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},d(e,t)}function c(e){return c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},c(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidEventError=void 0;var l=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&d(e,t)}(a,e);var t,s,r,o=n(a);function a(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a),o.call(this,e)}return t=a,s&&i(t.prototype,s),r&&i(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}(r(Error));t.InvalidEventError=l},"./node_modules/matrix-events-sdk/lib/NamespacedMap.js":(e,t)=>{"use strict";function s(e,t){var s="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!s){if(Array.isArray(e)||(s=function(e,t){if(!e)return;if("string"==typeof e)return i(e,t);var s=Object.prototype.toString.call(e).slice(8,-1);"Object"===s&&e.constructor&&(s=e.constructor.name);if("Map"===s||"Set"===s)return Array.from(e);if("Arguments"===s||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s))return i(e,t)}(e))||t&&e&&"number"==typeof e.length){s&&(e=s);var n=0,r=function(){};return{s:r,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,d=!1;return{s:function(){s=s.call(e)},n:function(){var e=s.next();return a=e.done,e},e:function(e){d=!0,o=e},f:function(){try{a||null==s.return||s.return()}finally{if(d)throw o}}}}function i(e,t){(null==t||t>e.length)&&(t=e.length);for(var s=0,i=new Array(t);s<t;s++)i[s]=e[s];return i}function n(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}Object.defineProperty(t,"__esModule",{value:!0}),t.NamespacedMap=void 0;var r=function(){function e(t){var i,n,r;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),i=this,n="internalMap",r=new Map,n in i?Object.defineProperty(i,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):i[n]=r,t){var o,a=s(t);try{for(a.s();!(o=a.n()).done;){var d=o.value;this.set(d[0],d[1])}}catch(e){a.e(e)}finally{a.f()}}}var t,i,r;return t=e,(i=[{key:"get",value:function(e){return e.name&&this.internalMap.has(e.name)?this.internalMap.get(e.name):e.altName&&this.internalMap.has(e.altName)?this.internalMap.get(e.altName):null}},{key:"set",value:function(e,t){e.name&&this.internalMap.set(e.name,t),e.altName&&this.internalMap.set(e.altName,t)}},{key:"has",value:function(e){return!!this.get(e)}},{key:"delete",value:function(e){e.name&&this.internalMap.delete(e.name),e.altName&&this.internalMap.delete(e.altName)}},{key:"hasNamespaced",value:function(e){return this.internalMap.has(e)}},{key:"getNamespaced",value:function(e){return this.internalMap.get(e)}}])&&n(t.prototype,i),r&&n(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();t.NamespacedMap=r},"./node_modules/matrix-events-sdk/lib/NamespacedValue.js":(e,t)=>{"use strict";function s(e){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s(e)}function i(e,t){return i=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},i(e,t)}function n(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var i,n=r(e);if(t){var o=r(this).constructor;i=Reflect.construct(n,arguments,o)}else i=n.apply(this,arguments);return function(e,t){if(t&&("object"===s(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(this,i)}}function r(e){return r=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},r(e)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function d(e,t,s){return t&&a(e.prototype,t),s&&a(e,s),Object.defineProperty(e,"prototype",{writable:!1}),e}Object.defineProperty(t,"__esModule",{value:!0}),t.UnstableValue=t.NamespacedValue=void 0;var c=function(){function e(t,s){if(o(this,e),this.stable=t,this.unstable=s,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}return d(e,[{key:"name",get:function(){return this.stable?this.stable:this.unstable}},{key:"altName",get:function(){return this.stable?this.unstable:null}},{key:"matches",value:function(e){return!!this.name&&this.name===e||!!this.altName&&this.altName===e}},{key:"findIn",value:function(e){var t;return this.name&&(t=null==e?void 0:e[this.name]),!t&&this.altName&&(t=null==e?void 0:e[this.altName]),t}},{key:"includedIn",value:function(e){var t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}}]),e}();t.NamespacedValue=c;var l=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&i(e,t)}(s,e);var t=n(s);function s(e,i){var n;if(o(this,s),!(n=t.call(this,e,i)).unstable)throw new Error("Unstable value must be supplied");return n}return d(s,[{key:"name",get:function(){return this.unstable}},{key:"altName",get:function(){return this.stable}}]),s}(c);t.UnstableValue=l},"./node_modules/matrix-events-sdk/lib/events/EmoteEvent.js":(e,t,s)=>{"use strict";function i(e){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.EmoteEvent=void 0;var n=s("./node_modules/matrix-events-sdk/lib/events/MessageEvent.js"),r=s("./node_modules/matrix-events-sdk/lib/events/message_types.js"),o=s("./node_modules/matrix-events-sdk/lib/utility/events.js");function a(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function d(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function c(){return c="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,s){var i=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=h(e)););return e}(e,t);if(i){var n=Object.getOwnPropertyDescriptor(i,t);return n.get?n.get.call(arguments.length<3?e:s):n.value}},c.apply(this,arguments)}function l(e,t){return l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},l(e,t)}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var s,n=h(e);if(t){var r=h(this).constructor;s=Reflect.construct(n,arguments,r)}else s=n.apply(this,arguments);return function(e,t){if(t&&("object"===i(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(this,s)}}function h(e){return h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},h(e)}var m=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&l(e,t)}(m,e);var t,s,i,n=u(m);function m(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,m),n.call(this,e)}return t=m,i=[{key:"from",value:function(e,t){var s;return new m({type:r.M_EMOTE.name,content:(s={},a(s,r.M_TEXT.name,e),a(s,r.M_HTML.name,t),s)})}}],(s=[{key:"isEmote",get:function(){return!0}},{key:"isEquivalentTo",value:function(e){return(0,o.isEventTypeSame)(e,r.M_EMOTE)||c(h(m.prototype),"isEquivalentTo",this).call(this,e)}},{key:"serialize",value:function(){var e=c(h(m.prototype),"serialize",this).call(this);return e.content.msgtype="m.emote",e}}])&&d(t.prototype,s),i&&d(t,i),Object.defineProperty(t,"prototype",{writable:!1}),m}(n.MessageEvent);t.EmoteEvent=m},"./node_modules/matrix-events-sdk/lib/events/ExtensibleEvent.js":(e,t)=>{"use strict";function s(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}Object.defineProperty(t,"__esModule",{value:!0}),t.ExtensibleEvent=void 0;var i=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.wireFormat=t}var t,i,n;return t=e,(i=[{key:"wireContent",get:function(){return this.wireFormat.content}}])&&s(t.prototype,i),n&&s(t,n),Object.defineProperty(t,"prototype",{writable:!1}),e}();t.ExtensibleEvent=i},"./node_modules/matrix-events-sdk/lib/events/MessageEvent.js":(e,t,s)=>{"use strict";function i(e){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.MessageEvent=void 0;var n=s("./node_modules/matrix-events-sdk/lib/events/ExtensibleEvent.js"),r=s("./node_modules/matrix-events-sdk/lib/types.js"),o=s("./node_modules/matrix-events-sdk/lib/InvalidEventError.js"),a=s("./node_modules/matrix-events-sdk/lib/events/message_types.js"),d=s("./node_modules/matrix-events-sdk/lib/utility/events.js");function c(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function l(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?c(Object(s),!0).forEach((function(t){v(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):c(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}function u(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function h(e,t){return h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},h(e,t)}function m(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var s,n=g(e);if(t){var r=g(this).constructor;s=Reflect.construct(n,arguments,r)}else s=n.apply(this,arguments);return function(e,t){if(t&&("object"===i(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return p(e)}(this,s)}}function p(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function g(e){return g=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},g(e)}function v(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}var f=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&h(e,t)}(c,e);var t,s,i,n=m(c);function c(e){var t;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,c),v(p(t=n.call(this,e)),"text",void 0),v(p(t),"html",void 0),v(p(t),"renderings",void 0);var s=a.M_MESSAGE.findIn(t.wireContent),i=a.M_TEXT.findIn(t.wireContent),d=a.M_HTML.findIn(t.wireContent);if((0,r.isProvided)(s)){if(!Array.isArray(s))throw new o.InvalidEventError("m.message contents must be an array");var l=s.find((function(e){return!(0,r.isProvided)(e.mimetype)||"text/plain"===e.mimetype})),u=s.find((function(e){return"text/html"===e.mimetype}));if(!l)throw new o.InvalidEventError("m.message is missing a plain text representation");t.text=l.body,t.html=null==u?void 0:u.body,t.renderings=s}else{if(!(0,r.isOptionalAString)(i))throw new o.InvalidEventError("Missing textual representation for event");t.text=i,t.html=d,t.renderings=[{body:i,mimetype:"text/plain"}],t.html&&t.renderings.push({body:t.html,mimetype:"text/html"})}return t}return t=c,i=[{key:"from",value:function(e,t){var s;return new c({type:a.M_MESSAGE.name,content:(s={},v(s,a.M_TEXT.name,e),v(s,a.M_HTML.name,t),s)})}}],(s=[{key:"isEmote",get:function(){return a.M_EMOTE.matches(this.wireFormat.type)||(0,r.isProvided)(a.M_EMOTE.findIn(this.wireFormat.content))}},{key:"isNotice",get:function(){return a.M_NOTICE.matches(this.wireFormat.type)||(0,r.isProvided)(a.M_NOTICE.findIn(this.wireFormat.content))}},{key:"isEquivalentTo",value:function(e){return(0,d.isEventTypeSame)(e,a.M_MESSAGE)}},{key:"serializeMMessageOnly",value:function(){var e=v({},a.M_MESSAGE.name,this.renderings);if(1===this.renderings.length){var t=this.renderings[0].mimetype;void 0!==t&&"text/plain"!==t||(e=v({},a.M_TEXT.name,this.renderings[0].body))}return e}},{key:"serialize",value:function(){var e;return{type:"m.room.message",content:l(l({},this.serializeMMessageOnly()),{},{body:this.text,msgtype:"m.text",format:this.html?"org.matrix.custom.html":void 0,formatted_body:null!==(e=this.html)&&void 0!==e?e:void 0})}}}])&&u(t.prototype,s),i&&u(t,i),Object.defineProperty(t,"prototype",{writable:!1}),c}(n.ExtensibleEvent);t.MessageEvent=f},"./node_modules/matrix-events-sdk/lib/events/NoticeEvent.js":(e,t,s)=>{"use strict";function i(e){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.NoticeEvent=void 0;var n=s("./node_modules/matrix-events-sdk/lib/events/MessageEvent.js"),r=s("./node_modules/matrix-events-sdk/lib/events/message_types.js"),o=s("./node_modules/matrix-events-sdk/lib/utility/events.js");function a(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function d(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function c(){return c="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,s){var i=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=h(e)););return e}(e,t);if(i){var n=Object.getOwnPropertyDescriptor(i,t);return n.get?n.get.call(arguments.length<3?e:s):n.value}},c.apply(this,arguments)}function l(e,t){return l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},l(e,t)}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var s,n=h(e);if(t){var r=h(this).constructor;s=Reflect.construct(n,arguments,r)}else s=n.apply(this,arguments);return function(e,t){if(t&&("object"===i(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(this,s)}}function h(e){return h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},h(e)}var m=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&l(e,t)}(m,e);var t,s,i,n=u(m);function m(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,m),n.call(this,e)}return t=m,i=[{key:"from",value:function(e,t){var s;return new m({type:r.M_NOTICE.name,content:(s={},a(s,r.M_TEXT.name,e),a(s,r.M_HTML.name,t),s)})}}],(s=[{key:"isNotice",get:function(){return!0}},{key:"isEquivalentTo",value:function(e){return(0,o.isEventTypeSame)(e,r.M_NOTICE)||c(h(m.prototype),"isEquivalentTo",this).call(this,e)}},{key:"serialize",value:function(){var e=c(h(m.prototype),"serialize",this).call(this);return e.content.msgtype="m.notice",e}}])&&d(t.prototype,s),i&&d(t,i),Object.defineProperty(t,"prototype",{writable:!1}),m}(n.MessageEvent);t.NoticeEvent=m},"./node_modules/matrix-events-sdk/lib/events/PollEndEvent.js":(e,t,s)=>{"use strict";function i(e){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.PollEndEvent=void 0;var n=s("./node_modules/matrix-events-sdk/lib/events/poll_types.js"),r=s("./node_modules/matrix-events-sdk/lib/InvalidEventError.js"),o=s("./node_modules/matrix-events-sdk/lib/events/relationship_types.js"),a=s("./node_modules/matrix-events-sdk/lib/events/MessageEvent.js"),d=s("./node_modules/matrix-events-sdk/lib/events/message_types.js"),c=s("./node_modules/matrix-events-sdk/lib/utility/events.js");function l(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function u(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?l(Object(s),!0).forEach((function(t){f(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):l(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}function h(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function m(e,t){return m=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},m(e,t)}function p(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var s,n=v(e);if(t){var r=v(this).constructor;s=Reflect.construct(n,arguments,r)}else s=n.apply(this,arguments);return function(e,t){if(t&&("object"===i(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return g(e)}(this,s)}}function g(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function v(e){return v=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},v(e)}function f(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}var y=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&m(e,t)}(v,e);var t,s,i,l=p(v);function v(e){var t;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,v),f(g(t=l.call(this,e)),"pollEventId",void 0),f(g(t),"closingMessage",void 0);var s=t.wireContent["m.relates_to"];if(!o.REFERENCE_RELATION.matches(null==s?void 0:s.rel_type)||"string"!=typeof(null==s?void 0:s.event_id))throw new r.InvalidEventError("Relationship must be a reference to an event");return t.pollEventId=s.event_id,t.closingMessage=new a.MessageEvent(t.wireFormat),t}return t=v,i=[{key:"from",value:function(e,t){var s;return new v({type:n.M_POLL_END.name,content:(s={"m.relates_to":{rel_type:o.REFERENCE_RELATION.name,event_id:e}},f(s,n.M_POLL_END.name,{}),f(s,d.M_TEXT.name,t),s)})}}],(s=[{key:"isEquivalentTo",value:function(e){return(0,c.isEventTypeSame)(e,n.M_POLL_END)}},{key:"serialize",value:function(){return{type:n.M_POLL_END.name,content:u(f({"m.relates_to":{rel_type:o.REFERENCE_RELATION.name,event_id:this.pollEventId}},n.M_POLL_END.name,{}),this.closingMessage.serialize().content)}}}])&&h(t.prototype,s),i&&h(t,i),Object.defineProperty(t,"prototype",{writable:!1}),v}(s("./node_modules/matrix-events-sdk/lib/events/ExtensibleEvent.js").ExtensibleEvent);t.PollEndEvent=y},"./node_modules/matrix-events-sdk/lib/events/PollResponseEvent.js":(e,t,s)=>{"use strict";function i(e){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.PollResponseEvent=void 0;var n=s("./node_modules/matrix-events-sdk/lib/events/ExtensibleEvent.js"),r=s("./node_modules/matrix-events-sdk/lib/events/poll_types.js"),o=s("./node_modules/matrix-events-sdk/lib/InvalidEventError.js"),a=s("./node_modules/matrix-events-sdk/lib/events/relationship_types.js"),d=s("./node_modules/matrix-events-sdk/lib/utility/events.js");function c(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e,t){return l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},l(e,t)}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var s,n=m(e);if(t){var r=m(this).constructor;s=Reflect.construct(n,arguments,r)}else s=n.apply(this,arguments);return function(e,t){if(t&&("object"===i(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return h(e)}(this,s)}}function h(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function m(e){return m=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},m(e)}function p(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}var g=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&l(e,t)}(m,e);var t,s,i,n=u(m);function m(e){var t;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,m),p(h(t=n.call(this,e)),"internalAnswerIds",void 0),p(h(t),"internalSpoiled",void 0),p(h(t),"pollEventId",void 0);var s=t.wireContent["m.relates_to"];if(!a.REFERENCE_RELATION.matches(null==s?void 0:s.rel_type)||"string"!=typeof(null==s?void 0:s.event_id))throw new o.InvalidEventError("Relationship must be a reference to an event");return t.pollEventId=s.event_id,t.validateAgainst(null),t}return t=m,i=[{key:"from",value:function(e,t){return new m({type:r.M_POLL_RESPONSE.name,content:p({"m.relates_to":{rel_type:a.REFERENCE_RELATION.name,event_id:t}},r.M_POLL_RESPONSE.name,{answers:e})})}}],(s=[{key:"answerIds",get:function(){return this.internalAnswerIds}},{key:"spoiled",get:function(){return this.internalSpoiled}},{key:"validateAgainst",value:function(e){var t=r.M_POLL_RESPONSE.findIn(this.wireContent);if(!Array.isArray(null==t?void 0:t.answers))return this.internalSpoiled=!0,void(this.internalAnswerIds=[]);var s=t.answers;if(s.some((function(e){return"string"!=typeof e}))||0===s.length)return this.internalSpoiled=!0,void(this.internalAnswerIds=[]);if(e){if(s.some((function(t){return!e.answers.some((function(e){return e.id===t}))})))return this.internalSpoiled=!0,void(this.internalAnswerIds=[]);s=s.slice(0,e.maxSelections)}this.internalAnswerIds=s,this.internalSpoiled=!1}},{key:"isEquivalentTo",value:function(e){return(0,d.isEventTypeSame)(e,r.M_POLL_RESPONSE)}},{key:"serialize",value:function(){return{type:r.M_POLL_RESPONSE.name,content:p({"m.relates_to":{rel_type:a.REFERENCE_RELATION.name,event_id:this.pollEventId}},r.M_POLL_RESPONSE.name,{answers:this.spoiled?void 0:this.answerIds})}}}])&&c(t.prototype,s),i&&c(t,i),Object.defineProperty(t,"prototype",{writable:!1}),m}(n.ExtensibleEvent);t.PollResponseEvent=g},"./node_modules/matrix-events-sdk/lib/events/PollStartEvent.js":(e,t,s)=>{"use strict";function i(e){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.PollStartEvent=t.PollAnswerSubevent=void 0;var n=s("./node_modules/matrix-events-sdk/lib/events/poll_types.js"),r=s("./node_modules/matrix-events-sdk/lib/events/MessageEvent.js"),o=s("./node_modules/matrix-events-sdk/lib/events/message_types.js"),a=s("./node_modules/matrix-events-sdk/lib/InvalidEventError.js"),d=s("./node_modules/matrix-events-sdk/lib/NamespacedValue.js"),c=s("./node_modules/matrix-events-sdk/lib/utility/events.js"),l=s("./node_modules/matrix-events-sdk/lib/events/ExtensibleEvent.js");function u(e){return function(e){if(Array.isArray(e))return h(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return h(e,t);var s=Object.prototype.toString.call(e).slice(8,-1);"Object"===s&&e.constructor&&(s=e.constructor.name);if("Map"===s||"Set"===s)return Array.from(e);if("Arguments"===s||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s))return h(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function h(e,t){(null==t||t>e.length)&&(t=e.length);for(var s=0,i=new Array(t);s<t;s++)i[s]=e[s];return i}function m(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function p(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?m(Object(s),!0).forEach((function(t){I(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):m(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}function g(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function v(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function f(e,t,s){return t&&v(e.prototype,t),s&&v(e,s),Object.defineProperty(e,"prototype",{writable:!1}),e}function y(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&S(e,t)}function S(e,t){return S=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},S(e,t)}function b(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var s,n=w(e);if(t){var r=w(this).constructor;s=Reflect.construct(n,arguments,r)}else s=n.apply(this,arguments);return function(e,t){if(t&&("object"===i(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return E(e)}(this,s)}}function E(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function w(e){return w=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},w(e)}function I(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}var _=function(e){y(s,e);var t=b(s);function s(e){var i;g(this,s),I(E(i=t.call(this,e)),"id",void 0);var n=e.content.id;if(!n||"string"!=typeof n)throw new a.InvalidEventError("Answer ID must be a non-empty string");return i.id=n,i}return f(s,[{key:"serialize",value:function(){return{type:"org.matrix.sdk.poll.answer",content:p({id:this.id},this.serializeMMessageOnly())}}}],[{key:"from",value:function(e,t){return new s({type:"org.matrix.sdk.poll.answer",content:I({id:e},o.M_TEXT.name,t)})}}]),s}(r.MessageEvent);t.PollAnswerSubevent=_;var k=function(e){y(s,e);var t=b(s);function s(e){var i;g(this,s),I(E(i=t.call(this,e)),"question",void 0),I(E(i),"kind",void 0),I(E(i),"rawKind",void 0),I(E(i),"maxSelections",void 0),I(E(i),"answers",void 0);var o=n.M_POLL_START.findIn(i.wireContent);if(!o.question)throw new a.InvalidEventError("A question is required");if(i.question=new r.MessageEvent({type:"org.matrix.sdk.poll.question",content:o.question}),i.rawKind=o.kind,n.M_POLL_KIND_DISCLOSED.matches(i.rawKind)?i.kind=n.M_POLL_KIND_DISCLOSED:i.kind=n.M_POLL_KIND_UNDISCLOSED,i.maxSelections=Number.isFinite(o.max_selections)&&o.max_selections>0?o.max_selections:1,!Array.isArray(o.answers))throw new a.InvalidEventError("Poll answers must be an array");var d=o.answers.slice(0,20).map((function(e){return new _({type:"org.matrix.sdk.poll.answer",content:e})}));if(d.length<=0)throw new a.InvalidEventError("No answers available");return i.answers=d,i}return f(s,[{key:"isEquivalentTo",value:function(e){return(0,c.isEventTypeSame)(e,n.M_POLL_START)}},{key:"serialize",value:function(){var e;return{type:n.M_POLL_START.name,content:(e={},I(e,n.M_POLL_START.name,{question:this.question.serialize().content,kind:this.rawKind,max_selections:this.maxSelections,answers:this.answers.map((function(e){return e.serialize().content}))}),I(e,o.M_TEXT.name,"".concat(this.question.text,"\n").concat(this.answers.map((function(e,t){return"".concat(t+1,". ").concat(e.text)})).join("\n"))),e)}}}],[{key:"from",value:function(e,t,i){var r,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return new s({type:n.M_POLL_START.name,content:(r={},I(r,o.M_TEXT.name,e),I(r,n.M_POLL_START.name,{question:I({},o.M_TEXT.name,e),kind:i instanceof d.NamespacedValue?i.name:i,max_selections:a,answers:t.map((function(e){return I({id:u(Array(16)).map((function(){return R.charAt(Math.floor(Math.random()*R.length))})).join("")},o.M_TEXT.name,e)}))}),r)})}}]),s}(l.ExtensibleEvent);t.PollStartEvent=k;var R="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"},"./node_modules/matrix-events-sdk/lib/events/message_types.js":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.M_TEXT=t.M_NOTICE=t.M_MESSAGE=t.M_HTML=t.M_EMOTE=void 0;var i=s("./node_modules/matrix-events-sdk/lib/NamespacedValue.js"),n=new i.UnstableValue("m.message","org.matrix.msc1767.message");t.M_MESSAGE=n;var r=new i.UnstableValue("m.text","org.matrix.msc1767.text");t.M_TEXT=r;var o=new i.UnstableValue("m.html","org.matrix.msc1767.html");t.M_HTML=o;var a=new i.UnstableValue("m.emote","org.matrix.msc1767.emote");t.M_EMOTE=a;var d=new i.UnstableValue("m.notice","org.matrix.msc1767.notice");t.M_NOTICE=d},"./node_modules/matrix-events-sdk/lib/events/poll_types.js":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.M_POLL_START=t.M_POLL_RESPONSE=t.M_POLL_KIND_UNDISCLOSED=t.M_POLL_KIND_DISCLOSED=t.M_POLL_END=void 0;var i=s("./node_modules/matrix-events-sdk/lib/NamespacedValue.js"),n=new i.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed");t.M_POLL_KIND_DISCLOSED=n;var r=new i.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed");t.M_POLL_KIND_UNDISCLOSED=r;var o=new i.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start");t.M_POLL_START=o;var a=new i.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response");t.M_POLL_RESPONSE=a;var d=new i.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end");t.M_POLL_END=d},"./node_modules/matrix-events-sdk/lib/events/relationship_types.js":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.REFERENCE_RELATION=void 0;var i=new(s("./node_modules/matrix-events-sdk/lib/NamespacedValue.js").NamespacedValue)("m.reference");t.REFERENCE_RELATION=i},"./node_modules/matrix-events-sdk/lib/index.js":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=s("./node_modules/matrix-events-sdk/lib/ExtensibleEvents.js");Object.keys(i).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===i[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return i[e]}}))}));var n=s("./node_modules/matrix-events-sdk/lib/IPartialEvent.js");Object.keys(n).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===n[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return n[e]}}))}));var r=s("./node_modules/matrix-events-sdk/lib/InvalidEventError.js");Object.keys(r).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===r[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return r[e]}}))}));var o=s("./node_modules/matrix-events-sdk/lib/NamespacedValue.js");Object.keys(o).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===o[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}}))}));var a=s("./node_modules/matrix-events-sdk/lib/NamespacedMap.js");Object.keys(a).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===a[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))}));var d=s("./node_modules/matrix-events-sdk/lib/types.js");Object.keys(d).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===d[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}}))}));var c=s("./node_modules/matrix-events-sdk/lib/utility/MessageMatchers.js");Object.keys(c).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===c[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return c[e]}}))}));var l=s("./node_modules/matrix-events-sdk/lib/utility/events.js");Object.keys(l).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===l[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return l[e]}}))}));var u=s("./node_modules/matrix-events-sdk/lib/interpreters/legacy/MRoomMessage.js");Object.keys(u).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===u[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return u[e]}}))}));var h=s("./node_modules/matrix-events-sdk/lib/interpreters/modern/MMessage.js");Object.keys(h).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===h[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return h[e]}}))}));var m=s("./node_modules/matrix-events-sdk/lib/interpreters/modern/MPoll.js");Object.keys(m).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===m[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return m[e]}}))}));var p=s("./node_modules/matrix-events-sdk/lib/events/relationship_types.js");Object.keys(p).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===p[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return p[e]}}))}));var g=s("./node_modules/matrix-events-sdk/lib/events/ExtensibleEvent.js");Object.keys(g).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===g[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return g[e]}}))}));var v=s("./node_modules/matrix-events-sdk/lib/events/message_types.js");Object.keys(v).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===v[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return v[e]}}))}));var f=s("./node_modules/matrix-events-sdk/lib/events/MessageEvent.js");Object.keys(f).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===f[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return f[e]}}))}));var y=s("./node_modules/matrix-events-sdk/lib/events/EmoteEvent.js");Object.keys(y).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===y[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return y[e]}}))}));var S=s("./node_modules/matrix-events-sdk/lib/events/NoticeEvent.js");Object.keys(S).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===S[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return S[e]}}))}));var b=s("./node_modules/matrix-events-sdk/lib/events/poll_types.js");Object.keys(b).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===b[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return b[e]}}))}));var E=s("./node_modules/matrix-events-sdk/lib/events/PollStartEvent.js");Object.keys(E).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===E[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return E[e]}}))}));var w=s("./node_modules/matrix-events-sdk/lib/events/PollResponseEvent.js");Object.keys(w).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===w[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return w[e]}}))}));var I=s("./node_modules/matrix-events-sdk/lib/events/PollEndEvent.js");Object.keys(I).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===I[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return I[e]}}))}))},"./node_modules/matrix-events-sdk/lib/interpreters/legacy/MRoomMessage.js":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LEGACY_M_ROOM_MESSAGE=void 0,t.parseMRoomMessage=function(e){var t,s,o;if(a.M_MESSAGE.findIn(e.content)||a.M_TEXT.findIn(e.content))return new i.MessageEvent(e);var d,u=null===(t=e.content)||void 0===t?void 0:t.msgtype,h=null===(s=e.content)||void 0===s?void 0:s.body,m="org.matrix.custom.html"===(null===(o=e.content)||void 0===o?void 0:o.format)?e.content.formatted_body:null;return"m.text"===u?new i.MessageEvent(c(c({},e),{},{content:c(c({},e.content),{},(d={},l(d,a.M_TEXT.name,h),l(d,a.M_HTML.name,m),d))})):"m.notice"===u?new n.NoticeEvent(c(c({},e),{},{content:c(c({},e.content),{},(p={},l(p,a.M_TEXT.name,h),l(p,a.M_HTML.name,m),p))})):"m.emote"===u?new r.EmoteEvent(c(c({},e),{},{content:c(c({},e.content),{},(g={},l(g,a.M_TEXT.name,h),l(g,a.M_HTML.name,m),g))})):null;var p,g};var i=s("./node_modules/matrix-events-sdk/lib/events/MessageEvent.js"),n=s("./node_modules/matrix-events-sdk/lib/events/NoticeEvent.js"),r=s("./node_modules/matrix-events-sdk/lib/events/EmoteEvent.js"),o=s("./node_modules/matrix-events-sdk/lib/NamespacedValue.js"),a=s("./node_modules/matrix-events-sdk/lib/events/message_types.js");function d(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,i)}return s}function c(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?d(Object(s),!0).forEach((function(t){l(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):d(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}function l(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}var u=new o.NamespacedValue("m.room.message");t.LEGACY_M_ROOM_MESSAGE=u},"./node_modules/matrix-events-sdk/lib/interpreters/modern/MMessage.js":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseMMessage=function(e){if(n.M_EMOTE.matches(e.type))return new r.EmoteEvent(e);if(n.M_NOTICE.matches(e.type))return new o.NoticeEvent(e);return new i.MessageEvent(e)};var i=s("./node_modules/matrix-events-sdk/lib/events/MessageEvent.js"),n=s("./node_modules/matrix-events-sdk/lib/events/message_types.js"),r=s("./node_modules/matrix-events-sdk/lib/events/EmoteEvent.js"),o=s("./node_modules/matrix-events-sdk/lib/events/NoticeEvent.js")},"./node_modules/matrix-events-sdk/lib/interpreters/modern/MPoll.js":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseMPoll=function(e){if(i.M_POLL_START.matches(e.type))return new n.PollStartEvent(e);if(i.M_POLL_RESPONSE.matches(e.type))return new r.PollResponseEvent(e);if(i.M_POLL_END.matches(e.type))return new o.PollEndEvent(e);return null};var i=s("./node_modules/matrix-events-sdk/lib/events/poll_types.js"),n=s("./node_modules/matrix-events-sdk/lib/events/PollStartEvent.js"),r=s("./node_modules/matrix-events-sdk/lib/events/PollResponseEvent.js"),o=s("./node_modules/matrix-events-sdk/lib/events/PollEndEvent.js")},"./node_modules/matrix-events-sdk/lib/types.js":(e,t)=>{"use strict";function s(e){return null!=e}Object.defineProperty(t,"__esModule",{value:!0}),t.isOptionalAString=function(e){return s(e)&&"string"==typeof e},t.isProvided=s},"./node_modules/matrix-events-sdk/lib/utility/MessageMatchers.js":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LegacyMsgType=void 0,t.isEventLike=function(e,t){var s=e.content;if(t===i.Text)return n.M_MESSAGE.matches(e.type)||"m.room.message"===e.type&&"m.text"===(null==s?void 0:s.msgtype);if(t===i.Emote)return n.M_EMOTE.matches(e.type)||"m.room.message"===e.type&&"m.emote"===(null==s?void 0:s.msgtype);if(t===i.Notice)return n.M_NOTICE.matches(e.type)||"m.room.message"===e.type&&"m.notice"===(null==s?void 0:s.msgtype);return!1};var i,n=s("./node_modules/matrix-events-sdk/lib/events/message_types.js");t.LegacyMsgType=i,function(e){e.Text="m.text",e.Notice="m.notice",e.Emote="m.emote"}(i||(t.LegacyMsgType=i={}))},"./node_modules/matrix-events-sdk/lib/utility/events.js":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isEventTypeSame=function(e,t){if("string"==typeof e)return"string"==typeof t?t===e:t.matches(e);if("string"==typeof t)return e.matches(t);var s=t,i=e;return s.matches(i.name)||s.matches(i.altName)}},"./node_modules/p-retry/index.js":(e,t,s)=>{"use strict";const i=s("./node_modules/retry/index.js"),n=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class r extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const o=(e,t)=>new Promise(((s,o)=>{t={onFailedAttempt:()=>{},retries:10,...t};const a=i.operation(t);a.attempt((async i=>{try{s(await e(i))}catch(e){if(!(e instanceof Error))return void o(new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`));if(e instanceof r)a.stop(),o(e.originalError);else if(e instanceof TypeError&&(d=e.message,!n.includes(d)))a.stop(),o(e);else{((e,t,s)=>{const i=s.retries-(t-1);e.attemptNumber=t,e.retriesLeft=i})(e,i,t);try{await t.onFailedAttempt(e)}catch(e){return void o(e)}a.retry(e)||o(a.mainError())}}var d}))}));e.exports=o,e.exports.default=o,e.exports.AbortError=r},"./node_modules/retry/index.js":(e,t,s)=>{e.exports=s("./node_modules/retry/lib/retry.js")},"./node_modules/retry/lib/retry.js":(e,t,s)=>{var i=s("./node_modules/retry/lib/retry_operation.js");t.operation=function(e){var s=t.timeouts(e);return new i(s,{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var s in e)t[s]=e[s];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],n=0;n<t.retries;n++)i.push(this.createTimeout(n,t));return e&&e.forever&&!i.length&&i.push(this.createTimeout(n,t)),i.sort((function(e,t){return e-t})),i},t.createTimeout=function(e,t){var s=t.randomize?Math.random()+1:1,i=Math.round(s*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return i=Math.min(i,t.maxTimeout)},t.wrap=function(e,s,i){if(s instanceof Array&&(i=s,s=null),!i)for(var n in i=[],e)"function"==typeof e[n]&&i.push(n);for(var r=0;r<i.length;r++){var o=i[r],a=e[o];e[o]=function(i){var n=t.operation(s),r=Array.prototype.slice.call(arguments,1),o=r.pop();r.push((function(e){n.retry(e)||(e&&(arguments[0]=n.mainError()),o.apply(this,arguments))})),n.attempt((function(){i.apply(e,r)}))}.bind(e,a),e[o].options=s}}},"./node_modules/retry/lib/retry_operation.js":e=>{function t(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}e.exports=t,t.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},t.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},t.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var s=this._timeouts.shift();if(void 0===s){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),s=this._cachedTimeouts.slice(-1)}var i=this;return this._timer=setTimeout((function(){i._attempts++,i._operationTimeoutCb&&(i._timeout=setTimeout((function(){i._operationTimeoutCb(i._attempts)}),i._operationTimeout),i._options.unref&&i._timeout.unref()),i._fn(i._attempts)}),s),this._options.unref&&this._timer.unref(),!0},t.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var s=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){s._operationTimeoutCb()}),s._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},t.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},t.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},t.prototype.start=t.prototype.try,t.prototype.errors=function(){return this._errors},t.prototype.attempts=function(){return this._attempts},t.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,s=0,i=0;i<this._errors.length;i++){var n=this._errors[i],r=n.message,o=(e[r]||0)+1;e[r]=o,o>=s&&(t=n,s=o)}return t}},"./node_modules/sdp-transform/lib/grammar.js":e=>{var t=e.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(t).forEach((function(e){t[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))}))},"./node_modules/sdp-transform/lib/index.js":(e,t,s)=>{var i=s("./node_modules/sdp-transform/lib/parser.js"),n=s("./node_modules/sdp-transform/lib/writer.js");t.M9=n,t.qg=i.parse,i.parseParams,i.parseFmtpConfig,i.parsePayloads,i.parseRemoteCandidates,i.parseImageAttributes,i.parseSimulcastStreamList},"./node_modules/sdp-transform/lib/parser.js":(e,t,s)=>{var i=function(e){return String(Number(e))===e?Number(e):e},n=function(e,t,s){var n=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:n&&!t[e.name]&&(t[e.name]={});var r=e.push?{}:n?t[e.name]:t;!function(e,t,s,n){if(n&&!s)t[n]=i(e[1]);else for(var r=0;r<s.length;r+=1)null!=e[r+1]&&(t[s[r]]=i(e[r+1]))}(s.match(e.reg),r,e.names,e.name),e.push&&t[e.push].push(r)},r=s("./node_modules/sdp-transform/lib/grammar.js"),o=RegExp.prototype.test.bind(/^([a-z])=(.*)/);t.parse=function(e){var t={},s=[],i=t;return e.split(/(\r\n|\r|\n)/).filter(o).forEach((function(e){var t=e[0],o=e.slice(2);"m"===t&&(s.push({rtp:[],fmtp:[]}),i=s[s.length-1]);for(var a=0;a<(r[t]||[]).length;a+=1){var d=r[t][a];if(d.reg.test(o))return n(d,i,o)}})),t.media=s,t};var a=function(e,t){var s=t.split(/=(.+)/,2);return 2===s.length?e[s[0]]=i(s[1]):1===s.length&&t.length>1&&(e[s[0]]=void 0),e};t.parseParams=function(e){return e.split(/;\s?/).reduce(a,{})},t.parseFmtpConfig=t.parseParams,t.parsePayloads=function(e){return e.toString().split(" ").map(Number)},t.parseRemoteCandidates=function(e){for(var t=[],s=e.split(" ").map(i),n=0;n<s.length;n+=3)t.push({component:s[n],ip:s[n+1],port:s[n+2]});return t},t.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(a,{})}))},t.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var t,s=!1;return"~"!==e[0]?t=i(e):(t=i(e.substring(1,e.length)),s=!0),{scid:t,paused:s}}))}))}},"./node_modules/sdp-transform/lib/writer.js":(e,t,s)=>{var i=s("./node_modules/sdp-transform/lib/grammar.js"),n=/%[sdv%]/g,r=function(e){var t=1,s=arguments,i=s.length;return e.replace(n,(function(e){if(t>=i)return e;var n=s[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(n);case"%d":return Number(n);case"%v":return""}}))},o=function(e,t,s){var i=[e+"="+(t.format instanceof Function?t.format(t.push?s:s[t.name]):t.format)];if(t.names)for(var n=0;n<t.names.length;n+=1){var o=t.names[n];t.name?i.push(s[t.name][o]):i.push(s[t.names[n]])}else i.push(s[t.name]);return r.apply(null,i)},a=["v","o","s","i","u","e","p","c","b","t","r","z","a"],d=["i","c","b","a"];e.exports=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var s=t.outerOrder||a,n=t.innerOrder||d,r=[];return s.forEach((function(t){i[t].forEach((function(s){s.name in e&&null!=e[s.name]?r.push(o(t,s,e)):s.push in e&&null!=e[s.push]&&e[s.push].forEach((function(e){r.push(o(t,s,e))}))}))})),e.media.forEach((function(e){r.push(o("m",i.m[0],e)),n.forEach((function(t){i[t].forEach((function(s){s.name in e&&null!=e[s.name]?r.push(o(t,s,e)):s.push in e&&null!=e[s.push]&&e[s.push].forEach((function(e){r.push(o(t,s,e))}))}))}))})),r.join("\r\n")+"\r\n"}},"./node_modules/unhomoglyph/index.js":(e,t,s)=>{"use strict";var i=s("./node_modules/unhomoglyph/data.json");var n=RegExp(Object.keys(i).map((function(e){return e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")})).join("|"),"g");function r(e){return i[e]}e.exports=function(e){return e.replace(n,r)}},"./node_modules/uuid/dist/esm-browser/v4.js":(e,t,s)=>{"use strict";s.d(t,{A:()=>l});const i={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};var n,r=new Uint8Array(16);function o(){if(!n&&!(n="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return n(r)}for(var a=[],d=0;d<256;++d)a.push((d+256).toString(16).slice(1));function c(e,t=0){return(a[e[t+0]]+a[e[t+1]]+a[e[t+2]]+a[e[t+3]]+"-"+a[e[t+4]]+a[e[t+5]]+"-"+a[e[t+6]]+a[e[t+7]]+"-"+a[e[t+8]]+a[e[t+9]]+"-"+a[e[t+10]]+a[e[t+11]]+a[e[t+12]]+a[e[t+13]]+a[e[t+14]]+a[e[t+15]]).toLowerCase()}const l=function(e,t,s){if(i.randomUUID&&!t&&!e)return i.randomUUID();var n=(e=e||{}).random||(e.rng||o)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){s=s||0;for(var r=0;r<16;++r)t[s+r]=n[r];return t}return c(n)}},"./node_modules/@babel/runtime/helpers/esm/defineProperty.js":(e,t,s)=>{"use strict";s.d(t,{A:()=>n});var i=s("./node_modules/@babel/runtime/helpers/esm/toPropertyKey.js");function n(e,t,s){return(t=(0,i.A)(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}},"./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js":(e,t,s)=>{"use strict";function i(e,t){if(null==e)return{};var s,i,n=function(e,t){if(null==e)return{};var s={};for(var i in e)if({}.hasOwnProperty.call(e,i)){if(t.includes(i))continue;s[i]=e[i]}return s}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)s=r[i],t.includes(s)||{}.propertyIsEnumerable.call(e,s)&&(n[s]=e[s])}return n}s.d(t,{A:()=>i})},"./node_modules/@babel/runtime/helpers/esm/toPrimitive.js":(e,t,s)=>{"use strict";s.d(t,{A:()=>n});var i=s("./node_modules/@babel/runtime/helpers/esm/typeof.js");function n(e,t){if("object"!=(0,i.A)(e)||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var n=s.call(e,t||"default");if("object"!=(0,i.A)(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}},"./node_modules/@babel/runtime/helpers/esm/toPropertyKey.js":(e,t,s)=>{"use strict";s.d(t,{A:()=>r});var i=s("./node_modules/@babel/runtime/helpers/esm/typeof.js"),n=s("./node_modules/@babel/runtime/helpers/esm/toPrimitive.js");function r(e){var t=(0,n.A)(e,"string");return"symbol"==(0,i.A)(t)?t:t+""}},"./node_modules/@babel/runtime/helpers/esm/typeof.js":(e,t,s)=>{"use strict";function i(e){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i(e)}s.d(t,{A:()=>i})}},n={};function r(e){var t=n[e];if(void 0!==t)return t.exports;var s=n[e]={id:e,loaded:!1,exports:{}};return i[e].call(s.exports,s,s.exports,r),s.loaded=!0,s.exports}r.m=i,e=[],r.O=(t,s,i,n)=>{if(!s){var o=1/0;for(l=0;l<e.length;l++){for(var[s,i,n]=e[l],a=!0,d=0;d<s.length;d++)(!1&n||o>=n)&&Object.keys(r.O).every((e=>r.O[e](s[d])))?s.splice(d--,1):(a=!1,n<o&&(o=n));if(a){e.splice(l--,1);var c=i();void 0!==c&&(t=c)}}return t}n=n||0;for(var l=e.length;l>0&&e[l-1][2]>n;l--)e[l]=e[l-1];e[l]=[s,i,n]},r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var s in t)r.o(t,s)&&!r.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},r.f={},r.e=e=>Promise.all(Object.keys(r.f).reduce(((t,s)=>(r.f[s](e,t),t)),[])),r.u=e=>"bundles/"+r.h()+"/"+e+".js",r.miniCssF=e=>{},r.h=()=>"daf3c59dbe86426f3fd3",r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),t={},s="element-web:",r.l=(e,i,n,o)=>{if(t[e])t[e].push(i);else{var a,d;if(void 0!==n)for(var c=document.getElementsByTagName("script"),l=0;l<c.length;l++){var u=c[l];if(u.getAttribute("src")==e||u.getAttribute("data-webpack")==s+n){a=u;break}}a||(d=!0,(a=document.createElement("script")).charset="utf-8",a.timeout=120,r.nc&&a.setAttribute("nonce",r.nc),a.setAttribute("data-webpack",s+n),a.src=e),t[e]=[i];var h=(s,i)=>{a.onerror=a.onload=null,clearTimeout(m);var n=t[e];if(delete t[e],a.parentNode&&a.parentNode.removeChild(a),n&&n.forEach((e=>e(i))),s)return s(i)},m=setTimeout(h.bind(null,void 0,{type:"timeout",target:a}),12e4);a.onerror=h.bind(null,a.onerror),a.onload=h.bind(null,a.onload),d&&document.head.appendChild(a)}},r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),r.j=2798,(()=>{var e;r.g.importScripts&&(e=r.g.location+"");var t=r.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var s=t.getElementsByTagName("script");if(s.length)for(var i=s.length-1;i>-1&&(!e||!/^http(s?):/.test(e));)e=s[i--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),r.p=e})(),(()=>{var e={2798:0};r.f.j=(t,s)=>{var i=r.o(e,t)?e[t]:void 0;if(0!==i)if(i)s.push(i[2]);else{var n=new Promise(((s,n)=>i=e[t]=[s,n]));s.push(i[2]=n);var o=r.p+r.u(t),a=new Error;r.l(o,(s=>{if(r.o(e,t)&&(0!==(i=e[t])&&(e[t]=void 0),i)){var n=s&&("load"===s.type?"missing":s.type),o=s&&s.target&&s.target.src;a.message="Loading chunk "+t+" failed.\n("+n+": "+o+")",a.name="ChunkLoadError",a.type=n,a.request=o,i[1](a)}}),"chunk-"+t,t)}},r.O.j=t=>0===e[t];var t=(t,s)=>{var i,n,[o,a,d]=s,c=0;if(o.some((t=>0!==e[t]))){for(i in a)r.o(a,i)&&(r.m[i]=a[i]);if(d)var l=d(r)}for(t&&t(s);c<o.length;c++)n=o[c],r.o(e,n)&&e[n]&&e[n][0](),e[n]=0;return r.O(l)},s=self.webpackChunkelement_web=self.webpackChunkelement_web||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})();var o=r.O(void 0,[1040],(()=>r("./src/serviceworker/index.ts")));o=r.O(o)})();
//# sourceMappingURL=sw.js.map