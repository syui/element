/*! For license information please see 6656.js.LICENSE.txt */
"use strict";(self.webpackChunkelement_web=self.webpackChunkelement_web||[]).push([[6656],{"./node_modules/matrix-js-sdk/src/interactive-auth.ts":(e,t,r)=>{r.d(t,{Lh:()=>u,hT:()=>d,k_:()=>l});var i=r("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=r("./node_modules/matrix-js-sdk/src/logger.ts"),o=r("./node_modules/matrix-js-sdk/src/utils.ts"),s=r("./node_modules/matrix-js-sdk/src/http-api/index.ts");const a="m.login.email.identity",c="m.login.msisdn";let d=function(e){return e.Password="m.login.password",e.Recaptcha="m.login.recaptcha",e.Terms="m.login.terms",e.Email="m.login.email.identity",e.Msisdn="m.login.msisdn",e.Sso="m.login.sso",e.SsoUnstable="org.matrix.login.sso",e.Dummy="m.login.dummy",e.RegistrationToken="m.login.registration_token",e.UnstableRegistrationToken="org.matrix.msc3231.login.registration_token",e}({});class l extends Error{constructor(e,t,r){super(e),(0,i.A)(this,"name","NoAuthFlowFoundError"),this.required_stages=t,this.flows=r}}class u{constructor(e){(0,i.A)(this,"matrixClient",void 0),(0,i.A)(this,"inputs",void 0),(0,i.A)(this,"clientSecret",void 0),(0,i.A)(this,"requestCallback",void 0),(0,i.A)(this,"busyChangedCallback",void 0),(0,i.A)(this,"stateUpdatedCallback",void 0),(0,i.A)(this,"requestEmailTokenCallback",void 0),(0,i.A)(this,"supportedStages",void 0),(0,i.A)(this,"data",void 0),(0,i.A)(this,"emailSid",void 0),(0,i.A)(this,"requestingEmailToken",!1),(0,i.A)(this,"attemptAuthDeferred",null),(0,i.A)(this,"chosenFlow",null),(0,i.A)(this,"currentStage",null),(0,i.A)(this,"emailAttempt",1),(0,i.A)(this,"submitPromise",null),(0,i.A)(this,"requestEmailToken",(async()=>{if(this.requestingEmailToken)n.v.warn("Could not request email token: Already requesting");else{n.v.trace("Requesting email token. Attempt: "+this.emailAttempt),this.requestingEmailToken=!0;try{const e=await this.requestEmailTokenCallback(this.inputs.emailAddress,this.clientSecret,this.emailAttempt++,this.data.session);this.emailSid=e.sid,n.v.trace("Email token request succeeded")}finally{this.requestingEmailToken=!1}}})),this.matrixClient=e.matrixClient,this.data=e.authData||{flows:[]},this.requestCallback=e.doRequest,this.busyChangedCallback=e.busyChanged,this.stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this.requestEmailTokenCallback=e.requestEmailToken,this.inputs=e.inputs||{},e.sessionId&&(this.data.session=e.sessionId),this.clientSecret=e.clientSecret||this.matrixClient.generateClientSecret(),this.emailSid=e.emailSid,void 0!==e.supportedStages&&(this.supportedStages=new Set(e.supportedStages))}async attemptAuth(){var e;this.attemptAuthDeferred=(0,o.v6)();const t=this.attemptAuthDeferred.promise;if(null!==(e=this.data)&&void 0!==e&&null!==(e=e.flows)&&void 0!==e&&e.length)this.startNextAuthStage();else{var r;null===(r=this.busyChangedCallback)||void 0===r||r.call(this,!0);const e=this.data.session?{session:this.data.session}:null;this.doRequest(e).finally((()=>{var e;null===(e=this.busyChangedCallback)||void 0===e||e.call(this,!1)}))}return t}async poll(){if(!this.data.session)return;if(!this.attemptAuthDeferred)return;if(this.submitPromise)return;let e={};if(this.currentStage==a&&this.emailSid){const t={sid:this.emailSid,client_secret:this.clientSecret},r=this.matrixClient.getIdentityServerUrl();r&&(t.id_server=new URL(r).host),e={type:a,threepid_creds:t}}this.submitAuthDict(e,!0)}getSessionId(){var e;return null===(e=this.data)||void 0===e?void 0:e.session}getClientSecret(){return this.clientSecret}getStageParams(e){var t;return null===(t=this.data)||void 0===t||null===(t=t.params)||void 0===t?void 0:t[e]}getChosenFlow(){return this.chosenFlow}async submitAuthDict(e,t=!1){var r,i;if(!this.attemptAuthDeferred)throw new Error("submitAuthDict() called before attemptAuth()");t||(null===(i=this.busyChangedCallback)||void 0===i||i.call(this,!0));for(;this.submitPromise;)try{await this.submitPromise}catch(e){}let n;null!==(r=this.data)&&void 0!==r&&r.session?(n={session:this.data.session},Object.assign(n,e)):n=e;try{this.submitPromise=this.doRequest(n,t),await this.submitPromise}finally{var o;if(this.submitPromise=null,!t)null===(o=this.busyChangedCallback)||void 0===o||o.call(this,!1)}}getEmailSid(){return this.emailSid}setEmailSid(e){this.emailSid=e}async doRequest(e,t=!1){try{const r=await this.requestCallback(e,t);this.attemptAuthDeferred.resolve(r),this.attemptAuthDeferred=null}catch(e){var r,i,o,a;const l=e instanceof s.up?e:null,u=null!==(r=null==l||null===(i=l.data)||void 0===i?void 0:i.flows)&&void 0!==r?r:null,p=(null===(o=this.data)||void 0===o?void 0:o.flows)||Boolean(u);var c;if(!l||401!==l.httpStatus||!l.data||!p)if(t)n.v.log("Background poll request failed doing UI auth: ignoring",e);else null===(c=this.attemptAuthDeferred)||void 0===c||c.reject(e);l&&!l.data&&(l.data={}),!l||l.data.flows||l.data.completed||l.data.session||(l.data.flows=this.data.flows,l.data.completed=this.data.completed,l.data.session=this.data.session),l&&(this.data=l.data);try{this.startNextAuthStage()}catch(e){return this.attemptAuthDeferred.reject(e),void(this.attemptAuthDeferred=null)}if(!this.emailSid&&null!==(a=this.chosenFlow)&&void 0!==a&&a.stages.includes(d.Email))try{await this.requestEmailToken()}catch(e){this.attemptAuthDeferred.reject(e),this.attemptAuthDeferred=null}}}startNextAuthStage(){var e,t;const r=this.chooseStage();if(!r)throw new Error("No incomplete flows from the server");var i,n;(this.currentStage=r,r!==d.Dummy)?null!==(e=this.data)&&void 0!==e&&e.errcode||null!==(t=this.data)&&void 0!==t&&t.error?this.stateUpdatedCallback(r,{errcode:(null===(i=this.data)||void 0===i?void 0:i.errcode)||"",error:(null===(n=this.data)||void 0===n?void 0:n.error)||""}):this.stateUpdatedCallback(r,r===a?{emailSid:this.emailSid}:{}):this.submitAuthDict({type:"m.login.dummy"})}chooseStage(){null===this.chosenFlow&&(this.chosenFlow=this.chooseFlow()),n.v.log("Active flow => %s",JSON.stringify(this.chosenFlow));const e=this.firstUncompletedStage(this.chosenFlow);return n.v.log("Next stage: %s",e),e}scoreFlow(e){let t=e.stages.length;return void 0!==this.supportedStages&&(t+=10*e.stages.filter((e=>!this.supportedStages.has(e))).length),t}chooseFlow(){var e;const t=(null===(e=this.data)||void 0===e?void 0:e.flows)||[],r=Boolean(this.inputs.emailAddress)||Boolean(this.emailSid),i=Boolean(this.inputs.phoneCountry)&&Boolean(this.inputs.phoneNumber);t.sort(((e,t)=>this.scoreFlow(e)-this.scoreFlow(t)));for(const e of t){let t=!1,n=!1;for(const r of e.stages)r===a?t=!0:r==c&&(n=!0);if(t==r&&n==i)return e}const n=[];throw r&&n.push(a),i&&n.push(c),new l("No appropriate authentication flow found",n,t)}firstUncompletedStage(e){var t;const r=(null===(t=this.data)||void 0===t?void 0:t.completed)||[];return e.stages.find((e=>!r.includes(e)))}}},"./node_modules/matrix-js-sdk/src/matrix.ts":(e,t,r)=>{r.r(t),r.d(t,{AuthType:()=>F.hT,AutoDiscovery:()=>w.MN,AutoDiscoveryAction:()=>w.iz,AutoDiscoveryError:()=>w.gc,Beacon:()=>x.HF,BeaconEvent:()=>x.JH,CRYPTO_ENABLED:()=>s.Kn,CallEvent:()=>fe.$E,CallFeedEvent:()=>_e.BL,Category:()=>S.b,ClientEvent:()=>s.AU,ClientPrefix:()=>b.iD,ClientStoppedError:()=>k.LA,ConditionKind:()=>Y.wp,ConditionOperator:()=>Y.CD,ConnectionError:()=>b.Rc,ContentHelpers:()=>pe,Crypto:()=>Ee,CryptoEvent:()=>ge.cr,DELEGATED_OIDC_COMPATIBILITY:()=>ne,DEVICE_CODE_SCOPE:()=>W.AO,DMMemberCountCondition:()=>Y.IJ,Device:()=>M.p,DeviceVerification:()=>M.u,Direction:()=>A.O,DuplicateStrategy:()=>O.x,EVENT_VISIBILITY_CHANGE_TYPE:()=>l.Yg,EventEmitterEvents:()=>I.u,EventStatus:()=>d.fb,EventTimeline:()=>A.q,EventTimelineSet:()=>O.m,EventType:()=>l.Bx,FILTER_RELATED_BY_REL_TYPES:()=>P.H,FILTER_RELATED_BY_SENDERS:()=>P.o1,FeatureSupport:()=>P.c1,Filter:()=>U.d,GET_LOGIN_TOKEN_CAPABILITY:()=>s.hx,GroupCall:()=>me.eO,GroupCallEvent:()=>me.AZ,GroupCallIntent:()=>me.MC,GroupCallState:()=>me.F_,GroupCallStatsReportEvent:()=>me.xt,GroupCallType:()=>me.Ad,GuestAccess:()=>Q.rF,HTTPError:()=>b.Hl,HistoryVisibility:()=>Q.Jv,HttpApiEvent:()=>b.XD,IdentityPrefix:()=>b.Pw,IdentityProviderBrand:()=>oe,IndexedDBCryptoStore:()=>J.y,IndexedDBStore:()=>G,InteractiveAuth:()=>F.Lh,InvalidCryptoStoreError:()=>k.E5,InvalidCryptoStoreState:()=>k.hP,JoinRule:()=>Q.dx,KNOWN_SAFE_ROOM_VERSION:()=>j.vx,KeySignatureUploadError:()=>k.b0,KnownMembership:()=>le.O,LOCAL_NOTIFICATION_SETTINGS_PREFIX:()=>l.Xs,LocalStorageCryptoStore:()=>H.F,LocalStorageErrors:()=>Se,LocationAssetType:()=>re.Yg,MAIN_ROOM_TIMELINE:()=>ce.S,MSC3912_RELATION_BASED_REDACTIONS_PROP:()=>l.Z3,M_ASSET:()=>re.J1,M_BEACON:()=>ee.z,M_BEACON_INFO:()=>ee.E,M_HTML:()=>de.Et,M_LOCATION:()=>re.M6,M_MESSAGE:()=>de.K0,M_POLL_END:()=>ae.cI,M_POLL_KIND_DISCLOSED:()=>ae.ms,M_POLL_KIND_UNDISCLOSED:()=>ae.li,M_POLL_RESPONSE:()=>ae.qN,M_POLL_START:()=>ae.$S,M_TEXT:()=>de.yB,M_TIMESTAMP:()=>re.vo,M_TOPIC:()=>te.s,MatrixClient:()=>s.pB,MatrixError:()=>b.up,MatrixEvent:()=>d.kl,MatrixEventEvent:()=>d.OQ,MatrixHttpApi:()=>b.ED,MatrixScheduler:()=>o.b,MediaHandlerEvent:()=>ye.d,MediaPrefix:()=>b.zs,MemoryCryptoStore:()=>i._,MemoryStore:()=>n.n,Method:()=>b.IT,MsgType:()=>l.Wr,NoAuthFlowFoundError:()=>F.k_,NotificationCountType:()=>j.X5,OidcError:()=>W.uv,OidcTokenRefresher:()=>W.db,PUSHER_DEVICE_ID:()=>l.VT,PUSHER_ENABLED:()=>l.cr,PendingEventOrdering:()=>s.eO,Poll:()=>C.sP,PollEvent:()=>C.sn,Preset:()=>Q.k,PushRuleActionName:()=>Y.YU,PushRuleKind:()=>Y.Ji,REFERENCE_RELATION:()=>de.BJ,ReceiptType:()=>ce.L,RelationType:()=>l.zZ,Relations:()=>we.s,RelationsEvent:()=>we.S,RestrictedAllowType:()=>Q.D7,Room:()=>j.Wv,RoomCreateTypeField:()=>l.Ct,RoomEvent:()=>j.u9,RoomMember:()=>T.Y,RoomMemberEvent:()=>T.o,RoomNameType:()=>j.bx,RoomState:()=>R.H,RoomStateEvent:()=>R.f,RoomSummary:()=>ue.c,RoomType:()=>l.CJ,RoomVersionStability:()=>_.L,RoomWidgetClient:()=>y,RuleId:()=>Y.kq,SERVICE_TYPES:()=>B.S,SSOAction:()=>se,SearchOrderBy:()=>Z.g,SearchResult:()=>D.q,SecretStorage:()=>he,ServerCapabilities:()=>_.K,SetPresence:()=>p.IU,SlidingSyncEvent:()=>ve.cQ,StatsReport:()=>be.I,SyncAccumulator:()=>S.w,SyncState:()=>p.Lm,THREAD_RELATION_TYPE:()=>P.RN,Thread:()=>P.jV,ThreadEvent:()=>P.ju,ThreadFilterType:()=>P.x3,ThreepidMedium:()=>ie,TimelineIndex:()=>L,TimelineWindow:()=>N,ToDeviceMessageId:()=>l.wt,TweakName:()=>Y.QN,TypedEventEmitter:()=>I.X,UNSIGNED_MEMBERSHIP_FIELD:()=>l.SY,UNSIGNED_THREAD_ID_FIELD:()=>l.Sr,UNSTABLE_ELEMENT_FUNCTIONAL_USERS:()=>l.Ng,UNSTABLE_MSC2666_MUTUAL_ROOMS:()=>s.NB,UNSTABLE_MSC2666_QUERY_MUTUAL_ROOMS:()=>s.A0,UNSTABLE_MSC2666_SHARED_ROOMS:()=>s.uD,UNSTABLE_MSC2716_MARKER:()=>l.ge,UNSTABLE_MSC3088_ENABLED:()=>l.ud,UNSTABLE_MSC3088_PURPOSE:()=>l.D7,UNSTABLE_MSC3089_BRANCH:()=>l.iK,UNSTABLE_MSC3089_LEAF:()=>l.ID,UNSTABLE_MSC3089_TREE_SUBTYPE:()=>l.nN,UNSTABLE_MSC3852_LAST_SEEN_UA:()=>s.HF,UNSTABLE_MSC4133_EXTENDED_PROFILES:()=>s.jB,UNSTABLE_MSC4140_DELAYED_EVENTS:()=>s.rG,UpdateDelayedEventAction:()=>X.e,User:()=>f.K,UserEvent:()=>f.U,Visibility:()=>Q.bv,anySignal:()=>b.JG,calculateRetryBackoff:()=>b.fZ,completeAuthorizationCodeGrant:()=>W.SU,createClient:()=>Oe,createNewMatrixCall:()=>fe.sv,createRoomWidgetClient:()=>Ce,decodeBase64:()=>E.y4,decodeIdToken:()=>W.Rh,determineFeatureSupport:()=>P.FD,discoverAndValidateOIDCIssuerWellKnown:()=>W.k8,encodeBase64:()=>E.WG,encodeUnpaddedBase64:()=>E.PP,encodeUnpaddedBase64Url:()=>E.A4,fixNotificationCountOnDecryption:()=>s.mD,generateAuthorizationParams:()=>W.P3,generateAuthorizationUrl:()=>W.cJ,generateOidcAuthorizationUrl:()=>W.R2,generateScope:()=>W.oE,getBeaconInfoIdentifier:()=>x.M9,getHttpUriForMxc:()=>z.y,inMainTimelineForReceipt:()=>s.fN,isDmMemberCountCondition:()=>Y.WM,isEventTypeSame:()=>de.NY,isPollEvent:()=>C.Wi,isTimestampInDuration:()=>x.ai,isValidatedIssuerMetadata:()=>W.BH,parseErrorResponse:()=>b.xy,registerOidcClient:()=>W.aT,retryNetworkOperation:()=>b.Y6,setCryptoStoreFactory:()=>je,threadFilterTypeToFilter:()=>P.UR,threadIdForReceipt:()=>s.Xb,timeoutSignal:()=>b._,validateBearerTokenResponse:()=>W.eC,validateIdToken:()=>W.rm,validateOIDCIssuerWellKnown:()=>W.sn,validateStoredUserState:()=>W.K8});var i=r("./node_modules/matrix-js-sdk/src/crypto/store/memory-crypto-store.ts"),n=r("./node_modules/matrix-js-sdk/src/store/memory.ts"),o=r("./node_modules/matrix-js-sdk/src/scheduler.ts"),s=r("./node_modules/matrix-js-sdk/src/client.ts"),a=r("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),c=r("./node_modules/matrix-widget-api/lib/index.js"),d=r("./node_modules/matrix-js-sdk/src/models/event.ts"),l=r("./node_modules/matrix-js-sdk/src/@types/event.ts"),u=r("./node_modules/matrix-js-sdk/src/logger.ts"),p=r("./node_modules/matrix-js-sdk/src/sync.ts"),h=r("./node_modules/matrix-js-sdk/src/sliding-sync-sdk.ts"),f=r("./node_modules/matrix-js-sdk/src/models/user.ts"),m=r("./node_modules/matrix-js-sdk/src/utils.ts");function g(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function v(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?g(Object(r),!0).forEach((function(t){(0,a.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):g(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}class y extends s.pB{constructor(e,t,r,i,n){var o,h,f,m,g,v,y,_,b,w,S,k;super(i),(0,a.A)(this,"room",void 0),(0,a.A)(this,"widgetApiReady",void 0),(0,a.A)(this,"lifecycle",void 0),(0,a.A)(this,"syncState",null),(0,a.A)(this,"onEvent",(async e=>{if(e.preventDefault(),e.detail.data.room_id===this.roomId){const t=new d.kl(e.detail.data);await this.syncApi.injectRoomEvents(this.room,[],[t]),this.emit(s.AU.Event,t),this.setSyncState(p.Lm.Syncing),u.v.info(`Received event ${t.getId()} ${t.getType()} ${t.getStateKey()}`)}else{const{event_id:t,room_id:r}=e.detail.data;u.v.info(`Received event ${t} for a different room ${r}; discarding`)}await this.ack(e)})),(0,a.A)(this,"onToDevice",(async e=>{e.preventDefault();const t=new d.kl({type:e.detail.data.type,sender:e.detail.data.sender,content:e.detail.data.content});e.detail.data.encrypted&&t.makeEncrypted(l.Bx.RoomMessageEncrypted,{},"",""),this.emit(s.AU.ToDeviceEvent,t),this.setSyncState(p.Lm.Syncing),await this.ack(e)})),this.widgetApi=e,this.capabilities=t,this.roomId=r,this.widgetApiReady=new Promise((e=>this.widgetApi.once("ready",e))),(null!==(o=t.sendEvent)&&void 0!==o&&o.length||null!==(h=t.receiveEvent)&&void 0!==h&&h.length||!0===t.sendMessage||Array.isArray(t.sendMessage)&&t.sendMessage.length||!0===t.receiveMessage||Array.isArray(t.receiveMessage)&&t.receiveMessage.length||null!==(f=t.sendState)&&void 0!==f&&f.length||null!==(m=t.receiveState)&&void 0!==m&&m.length)&&e.requestCapabilityForRoomTimeline(r),null===(g=t.sendEvent)||void 0===g||g.forEach((t=>e.requestCapabilityToSendEvent(t))),null===(v=t.receiveEvent)||void 0===v||v.forEach((t=>e.requestCapabilityToReceiveEvent(t))),!0===t.sendMessage?e.requestCapabilityToSendMessage():Array.isArray(t.sendMessage)&&t.sendMessage.forEach((t=>e.requestCapabilityToSendMessage(t))),!0===t.receiveMessage?e.requestCapabilityToReceiveMessage():Array.isArray(t.receiveMessage)&&t.receiveMessage.forEach((t=>e.requestCapabilityToReceiveMessage(t))),null===(y=t.sendState)||void 0===y||y.forEach((({eventType:t,stateKey:r})=>e.requestCapabilityToSendState(t,r))),null===(_=t.receiveState)||void 0===_||_.forEach((({eventType:t,stateKey:r})=>e.requestCapabilityToReceiveState(t,r))),null===(b=t.sendToDevice)||void 0===b||b.forEach((t=>e.requestCapabilityToSendToDevice(t))),null===(w=t.receiveToDevice)||void 0===w||w.forEach((t=>e.requestCapabilityToReceiveToDevice(t))),t.sendDelayedEvents&&(null!==(S=t.sendEvent)&&void 0!==S&&S.length||!0===t.sendMessage||Array.isArray(t.sendMessage)&&t.sendMessage.length||null!==(k=t.sendState)&&void 0!==k&&k.length)&&e.requestCapability(c.MatrixCapabilities.MSC4157SendDelayedEvent),t.updateDelayedEvents&&e.requestCapability(c.MatrixCapabilities.MSC4157UpdateDelayedEvent),t.turnServers&&e.requestCapability(c.MatrixCapabilities.MSC3846TurnServers),e.on(`action:${c.WidgetApiToWidgetAction.SendEvent}`,this.onEvent),e.on(`action:${c.WidgetApiToWidgetAction.SendToDevice}`,this.onToDevice),e.start(),n&&e.sendContentLoaded()}async startClient(e={}){var t,r;this.lifecycle=new AbortController;const i=this.getUserId();i&&this.store.storeUser(new f.K(i)),e.slidingSync?this.syncApi=new h.m(e.slidingSync,this,e,this.buildSyncApiOptions()):this.syncApi=new p.w_(this,e,this.buildSyncApiOptions()),this.room=this.syncApi.createRoom(this.roomId),this.store.storeRoom(this.room),await this.widgetApiReady,await Promise.all(null!==(t=null===(r=this.capabilities.receiveState)||void 0===r?void 0:r.map((async({eventType:e,stateKey:t})=>{const r=(await this.widgetApi.readStateEvents(e,void 0,t,[this.roomId])).map((e=>new d.kl(e)));await this.syncApi.injectRoomEvents(this.room,[],r),r.forEach((e=>{this.emit(s.AU.Event,e),u.v.info(`Backfilled event ${e.getId()} ${e.getType()} ${e.getStateKey()}`)}))})))&&void 0!==t?t:[]),void 0!==e.clientWellKnownPollPeriod&&(this.clientWellKnownIntervalID=setInterval((()=>{this.fetchClientWellKnown()}),1e3*e.clientWellKnownPollPeriod),this.fetchClientWellKnown()),this.setSyncState(p.Lm.Syncing),u.v.info("Finished backfilling events"),this.matrixRTC.start(),this.capabilities.turnServers&&this.watchTurnServers()}stopClient(){this.widgetApi.off(`action:${c.WidgetApiToWidgetAction.SendEvent}`,this.onEvent),this.widgetApi.off(`action:${c.WidgetApiToWidgetAction.SendToDevice}`,this.onToDevice),super.stopClient(),this.lifecycle.abort()}async joinRoom(e){if(e===this.roomId)return this.room;throw new Error(`Unknown room: ${e}`)}async encryptAndSendEvent(e,t,r){const i=t.event.redacts?v(v({},t.getContent()),{},{redacts:t.event.redacts}):t.getContent();if(r){const n=await this.widgetApi.sendRoomEvent(t.getType(),i,e.roomId,"delay"in r?r.delay:void 0,"parent_delay_id"in r?r.parent_delay_id:void 0);return this.validateSendDelayedEventResponse(n)}let n;try{n=await this.widgetApi.sendRoomEvent(t.getType(),i,e.roomId)}catch(r){throw this.updatePendingEventStatus(e,t,d.fb.NOT_SENT),r}return e.updatePendingEvent(t,d.fb.SENT,n.event_id),{event_id:n.event_id}}async sendStateEvent(e,t,r,i=""){const n=await this.widgetApi.sendStateEvent(t,i,r,e);if(void 0===n.event_id)throw new Error("'event_id' absent from response to an event request");return{event_id:n.event_id}}async _unstable_sendDelayedStateEvent(e,t,r,i,n=""){if(!await this.doesServerSupportUnstableFeature(s.rG))throw Error("Server does not support the delayed events API");const o=await this.widgetApi.sendStateEvent(r,n,i,e,"delay"in t?t.delay:void 0,"parent_delay_id"in t?t.parent_delay_id:void 0);return this.validateSendDelayedEventResponse(o)}validateSendDelayedEventResponse(e){if(void 0===e.delay_id)throw new Error("'delay_id' absent from response to a delayed event request");return{delay_id:e.delay_id}}async _unstable_updateDelayedEvent(e,t){if(!await this.doesServerSupportUnstableFeature(s.rG))throw Error("Server does not support the delayed events API");return await this.widgetApi.updateDelayedEvent(e,t)}async sendToDevice(e,t){return await this.widgetApi.sendToDevice(e,!1,(0,m.HF)(t)),{}}async getOpenIdToken(){const e=await this.widgetApi.requestOpenIDConnectToken();return{access_token:e.access_token,expires_in:e.expires_in,matrix_server_name:e.matrix_server_name,token_type:e.token_type}}async queueToDevice({eventType:e,batch:t}){const r=new m.kG((()=>new Map));for(const{userId:e,deviceId:i,payload:n}of t)r.getOrCreate(e).set(i,n);await this.widgetApi.sendToDevice(e,!1,(0,m.HF)(r))}async encryptAndSendToDevices(e,t){const r=new m.kG((()=>new Map));for(const{userId:i,deviceInfo:{deviceId:n}}of e)r.getOrCreate(i).set(n,t);await this.widgetApi.sendToDevice(t.type,!0,(0,m.HF)(r))}async checkTurnServers(){return this.turnServers.length>0}getSyncState(){return this.syncState}setSyncState(e){const t=this.syncState;this.syncState=e,this.emit(s.AU.Sync,e,t)}async ack(e){await this.widgetApi.transport.reply(e.detail,{})}async watchTurnServers(){const e=this.widgetApi.getTurnServers(),t=()=>{e.return(void 0)};this.lifecycle.signal.addEventListener("abort",t);try{for await(const t of e)this.turnServers=[{urls:t.uris,username:t.username,credential:t.password}],this.emit(s.AU.TurnServers,this.turnServers),u.v.log(`Received TURN server: ${t.uris}`)}catch(e){u.v.warn("Error watching TURN servers",e)}finally{this.lifecycle.signal.removeEventListener("abort",t)}}}var _=r("./node_modules/matrix-js-sdk/src/serverCapabilities.ts"),b=r("./node_modules/matrix-js-sdk/src/http-api/index.ts"),w=r("./node_modules/matrix-js-sdk/src/autodiscovery.ts"),S=r("./node_modules/matrix-js-sdk/src/sync-accumulator.ts"),k=r("./node_modules/matrix-js-sdk/src/errors.ts"),E=r("./node_modules/matrix-js-sdk/src/base64.ts"),x=r("./node_modules/matrix-js-sdk/src/models/beacon.ts"),j=r("./node_modules/matrix-js-sdk/src/models/room.ts"),A=r("./node_modules/matrix-js-sdk/src/models/event-timeline.ts"),O=r("./node_modules/matrix-js-sdk/src/models/event-timeline-set.ts"),C=r("./node_modules/matrix-js-sdk/src/models/poll.ts"),T=r("./node_modules/matrix-js-sdk/src/models/room-member.ts"),R=r("./node_modules/matrix-js-sdk/src/models/room-state.ts"),P=r("./node_modules/matrix-js-sdk/src/models/thread.ts"),I=r("./node_modules/matrix-js-sdk/src/models/typed-event-emitter.ts"),M=r("./node_modules/matrix-js-sdk/src/models/device.ts"),D=r("./node_modules/matrix-js-sdk/src/models/search-result.ts"),W=r("./node_modules/matrix-js-sdk/src/oidc/index.ts"),U=r("./node_modules/matrix-js-sdk/src/filter.ts");const q=function(){};class N{constructor(e,t,r={}){var i;(0,a.A)(this,"windowLimit",void 0),(0,a.A)(this,"start",void 0),(0,a.A)(this,"end",void 0),(0,a.A)(this,"eventCount",0),this.client=e,this.timelineSet=t,this.windowLimit=r.windowLimit||1e3,null===(i=t.room)||void 0===i||i.on(j.u9.Timeline,this.onTimelineEvent.bind(this))}load(e,t=20){const r=r=>{if(!r)throw new Error("No timeline given to initFields");let i;const n=r.getEvents();if(e){if(i=n.findIndex((t=>t.getId()===e)),i<0)throw new Error("getEventTimeline result didn't include requested event")}else i=n.length;const o=Math.min(n.length,i+Math.ceil(t/2)),s=Math.max(0,o-t);this.start=new L(r,s-r.getBaseIndex()),this.end=new L(r,o-r.getBaseIndex()),this.eventCount=o-s};return this.timelineSet.getTimelineForEvent(e)?(r(this.timelineSet.getTimelineForEvent(e)),Promise.resolve()):e?this.client.getEventTimeline(this.timelineSet,e).then(r):(r(this.timelineSet.getLiveTimeline()),Promise.resolve())}getTimelineIndex(e){var t,r;if(e==A.q.BACKWARDS)return null!==(t=this.start)&&void 0!==t?t:null;if(e==A.q.FORWARDS)return null!==(r=this.end)&&void 0!==r?r:null;throw new Error("Invalid direction '"+e+"'")}extend(e,t){const r=this.getTimelineIndex(e);if(!r)return q("TimelineWindow: no timeline yet"),!1;const i=e==A.q.BACKWARDS?r.retreat(t):r.advance(t);if(i){this.eventCount+=i,q("TimelineWindow: increased cap by "+i+" (now "+this.eventCount+")");const t=this.eventCount-this.windowLimit;return t>0&&this.unpaginate(t,e!=A.q.BACKWARDS),!0}return!1}onTimelineEvent(e,t,r,i){i&&this.onEventRemoved()}onEventRemoved(){const e=this.getEvents();e.length>0&&void 0===e[e.length-1]&&this.end&&this.end.index--}canPaginate(e){const t=this.getTimelineIndex(e);if(!t)return q("TimelineWindow: no timeline yet"),!1;if(e==A.q.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;const r=t.timeline.getNeighbouringTimeline(e),i=t.timeline.getPaginationToken(e);return Boolean(r)||Boolean(i)}async paginate(e,t,r=!0,i=10){const n=this.getTimelineIndex(e);if(!n)return q("TimelineWindow: no timeline yet"),!1;if(n.pendingPaginate)return n.pendingPaginate;if(this.extend(e,t))return!0;if(!r||0===i)return!1;if(!n.timeline.getPaginationToken(e))return q("TimelineWindow: no token"),!1;q("TimelineWindow: starting request");const o=this.client.paginateEventTimeline(n.timeline,{backwards:e==A.q.BACKWARDS,limit:t}).finally((function(){n.pendingPaginate=void 0})).then((r=>(q("TimelineWindow: request completed with result "+r),r?this.paginate(e,t,!0,i-1):this.paginate(e,t,!1,0))));return n.pendingPaginate=o,o}unpaginate(e,t){const r=t?this.start:this.end;if(!r)throw new Error(`Attempting to unpaginate startOfTimeline=${t} but don't have this direction`);if(e>this.eventCount||e<0)throw new Error(`Attemting to unpaginate ${e} events, but only have ${this.eventCount} in the timeline`);for(;e>0;){const i=t?r.advance(e):r.retreat(e);if(i<=0)throw new Error("Unable to unpaginate any further, but still have "+this.eventCount+" events");e-=i,this.eventCount-=i,q("TimelineWindow.unpaginate: dropped "+i+" (now "+this.eventCount+")")}}getEvents(){if(!this.start)return[];const e=[];let t=this.start.timeline;for(;t;){var r,i;const n=t.getEvents();let o=0,s=n.length;t===this.start.timeline&&(o=this.start.index+t.getBaseIndex()),t===(null===(r=this.end)||void 0===r?void 0:r.timeline)&&(s=this.end.index+t.getBaseIndex());for(let t=o;t<s;t++)e.push(n[t]);if(t===(null===(i=this.end)||void 0===i?void 0:i.timeline))break;t=t.getNeighbouringTimeline(A.q.FORWARDS)}return e}}class L{constructor(e,t){(0,a.A)(this,"pendingPaginate",void 0),this.timeline=e,this.index=t}minIndex(){return-1*this.timeline.getBaseIndex()}maxIndex(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()}advance(e){if(!e)return 0;let t;if(e<0){if(t=Math.max(e,this.minIndex()-this.index),t<0)return this.index+=t,t}else if(t=Math.min(e,this.maxIndex()-this.index),t>0)return this.index+=t,t;const r=this.timeline.getNeighbouringTimeline(e<0?A.q.BACKWARDS:A.q.FORWARDS);return r?(this.timeline=r,this.index=e<0?this.maxIndex():this.minIndex(),q("paginate: switched to new neighbour"),this.advance(e)):0}retreat(e){return-1*this.advance(-1*e)}}var F=r("./node_modules/matrix-js-sdk/src/interactive-auth.ts"),B=r("./node_modules/matrix-js-sdk/src/service-types.ts"),K=r("./node_modules/matrix-js-sdk/src/store/indexeddb-local-backend.ts");class V{constructor(e,t){(0,a.A)(this,"worker",void 0),(0,a.A)(this,"nextSeq",0),(0,a.A)(this,"inFlight",{}),(0,a.A)(this,"startPromise",void 0),(0,a.A)(this,"onWorkerMessage",(e=>{const t=e.data;var r;if("closed"==t.command)null===(r=this.onClose)||void 0===r||r.call(this);else if("cmd_success"==t.command||"cmd_fail"==t.command){if(void 0===t.seq)return void u.v.error("Got reply from worker with no seq");const e=this.inFlight[t.seq];if(void 0===e)return void u.v.error("Got reply for unknown seq "+t.seq);if(delete this.inFlight[t.seq],"cmd_success"==t.command)e.resolve(t.result);else{const r=new Error(t.error.message);r.name=t.error.name,e.reject(r)}}else u.v.warn("Unrecognised message from worker: ",t)})),this.workerFactory=e,this.dbName=t}connect(e){return this.onClose=e,this.ensureStarted().then((()=>this.doCmd("connect")))}clearDatabase(){return this.ensureStarted().then((()=>this.doCmd("clearDatabase")))}isNewlyCreated(){return this.doCmd("isNewlyCreated")}getSavedSync(){return this.doCmd("getSavedSync")}getNextBatchToken(){return this.doCmd("getNextBatchToken")}setSyncData(e){return this.doCmd("setSyncData",[e])}syncToDatabase(e){return this.doCmd("syncToDatabase",[e])}getOutOfBandMembers(e){return this.doCmd("getOutOfBandMembers",[e])}setOutOfBandMembers(e,t){return this.doCmd("setOutOfBandMembers",[e,t])}clearOutOfBandMembers(e){return this.doCmd("clearOutOfBandMembers",[e])}getClientOptions(){return this.doCmd("getClientOptions")}storeClientOptions(e){return this.doCmd("storeClientOptions",[e])}getUserPresenceEvents(){return this.doCmd("getUserPresenceEvents")}async saveToDeviceBatches(e){return this.doCmd("saveToDeviceBatches",[e])}async getOldestToDeviceBatch(){return this.doCmd("getOldestToDeviceBatch")}async removeToDeviceBatch(e){return this.doCmd("removeToDeviceBatch",[e])}ensureStarted(){return this.startPromise||(this.worker=this.workerFactory(),this.worker.onmessage=this.onWorkerMessage,this.startPromise=this.doCmd("setupWorker",[this.dbName]).then((()=>{u.v.log("IndexedDB worker is ready")}))),this.startPromise}doCmd(e,t){return Promise.resolve().then((()=>{var r;const i=this.nextSeq++,n=(0,m.v6)();return this.inFlight[i]=n,null===(r=this.worker)||void 0===r||r.postMessage({command:e,seq:i,args:t}),n.promise}))}async destroy(){var e;null===(e=this.worker)||void 0===e||e.terminate()}}class G extends n.n{static exists(e,t){return K.k.exists(e,t)}constructor(e){if(super(e),(0,a.A)(this,"backend",void 0),(0,a.A)(this,"startedUp",!1),(0,a.A)(this,"syncTs",0),(0,a.A)(this,"userModifiedMap",{}),(0,a.A)(this,"emitter",new I.X),(0,a.A)(this,"onClose",(()=>{this.emitter.emit("closed")})),(0,a.A)(this,"getSavedSync",this.degradable((()=>this.backend.getSavedSync()),"getSavedSync")),(0,a.A)(this,"isNewlyCreated",this.degradable((()=>this.backend.isNewlyCreated()),"isNewlyCreated")),(0,a.A)(this,"getSavedSyncToken",this.degradable((()=>this.backend.getNextBatchToken()),"getSavedSyncToken")),(0,a.A)(this,"deleteAllData",this.degradable((()=>(super.deleteAllData(),this.backend.clearDatabase().then((()=>{u.v.log("Deleted indexeddb data.")}),(e=>{throw u.v.error(`Failed to delete indexeddb data: ${e}`),e})))))),(0,a.A)(this,"reallySave",this.degradable((()=>{this.syncTs=Date.now();const e=[];for(const t of this.getUsers())this.userModifiedMap[t.userId]!==t.getLastModifiedTime()&&t.events.presence&&(e.push([t.userId,t.events.presence.event]),this.userModifiedMap[t.userId]=t.getLastModifiedTime());return this.backend.syncToDatabase(e)}))),(0,a.A)(this,"setSyncData",this.degradable((e=>this.backend.setSyncData(e)),"setSyncData")),(0,a.A)(this,"getOutOfBandMembers",this.degradable((e=>this.backend.getOutOfBandMembers(e)),"getOutOfBandMembers")),(0,a.A)(this,"setOutOfBandMembers",this.degradable(((e,t)=>(super.setOutOfBandMembers(e,t),this.backend.setOutOfBandMembers(e,t))),"setOutOfBandMembers")),(0,a.A)(this,"clearOutOfBandMembers",this.degradable((e=>(super.clearOutOfBandMembers(e),this.backend.clearOutOfBandMembers(e))),"clearOutOfBandMembers")),(0,a.A)(this,"getClientOptions",this.degradable((()=>this.backend.getClientOptions()),"getClientOptions")),(0,a.A)(this,"storeClientOptions",this.degradable((e=>(super.storeClientOptions(e),this.backend.storeClientOptions(e))),"storeClientOptions")),!e.indexedDB)throw new Error("Missing required option: indexedDB");e.workerFactory?this.backend=new V(e.workerFactory,e.dbName):this.backend=new K.k(e.indexedDB,e.dbName)}on(e,t){this.emitter.on(e,t)}startup(){return this.startedUp?(u.v.log("IndexedDBStore.startup: already started"),Promise.resolve()):(u.v.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect(this.onClose).then((()=>(u.v.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents()))).then((e=>{u.v.log("IndexedDBStore.startup: processing presence events"),e.forEach((([e,t])=>{if(!this.createUser)throw new Error("`IndexedDBStore.startup` must be called after assigning it to the client, not before!");const r=this.createUser(e);t&&r.setPresenceEvent(new d.kl(t)),this.userModifiedMap[r.userId]=r.getLastModifiedTime(),this.storeUser(r)})),this.startedUp=!0})))}destroy(){return this.backend.destroy()}wantsSave(){return Date.now()-this.syncTs>3e5}save(e=!1){return e||this.wantsSave()?this.reallySave():Promise.resolve()}degradable(e,t){const r=t?super[t]:null;return async(...t)=>{try{return await e.call(this,...t)}catch(e){u.v.error("IndexedDBStore failure, degrading to MemoryStore",e),this.emitter.emit("degraded",e);try{u.v.log("IndexedDBStore trying to delete degraded data"),await this.backend.clearDatabase(),u.v.log("IndexedDBStore delete after degrading succeeded")}catch(e){u.v.warn("IndexedDBStore delete after degrading failed",e)}if(r)return r.call(this,...t)}}}async getPendingEvents(e){if(!this.localStorage)return super.getPendingEvents(e);const t=this.localStorage.getItem($(e));if(t)try{return JSON.parse(t)}catch(e){u.v.error("Could not parse persisted pending events",e)}return[]}async setPendingEvents(e,t){if(!this.localStorage)return super.setPendingEvents(e,t);t.length>0?this.localStorage.setItem($(e),JSON.stringify(t)):this.localStorage.removeItem($(e))}saveToDeviceBatches(e){return this.backend.saveToDeviceBatches(e)}getOldestToDeviceBatch(){return this.backend.getOldestToDeviceBatch()}removeToDeviceBatch(e){return this.backend.removeToDeviceBatch(e)}}function $(e){return`mx_pending_events_${e}`}var H=r("./node_modules/matrix-js-sdk/src/crypto/store/localStorage-crypto-store.ts"),J=r("./node_modules/matrix-js-sdk/src/crypto/store/indexeddb-crypto-store.ts"),z=r("./node_modules/matrix-js-sdk/src/content-repo.ts"),Y=r("./node_modules/matrix-js-sdk/src/@types/PushRules.ts"),Q=r("./node_modules/matrix-js-sdk/src/@types/partials.ts"),X=r("./node_modules/matrix-js-sdk/src/@types/requests.ts"),Z=r("./node_modules/matrix-js-sdk/src/@types/search.ts"),ee=r("./node_modules/matrix-js-sdk/src/@types/beacon.ts"),te=r("./node_modules/matrix-js-sdk/src/@types/topic.ts"),re=r("./node_modules/matrix-js-sdk/src/@types/location.ts");let ie=function(e){return e.Email="email",e.Phone="msisdn",e}({});const ne=new(r("./node_modules/matrix-js-sdk/src/NamespacedValue.ts").qr)("delegated_oidc_compatibility","org.matrix.msc3824.delegated_oidc_compatibility");let oe=function(e){return e.Gitlab="gitlab",e.Github="github",e.Apple="apple",e.Google="google",e.Facebook="facebook",e.Twitter="twitter",e}({}),se=function(e){return e.LOGIN="login",e.REGISTER="register",e}({});var ae=r("./node_modules/matrix-js-sdk/src/@types/polls.ts"),ce=r("./node_modules/matrix-js-sdk/src/@types/read_receipts.ts"),de=r("./node_modules/matrix-js-sdk/src/@types/extensible_events.ts"),le=r("./node_modules/matrix-js-sdk/src/@types/membership.ts");if(3023==r.j)var ue=r("./node_modules/matrix-js-sdk/src/models/room-summary.ts");r("./node_modules/matrix-js-sdk/src/models/event-status.ts");var pe=r("./node_modules/matrix-js-sdk/src/content-helpers.ts"),he=r("./node_modules/matrix-js-sdk/src/secret-storage.ts"),fe=r("./node_modules/matrix-js-sdk/src/webrtc/call.ts"),me=r("./node_modules/matrix-js-sdk/src/webrtc/groupCall.ts"),ge=r("./node_modules/matrix-js-sdk/src/crypto/index.ts"),ve=r("./node_modules/matrix-js-sdk/src/sliding-sync.ts"),ye=r("./node_modules/matrix-js-sdk/src/webrtc/mediaHandler.ts"),_e=r("./node_modules/matrix-js-sdk/src/webrtc/callFeed.ts"),be=r("./node_modules/matrix-js-sdk/src/webrtc/stats/statsReport.ts"),we=r("./node_modules/matrix-js-sdk/src/models/relations.ts");let Se=function(e){return e.Global="Global",e.SetItemError="setItem",e.GetItemError="getItem",e.RemoveItemError="removeItem",e.ClearError="clear",e.QuotaExceededError="QuotaExceededError",e}({});class ke extends I.X{}new ke;var Ee=r("./node_modules/matrix-js-sdk/src/crypto-api/index.ts");let xe=()=>new i._;function je(e){xe=e}function Ae(e){var t,i,s;return e.store=null!==(t=e.store)&&void 0!==t?t:new n.n({localStorage:r.g.localStorage}),e.scheduler=null!==(i=e.scheduler)&&void 0!==i?i:new o.b,e.cryptoStore=null!==(s=e.cryptoStore)&&void 0!==s?s:xe(),e}function Oe(e){return new s.pB(Ae(e))}function Ce(e,t,r,i,n=!0){return new y(e,t,r,Ae(i),n)}},"./node_modules/matrix-js-sdk/src/oidc/authorize.ts":(e,t,r)=>{if(r.d(t,{P3:()=>f,R2:()=>g,SU:()=>v,cJ:()=>m,oE:()=>h}),3023==r.j)var i=r("./node_modules/@babel/runtime/helpers/esm/defineProperty.js");var n=r("./node_modules/oidc-client-ts/dist/esm/oidc-client-ts.js"),o=r("./node_modules/matrix-js-sdk/src/logger.ts"),s=r("./node_modules/matrix-js-sdk/src/randomstring.ts"),a=r("./node_modules/matrix-js-sdk/src/oidc/error.ts"),c=r("./node_modules/matrix-js-sdk/src/oidc/validate.ts");if(3023==r.j)var d=r("./node_modules/matrix-js-sdk/src/digest.ts");var l=r("./node_modules/matrix-js-sdk/src/base64.ts");function u(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function p(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?u(Object(r),!0).forEach((function(t){(0,i.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):u(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}const h=e=>`openid urn:matrix:org.matrix.msc2967.client:api:* urn:matrix:org.matrix.msc2967.client:device:${null!=e?e:(0,s.DU)(10)}`,f=({redirectUri:e})=>({scope:h(),redirectUri:e,state:(0,s.DU)(8),nonce:(0,s.DU)(8),codeVerifier:(0,s.DU)(64)}),m=async(e,t,{scope:r,redirectUri:i,state:n,nonce:s,codeVerifier:a})=>{const c=new URL(e);return c.searchParams.append("response_mode","query"),c.searchParams.append("response_type","code"),c.searchParams.append("redirect_uri",i),c.searchParams.append("client_id",t),c.searchParams.append("state",n),c.searchParams.append("scope",r),c.searchParams.append("nonce",s),c.searchParams.append("code_challenge_method","S256"),c.searchParams.append("code_challenge",await(async e=>{if(!globalThis.crypto.subtle)return o.v.warn("A secure context is required to generate code challenge. Using plain text code challenge"),e;const t=await(0,d.s)(e);return(0,l.A4)(t)})(a)),c.toString()},g=async({metadata:e,redirectUri:t,clientId:r,homeserverUrl:i,identityServerUrl:o,nonce:s,prompt:a,urlState:c})=>{const d=h(),l=new n.hz(p(p({},e),{},{client_id:r,redirect_uri:t,authority:e.issuer,response_mode:"query",response_type:"code",scope:d,stateStore:new n.O({prefix:"mx_oidc_",store:window.sessionStorage})})),u={homeserverUrl:i,nonce:s,identityServerUrl:o};return(await l.createSigninRequest({state:u,nonce:s,prompt:a,url_state:c})).url},v=async(e,t)=>{const r=new URL(window.location.origin);r.searchParams.append("code",e),r.searchParams.append("state",t),n.tG.setLogger(o.v);try{const e=new n.w7(r.searchParams),t=new n.O({prefix:"mx_oidc_",store:window.sessionStorage}),i=await t.get(e.state);if(!i)throw new Error(a.u.MissingOrInvalidStoredState);const o=await n.OA.fromStorageString(i),s=new n.hz(p(p({},o),{},{stateStore:t})),d=await s.processSigninResponse(r.href),l=d.userState;(0,c.K8)(l),(0,c.eC)(d),(0,c.rm)(d.id_token,s.settings.authority,s.settings.client_id,l.nonce);const u=(e=>({id_token:e.id_token,scope:e.scope,expires_at:e.expires_at,refresh_token:e.refresh_token,access_token:e.access_token,token_type:"Bearer"}))(d);return{oidcClientSettings:{clientId:s.settings.client_id,issuer:s.settings.authority},tokenResponse:u,homeserverUrl:l.homeserverUrl,identityServerUrl:l.identityServerUrl,idTokenClaims:d.profile}}catch(e){o.v.error("Oidc login failed",e);const t=e.message;if(Object.values(a.u).includes(t))throw e;throw new Error(a.u.CodeExchangeFailed)}}},"./node_modules/matrix-js-sdk/src/oidc/error.ts":(e,t,r)=>{r.d(t,{u:()=>i});let i=function(e){return e.NotSupported="OIDC authentication not supported",e.Misconfigured="OIDC is misconfigured",e.General="Something went wrong with OIDC discovery",e.OpSupport="Configured OIDC OP does not support required functions",e.DynamicRegistrationNotSupported="Dynamic registration not supported",e.DynamicRegistrationFailed="Dynamic registration failed",e.DynamicRegistrationInvalid="Dynamic registration invalid response",e.CodeExchangeFailed="Failed to exchange code for token",e.InvalidBearerTokenResponse="Invalid bearer token response",e.InvalidIdToken="Invalid ID token",e.MissingOrInvalidStoredState="State required to finish logging in is not found in storage.",e}({})},"./node_modules/matrix-js-sdk/src/oidc/index.ts":(e,t,r)=>{r.d(t,{AO:()=>h,uv:()=>u.u,db:()=>v,SU:()=>i.SU,Rh:()=>s.Rh,k8:()=>l,P3:()=>i.P3,cJ:()=>i.cJ,R2:()=>i.R2,oE:()=>i.oE,BH:()=>s.BH,aT:()=>f,eC:()=>s.eC,rm:()=>s.rm,sn:()=>s.sn,K8:()=>s.K8});var i=r("./node_modules/matrix-js-sdk/src/oidc/authorize.ts");if(3023==r.j)var n=r("./node_modules/@babel/runtime/helpers/esm/defineProperty.js");var o=r("./node_modules/oidc-client-ts/dist/esm/oidc-client-ts.js"),s=r("./node_modules/matrix-js-sdk/src/oidc/validate.ts"),a=r("./node_modules/matrix-js-sdk/src/http-api/index.ts");function c(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function d(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?c(Object(r),!0).forEach((function(t){(0,n.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):c(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}const l=async e=>{var t;const r=new URL(".well-known/openid-configuration",e),i=await fetch(r,{method:a.IT.Get,signal:(0,a._)(5e3)}),n=await i.json(),c=(0,s.sn)(n),l=new o.ZH({authority:e,redirect_uri:"",client_id:""}),u=new o.TI(l),p=await u.getMetadata(),h=null!==(t=await u.getSigningKeys())&&void 0!==t?t:void 0;return(0,s.BH)(p),d(d({},c),{},{metadata:p,signingKeys:h})};var u=r("./node_modules/matrix-js-sdk/src/oidc/error.ts"),p=r("./node_modules/matrix-js-sdk/src/logger.ts");const h="urn:ietf:params:oauth:grant-type:device_code",f=async(e,t)=>{if(!e.registrationEndpoint)throw new Error(u.u.DynamicRegistrationNotSupported);const r=["authorization_code","refresh_token"];if(r.some((t=>!e.metadata.grant_types_supported.includes(t))))throw new Error(u.u.DynamicRegistrationNotSupported);const i={client_name:t.clientName,client_uri:t.clientUri,response_types:["code"],grant_types:r,redirect_uris:t.redirectUris,id_token_signed_response_alg:"RS256",token_endpoint_auth_method:"none",application_type:t.applicationType,logo_uri:t.logoUri,contacts:t.contacts,policy_uri:t.policyUri,tos_uri:t.tosUri},n={Accept:"application/json","Content-Type":"application/json"};try{const t=await fetch(e.registrationEndpoint,{method:a.IT.Post,headers:n,body:JSON.stringify(i)});if(t.status>=400)throw new Error(u.u.DynamicRegistrationFailed);const r=(await t.json()).client_id;if(!r||"string"!=typeof r)throw new Error(u.u.DynamicRegistrationInvalid);return r}catch(e){throw Object.values(u.u).includes(e.message)?e:(p.v.error("Dynamic registration request failed",e),new Error(u.u.DynamicRegistrationFailed))}};function m(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function g(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?m(Object(r),!0).forEach((function(t){(0,n.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):m(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}class v{constructor(e,t,r,i,o){(0,n.A)(this,"oidcClientReady",void 0),(0,n.A)(this,"oidcClient",void 0),(0,n.A)(this,"inflightRefreshRequest",void 0),this.idTokenClaims=o,this.oidcClientReady=this.initialiseOidcClient(e,t,i,r)}async initialiseOidcClient(e,t,r,n){try{const s=await l(e),a=(0,i.oE)(r);this.oidcClient=new o.hz(g(g({},s.metadata),{},{client_id:t,scope:a,redirect_uri:n,authority:s.metadata.issuer,stateStore:new o.O({prefix:"mx_oidc_",store:window.sessionStorage})}))}catch(e){throw p.v.error("Failed to initialise OIDC client.",e),new Error("Failed to initialise OIDC client.")}}async doRefreshAccessToken(e){this.inflightRefreshRequest||(this.inflightRefreshRequest=this.getNewTokens(e));try{return await this.inflightRefreshRequest}finally{this.inflightRefreshRequest=void 0}}async persistTokens(e){}async getNewTokens(e){if(!this.oidcClient)throw new Error("Cannot get new token before OIDC client is initialised.");const t={refresh_token:e,session_state:"test",data:void 0,profile:this.idTokenClaims},r=await this.oidcClient.useRefreshToken({state:t,timeoutInSeconds:300}),i={accessToken:r.access_token,refreshToken:r.refresh_token};return await this.persistTokens(i),i}}},"./node_modules/matrix-js-sdk/src/oidc/validate.ts":(e,t,r)=>{r.d(t,{BH:()=>p,K8:()=>m,Rh:()=>h,eC:()=>v,rm:()=>f,sn:()=>u});var i=r("./node_modules/jwt-decode/build/esm/index.js"),n=r("./node_modules/matrix-js-sdk/src/logger.ts"),o=r("./node_modules/matrix-js-sdk/src/oidc/error.ts");const s=e=>!!e&&"object"==typeof e&&!Array.isArray(e),a=(e,t)=>!(!e[t]||!c(e,t))||(n.v.error(`Missing or invalid property: ${t}`),!1),c=(e,t)=>!e[t]||"string"==typeof e[t]||(n.v.error(`Invalid property: ${t}`),!1),d=(e,t)=>!!(!e[t]||Array.isArray(e[t])&&e[t].every((e=>"string"==typeof e)))||(n.v.error(`Invalid property: ${t}`),!1),l=(e,t,r)=>{const i=e[t];return!!(i&&Array.isArray(i)&&i.includes(r))||(n.v.error(`Invalid property: ${t}. ${r} is required.`),!1)},u=e=>{if(!s(e))throw n.v.error("Issuer configuration not found or malformed"),new Error(o.u.OpSupport);if(![a(e,"authorization_endpoint"),a(e,"token_endpoint"),a(e,"revocation_endpoint"),c(e,"registration_endpoint"),c(e,"account_management_uri"),c(e,"device_authorization_endpoint"),d(e,"account_management_actions_supported"),l(e,"response_types_supported","code"),l(e,"grant_types_supported","authorization_code"),l(e,"code_challenge_methods_supported","S256")].some((e=>!e)))return{authorizationEndpoint:e.authorization_endpoint,tokenEndpoint:e.token_endpoint,registrationEndpoint:e.registration_endpoint,accountManagementEndpoint:e.account_management_uri,accountManagementActionsSupported:e.account_management_actions_supported};throw n.v.error("Issuer configuration not valid"),new Error(o.u.OpSupport)};function p(e){u(e)}const h=e=>{try{return(0,i.s)(e)}catch(e){throw n.v.error("Could not decode id_token",e),e}},f=(e,t,r,i)=>{try{if(!e)throw new Error("No ID token");const n=h(e);if(n.iss!==t)throw new Error("Invalid issuer");if(n.aud!==r)throw new Error("Invalid audience");if(void 0!==i&&n.nonce!==i)throw new Error("Invalid nonce");if(!n.exp||Date.now()>1e3*n.exp)throw new Error("Invalid expiry")}catch(e){throw n.v.error("Invalid ID token",e),new Error(o.u.InvalidIdToken)}};function m(e){if(!s(e))throw n.v.error("Stored user state not found"),new Error(o.u.MissingOrInvalidStoredState);if([a(e,"homeserverUrl"),a(e,"nonce"),c(e,"identityServerUrl")].some((e=>!e)))throw new Error(o.u.MissingOrInvalidStoredState)}const g=e=>s(e)&&a(e,"token_type")&&"bearer"===e.token_type.toLowerCase()&&a(e,"access_token")&&a(e,"refresh_token")&&(!("expires_in"in e)||"number"==typeof e.expires_in);function v(e){if(!g(e))throw new Error(o.u.InvalidBearerTokenResponse)}},"./node_modules/matrix-js-sdk/src/sync-accumulator.ts":(e,t,r)=>{r.d(t,{b:()=>d,w:()=>l});var i=r("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),n=r("./node_modules/matrix-js-sdk/src/logger.ts"),o=r("./node_modules/matrix-js-sdk/src/utils.ts"),s=r("./node_modules/matrix-js-sdk/src/@types/sync.ts"),a=r("./node_modules/matrix-js-sdk/src/@types/event.ts");class c{constructor(){(0,i.A)(this,"unthreadedReadReceipts",new Map),(0,i.A)(this,"threadedReadReceipts",new o.kG((()=>new Map)))}setUnthreaded(e,t){this.unthreadedReadReceipts.set(e,t)}setThreaded(e,t,r){this.threadedReadReceipts.getOrCreate(e).set(t,r)}allUnthreaded(){return this.unthreadedReadReceipts.entries()}*allThreaded(){for(const e of this.threadedReadReceipts.values())for(const t of e.entries())yield t}consumeEphemeralEvents(e){null==e||e.forEach((e=>{e.type===a.Bx.Receipt&&e.content&&Object.keys(e.content).forEach((t=>{Object.entries(e.content[t]).forEach((([r,i])=>{if((0,o.ll)(r))for(const n of Object.keys(i)){const i=e.content[t][r][n],o={data:e.content[t][r][n],type:r,eventId:t};i.thread_id?this.setThreaded(i.thread_id,n,o):this.setUnthreaded(n,o)}}))}))}))}buildAccumulatedReceiptEvent(e){const t={type:a.Bx.Receipt,room_id:e,content:{}},r=new o.kG((()=>new o.kG((()=>new Map))));for(const[e,t]of this.allUnthreaded())r.getOrCreate(t.eventId).getOrCreate(t.type).set(e,t.data);for(const[e,t]of this.allThreaded())r.getOrCreate(t.eventId).getOrCreate(t.type).set(e,t.data);return t.content=(0,o.HF)(r),r.size>0?t:null}}let d=function(e){return e.Invite="invite",e.Leave="leave",e.Join="join",e.Knock="knock",e}({});class l{constructor(e={}){(0,i.A)(this,"accountData",{}),(0,i.A)(this,"inviteRooms",{}),(0,i.A)(this,"knockRooms",{}),(0,i.A)(this,"joinRooms",{}),(0,i.A)(this,"nextBatch",null),this.opts=e,this.opts.maxTimelineEntries=this.opts.maxTimelineEntries||50}accumulate(e,t=!1){this.accumulateRooms(e,t),this.accumulateAccountData(e),this.nextBatch=e.next_batch}accumulateAccountData(e){e.account_data&&e.account_data.events&&e.account_data.events.forEach((e=>{this.accountData[e.type]=e}))}accumulateRooms(e,t=!1){e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach((r=>{this.accumulateRoom(r,d.Invite,e.rooms.invite[r],t)})),e.rooms.join&&Object.keys(e.rooms.join).forEach((r=>{this.accumulateRoom(r,d.Join,e.rooms.join[r],t)})),e.rooms.leave&&Object.keys(e.rooms.leave).forEach((r=>{this.accumulateRoom(r,d.Leave,e.rooms.leave[r],t)})),e.rooms.knock&&Object.keys(e.rooms.knock).forEach((r=>{this.accumulateRoom(r,d.Knock,e.rooms.knock[r],t)})))}accumulateRoom(e,t,r,i=!1){switch(t){case d.Invite:this.knockRooms[e]&&delete this.knockRooms[e],this.accumulateInviteState(e,r);break;case d.Knock:this.accumulateKnockState(e,r);break;case d.Join:this.inviteRooms[e]&&delete this.inviteRooms[e],this.accumulateJoinState(e,r,i);break;case d.Leave:this.knockRooms[e]?delete this.knockRooms[e]:this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:n.v.error("Unknown cateogory: ",t)}}accumulateInviteState(e,t){if(!t.invite_state||!t.invite_state.events)return;if(!this.inviteRooms[e])return void(this.inviteRooms[e]={invite_state:t.invite_state});const r=this.inviteRooms[e];t.invite_state.events.forEach((e=>{let t=!1;for(let i=0;i<r.invite_state.events.length;i++){const n=r.invite_state.events[i];n.type===e.type&&n.state_key==e.state_key&&(r.invite_state.events[i]=e,t=!0)}t||r.invite_state.events.push(e)}))}accumulateKnockState(e,t){if(!t.knock_state||!t.knock_state.events)return;if(!this.knockRooms[e])return void(this.knockRooms[e]={knock_state:t.knock_state});const r=this.knockRooms[e];t.knock_state.events.forEach((e=>{let t=!1;for(let i=0;i<r.knock_state.events.length;i++){const n=r.knock_state.events[i];n.type===e.type&&n.state_key==e.state_key&&(r.knock_state.events[i]=e,t=!0)}t||r.knock_state.events.push(e)}))}accumulateJoinState(e,t,r=!1){var i,n,o,a,d;this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_unreadThreadNotifications:{},_summary:{},_receipts:new c});const l=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach((e=>{l._accountData[e.type]=e})),t.unread_notifications&&(l._unreadNotifications=t.unread_notifications),l._unreadThreadNotifications=null!==(i=null!==(n=t[s.a.stable])&&void 0!==n?n:t[s.a.unstable])&&void 0!==i?i:void 0,t.summary){var p,h,f;const e="m.heroes",r="m.invited_member_count",i="m.joined_member_count",n=l._summary,o=t.summary;n[e]=null!==(p=o[e])&&void 0!==p?p:n[e],n[i]=null!==(h=o[i])&&void 0!==h?h:n[i],n[r]=null!==(f=o[r])&&void 0!==f?f:n[r]}if(l._receipts.consumeEphemeralEvents(null===(o=t.ephemeral)||void 0===o?void 0:o.events),t.timeline&&t.timeline.limited&&(l._timeline=[]),null===(a=t.state)||void 0===a||null===(a=a.events)||void 0===a||a.forEach((e=>{u(l._currentState,e)})),null===(d=t.timeline)||void 0===d||null===(d=d.events)||void 0===d||d.forEach(((e,i)=>{var n;let o;if(u(l._currentState,e),r)o=e;else{var s;o=Object.assign({},e),void 0!==o.unsigned&&(o.unsigned=Object.assign({},o.unsigned));const t=null===(s=e.unsigned)||void 0===s?void 0:s.age;void 0!==t&&(o._localTs=Date.now()-t)}l._timeline.push({event:o,token:0===i&&null!==(n=t.timeline.prev_batch)&&void 0!==n?n:null})})),l._timeline.length>this.opts.maxTimelineEntries){for(let e=l._timeline.length-this.opts.maxTimelineEntries;e<l._timeline.length;e++)if(l._timeline[e].token){l._timeline=l._timeline.slice(e,l._timeline.length);break}}}getJSON(e=!1){const t={join:{},invite:{},knock:{},leave:{}};Object.keys(this.inviteRooms).forEach((e=>{t.invite[e]=this.inviteRooms[e]})),Object.keys(this.knockRooms).forEach((e=>{t.knock[e]=this.knockRooms[e]})),Object.keys(this.joinRooms).forEach((r=>{const i=this.joinRooms[r],n={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:i._unreadNotifications,unread_thread_notifications:i._unreadThreadNotifications,summary:i._summary};Object.keys(i._accountData).forEach((e=>{n.account_data.events.push(i._accountData[e])}));const s=i._receipts.buildAccumulatedReceiptEvent(r);s&&n.ephemeral.events.push(s),i._timeline.forEach((t=>{if(!n.timeline.prev_batch){if(!t.token)return;n.timeline.prev_batch=t.token}let r;var i;!e&&("_localTs"in(i=t.event)&&void 0!==i._localTs)?(r=Object.assign({},t.event),void 0!==r.unsigned&&(r.unsigned=Object.assign({},r.unsigned)),delete r._localTs,r.unsigned=r.unsigned||{},r.unsigned.age=Date.now()-t.event._localTs):r=t.event,n.timeline.events.push(r)}));const a=Object.create(null);for(let e=n.timeline.events.length-1;e>=0;e--){const t=n.timeline.events[e];if(null===t.state_key||void 0===t.state_key)continue;const r=(0,o.A4)(t);r.unsigned&&(r.unsigned.prev_content&&(r.content=r.unsigned.prev_content),r.unsigned.prev_sender&&(r.sender=r.unsigned.prev_sender)),u(a,r)}Object.keys(i._currentState).forEach((e=>{Object.keys(i._currentState[e]).forEach((t=>{let r=i._currentState[e][t];a[e]&&a[e][t]&&(r=a[e][t]),n.state.events.push(r)}))})),t.join[r]=n}));const r=[];return Object.keys(this.accountData).forEach((e=>{r.push(this.accountData[e])})),{nextBatch:this.nextBatch,roomsData:t,accountData:r}}getNextBatchToken(){return this.nextBatch}}function u(e,t){null!==t.state_key&&void 0!==t.state_key&&t.type&&(e[t.type]||(e[t.type]=Object.create(null)),e[t.type][t.state_key]=t)}},"./node_modules/matrix-widget-api/lib/ClientWidgetApi.js":(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ClientWidgetApi=void 0;var i=r("./node_modules/events/events.js"),n=r("./node_modules/matrix-widget-api/lib/transport/PostmessageTransport.js"),o=r("./node_modules/matrix-widget-api/lib/interfaces/WidgetApiDirection.js"),s=r("./node_modules/matrix-widget-api/lib/interfaces/WidgetApiAction.js"),a=r("./node_modules/matrix-widget-api/lib/interfaces/Capabilities.js"),c=r("./node_modules/matrix-widget-api/lib/interfaces/ApiVersion.js"),d=r("./node_modules/matrix-widget-api/lib/models/WidgetEventCapability.js"),l=r("./node_modules/matrix-widget-api/lib/interfaces/GetOpenIDAction.js"),u=r("./node_modules/matrix-widget-api/lib/util/SimpleObservable.js"),p=r("./node_modules/matrix-widget-api/lib/Symbols.js"),h=r("./node_modules/matrix-widget-api/lib/interfaces/UpdateDelayedEventAction.js");function f(e){return f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},f(e)}function m(){m=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,i=Object.defineProperty||function(e,t,r){e[t]=r.value},n="function"==typeof Symbol?Symbol:{},o=n.iterator||"@@iterator",s=n.asyncIterator||"@@asyncIterator",a=n.toStringTag||"@@toStringTag";function c(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,r){return e[t]=r}}function d(e,t,r,n){var o=t&&t.prototype instanceof p?t:p,s=Object.create(o.prototype),a=new A(n||[]);return i(s,"_invoke",{value:k(e,r,a)}),s}function l(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=d;var u={};function p(){}function h(){}function g(){}var v={};c(v,o,(function(){return this}));var y=Object.getPrototypeOf,_=y&&y(y(O([])));_&&_!==t&&r.call(_,o)&&(v=_);var b=g.prototype=p.prototype=Object.create(v);function w(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function S(e,t){function n(i,o,s,a){var c=l(e[i],e,o);if("throw"!==c.type){var d=c.arg,u=d.value;return u&&"object"==f(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,s,a)}),(function(e){n("throw",e,s,a)})):t.resolve(u).then((function(e){d.value=e,s(d)}),(function(e){return n("throw",e,s,a)}))}a(c.arg)}var o;i(this,"_invoke",{value:function(e,r){function i(){return new t((function(t,i){n(e,r,t,i)}))}return o=o?o.then(i,i):i()}})}function k(e,t,r){var i="suspendedStart";return function(n,o){if("executing"===i)throw new Error("Generator is already running");if("completed"===i){if("throw"===n)throw o;return C()}for(r.method=n,r.arg=o;;){var s=r.delegate;if(s){var a=E(s,r);if(a){if(a===u)continue;return a}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===i)throw i="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i="executing";var c=l(e,t,r);if("normal"===c.type){if(i=r.done?"completed":"suspendedYield",c.arg===u)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(i="completed",r.method="throw",r.arg=c.arg)}}}function E(e,t){var r=t.method,i=e.iterator[r];if(void 0===i)return t.delegate=null,"throw"===r&&e.iterator.return&&(t.method="return",t.arg=void 0,E(e,t),"throw"===t.method)||"return"!==r&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+r+"' method")),u;var n=l(i,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,u;var o=n.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,u):o:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,u)}function x(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function j(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function A(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(x,this),this.reset(!0)}function O(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,n=function t(){for(;++i<e.length;)if(r.call(e,i))return t.value=e[i],t.done=!1,t;return t.value=void 0,t.done=!0,t};return n.next=n}}return{next:C}}function C(){return{value:void 0,done:!0}}return h.prototype=g,i(b,"constructor",{value:g,configurable:!0}),i(g,"constructor",{value:h,configurable:!0}),h.displayName=c(g,a,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,g):(e.__proto__=g,c(e,a,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(S.prototype),c(S.prototype,s,(function(){return this})),e.AsyncIterator=S,e.async=function(t,r,i,n,o){void 0===o&&(o=Promise);var s=new S(d(t,r,i,n),o);return e.isGeneratorFunction(r)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},w(b),c(b,a,"Generator"),c(b,o,(function(){return this})),c(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),r=[];for(var i in t)r.push(i);return r.reverse(),function e(){for(;r.length;){var i=r.pop();if(i in t)return e.value=i,e.done=!1,e}return e.done=!0,e}},e.values=O,A.prototype={constructor:A,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(j),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function i(r,i){return s.type="throw",s.arg=e,t.next=r,i&&(t.method="next",t.arg=void 0),!!i}for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n],s=o.completion;if("root"===o.tryLoc)return i("end");if(o.tryLoc<=this.prev){var a=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(a&&c){if(this.prev<o.catchLoc)return i(o.catchLoc,!0);if(this.prev<o.finallyLoc)return i(o.finallyLoc)}else if(a){if(this.prev<o.catchLoc)return i(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return i(o.finallyLoc)}}}},abrupt:function(e,t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.tryLoc<=this.prev&&r.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var o=n;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var s=o?o.completion:{};return s.type=e,s.arg=t,o?(this.method="next",this.next=o.finallyLoc,u):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),u},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),j(r),u}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var i=r.completion;if("throw"===i.type){var n=i.arg;j(r)}return n}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),u}},e}function g(e,t,r,i,n,o,s){try{var a=e[o](s),c=a.value}catch(e){return void r(e)}a.done?t(c):Promise.resolve(c).then(i,n)}function v(e){return function(){var t=this,r=arguments;return new Promise((function(i,n){var o=e.apply(t,r);function s(e){g(o,i,n,s,a,"next",e)}function a(e){g(o,i,n,s,a,"throw",e)}s(void 0)}))}}function y(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return _(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return _(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function _(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}function b(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function w(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?b(Object(r),!0).forEach((function(t){A(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):b(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function S(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,O(i.key),i)}}function k(e,t){return k=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},k(e,t)}function E(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,i=j(e);if(t){var n=j(this).constructor;r=Reflect.construct(i,arguments,n)}else r=i.apply(this,arguments);return function(e,t){if(t&&("object"===f(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return x(e)}(this,r)}}function x(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function j(e){return j=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},j(e)}function A(e,t,r){return(t=O(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function O(e){var t=function(e,t){if("object"!==f(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,t||"default");if("object"!==f(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===f(t)?t:String(t)}function C(e){var t,r,i,n=2;for("undefined"!=typeof Symbol&&(r=Symbol.asyncIterator,i=Symbol.iterator);n--;){if(r&&null!=(t=e[r]))return t.call(e);if(i&&null!=(t=e[i]))return new T(t.call(e));r="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function T(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then((function(e){return{value:e,done:t}}))}return T=function(e){this.s=e,this.n=e.next},T.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var r=this.s.return;return void 0===r?Promise.resolve({value:e,done:!0}):t(r.apply(this.s,arguments))},throw:function(e){var r=this.s.return;return void 0===r?Promise.reject(e):t(r.apply(this.s,arguments))}},new T(e)}var R=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&k(e,t)}(W,e);var t,r,i,f,g,_,b,j,O,T,R,P,I,M,D=E(W);function W(e,t,r){var i;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,W),(i=D.call(this)).widget=e,i.iframe=t,i.driver=r,A(x(i),"transport",void 0),A(x(i),"contentLoadedActionSent",!1),A(x(i),"allowedCapabilities",new Set),A(x(i),"allowedEvents",[]),A(x(i),"isStopped",!1),A(x(i),"turnServers",null),A(x(i),"contentLoadedWaitTimer",void 0),null==t||!t.contentWindow)throw new Error("No iframe supplied");if(!e)throw new Error("Invalid widget");if(!r)throw new Error("Invalid driver");return i.transport=new n.PostmessageTransport(o.WidgetApiDirection.ToWidget,e.id,t.contentWindow,window),i.transport.targetOrigin=e.origin,i.transport.on("message",i.handleMessage.bind(x(i))),t.addEventListener("load",i.onIframeLoad.bind(x(i))),i.transport.start(),i}return t=W,r=[{key:"hasCapability",value:function(e){return this.allowedCapabilities.has(e)}},{key:"canUseRoomTimeline",value:function(e){return this.hasCapability("org.matrix.msc2762.timeline:".concat(p.Symbols.AnyRoom))||this.hasCapability("org.matrix.msc2762.timeline:".concat(e))}},{key:"canSendRoomEvent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.allowedEvents.some((function(r){return r.matchesAsRoomEvent(d.EventDirection.Send,e,t)}))}},{key:"canSendStateEvent",value:function(e,t){return this.allowedEvents.some((function(r){return r.matchesAsStateEvent(d.EventDirection.Send,e,t)}))}},{key:"canSendToDeviceEvent",value:function(e){return this.allowedEvents.some((function(t){return t.matchesAsToDeviceEvent(d.EventDirection.Send,e)}))}},{key:"canReceiveRoomEvent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.allowedEvents.some((function(r){return r.matchesAsRoomEvent(d.EventDirection.Receive,e,t)}))}},{key:"canReceiveStateEvent",value:function(e,t){return this.allowedEvents.some((function(r){return r.matchesAsStateEvent(d.EventDirection.Receive,e,t)}))}},{key:"canReceiveToDeviceEvent",value:function(e){return this.allowedEvents.some((function(t){return t.matchesAsToDeviceEvent(d.EventDirection.Receive,e)}))}},{key:"canReceiveRoomAccountData",value:function(e){return this.allowedEvents.some((function(t){return t.matchesAsRoomAccountData(d.EventDirection.Receive,e)}))}},{key:"stop",value:function(){this.isStopped=!0,this.transport.stop()}},{key:"beginCapabilities",value:function(){var e,t=this;this.emit("preparing"),this.transport.send(s.WidgetApiToWidgetAction.Capabilities,{}).then((function(r){return e=r.capabilities,t.driver.validateCapabilities(new Set(r.capabilities))})).then((function(r){console.log("Widget ".concat(t.widget.id," is allowed capabilities:"),Array.from(r)),t.allowedCapabilities=r,t.allowedEvents=d.WidgetEventCapability.findEventCapabilities(r),t.notifyCapabilities(e),t.emit("ready")})).catch((function(e){t.emit("error:preparing",e)}))}},{key:"notifyCapabilities",value:function(e){var t=this;this.transport.send(s.WidgetApiToWidgetAction.NotifyCapabilities,{requested:e,approved:Array.from(this.allowedCapabilities)}).catch((function(e){console.warn("non-fatal error notifying widget of approved capabilities:",e)})).then((function(){t.emit("capabilitiesNotified")}))}},{key:"onIframeLoad",value:function(e){this.widget.waitForIframeLoad?this.beginCapabilities():(console.log("waitForIframeLoad is false: waiting for widget to send contentLoaded"),this.contentLoadedWaitTimer=setTimeout((function(){console.error("Widget specified waitForIframeLoad=false but timed out waiting for contentLoaded event!")}),1e4),this.contentLoadedActionSent=!1)}},{key:"handleContentLoadedAction",value:function(e){if(void 0!==this.contentLoadedWaitTimer&&(clearTimeout(this.contentLoadedWaitTimer),this.contentLoadedWaitTimer=void 0),this.contentLoadedActionSent)throw new Error("Improper sequence: ContentLoaded Action can only be sent once after the widget loaded and should only be used if waitForIframeLoad is false (default=true)");this.widget.waitForIframeLoad?this.transport.reply(e,{error:{message:"Improper sequence: not expecting ContentLoaded event if waitForIframeLoad is true (default=true)"}}):(this.transport.reply(e,{}),this.beginCapabilities()),this.contentLoadedActionSent=!0}},{key:"replyVersions",value:function(e){this.transport.reply(e,{supported_versions:c.CurrentApiVersions})}},{key:"handleCapabilitiesRenegotiate",value:function(e){var t,r=this;this.transport.reply(e,{});var i=(null===(t=e.data)||void 0===t?void 0:t.capabilities)||[],n=new Set(i.filter((function(e){return!r.hasCapability(e)})));if(0===n.size)return this.notifyCapabilities([]);this.driver.validateCapabilities(n).then((function(e){return e.forEach((function(e){return r.allowedCapabilities.add(e)})),d.WidgetEventCapability.findEventCapabilities(e).forEach((function(e){return r.allowedEvents.push(e)})),r.notifyCapabilities(Array.from(n))}))}},{key:"handleNavigate",value:function(e){var t,r,i=this;if(!this.hasCapability(a.MatrixCapabilities.MSC2931Navigate))return this.transport.reply(e,{error:{message:"Missing capability"}});if(null===(t=e.data)||void 0===t||!t.uri||null===(r=e.data)||void 0===r||!r.uri.toString().startsWith("https://matrix.to/#"))return this.transport.reply(e,{error:{message:"Invalid matrix.to URI"}});var n=function(t){return console.error("[ClientWidgetApi] Failed to handle navigation: ",t),i.transport.reply(e,{error:{message:"Error handling navigation"}})};try{this.driver.navigate(e.data.uri.toString()).catch((function(e){return n(e)})).then((function(){return i.transport.reply(e,{})}))}catch(e){return n(e)}}},{key:"handleOIDC",value:function(e){var t=this,r=1,i=function(i,n){return n=n||{},r>1?t.transport.send(s.WidgetApiToWidgetAction.OpenIDCredentials,w({state:i,original_request_id:e.requestId},n)):t.transport.reply(e,w({state:i},n))},n=function(n){return console.error("[ClientWidgetApi] Failed to handle OIDC: ",n),r>1?i(l.OpenIDRequestState.Blocked):t.transport.reply(e,{error:{message:n}})},o=new u.SimpleObservable((function(e){return e.state===l.OpenIDRequestState.PendingUserConfirmation&&r>1?(o.close(),n("client provided out-of-phase response to OIDC flow")):e.state===l.OpenIDRequestState.PendingUserConfirmation?(i(e.state),void r++):e.state!==l.OpenIDRequestState.Allowed||e.token?(e.state===l.OpenIDRequestState.Blocked&&(e.token=void 0),o.close(),i(e.state,e.token)):n("client provided invalid OIDC token for an allowed request")}));this.driver.askOpenID(o)}},{key:"handleReadRoomAccountData",value:function(e){var t=this,r=Promise.resolve([]);return r=this.driver.readRoomAccountData(e.data.type),this.canReceiveRoomAccountData(e.data.type)?r.then((function(r){t.transport.reply(e,{events:r})})):this.transport.reply(e,{error:{message:"Cannot read room account data of this type"}})}},{key:"handleReadEvents",value:function(e){var t=this;if(!e.data.type)return this.transport.reply(e,{error:{message:"Invalid request - missing event type"}});if(void 0!==e.data.limit&&(!e.data.limit||e.data.limit<0))return this.transport.reply(e,{error:{message:"Invalid request - limit out of range"}});var r=null;if(e.data.room_ids){r=e.data.room_ids,Array.isArray(r)||(r=[r]);var i,n=y(r);try{for(n.s();!(i=n.n()).done;){var o=i.value;if(!this.canUseRoomTimeline(o))return this.transport.reply(e,{error:{message:"Unable to access room timeline: ".concat(o)}})}}catch(e){n.e(e)}finally{n.f()}}var s=e.data.limit||0,a=e.data.since,c=Promise.resolve([]);if(void 0!==e.data.state_key){var d=!0===e.data.state_key?void 0:e.data.state_key.toString();if(!this.canReceiveStateEvent(e.data.type,null!=d?d:null))return this.transport.reply(e,{error:{message:"Cannot read state events of this type"}});c=this.driver.readStateEvents(e.data.type,d,s,r)}else{if(!this.canReceiveRoomEvent(e.data.type,e.data.msgtype))return this.transport.reply(e,{error:{message:"Cannot read room events of this type"}});c=this.driver.readRoomEvents(e.data.type,e.data.msgtype,s,r,a)}return c.then((function(r){return t.transport.reply(e,{events:r})}))}},{key:"handleSendEvent",value:function(e){var t=this;if(!e.data.type)return this.transport.reply(e,{error:{message:"Invalid request - missing event type"}});if(e.data.room_id&&!this.canUseRoomTimeline(e.data.room_id))return this.transport.reply(e,{error:{message:"Unable to access room timeline: ".concat(e.data.room_id)}});var r,i=void 0!==e.data.delay||void 0!==e.data.parent_delay_id;if(i&&!this.hasCapability(a.MatrixCapabilities.MSC4157SendDelayedEvent))return this.transport.reply(e,{error:{message:"Missing capability"}});if(void 0!==e.data.state_key){if(!this.canSendStateEvent(e.data.type,e.data.state_key))return this.transport.reply(e,{error:{message:"Cannot send state events of this type"}});var n,o;r=i?this.driver.sendDelayedEvent(null!==(n=e.data.delay)&&void 0!==n?n:null,null!==(o=e.data.parent_delay_id)&&void 0!==o?o:null,e.data.type,e.data.content||{},e.data.state_key,e.data.room_id):this.driver.sendEvent(e.data.type,e.data.content||{},e.data.state_key,e.data.room_id)}else{var s,c,d=e.data.content||{},l=d.msgtype;if(!this.canSendRoomEvent(e.data.type,l))return this.transport.reply(e,{error:{message:"Cannot send room events of this type"}});r=i?this.driver.sendDelayedEvent(null!==(s=e.data.delay)&&void 0!==s?s:null,null!==(c=e.data.parent_delay_id)&&void 0!==c?c:null,e.data.type,d,null,e.data.room_id):this.driver.sendEvent(e.data.type,d,null,e.data.room_id)}r.then((function(r){return t.transport.reply(e,w({room_id:r.roomId},"eventId"in r?{event_id:r.eventId}:{delay_id:r.delayId}))})).catch((function(r){return console.error("error sending event: ",r),t.transport.reply(e,{error:{message:"Error sending event"}})}))}},{key:"handleUpdateDelayedEvent",value:function(e){var t=this;if(!e.data.delay_id)return this.transport.reply(e,{error:{message:"Invalid request - missing delay_id"}});if(!this.hasCapability(a.MatrixCapabilities.MSC4157UpdateDelayedEvent))return this.transport.reply(e,{error:{message:"Missing capability"}});switch(e.data.action){case h.UpdateDelayedEventAction.Cancel:case h.UpdateDelayedEventAction.Restart:case h.UpdateDelayedEventAction.Send:this.driver.updateDelayedEvent(e.data.delay_id,e.data.action).then((function(){return t.transport.reply(e,{})})).catch((function(r){return console.error("error updating delayed event: ",r),t.transport.reply(e,{error:{message:"Error updating delayed event"}})}));break;default:return this.transport.reply(e,{error:{message:"Invalid request - unsupported action"}})}}},{key:"handleSendToDevice",value:(M=v(m().mark((function e(t){return m().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.data.type){e.next=5;break}return e.next=3,this.transport.reply(t,{error:{message:"Invalid request - missing event type"}});case 3:case 8:case 13:case 18:case 25:e.next=32;break;case 5:if(t.data.messages){e.next=10;break}return e.next=8,this.transport.reply(t,{error:{message:"Invalid request - missing event contents"}});case 10:if("boolean"==typeof t.data.encrypted){e.next=15;break}return e.next=13,this.transport.reply(t,{error:{message:"Invalid request - missing encryption flag"}});case 15:if(this.canSendToDeviceEvent(t.data.type)){e.next=20;break}return e.next=18,this.transport.reply(t,{error:{message:"Cannot send to-device events of this type"}});case 20:return e.prev=20,e.next=23,this.driver.sendToDevice(t.data.type,t.data.encrypted,t.data.messages);case 23:return e.next=25,this.transport.reply(t,{});case 27:return e.prev=27,e.t0=e.catch(20),console.error("error sending to-device event",e.t0),e.next=32,this.transport.reply(t,{error:{message:"Error sending event"}});case 32:case"end":return e.stop()}}),e,this,[[20,27]])}))),function(e){return M.apply(this,arguments)})},{key:"pollTurnServers",value:(I=v(m().mark((function e(t,r){var i,n,o,a,c,d;return m().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.transport.send(s.WidgetApiToWidgetAction.UpdateTurnServers,r);case 3:i=!1,n=!1,e.prev=5,a=C(t);case 7:return e.next=9,a.next();case 9:if(!(i=!(c=e.sent).done)){e.next=16;break}return d=c.value,e.next=13,this.transport.send(s.WidgetApiToWidgetAction.UpdateTurnServers,d);case 13:i=!1,e.next=7;break;case 16:e.next=22;break;case 18:e.prev=18,e.t0=e.catch(5),n=!0,o=e.t0;case 22:if(e.prev=22,e.prev=23,!i||null==a.return){e.next=27;break}return e.next=27,a.return();case 27:if(e.prev=27,!n){e.next=30;break}throw o;case 30:return e.finish(27);case 31:return e.finish(22);case 32:e.next=37;break;case 34:e.prev=34,e.t1=e.catch(0),console.error("error polling for TURN servers",e.t1);case 37:case"end":return e.stop()}}),e,this,[[0,34],[5,18,22,32],[23,,27,31]])}))),function(e,t){return I.apply(this,arguments)})},{key:"handleWatchTurnServers",value:(P=v(m().mark((function e(t){var r,i,n,o;return m().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(a.MatrixCapabilities.MSC3846TurnServers)){e.next=5;break}return e.next=3,this.transport.reply(t,{error:{message:"Missing capability"}});case 3:case 8:e.next=30;break;case 5:if(!this.turnServers){e.next=10;break}return e.next=8,this.transport.reply(t,{});case 10:return e.prev=10,r=this.driver.getTurnServers(),e.next=14,r.next();case 14:if(i=e.sent,n=i.done,o=i.value,!n){e.next=19;break}throw new Error("Client refuses to provide any TURN servers");case 19:return e.next=21,this.transport.reply(t,{});case 21:this.pollTurnServers(r,o),this.turnServers=r,e.next=30;break;case 25:return e.prev=25,e.t0=e.catch(10),console.error("error getting first TURN server results",e.t0),e.next=30,this.transport.reply(t,{error:{message:"TURN servers not available"}});case 30:case"end":return e.stop()}}),e,this,[[10,25]])}))),function(e){return P.apply(this,arguments)})},{key:"handleUnwatchTurnServers",value:(R=v(m().mark((function e(t){return m().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(a.MatrixCapabilities.MSC3846TurnServers)){e.next=5;break}return e.next=3,this.transport.reply(t,{error:{message:"Missing capability"}});case 3:case 8:e.next=15;break;case 5:if(this.turnServers){e.next=10;break}return e.next=8,this.transport.reply(t,{});case 10:return e.next=12,this.turnServers.return(void 0);case 12:return this.turnServers=null,e.next=15,this.transport.reply(t,{});case 15:case"end":return e.stop()}}),e,this)}))),function(e){return R.apply(this,arguments)})},{key:"handleReadRelations",value:(T=v(m().mark((function e(t){var r,i,n=this;return m().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.data.event_id){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - missing event ID"}}));case 2:if(!(void 0!==t.data.limit&&t.data.limit<0)){e.next=4;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - limit out of range"}}));case 4:if(void 0===t.data.room_id||this.canUseRoomTimeline(t.data.room_id)){e.next=6;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Unable to access room timeline: ".concat(t.data.room_id)}}));case 6:return e.prev=6,e.next=9,this.driver.readEventRelations(t.data.event_id,t.data.room_id,t.data.rel_type,t.data.event_type,t.data.from,t.data.to,t.data.limit,t.data.direction);case 9:return r=e.sent,i=r.chunk.filter((function(e){return void 0!==e.state_key?n.canReceiveStateEvent(e.type,e.state_key):n.canReceiveRoomEvent(e.type,e.content.msgtype)})),e.abrupt("return",this.transport.reply(t,{chunk:i,prev_batch:r.prevBatch,next_batch:r.nextBatch}));case 14:return e.prev=14,e.t0=e.catch(6),console.error("error getting the relations",e.t0),e.next=19,this.transport.reply(t,{error:{message:"Unexpected error while reading relations"}});case 19:case"end":return e.stop()}}),e,this,[[6,14]])}))),function(e){return T.apply(this,arguments)})},{key:"handleUserDirectorySearch",value:(O=v(m().mark((function e(t){var r;return m().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(a.MatrixCapabilities.MSC3973UserDirectorySearch)){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Missing capability"}}));case 2:if("string"==typeof t.data.search_term){e.next=4;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - missing search term"}}));case 4:if(!(void 0!==t.data.limit&&t.data.limit<0)){e.next=6;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - limit out of range"}}));case 6:return e.prev=6,e.next=9,this.driver.searchUserDirectory(t.data.search_term,t.data.limit);case 9:return r=e.sent,e.abrupt("return",this.transport.reply(t,{limited:r.limited,results:r.results.map((function(e){return{user_id:e.userId,display_name:e.displayName,avatar_url:e.avatarUrl}}))}));case 13:return e.prev=13,e.t0=e.catch(6),console.error("error searching in the user directory",e.t0),e.next=18,this.transport.reply(t,{error:{message:"Unexpected error while searching in the user directory"}});case 18:case"end":return e.stop()}}),e,this,[[6,13]])}))),function(e){return O.apply(this,arguments)})},{key:"handleGetMediaConfig",value:(j=v(m().mark((function e(t){var r;return m().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(a.MatrixCapabilities.MSC4039UploadFile)){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Missing capability"}}));case 2:return e.prev=2,e.next=5,this.driver.getMediaConfig();case 5:return r=e.sent,e.abrupt("return",this.transport.reply(t,r));case 9:return e.prev=9,e.t0=e.catch(2),console.error("error while getting the media configuration",e.t0),e.next=14,this.transport.reply(t,{error:{message:"Unexpected error while getting the media configuration"}});case 14:case"end":return e.stop()}}),e,this,[[2,9]])}))),function(e){return j.apply(this,arguments)})},{key:"handleUploadFile",value:(b=v(m().mark((function e(t){var r;return m().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(a.MatrixCapabilities.MSC4039UploadFile)){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Missing capability"}}));case 2:return e.prev=2,e.next=5,this.driver.uploadFile(t.data.file);case 5:return r=e.sent,e.abrupt("return",this.transport.reply(t,{content_uri:r.contentUri}));case 9:return e.prev=9,e.t0=e.catch(2),console.error("error while uploading a file",e.t0),e.next=14,this.transport.reply(t,{error:{message:"Unexpected error while uploading a file"}});case 14:case"end":return e.stop()}}),e,this,[[2,9]])}))),function(e){return b.apply(this,arguments)})},{key:"handleDownloadFile",value:(_=v(m().mark((function e(t){var r;return m().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasCapability(a.MatrixCapabilities.MSC4039DownloadFile)){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Missing capability"}}));case 2:return e.prev=2,e.next=5,this.driver.downloadFile(t.data.content_uri);case 5:return r=e.sent,e.abrupt("return",this.transport.reply(t,{file:r.file}));case 9:e.prev=9,e.t0=e.catch(2),console.error("error while downloading a file",e.t0),this.transport.reply(t,{error:{message:"Unexpected error while downloading a file"}});case 13:case"end":return e.stop()}}),e,this,[[2,9]])}))),function(e){return _.apply(this,arguments)})},{key:"handleMessage",value:function(e){if(!this.isStopped){var t=new CustomEvent("action:".concat(e.detail.action),{detail:e.detail,cancelable:!0});if(this.emit("action:".concat(e.detail.action),t),!t.defaultPrevented)switch(e.detail.action){case s.WidgetApiFromWidgetAction.ContentLoaded:return this.handleContentLoadedAction(e.detail);case s.WidgetApiFromWidgetAction.SupportedApiVersions:return this.replyVersions(e.detail);case s.WidgetApiFromWidgetAction.SendEvent:return this.handleSendEvent(e.detail);case s.WidgetApiFromWidgetAction.SendToDevice:return this.handleSendToDevice(e.detail);case s.WidgetApiFromWidgetAction.GetOpenIDCredentials:return this.handleOIDC(e.detail);case s.WidgetApiFromWidgetAction.MSC2931Navigate:return this.handleNavigate(e.detail);case s.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities:return this.handleCapabilitiesRenegotiate(e.detail);case s.WidgetApiFromWidgetAction.MSC2876ReadEvents:return this.handleReadEvents(e.detail);case s.WidgetApiFromWidgetAction.WatchTurnServers:return this.handleWatchTurnServers(e.detail);case s.WidgetApiFromWidgetAction.UnwatchTurnServers:return this.handleUnwatchTurnServers(e.detail);case s.WidgetApiFromWidgetAction.MSC3869ReadRelations:return this.handleReadRelations(e.detail);case s.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch:return this.handleUserDirectorySearch(e.detail);case s.WidgetApiFromWidgetAction.BeeperReadRoomAccountData:return this.handleReadRoomAccountData(e.detail);case s.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction:return this.handleGetMediaConfig(e.detail);case s.WidgetApiFromWidgetAction.MSC4039UploadFileAction:return this.handleUploadFile(e.detail);case s.WidgetApiFromWidgetAction.MSC4039DownloadFileAction:return this.handleDownloadFile(e.detail);case s.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent:return this.handleUpdateDelayedEvent(e.detail);default:return this.transport.reply(e.detail,{error:{message:"Unknown or unsupported action: "+e.detail.action}})}}}},{key:"takeScreenshot",value:function(){return this.transport.send(s.WidgetApiToWidgetAction.TakeScreenshot,{})}},{key:"updateVisibility",value:function(e){return this.transport.send(s.WidgetApiToWidgetAction.UpdateVisibility,{visible:e})}},{key:"sendWidgetConfig",value:function(e){return this.transport.send(s.WidgetApiToWidgetAction.WidgetConfig,e).then()}},{key:"notifyModalWidgetButtonClicked",value:function(e){return this.transport.send(s.WidgetApiToWidgetAction.ButtonClicked,{id:e}).then()}},{key:"notifyModalWidgetClose",value:function(e){return this.transport.send(s.WidgetApiToWidgetAction.CloseModalWidget,e).then()}},{key:"feedEvent",value:(g=v(m().mark((function e(t,r){var i;return m().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.room_id===r||this.canUseRoomTimeline(t.room_id)){e.next=2;break}return e.abrupt("return");case 2:if(void 0===t.state_key||null===t.state_key){e.next=7;break}if(this.canReceiveStateEvent(t.type,t.state_key)){e.next=5;break}return e.abrupt("return");case 5:e.next=9;break;case 7:if(this.canReceiveRoomEvent(t.type,null===(i=t.content)||void 0===i?void 0:i.msgtype)){e.next=9;break}return e.abrupt("return");case 9:return e.next=11,this.transport.send(s.WidgetApiToWidgetAction.SendEvent,t);case 11:case"end":return e.stop()}}),e,this)}))),function(e,t){return g.apply(this,arguments)})},{key:"feedToDevice",value:(f=v(m().mark((function e(t,r){return m().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.canReceiveToDeviceEvent(t.type)){e.next=3;break}return e.next=3,this.transport.send(s.WidgetApiToWidgetAction.SendToDevice,w(w({},t),{},{encrypted:r}));case 3:case"end":return e.stop()}}),e,this)}))),function(e,t){return f.apply(this,arguments)})}],r&&S(t.prototype,r),i&&S(t,i),Object.defineProperty(t,"prototype",{writable:!1}),W}(i.EventEmitter);t.ClientWidgetApi=R},"./node_modules/matrix-widget-api/lib/Symbols.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Symbols=void 0;var r=function(e){return e.AnyRoom="*",e}({});t.Symbols=r},"./node_modules/matrix-widget-api/lib/WidgetApi.js":(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetApi=void 0;var i=r("./node_modules/events/events.js"),n=r("./node_modules/matrix-widget-api/lib/interfaces/WidgetApiDirection.js"),o=r("./node_modules/matrix-widget-api/lib/interfaces/ApiVersion.js"),s=r("./node_modules/matrix-widget-api/lib/transport/PostmessageTransport.js"),a=r("./node_modules/matrix-widget-api/lib/interfaces/WidgetApiAction.js"),c=r("./node_modules/matrix-widget-api/lib/interfaces/GetOpenIDAction.js"),d=r("./node_modules/matrix-widget-api/lib/interfaces/WidgetType.js"),l=r("./node_modules/matrix-widget-api/lib/interfaces/ModalWidgetActions.js"),u=r("./node_modules/matrix-widget-api/lib/models/WidgetEventCapability.js"),p=r("./node_modules/matrix-widget-api/lib/Symbols.js");function h(e){return h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},h(e)}function f(){f=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,i=Object.defineProperty||function(e,t,r){e[t]=r.value},n="function"==typeof Symbol?Symbol:{},o=n.iterator||"@@iterator",s=n.asyncIterator||"@@asyncIterator",a=n.toStringTag||"@@toStringTag";function c(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,r){return e[t]=r}}function d(e,t,r,n){var o=t&&t.prototype instanceof p?t:p,s=Object.create(o.prototype),a=new A(n||[]);return i(s,"_invoke",{value:k(e,r,a)}),s}function l(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=d;var u={};function p(){}function m(){}function g(){}var v={};c(v,o,(function(){return this}));var y=Object.getPrototypeOf,_=y&&y(y(O([])));_&&_!==t&&r.call(_,o)&&(v=_);var b=g.prototype=p.prototype=Object.create(v);function w(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function S(e,t){function n(i,o,s,a){var c=l(e[i],e,o);if("throw"!==c.type){var d=c.arg,u=d.value;return u&&"object"==h(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,s,a)}),(function(e){n("throw",e,s,a)})):t.resolve(u).then((function(e){d.value=e,s(d)}),(function(e){return n("throw",e,s,a)}))}a(c.arg)}var o;i(this,"_invoke",{value:function(e,r){function i(){return new t((function(t,i){n(e,r,t,i)}))}return o=o?o.then(i,i):i()}})}function k(e,t,r){var i="suspendedStart";return function(n,o){if("executing"===i)throw new Error("Generator is already running");if("completed"===i){if("throw"===n)throw o;return C()}for(r.method=n,r.arg=o;;){var s=r.delegate;if(s){var a=E(s,r);if(a){if(a===u)continue;return a}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===i)throw i="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i="executing";var c=l(e,t,r);if("normal"===c.type){if(i=r.done?"completed":"suspendedYield",c.arg===u)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(i="completed",r.method="throw",r.arg=c.arg)}}}function E(e,t){var r=t.method,i=e.iterator[r];if(void 0===i)return t.delegate=null,"throw"===r&&e.iterator.return&&(t.method="return",t.arg=void 0,E(e,t),"throw"===t.method)||"return"!==r&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+r+"' method")),u;var n=l(i,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,u;var o=n.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,u):o:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,u)}function x(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function j(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function A(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(x,this),this.reset(!0)}function O(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,n=function t(){for(;++i<e.length;)if(r.call(e,i))return t.value=e[i],t.done=!1,t;return t.value=void 0,t.done=!0,t};return n.next=n}}return{next:C}}function C(){return{value:void 0,done:!0}}return m.prototype=g,i(b,"constructor",{value:g,configurable:!0}),i(g,"constructor",{value:m,configurable:!0}),m.displayName=c(g,a,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===m||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,g):(e.__proto__=g,c(e,a,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},w(S.prototype),c(S.prototype,s,(function(){return this})),e.AsyncIterator=S,e.async=function(t,r,i,n,o){void 0===o&&(o=Promise);var s=new S(d(t,r,i,n),o);return e.isGeneratorFunction(r)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},w(b),c(b,a,"Generator"),c(b,o,(function(){return this})),c(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),r=[];for(var i in t)r.push(i);return r.reverse(),function e(){for(;r.length;){var i=r.pop();if(i in t)return e.value=i,e.done=!1,e}return e.done=!0,e}},e.values=O,A.prototype={constructor:A,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(j),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function i(r,i){return s.type="throw",s.arg=e,t.next=r,i&&(t.method="next",t.arg=void 0),!!i}for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n],s=o.completion;if("root"===o.tryLoc)return i("end");if(o.tryLoc<=this.prev){var a=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(a&&c){if(this.prev<o.catchLoc)return i(o.catchLoc,!0);if(this.prev<o.finallyLoc)return i(o.finallyLoc)}else if(a){if(this.prev<o.catchLoc)return i(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return i(o.finallyLoc)}}}},abrupt:function(e,t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.tryLoc<=this.prev&&r.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var o=n;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var s=o?o.completion:{};return s.type=e,s.arg=t,o?(this.method="next",this.next=o.finallyLoc,u):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),u},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),j(r),u}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var i=r.completion;if("throw"===i.type){var n=i.arg;j(r)}return n}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),u}},e}function m(e,t,r,i,n,o,s){try{var a=e[o](s),c=a.value}catch(e){return void r(e)}a.done?t(c):Promise.resolve(c).then(i,n)}function g(e){return function(){var t=this,r=arguments;return new Promise((function(i,n){var o=e.apply(t,r);function s(e){m(o,i,n,s,a,"next",e)}function a(e){m(o,i,n,s,a,"throw",e)}s(void 0)}))}}function v(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function y(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?v(Object(r),!0).forEach((function(t){E(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):v(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function _(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,x(i.key),i)}}function b(e,t){return b=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},b(e,t)}function w(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,i=k(e);if(t){var n=k(this).constructor;r=Reflect.construct(i,arguments,n)}else r=i.apply(this,arguments);return function(e,t){if(t&&("object"===h(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return S(e)}(this,r)}}function S(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function k(e){return k=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},k(e)}function E(e,t,r){return(t=x(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function x(e){var t=function(e,t){if("object"!==h(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,t||"default");if("object"!==h(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===h(t)?t:String(t)}function j(e){return new O(e,0)}function A(e){var t,r;function i(t,r){try{var o=e[t](r),s=o.value,a=s instanceof O;Promise.resolve(a?s.v:s).then((function(r){if(a){var c="return"===t?"return":"next";if(!s.k||r.done)return i(c,r);r=e[c](r).value}n(o.done?"return":"normal",r)}),(function(e){i("throw",e)}))}catch(e){n("throw",e)}}function n(e,n){switch(e){case"return":t.resolve({value:n,done:!0});break;case"throw":t.reject(n);break;default:t.resolve({value:n,done:!1})}(t=t.next)?i(t.key,t.arg):r=null}this._invoke=function(e,n){return new Promise((function(o,s){var a={key:e,arg:n,resolve:o,reject:s,next:null};r?r=r.next=a:(t=r=a,i(e,n))}))},"function"!=typeof e.return&&(this.return=void 0)}function O(e,t){this.v=e,this.k=t}A.prototype["function"==typeof Symbol&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},A.prototype.next=function(e){return this._invoke("next",e)},A.prototype.throw=function(e){return this._invoke("throw",e)},A.prototype.return=function(e){return this._invoke("return",e)};var C=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&b(e,t)}(C,e);var t,r,i,h,m,v,k,x,O=w(C);function C(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,C),(e=O.call(this)).clientOrigin=r,E(S(e),"transport",void 0),E(S(e),"capabilitiesFinished",!1),E(S(e),"supportsMSC2974Renegotiate",!1),E(S(e),"requestedCapabilities",[]),E(S(e),"approvedCapabilities",void 0),E(S(e),"cachedClientVersions",void 0),E(S(e),"turnServerWatchers",0),!window.parent)throw new Error("No parent window. This widget doesn't appear to be embedded properly.");return e.transport=new s.PostmessageTransport(n.WidgetApiDirection.FromWidget,t,window.parent,window),e.transport.targetOrigin=r,e.transport.on("message",e.handleMessage.bind(S(e))),e}return t=C,r=[{key:"hasCapability",value:function(e){return Array.isArray(this.approvedCapabilities)?this.approvedCapabilities.includes(e):this.requestedCapabilities.includes(e)}},{key:"requestCapability",value:function(e){if(this.capabilitiesFinished&&!this.supportsMSC2974Renegotiate)throw new Error("Capabilities have already been negotiated");this.requestedCapabilities.push(e)}},{key:"requestCapabilities",value:function(e){var t=this;e.forEach((function(e){return t.requestCapability(e)}))}},{key:"requestCapabilityForRoomTimeline",value:function(e){this.requestCapability("org.matrix.msc2762.timeline:".concat(e))}},{key:"requestCapabilityToSendState",value:function(e,t){this.requestCapability(u.WidgetEventCapability.forStateEvent(u.EventDirection.Send,e,t).raw)}},{key:"requestCapabilityToReceiveState",value:function(e,t){this.requestCapability(u.WidgetEventCapability.forStateEvent(u.EventDirection.Receive,e,t).raw)}},{key:"requestCapabilityToSendToDevice",value:function(e){this.requestCapability(u.WidgetEventCapability.forToDeviceEvent(u.EventDirection.Send,e).raw)}},{key:"requestCapabilityToReceiveToDevice",value:function(e){this.requestCapability(u.WidgetEventCapability.forToDeviceEvent(u.EventDirection.Receive,e).raw)}},{key:"requestCapabilityToSendEvent",value:function(e){this.requestCapability(u.WidgetEventCapability.forRoomEvent(u.EventDirection.Send,e).raw)}},{key:"requestCapabilityToReceiveEvent",value:function(e){this.requestCapability(u.WidgetEventCapability.forRoomEvent(u.EventDirection.Receive,e).raw)}},{key:"requestCapabilityToSendMessage",value:function(e){this.requestCapability(u.WidgetEventCapability.forRoomMessageEvent(u.EventDirection.Send,e).raw)}},{key:"requestCapabilityToReceiveMessage",value:function(e){this.requestCapability(u.WidgetEventCapability.forRoomMessageEvent(u.EventDirection.Receive,e).raw)}},{key:"requestCapabilityToReceiveRoomAccountData",value:function(e){this.requestCapability(u.WidgetEventCapability.forRoomAccountData(u.EventDirection.Receive,e).raw)}},{key:"requestOpenIDConnectToken",value:function(){var e=this;return new Promise((function(t,r){e.transport.sendComplete(a.WidgetApiFromWidgetAction.GetOpenIDCredentials,{}).then((function(i){var n=i.response;n.state===c.OpenIDRequestState.Allowed?t(n):n.state===c.OpenIDRequestState.Blocked?r(new Error("User declined to verify their identity")):n.state===c.OpenIDRequestState.PendingUserConfirmation?e.on("action:".concat(a.WidgetApiToWidgetAction.OpenIDCredentials),(function o(s){s.preventDefault();var d=s.detail;d.data.original_request_id===i.requestId&&(d.data.state===c.OpenIDRequestState.Allowed?(t(d.data),e.transport.reply(d,{})):d.data.state===c.OpenIDRequestState.Blocked?(r(new Error("User declined to verify their identity")),e.transport.reply(d,{})):(r(new Error("Invalid state on reply: "+n.state)),e.transport.reply(d,{error:{message:"Invalid state"}})),e.off("action:".concat(a.WidgetApiToWidgetAction.OpenIDCredentials),o))})):r(new Error("Invalid state: "+n.state))})).catch(r)}))}},{key:"updateRequestedCapabilities",value:function(){return this.transport.send(a.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities,{capabilities:this.requestedCapabilities}).then()}},{key:"sendContentLoaded",value:function(){return this.transport.send(a.WidgetApiFromWidgetAction.ContentLoaded,{}).then()}},{key:"sendSticker",value:function(e){return this.transport.send(a.WidgetApiFromWidgetAction.SendSticker,e).then()}},{key:"setAlwaysOnScreen",value:function(e){return this.transport.send(a.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen,{value:e}).then((function(e){return e.success}))}},{key:"openModalWidget",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:d.MatrixWidgetType.Custom;return this.transport.send(a.WidgetApiFromWidgetAction.OpenModalWidget,{type:n,url:e,name:t,buttons:r,data:i}).then()}},{key:"closeModalWidget",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.transport.send(a.WidgetApiFromWidgetAction.CloseModalWidget,e).then()}},{key:"sendRoomEvent",value:function(e,t,r,i,n){return this.sendEvent(e,void 0,t,r,i,n)}},{key:"sendStateEvent",value:function(e,t,r,i,n,o){return this.sendEvent(e,t,r,i,n,o)}},{key:"sendEvent",value:function(e,t,r,i,n,o){return this.transport.send(a.WidgetApiFromWidgetAction.SendEvent,y(y(y(y({type:e,content:r},void 0!==t&&{state_key:t}),void 0!==i&&{room_id:i}),void 0!==n&&{delay:n}),void 0!==o&&{parent_delay_id:o}))}},{key:"updateDelayedEvent",value:function(e,t){return this.transport.send(a.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent,{delay_id:e,action:t})}},{key:"sendToDevice",value:function(e,t,r){return this.transport.send(a.WidgetApiFromWidgetAction.SendToDevice,{type:e,encrypted:t,messages:r})}},{key:"readRoomAccountData",value:function(e,t){var r={type:e};return t&&(t.includes(p.Symbols.AnyRoom)?r.room_ids=p.Symbols.AnyRoom:r.room_ids=t),this.transport.send(a.WidgetApiFromWidgetAction.BeeperReadRoomAccountData,r).then((function(e){return e.events}))}},{key:"readRoomEvents",value:function(e,t,r,i,n){var o={type:e,msgtype:r};return void 0!==t&&(o.limit=t),i&&(i.includes(p.Symbols.AnyRoom)?o.room_ids=p.Symbols.AnyRoom:o.room_ids=i),n&&(o.since=n),this.transport.send(a.WidgetApiFromWidgetAction.MSC2876ReadEvents,o).then((function(e){return e.events}))}},{key:"readEventRelations",value:(x=g(f().mark((function e(t,r,i,n,s,c,d,l){var u;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(e.sent.includes(o.UnstableApiVersion.MSC3869)){e.next=5;break}throw new Error("The read_relations action is not supported by the client.");case 5:return u={event_id:t,rel_type:i,event_type:n,room_id:r,to:d,from:c,limit:s,direction:l},e.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC3869ReadRelations,u));case 7:case"end":return e.stop()}}),e,this)}))),function(e,t,r,i,n,o,s,a){return x.apply(this,arguments)})},{key:"readStateEvents",value:function(e,t,r,i){var n={type:e,state_key:void 0===r||r};return void 0!==t&&(n.limit=t),i&&(i.includes(p.Symbols.AnyRoom)?n.room_ids=p.Symbols.AnyRoom:n.room_ids=i),this.transport.send(a.WidgetApiFromWidgetAction.MSC2876ReadEvents,n).then((function(e){return e.events}))}},{key:"setModalButtonEnabled",value:function(e,t){if(e===l.BuiltInModalButtonID.Close)throw new Error("The close button cannot be disabled");return this.transport.send(a.WidgetApiFromWidgetAction.SetModalButtonEnabled,{button:e,enabled:t}).then()}},{key:"navigateTo",value:function(e){if(!e||!e.startsWith("https://matrix.to/#"))throw new Error("Invalid matrix.to URI");return this.transport.send(a.WidgetApiFromWidgetAction.MSC2931Navigate,{uri:e}).then()}},{key:"getTurnServers",value:function(){var e,t=this;return(e=f().mark((function e(){var r,i;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=function(){var e=g(f().mark((function e(i){return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i.preventDefault(),r(i.detail.data),e.next=4,t.transport.reply(i.detail,{});case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),t.on("action:".concat(a.WidgetApiToWidgetAction.UpdateTurnServers),i),0!==t.turnServerWatchers){e.next=12;break}return e.prev=3,e.next=6,j(t.transport.send(a.WidgetApiFromWidgetAction.WatchTurnServers,{}));case 6:e.next=12;break;case 8:throw e.prev=8,e.t0=e.catch(3),t.off("action:".concat(a.WidgetApiToWidgetAction.UpdateTurnServers),i),e.t0;case 12:t.turnServerWatchers++,e.prev=13;case 14:return e.next=17,j(new Promise((function(e){return r=e})));case 17:return e.next=19,e.sent;case 19:e.next=14;break;case 21:if(e.prev=21,t.off("action:".concat(a.WidgetApiToWidgetAction.UpdateTurnServers),i),t.turnServerWatchers--,0!==t.turnServerWatchers){e.next=27;break}return e.next=27,j(t.transport.send(a.WidgetApiFromWidgetAction.UnwatchTurnServers,{}));case 27:return e.finish(21);case 28:case"end":return e.stop()}}),e,null,[[3,8],[13,,21,28]])})),function(){return new A(e.apply(this,arguments))})()}},{key:"searchUserDirectory",value:(k=g(f().mark((function e(t,r){var i;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(e.sent.includes(o.UnstableApiVersion.MSC3973)){e.next=5;break}throw new Error("The user_directory_search action is not supported by the client.");case 5:return i={search_term:t,limit:r},e.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch,i));case 7:case"end":return e.stop()}}),e,this)}))),function(e,t){return k.apply(this,arguments)})},{key:"getMediaConfig",value:(v=g(f().mark((function e(){var t;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(e.sent.includes(o.UnstableApiVersion.MSC4039)){e.next=5;break}throw new Error("The get_media_config action is not supported by the client.");case 5:return t={},e.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction,t));case 7:case"end":return e.stop()}}),e,this)}))),function(){return v.apply(this,arguments)})},{key:"uploadFile",value:(m=g(f().mark((function e(t){var r;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(e.sent.includes(o.UnstableApiVersion.MSC4039)){e.next=5;break}throw new Error("The upload_file action is not supported by the client.");case 5:return r={file:t},e.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC4039UploadFileAction,r));case 7:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"downloadFile",value:(h=g(f().mark((function e(t){var r;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(e.sent.includes(o.UnstableApiVersion.MSC4039)){e.next=5;break}throw new Error("The download_file action is not supported by the client.");case 5:return r={content_uri:t},e.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC4039DownloadFileAction,r));case 7:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"start",value:function(){var e=this;this.transport.start(),this.getClientVersions().then((function(t){t.includes(o.UnstableApiVersion.MSC2974)&&(e.supportsMSC2974Renegotiate=!0)}))}},{key:"handleMessage",value:function(e){var t=new CustomEvent("action:".concat(e.detail.action),{detail:e.detail,cancelable:!0});if(this.emit("action:".concat(e.detail.action),t),!t.defaultPrevented)switch(e.detail.action){case a.WidgetApiToWidgetAction.SupportedApiVersions:return this.replyVersions(e.detail);case a.WidgetApiToWidgetAction.Capabilities:return this.handleCapabilities(e.detail);case a.WidgetApiToWidgetAction.UpdateVisibility:case a.WidgetApiToWidgetAction.NotifyCapabilities:return this.transport.reply(e.detail,{});default:return this.transport.reply(e.detail,{error:{message:"Unknown or unsupported action: "+e.detail.action}})}}},{key:"replyVersions",value:function(e){this.transport.reply(e,{supported_versions:o.CurrentApiVersions})}},{key:"getClientVersions",value:function(){var e=this;return Array.isArray(this.cachedClientVersions)?Promise.resolve(this.cachedClientVersions):this.transport.send(a.WidgetApiFromWidgetAction.SupportedApiVersions,{}).then((function(t){return e.cachedClientVersions=t.supported_versions,t.supported_versions})).catch((function(e){return console.warn("non-fatal error getting supported client versions: ",e),[]}))}},{key:"handleCapabilities",value:function(e){var t=this;return this.capabilitiesFinished?this.transport.reply(e,{error:{message:"Capability negotiation already completed"}}):this.getClientVersions().then((function(r){return r.includes(o.UnstableApiVersion.MSC2871)?t.once("action:".concat(a.WidgetApiToWidgetAction.NotifyCapabilities),(function(e){t.approvedCapabilities=e.detail.data.approved,t.emit("ready")})):t.emit("ready"),t.capabilitiesFinished=!0,t.transport.reply(e,{capabilities:t.requestedCapabilities})}))}}],r&&_(t.prototype,r),i&&_(t,i),Object.defineProperty(t,"prototype",{writable:!1}),C}(i.EventEmitter);t.WidgetApi=C},"./node_modules/matrix-widget-api/lib/driver/WidgetDriver.js":(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetDriver=void 0;var i=r("./node_modules/matrix-widget-api/lib/index.js");function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function o(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,(o=i.key,s=void 0,s=function(e,t){if("object"!==n(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,t||"default");if("object"!==n(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(o,"string"),"symbol"===n(s)?s:String(s)),i)}var o,s}var s=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,n;return t=e,(r=[{key:"validateCapabilities",value:function(e){return Promise.resolve(new Set)}},{key:"sendEvent",value:function(e,t){return Promise.reject(new Error("Failed to override function"))}},{key:"sendDelayedEvent",value:function(e,t,r,i){return Promise.reject(new Error("Failed to override function"))}},{key:"updateDelayedEvent",value:function(e,t){return Promise.reject(new Error("Failed to override function"))}},{key:"sendToDevice",value:function(e,t,r){return Promise.reject(new Error("Failed to override function"))}},{key:"readRoomAccountData",value:function(e){return Promise.resolve([])}},{key:"readRoomEvents",value:function(e,t,r){return Promise.resolve([])}},{key:"readStateEvents",value:function(e,t,r){return Promise.resolve([])}},{key:"readEventRelations",value:function(e,t,r,i,n,o,s,a){return Promise.resolve({chunk:[]})}},{key:"askOpenID",value:function(e){e.update({state:i.OpenIDRequestState.Blocked})}},{key:"navigate",value:function(e){throw new Error("Navigation is not implemented")}},{key:"getTurnServers",value:function(){throw new Error("TURN server support is not implemented")}},{key:"searchUserDirectory",value:function(e,t){return Promise.resolve({limited:!1,results:[]})}},{key:"getMediaConfig",value:function(){throw new Error("Get media config is not implemented")}},{key:"uploadFile",value:function(e){throw new Error("Upload file is not implemented")}},{key:"downloadFile",value:function(e){throw new Error("Download file is not implemented")}}])&&o(t.prototype,r),n&&o(t,n),Object.defineProperty(t,"prototype",{writable:!1}),e}();t.WidgetDriver=s},"./node_modules/matrix-widget-api/lib/index.js":(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var i=r("./node_modules/matrix-widget-api/lib/WidgetApi.js");Object.keys(i).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===i[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return i[e]}}))}));var n=r("./node_modules/matrix-widget-api/lib/ClientWidgetApi.js");Object.keys(n).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===n[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return n[e]}}))}));var o=r("./node_modules/matrix-widget-api/lib/Symbols.js");Object.keys(o).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===o[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}}))}));var s=r("./node_modules/matrix-widget-api/lib/transport/ITransport.js");Object.keys(s).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===s[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}}))}));var a=r("./node_modules/matrix-widget-api/lib/transport/PostmessageTransport.js");Object.keys(a).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===a[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))}));var c=r("./node_modules/matrix-widget-api/lib/interfaces/ICustomWidgetData.js");Object.keys(c).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===c[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return c[e]}}))}));var d=r("./node_modules/matrix-widget-api/lib/interfaces/IJitsiWidgetData.js");Object.keys(d).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===d[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}}))}));var l=r("./node_modules/matrix-widget-api/lib/interfaces/IStickerpickerWidgetData.js");Object.keys(l).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===l[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return l[e]}}))}));var u=r("./node_modules/matrix-widget-api/lib/interfaces/IWidget.js");Object.keys(u).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===u[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return u[e]}}))}));var p=r("./node_modules/matrix-widget-api/lib/interfaces/WidgetType.js");Object.keys(p).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===p[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return p[e]}}))}));var h=r("./node_modules/matrix-widget-api/lib/interfaces/IWidgetApiErrorResponse.js");Object.keys(h).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===h[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return h[e]}}))}));var f=r("./node_modules/matrix-widget-api/lib/interfaces/IWidgetApiRequest.js");Object.keys(f).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===f[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return f[e]}}))}));var m=r("./node_modules/matrix-widget-api/lib/interfaces/IWidgetApiResponse.js");Object.keys(m).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===m[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return m[e]}}))}));var g=r("./node_modules/matrix-widget-api/lib/interfaces/WidgetApiAction.js");Object.keys(g).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===g[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return g[e]}}))}));var v=r("./node_modules/matrix-widget-api/lib/interfaces/WidgetApiDirection.js");Object.keys(v).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===v[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return v[e]}}))}));var y=r("./node_modules/matrix-widget-api/lib/interfaces/ApiVersion.js");Object.keys(y).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===y[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return y[e]}}))}));var _=r("./node_modules/matrix-widget-api/lib/interfaces/Capabilities.js");Object.keys(_).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===_[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return _[e]}}))}));var b=r("./node_modules/matrix-widget-api/lib/interfaces/CapabilitiesAction.js");Object.keys(b).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===b[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return b[e]}}))}));var w=r("./node_modules/matrix-widget-api/lib/interfaces/ContentLoadedAction.js");Object.keys(w).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===w[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return w[e]}}))}));var S=r("./node_modules/matrix-widget-api/lib/interfaces/ScreenshotAction.js");Object.keys(S).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===S[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return S[e]}}))}));var k=r("./node_modules/matrix-widget-api/lib/interfaces/StickerAction.js");Object.keys(k).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===k[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return k[e]}}))}));var E=r("./node_modules/matrix-widget-api/lib/interfaces/StickyAction.js");Object.keys(E).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===E[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return E[e]}}))}));var x=r("./node_modules/matrix-widget-api/lib/interfaces/SupportedVersionsAction.js");Object.keys(x).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===x[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return x[e]}}))}));var j=r("./node_modules/matrix-widget-api/lib/interfaces/VisibilityAction.js");Object.keys(j).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===j[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return j[e]}}))}));var A=r("./node_modules/matrix-widget-api/lib/interfaces/GetOpenIDAction.js");Object.keys(A).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===A[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return A[e]}}))}));var O=r("./node_modules/matrix-widget-api/lib/interfaces/OpenIDCredentialsAction.js");Object.keys(O).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===O[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return O[e]}}))}));var C=r("./node_modules/matrix-widget-api/lib/interfaces/WidgetKind.js");Object.keys(C).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===C[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return C[e]}}))}));var T=r("./node_modules/matrix-widget-api/lib/interfaces/ModalButtonKind.js");Object.keys(T).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===T[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return T[e]}}))}));var R=r("./node_modules/matrix-widget-api/lib/interfaces/ModalWidgetActions.js");Object.keys(R).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===R[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return R[e]}}))}));var P=r("./node_modules/matrix-widget-api/lib/interfaces/SetModalButtonEnabledAction.js");Object.keys(P).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===P[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return P[e]}}))}));var I=r("./node_modules/matrix-widget-api/lib/interfaces/WidgetConfigAction.js");Object.keys(I).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===I[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return I[e]}}))}));var M=r("./node_modules/matrix-widget-api/lib/interfaces/SendEventAction.js");Object.keys(M).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===M[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return M[e]}}))}));var D=r("./node_modules/matrix-widget-api/lib/interfaces/SendToDeviceAction.js");Object.keys(D).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===D[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return D[e]}}))}));var W=r("./node_modules/matrix-widget-api/lib/interfaces/ReadEventAction.js");Object.keys(W).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===W[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return W[e]}}))}));var U=r("./node_modules/matrix-widget-api/lib/interfaces/IRoomEvent.js");Object.keys(U).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===U[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return U[e]}}))}));var q=r("./node_modules/matrix-widget-api/lib/interfaces/IRoomAccountData.js");Object.keys(q).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===q[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return q[e]}}))}));var N=r("./node_modules/matrix-widget-api/lib/interfaces/NavigateAction.js");Object.keys(N).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===N[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return N[e]}}))}));var L=r("./node_modules/matrix-widget-api/lib/interfaces/TurnServerActions.js");Object.keys(L).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===L[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return L[e]}}))}));var F=r("./node_modules/matrix-widget-api/lib/interfaces/ReadRelationsAction.js");Object.keys(F).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===F[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return F[e]}}))}));var B=r("./node_modules/matrix-widget-api/lib/interfaces/GetMediaConfigAction.js");Object.keys(B).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===B[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return B[e]}}))}));var K=r("./node_modules/matrix-widget-api/lib/interfaces/UpdateDelayedEventAction.js");Object.keys(K).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===K[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return K[e]}}))}));var V=r("./node_modules/matrix-widget-api/lib/interfaces/UploadFileAction.js");Object.keys(V).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===V[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return V[e]}}))}));var G=r("./node_modules/matrix-widget-api/lib/interfaces/DownloadFileAction.js");Object.keys(G).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===G[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return G[e]}}))}));var $=r("./node_modules/matrix-widget-api/lib/models/WidgetEventCapability.js");Object.keys($).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===$[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return $[e]}}))}));var H=r("./node_modules/matrix-widget-api/lib/models/validation/url.js");Object.keys(H).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===H[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return H[e]}}))}));var J=r("./node_modules/matrix-widget-api/lib/models/validation/utils.js");Object.keys(J).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===J[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return J[e]}}))}));var z=r("./node_modules/matrix-widget-api/lib/models/Widget.js");Object.keys(z).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===z[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return z[e]}}))}));var Y=r("./node_modules/matrix-widget-api/lib/models/WidgetParser.js");Object.keys(Y).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===Y[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return Y[e]}}))}));var Q=r("./node_modules/matrix-widget-api/lib/templating/url-template.js");Object.keys(Q).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===Q[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return Q[e]}}))}));var X=r("./node_modules/matrix-widget-api/lib/util/SimpleObservable.js");Object.keys(X).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===X[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return X[e]}}))}));var Z=r("./node_modules/matrix-widget-api/lib/driver/WidgetDriver.js");Object.keys(Z).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===Z[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return Z[e]}}))}))},"./node_modules/matrix-widget-api/lib/interfaces/ApiVersion.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.UnstableApiVersion=t.MatrixApiVersion=t.CurrentApiVersions=void 0;var r=function(e){return e.Prerelease1="0.0.1",e.Prerelease2="0.0.2",e}({});t.MatrixApiVersion=r;var i=function(e){return e.MSC2762="org.matrix.msc2762",e.MSC2871="org.matrix.msc2871",e.MSC2931="org.matrix.msc2931",e.MSC2974="org.matrix.msc2974",e.MSC2876="org.matrix.msc2876",e.MSC3819="org.matrix.msc3819",e.MSC3846="town.robin.msc3846",e.MSC3869="org.matrix.msc3869",e.MSC3973="org.matrix.msc3973",e.MSC4039="org.matrix.msc4039",e}({});t.UnstableApiVersion=i;var n=[r.Prerelease1,r.Prerelease2,i.MSC2762,i.MSC2871,i.MSC2931,i.MSC2974,i.MSC2876,i.MSC3819,i.MSC3846,i.MSC3869,i.MSC3973,i.MSC4039];t.CurrentApiVersions=n},"./node_modules/matrix-widget-api/lib/interfaces/Capabilities.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.VideoConferenceCapabilities=t.StickerpickerCapabilities=t.MatrixCapabilities=void 0,t.getTimelineRoomIDFromCapability=function(e){return e.substring(e.indexOf(":")+1)},t.isTimelineCapability=function(e){return null==e?void 0:e.startsWith("org.matrix.msc2762.timeline:")},t.isTimelineCapabilityFor=function(e,t){return e==="org.matrix.msc2762.timeline:".concat(t)};var r=function(e){return e.Screenshots="m.capability.screenshot",e.StickerSending="m.sticker",e.AlwaysOnScreen="m.always_on_screen",e.RequiresClient="io.element.requires_client",e.MSC2931Navigate="org.matrix.msc2931.navigate",e.MSC3846TurnServers="town.robin.msc3846.turn_servers",e.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",e.MSC4039UploadFile="org.matrix.msc4039.upload_file",e.MSC4039DownloadFile="org.matrix.msc4039.download_file",e.MSC4157SendDelayedEvent="org.matrix.msc4157.send.delayed_event",e.MSC4157UpdateDelayedEvent="org.matrix.msc4157.update_delayed_event",e}({});t.MatrixCapabilities=r;var i=[r.StickerSending];t.StickerpickerCapabilities=i;var n=[r.AlwaysOnScreen];t.VideoConferenceCapabilities=n},"./node_modules/matrix-widget-api/lib/interfaces/CapabilitiesAction.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/ContentLoadedAction.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/DownloadFileAction.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/GetMediaConfigAction.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/GetOpenIDAction.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.OpenIDRequestState=void 0;var r=function(e){return e.Allowed="allowed",e.Blocked="blocked",e.PendingUserConfirmation="request",e}({});t.OpenIDRequestState=r},"./node_modules/matrix-widget-api/lib/interfaces/ICustomWidgetData.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/IJitsiWidgetData.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/IRoomAccountData.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/IRoomEvent.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/IStickerpickerWidgetData.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/IWidget.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/IWidgetApiErrorResponse.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isErrorResponse=function(e){if("error"in e){return!!e.error.message}return!1}},"./node_modules/matrix-widget-api/lib/interfaces/IWidgetApiRequest.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/IWidgetApiResponse.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/ModalButtonKind.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ModalButtonKind=void 0;var r=function(e){return e.Primary="m.primary",e.Secondary="m.secondary",e.Warning="m.warning",e.Danger="m.danger",e.Link="m.link",e}({});t.ModalButtonKind=r},"./node_modules/matrix-widget-api/lib/interfaces/ModalWidgetActions.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.BuiltInModalButtonID=void 0;var r=function(e){return e.Close="m.close",e}({});t.BuiltInModalButtonID=r},"./node_modules/matrix-widget-api/lib/interfaces/NavigateAction.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/OpenIDCredentialsAction.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/ReadEventAction.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/ReadRelationsAction.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/ScreenshotAction.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/SendEventAction.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/SendToDeviceAction.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/SetModalButtonEnabledAction.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/StickerAction.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/StickyAction.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/SupportedVersionsAction.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/TurnServerActions.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/UpdateDelayedEventAction.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.UpdateDelayedEventAction=void 0;var r=function(e){return e.Cancel="cancel",e.Restart="restart",e.Send="send",e}({});t.UpdateDelayedEventAction=r},"./node_modules/matrix-widget-api/lib/interfaces/UploadFileAction.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/VisibilityAction.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/WidgetApiAction.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetApiToWidgetAction=t.WidgetApiFromWidgetAction=void 0;var r=function(e){return e.SupportedApiVersions="supported_api_versions",e.Capabilities="capabilities",e.NotifyCapabilities="notify_capabilities",e.TakeScreenshot="screenshot",e.UpdateVisibility="visibility",e.OpenIDCredentials="openid_credentials",e.WidgetConfig="widget_config",e.CloseModalWidget="close_modal",e.ButtonClicked="button_clicked",e.SendEvent="send_event",e.SendToDevice="send_to_device",e.UpdateTurnServers="update_turn_servers",e}({});t.WidgetApiToWidgetAction=r;var i=function(e){return e.SupportedApiVersions="supported_api_versions",e.ContentLoaded="content_loaded",e.SendSticker="m.sticker",e.UpdateAlwaysOnScreen="set_always_on_screen",e.GetOpenIDCredentials="get_openid",e.CloseModalWidget="close_modal",e.OpenModalWidget="open_modal",e.SetModalButtonEnabled="set_button_enabled",e.SendEvent="send_event",e.SendToDevice="send_to_device",e.WatchTurnServers="watch_turn_servers",e.UnwatchTurnServers="unwatch_turn_servers",e.BeeperReadRoomAccountData="com.beeper.read_room_account_data",e.MSC2876ReadEvents="org.matrix.msc2876.read_events",e.MSC2931Navigate="org.matrix.msc2931.navigate",e.MSC2974RenegotiateCapabilities="org.matrix.msc2974.request_capabilities",e.MSC3869ReadRelations="org.matrix.msc3869.read_relations",e.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",e.MSC4039GetMediaConfigAction="org.matrix.msc4039.get_media_config",e.MSC4039UploadFileAction="org.matrix.msc4039.upload_file",e.MSC4039DownloadFileAction="org.matrix.msc4039.download_file",e.MSC4157UpdateDelayedEvent="org.matrix.msc4157.update_delayed_event",e}({});t.WidgetApiFromWidgetAction=i},"./node_modules/matrix-widget-api/lib/interfaces/WidgetApiDirection.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetApiDirection=void 0,t.invertedDirection=function(e){if(e===r.ToWidget)return r.FromWidget;if(e===r.FromWidget)return r.ToWidget;throw new Error("Invalid direction")};var r=function(e){return e.ToWidget="toWidget",e.FromWidget="fromWidget",e}({});t.WidgetApiDirection=r},"./node_modules/matrix-widget-api/lib/interfaces/WidgetConfigAction.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/interfaces/WidgetKind.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetKind=void 0;var r=function(e){return e.Room="room",e.Account="account",e.Modal="modal",e}({});t.WidgetKind=r},"./node_modules/matrix-widget-api/lib/interfaces/WidgetType.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixWidgetType=void 0;var r=function(e){return e.Custom="m.custom",e.JitsiMeet="m.jitsi",e.Stickerpicker="m.stickerpicker",e}({});t.MatrixWidgetType=r},"./node_modules/matrix-widget-api/lib/models/Widget.js":(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Widget=void 0;var i=r("./node_modules/matrix-widget-api/lib/models/validation/utils.js"),n=r("./node_modules/matrix-widget-api/lib/index.js");function o(e){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o(e)}function s(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,(n=i.key,s=void 0,s=function(e,t){if("object"!==o(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,t||"default");if("object"!==o(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(n,"string"),"symbol"===o(s)?s:String(s)),i)}var n,s}var a=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.definition=t,!this.definition)throw new Error("Definition is required");(0,i.assertPresent)(t,"id"),(0,i.assertPresent)(t,"creatorUserId"),(0,i.assertPresent)(t,"type"),(0,i.assertPresent)(t,"url")}var t,r,o;return t=e,(r=[{key:"creatorUserId",get:function(){return this.definition.creatorUserId}},{key:"type",get:function(){return this.definition.type}},{key:"id",get:function(){return this.definition.id}},{key:"name",get:function(){return this.definition.name||null}},{key:"title",get:function(){return this.rawData.title||null}},{key:"templateUrl",get:function(){return this.definition.url}},{key:"origin",get:function(){return new URL(this.templateUrl).origin}},{key:"waitForIframeLoad",get:function(){return!1!==this.definition.waitForIframeLoad&&(this.definition.waitForIframeLoad,!0)}},{key:"rawData",get:function(){return this.definition.data||{}}},{key:"getCompleteUrl",value:function(e){return(0,n.runTemplate)(this.templateUrl,this.definition,e)}}])&&s(t.prototype,r),o&&s(t,o),Object.defineProperty(t,"prototype",{writable:!1}),e}();t.Widget=a},"./node_modules/matrix-widget-api/lib/models/WidgetEventCapability.js":(e,t)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}function i(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return n(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return n(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,o=function(){};return{s:o,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,a=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){c=!0,s=e},f:function(){try{a||null==r.return||r.return()}finally{if(c)throw s}}}}function n(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}function o(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,(o=n.key,s=void 0,s=function(e,t){if("object"!==r(e)||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!==r(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(o,"string"),"symbol"===r(s)?s:String(s)),n)}var o,s}Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetEventCapability=t.EventKind=t.EventDirection=void 0;var s=function(e){return e.Event="event",e.State="state_event",e.ToDevice="to_device",e.RoomAccount="room_account",e}({});t.EventKind=s;var a=function(e){return e.Send="send",e.Receive="receive",e}({});t.EventDirection=a;var c=function(){function e(t,r,i,n,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.direction=t,this.eventType=r,this.kind=i,this.keyStr=n,this.raw=o}var t,r,n;return t=e,r=[{key:"matchesAsStateEvent",value:function(e,t,r){return this.kind===s.State&&this.direction===e&&this.eventType===t&&(null===this.keyStr||this.keyStr===r)}},{key:"matchesAsToDeviceEvent",value:function(e,t){return this.kind===s.ToDevice&&this.direction===e&&this.eventType===t}},{key:"matchesAsRoomEvent",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return this.kind===s.Event&&this.direction===e&&this.eventType===t&&("m.room.message"!==this.eventType||null===this.keyStr||this.keyStr===r)}},{key:"matchesAsRoomAccountData",value:function(e,t){return this.kind===s.RoomAccount&&this.direction===e&&this.eventType===t}}],n=[{key:"forStateEvent",value:function(t,r,i){r=r.replace(/#/g,"\\#"),i=null!=i?"#".concat(i):"";var n="org.matrix.msc2762.".concat(t,".state_event:").concat(r).concat(i);return e.findEventCapabilities([n])[0]}},{key:"forToDeviceEvent",value:function(t,r){var i="org.matrix.msc3819.".concat(t,".to_device:").concat(r);return e.findEventCapabilities([i])[0]}},{key:"forRoomEvent",value:function(t,r){var i="org.matrix.msc2762.".concat(t,".event:").concat(r);return e.findEventCapabilities([i])[0]}},{key:"forRoomMessageEvent",value:function(t,r){r=null==r?"":r;var i="org.matrix.msc2762.".concat(t,".event:m.room.message#").concat(r);return e.findEventCapabilities([i])[0]}},{key:"forRoomAccountData",value:function(t,r){var i="com.beeper.capabilities.".concat(t,".room_account_data:").concat(r);return e.findEventCapabilities([i])[0]}},{key:"findEventCapabilities",value:function(t){var r,n=[],o=i(t);try{for(o.s();!(r=o.n()).done;){var c=r.value,d=null,l=void 0,u=null;if(c.startsWith("org.matrix.msc2762.send.event:")?(d=a.Send,u=s.Event,l=c.substring(30)):c.startsWith("org.matrix.msc2762.send.state_event:")?(d=a.Send,u=s.State,l=c.substring(36)):c.startsWith("org.matrix.msc3819.send.to_device:")?(d=a.Send,u=s.ToDevice,l=c.substring(34)):c.startsWith("org.matrix.msc2762.receive.event:")?(d=a.Receive,u=s.Event,l=c.substring(33)):c.startsWith("org.matrix.msc2762.receive.state_event:")?(d=a.Receive,u=s.State,l=c.substring(39)):c.startsWith("org.matrix.msc3819.receive.to_device:")?(d=a.Receive,u=s.ToDevice,l=c.substring(37)):c.startsWith("com.beeper.capabilities.receive.room_account_data:")&&(d=a.Receive,u=s.RoomAccount,l=c.substring(50)),null!==d&&null!==u&&void 0!==l){var p=l.startsWith("m.room.message#")||u===s.State,h=null;if(l.includes("#")&&p){var f=l.split("#"),m=f.findIndex((function(e){return!e.endsWith("\\")}));l=f.slice(0,m+1).map((function(e){return e.endsWith("\\")?e.substring(0,e.length-1):e})).join("#"),h=f.slice(m+1).join("#")}n.push(new e(d,l,u,h,c))}}}catch(e){o.e(e)}finally{o.f()}return n}}],r&&o(t.prototype,r),n&&o(t,n),Object.defineProperty(t,"prototype",{writable:!1}),e}();t.WidgetEventCapability=c},"./node_modules/matrix-widget-api/lib/models/WidgetParser.js":(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetParser=void 0;var i=r("./node_modules/matrix-widget-api/lib/models/Widget.js"),n=r("./node_modules/matrix-widget-api/lib/models/validation/url.js");function o(e){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o(e)}function s(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return a(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return a(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){c=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(c)throw o}}}}function a(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}function c(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,(n=i.key,s=void 0,s=function(e,t){if("object"!==o(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,t||"default");if("object"!==o(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(n,"string"),"symbol"===o(s)?s:String(s)),i)}var n,s}var d=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,o;return t=e,o=[{key:"parseAccountData",value:function(t){if(!t)return[];for(var r=[],i=0,n=Object.keys(t);i<n.length;i++){var o=n[i],s=t[o];if(s&&("m.widget"===s.type||"im.vector.modular.widgets"===s.type)&&s.sender&&(s.state_key||s.id)===o){var a={content:s.content,sender:s.sender,type:"m.widget",state_key:o,event_id:"$example",room_id:"!example",origin_server_ts:1},c=e.parseRoomWidget(a);c&&r.push(c)}}return r}},{key:"parseWidgetsFromRoomState",value:function(t){if(!t)return[];var r,i=[],n=s(t);try{for(n.s();!(r=n.n()).done;){var o=r.value,a=e.parseRoomWidget(o);a&&i.push(a)}}catch(e){n.e(e)}finally{n.f()}return i}},{key:"parseRoomWidget",value:function(t){if(!t)return null;if("m.widget"!==t.type&&"im.vector.modular.widgets"!==t.type)return null;var r=t.content||{},i={id:t.state_key,creatorUserId:r.creatorUserId||t.sender,name:r.name,type:r.type,url:r.url,waitForIframeLoad:r.waitForIframeLoad,data:r.data};return e.processEstimatedWidget(i)}},{key:"processEstimatedWidget",value:function(e){return e.id&&e.creatorUserId&&e.type&&(0,n.isValidUrl)(e.url)?new i.Widget(e):null}}],(r=null)&&c(t.prototype,r),o&&c(t,o),Object.defineProperty(t,"prototype",{writable:!1}),e}();t.WidgetParser=d},"./node_modules/matrix-widget-api/lib/models/validation/url.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isValidUrl=function(e){if(!e)return!1;try{var t=new URL(e);return"http"===t.protocol||"https"===t.protocol}catch(e){if(e instanceof TypeError)return!1;throw e}}},"./node_modules/matrix-widget-api/lib/models/validation/utils.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.assertPresent=function(e,t){if(!e[t])throw new Error("".concat(String(t)," is required"))}},"./node_modules/matrix-widget-api/lib/templating/url-template.js":(e,t)=>{function r(e){return null==e?"".concat(e):String(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.runTemplate=function(e,t,i){for(var n=Object.assign({},t.data,{matrix_room_id:i.widgetRoomId||"",matrix_user_id:i.currentUserId,matrix_display_name:i.userDisplayName||i.currentUserId,matrix_avatar_url:i.userHttpAvatarUrl||"",matrix_widget_id:t.id,"org.matrix.msc2873.client_id":i.clientId||"","org.matrix.msc2873.client_theme":i.clientTheme||"","org.matrix.msc2873.client_language":i.clientLanguage||"","org.matrix.msc3819.matrix_device_id":i.deviceId||"","org.matrix.msc4039.matrix_base_url":i.baseUrl||""}),o=e,s=0,a=Object.keys(n);s<a.length;s++){var c=a[s],d="$".concat(c).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),l=new RegExp(d,"g");o=o.replace(l,encodeURIComponent(r(n[c])))}return o},t.toString=r},"./node_modules/matrix-widget-api/lib/transport/ITransport.js":(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},"./node_modules/matrix-widget-api/lib/transport/PostmessageTransport.js":(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PostmessageTransport=void 0;var i=r("./node_modules/events/events.js"),n=r("./node_modules/matrix-widget-api/lib/index.js");function o(e){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o(e)}function s(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function a(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?s(Object(r),!0).forEach((function(t){h(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):s(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function c(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,f(i.key),i)}}function d(e,t){return d=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},d(e,t)}function l(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,i=p(e);if(t){var n=p(this).constructor;r=Reflect.construct(i,arguments,n)}else r=i.apply(this,arguments);return function(e,t){if(t&&("object"===o(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return u(e)}(this,r)}}function u(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function p(e){return p=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},p(e)}function h(e,t,r){return(t=f(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function f(e){var t=function(e,t){if("object"!==o(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,t||"default");if("object"!==o(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===o(t)?t:String(t)}var m=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&d(e,t)}(s,e);var t,r,i,o=l(s);function s(e,t,r,i){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),(n=o.call(this)).sendDirection=e,n.initialWidgetId=t,n.transportWindow=r,n.inboundWindow=i,h(u(n),"strictOriginCheck",!1),h(u(n),"targetOrigin","*"),h(u(n),"timeoutSeconds",10),h(u(n),"_ready",!1),h(u(n),"_widgetId",null),h(u(n),"outboundRequests",new Map),h(u(n),"stopController",new AbortController),n._widgetId=t,n}return t=s,(r=[{key:"ready",get:function(){return this._ready}},{key:"widgetId",get:function(){return this._widgetId||null}},{key:"nextRequestId",get:function(){for(var e="widgetapi-".concat(Date.now()),t=0,r=e;this.outboundRequests.has(r);)r="".concat(e,"-").concat(t++);return this.outboundRequests.set(r,null),r}},{key:"sendInternal",value:function(e){console.log("[PostmessageTransport] Sending object to ".concat(this.targetOrigin,": "),e),this.transportWindow.postMessage(e,this.targetOrigin)}},{key:"reply",value:function(e,t){return this.sendInternal(a(a({},e),{},{response:t}))}},{key:"send",value:function(e,t){return this.sendComplete(e,t).then((function(e){return e.response}))}},{key:"sendComplete",value:function(e,t){var r=this;if(!this.ready||!this.widgetId)return Promise.reject(new Error("Not ready or unknown widget ID"));var i={api:this.sendDirection,widgetId:this.widgetId,requestId:this.nextRequestId,action:e,data:t};return e===n.WidgetApiToWidgetAction.UpdateVisibility&&(i.visible=t.visible),new Promise((function(e,t){var n=function(e){a(),t(e)},o=setTimeout((function(){return n(new Error("Request timed out"))}),1e3*(r.timeoutSeconds||1)),s=function(){return n(new Error("Transport stopped"))};r.stopController.signal.addEventListener("abort",s);var a=function(){r.outboundRequests.delete(i.requestId),clearTimeout(o),r.stopController.signal.removeEventListener("abort",s)};r.outboundRequests.set(i.requestId,{request:i,resolve:function(t){a(),e(t)},reject:n}),r.sendInternal(i)}))}},{key:"start",value:function(){var e=this;this.inboundWindow.addEventListener("message",(function(t){e.handleMessage(t)})),this._ready=!0}},{key:"stop",value:function(){this._ready=!1,this.stopController.abort()}},{key:"handleMessage",value:function(e){if(!this.stopController.signal.aborted&&e.data&&(!this.strictOriginCheck||e.origin===window.origin)){var t=e.data;if(t.action&&t.requestId&&t.widgetId)if(t.response){if(t.api!==this.sendDirection)return;this.handleResponse(t)}else{var r=t;if(r.api!==(0,n.invertedDirection)(this.sendDirection))return;this.handleRequest(r)}}}},{key:"handleRequest",value:function(e){if(this.widgetId){if(this.widgetId!==e.widgetId)return}else this._widgetId=e.widgetId;this.emit("message",new CustomEvent("message",{detail:e}))}},{key:"handleResponse",value:function(e){if(e.widgetId===this.widgetId){var t=this.outboundRequests.get(e.requestId);if(t)if((0,n.isErrorResponse)(e.response)){var r=e.response;t.reject(new Error(r.error.message))}else t.resolve(e)}}}])&&c(t.prototype,r),i&&c(t,i),Object.defineProperty(t,"prototype",{writable:!1}),s}(i.EventEmitter);t.PostmessageTransport=m},"./node_modules/matrix-widget-api/lib/util/SimpleObservable.js":(e,t)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}function i(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return n(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return n(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,o=function(){};return{s:o,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,a=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){c=!0,s=e},f:function(){try{a||null==r.return||r.return()}finally{if(c)throw s}}}}function n(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}function o(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,s(i.key),i)}}function s(e){var t=function(e,t){if("object"!==r(e)||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!==r(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===r(t)?t:String(t)}Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleObservable=void 0;var a=function(){function e(t){var r,i,n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),r=this,n=[],(i=s(i="listeners"))in r?Object.defineProperty(r,i,{value:n,enumerable:!0,configurable:!0,writable:!0}):r[i]=n,t&&this.listeners.push(t)}var t,r,n;return t=e,(r=[{key:"onUpdate",value:function(e){this.listeners.push(e)}},{key:"update",value:function(e){var t,r=i(this.listeners);try{for(r.s();!(t=r.n()).done;)(0,t.value)(e)}catch(e){r.e(e)}finally{r.f()}}},{key:"close",value:function(){this.listeners=[]}}])&&o(t.prototype,r),n&&o(t,n),Object.defineProperty(t,"prototype",{writable:!1}),e}();t.SimpleObservable=a},"./node_modules/jwt-decode/build/esm/index.js":(e,t,r)=>{r.d(t,{s:()=>o});class i extends Error{}function n(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return function(e){return decodeURIComponent(atob(e).replace(/(.)/g,((e,t)=>{let r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r})))}(t)}catch(e){return atob(t)}}function o(e,t){if("string"!=typeof e)throw new i("Invalid token specified: must be a string");t||(t={});const r=!0===t.header?0:1,o=e.split(".")[r];if("string"!=typeof o)throw new i(`Invalid token specified: missing part #${r+1}`);let s;try{s=n(o)}catch(e){throw new i(`Invalid token specified: invalid base64 for part #${r+1} (${e.message})`)}try{return JSON.parse(s)}catch(e){throw new i(`Invalid token specified: invalid json for part #${r+1} (${e.message})`)}}i.prototype.name="InvalidTokenError"},"./node_modules/oidc-client-ts/dist/esm/oidc-client-ts.js":(e,t,r)=>{r.d(t,{O:()=>w,OA:()=>A,TI:()=>b,ZH:()=>S,hz:()=>W,tG:()=>c,w7:()=>T});var i,n,o,s=r("./node_modules/jwt-decode/build/esm/index.js"),a={debug:()=>{},info:()=>{},warn:()=>{},error:()=>{}},c=(e=>(e[e.NONE=0]="NONE",e[e.ERROR=1]="ERROR",e[e.WARN=2]="WARN",e[e.INFO=3]="INFO",e[e.DEBUG=4]="DEBUG",e))(c||{});(o=c||(c={})).reset=function(){i=3,n=a},o.setLevel=function(e){if(!(0<=e&&e<=4))throw new Error("Invalid log level");i=e},o.setLogger=function(e){n=e};var d=class e{constructor(e){this._name=e}debug(...t){i>=4&&n.debug(e._format(this._name,this._method),...t)}info(...t){i>=3&&n.info(e._format(this._name,this._method),...t)}warn(...t){i>=2&&n.warn(e._format(this._name,this._method),...t)}error(...t){i>=1&&n.error(e._format(this._name,this._method),...t)}throw(e){throw this.error(e),e}create(e){const t=Object.create(this);return t._method=e,t.debug("begin"),t}static createStatic(t,r){const i=new e(`${t}.${r}`);return i.debug("begin"),i}static _format(e,t){const r=`[${e}]`;return t?`${r} ${t}:`:r}static debug(t,...r){i>=4&&n.debug(e._format(t),...r)}static info(t,...r){i>=3&&n.info(e._format(t),...r)}static warn(t,...r){i>=2&&n.warn(e._format(t),...r)}static error(t,...r){i>=1&&n.error(e._format(t),...r)}};c.reset();var l=e=>btoa([...new Uint8Array(e)].map((e=>String.fromCharCode(e))).join("")),u=class e{static _randomWord(){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]}static generateUUIDv4(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(t=>(+t^e._randomWord()&15>>+t/4).toString(16))).replace(/-/g,"")}static generateCodeVerifier(){return e.generateUUIDv4()+e.generateUUIDv4()+e.generateUUIDv4()}static async generateCodeChallenge(e){if(!crypto.subtle)throw new Error("Crypto.subtle is available only in secure contexts (HTTPS).");try{const t=(new TextEncoder).encode(e),r=await crypto.subtle.digest("SHA-256",t);return l(r).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch(e){throw d.error("CryptoUtils.generateCodeChallenge",e),e}}static generateBasicAuth(e,t){const r=(new TextEncoder).encode([e,t].join(":"));return l(r)}},p=class{constructor(e){this._name=e,this._logger=new d(`Event('${this._name}')`),this._callbacks=[]}addHandler(e){return this._callbacks.push(e),()=>this.removeHandler(e)}removeHandler(e){const t=this._callbacks.lastIndexOf(e);t>=0&&this._callbacks.splice(t,1)}async raise(...e){this._logger.debug("raise:",...e);for(const t of this._callbacks)await t(...e)}},h=class{static decode(e){try{return(0,s.s)(e)}catch(e){throw d.error("JwtUtils.decode",e),e}}},f=class e extends p{constructor(){super(...arguments),this._logger=new d(`Timer('${this._name}')`),this._timerHandle=null,this._expiration=0,this._callback=()=>{const t=this._expiration-e.getEpochTime();this._logger.debug("timer completes in",t),this._expiration<=e.getEpochTime()&&(this.cancel(),super.raise())}}static getEpochTime(){return Math.floor(Date.now()/1e3)}init(t){const r=this._logger.create("init");t=Math.max(Math.floor(t),1);const i=e.getEpochTime()+t;if(this.expiration===i&&this._timerHandle)return void r.debug("skipping since already initialized for expiration at",this.expiration);this.cancel(),r.debug("using duration",t),this._expiration=i;const n=Math.min(t,5);this._timerHandle=setInterval(this._callback,1e3*n)}get expiration(){return this._expiration}cancel(){this._logger.create("cancel"),this._timerHandle&&(clearInterval(this._timerHandle),this._timerHandle=null)}},m=class{static readParams(e,t="query"){if(!e)throw new TypeError("Invalid URL");const r=new URL(e,"http://127.0.0.1")["fragment"===t?"hash":"search"];return new URLSearchParams(r.slice(1))}},g=class extends Error{constructor(e,t){var r,i,n;if(super(e.error_description||e.error||""),this.form=t,this.name="ErrorResponse",!e.error)throw d.error("ErrorResponse","No error passed"),new Error("No error passed");this.error=e.error,this.error_description=null!=(r=e.error_description)?r:null,this.error_uri=null!=(i=e.error_uri)?i:null,this.state=e.userState,this.session_state=null!=(n=e.session_state)?n:null,this.url_state=e.url_state}},v=class extends Error{constructor(e){super(e),this.name="ErrorTimeout"}},y=class{constructor(){this._logger=new d("InMemoryWebStorage"),this._data={}}clear(){this._logger.create("clear"),this._data={}}getItem(e){return this._logger.create(`getItem('${e}')`),this._data[e]}setItem(e,t){this._logger.create(`setItem('${e}')`),this._data[e]=t}removeItem(e){this._logger.create(`removeItem('${e}')`),delete this._data[e]}get length(){return Object.getOwnPropertyNames(this._data).length}key(e){return Object.getOwnPropertyNames(this._data)[e]}},_=class{constructor(e=[],t=null,r={}){this._jwtHandler=t,this._extraHeaders=r,this._logger=new d("JsonService"),this._contentTypes=[],this._contentTypes.push(...e,"application/json"),t&&this._contentTypes.push("application/jwt")}async fetchWithTimeout(e,t={}){const{timeoutInSeconds:r,...i}=t;if(!r)return await fetch(e,i);const n=new AbortController,o=setTimeout((()=>n.abort()),1e3*r);try{return await fetch(e,{...t,signal:n.signal})}catch(e){if(e instanceof DOMException&&"AbortError"===e.name)throw new v("Network timed out");throw e}finally{clearTimeout(o)}}async getJson(e,{token:t,credentials:r}={}){const i=this._logger.create("getJson"),n={Accept:this._contentTypes.join(", ")};let o;t&&(i.debug("token passed, setting Authorization header"),n.Authorization="Bearer "+t),this.appendExtraHeaders(n);try{i.debug("url:",e),o=await this.fetchWithTimeout(e,{method:"GET",headers:n,credentials:r})}catch(e){throw i.error("Network Error"),e}i.debug("HTTP response received, status",o.status);const s=o.headers.get("Content-Type");if(s&&!this._contentTypes.find((e=>s.startsWith(e)))&&i.throw(new Error(`Invalid response Content-Type: ${null!=s?s:"undefined"}, from URL: ${e}`)),o.ok&&this._jwtHandler&&(null==s?void 0:s.startsWith("application/jwt")))return await this._jwtHandler(await o.text());let a;try{a=await o.json()}catch(e){if(i.error("Error parsing JSON response",e),o.ok)throw e;throw new Error(`${o.statusText} (${o.status})`)}if(!o.ok){if(i.error("Error from server:",a),a.error)throw new g(a);throw new Error(`${o.statusText} (${o.status}): ${JSON.stringify(a)}`)}return a}async postForm(e,{body:t,basicAuth:r,timeoutInSeconds:i,initCredentials:n}){const o=this._logger.create("postForm"),s={Accept:this._contentTypes.join(", "),"Content-Type":"application/x-www-form-urlencoded"};let a;void 0!==r&&(s.Authorization="Basic "+r),this.appendExtraHeaders(s);try{o.debug("url:",e),a=await this.fetchWithTimeout(e,{method:"POST",headers:s,body:t,timeoutInSeconds:i,credentials:n})}catch(e){throw o.error("Network error"),e}o.debug("HTTP response received, status",a.status);const c=a.headers.get("Content-Type");if(c&&!this._contentTypes.find((e=>c.startsWith(e))))throw new Error(`Invalid response Content-Type: ${null!=c?c:"undefined"}, from URL: ${e}`);const d=await a.text();let l={};if(d)try{l=JSON.parse(d)}catch(e){if(o.error("Error parsing JSON response",e),a.ok)throw e;throw new Error(`${a.statusText} (${a.status})`)}if(!a.ok){if(o.error("Error from server:",l),l.error)throw new g(l,t);throw new Error(`${a.statusText} (${a.status}): ${JSON.stringify(l)}`)}return l}appendExtraHeaders(e){const t=this._logger.create("appendExtraHeaders"),r=Object.keys(this._extraHeaders),i=["authorization","accept","content-type"];0!==r.length&&r.forEach((r=>{if(i.includes(r.toLocaleLowerCase()))return void t.warn("Protected header could not be overridden",r,i);const n="function"==typeof this._extraHeaders[r]?this._extraHeaders[r]():this._extraHeaders[r];n&&""!==n&&(e[r]=n)}))}},b=class{constructor(e){this._settings=e,this._logger=new d("MetadataService"),this._signingKeys=null,this._metadata=null,this._metadataUrl=this._settings.metadataUrl,this._jsonService=new _(["application/jwk-set+json"],null,this._settings.extraHeaders),this._settings.signingKeys&&(this._logger.debug("using signingKeys from settings"),this._signingKeys=this._settings.signingKeys),this._settings.metadata&&(this._logger.debug("using metadata from settings"),this._metadata=this._settings.metadata),this._settings.fetchRequestCredentials&&(this._logger.debug("using fetchRequestCredentials from settings"),this._fetchRequestCredentials=this._settings.fetchRequestCredentials)}resetSigningKeys(){this._signingKeys=null}async getMetadata(){const e=this._logger.create("getMetadata");if(this._metadata)return e.debug("using cached values"),this._metadata;if(!this._metadataUrl)throw e.throw(new Error("No authority or metadataUrl configured on settings")),null;e.debug("getting metadata from",this._metadataUrl);const t=await this._jsonService.getJson(this._metadataUrl,{credentials:this._fetchRequestCredentials});return e.debug("merging remote JSON with seed metadata"),this._metadata=Object.assign({},this._settings.metadataSeed,t),this._metadata}getIssuer(){return this._getMetadataProperty("issuer")}getAuthorizationEndpoint(){return this._getMetadataProperty("authorization_endpoint")}getUserInfoEndpoint(){return this._getMetadataProperty("userinfo_endpoint")}getTokenEndpoint(e=!0){return this._getMetadataProperty("token_endpoint",e)}getCheckSessionIframe(){return this._getMetadataProperty("check_session_iframe",!0)}getEndSessionEndpoint(){return this._getMetadataProperty("end_session_endpoint",!0)}getRevocationEndpoint(e=!0){return this._getMetadataProperty("revocation_endpoint",e)}getKeysEndpoint(e=!0){return this._getMetadataProperty("jwks_uri",e)}async _getMetadataProperty(e,t=!1){const r=this._logger.create(`_getMetadataProperty('${e}')`),i=await this.getMetadata();if(r.debug("resolved"),void 0===i[e]){if(!0===t)return void r.warn("Metadata does not contain optional property");r.throw(new Error("Metadata does not contain property "+e))}return i[e]}async getSigningKeys(){const e=this._logger.create("getSigningKeys");if(this._signingKeys)return e.debug("returning signingKeys from cache"),this._signingKeys;const t=await this.getKeysEndpoint(!1);e.debug("got jwks_uri",t);const r=await this._jsonService.getJson(t);if(e.debug("got key set",r),!Array.isArray(r.keys))throw e.throw(new Error("Missing keys on keyset")),null;return this._signingKeys=r.keys,this._signingKeys}},w=class{constructor({prefix:e="oidc.",store:t=localStorage}={}){this._logger=new d("WebStorageStateStore"),this._store=t,this._prefix=e}async set(e,t){this._logger.create(`set('${e}')`),e=this._prefix+e,await this._store.setItem(e,t)}async get(e){this._logger.create(`get('${e}')`),e=this._prefix+e;return await this._store.getItem(e)}async remove(e){this._logger.create(`remove('${e}')`),e=this._prefix+e;const t=await this._store.getItem(e);return await this._store.removeItem(e),t}async getAllKeys(){this._logger.create("getAllKeys");const e=await this._store.length,t=[];for(let r=0;r<e;r++){const e=await this._store.key(r);e&&0===e.indexOf(this._prefix)&&t.push(e.substr(this._prefix.length))}return t}},S=class{constructor({authority:e,metadataUrl:t,metadata:r,signingKeys:i,metadataSeed:n,client_id:o,client_secret:s,response_type:a="code",scope:c="openid",redirect_uri:d,post_logout_redirect_uri:l,client_authentication:u="client_secret_post",prompt:p,display:h,max_age:f,ui_locales:m,acr_values:g,resource:v,response_mode:_,filterProtocolClaims:b=!0,loadUserInfo:S=!1,staleStateAgeInSeconds:k=900,mergeClaimsStrategy:E={array:"replace"},disablePKCE:x=!1,stateStore:j,revokeTokenAdditionalContentTypes:A,fetchRequestCredentials:O,refreshTokenAllowedScope:C,extraQueryParams:T={},extraTokenParams:R={},extraHeaders:P={}}){if(this.authority=e,t?this.metadataUrl=t:(this.metadataUrl=e,e&&(this.metadataUrl.endsWith("/")||(this.metadataUrl+="/"),this.metadataUrl+=".well-known/openid-configuration")),this.metadata=r,this.metadataSeed=n,this.signingKeys=i,this.client_id=o,this.client_secret=s,this.response_type=a,this.scope=c,this.redirect_uri=d,this.post_logout_redirect_uri=l,this.client_authentication=u,this.prompt=p,this.display=h,this.max_age=f,this.ui_locales=m,this.acr_values=g,this.resource=v,this.response_mode=_,this.filterProtocolClaims=null==b||b,this.loadUserInfo=!!S,this.staleStateAgeInSeconds=k,this.mergeClaimsStrategy=E,this.disablePKCE=!!x,this.revokeTokenAdditionalContentTypes=A,this.fetchRequestCredentials=O||"same-origin",j)this.stateStore=j;else{const e="undefined"!=typeof window?window.localStorage:new y;this.stateStore=new w({store:e})}this.refreshTokenAllowedScope=C,this.extraQueryParams=T,this.extraTokenParams=R,this.extraHeaders=P}},k=class{constructor(e,t){this._settings=e,this._metadataService=t,this._logger=new d("UserInfoService"),this._getClaimsFromJwt=async e=>{const t=this._logger.create("_getClaimsFromJwt");try{const r=h.decode(e);return t.debug("JWT decoding successful"),r}catch(e){throw t.error("Error parsing JWT response"),e}},this._jsonService=new _(void 0,this._getClaimsFromJwt,this._settings.extraHeaders)}async getClaims(e){const t=this._logger.create("getClaims");e||this._logger.throw(new Error("No token passed"));const r=await this._metadataService.getUserInfoEndpoint();t.debug("got userinfo url",r);const i=await this._jsonService.getJson(r,{token:e,credentials:this._settings.fetchRequestCredentials});return t.debug("got claims",i),i}},E=class{constructor(e,t){this._settings=e,this._metadataService=t,this._logger=new d("TokenClient"),this._jsonService=new _(this._settings.revokeTokenAdditionalContentTypes,null,this._settings.extraHeaders)}async exchangeCode({grant_type:e="authorization_code",redirect_uri:t=this._settings.redirect_uri,client_id:r=this._settings.client_id,client_secret:i=this._settings.client_secret,...n}){const o=this._logger.create("exchangeCode");r||o.throw(new Error("A client_id is required")),t||o.throw(new Error("A redirect_uri is required")),n.code||o.throw(new Error("A code is required"));const s=new URLSearchParams({grant_type:e,redirect_uri:t});for(const[e,t]of Object.entries(n))null!=t&&s.set(e,t);let a;switch(this._settings.client_authentication){case"client_secret_basic":if(!i)throw o.throw(new Error("A client_secret is required")),null;a=u.generateBasicAuth(r,i);break;case"client_secret_post":s.append("client_id",r),i&&s.append("client_secret",i)}const c=await this._metadataService.getTokenEndpoint(!1);o.debug("got token endpoint");const d=await this._jsonService.postForm(c,{body:s,basicAuth:a,initCredentials:this._settings.fetchRequestCredentials});return o.debug("got response"),d}async exchangeCredentials({grant_type:e="password",client_id:t=this._settings.client_id,client_secret:r=this._settings.client_secret,scope:i=this._settings.scope,...n}){const o=this._logger.create("exchangeCredentials");t||o.throw(new Error("A client_id is required"));const s=new URLSearchParams({grant_type:e,scope:i});for(const[e,t]of Object.entries(n))null!=t&&s.set(e,t);let a;switch(this._settings.client_authentication){case"client_secret_basic":if(!r)throw o.throw(new Error("A client_secret is required")),null;a=u.generateBasicAuth(t,r);break;case"client_secret_post":s.append("client_id",t),r&&s.append("client_secret",r)}const c=await this._metadataService.getTokenEndpoint(!1);o.debug("got token endpoint");const d=await this._jsonService.postForm(c,{body:s,basicAuth:a,initCredentials:this._settings.fetchRequestCredentials});return o.debug("got response"),d}async exchangeRefreshToken({grant_type:e="refresh_token",client_id:t=this._settings.client_id,client_secret:r=this._settings.client_secret,timeoutInSeconds:i,...n}){const o=this._logger.create("exchangeRefreshToken");t||o.throw(new Error("A client_id is required")),n.refresh_token||o.throw(new Error("A refresh_token is required"));const s=new URLSearchParams({grant_type:e});for(const[e,t]of Object.entries(n))Array.isArray(t)?t.forEach((t=>s.append(e,t))):null!=t&&s.set(e,t);let a;switch(this._settings.client_authentication){case"client_secret_basic":if(!r)throw o.throw(new Error("A client_secret is required")),null;a=u.generateBasicAuth(t,r);break;case"client_secret_post":s.append("client_id",t),r&&s.append("client_secret",r)}const c=await this._metadataService.getTokenEndpoint(!1);o.debug("got token endpoint");const d=await this._jsonService.postForm(c,{body:s,basicAuth:a,timeoutInSeconds:i,initCredentials:this._settings.fetchRequestCredentials});return o.debug("got response"),d}async revoke(e){var t;const r=this._logger.create("revoke");e.token||r.throw(new Error("A token is required"));const i=await this._metadataService.getRevocationEndpoint(!1);r.debug(`got revocation endpoint, revoking ${null!=(t=e.token_type_hint)?t:"default token type"}`);const n=new URLSearchParams;for(const[t,r]of Object.entries(e))null!=r&&n.set(t,r);n.set("client_id",this._settings.client_id),this._settings.client_secret&&n.set("client_secret",this._settings.client_secret),await this._jsonService.postForm(i,{body:n}),r.debug("got response")}},x=class{constructor(e,t,r){this._settings=e,this._metadataService=t,this._claimsService=r,this._logger=new d("ResponseValidator"),this._userInfoService=new k(this._settings,this._metadataService),this._tokenClient=new E(this._settings,this._metadataService)}async validateSigninResponse(e,t){const r=this._logger.create("validateSigninResponse");this._processSigninState(e,t),r.debug("state processed"),await this._processCode(e,t),r.debug("code processed"),e.isOpenId&&this._validateIdTokenAttributes(e),r.debug("tokens validated"),await this._processClaims(e,null==t?void 0:t.skipUserInfo,e.isOpenId),r.debug("claims processed")}async validateCredentialsResponse(e,t){const r=this._logger.create("validateCredentialsResponse");e.isOpenId&&e.id_token&&this._validateIdTokenAttributes(e),r.debug("tokens validated"),await this._processClaims(e,t,e.isOpenId),r.debug("claims processed")}async validateRefreshResponse(e,t){const r=this._logger.create("validateRefreshResponse");e.userState=t.data,null!=e.session_state||(e.session_state=t.session_state),null!=e.scope||(e.scope=t.scope),e.isOpenId&&e.id_token&&(this._validateIdTokenAttributes(e,t.id_token),r.debug("ID Token validated")),e.id_token||(e.id_token=t.id_token,e.profile=t.profile);const i=e.isOpenId&&!!e.id_token;await this._processClaims(e,!1,i),r.debug("claims processed")}validateSignoutResponse(e,t){const r=this._logger.create("validateSignoutResponse");if(t.id!==e.state&&r.throw(new Error("State does not match")),r.debug("state validated"),e.userState=t.data,e.error)throw r.warn("Response was error",e.error),new g(e)}_processSigninState(e,t){const r=this._logger.create("_processSigninState");if(t.id!==e.state&&r.throw(new Error("State does not match")),t.client_id||r.throw(new Error("No client_id on state")),t.authority||r.throw(new Error("No authority on state")),this._settings.authority!==t.authority&&r.throw(new Error("authority mismatch on settings vs. signin state")),this._settings.client_id&&this._settings.client_id!==t.client_id&&r.throw(new Error("client_id mismatch on settings vs. signin state")),r.debug("state validated"),e.userState=t.data,e.url_state=t.url_state,null!=e.scope||(e.scope=t.scope),e.error)throw r.warn("Response was error",e.error),new g(e);t.code_verifier&&!e.code&&r.throw(new Error("Expected code in response"))}async _processClaims(e,t=!1,r=!0){const i=this._logger.create("_processClaims");if(e.profile=this._claimsService.filterProtocolClaims(e.profile),t||!this._settings.loadUserInfo||!e.access_token)return void i.debug("not loading user info");i.debug("loading user info");const n=await this._userInfoService.getClaims(e.access_token);i.debug("user info claims received from user info endpoint"),r&&n.sub!==e.profile.sub&&i.throw(new Error("subject from UserInfo response does not match subject in ID Token")),e.profile=this._claimsService.mergeClaims(e.profile,this._claimsService.filterProtocolClaims(n)),i.debug("user info claims received, updated profile:",e.profile)}async _processCode(e,t){const r=this._logger.create("_processCode");if(e.code){r.debug("Validating code");const i=await this._tokenClient.exchangeCode({client_id:t.client_id,client_secret:t.client_secret,code:e.code,redirect_uri:t.redirect_uri,code_verifier:t.code_verifier,...t.extraTokenParams});Object.assign(e,i)}else r.debug("No code to process")}_validateIdTokenAttributes(e,t){var r;const i=this._logger.create("_validateIdTokenAttributes");i.debug("decoding ID Token JWT");const n=h.decode(null!=(r=e.id_token)?r:"");if(n.sub||i.throw(new Error("ID Token is missing a subject claim")),t){const e=h.decode(t);n.sub!==e.sub&&i.throw(new Error("sub in id_token does not match current sub")),n.auth_time&&n.auth_time!==e.auth_time&&i.throw(new Error("auth_time in id_token does not match original auth_time")),n.azp&&n.azp!==e.azp&&i.throw(new Error("azp in id_token does not match original azp")),!n.azp&&e.azp&&i.throw(new Error("azp not in id_token, but present in original id_token"))}e.profile=n}},j=class e{constructor(e){this.id=e.id||u.generateUUIDv4(),this.data=e.data,e.created&&e.created>0?this.created=e.created:this.created=f.getEpochTime(),this.request_type=e.request_type,this.url_state=e.url_state}toStorageString(){return new d("State").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state})}static fromStorageString(t){return d.createStatic("State","fromStorageString"),Promise.resolve(new e(JSON.parse(t)))}static async clearStaleState(t,r){const i=d.createStatic("State","clearStaleState"),n=f.getEpochTime()-r,o=await t.getAllKeys();i.debug("got keys",o);for(let r=0;r<o.length;r++){const s=o[r],a=await t.get(s);let c=!1;if(a)try{const t=await e.fromStorageString(a);i.debug("got item from key:",s,t.created),t.created<=n&&(c=!0)}catch(e){i.error("Error parsing state for key:",s,e),c=!0}else i.debug("no item in storage for key:",s),c=!0;c&&(i.debug("removed item for key:",s),t.remove(s))}}},A=class e extends j{constructor(e){super(e),this.code_verifier=e.code_verifier,this.code_challenge=e.code_challenge,this.authority=e.authority,this.client_id=e.client_id,this.redirect_uri=e.redirect_uri,this.scope=e.scope,this.client_secret=e.client_secret,this.extraTokenParams=e.extraTokenParams,this.response_mode=e.response_mode,this.skipUserInfo=e.skipUserInfo}static async create(t){const r=!0===t.code_verifier?u.generateCodeVerifier():t.code_verifier||void 0,i=r?await u.generateCodeChallenge(r):void 0;return new e({...t,code_verifier:r,code_challenge:i})}toStorageString(){return new d("SigninState").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state,code_verifier:this.code_verifier,authority:this.authority,client_id:this.client_id,redirect_uri:this.redirect_uri,scope:this.scope,client_secret:this.client_secret,extraTokenParams:this.extraTokenParams,response_mode:this.response_mode,skipUserInfo:this.skipUserInfo})}static fromStorageString(t){d.createStatic("SigninState","fromStorageString");const r=JSON.parse(t);return e.create(r)}},O=class e{constructor(e){this.url=e.url,this.state=e.state}static async create({url:t,authority:r,client_id:i,redirect_uri:n,response_type:o,scope:s,state_data:a,response_mode:c,request_type:d,client_secret:l,nonce:u,url_state:p,resource:h,skipUserInfo:f,extraQueryParams:m,extraTokenParams:g,disablePKCE:v,...y}){if(!t)throw this._logger.error("create: No url passed"),new Error("url");if(!i)throw this._logger.error("create: No client_id passed"),new Error("client_id");if(!n)throw this._logger.error("create: No redirect_uri passed"),new Error("redirect_uri");if(!o)throw this._logger.error("create: No response_type passed"),new Error("response_type");if(!s)throw this._logger.error("create: No scope passed"),new Error("scope");if(!r)throw this._logger.error("create: No authority passed"),new Error("authority");const _=await A.create({data:a,request_type:d,url_state:p,code_verifier:!v,client_id:i,authority:r,redirect_uri:n,response_mode:c,client_secret:l,scope:s,extraTokenParams:g,skipUserInfo:f}),b=new URL(t);b.searchParams.append("client_id",i),b.searchParams.append("redirect_uri",n),b.searchParams.append("response_type",o),b.searchParams.append("scope",s),u&&b.searchParams.append("nonce",u);let w=_.id;if(p&&(w=`${w};${p}`),b.searchParams.append("state",w),_.code_challenge&&(b.searchParams.append("code_challenge",_.code_challenge),b.searchParams.append("code_challenge_method","S256")),h){(Array.isArray(h)?h:[h]).forEach((e=>b.searchParams.append("resource",e)))}for(const[e,t]of Object.entries({response_mode:c,...y,...m}))null!=t&&b.searchParams.append(e,t.toString());return new e({url:b.href,state:_})}};O._logger=new d("SigninRequest");var C=3023==r.j?O:null,T=class{constructor(e){if(this.access_token="",this.token_type="",this.profile={},this.state=e.get("state"),this.session_state=e.get("session_state"),this.state){const e=decodeURIComponent(this.state).split(";");this.state=e[0],e.length>1&&(this.url_state=e.slice(1).join(";"))}this.error=e.get("error"),this.error_description=e.get("error_description"),this.error_uri=e.get("error_uri"),this.code=e.get("code")}get expires_in(){if(void 0!==this.expires_at)return this.expires_at-f.getEpochTime()}set expires_in(e){"string"==typeof e&&(e=Number(e)),void 0!==e&&e>=0&&(this.expires_at=Math.floor(e)+f.getEpochTime())}get isOpenId(){var e;return(null==(e=this.scope)?void 0:e.split(" ").includes("openid"))||!!this.id_token}},R=class{constructor({url:e,state_data:t,id_token_hint:r,post_logout_redirect_uri:i,extraQueryParams:n,request_type:o,client_id:s}){if(this._logger=new d("SignoutRequest"),!e)throw this._logger.error("ctor: No url passed"),new Error("url");const a=new URL(e);r&&a.searchParams.append("id_token_hint",r),s&&a.searchParams.append("client_id",s),i&&(a.searchParams.append("post_logout_redirect_uri",i),t&&(this.state=new j({data:t,request_type:o}),a.searchParams.append("state",this.state.id)));for(const[e,t]of Object.entries({...n}))null!=t&&a.searchParams.append(e,t.toString());this.url=a.href}},P=class{constructor(e){this.state=e.get("state"),this.error=e.get("error"),this.error_description=e.get("error_description"),this.error_uri=e.get("error_uri")}},I=3023==r.j?["nbf","jti","auth_time","nonce","acr","amr","azp","at_hash"]:null,M=3023==r.j?["sub","iss","aud","exp","iat"]:null,D=class{constructor(e){this._settings=e,this._logger=new d("ClaimsService")}filterProtocolClaims(e){const t={...e};if(this._settings.filterProtocolClaims){let e;e=Array.isArray(this._settings.filterProtocolClaims)?this._settings.filterProtocolClaims:I;for(const r of e)M.includes(r)||delete t[r]}return t}mergeClaims(e,t){const r={...e};for(const[e,i]of Object.entries(t))if(r[e]!==i)if(Array.isArray(r[e])||Array.isArray(i))if("replace"==this._settings.mergeClaimsStrategy.array)r[e]=i;else{const t=Array.isArray(r[e])?r[e]:[r[e]];for(const e of Array.isArray(i)?i:[i])t.includes(e)||t.push(e);r[e]=t}else"object"==typeof r[e]&&"object"==typeof i?r[e]=this.mergeClaims(r[e],i):r[e]=i;return r}},W=class{constructor(e,t){this._logger=new d("OidcClient"),this.settings=e instanceof S?e:new S(e),this.metadataService=null!=t?t:new b(this.settings),this._claimsService=new D(this.settings),this._validator=new x(this.settings,this.metadataService,this._claimsService),this._tokenClient=new E(this.settings,this.metadataService)}async createSigninRequest({state:e,request:t,request_uri:r,request_type:i,id_token_hint:n,login_hint:o,skipUserInfo:s,nonce:a,url_state:c,response_type:d=this.settings.response_type,scope:l=this.settings.scope,redirect_uri:u=this.settings.redirect_uri,prompt:p=this.settings.prompt,display:h=this.settings.display,max_age:f=this.settings.max_age,ui_locales:m=this.settings.ui_locales,acr_values:g=this.settings.acr_values,resource:v=this.settings.resource,response_mode:y=this.settings.response_mode,extraQueryParams:_=this.settings.extraQueryParams,extraTokenParams:b=this.settings.extraTokenParams}){const w=this._logger.create("createSigninRequest");if("code"!==d)throw new Error("Only the Authorization Code flow (with PKCE) is supported");const S=await this.metadataService.getAuthorizationEndpoint();w.debug("Received authorization endpoint",S);const k=await C.create({url:S,authority:this.settings.authority,client_id:this.settings.client_id,redirect_uri:u,response_type:d,scope:l,state_data:e,url_state:c,prompt:p,display:h,max_age:f,ui_locales:m,id_token_hint:n,login_hint:o,acr_values:g,resource:v,request:t,request_uri:r,extraQueryParams:_,extraTokenParams:b,request_type:i,response_mode:y,client_secret:this.settings.client_secret,skipUserInfo:s,nonce:a,disablePKCE:this.settings.disablePKCE});await this.clearStaleState();const E=k.state;return await this.settings.stateStore.set(E.id,E.toStorageString()),k}async readSigninResponseState(e,t=!1){const r=this._logger.create("readSigninResponseState"),i=new T(m.readParams(e,this.settings.response_mode));if(!i.state)throw r.throw(new Error("No state in response")),null;const n=await this.settings.stateStore[t?"remove":"get"](i.state);if(!n)throw r.throw(new Error("No matching state found in storage")),null;return{state:await A.fromStorageString(n),response:i}}async processSigninResponse(e){const t=this._logger.create("processSigninResponse"),{state:r,response:i}=await this.readSigninResponseState(e,!0);return t.debug("received state from storage; validating response"),await this._validator.validateSigninResponse(i,r),i}async processResourceOwnerPasswordCredentials({username:e,password:t,skipUserInfo:r=!1,extraTokenParams:i={}}){const n=await this._tokenClient.exchangeCredentials({username:e,password:t,...i}),o=new T(new URLSearchParams);return Object.assign(o,n),await this._validator.validateCredentialsResponse(o,r),o}async useRefreshToken({state:e,redirect_uri:t,resource:r,timeoutInSeconds:i,extraTokenParams:n}){var o;const s=this._logger.create("useRefreshToken");let a;if(void 0===this.settings.refreshTokenAllowedScope)a=e.scope;else{const t=this.settings.refreshTokenAllowedScope.split(" ");a=((null==(o=e.scope)?void 0:o.split(" "))||[]).filter((e=>t.includes(e))).join(" ")}const c=await this._tokenClient.exchangeRefreshToken({refresh_token:e.refresh_token,scope:a,redirect_uri:t,resource:r,timeoutInSeconds:i,...n}),d=new T(new URLSearchParams);return Object.assign(d,c),s.debug("validating response",d),await this._validator.validateRefreshResponse(d,{...e,scope:a}),d}async createSignoutRequest({state:e,id_token_hint:t,client_id:r,request_type:i,post_logout_redirect_uri:n=this.settings.post_logout_redirect_uri,extraQueryParams:o=this.settings.extraQueryParams}={}){const s=this._logger.create("createSignoutRequest"),a=await this.metadataService.getEndSessionEndpoint();if(!a)throw s.throw(new Error("No end session endpoint")),null;s.debug("Received end session endpoint",a),r||!n||t||(r=this.settings.client_id);const c=new R({url:a,id_token_hint:t,client_id:r,post_logout_redirect_uri:n,state_data:e,extraQueryParams:o,request_type:i});await this.clearStaleState();const d=c.state;return d&&(s.debug("Signout request has state to persist"),await this.settings.stateStore.set(d.id,d.toStorageString())),c}async readSignoutResponseState(e,t=!1){const r=this._logger.create("readSignoutResponseState"),i=new P(m.readParams(e,this.settings.response_mode));if(!i.state){if(r.debug("No state in response"),i.error)throw r.warn("Response was error:",i.error),new g(i);return{state:void 0,response:i}}const n=await this.settings.stateStore[t?"remove":"get"](i.state);if(!n)throw r.throw(new Error("No matching state found in storage")),null;return{state:await j.fromStorageString(n),response:i}}async processSignoutResponse(e){const t=this._logger.create("processSignoutResponse"),{state:r,response:i}=await this.readSignoutResponseState(e,!0);return r?(t.debug("Received state from storage; validating response"),this._validator.validateSignoutResponse(i,r)):t.debug("No state from storage; skipping response validation"),i}clearStaleState(){return this._logger.create("clearStaleState"),j.clearStaleState(this.settings.stateStore,this.settings.staleStateAgeInSeconds)}async revokeToken(e,t){return this._logger.create("revokeToken"),await this._tokenClient.revoke({token:e,token_type_hint:t})}}}}]);
//# sourceMappingURL=6656.js.map